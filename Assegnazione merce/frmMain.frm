VERSION 5.00
Object = "{8D02DC4E-BFE1-4A08-9F2A-F268CB42CDFB}#3.0#0"; "Actbar3.ocx"
Object = "{7A1D73E4-F461-11D0-8F01-004033A00AF2}#1.0#0"; "DmtWheel.ocx"
Object = "{5C67DC8E-40E7-11D3-AF44-00105A2FBE61}#3.0#0"; "DmtPrnDlgCtl.ocx"
Object = "{5C67DB53-40E7-11D3-AF44-00105A2FBE61}#11.8#0"; "DmtGridCtl.ocx"
Object = "{BDC217C8-ED16-11CD-956C-0000C04E4C0A}#1.1#0"; "tabctl32.ocx"
Object = "{910385FB-4687-11D3-935C-00105A2E9BA7}#4.10#0"; "DmtCodDesc.ocx"
Object = "{E0BE4700-0D0C-11D2-B957-002018813989}#10.1#0"; "DMTDataCmb.OCX"
Object = "{2ACC5784-9960-11D1-A947-0040335881DA}#1.0#0"; "DMTDateTime.ocx"
Object = "{E9A7E3D8-0C2C-11D2-B92E-00201880103B}#1.0#0"; "dmteditnum.ocx"
Object = "{9385BB2E-6637-11D1-850D-002018802E11}#3.1#0"; "Dmtsplit.ocx"
Object = "{41B8DADF-1874-4E5A-BB7B-4CE86D43F217}#1.2#0"; "DmtActBox.OCX"
Object = "{E1215E52-40E1-11D3-AF44-00105A2FBE61}#5.1#0"; "DMTLblLinkCtl.ocx"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.1#0"; "mscomctl.ocx"
Begin VB.Form frmMain 
   ClientHeight    =   11670
   ClientLeft      =   60
   ClientTop       =   345
   ClientWidth     =   19185
   BeginProperty Font 
      Name            =   "Verdana"
      Size            =   8.25
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   Icon            =   "frmMain.frx":0000
   KeyPreview      =   -1  'True
   LinkTopic       =   "Form1"
   ScaleHeight     =   11670
   ScaleWidth      =   19185
   StartUpPosition =   2  'CenterScreen
   WhatsThisHelp   =   -1  'True
   Begin ActiveBar3LibraryCtl.ActiveBar3 BarMenu 
      Height          =   11325
      Left            =   0
      TabIndex        =   85
      TabStop         =   0   'False
      Top             =   0
      Width           =   19185
      _LayoutVersion  =   2
      _ExtentX        =   33840
      _ExtentY        =   19976
      _DataPath       =   ""
      Bands           =   "frmMain.frx":4781A
      Begin DMTSPLIT.DMTSplitBar DMTSplitBar1 
         Height          =   510
         Left            =   1200
         TabIndex        =   86
         Top             =   2400
         Width           =   840
         _ExtentX        =   1482
         _ExtentY        =   900
      End
      Begin VB.PictureBox PicForm 
         Appearance      =   0  'Flat
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H80000008&
         Height          =   11265
         Left            =   0
         ScaleHeight     =   11235
         ScaleWidth      =   19125
         TabIndex        =   88
         Top             =   0
         Width           =   19155
         Begin VB.PictureBox PicForm2 
            Appearance      =   0  'Flat
            BeginProperty Font 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ForeColor       =   &H80000008&
            Height          =   10935
            Left            =   120
            ScaleHeight     =   10905
            ScaleWidth      =   18825
            TabIndex        =   89
            Top             =   120
            Width           =   18855
            Begin VB.Frame FraConferimento 
               Caption         =   "ARTICOLO DI CONFERIMENTO"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00C00000&
               Height          =   2295
               Left            =   5760
               TabIndex        =   108
               Top             =   120
               Width           =   12975
               Begin VB.CheckBox chkLottoUtilizzoEsclusivo 
                  Caption         =   "Esclusivo"
                  Enabled         =   0   'False
                  Height          =   255
                  Left            =   11400
                  TabIndex        =   348
                  Top             =   960
                  Width           =   1455
               End
               Begin VB.CheckBox chkPreConferimento 
                  Caption         =   "Pre-conferimento"
                  Enabled         =   0   'False
                  Height          =   255
                  Left            =   5640
                  TabIndex        =   347
                  Top             =   1920
                  Width           =   2295
               End
               Begin VB.CommandButton cmdCalcoloPesi 
                  Height          =   315
                  Left            =   12000
                  Picture         =   "frmMain.frx":479EA
                  Style           =   1  'Graphical
                  TabIndex        =   300
                  TabStop         =   0   'False
                  ToolTipText     =   "Apri maschera per calcolo pesi medi e pezzi medi"
                  Top             =   0
                  Width           =   375
               End
               Begin VB.CheckBox chkPrezzoMedioConf 
                  Caption         =   "Prezzo medio"
                  Enabled         =   0   'False
                  Height          =   255
                  Left            =   3960
                  TabIndex        =   288
                  Top             =   1920
                  Width           =   1455
               End
               Begin VB.CheckBox chkSoloLavorazioniPostazione 
                  Alignment       =   1  'Right Justify
                  Appearance      =   0  'Flat
                  Caption         =   "VISUALIZZA DATI DI QUESTA POSTAZIONE"
                  BeginProperty Font 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  ForeColor       =   &H80000008&
                  Height          =   255
                  Left            =   8400
                  TabIndex        =   191
                  Top             =   2880
                  Width           =   4455
               End
               Begin VB.CheckBox chkPareggiaConferimento 
                  Alignment       =   1  'Right Justify
                  Appearance      =   0  'Flat
                  Caption         =   "PAREGGIA CONFERIMENTO"
                  BeginProperty Font 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  ForeColor       =   &H80000008&
                  Height          =   315
                  Left            =   9960
                  TabIndex        =   190
                  Top             =   2400
                  Width           =   2895
               End
               Begin VB.CommandButton cmdApriFrameConferimento 
                  BeginProperty Font 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Height          =   315
                  Left            =   12480
                  Picture         =   "frmMain.frx":47D2C
                  Style           =   1  'Graphical
                  TabIndex        =   186
                  TabStop         =   0   'False
                  ToolTipText     =   "Espandi maschera"
                  Top             =   0
                  Width           =   375
               End
               Begin VB.TextBox txtLottoEntrata 
                  Appearance      =   0  'Flat
                  BackColor       =   &H00FFFFFF&
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   120
                  TabIndex        =   132
                  Top             =   960
                  Width           =   5655
               End
               Begin VB.TextBox txtUnitaDiMisura_Conferimento 
                  Appearance      =   0  'Flat
                  BackColor       =   &H00FFFFFF&
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   1680
                  TabIndex        =   130
                  Top             =   1440
                  Width           =   2535
               End
               Begin VB.TextBox txtCodiceImballo_Conferimento 
                  Appearance      =   0  'Flat
                  BackColor       =   &H00FFFFFF&
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   5880
                  TabIndex        =   118
                  Top             =   960
                  Width           =   1935
               End
               Begin VB.TextBox txtCodiceLotto_Conf 
                  Appearance      =   0  'Flat
                  BackColor       =   &H00FFFFFF&
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   6720
                  TabIndex        =   112
                  Top             =   480
                  Width           =   6135
               End
               Begin VB.TextBox txtCodiceArticolo_Conf 
                  Appearance      =   0  'Flat
                  BackColor       =   &H00FFFFFF&
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   120
                  TabIndex        =   111
                  Top             =   480
                  Width           =   2295
               End
               Begin VB.TextBox txtArticolo_Conf 
                  Appearance      =   0  'Flat
                  BackColor       =   &H00FFFFFF&
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   2520
                  TabIndex        =   110
                  Top             =   480
                  Width           =   4095
               End
               Begin VB.CheckBox chkChiusoConferimento 
                  Alignment       =   1  'Right Justify
                  Appearance      =   0  'Flat
                  Caption         =   "Chiusura lotto"
                  BeginProperty Font 
                     Name            =   "Verdana"
                     Size            =   9.75
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  ForeColor       =   &H80000008&
                  Height          =   255
                  Left            =   10920
                  TabIndex        =   0
                  Top             =   1920
                  Width           =   1935
               End
               Begin VB.TextBox txtArticoloImballo_Conferimento 
                  Appearance      =   0  'Flat
                  BackColor       =   &H00FFFFFF&
                  Enabled         =   0   'False
                  Height          =   285
                  Left            =   7920
                  TabIndex        =   109
                  Top             =   960
                  Width           =   3375
               End
               Begin DMTEDITNUMLib.dmtNumber txtQtaDifferenza 
                  Height          =   285
                  Left            =   8040
                  TabIndex        =   113
                  Top             =   1920
                  Width           =   1695
                  _Version        =   65536
                  _ExtentX        =   2990
                  _ExtentY        =   503
                  _StockProps     =   253
                  Text            =   "0"
                  ForeColor       =   65535
                  BackColor       =   16777215
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  BorderStyle     =   1
                  Enabled         =   0   'False
                  UseSeparator    =   -1  'True
                  DecFinalZeros   =   -1  'True
                  AllowEmpty      =   0   'False
               End
               Begin DMTEDITNUMLib.dmtNumber txtQtaQuadrata 
                  Height          =   285
                  Left            =   6240
                  TabIndex        =   114
                  Top             =   1440
                  Width           =   1695
                  _Version        =   65536
                  _ExtentX        =   2990
                  _ExtentY        =   503
                  _StockProps     =   253
                  Text            =   "0"
                  ForeColor       =   65535
                  BackColor       =   65535
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  BorderStyle     =   1
                  Enabled         =   0   'False
                  UseSeparator    =   -1  'True
                  DecFinalZeros   =   -1  'True
                  AllowEmpty      =   0   'False
               End
               Begin DMTEDITNUMLib.dmtNumber txtQtaVenduta 
                  Height          =   285
                  Left            =   8040
                  TabIndex        =   115
                  Top             =   1440
                  Width           =   1695
                  _Version        =   65536
                  _ExtentX        =   2990
                  _ExtentY        =   503
                  _StockProps     =   253
                  Text            =   "0"
                  ForeColor       =   65535
                  BackColor       =   65535
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  BorderStyle     =   1
                  Enabled         =   0   'False
                  UseSeparator    =   -1  'True
                  DecFinalZeros   =   -1  'True
                  AllowEmpty      =   0   'False
               End
               Begin DMTEDITNUMLib.dmtNumber txtDisponibiltaLottoCaricato 
                  Height          =   285
                  Left            =   4320
                  TabIndex        =   116
                  Top             =   1440
                  Width           =   1815
                  _Version        =   65536
                  _ExtentX        =   3201
                  _ExtentY        =   503
                  _StockProps     =   253
                  Text            =   "0"
                  ForeColor       =   65535
                  BackColor       =   65535
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  BorderStyle     =   1
                  Enabled         =   0   'False
                  UseSeparator    =   -1  'True
                  DecFinalZeros   =   -1  'True
                  AllowEmpty      =   0   'False
               End
               Begin DMTEDITNUMLib.dmtNumber txtNumeroColliCaricati 
                  Height          =   285
                  Left            =   120
                  TabIndex        =   117
                  TabStop         =   0   'False
                  Top             =   1440
                  Width           =   1455
                  _Version        =   65536
                  _ExtentX        =   2566
                  _ExtentY        =   503
                  _StockProps     =   253
                  Text            =   "0"
                  ForeColor       =   0
                  BackColor       =   16777215
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  BorderStyle     =   1
                  Enabled         =   0   'False
                  AllowEmpty      =   0   'False
               End
               Begin DMTEDITNUMLib.dmtNumber txtNumeroPedaneLav 
                  Height          =   285
                  Left            =   9840
                  TabIndex        =   221
                  Top             =   1440
                  Width           =   1455
                  _Version        =   65536
                  _ExtentX        =   2566
                  _ExtentY        =   503
                  _StockProps     =   253
                  Text            =   "0"
                  ForeColor       =   65535
                  BackColor       =   65535
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  BorderStyle     =   1
                  Enabled         =   0   'False
                  UseSeparator    =   -1  'True
                  DecFinalZeros   =   -1  'True
                  AllowEmpty      =   0   'False
               End
               Begin DMTEDITNUMLib.dmtNumber txtNumeroColliLav 
                  Height          =   285
                  Left            =   11400
                  TabIndex        =   222
                  Top             =   1440
                  Width           =   1455
                  _Version        =   65536
                  _ExtentX        =   2566
                  _ExtentY        =   503
                  _StockProps     =   253
                  Text            =   "0"
                  ForeColor       =   65535
                  BackColor       =   65535
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   700
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  BorderStyle     =   1
                  Enabled         =   0   'False
                  UseSeparator    =   -1  'True
                  DecFinalZeros   =   -1  'True
                  AllowEmpty      =   0   'False
               End
               Begin DMTDataCmb.DMTCombo cboTipoLavConf 
                  Height          =   315
                  Left            =   120
                  TabIndex        =   286
                  TabStop         =   0   'False
                  Top             =   1920
                  Width           =   3735
                  _ExtentX        =   6588
                  _ExtentY        =   556
                  Enabled         =   0   'False
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
               End
               Begin VB.Label Label3 
                  Caption         =   "Tipo lavorazione conferimento"
                  Height          =   255
                  Index           =   6
                  Left            =   120
                  TabIndex        =   287
                  Top             =   1720
                  Width           =   2895
               End
               Begin VB.Label Label2 
                  Caption         =   "N° Pedane "
                  Height          =   255
                  Index           =   27
                  Left            =   9840
                  TabIndex        =   220
                  Top             =   1245
                  Width           =   1455
               End
               Begin VB.Label Label2 
                  Caption         =   "Colli lavorati"
                  Height          =   255
                  Index           =   26
                  Left            =   11400
                  TabIndex        =   219
                  Top             =   1245
                  Width           =   1455
               End
               Begin VB.Label Label3 
                  Caption         =   "Unità di misura"
                  Height          =   255
                  Index           =   4
                  Left            =   1680
                  TabIndex        =   131
                  Top             =   1245
                  Width           =   1575
               End
               Begin VB.Label Label3 
                  Caption         =   "Codice imballo"
                  Height          =   255
                  Index           =   5
                  Left            =   5880
                  TabIndex        =   129
                  Top             =   765
                  Width           =   1455
               End
               Begin VB.Image Image1 
                  Height          =   240
                  Left            =   9720
                  Picture         =   "frmMain.frx":482B6
                  ToolTipText     =   "ATTENZIONE: ERRORE DI QUADRATURA"
                  Top             =   1920
                  Width           =   240
               End
               Begin VB.Label Label2 
                  Caption         =   "Q.tà Quadrata"
                  Height          =   255
                  Index           =   18
                  Left            =   6240
                  TabIndex        =   128
                  Top             =   1245
                  Width           =   1575
               End
               Begin VB.Label Label2 
                  Caption         =   "Q.tà Assegnata"
                  Height          =   255
                  Index           =   17
                  Left            =   8040
                  TabIndex        =   127
                  Top             =   1245
                  Width           =   1575
               End
               Begin VB.Label Label2 
                  Caption         =   "Differenza"
                  Height          =   255
                  Index           =   16
                  Left            =   8040
                  TabIndex        =   126
                  Top             =   1725
                  Width           =   1575
               End
               Begin VB.Label Label3 
                  Caption         =   "Q.tà conferita"
                  Height          =   255
                  Index           =   9
                  Left            =   4320
                  TabIndex        =   125
                  Top             =   1245
                  Width           =   1575
               End
               Begin VB.Label Label3 
                  Caption         =   "Lotto di entrata (lotto di conferimento)"
                  Height          =   255
                  Index           =   8
                  Left            =   120
                  TabIndex        =   124
                  Top             =   765
                  Width           =   3375
               End
               Begin VB.Label Label3 
                  Caption         =   "Colli caricati"
                  Height          =   255
                  Index           =   7
                  Left            =   120
                  TabIndex        =   123
                  Top             =   1245
                  Width           =   1095
               End
               Begin VB.Label Label3 
                  Caption         =   "Lotto di produzione"
                  Height          =   255
                  Index           =   2
                  Left            =   6720
                  TabIndex        =   122
                  Top             =   285
                  Width           =   2295
               End
               Begin VB.Label Label3 
                  Caption         =   "Articolo"
                  Height          =   255
                  Index           =   1
                  Left            =   2520
                  TabIndex        =   121
                  Top             =   280
                  Width           =   2055
               End
               Begin VB.Label Label3 
                  Caption         =   "Codice articolo"
                  Height          =   255
                  Index           =   0
                  Left            =   120
                  TabIndex        =   120
                  Top             =   280
                  Width           =   2055
               End
               Begin VB.Label Label3 
                  Caption         =   "Imballo"
                  Height          =   255
                  Index           =   3
                  Left            =   7920
                  TabIndex        =   119
                  Top             =   765
                  Width           =   3255
               End
            End
            Begin VB.Frame Frame1 
               Caption         =   "DOCUMENTO DI CONFERIMENTO"
               BeginProperty Font 
                  Name            =   "Verdana"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               ForeColor       =   &H00C00000&
               Height          =   2295
               Left            =   120
               TabIndex        =   90
               Top             =   120
               Width           =   5655
               Begin VB.TextBox txtCodiceSocio 
                  Appearance      =   0  'Flat
                  Enabled         =   0   'False
                  Height          =   315
                  Left            =   120
                  TabIndex        =   133
                  Top             =   380
                  Width           =   615
               End
               Begin VB.TextBox txtSocio 
                  Appearance      =   0  'Flat
                  Enabled         =   0   'False
                  Height          =   315
                  Left            =   720
                  TabIndex        =   95
                  Top             =   380
                  Width           =   3495
               End
               Begin VB.TextBox txtNomeSocio 
                  Appearance      =   0  'Flat
                  BackColor       =   &H8000000F&
                  Enabled         =   0   'False
                  Height          =   315
                  Left            =   4200
                  Locked          =   -1  'True
                  TabIndex        =   94
                  TabStop         =   0   'False
                  Top             =   380
                  Width           =   1215
               End
               Begin VB.TextBox TxtIDAnagrafica 
                  BeginProperty Font 
                     Name            =   "MS Sans Serif"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
                  Height          =   285
                  Left            =   4200
                  TabIndex        =   93
                  Top             =   120
                  Visible         =   0   'False
                  Width           =   1215
               End
               Begin DMTDATETIMELib.dmtDate txtDataDocumento 
                  Height          =   315
                  Left            =   4200
                  TabIndex        =   91
                  TabStop         =   0   'False
                  Top             =   1400
                  Width           =   1215
                  _Version        =   65536
                  _ExtentX        =   2143
                  _ExtentY        =   556
                  _StockProps     =   253
                  BorderStyle     =   1
                  Enabled         =   0   'False
               End
               Begin DMTEDITNUMLib.dmtNumber txtNumeroDocumento 
                  Height          =   315
                  Left            =   3000
                  TabIndex        =   92
                  TabStop         =   0   'False
                  Top             =   1400
                  Width           =   1095
                  _Version        =   65536
                  _ExtentX        =   1931
                  _ExtentY        =   556
                  _StockProps     =   253
                  BorderStyle     =   1
                  Enabled         =   0   'False
               End
               Begin DMTDataCmb.DMTCombo CboMagazzinoVend 
                  Height          =   315
                  Left            =   3000
                  TabIndex        =   96
                  TabStop         =   0   'False
                  Top             =   900
                  Width           =   2415
                  _ExtentX        =   4260
                  _ExtentY        =   556
                  BackColor       =   -2147483633
                  Enabled         =   0   'False
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
               End
               Begin DMTDataCmb.DMTCombo cboMagazzinoConf 
                  Height          =   315
                  Left            =   120
                  TabIndex        =   97
                  TabStop         =   0   'False
                  Top             =   900
                  Width           =   2775
                  _ExtentX        =   4895
                  _ExtentY        =   556
                  BackColor       =   -2147483633
                  Enabled         =   0   'False
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
               End
               Begin DMTDataCmb.DMTCombo cboSezionale 
                  Height          =   315
                  Left            =   120
                  TabIndex        =   98
                  TabStop         =   0   'False
                  Top             =   1395
                  Width           =   2775
                  _ExtentX        =   4895
                  _ExtentY        =   556
                  BackColor       =   -2147483633
                  Enabled         =   0   'False
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
               End
               Begin DMTDataCmb.DMTCombo cboTipoDocumentoCoop 
                  Height          =   315
                  Left            =   120
                  TabIndex        =   223
                  TabStop         =   0   'False
                  Top             =   1920
                  Width           =   3975
                  _ExtentX        =   7011
                  _ExtentY        =   556
                  BackColor       =   -2147483633
                  Enabled         =   0   'False
                  BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                     Name            =   "Verdana"
                     Size            =   8.25
                     Charset         =   0
                     Weight          =   400
                     Underline       =   0   'False
                     Italic          =   0   'False
                     Strikethrough   =   0   'False
                  EndProperty
               End
               Begin VB.Label Label12 
                  Caption         =   "Documento di conferimento"
                  Height          =   255
                  Left            =   120
                  TabIndex        =   224
                  Top             =   1720
                  Width           =   2775
               End
               Begin VB.Label Label1 
                  Caption         =   "N° Doc."
                  Height          =   255
                  Index           =   0
                  Left            =   3000
                  TabIndex        =   104
                  Top             =   1200
                  Width           =   975
               End
               Begin VB.Label Label1 
                  Caption         =   "Data Doc."
                  Height          =   255
                  Index           =   1
                  Left            =   4200
                  TabIndex        =   103
                  Top             =   1200
                  Width           =   1095
               End
               Begin VB.Label Label1 
                  Caption         =   "Sezionale"
                  Height          =   255
                  Index           =   2
                  Left            =   120
                  TabIndex        =   102
                  Top             =   1200
                  Width           =   2535
               End
               Begin VB.Label Label1 
                  Caption         =   "Magazzino di conferimento"
                  Height          =   255
                  Index           =   3
                  Left            =   120
                  TabIndex        =   101
                  Top             =   690
                  Width           =   2535
               End
               Begin VB.Label Label1 
                  Caption         =   "Magazzino di vendita"
                  Height          =   255
                  Index           =   4
                  Left            =   3000
                  TabIndex        =   100
                  Top             =   690
                  Width           =   2415
               End
               Begin VB.Label Label1 
                  Caption         =   "Socio"
                  Height          =   255
                  Index           =   5
                  Left            =   120
                  TabIndex        =   99
                  Top             =   195
                  Width           =   5295
               End
            End
            Begin VB.Frame fraRighe 
               BeginProperty Font 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   400
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   8535
               Left            =   120
               TabIndex        =   105
               Top             =   2280
               Width           =   18615
               Begin TabDlg.SSTab SSTab1 
                  Height          =   8175
                  Left            =   120
                  TabIndex        =   134
                  Top             =   240
                  Width           =   18405
                  _ExtentX        =   32464
                  _ExtentY        =   14420
                  _Version        =   393216
                  Tabs            =   2
                  TabsPerRow      =   2
                  TabHeight       =   520
                  ForeColor       =   12582912
                  TabCaption(0)   =   " LAVORAZIONE MERCE"
                  TabPicture(0)   =   "frmMain.frx":48840
                  Tab(0).ControlEnabled=   -1  'True
                  Tab(0).Control(0)=   "Label2(11)"
                  Tab(0).Control(0).Enabled=   0   'False
                  Tab(0).Control(1)=   "Label2(10)"
                  Tab(0).Control(1).Enabled=   0   'False
                  Tab(0).Control(2)=   "Label2(9)"
                  Tab(0).Control(2).Enabled=   0   'False
                  Tab(0).Control(3)=   "lblImballo"
                  Tab(0).Control(3).Enabled=   0   'False
                  Tab(0).Control(4)=   "Label2(5)"
                  Tab(0).Control(4).Enabled=   0   'False
                  Tab(0).Control(5)=   "Label2(4)"
                  Tab(0).Control(5).Enabled=   0   'False
                  Tab(0).Control(6)=   "Label2(3)"
                  Tab(0).Control(6).Enabled=   0   'False
                  Tab(0).Control(7)=   "Label2(2)"
                  Tab(0).Control(7).Enabled=   0   'False
                  Tab(0).Control(8)=   "Label2(1)"
                  Tab(0).Control(8).Enabled=   0   'False
                  Tab(0).Control(9)=   "Label2(0)"
                  Tab(0).Control(9).Enabled=   0   'False
                  Tab(0).Control(10)=   "lblArticolo"
                  Tab(0).Control(10).Enabled=   0   'False
                  Tab(0).Control(11)=   "Label2(6)"
                  Tab(0).Control(11).Enabled=   0   'False
                  Tab(0).Control(12)=   "Label7(0)"
                  Tab(0).Control(12).Enabled=   0   'False
                  Tab(0).Control(13)=   "Label8(0)"
                  Tab(0).Control(13).Enabled=   0   'False
                  Tab(0).Control(14)=   "Label8(1)"
                  Tab(0).Control(14).Enabled=   0   'False
                  Tab(0).Control(15)=   "lblProtocollo"
                  Tab(0).Control(15).Enabled=   0   'False
                  Tab(0).Control(16)=   "Label2(32)"
                  Tab(0).Control(16).Enabled=   0   'False
                  Tab(0).Control(17)=   "Label2(33)"
                  Tab(0).Control(17).Enabled=   0   'False
                  Tab(0).Control(18)=   "cmdSalva"
                  Tab(0).Control(18).Enabled=   0   'False
                  Tab(0).Control(19)=   "txtPesoNetto"
                  Tab(0).Control(19).Enabled=   0   'False
                  Tab(0).Control(20)=   "Command1"
                  Tab(0).Control(20).Enabled=   0   'False
                  Tab(0).Control(21)=   "cmdScaricaImbPrim"
                  Tab(0).Control(21).Enabled=   0   'False
                  Tab(0).Control(22)=   "txtCostoConfezione"
                  Tab(0).Control(22).Enabled=   0   'False
                  Tab(0).Control(23)=   "cmdRefreshKit"
                  Tab(0).Control(23).Enabled=   0   'False
                  Tab(0).Control(24)=   "cmdLottoImballo"
                  Tab(0).Control(24).Enabled=   0   'False
                  Tab(0).Control(25)=   "Command3"
                  Tab(0).Control(25).Enabled=   0   'False
                  Tab(0).Control(26)=   "Command2"
                  Tab(0).Control(26).Enabled=   0   'False
                  Tab(0).Control(27)=   "chkConfermaDaUtentePrim"
                  Tab(0).Control(27).Enabled=   0   'False
                  Tab(0).Control(28)=   "chkTracciaImballoGestPrim"
                  Tab(0).Control(28).Enabled=   0   'False
                  Tab(0).Control(29)=   "txtGiacLottoImballoPrim"
                  Tab(0).Control(29).Enabled=   0   'False
                  Tab(0).Control(30)=   "txtDispLottoImballoPrim"
                  Tab(0).Control(30).Enabled=   0   'False
                  Tab(0).Control(31)=   "CDImballoPrimario"
                  Tab(0).Control(31).Enabled=   0   'False
                  Tab(0).Control(32)=   "FraEtichetteOLD"
                  Tab(0).Control(32).Enabled=   0   'False
                  Tab(0).Control(33)=   "FraEtichette"
                  Tab(0).Control(33).Enabled=   0   'False
                  Tab(0).Control(34)=   "txtNumeroConfImballo"
                  Tab(0).Control(34).Enabled=   0   'False
                  Tab(0).Control(35)=   "txtTaraConfImballo"
                  Tab(0).Control(35).Enabled=   0   'False
                  Tab(0).Control(36)=   "txtAndamentoOrdineDett"
                  Tab(0).Control(36).Enabled=   0   'False
                  Tab(0).Control(37)=   "txtGiacLottoImballo"
                  Tab(0).Control(37).Enabled=   0   'False
                  Tab(0).Control(38)=   "txtDispLottoImballo"
                  Tab(0).Control(38).Enabled=   0   'False
                  Tab(0).Control(39)=   "cboUMImballo"
                  Tab(0).Control(39).Enabled=   0   'False
                  Tab(0).Control(40)=   "txtColli"
                  Tab(0).Control(40).Enabled=   0   'False
                  Tab(0).Control(41)=   "txtPesoLordo"
                  Tab(0).Control(41).Enabled=   0   'False
                  Tab(0).Control(42)=   "txtTara"
                  Tab(0).Control(42).Enabled=   0   'False
                  Tab(0).Control(43)=   "txtPezzi"
                  Tab(0).Control(43).Enabled=   0   'False
                  Tab(0).Control(44)=   "txtQta_UM"
                  Tab(0).Control(44).Enabled=   0   'False
                  Tab(0).Control(45)=   "CDCodiceImballo"
                  Tab(0).Control(45).Enabled=   0   'False
                  Tab(0).Control(46)=   "cboUM"
                  Tab(0).Control(46).Enabled=   0   'False
                  Tab(0).Control(47)=   "txtTaraUnitaria"
                  Tab(0).Control(47).Enabled=   0   'False
                  Tab(0).Control(48)=   "CDArticolo"
                  Tab(0).Control(48).Enabled=   0   'False
                  Tab(0).Control(49)=   "CboTipoLavorazione"
                  Tab(0).Control(49).Enabled=   0   'False
                  Tab(0).Control(50)=   "cboCalibro"
                  Tab(0).Control(50).Enabled=   0   'False
                  Tab(0).Control(51)=   "cboTipoCategoria"
                  Tab(0).Control(51).Enabled=   0   'False
                  Tab(0).Control(52)=   "cmdNuovo"
                  Tab(0).Control(52).Enabled=   0   'False
                  Tab(0).Control(53)=   "cmdElimina"
                  Tab(0).Control(53).Enabled=   0   'False
                  Tab(0).Control(54)=   "txtImballo"
                  Tab(0).Control(54).Enabled=   0   'False
                  Tab(0).Control(55)=   "TxtArticolo"
                  Tab(0).Control(55).Enabled=   0   'False
                  Tab(0).Control(56)=   "chkNuovoMetodo"
                  Tab(0).Control(56).Enabled=   0   'False
                  Tab(0).Control(57)=   "cmdEspandiGriglia"
                  Tab(0).Control(57).Enabled=   0   'False
                  Tab(0).Control(58)=   "cmdRiduciGriglia"
                  Tab(0).Control(58).Enabled=   0   'False
                  Tab(0).Control(59)=   "txtNumeroProtocollo"
                  Tab(0).Control(59).Enabled=   0   'False
                  Tab(0).Control(60)=   "txtLottoVendita"
                  Tab(0).Control(60).Enabled=   0   'False
                  Tab(0).Control(61)=   "chkConfermaDaUtente"
                  Tab(0).Control(61).Enabled=   0   'False
                  Tab(0).Control(62)=   "chkTracciaImballoGest"
                  Tab(0).Control(62).Enabled=   0   'False
                  Tab(0).Control(63)=   "GrigliaCorpo"
                  Tab(0).Control(63).Enabled=   0   'False
                  Tab(0).Control(64)=   "FraCliente"
                  Tab(0).Control(64).Enabled=   0   'False
                  Tab(0).Control(65)=   "FraOrdineCliente"
                  Tab(0).Control(65).Enabled=   0   'False
                  Tab(0).Control(66)=   "cmdLottoImballoPrim"
                  Tab(0).Control(66).Enabled=   0   'False
                  Tab(0).Control(67)=   "FraPedana"
                  Tab(0).Control(67).Enabled=   0   'False
                  Tab(0).Control(68)=   "cmdSelezionaPedana"
                  Tab(0).Control(68).Enabled=   0   'False
                  Tab(0).Control(69)=   "cmdArticoliDerivati"
                  Tab(0).Control(69).Enabled=   0   'False
                  Tab(0).Control(70)=   "cmdStampaEtichettaPedana"
                  Tab(0).Control(70).Enabled=   0   'False
                  Tab(0).Control(71)=   "cmdNuovaPedana"
                  Tab(0).Control(71).Enabled=   0   'False
                  Tab(0).Control(72)=   "cmdPesaturaAutomatica"
                  Tab(0).Control(72).Enabled=   0   'False
                  Tab(0).Control(73)=   "cmdAnalizzaPedana"
                  Tab(0).Control(73).Enabled=   0   'False
                  Tab(0).Control(74)=   "cmdDuplicaRiga"
                  Tab(0).Control(74).Enabled=   0   'False
                  Tab(0).ControlCount=   75
                  TabCaption(1)   =   "GESTIONE SCARTI"
                  TabPicture(1)   =   "frmMain.frx":4885C
                  Tab(1).ControlEnabled=   0   'False
                  Tab(1).Control(0)=   "Label2(12)"
                  Tab(1).Control(1)=   "Label2(13)"
                  Tab(1).Control(2)=   "Label2(14)"
                  Tab(1).Control(3)=   "lblImballo_Q"
                  Tab(1).Control(4)=   "Label2(15)"
                  Tab(1).Control(5)=   "Label2(19)"
                  Tab(1).Control(6)=   "Label2(20)"
                  Tab(1).Control(7)=   "Label2(21)"
                  Tab(1).Control(8)=   "Label2(22)"
                  Tab(1).Control(9)=   "Label2(23)"
                  Tab(1).Control(10)=   "lblArticolo_Q"
                  Tab(1).Control(11)=   "Label2(25)"
                  Tab(1).Control(12)=   "Label2(7)"
                  Tab(1).Control(13)=   "Label2(28)"
                  Tab(1).Control(14)=   "Label2(29)"
                  Tab(1).Control(15)=   "Label2(30)"
                  Tab(1).Control(16)=   "Label2(31)"
                  Tab(1).Control(17)=   "txtPercResoQ"
                  Tab(1).Control(18)=   "txtSequenzaPrelievo"
                  Tab(1).Control(19)=   "txtQtaLavPrec"
                  Tab(1).Control(20)=   "txtQtaPrelievoQ"
                  Tab(1).Control(21)=   "CboTipoLavorazione_Q"
                  Tab(1).Control(22)=   "CDCodiceImballo_Q"
                  Tab(1).Control(23)=   "txtColli_Q"
                  Tab(1).Control(24)=   "txtPesoLordo_Q"
                  Tab(1).Control(25)=   "txtPesoNetto_Q"
                  Tab(1).Control(26)=   "txtTara_Q"
                  Tab(1).Control(27)=   "txtPezzi_Q"
                  Tab(1).Control(28)=   "txtQta_UM_Q"
                  Tab(1).Control(29)=   "cboUM_Q"
                  Tab(1).Control(30)=   "txtTaraUnitaria_Q"
                  Tab(1).Control(31)=   "txtDataLavorazione_Q"
                  Tab(1).Control(32)=   "GrigliaScarti"
                  Tab(1).Control(33)=   "CDArticolo_Q"
                  Tab(1).Control(34)=   "cmdNuovo_Q"
                  Tab(1).Control(35)=   "cmdSalva_Q"
                  Tab(1).Control(36)=   "cmdElimina_Q"
                  Tab(1).Control(36).Enabled=   0   'False
                  Tab(1).Control(37)=   "txtImballo_Q"
                  Tab(1).Control(38)=   "TxtArticolo_Q"
                  Tab(1).Control(39)=   "txtOraLav_Q"
                  Tab(1).Control(39).Enabled=   0   'False
                  Tab(1).ControlCount=   40
                  Begin VB.CommandButton cmdDuplicaRiga 
                     Height          =   615
                     Left            =   7320
                     Picture         =   "frmMain.frx":48878
                     Style           =   1  'Graphical
                     TabIndex        =   217
                     TabStop         =   0   'False
                     ToolTipText     =   "Duplicazione merce"
                     Top             =   300
                     Width           =   735
                  End
                  Begin VB.CommandButton cmdAnalizzaPedana 
                     BeginProperty Font 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   615
                     Left            =   6360
                     Picture         =   "frmMain.frx":48E02
                     Style           =   1  'Graphical
                     TabIndex        =   207
                     TabStop         =   0   'False
                     ToolTipText     =   "Analizza pedana"
                     Top             =   300
                     Width           =   735
                  End
                  Begin VB.CommandButton cmdPesaturaAutomatica 
                     BeginProperty Font 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   615
                     Left            =   3480
                     Picture         =   "frmMain.frx":4938C
                     Style           =   1  'Graphical
                     TabIndex        =   3
                     TabStop         =   0   'False
                     ToolTipText     =   "Pesatura automatica"
                     Top             =   300
                     Width           =   735
                  End
                  Begin VB.CommandButton cmdNuovaPedana 
                     BeginProperty Font 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   615
                     Left            =   2520
                     Picture         =   "frmMain.frx":49916
                     Style           =   1  'Graphical
                     TabIndex        =   1
                     ToolTipText     =   "Nuova pedana"
                     Top             =   300
                     Width           =   735
                  End
                  Begin VB.CommandButton cmdStampaEtichettaPedana 
                     BeginProperty Font 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   615
                     Left            =   4440
                     Picture         =   "frmMain.frx":49EA0
                     Style           =   1  'Graphical
                     TabIndex        =   4
                     TabStop         =   0   'False
                     ToolTipText     =   "Stampa etichetta di pedana"
                     Top             =   300
                     Width           =   735
                  End
                  Begin VB.CommandButton cmdArticoliDerivati 
                     BeginProperty Font 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   615
                     Left            =   5400
                     Picture         =   "frmMain.frx":4A42A
                     Style           =   1  'Graphical
                     TabIndex        =   5
                     TabStop         =   0   'False
                     ToolTipText     =   "Articoli derivati"
                     Top             =   300
                     Width           =   735
                  End
                  Begin VB.CommandButton cmdSelezionaPedana 
                     BeginProperty Font 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   615
                     Left            =   1560
                     Picture         =   "frmMain.frx":4A9B4
                     Style           =   1  'Graphical
                     TabIndex        =   2
                     ToolTipText     =   "Trova pedana"
                     Top             =   300
                     Width           =   735
                  End
                  Begin VB.Frame FraPedana 
                     Caption         =   "PEDANA"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     ForeColor       =   &H00C00000&
                     Height          =   855
                     Left            =   120
                     TabIndex        =   155
                     Top             =   660
                     Width           =   8175
                     Begin DMTEDITNUMLib.dmtNumber txtPesoPedana 
                        Height          =   315
                        Left            =   7080
                        TabIndex        =   225
                        Top             =   480
                        Width           =   975
                        _Version        =   65536
                        _ExtentX        =   1720
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Appearance      =   1
                        UseSeparator    =   -1  'True
                        DecFinalZeros   =   -1  'True
                        AllowEmpty      =   0   'False
                     End
                     Begin VB.TextBox txtCodBarreImbAzienda 
                        Height          =   315
                        Left            =   3840
                        TabIndex        =   214
                        Top             =   3960
                        Width           =   4095
                     End
                     Begin VB.TextBox txtCodBarreArtAzienda 
                        Height          =   315
                        Left            =   3840
                        TabIndex        =   213
                        Top             =   3000
                        Width           =   4095
                     End
                     Begin VB.TextBox txtDescrCodBarreImbAzienda 
                        Height          =   315
                        Left            =   3840
                        TabIndex        =   212
                        Top             =   3600
                        Width           =   4095
                     End
                     Begin VB.TextBox txtDescrCodBarreArtAzienda 
                        Height          =   315
                        Left            =   3840
                        TabIndex        =   211
                        Top             =   2640
                        Width           =   4095
                     End
                     Begin VB.TextBox txtCodicePedana 
                        Height          =   315
                        Left            =   120
                        TabIndex        =   6
                        TabStop         =   0   'False
                        Top             =   480
                        Width           =   2535
                     End
                     Begin VB.TextBox txtArticoloInLinguaPred 
                        Height          =   315
                        Left            =   3840
                        TabIndex        =   9
                        TabStop         =   0   'False
                        Top             =   1440
                        Width           =   4095
                     End
                     Begin VB.TextBox txtCalibroInLiguaPred 
                        Height          =   315
                        Left            =   6000
                        TabIndex        =   11
                        TabStop         =   0   'False
                        Top             =   2040
                        Width           =   1935
                     End
                     Begin VB.TextBox txtCategoriaInLinguaPred 
                        Height          =   315
                        Left            =   3840
                        TabIndex        =   10
                        TabStop         =   0   'False
                        Top             =   2040
                        Width           =   2055
                     End
                     Begin VB.TextBox txtCodicePostazione 
                        Enabled         =   0   'False
                        Height          =   315
                        Left            =   120
                        TabIndex        =   14
                        TabStop         =   0   'False
                        Top             =   2640
                        Width           =   2895
                     End
                     Begin VB.TextBox txtUtenteMacchina 
                        Enabled         =   0   'False
                        Height          =   315
                        Left            =   120
                        TabIndex        =   16
                        Top             =   3840
                        Width           =   2895
                     End
                     Begin VB.TextBox txtNomeMacchina 
                        Enabled         =   0   'False
                        Height          =   315
                        Left            =   120
                        TabIndex        =   15
                        Top             =   3240
                        Width           =   2895
                     End
                     Begin DMTLblLinkCtl.LabelLink LabelLink2 
                        Height          =   255
                        Left            =   120
                        TabIndex        =   156
                        Top             =   260
                        Width           =   2415
                        _ExtentX        =   4260
                        _ExtentY        =   450
                        Caption         =   "Pedana"
                        Name            =   "LabelLink"
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtIDPedana 
                        Height          =   315
                        Left            =   120
                        TabIndex        =   12
                        TabStop         =   0   'False
                        Top             =   1440
                        Width           =   1815
                        _Version        =   65536
                        _ExtentX        =   3201
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   0   'False
                        Appearance      =   1
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTDataCmb.DMTCombo cboLinguaPred 
                        Height          =   315
                        Left            =   2040
                        TabIndex        =   8
                        TabStop         =   0   'False
                        Top             =   1440
                        Width           =   1695
                        _ExtentX        =   2990
                        _ExtentY        =   556
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Tahoma"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DMTDataCmb.DMTCombo cboUtente 
                        Height          =   315
                        Left            =   120
                        TabIndex        =   13
                        TabStop         =   0   'False
                        Top             =   2040
                        Width           =   2895
                        _ExtentX        =   5106
                        _ExtentY        =   556
                        Enabled         =   0   'False
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Tahoma"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DmtCodDescCtl.DmtCodDesc CDTipoPedana 
                        Height          =   615
                        Left            =   2760
                        TabIndex        =   7
                        Top             =   230
                        Width           =   4335
                        _ExtentX        =   7646
                        _ExtentY        =   1085
                        PropCodice      =   $"frmMain.frx":4AF3E
                        BeginProperty PropCodiceFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   -1  'True
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        PropDescrizione =   $"frmMain.frx":4AF8D
                        BeginProperty PropDescrizioneFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   -1  'True
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MenuFunctions   =   $"frmMain.frx":4AFE3
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   0   'False
                     End
                     Begin VB.Label Label5 
                        Caption         =   "Codice a barre imballo"
                        Height          =   255
                        Index           =   5
                        Left            =   3840
                        TabIndex        =   216
                        Top             =   3360
                        Width           =   2655
                     End
                     Begin VB.Label Label5 
                        Caption         =   "Codice a barre articolo"
                        Height          =   255
                        Index           =   4
                        Left            =   3840
                        TabIndex        =   215
                        Top             =   2400
                        Width           =   4095
                     End
                     Begin VB.Label Label7 
                        Caption         =   "Lingua predefinita"
                        Height          =   255
                        Index           =   5
                        Left            =   2040
                        TabIndex        =   165
                        Top             =   1200
                        Width           =   1695
                     End
                     Begin VB.Line Line5 
                        X1              =   120
                        X2              =   7920
                        Y1              =   1080
                        Y2              =   1080
                     End
                     Begin VB.Label Label7 
                        Caption         =   "Utente"
                        Height          =   255
                        Index           =   4
                        Left            =   120
                        TabIndex        =   164
                        Top             =   1800
                        Width           =   2415
                     End
                     Begin VB.Label Label11 
                        Caption         =   "Descrizione articolo in lingua predefinita"
                        Height          =   255
                        Index           =   3
                        Left            =   3840
                        TabIndex        =   163
                        Top             =   1200
                        Width           =   3615
                     End
                     Begin VB.Label Label11 
                        Caption         =   "Calibro in lingua "
                        Height          =   255
                        Index           =   4
                        Left            =   6000
                        TabIndex        =   162
                        Top             =   1800
                        Width           =   1455
                     End
                     Begin VB.Label Label11 
                        Caption         =   "Categoria in lingua "
                        Height          =   255
                        Index           =   5
                        Left            =   3840
                        TabIndex        =   161
                        Top             =   1800
                        Width           =   1695
                     End
                     Begin VB.Label Label7 
                        Caption         =   "Codice postazione"
                        Height          =   255
                        Index           =   6
                        Left            =   120
                        TabIndex        =   160
                        Top             =   2400
                        Width           =   2415
                     End
                     Begin VB.Label Label5 
                        Caption         =   "Utente macchina"
                        Height          =   255
                        Index           =   1
                        Left            =   120
                        TabIndex        =   159
                        Top             =   3600
                        Width           =   2295
                     End
                     Begin VB.Label Label5 
                        Caption         =   "Nome macchina"
                        Height          =   255
                        Index           =   2
                        Left            =   120
                        TabIndex        =   158
                        Top             =   3000
                        Width           =   2655
                     End
                     Begin VB.Label Label11 
                        Caption         =   "Identificativo pedana"
                        Height          =   255
                        Index           =   6
                        Left            =   120
                        TabIndex        =   157
                        Top             =   1200
                        Width           =   1815
                     End
                     Begin VB.Label Label8 
                        Caption         =   "Peso"
                        Height          =   255
                        Index           =   2
                        Left            =   7080
                        TabIndex        =   226
                        Top             =   285
                        Width           =   855
                     End
                  End
                  Begin VB.CommandButton cmdLottoImballoPrim 
                     Enabled         =   0   'False
                     Height          =   315
                     Left            =   16680
                     Picture         =   "frmMain.frx":4B03D
                     Style           =   1  'Graphical
                     TabIndex        =   332
                     ToolTipText     =   "Seleziona lotti imballo"
                     Top             =   2260
                     Width           =   375
                  End
                  Begin VB.Frame FraOrdineCliente 
                     Caption         =   "ORDINE CLIENTE"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     ForeColor       =   &H00C00000&
                     Height          =   1095
                     Left            =   8400
                     TabIndex        =   151
                     Top             =   420
                     Width           =   9855
                     Begin VB.CommandButton cmdSelRigaOrdine 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   7920
                        Picture         =   "frmMain.frx":4B5C7
                        Style           =   1  'Graphical
                        TabIndex        =   337
                        TabStop         =   0   'False
                        ToolTipText     =   "Seleziona riga ordine"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.CommandButton cmdAggiornaOrdinePadre 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   3840
                        Picture         =   "frmMain.frx":4BB51
                        Style           =   1  'Graphical
                        TabIndex        =   317
                        ToolTipText     =   "Aggiorna ordine cliente padre"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.TextBox txtNumeroOrdineOri 
                        Alignment       =   1  'Right Justify
                        Enabled         =   0   'False
                        Height          =   315
                        Left            =   7800
                        TabIndex        =   310
                        Top             =   3000
                        Width           =   1455
                     End
                     Begin VB.CommandButton cmdNListaPrelievo 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   2400
                        Picture         =   "frmMain.frx":4C0DB
                        Style           =   1  'Graphical
                        TabIndex        =   306
                        TabStop         =   0   'False
                        ToolTipText     =   "Nuova lista prelievo"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.TextBox txtNoteAgg 
                        Height          =   615
                        Left            =   480
                        TabIndex        =   298
                        Top             =   2160
                        Width           =   9255
                     End
                     Begin VB.CommandButton cmdEliminaRifOrdine 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   120
                        Picture         =   "frmMain.frx":4C665
                        Style           =   1  'Graphical
                        TabIndex        =   285
                        ToolTipText     =   "Aggiorna ordine cliente"
                        Top             =   1560
                        Width           =   375
                     End
                     Begin VB.CommandButton cmdAssegnazioneMerce 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   8880
                        Picture         =   "frmMain.frx":4CBEF
                        Style           =   1  'Graphical
                        TabIndex        =   231
                        TabStop         =   0   'False
                        ToolTipText     =   "Controllo lavorazioni"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.CommandButton cmdAnalizzaOrdine 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   8400
                        Picture         =   "frmMain.frx":4D179
                        Style           =   1  'Graphical
                        TabIndex        =   208
                        TabStop         =   0   'False
                        ToolTipText     =   "Analizza ordine"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.TextBox txtNumeroOrdineCliente 
                        Alignment       =   1  'Right Justify
                        Enabled         =   0   'False
                        Height          =   315
                        Left            =   3840
                        TabIndex        =   24
                        Top             =   1560
                        Width           =   1455
                     End
                     Begin VB.CommandButton cmdApriFrameOrdine 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   9360
                        Picture         =   "frmMain.frx":4D703
                        Style           =   1  'Graphical
                        TabIndex        =   185
                        TabStop         =   0   'False
                        ToolTipText     =   "Espandi maschera"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.CommandButton cmdAggiornaOrdineCliente 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   3360
                        Picture         =   "frmMain.frx":4DC8D
                        Style           =   1  'Graphical
                        TabIndex        =   182
                        ToolTipText     =   "Aggiorna ordine cliente"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.CommandButton cmdNuovoOrdine 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   1920
                        Picture         =   "frmMain.frx":4E217
                        Style           =   1  'Graphical
                        TabIndex        =   18
                        TabStop         =   0   'False
                        ToolTipText     =   "Nuovo ordine"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.CommandButton cmdSelezionaOrdine 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   2880
                        Picture         =   "frmMain.frx":4E7A1
                        Style           =   1  'Graphical
                        TabIndex        =   17
                        TabStop         =   0   'False
                        ToolTipText     =   "Trova ordine"
                        Top             =   0
                        Width           =   375
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtIDOrdineCliente 
                        Height          =   315
                        Left            =   480
                        TabIndex        =   22
                        Top             =   1560
                        Width           =   1815
                        _Version        =   65536
                        _ExtentX        =   3201
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   0   'False
                        Appearance      =   1
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtNumeroOrdine 
                        Height          =   315
                        Left            =   4560
                        TabIndex        =   21
                        Top             =   480
                        Width           =   1095
                        _Version        =   65536
                        _ExtentX        =   1931
                        _ExtentY        =   556
                        _StockProps     =   253
                        BackColor       =   16777215
                        Appearance      =   1
                     End
                     Begin DmtCodDescCtl.DmtCodDesc cdCliente 
                        Height          =   615
                        Left            =   120
                        TabIndex        =   19
                        TabStop         =   0   'False
                        Top             =   220
                        Width           =   4455
                        _ExtentX        =   7858
                        _ExtentY        =   1085
                        PropCodice      =   $"frmMain.frx":4ED2B
                        BeginProperty PropCodiceFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   -1  'True
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        PropDescrizione =   $"frmMain.frx":4ED79
                        BeginProperty PropDescrizioneFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   -1  'True
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        MenuFunctions   =   $"frmMain.frx":4EDCB
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DMTDATETIMELib.dmtDate txtDataOrdine 
                        Height          =   315
                        Left            =   5760
                        TabIndex        =   20
                        Top             =   480
                        Width           =   1335
                        _Version        =   65536
                        _ExtentX        =   2355
                        _ExtentY        =   556
                        _StockProps     =   253
                        BackColor       =   16777215
                        Appearance      =   1
                     End
                     Begin DMTDATETIMELib.dmtDate txtDataPartenza 
                        Height          =   315
                        Left            =   8280
                        TabIndex        =   25
                        Top             =   480
                        Width           =   1455
                        _Version        =   65536
                        _ExtentX        =   2566
                        _ExtentY        =   556
                        _StockProps     =   253
                        BackColor       =   16777215
                        Appearance      =   1
                     End
                     Begin DMTDATETIMELib.dmtDate txtDataOrdineCliente 
                        Height          =   315
                        Left            =   2400
                        TabIndex        =   23
                        Top             =   1560
                        Width           =   1335
                        _Version        =   65536
                        _ExtentX        =   2355
                        _ExtentY        =   556
                        _StockProps     =   253
                        BackColor       =   16777215
                        Enabled         =   0   'False
                        Appearance      =   1
                     End
                     Begin DMTLblLinkCtl.LabelLink lblLinkOrdine 
                        Height          =   255
                        Left            =   480
                        TabIndex        =   276
                        Top             =   2280
                        Visible         =   0   'False
                        Width           =   1695
                        _ExtentX        =   2990
                        _ExtentY        =   450
                        Caption         =   "Nuovo ordine"
                        Name            =   "LabelLink"
                     End
                     Begin DMTDataCmb.DMTCombo cboDestinazione 
                        Height          =   315
                        Left            =   5400
                        TabIndex        =   296
                        TabStop         =   0   'False
                        Top             =   1560
                        Width           =   4335
                        _ExtentX        =   7646
                        _ExtentY        =   556
                        Enabled         =   0   'False
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtNListaPrelievo 
                        Height          =   315
                        Left            =   7200
                        TabIndex        =   307
                        Top             =   480
                        Width           =   975
                        _Version        =   65536
                        _ExtentX        =   1720
                        _ExtentY        =   556
                        _StockProps     =   253
                        BackColor       =   16777215
                        Appearance      =   1
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtIDOrdinePadre 
                        Height          =   315
                        Left            =   480
                        TabIndex        =   309
                        Top             =   3000
                        Width           =   1815
                        _Version        =   65536
                        _ExtentX        =   3201
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   0   'False
                        Appearance      =   1
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTDATETIMELib.dmtDate txtDataOrdineOri 
                        Height          =   315
                        Left            =   6360
                        TabIndex        =   311
                        Top             =   3000
                        Width           =   1335
                        _Version        =   65536
                        _ExtentX        =   2355
                        _ExtentY        =   556
                        _StockProps     =   253
                        BackColor       =   16777215
                        Enabled         =   0   'False
                        Appearance      =   1
                     End
                     Begin DMTDataCmb.DMTCombo cboSezionaleOrdOri 
                        Height          =   315
                        Left            =   2400
                        TabIndex        =   315
                        TabStop         =   0   'False
                        Top             =   3000
                        Width           =   3855
                        _ExtentX        =   6800
                        _ExtentY        =   556
                        Enabled         =   0   'False
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin VB.TextBox txtAndamentoOrdine 
                        Alignment       =   2  'Center
                        Appearance      =   0  'Flat
                        BackColor       =   &H00FF8080&
                        BeginProperty Font 
                           Name            =   "Verdana"
                           Size            =   6.75
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   210
                        Left            =   4280
                        Locked          =   -1  'True
                        TabIndex        =   227
                        TabStop         =   0   'False
                        Text            =   "100"
                        Top             =   0
                        Visible         =   0   'False
                        Width           =   3615
                     End
                     Begin VB.Label lblNomeCliente 
                        Alignment       =   2  'Center
                        BeginProperty Font 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   210
                        Left            =   120
                        TabIndex        =   320
                        Top             =   840
                        Width           =   4335
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Sezionale"
                        Height          =   255
                        Index           =   7
                        Left            =   2400
                        TabIndex        =   316
                        Top             =   2805
                        Width           =   2415
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Ordine padre"
                        Height          =   255
                        Index           =   6
                        Left            =   480
                        TabIndex        =   314
                        Top             =   2805
                        Width           =   1815
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Data ord. ori."
                        Height          =   255
                        Index           =   4
                        Left            =   6360
                        TabIndex        =   313
                        Top             =   2805
                        Width           =   1335
                     End
                     Begin VB.Label Label5 
                        Caption         =   "Num. ord. ori."
                        Height          =   255
                        Index           =   7
                        Left            =   7800
                        TabIndex        =   312
                        Top             =   2805
                        Width           =   1215
                     End
                     Begin VB.Label Label5 
                        Caption         =   "N° lista"
                        Height          =   255
                        Index           =   6
                        Left            =   7200
                        TabIndex        =   308
                        Top             =   285
                        Width           =   975
                     End
                     Begin VB.Label Label3 
                        Caption         =   "Annotazioni aggiuntive lavorazione"
                        BeginProperty Font 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        ForeColor       =   &H00C00000&
                        Height          =   255
                        Index           =   10
                        Left            =   480
                        TabIndex        =   299
                        Top             =   1920
                        Width           =   7695
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Destinazione diversa"
                        Height          =   255
                        Index           =   1
                        Left            =   5400
                        TabIndex        =   297
                        Top             =   1320
                        Width           =   2415
                     End
                     Begin VB.Label Label5 
                        Caption         =   "Num. ord. cli."
                        Height          =   255
                        Index           =   3
                        Left            =   3840
                        TabIndex        =   189
                        Top             =   1320
                        Width           =   1215
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Data ord. cli."
                        Height          =   255
                        Index           =   5
                        Left            =   2400
                        TabIndex        =   188
                        Top             =   1320
                        Width           =   1215
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Data partenza"
                        Height          =   255
                        Index           =   3
                        Left            =   8280
                        TabIndex        =   187
                        Top             =   285
                        Width           =   1215
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Identificativo ordine"
                        Height          =   255
                        Index           =   2
                        Left            =   480
                        TabIndex        =   183
                        Top             =   1320
                        Width           =   1815
                     End
                     Begin VB.Label lblStatoOrdine 
                        Alignment       =   2  'Center
                        BeginProperty Font 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   210
                        Left            =   4560
                        TabIndex        =   154
                        Top             =   810
                        Width           =   5175
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Data ordine"
                        Height          =   255
                        Index           =   0
                        Left            =   5760
                        TabIndex        =   153
                        Top             =   285
                        Width           =   975
                     End
                     Begin VB.Label Label5 
                        Caption         =   "Numero"
                        Height          =   255
                        Index           =   0
                        Left            =   4560
                        TabIndex        =   152
                        Top             =   285
                        Width           =   975
                     End
                  End
                  Begin VB.Frame FraCliente 
                     Caption         =   "ALTRI DATI"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     ForeColor       =   &H00C00000&
                     Height          =   915
                     Left            =   10440
                     TabIndex        =   135
                     Top             =   2760
                     Width           =   7815
                     Begin VB.CommandButton cmdAltriDatiLav 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   6840
                        Picture         =   "frmMain.frx":4EE25
                        Style           =   1  'Graphical
                        TabIndex        =   342
                        TabStop         =   0   'False
                        ToolTipText     =   "Altri dati lavorazione"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.TextBox txtDescrizioneImballoInLinguaCliente 
                        Height          =   315
                        Left            =   3960
                        TabIndex        =   340
                        TabStop         =   0   'False
                        Top             =   2040
                        Width           =   3735
                     End
                     Begin VB.CommandButton cmdEliminaRifRigaOrd 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   120
                        Picture         =   "frmMain.frx":4F3AF
                        Style           =   1  'Graphical
                        TabIndex        =   338
                        TabStop         =   0   'False
                        ToolTipText     =   "Elimina riferimento riga ordine"
                        Top             =   3240
                        Width           =   375
                     End
                     Begin VB.TextBox txtRaggrOrd 
                        Height          =   315
                        Left            =   5520
                        TabIndex        =   330
                        Top             =   550
                        Width           =   2175
                     End
                     Begin VB.CommandButton cmdRefreshPrezzoDaOrd 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   1800
                        Picture         =   "frmMain.frx":4F939
                        Style           =   1  'Graphical
                        TabIndex        =   328
                        TabStop         =   0   'False
                        ToolTipText     =   "Recupera prezzi da ordine"
                        Top             =   3240
                        Width           =   375
                     End
                     Begin VB.TextBox txtOraLav 
                        Alignment       =   2  'Center
                        Height          =   315
                        Left            =   1320
                        Locked          =   -1  'True
                        TabIndex        =   323
                        TabStop         =   0   'False
                        Top             =   550
                        Width           =   975
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtIDRigaOrdine 
                        Height          =   315
                        Left            =   480
                        TabIndex        =   295
                        Top             =   3240
                        Width           =   1215
                        _Version        =   65536
                        _ExtentX        =   2143
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Enabled         =   0   'False
                        Appearance      =   1
                        DecimalPlaces   =   0
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtImportoUnitarioArticolo 
                        Height          =   315
                        Left            =   120
                        TabIndex        =   277
                        Top             =   3840
                        Width           =   1575
                        _Version        =   65536
                        _ExtentX        =   2778
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Enabled         =   0   'False
                        Appearance      =   1
                        UseSeparator    =   -1  'True
                        DecimalPlaces   =   5
                        DecFinalZeros   =   -1  'True
                        AllowEmpty      =   0   'False
                     End
                     Begin VB.CommandButton cmdApriFrameCliente 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   7320
                        Picture         =   "frmMain.frx":4FEC3
                        Style           =   1  'Graphical
                        TabIndex        =   184
                        TabStop         =   0   'False
                        ToolTipText     =   "Espandi maschera"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.CommandButton cmdRiprendiDatiCliente 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   6360
                        Picture         =   "frmMain.frx":5044D
                        Style           =   1  'Graphical
                        TabIndex        =   181
                        TabStop         =   0   'False
                        ToolTipText     =   "Ricalcola dati cliente"
                        Top             =   0
                        Width           =   375
                     End
                     Begin VB.TextBox txtLottoCliente 
                        BeginProperty Font 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   2400
                        TabIndex        =   46
                        TabStop         =   0   'False
                        Top             =   550
                        Width           =   3015
                     End
                     Begin VB.TextBox txtAltreAnnotazioniCliente 
                        BeginProperty Font 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   660
                        Left            =   120
                        MultiLine       =   -1  'True
                        ScrollBars      =   2  'Vertical
                        TabIndex        =   58
                        TabStop         =   0   'False
                        Top             =   4440
                        Width           =   5175
                     End
                     Begin VB.CheckBox chkPrezzoInclusoImballo 
                        Caption         =   "Incluso imballo"
                        Enabled         =   0   'False
                        Height          =   315
                        Left            =   5040
                        TabIndex        =   56
                        TabStop         =   0   'False
                        Top             =   3240
                        Width           =   1695
                     End
                     Begin VB.TextBox txtCodiceABarreArticoloCliente 
                        Height          =   315
                        Left            =   120
                        TabIndex        =   53
                        TabStop         =   0   'False
                        Top             =   2640
                        Width           =   2415
                     End
                     Begin VB.TextBox txtCodiceGSICliente 
                        Height          =   315
                        Left            =   5400
                        TabIndex        =   52
                        TabStop         =   0   'False
                        Top             =   3840
                        Width           =   2295
                     End
                     Begin VB.TextBox txtDescrizioneArticoloInLinguaCliente 
                        Height          =   315
                        Left            =   120
                        TabIndex        =   48
                        TabStop         =   0   'False
                        Top             =   2040
                        Width           =   3735
                     End
                     Begin VB.TextBox txtCategoriaInLingua 
                        Height          =   315
                        Left            =   2280
                        TabIndex        =   50
                        TabStop         =   0   'False
                        Top             =   1440
                        Width           =   1815
                     End
                     Begin VB.TextBox txtCalibroInLingua 
                        Height          =   315
                        Left            =   4200
                        TabIndex        =   51
                        TabStop         =   0   'False
                        Top             =   1440
                        Width           =   1575
                     End
                     Begin VB.TextBox txtCodificaArticoloCodiceABarre 
                        Height          =   315
                        Left            =   120
                        TabIndex        =   138
                        Top             =   2640
                        Visible         =   0   'False
                        Width           =   2415
                     End
                     Begin VB.TextBox txtCodiceABarreImballoCliente 
                        Height          =   315
                        Left            =   2640
                        TabIndex        =   55
                        TabStop         =   0   'False
                        Top             =   2640
                        Width           =   2415
                     End
                     Begin VB.TextBox txtCodificaImballoCodiceABarre 
                        Height          =   315
                        Left            =   2640
                        TabIndex        =   137
                        Top             =   2640
                        Visible         =   0   'False
                        Width           =   2415
                     End
                     Begin VB.TextBox txtCodiceAssociatoPressoCliente 
                        Height          =   315
                        Left            =   5400
                        TabIndex        =   54
                        TabStop         =   0   'False
                        Top             =   4440
                        Width           =   2295
                     End
                     Begin VB.TextBox txtCodificaCodicePedanaCliente 
                        Enabled         =   0   'False
                        Height          =   315
                        Left            =   5160
                        TabIndex        =   57
                        TabStop         =   0   'False
                        Top             =   2640
                        Width           =   2535
                     End
                     Begin VB.CommandButton cmdStampaPedanaCliente 
                        BeginProperty Font 
                           Name            =   "MS Sans Serif"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   315
                        Left            =   5880
                        Picture         =   "frmMain.frx":507D7
                        Style           =   1  'Graphical
                        TabIndex        =   136
                        TabStop         =   0   'False
                        ToolTipText     =   "Stampa pedana cliente"
                        Top             =   0
                        Width           =   375
                     End
                     Begin DMTDataCmb.DMTCombo cboLinguaCliente 
                        Height          =   315
                        Left            =   120
                        TabIndex        =   47
                        TabStop         =   0   'False
                        Top             =   1440
                        Width           =   2055
                        _ExtentX        =   3625
                        _ExtentY        =   556
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtCodicePedanaCliente 
                        Height          =   315
                        Left            =   5880
                        TabIndex        =   49
                        TabStop         =   0   'False
                        Top             =   1440
                        Width           =   1815
                        _Version        =   65536
                        _ExtentX        =   3201
                        _ExtentY        =   556
                        _StockProps     =   253
                        BackColor       =   16777215
                        Appearance      =   1
                     End
                     Begin DMTDataCmb.DMTCombo cboListino 
                        Height          =   315
                        Left            =   2160
                        TabIndex        =   209
                        Top             =   3240
                        Width           =   2775
                        _ExtentX        =   4895
                        _ExtentY        =   556
                        Enabled         =   0   'False
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Tahoma"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtSconto2 
                        Height          =   315
                        Left            =   2760
                        TabIndex        =   278
                        Top             =   3840
                        Width           =   855
                        _Version        =   65536
                        _ExtentX        =   1508
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Enabled         =   0   'False
                        Appearance      =   1
                        UseSeparator    =   -1  'True
                        DecimalPlaces   =   1
                        DecFinalZeros   =   -1  'True
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtSconto1 
                        Height          =   315
                        Left            =   1800
                        TabIndex        =   279
                        Top             =   3840
                        Width           =   855
                        _Version        =   65536
                        _ExtentX        =   1508
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Enabled         =   0   'False
                        Appearance      =   1
                        UseSeparator    =   -1  'True
                        DecimalPlaces   =   1
                        DecFinalZeros   =   -1  'True
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtImportoUnitarioImballo 
                        Height          =   315
                        Left            =   3720
                        TabIndex        =   280
                        Top             =   3840
                        Width           =   1575
                        _Version        =   65536
                        _ExtentX        =   2778
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Enabled         =   0   'False
                        Appearance      =   1
                        UseSeparator    =   -1  'True
                        DecimalPlaces   =   5
                        DecFinalZeros   =   -1  'True
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtImportoUnitarioListino 
                        Height          =   315
                        Left            =   5040
                        TabIndex        =   294
                        Top             =   3240
                        Visible         =   0   'False
                        Width           =   1215
                        _Version        =   65536
                        _ExtentX        =   2143
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Enabled         =   0   'False
                        Appearance      =   1
                        UseSeparator    =   -1  'True
                        DecimalPlaces   =   5
                        DecFinalZeros   =   -1  'True
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTDATETIMELib.dmtDate txtDataLavorazione 
                        Height          =   315
                        Left            =   120
                        TabIndex        =   324
                        TabStop         =   0   'False
                        Top             =   550
                        Width           =   1215
                        _Version        =   65536
                        _ExtentX        =   2143
                        _ExtentY        =   556
                        _StockProps     =   253
                        BackColor       =   16777215
                        Appearance      =   1
                     End
                     Begin VB.Label Label11 
                        Caption         =   "Descrizione imballo in lingua"
                        Height          =   255
                        Index           =   7
                        Left            =   3960
                        TabIndex        =   341
                        Top             =   1800
                        Width           =   3735
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Sub lotto"
                        Height          =   255
                        Index           =   20
                        Left            =   5520
                        TabIndex        =   331
                        Top             =   340
                        Width           =   2055
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Rif. riga ord."
                        Height          =   255
                        Index           =   9
                        Left            =   480
                        TabIndex        =   329
                        Top             =   3000
                        Width           =   1215
                     End
                     Begin VB.Label Label2 
                        Caption         =   "Data lav."
                        Height          =   255
                        Index           =   8
                        Left            =   120
                        TabIndex        =   326
                        Top             =   340
                        Width           =   1095
                     End
                     Begin VB.Label Label2 
                        Caption         =   "Ora"
                        Height          =   255
                        Index           =   24
                        Left            =   1320
                        TabIndex        =   325
                        Top             =   340
                        Width           =   975
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Imp. Uni. Imb"
                        Height          =   255
                        Index           =   19
                        Left            =   3720
                        TabIndex        =   284
                        Top             =   3600
                        Width           =   1215
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Sc.2 %"
                        Height          =   255
                        Index           =   18
                        Left            =   2760
                        TabIndex        =   283
                        Top             =   3600
                        Width           =   615
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Sc.1 %"
                        Height          =   255
                        Index           =   17
                        Left            =   1800
                        TabIndex        =   282
                        Top             =   3600
                        Width           =   615
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Imp. Uni. Art."
                        Height          =   255
                        Index           =   15
                        Left            =   120
                        TabIndex        =   281
                        Top             =   3600
                        Width           =   1455
                     End
                     Begin VB.Label Label4 
                        Caption         =   "Listino"
                        Height          =   255
                        Index           =   8
                        Left            =   2160
                        TabIndex        =   210
                        Top             =   3000
                        Width           =   1695
                     End
                     Begin VB.Label Label7 
                        Caption         =   "Lotto cliente"
                        Height          =   255
                        Index           =   1
                        Left            =   2400
                        TabIndex        =   150
                        Top             =   340
                        Width           =   2415
                     End
                     Begin VB.Label Label7 
                        Caption         =   "Altre annotazioni per il  cliente"
                        Height          =   255
                        Index           =   2
                        Left            =   120
                        TabIndex        =   149
                        Top             =   4200
                        Width           =   3855
                     End
                     Begin VB.Label Label7 
                        Caption         =   "Lingua cliente"
                        Height          =   255
                        Index           =   3
                        Left            =   120
                        TabIndex        =   148
                        Top             =   1200
                        Width           =   2055
                     End
                     Begin VB.Label Label6 
                        Caption         =   "Codice a barre articolo"
                        Height          =   255
                        Index           =   0
                        Left            =   120
                        TabIndex        =   147
                        Top             =   2400
                        Width           =   2415
                     End
                     Begin VB.Label Label6 
                        Caption         =   "N° Ped. cliente"
                        Height          =   255
                        Index           =   1
                        Left            =   5880
                        TabIndex        =   146
                        Top             =   1200
                        Width           =   1815
                     End
                     Begin VB.Label Label6 
                        Caption         =   "Codice G.S.I."
                        Height          =   255
                        Index           =   2
                        Left            =   5400
                        TabIndex        =   145
                        Top             =   3600
                        Width           =   1335
                     End
                     Begin VB.Label Label11 
                        Caption         =   "Descrizione articolo in lingua"
                        Height          =   255
                        Index           =   0
                        Left            =   120
                        TabIndex        =   144
                        Top             =   1800
                        Width           =   3735
                     End
                     Begin VB.Label Label11 
                        Caption         =   "Categoria in lingua "
                        Height          =   255
                        Index           =   1
                        Left            =   2280
                        TabIndex        =   143
                        Top             =   1200
                        Width           =   1695
                     End
                     Begin VB.Label Label11 
                        Caption         =   "Calibro in lingua "
                        Height          =   255
                        Index           =   2
                        Left            =   4200
                        TabIndex        =   142
                        Top             =   1200
                        Width           =   1455
                     End
                     Begin VB.Label Label6 
                        Caption         =   "Codice a barre imballo"
                        Height          =   255
                        Index           =   3
                        Left            =   2640
                        TabIndex        =   141
                        Top             =   2400
                        Width           =   2415
                     End
                     Begin VB.Label Label6 
                        Caption         =   "Cod. ass."
                        Height          =   255
                        Index           =   4
                        Left            =   5400
                        TabIndex        =   140
                        ToolTipText     =   "Codice associato"
                        Top             =   4200
                        Width           =   975
                     End
                     Begin VB.Label Label6 
                        Caption         =   "Codice pedana cliente"
                        Height          =   255
                        Index           =   5
                        Left            =   5160
                        TabIndex        =   139
                        Top             =   2400
                        Width           =   2535
                     End
                  End
                  Begin DmtGridCtl.DmtGrid GrigliaCorpo 
                     Height          =   2775
                     Left            =   120
                     TabIndex        =   82
                     TabStop         =   0   'False
                     Top             =   3720
                     Width           =   16575
                     _ExtentX        =   29236
                     _ExtentY        =   4895
                     BackColor       =   16777215
                     ForeColor       =   0
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     EnableMove      =   0   'False
                     UseUserSettings =   0   'False
                     ColumnsHeaderHeight=   20
                  End
                  Begin VB.CheckBox chkTracciaImballoGest 
                     Caption         =   "Traccia"
                     Height          =   255
                     Left            =   1920
                     TabIndex        =   293
                     Top             =   4080
                     Width           =   975
                  End
                  Begin VB.CheckBox chkConfermaDaUtente 
                     Caption         =   "Conferma da utente"
                     Height          =   255
                     Left            =   5160
                     TabIndex        =   290
                     Top             =   4080
                     Width           =   2535
                  End
                  Begin VB.TextBox txtLottoVendita 
                     Height          =   315
                     Left            =   6120
                     Locked          =   -1  'True
                     TabIndex        =   83
                     TabStop         =   0   'False
                     Top             =   2265
                     Width           =   5895
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtNumeroProtocollo 
                     Height          =   315
                     Left            =   10800
                     TabIndex        =   229
                     Top             =   2265
                     Visible         =   0   'False
                     Width           =   1215
                     _Version        =   65536
                     _ExtentX        =   2143
                     _ExtentY        =   556
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     Enabled         =   0   'False
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin VB.TextBox txtOraLav_Q 
                     Alignment       =   2  'Center
                     Height          =   315
                     Left            =   -61680
                     Locked          =   -1  'True
                     TabIndex        =   67
                     TabStop         =   0   'False
                     Top             =   735
                     Width           =   975
                  End
                  Begin VB.TextBox TxtArticolo_Q 
                     Height          =   315
                     Left            =   -73080
                     TabIndex        =   63
                     Top             =   735
                     Width           =   3615
                  End
                  Begin VB.TextBox txtImballo_Q 
                     Height          =   315
                     Left            =   -73200
                     TabIndex        =   69
                     Top             =   1335
                     Width           =   3735
                  End
                  Begin VB.CommandButton cmdElimina_Q 
                     Caption         =   "Elimina"
                     Height          =   375
                     Left            =   -58200
                     TabIndex        =   80
                     TabStop         =   0   'False
                     Top             =   5160
                     Width           =   1455
                  End
                  Begin VB.CommandButton cmdSalva_Q 
                     Caption         =   "Salva"
                     Height          =   375
                     Left            =   -58200
                     TabIndex        =   78
                     Top             =   4200
                     Width           =   1455
                  End
                  Begin VB.CommandButton cmdNuovo_Q 
                     Caption         =   "Nuovo"
                     Height          =   375
                     Left            =   -58200
                     TabIndex        =   79
                     Top             =   3240
                     Width           =   1455
                  End
                  Begin VB.CommandButton cmdRiduciGriglia 
                     Height          =   315
                     Left            =   120
                     Picture         =   "frmMain.frx":50D61
                     Style           =   1  'Graphical
                     TabIndex        =   194
                     ToolTipText     =   "Riduci griglia"
                     Top             =   3360
                     Visible         =   0   'False
                     Width           =   495
                  End
                  Begin VB.CommandButton cmdEspandiGriglia 
                     Height          =   315
                     Left            =   120
                     Picture         =   "frmMain.frx":512EB
                     Style           =   1  'Graphical
                     TabIndex        =   192
                     ToolTipText     =   "Espandi griglia"
                     Top             =   3360
                     Width           =   495
                  End
                  Begin VB.CheckBox chkNuovoMetodo 
                     Caption         =   "Stampa con il nuovo metodo"
                     Height          =   255
                     Left            =   720
                     TabIndex        =   193
                     Top             =   3480
                     Width           =   2895
                  End
                  Begin VB.TextBox TxtArticolo 
                     Height          =   315
                     Left            =   1920
                     TabIndex        =   27
                     Top             =   1730
                     Width           =   3615
                  End
                  Begin VB.TextBox txtImballo 
                     Height          =   315
                     Left            =   9240
                     TabIndex        =   30
                     Top             =   1725
                     Width           =   3855
                  End
                  Begin VB.CommandButton cmdElimina 
                     Caption         =   "Elimina"
                     Height          =   375
                     Left            =   16800
                     TabIndex        =   61
                     TabStop         =   0   'False
                     Top             =   5520
                     Width           =   1455
                  End
                  Begin VB.CommandButton cmdNuovo 
                     Caption         =   "Nuovo"
                     Height          =   375
                     Left            =   16800
                     TabIndex        =   60
                     Top             =   4080
                     Width           =   1455
                  End
                  Begin DMTDataCmb.DMTCombo cboTipoCategoria 
                     Height          =   315
                     Left            =   3120
                     TabIndex        =   36
                     TabStop         =   0   'False
                     Top             =   2265
                     Width           =   1455
                     _ExtentX        =   2566
                     _ExtentY        =   556
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                  End
                  Begin DMTDataCmb.DMTCombo cboCalibro 
                     Height          =   315
                     Left            =   4680
                     TabIndex        =   37
                     TabStop         =   0   'False
                     Top             =   2265
                     Width           =   1335
                     _ExtentX        =   2355
                     _ExtentY        =   556
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                  End
                  Begin DMTDataCmb.DMTCombo CboTipoLavorazione 
                     Height          =   315
                     Left            =   120
                     TabIndex        =   35
                     TabStop         =   0   'False
                     Top             =   2265
                     Width           =   2895
                     _ExtentX        =   5106
                     _ExtentY        =   556
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                  End
                  Begin DmtCodDescCtl.DmtCodDesc CDArticolo 
                     Height          =   615
                     Left            =   120
                     TabIndex        =   26
                     Top             =   1470
                     Width           =   1815
                     _ExtentX        =   3201
                     _ExtentY        =   1085
                     PropCodice      =   $"frmMain.frx":51875
                     BeginProperty PropCodiceFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     PropDescrizione =   $"frmMain.frx":518C4
                     BeginProperty PropDescrizioneFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     MenuFunctions   =   $"frmMain.frx":5191C
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtTaraUnitaria 
                     Height          =   315
                     Left            =   15240
                     TabIndex        =   32
                     TabStop         =   0   'False
                     Top             =   1730
                     Width           =   975
                     _Version        =   65536
                     _ExtentX        =   1720
                     _ExtentY        =   556
                     _StockProps     =   253
                     BackColor       =   16777215
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecimalPlaces   =   5
                     DecFinalZeros   =   -1  'True
                  End
                  Begin DMTDataCmb.DMTCombo cboUM 
                     Height          =   315
                     Left            =   6000
                     TabIndex        =   28
                     TabStop         =   0   'False
                     Top             =   1725
                     Width           =   1455
                     _ExtentX        =   2566
                     _ExtentY        =   556
                     Enabled         =   0   'False
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                  End
                  Begin DmtCodDescCtl.DmtCodDesc CDCodiceImballo 
                     Height          =   615
                     Left            =   7560
                     TabIndex        =   29
                     Top             =   1470
                     Width           =   1695
                     _ExtentX        =   2990
                     _ExtentY        =   1085
                     PropCodice      =   $"frmMain.frx":51976
                     BeginProperty PropCodiceFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     PropDescrizione =   $"frmMain.frx":519CD
                     BeginProperty PropDescrizioneFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     MenuFunctions   =   $"frmMain.frx":51A24
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtQta_UM 
                     Height          =   405
                     Left            =   8640
                     TabIndex        =   45
                     TabStop         =   0   'False
                     Top             =   2880
                     Width           =   1695
                     _Version        =   65536
                     _ExtentX        =   2990
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtPezzi 
                     Height          =   405
                     Left            =   6840
                     TabIndex        =   44
                     Top             =   2880
                     Width           =   1695
                     _Version        =   65536
                     _ExtentX        =   2990
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtTara 
                     Height          =   405
                     Left            =   3480
                     TabIndex        =   42
                     Top             =   2880
                     Width           =   1455
                     _Version        =   65536
                     _ExtentX        =   2566
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtPesoLordo 
                     Height          =   405
                     Left            =   1680
                     TabIndex        =   41
                     Top             =   2880
                     Width           =   1695
                     _Version        =   65536
                     _ExtentX        =   2990
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtColli 
                     Height          =   405
                     Left            =   120
                     TabIndex        =   40
                     Top             =   2880
                     Width           =   1455
                     _Version        =   65536
                     _ExtentX        =   2566
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTDataCmb.DMTCombo cboUMImballo 
                     Height          =   315
                     Left            =   13920
                     TabIndex        =   31
                     TabStop         =   0   'False
                     Top             =   1725
                     Width           =   1215
                     _ExtentX        =   2143
                     _ExtentY        =   556
                     Enabled         =   0   'False
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                  End
                  Begin DmtCodDescCtl.DmtCodDesc CDArticolo_Q 
                     Height          =   615
                     Left            =   -74880
                     TabIndex        =   62
                     Top             =   480
                     Width           =   1815
                     _ExtentX        =   3201
                     _ExtentY        =   1085
                     PropCodice      =   $"frmMain.frx":51A7E
                     BeginProperty PropCodiceFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     PropDescrizione =   $"frmMain.frx":51ACD
                     BeginProperty PropDescrizioneFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     MenuFunctions   =   $"frmMain.frx":51B1A
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                  End
                  Begin DmtGridCtl.DmtGrid GrigliaScarti 
                     Height          =   5520
                     Left            =   -74880
                     TabIndex        =   81
                     TabStop         =   0   'False
                     Top             =   2415
                     Width           =   16575
                     _ExtentX        =   29236
                     _ExtentY        =   9737
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     EnableMove      =   0   'False
                     ColumnsHeaderHeight=   20
                  End
                  Begin DMTDATETIMELib.dmtDate txtDataLavorazione_Q 
                     Height          =   315
                     Left            =   -63240
                     TabIndex        =   66
                     TabStop         =   0   'False
                     Top             =   735
                     Width           =   1575
                     _Version        =   65536
                     _ExtentX        =   2778
                     _ExtentY        =   556
                     _StockProps     =   253
                     BackColor       =   16777215
                     Appearance      =   1
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtTaraUnitaria_Q 
                     Height          =   315
                     Left            =   -69360
                     TabIndex        =   70
                     TabStop         =   0   'False
                     Top             =   1335
                     Width           =   1575
                     _Version        =   65536
                     _ExtentX        =   2778
                     _ExtentY        =   556
                     _StockProps     =   253
                     BackColor       =   16777215
                     Enabled         =   0   'False
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                  End
                  Begin DMTDataCmb.DMTCombo cboUM_Q 
                     Height          =   315
                     Left            =   -69360
                     TabIndex        =   64
                     TabStop         =   0   'False
                     Top             =   735
                     Width           =   2655
                     _ExtentX        =   4683
                     _ExtentY        =   556
                     Enabled         =   0   'False
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtQta_UM_Q 
                     Height          =   405
                     Left            =   -62040
                     TabIndex        =   77
                     Top             =   1920
                     Width           =   1935
                     _Version        =   65536
                     _ExtentX        =   3413
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtPezzi_Q 
                     Height          =   405
                     Left            =   -64080
                     TabIndex        =   76
                     Top             =   1920
                     Width           =   1935
                     _Version        =   65536
                     _ExtentX        =   3413
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtTara_Q 
                     Height          =   405
                     Left            =   -67440
                     TabIndex        =   74
                     Top             =   1920
                     Width           =   1455
                     _Version        =   65536
                     _ExtentX        =   2566
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtPesoNetto_Q 
                     Height          =   405
                     Left            =   -65880
                     TabIndex        =   75
                     Top             =   1920
                     Width           =   1695
                     _Version        =   65536
                     _ExtentX        =   2990
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtPesoLordo_Q 
                     Height          =   405
                     Left            =   -69360
                     TabIndex        =   73
                     Top             =   1920
                     Width           =   1815
                     _Version        =   65536
                     _ExtentX        =   3201
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtColli_Q 
                     Height          =   405
                     Left            =   -70680
                     TabIndex        =   72
                     Top             =   1920
                     Width           =   1215
                     _Version        =   65536
                     _ExtentX        =   2143
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DmtCodDescCtl.DmtCodDesc CDCodiceImballo_Q 
                     Height          =   615
                     Left            =   -74880
                     TabIndex        =   68
                     Top             =   1080
                     Width           =   1695
                     _ExtentX        =   2990
                     _ExtentY        =   1085
                     PropCodice      =   $"frmMain.frx":51B74
                     BeginProperty PropCodiceFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     PropDescrizione =   $"frmMain.frx":51BCB
                     BeginProperty PropDescrizioneFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "MS Sans Serif"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     MenuFunctions   =   $"frmMain.frx":51C22
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                  End
                  Begin DMTDataCmb.DMTCombo CboTipoLavorazione_Q 
                     Height          =   315
                     Left            =   -66600
                     TabIndex        =   65
                     Top             =   735
                     Width           =   3255
                     _ExtentX        =   5741
                     _ExtentY        =   556
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtDispLottoImballo 
                     Height          =   255
                     Left            =   3960
                     TabIndex        =   291
                     Top             =   4080
                     Width           =   975
                     _Version        =   65536
                     _ExtentX        =   1720
                     _ExtentY        =   450
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     Appearance      =   1
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtGiacLottoImballo 
                     Height          =   255
                     Left            =   3000
                     TabIndex        =   292
                     Top             =   4080
                     Width           =   855
                     _Version        =   65536
                     _ExtentX        =   1508
                     _ExtentY        =   450
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     Appearance      =   1
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtQtaPrelievoQ 
                     Height          =   405
                     Left            =   -74280
                     TabIndex        =   71
                     Top             =   1920
                     Width           =   1575
                     _Version        =   65536
                     _ExtentX        =   2778
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtQtaLavPrec 
                     Height          =   405
                     Left            =   -72600
                     TabIndex        =   301
                     Top             =   1920
                     Width           =   1815
                     _Version        =   65536
                     _ExtentX        =   3201
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtSequenzaPrelievo 
                     Height          =   405
                     Left            =   -74880
                     TabIndex        =   304
                     Top             =   1920
                     Width           =   495
                     _Version        =   65536
                     _ExtentX        =   873
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                     Appearance      =   1
                     DecimalPlaces   =   0
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtPercResoQ 
                     Height          =   405
                     Left            =   -60000
                     TabIndex        =   318
                     Top             =   1920
                     Width           =   1455
                     _Version        =   65536
                     _ExtentX        =   2566
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin VB.TextBox txtAndamentoOrdineDett 
                     Alignment       =   2  'Center
                     Appearance      =   0  'Flat
                     BackColor       =   &H00FF8080&
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   9.75
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   360
                     Left            =   3720
                     Locked          =   -1  'True
                     TabIndex        =   228
                     TabStop         =   0   'False
                     Text            =   "100"
                     Top             =   3340
                     Visible         =   0   'False
                     Width           =   6615
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtTaraConfImballo 
                     Height          =   315
                     Left            =   17280
                     TabIndex        =   34
                     Top             =   1730
                     Width           =   975
                     _Version        =   65536
                     _ExtentX        =   1720
                     _ExtentY        =   556
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecimalPlaces   =   5
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtNumeroConfImballo 
                     Height          =   315
                     Left            =   16320
                     TabIndex        =   33
                     Top             =   1730
                     Width           =   855
                     _Version        =   65536
                     _ExtentX        =   1508
                     _ExtentY        =   556
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecimalPlaces   =   0
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin VB.Frame FraEtichette 
                     Caption         =   "STAMPA ETICHETTE"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     ForeColor       =   &H00C00000&
                     Height          =   1575
                     Left            =   120
                     TabIndex        =   232
                     Top             =   6480
                     Visible         =   0   'False
                     Width           =   18135
                     Begin VB.ComboBox cboStampaNew 
                        Height          =   315
                        Left            =   3840
                        TabIndex        =   251
                        TabStop         =   0   'False
                        Top             =   480
                        Width           =   6135
                     End
                     Begin VB.CommandButton cmdStampaEtichetteNew 
                        Caption         =   "STAMPA"
                        BeginProperty Font 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   1215
                        Left            =   11400
                        TabIndex        =   250
                        TabStop         =   0   'False
                        Top             =   240
                        Width           =   975
                     End
                     Begin VB.ComboBox cboStampantePedNew 
                        Height          =   315
                        Left            =   3840
                        TabIndex        =   249
                        TabStop         =   0   'False
                        Top             =   1080
                        Width           =   6135
                     End
                     Begin VB.CommandButton cmdPropEtiLavPro 
                        Height          =   315
                        Left            =   240
                        Picture         =   "frmMain.frx":51C7C
                        Style           =   1  'Graphical
                        TabIndex        =   248
                        ToolTipText     =   "Proprietà della stampa"
                        Top             =   480
                        Width           =   375
                     End
                     Begin VB.Frame FraPropEtiLavPro 
                        Caption         =   "Proprietà report di lavorazione"
                        BeginProperty Font 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        ForeColor       =   &H00FF0000&
                        Height          =   1335
                        Left            =   12480
                        TabIndex        =   241
                        Top             =   120
                        Visible         =   0   'False
                        Width           =   5535
                        Begin VB.TextBox txtOraCreazioneReportLavorazione 
                           Height          =   285
                           Left            =   1320
                           Locked          =   -1  'True
                           TabIndex        =   247
                           ToolTipText     =   "Ora creazione"
                           Top             =   960
                           Width           =   975
                        End
                        Begin VB.TextBox txtNomeReportLavorazione 
                           Height          =   285
                           Left            =   120
                           Locked          =   -1  'True
                           TabIndex        =   246
                           TabStop         =   0   'False
                           ToolTipText     =   "Nome report"
                           Top             =   240
                           Width           =   5295
                        End
                        Begin VB.TextBox txtDataCreazioneReportLavorazione 
                           Height          =   285
                           Left            =   120
                           Locked          =   -1  'True
                           TabIndex        =   245
                           TabStop         =   0   'False
                           ToolTipText     =   "Data creazione"
                           Top             =   960
                           Width           =   1215
                        End
                        Begin VB.TextBox txt_X_Lavorazione 
                           Alignment       =   2  'Center
                           Height          =   285
                           Left            =   2160
                           Locked          =   -1  'True
                           TabIndex        =   244
                           TabStop         =   0   'False
                           ToolTipText     =   "X"
                           Top             =   600
                           Width           =   735
                        End
                        Begin VB.TextBox txt_Y_Lavorazione 
                           Alignment       =   2  'Center
                           Height          =   285
                           Left            =   3000
                           Locked          =   -1  'True
                           TabIndex        =   243
                           TabStop         =   0   'False
                           ToolTipText     =   "Y"
                           Top             =   600
                           Width           =   735
                        End
                        Begin VB.TextBox txtOrientamentoLavorazione 
                           Alignment       =   2  'Center
                           Height          =   285
                           Left            =   120
                           Locked          =   -1  'True
                           TabIndex        =   242
                           TabStop         =   0   'False
                           ToolTipText     =   "Orientamento"
                           Top             =   600
                           Width           =   1935
                        End
                     End
                     Begin VB.CommandButton cmdPropEtiPedPro 
                        Height          =   315
                        Left            =   240
                        Picture         =   "frmMain.frx":52206
                        Style           =   1  'Graphical
                        TabIndex        =   240
                        ToolTipText     =   "Proprietà della stampa"
                        Top             =   1080
                        Width           =   375
                     End
                     Begin VB.Frame FraPropEtiPedPro 
                        Caption         =   "Proprietà report di pedana"
                        Height          =   1335
                        Left            =   12480
                        TabIndex        =   233
                        Top             =   120
                        Visible         =   0   'False
                        Width           =   3855
                        Begin VB.TextBox txtOraCreazioneReportPedana 
                           Height          =   285
                           Left            =   1320
                           Locked          =   -1  'True
                           TabIndex        =   239
                           ToolTipText     =   "Ora creazione"
                           Top             =   960
                           Width           =   975
                        End
                        Begin VB.TextBox txtNomeReportPedana 
                           Height          =   285
                           Left            =   120
                           Locked          =   -1  'True
                           TabIndex        =   238
                           TabStop         =   0   'False
                           ToolTipText     =   "Nome report"
                           Top             =   240
                           Width           =   3615
                        End
                        Begin VB.TextBox txtDataCreazioneReportPedana 
                           Height          =   285
                           Left            =   120
                           Locked          =   -1  'True
                           TabIndex        =   237
                           TabStop         =   0   'False
                           ToolTipText     =   "Data creazione"
                           Top             =   960
                           Width           =   1215
                        End
                        Begin VB.TextBox txt_X_Pedana 
                           Alignment       =   2  'Center
                           Height          =   285
                           Left            =   2160
                           Locked          =   -1  'True
                           TabIndex        =   236
                           TabStop         =   0   'False
                           ToolTipText     =   "X"
                           Top             =   600
                           Width           =   735
                        End
                        Begin VB.TextBox txt_Y_Pedana 
                           Alignment       =   2  'Center
                           Height          =   285
                           Left            =   3000
                           Locked          =   -1  'True
                           TabIndex        =   235
                           TabStop         =   0   'False
                           ToolTipText     =   "Y"
                           Top             =   600
                           Width           =   735
                        End
                        Begin VB.TextBox txtOrientamentoPedana 
                           Alignment       =   2  'Center
                           Height          =   285
                           Left            =   120
                           Locked          =   -1  'True
                           TabIndex        =   234
                           TabStop         =   0   'False
                           ToolTipText     =   "Orientamento"
                           Top             =   600
                           Width           =   1935
                        End
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtNumeroEtichetteNew 
                        Height          =   315
                        Left            =   10080
                        TabIndex        =   252
                        TabStop         =   0   'False
                        Top             =   480
                        Width           =   1095
                        _Version        =   65536
                        _ExtentX        =   1931
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Appearance      =   1
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTDataCmb.DMTCombo cboReportNew 
                        Height          =   315
                        Left            =   600
                        TabIndex        =   253
                        TabStop         =   0   'False
                        Top             =   480
                        Width           =   3135
                        _ExtentX        =   5530
                        _ExtentY        =   556
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DMTDataCmb.DMTCombo cboReportPedNew 
                        Height          =   315
                        Left            =   600
                        TabIndex        =   254
                        TabStop         =   0   'False
                        Top             =   1080
                        Width           =   3135
                        _ExtentX        =   5530
                        _ExtentY        =   556
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtNumeroEtichettePedNew 
                        Height          =   315
                        Left            =   10080
                        TabIndex        =   255
                        TabStop         =   0   'False
                        Top             =   1080
                        Width           =   1095
                        _Version        =   65536
                        _ExtentX        =   1931
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Appearance      =   1
                        AllowEmpty      =   0   'False
                     End
                     Begin VB.Label Label1 
                        Caption         =   "Report per etichette di lavorazione"
                        Height          =   255
                        Index           =   19
                        Left            =   600
                        TabIndex        =   261
                        Top             =   240
                        Width           =   3135
                     End
                     Begin VB.Label Label1 
                        Caption         =   "Stampante per etichette di lavorazione"
                        Height          =   255
                        Index           =   18
                        Left            =   3840
                        TabIndex        =   260
                        Top             =   240
                        Width           =   3975
                     End
                     Begin VB.Label Label1 
                        Caption         =   "N° etichette"
                        Height          =   255
                        Index           =   17
                        Left            =   10080
                        TabIndex        =   259
                        Top             =   240
                        Width           =   1095
                     End
                     Begin VB.Label Label1 
                        Caption         =   "Stampante per etichette di pedana"
                        Height          =   255
                        Index           =   14
                        Left            =   3840
                        TabIndex        =   258
                        Top             =   840
                        Width           =   4575
                     End
                     Begin VB.Label Label1 
                        Caption         =   "Report per etichette di pedana"
                        Height          =   255
                        Index           =   15
                        Left            =   600
                        TabIndex        =   257
                        Top             =   840
                        Width           =   3135
                     End
                     Begin VB.Label Label1 
                        Caption         =   "N° etichette"
                        Height          =   255
                        Index           =   16
                        Left            =   10080
                        TabIndex        =   256
                        Top             =   840
                        Width           =   1095
                     End
                     Begin VB.Line Line6 
                        BorderColor     =   &H00C00000&
                        BorderWidth     =   3
                        Index           =   0
                        X1              =   11280
                        X2              =   11280
                        Y1              =   240
                        Y2              =   1440
                     End
                  End
                  Begin VB.Frame FraEtichetteOLD 
                     Caption         =   "STAMPA ETICHETTE"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     ForeColor       =   &H00C00000&
                     Height          =   1575
                     Left            =   120
                     TabIndex        =   262
                     Top             =   6480
                     Width           =   18135
                     Begin VB.CommandButton cmdStampaEtichette 
                        Caption         =   "STAMPA"
                        BeginProperty Font 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   700
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                        Height          =   1215
                        Left            =   12360
                        TabIndex        =   265
                        TabStop         =   0   'False
                        Top             =   240
                        Width           =   975
                     End
                     Begin VB.ComboBox cboStampantePed 
                        Height          =   315
                        Left            =   4800
                        TabIndex        =   264
                        TabStop         =   0   'False
                        Top             =   1080
                        Width           =   6135
                     End
                     Begin VB.ComboBox cboStampa 
                        Height          =   315
                        Left            =   4800
                        TabIndex        =   263
                        TabStop         =   0   'False
                        Top             =   480
                        Width           =   6135
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtNumeroEtichette 
                        Height          =   315
                        Left            =   11040
                        TabIndex        =   266
                        TabStop         =   0   'False
                        Top             =   480
                        Width           =   1095
                        _Version        =   65536
                        _ExtentX        =   1931
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Appearance      =   1
                        AllowEmpty      =   0   'False
                     End
                     Begin DMTDataCmb.DMTCombo cboReport 
                        Height          =   315
                        Left            =   240
                        TabIndex        =   267
                        TabStop         =   0   'False
                        Top             =   480
                        Width           =   4455
                        _ExtentX        =   7858
                        _ExtentY        =   556
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DMTDataCmb.DMTCombo cboReportPed 
                        Height          =   315
                        Left            =   240
                        TabIndex        =   268
                        TabStop         =   0   'False
                        Top             =   1080
                        Width           =   4455
                        _ExtentX        =   7858
                        _ExtentY        =   556
                        BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                           Name            =   "Verdana"
                           Size            =   8.25
                           Charset         =   0
                           Weight          =   400
                           Underline       =   0   'False
                           Italic          =   0   'False
                           Strikethrough   =   0   'False
                        EndProperty
                     End
                     Begin DMTEDITNUMLib.dmtNumber txtNumeroEtichettePed 
                        Height          =   315
                        Left            =   11040
                        TabIndex        =   269
                        TabStop         =   0   'False
                        Top             =   1080
                        Width           =   1095
                        _Version        =   65536
                        _ExtentX        =   1931
                        _ExtentY        =   556
                        _StockProps     =   253
                        Text            =   "0"
                        BackColor       =   16777215
                        Appearance      =   1
                        AllowEmpty      =   0   'False
                     End
                     Begin VB.Label Label1 
                        Caption         =   "N° etichette"
                        Height          =   255
                        Index           =   11
                        Left            =   11040
                        TabIndex        =   275
                        Top             =   840
                        Width           =   1095
                     End
                     Begin VB.Label Label1 
                        Caption         =   "Report per etichette di pedana"
                        Height          =   255
                        Index           =   10
                        Left            =   240
                        TabIndex        =   274
                        Top             =   840
                        Width           =   4455
                     End
                     Begin VB.Label Label1 
                        Caption         =   "Stampante per etichette di pedana"
                        Height          =   255
                        Index           =   9
                        Left            =   4800
                        TabIndex        =   273
                        Top             =   840
                        Width           =   4575
                     End
                     Begin VB.Label Label1 
                        Caption         =   "N° etichette lavorazione"
                        Height          =   255
                        Index           =   8
                        Left            =   11040
                        TabIndex        =   272
                        Top             =   240
                        Width           =   1095
                     End
                     Begin VB.Label Label1 
                        Caption         =   "Stampante per etichette di lavorazione"
                        Height          =   255
                        Index           =   7
                        Left            =   4800
                        TabIndex        =   271
                        Top             =   240
                        Width           =   3975
                     End
                     Begin VB.Label Label1 
                        Caption         =   "Report per etichette di lavorazione"
                        Height          =   255
                        Index           =   6
                        Left            =   240
                        TabIndex        =   270
                        Top             =   240
                        Width           =   4335
                     End
                     Begin VB.Line Line6 
                        BorderWidth     =   3
                        Index           =   1
                        X1              =   12240
                        X2              =   12240
                        Y1              =   240
                        Y2              =   1440
                     End
                  End
                  Begin DmtCodDescCtl.DmtCodDesc CDImballoPrimario 
                     Height          =   615
                     Left            =   12075
                     TabIndex        =   38
                     TabStop         =   0   'False
                     Top             =   2010
                     Width           =   4650
                     _ExtentX        =   8202
                     _ExtentY        =   1085
                     PropCodice      =   $"frmMain.frx":52790
                     BeginProperty PropCodiceFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     PropDescrizione =   $"frmMain.frx":527DF
                     BeginProperty PropDescrizioneFontCaption {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     MenuFunctions   =   $"frmMain.frx":52847
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Enabled         =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtDispLottoImballoPrim 
                     Height          =   255
                     Left            =   3960
                     TabIndex        =   335
                     Top             =   4440
                     Width           =   975
                     _Version        =   65536
                     _ExtentX        =   1720
                     _ExtentY        =   450
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     Appearance      =   1
                     AllowEmpty      =   0   'False
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtGiacLottoImballoPrim 
                     Height          =   255
                     Left            =   3000
                     TabIndex        =   336
                     Top             =   4440
                     Width           =   855
                     _Version        =   65536
                     _ExtentX        =   1508
                     _ExtentY        =   450
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     Appearance      =   1
                     AllowEmpty      =   0   'False
                  End
                  Begin VB.CheckBox chkTracciaImballoGestPrim 
                     Caption         =   "Traccia"
                     Height          =   255
                     Left            =   1920
                     TabIndex        =   333
                     Top             =   4440
                     Width           =   975
                  End
                  Begin VB.CheckBox chkConfermaDaUtentePrim 
                     Caption         =   "Conferma da utente"
                     Height          =   255
                     Left            =   5160
                     TabIndex        =   334
                     Top             =   4440
                     Width           =   2535
                  End
                  Begin VB.CommandButton Command2 
                     Height          =   315
                     Left            =   5520
                     Picture         =   "frmMain.frx":528A1
                     Style           =   1  'Graphical
                     TabIndex        =   345
                     ToolTipText     =   "Seleziona KIT"
                     Top             =   1710
                     Width           =   375
                  End
                  Begin VB.CommandButton Command3 
                     Height          =   315
                     Left            =   13440
                     Picture         =   "frmMain.frx":52C6F
                     Style           =   1  'Graphical
                     TabIndex        =   346
                     ToolTipText     =   "Seleziona confezioni"
                     Top             =   1725
                     Width           =   375
                  End
                  Begin VB.CommandButton cmdLottoImballo 
                     Enabled         =   0   'False
                     Height          =   315
                     Left            =   13080
                     Picture         =   "frmMain.frx":5305C
                     Style           =   1  'Graphical
                     TabIndex        =   289
                     ToolTipText     =   "Seleziona lotti imballo"
                     Top             =   1725
                     Width           =   375
                  End
                  Begin VB.CommandButton cmdRefreshKit 
                     Height          =   315
                     Left            =   17420
                     Picture         =   "frmMain.frx":535E6
                     Style           =   1  'Graphical
                     TabIndex        =   339
                     TabStop         =   0   'False
                     ToolTipText     =   "Ricalcolo della lista degli articoli che compongono il kit"
                     Top             =   2260
                     Width           =   375
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtCostoConfezione 
                     Height          =   315
                     Left            =   17520
                     TabIndex        =   39
                     TabStop         =   0   'False
                     Top             =   2265
                     Visible         =   0   'False
                     Width           =   735
                     _Version        =   65536
                     _ExtentX        =   1296
                     _ExtentY        =   556
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecimalPlaces   =   5
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin VB.CommandButton cmdScaricaImbPrim 
                     Height          =   315
                     Left            =   17060
                     Picture         =   "frmMain.frx":53B70
                     Style           =   1  'Graphical
                     TabIndex        =   327
                     TabStop         =   0   'False
                     ToolTipText     =   "Altri articoli che compongono il kit"
                     Top             =   2260
                     Width           =   375
                  End
                  Begin VB.CommandButton Command1 
                     Height          =   315
                     Left            =   16680
                     Picture         =   "frmMain.frx":540FA
                     Style           =   1  'Graphical
                     TabIndex        =   344
                     ToolTipText     =   "Seleziona confezione"
                     Top             =   2260
                     Visible         =   0   'False
                     Width           =   375
                  End
                  Begin DMTEDITNUMLib.dmtNumber txtPesoNetto 
                     Height          =   405
                     Left            =   5040
                     TabIndex        =   43
                     Top             =   2880
                     Width           =   1695
                     _Version        =   65536
                     _ExtentX        =   2990
                     _ExtentY        =   714
                     _StockProps     =   253
                     Text            =   "0"
                     BackColor       =   16777215
                     BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
                        Name            =   "Verdana"
                        Size            =   12
                        Charset         =   0
                        Weight          =   400
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Appearance      =   1
                     UseSeparator    =   -1  'True
                     DecFinalZeros   =   -1  'True
                     AllowEmpty      =   0   'False
                  End
                  Begin VB.CommandButton cmdSalva 
                     BackColor       =   &H00FFFFFF&
                     Caption         =   "Salva"
                     Height          =   375
                     Left            =   16800
                     TabIndex        =   59
                     Top             =   4800
                     Width           =   1455
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Tara conf."
                     Height          =   255
                     Index           =   33
                     Left            =   17280
                     TabIndex        =   322
                     ToolTipText     =   "Tara unitaria per ogni confezione"
                     Top             =   1515
                     Width           =   975
                  End
                  Begin VB.Label Label2 
                     Caption         =   "N° conf."
                     Height          =   255
                     Index           =   32
                     Left            =   16320
                     TabIndex        =   321
                     ToolTipText     =   "Numero di confezioni in un imballo"
                     Top             =   1515
                     Width           =   855
                  End
                  Begin VB.Label Label2 
                     Caption         =   "% Reso"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   31
                     Left            =   -60000
                     TabIndex        =   319
                     Top             =   1680
                     Width           =   1455
                  End
                  Begin VB.Label Label2 
                     Caption         =   "N°"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   30
                     Left            =   -74880
                     TabIndex        =   305
                     Top             =   1680
                     Width           =   495
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Q.tà lav. prelievo"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   29
                     Left            =   -72600
                     TabIndex        =   303
                     Top             =   1680
                     Width           =   1815
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Prelievo merce"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   28
                     Left            =   -74280
                     TabIndex        =   302
                     Top             =   1680
                     Width           =   1575
                  End
                  Begin VB.Label lblProtocollo 
                     Caption         =   "Passaporto"
                     Height          =   255
                     Left            =   10800
                     TabIndex        =   230
                     Top             =   2055
                     Visible         =   0   'False
                     Width           =   975
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Tipo lavorazione"
                     Height          =   255
                     Index           =   7
                     Left            =   -66600
                     TabIndex        =   218
                     Top             =   480
                     Width           =   3255
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Ora"
                     Height          =   270
                     Index           =   25
                     Left            =   -61680
                     TabIndex        =   206
                     Top             =   480
                     Width           =   975
                  End
                  Begin VB.Label lblArticolo_Q 
                     Caption         =   "Articolo"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     ForeColor       =   &H00800000&
                     Height          =   255
                     Left            =   -73080
                     TabIndex        =   205
                     Top             =   525
                     Width           =   3615
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Colli"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   23
                     Left            =   -70680
                     TabIndex        =   204
                     Top             =   1680
                     Width           =   855
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Peso lordo"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   22
                     Left            =   -69360
                     TabIndex        =   203
                     Top             =   1680
                     Width           =   1095
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Pezzi"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   21
                     Left            =   -64080
                     TabIndex        =   202
                     Top             =   1680
                     Width           =   855
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Tara "
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   20
                     Left            =   -67440
                     TabIndex        =   201
                     Top             =   1680
                     Width           =   1095
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Peso netto"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   19
                     Left            =   -65880
                     TabIndex        =   200
                     Top             =   1680
                     Width           =   1095
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Q.tà movim."
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   15
                     Left            =   -62040
                     TabIndex        =   199
                     Top             =   1680
                     Width           =   1695
                  End
                  Begin VB.Label lblImballo_Q 
                     Caption         =   "Imballo"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     ForeColor       =   &H00800000&
                     Height          =   255
                     Left            =   -73200
                     TabIndex        =   198
                     Top             =   1125
                     Width           =   3735
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Unità di misura"
                     Height          =   255
                     Index           =   14
                     Left            =   -69360
                     TabIndex        =   197
                     Top             =   495
                     Width           =   2295
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Tara unitaria"
                     Height          =   255
                     Index           =   13
                     Left            =   -69360
                     TabIndex        =   196
                     Top             =   1095
                     Width           =   1095
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Data quadratura"
                     Height          =   255
                     Index           =   12
                     Left            =   -63240
                     TabIndex        =   195
                     Top             =   480
                     Width           =   1455
                  End
                  Begin VB.Label Label8 
                     Caption         =   "Tipo categoria"
                     Height          =   255
                     Index           =   1
                     Left            =   3120
                     TabIndex        =   180
                     Top             =   2055
                     Width           =   1335
                  End
                  Begin VB.Label Label8 
                     Caption         =   "Calibro"
                     Height          =   255
                     Index           =   0
                     Left            =   4680
                     TabIndex        =   179
                     Top             =   2055
                     Width           =   1455
                  End
                  Begin VB.Label Label7 
                     Caption         =   "Lotto articolo di vendita"
                     Height          =   255
                     Index           =   0
                     Left            =   6120
                     TabIndex        =   178
                     Top             =   2055
                     Width           =   3975
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Tipo lavorazione"
                     Height          =   255
                     Index           =   6
                     Left            =   120
                     TabIndex        =   177
                     Top             =   2055
                     Width           =   2055
                  End
                  Begin VB.Label lblArticolo 
                     Caption         =   "Articolo"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     ForeColor       =   &H00800000&
                     Height          =   255
                     Left            =   1920
                     TabIndex        =   176
                     Top             =   1500
                     Width           =   3615
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Colli"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   9.75
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   0
                     Left            =   120
                     TabIndex        =   175
                     Top             =   2595
                     Width           =   1095
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Peso lordo"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   9.75
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   1
                     Left            =   1680
                     TabIndex        =   174
                     Top             =   2595
                     Width           =   1695
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Pezzi"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   9.75
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   2
                     Left            =   6840
                     TabIndex        =   173
                     Top             =   2595
                     Width           =   1095
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Tara "
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   9.75
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   3
                     Left            =   3480
                     TabIndex        =   172
                     Top             =   2595
                     Width           =   1455
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Peso netto"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   9.75
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   4
                     Left            =   5040
                     TabIndex        =   171
                     Top             =   2595
                     Width           =   1695
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Q.tà movim."
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   9.75
                        Charset         =   0
                        Weight          =   700
                        Underline       =   0   'False
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     Height          =   255
                     Index           =   5
                     Left            =   8640
                     TabIndex        =   170
                     Top             =   2595
                     Width           =   1695
                  End
                  Begin VB.Label lblImballo 
                     Caption         =   "Imballo"
                     BeginProperty Font 
                        Name            =   "Verdana"
                        Size            =   8.25
                        Charset         =   0
                        Weight          =   400
                        Underline       =   -1  'True
                        Italic          =   0   'False
                        Strikethrough   =   0   'False
                     EndProperty
                     ForeColor       =   &H00800000&
                     Height          =   255
                     Left            =   9240
                     TabIndex        =   169
                     Top             =   1500
                     Width           =   2535
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Unità di misura"
                     Height          =   255
                     Index           =   9
                     Left            =   6000
                     TabIndex        =   168
                     Top             =   1515
                     Width           =   1455
                  End
                  Begin VB.Label Label2 
                     Caption         =   "Tara uni."
                     Height          =   255
                     Index           =   10
                     Left            =   15240
                     TabIndex        =   167
                     ToolTipText     =   "Tara unitaria dell'imballo"
                     Top             =   1515
                     Width           =   855
                  End
                  Begin VB.Label Label2 
                     Caption         =   "U.M. imballo"
                     Height          =   255
                     Index           =   11
                     Left            =   13920
                     TabIndex        =   166
                     ToolTipText     =   "Unità di misura dell'imballo"
                     Top             =   1515
                     Width           =   1215
                  End
               End
            End
            Begin VB.Frame FraQuadratura 
               Caption         =   "Quadratura delle lavorazione del lotto di conferimento"
               BeginProperty Font 
                  Name            =   "MS Sans Serif"
                  Size            =   8.25
                  Charset         =   0
                  Weight          =   700
                  Underline       =   0   'False
                  Italic          =   0   'False
                  Strikethrough   =   0   'False
               EndProperty
               Height          =   2295
               Left            =   120
               TabIndex        =   106
               Top             =   120
               Width           =   5535
            End
         End
         Begin DmtGridCtl.DmtGrid BrwMain 
            Height          =   735
            Left            =   0
            TabIndex        =   343
            Top             =   0
            Width           =   1335
            _ExtentX        =   2355
            _ExtentY        =   1296
            BackColor       =   16777215
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Verdana"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ColumnsHeaderHeight=   20
         End
      End
      Begin DmtPrnDlgCtl.DMTDialog DmtPrnDlg 
         Left            =   480
         Top             =   1290
         _ExtentX        =   661
         _ExtentY        =   661
      End
      Begin VB.PictureBox picSplitter 
         BackColor       =   &H8000000A&
         BorderStyle     =   0  'None
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   4935
         Left            =   960
         ScaleHeight     =   4935
         ScaleWidth      =   60
         TabIndex        =   87
         Top             =   0
         Visible         =   0   'False
         Width           =   60
      End
      Begin DmtActBox.DmtActBoxCtl ActivityBox 
         Height          =   9075
         Left            =   0
         TabIndex        =   107
         Top             =   0
         Width           =   1215
         _ExtentX        =   2143
         _ExtentY        =   16007
         BackColor       =   -2147483643
         ForeColor       =   -2147483630
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin VB.Image imgSplitter 
         Height          =   4695
         Left            =   1200
         MousePointer    =   9  'Size W E
         Top             =   0
         Width           =   60
      End
      Begin DMTWheelCtrl.SpareWheel SpareWheel 
         Left            =   945
         Top             =   660
         _Version        =   65536
         _ExtentX        =   741
         _ExtentY        =   741
         _StockProps     =   0
      End
   End
   Begin MSComctlLib.StatusBar stbStatusbar 
      Align           =   2  'Align Bottom
      Height          =   345
      Left            =   0
      TabIndex        =   84
      Top             =   11325
      Width           =   19185
      _ExtentX        =   33840
      _ExtentY        =   609
      Style           =   1
      _Version        =   393216
      BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
         NumPanels       =   1
         BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
         EndProperty
      EndProperty
   End
End
Attribute VB_Name = "frmMain"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

    
'L'applicazione corrente
Private WithEvents m_App As DMTRunAppLib.Application
Attribute m_App.VB_VarHelpID = -1
'Il processo corrente
Private m_Process As DMTRunAppLib.Process
'Il tipo di documento corrente
Private m_DocType As DmtDocManLib.DBFormDocType
'Il documento corrente
Private WithEvents m_Document As DmtDocManLib.DBFormDocument
Attribute m_Document.VB_VarHelpID = -1
'La vista tabellare attiva
Private m_ActiveTableView As DmtDocManLib.TableView
'Il filtro attivo
Private m_ActiveFilter As DmtDocManLib.Filter
'Il report da stampare
Private m_Report As DmtDocManLib.Report
'La collezione dei campi del documento
'collegati ai controlli del form
Private m_FormFields As FormFields
'Il campo con la proprietà TabIndex uguale a 0
Private m_ControlTabIndex0 As Control
'La variabile  m_Semaphore mantiene un riferimento all'oggetto
'Semaphore che gestisce i conflitti di multiutenza
Private m_Semaphore As Semaforo.dmtSemaphore
'Indica se all'evento KeyPress del Form il tasto deve essere annullato
Private m_EatKey As Boolean
'Indica se l'utente ha modificato uno dei campi del documento
Private m_Changed As Boolean
'Indica se i valori dei campi del documento sono stati salvati
Private m_Saved As Boolean
'Indica se è in corso la definizione di una ricerca
Private m_Search As Boolean
'Indica se uno dei filtri è stato selezionato
Private m_FilterSelected As Boolean
'Indica lo stato di visibilità della vista tabellare
'prima dell'inizio della fase di esecuzione della
'anteprima di stampa
Private m_TabMode As Boolean
'Indica se si sta muovendo lo splitter
Private m_SplitterMoving As Boolean
'Nome dell'eventuale database esteso
Private m_ExtendedDatabase As String
'Processo "Shell su evento OnSave" nome del campo collegato
Private m_LinkedField As String
'Handle della finestra della anteprima di stampa
Private m_PreviewWindowHandle As Long
'Flag che permette l'esecuzione di Form_Activate soltanto all'avvio del programma
Private m_bOnFirstTime As Boolean
'Impedisce il Reposition della browse.
Private m_bAvoidReposition As Boolean
'Consente l'esecuzione del codice contenuto in BrwMain_OnChangeGuiMode()
Private bEnableGuiEvent As Boolean
'Indica se è stato attivato un link
Private m_LinkActive As Boolean

'cbcx
'Oggetto adibito alla gestione del processo On_Extend
'Private m_ExtendApplication As DmtExtendAppLib.ExtendApplication


'rif1
'L'oggetto per la gestione dei sottodocumenti
'LAVORAZIONE
Private WithEvents m_DocumentsLink As DmtDocManLib.DocumentsLink
Attribute m_DocumentsLink.VB_VarHelpID = -1
'QUADRATURA DI LAVORAZIONE DEL LOTTO DI CONFERIMENTO
Private WithEvents m_DocumentsLink1 As DmtDocManLib.DocumentsLink
Attribute m_DocumentsLink1.VB_VarHelpID = -1

Private SegnoPerQuadratura As String
Private SegnoPerQuadraturaPrec As String



'Costanti che rappresentano le modalità di visualizzazione
Private Enum neVisualModality
    Insert          'Modalità INSERIMENTO
    Modify          'Modalità VARIAZIONE
    Find            'Modalità TROVA
    Browse          'Modalità ELENCO
    Preview         'Modalità ANTEPRIMA
End Enum

'Costanti usate da SetStatus4Modality per l'apertura/chiusura dell'anteprima di stampa
Private Enum nePreviewModality
    OpenPrw
    ClosePrw
End Enum

Private m_iNumeroCopieDefault As Integer
Private m_OrientamentoDefault As OrientationConsts


'----- Oggetti e variabili per la gestione del riquadro attività -----------
'***Reports                                                                -
Private WithEvents oReportsActivity As DmtActBoxLib.ReportsActivity       '-
Attribute oReportsActivity.VB_VarHelpID = -1
'***Filtri                                                                 -
Private WithEvents oFiltersActivity As DmtActBoxLib.FiltersActivity       '-
Attribute oFiltersActivity.VB_VarHelpID = -1
'***Viste tabellari                                                        -
Private WithEvents oTableViewsActivity As DmtActBoxLib.TableViewsActivity '-
Attribute oTableViewsActivity.VB_VarHelpID = -1
'***Esportazioni                                                           -
Private oExportActivity As DmtActBoxLib.ExportActivity                    '-
'***Supporto tecnico                                                       -
Private oSupportActivity As DmtActBoxLib.SupportActivity                  '-
'***Nome dell'attività predefinita del riquadro attività                   -
Private m_DefaultActivity As String                                       '-
'---------------------------------------------------------------------------

Public bNotReturnValue As Boolean

'///////////////////////////////////////////////////////////////////////////////////
' ATTENZIONE:
' Occorre impostare questa costante!
' (ed eventualmente personalizzare il codice della funzione Caption2Display
'///////////////////////////////////////////////////////////////////////////////////
' Costante che identifica il campo più significativo del documento, il cui valore
' verrà visualizzato nella Caption del Form ed in quei messaggi in cui è mostrato
' il contenuto del campo principale del documento attivo.
' La costante può essere una stringa tipo "NomeCampo" o un intero che funge da indice
' nella collection m_Document.Fields().
'(Se l'applicazione può essere chiamata da un link occorre impostare anche la variabile
'sMessage1 presente nel metodo FormUnload.)
Private Const CAMPO_PER_CAPTION = "Anagrafica"


'Versione del controllo ActiveBar
Private Const BARMENUVERSION = "3.0"
'Variabile per la gestione degli shortcut del Menu
Private aryShortCut(1) As New ActiveBar3LibraryCtl.ShortCut

'****************************VARIABILI CONTRATTO**********************************
'VARIBILE ARRAY IN CUI VENGONO INSERITE L'ID DELLE RIGHE DA ELIMINARE DEFINITIVAMENTE
Private ArrayDelete(150) As Long
Private ArrayDelete_OLD(150) As Long

Private ArrayDeleteQuadratura(10)
Private ArrayDeleteLottoLavorazione(150)

'VARIABILE CONTATATORE CHE SERVE PER IL CONTEGGIO DELLE LINEE DA ELIMINARE
Private ContDelete As Long

Private ContDeleteQuadratura As Long
Private ContDeleteLotto As Long

'VARIABILE CHE SERVE PER VEDERE SE IL DOCUMENTO E' IN AGGIORNAMENTO IN MODO CHE ALL'EVENTO
'ON REPOSITION DEL DOTTODOCUMENTO NON VENGANO EFFETTUATI DI NUOVO TUTTI GLI AGGIORNAMENTI
Private AggiornamentoDocumento As Integer
Private AggiornamentoDocumento_Q As Integer
'VARIABILE CHE IMPOSTA UNA NUOVA RIGA
'0 = Nuova riga
'1 = Riga in modifica
Private Nuova_Riga As Integer
Private NUOVA_RIGA_ASSEGNAZIONE As Integer
Private NumeroRecordGriglia As Long


'VARIABILE RECORDSET PER LA GRIGLIA DELL'ASSEGNAZIONE
Private RsAss As DmtOleDbLib.adoResultset

Private bVariazioneDettaglio As Boolean
'******************************************************************************
Private ColliStampati As Long
Private ColliDaStampare As Long

'VARIABILI PER STAMPA VELOCE
Private Link_TipoOggettoLocal As Long
Private STAMPANTE_LAVORAZIONE As String
Private STAMPANTE_PEDANA As String
Private LINK_REPORT_LAV_DEFAULT As Long
Private LINK_REPORT_PED_DEFAULT As Long
Private oReport As dmtReportLib.dmtReport

Private Mov As DmtMovim.cMovimentazione
Private MAX_CARATTERI_PEDANA_CLIENTE  As Long


'L'oggetto PaintNotify usato per la gestione dei campi calcolati
Public gPaintNotify As PaintNotify

'RECORDSET CHE SERVE PER SALVARE LE RIGHE DEL DOCUMENTO
Private rsNew As ADODB.Recordset
Private rsTmpPed As ADODB.Recordset
Private bLoadingDaProcesso As Boolean



Public Property Set Application(ByVal NewValue As DMTRunAppLib.Application)
    Set m_App = NewValue
End Property

Public Property Get Application() As DMTRunAppLib.Application
    Set Application = m_App
End Property



'**+
'Nome: ChangeStringsLanguage
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Legge le stringe dal file di risorse per gestire l'opzione multilingue.
'Qui vanno inserite tutte le stringhe aggiunte in frmMain solo se si vuole
'gestire l'opzione multilingua
'**/
Public Sub ChangeStringsLanguage()
    '//////////////////////////////////////////////////////////////////////////////
    'ATTENZIONE
    'Inserire qui il codice per la lettura dal file di risorse di tutte le stringhe
    'per le quali si vuole gestire l'opzione multilingue.
    '//////////////////////////////////////////////////////////////////////////////
End Sub

'**+
'Nome: ChangeToolBarLanguage
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Legge dal file di risorse le stringe delle ToolTipText e dei suggerimenti da visualizzare
'sulla Statusbar per gestire l'opzione multilingue
'**/
Public Sub ChangeToolBarLanguage()

    'New
    BarMenu.Bands("Standard").Tools("New").ToolTipText = GetToolTipText4ToolBar("New")
    BarMenu.Bands("Standard").Tools("New").Description = GetDescription4StatusBar("New")
    
    'Save
    BarMenu.Bands("Standard").Tools("Save").ToolTipText = GetToolTipText4ToolBar("Save")
    BarMenu.Bands("Standard").Tools("Save").Description = GetDescription4StatusBar("Save")

    'Print
    BarMenu.Bands("Standard").Tools("Print").ToolTipText = GetToolTipText4ToolBar("Print")
    BarMenu.Bands("Standard").Tools("Print").Description = GetDescription4StatusBar("Print")

    'PrePrint
    BarMenu.Bands("Standard").Tools("PrePrint").ToolTipText = GetToolTipText4ToolBar("PrePrint")
    BarMenu.Bands("Standard").Tools("PrePrint").Description = GetDescription4StatusBar("PrePrint")

    'Cut
    BarMenu.Bands("Standard").Tools("Cut").ToolTipText = GetToolTipText4ToolBar("Cut")
    BarMenu.Bands("Standard").Tools("Cut").Description = GetDescription4StatusBar("Cut")

    'Copy
    BarMenu.Bands("Standard").Tools("Copy").ToolTipText = GetToolTipText4ToolBar("Copy")
    BarMenu.Bands("Standard").Tools("Copy").Description = GetDescription4StatusBar("Copy")

    'Paste
    BarMenu.Bands("Standard").Tools("Paste").ToolTipText = GetToolTipText4ToolBar("Paste")
    BarMenu.Bands("Standard").Tools("Paste").Description = GetDescription4StatusBar("Paste")

    'Delete
    BarMenu.Bands("Standard").Tools("Delete").ToolTipText = GetToolTipText4ToolBar("Delete")
    BarMenu.Bands("Standard").Tools("Delete").Description = GetDescription4StatusBar("Delete")

    'Clear
    BarMenu.Bands("Standard").Tools("Clear").ToolTipText = GetToolTipText4ToolBar("Clear")
    BarMenu.Bands("Standard").Tools("Clear").Description = GetDescription4StatusBar("Clear")

    'NewSearch
    BarMenu.Bands("Standard").Tools("NewSearch").ToolTipText = GetToolTipText4ToolBar("NewSearch")
    BarMenu.Bands("Standard").Tools("NewSearch").Description = GetDescription4StatusBar("NewSearch")

    'ExecuteSearch
    BarMenu.Bands("Standard").Tools("ExecuteSearch").ToolTipText = GetToolTipText4ToolBar("ExecuteSearch")
    BarMenu.Bands("Standard").Tools("ExecuteSearch").Description = GetDescription4StatusBar("ExecuteSearch")

    'ChangeView
    BarMenu.Bands("Standard").Tools("ChangeView").ToolTipText = GetToolTipText4ToolBar("ChangeView")
    BarMenu.Bands("Standard").Tools("ChangeView").Description = GetDescription4StatusBar("ChangeView")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_FormView").Description = GetDescription4StatusBar("Mnu_FormView")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_FormView").ToolTipText = GetToolTipText4ToolBar("ChangeView")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_TableView").Description = GetDescription4StatusBar("Mnu_TableView")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_TableView").ToolTipText = GetToolTipText4ToolBar("ChangeView")

    'SearchPrevious
    BarMenu.Bands("Standard").Tools("SearchPrevious").ToolTipText = GetToolTipText4ToolBar("SearchPrevious")
    BarMenu.Bands("Standard").Tools("SearchPrevious").Description = GetDescription4StatusBar("SearchPrevious")

    'SearchNext
    BarMenu.Bands("Standard").Tools("SearchNext").ToolTipText = GetToolTipText4ToolBar("SearchNext")
    BarMenu.Bands("Standard").Tools("SearchNext").Description = GetDescription4StatusBar("SearchNext")

    'ExportWord
    BarMenu.Bands("Band_Export").Tools("ExportWord").ToolTipText = GetToolTipText4ToolBar("ExportWord")
    BarMenu.Bands("Band_Export").Tools("ExportWord").Description = GetDescription4StatusBar("ExportWord")

    'ExportExcel
    BarMenu.Bands("Band_Export").Tools("ExportExcel").ToolTipText = GetToolTipText4ToolBar("ExportExcel")
    BarMenu.Bands("Band_Export").Tools("ExportExcel").Description = GetDescription4StatusBar("ExportExcel")

    'ExportHtml
    BarMenu.Bands("Band_Export").Tools("ExportHtml").ToolTipText = GetToolTipText4ToolBar("ExportHtml")
    BarMenu.Bands("Band_Export").Tools("ExportHtml").Description = GetDescription4StatusBar("ExportHtml")

    'ExportPDF
    BarMenu.Bands("Band_Export").Tools("ExportPDF").ToolTipText = GetToolTipText4ToolBar("ExportPDF")
    BarMenu.Bands("Band_Export").Tools("ExportPDF").Description = GetDescription4StatusBar("ExportPDF")

    BarMenu.RecalcLayout
End Sub


'**+
'Nome: ChangeMenuLanguage
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Legge dal file di risorse le stringe delle Caption e dei suggerimenti da visualizzare
'sulla Statusbar per gestire l'opzione multilingue
'**/
Public Sub ChangeMenuLanguage()

    '--- Menu PopUp del pulsante "ChangeView" della Toolbar ---
    'ChangeView - Form
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_FormView").Caption = GetCaption4MenuBar("Mnu_FormView")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_FormView").Description = GetDescription4StatusBar("Mnu_FormView")
    
    'ChangeView - Tabella
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_TableView").Caption = GetCaption4MenuBar("Mnu_TableView")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_TableView").Description = GetDescription4StatusBar("Mnu_TableView")
    
    'ChangeView - Filtro
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_SearchFilter").Caption = GetCaption4MenuBar("Mnu_SearchFilter")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_SearchFilter").Description = GetDescription4StatusBar("Mnu_SearchFilter")
    '---                           ---                      ---
    

    'File
    BarMenu.Bands("Band_Menu").Tools("File").Caption = GetCaption4MenuBar("File")
    BarMenu.Bands("Band_Menu").Tools("File").Description = GetDescription4StatusBar("File")

    'File-New
    BarMenu.Bands("Band_File").Tools("Mnu_New").Caption = GetCaption4MenuBar("Mnu_New")
    BarMenu.Bands("Band_File").Tools("Mnu_New").Description = GetDescription4StatusBar("Mnu_New")
    
    'File-Save
    BarMenu.Bands("Band_File").Tools("Mnu_Save").Caption = GetCaption4MenuBar("Mnu_Save")
    BarMenu.Bands("Band_File").Tools("Mnu_Save").Description = GetDescription4StatusBar("Mnu_Save")
    
    'File-PrePrint
    BarMenu.Bands("Band_File").Tools("Mnu_PrePrint").Caption = GetCaption4MenuBar("Mnu_PrePrint")
    BarMenu.Bands("Band_File").Tools("Mnu_PrePrint").Description = GetDescription4StatusBar("Mnu_PrePrint")
    
    'File-Print
    BarMenu.Bands("Band_File").Tools("Mnu_Print").Caption = GetCaption4MenuBar("Mnu_Print")
    BarMenu.Bands("Band_File").Tools("Mnu_Print").Description = GetDescription4StatusBar("Mnu_Print")
    
    'File-Exit
    BarMenu.Bands("Band_File").Tools("Mnu_Exit").Caption = GetCaption4MenuBar("Mnu_Exit")
    BarMenu.Bands("Band_File").Tools("Mnu_Exit").Description = GetDescription4StatusBar("Mnu_Exit")
    
    'Edit
    BarMenu.Bands("Band_Menu").Tools("Edit").Caption = GetCaption4MenuBar("Edit")
    BarMenu.Bands("Band_Menu").Tools("Edit").Description = GetDescription4StatusBar("Edit")
    
    'Edit-Delete
    BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").Caption = GetCaption4MenuBar("Mnu_Delete")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").Description = GetDescription4StatusBar("Mnu_Delete")
    
    'Edit-Clear
    BarMenu.Bands("Band_Edit").Tools("Mnu_Clear").Caption = GetCaption4MenuBar("Mnu_Clear")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Clear").Description = GetDescription4StatusBar("Mnu_Clear")
    
    'Edit-Cut
    BarMenu.Bands("Band_Edit").Tools("Mnu_Cut").Caption = GetCaption4MenuBar("Mnu_Cut")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Cut").Description = GetDescription4StatusBar("Mnu_Cut")
    
    'Edit-Copy
    BarMenu.Bands("Band_Edit").Tools("Mnu_Copy").Caption = GetCaption4MenuBar("Mnu_Copy")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Copy").Description = GetDescription4StatusBar("Mnu_Copy")
    
    'Edit-Paste
    BarMenu.Bands("Band_Edit").Tools("Mnu_Paste").Caption = GetCaption4MenuBar("Mnu_Paste")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Paste").Description = GetDescription4StatusBar("Mnu_Paste")
    
    'Edit-NewSearch
    BarMenu.Bands("Band_Edit").Tools("Mnu_NewSearch").Caption = GetCaption4MenuBar("Mnu_NewSearch")
    BarMenu.Bands("Band_Edit").Tools("Mnu_NewSearch").Description = GetDescription4StatusBar("Mnu_NewSearch")
    
    'Edit-ExecuteSearch
    BarMenu.Bands("Band_Edit").Tools("Mnu_ExecuteSearch").Caption = GetCaption4MenuBar("Mnu_ExecuteSearch")
    BarMenu.Bands("Band_Edit").Tools("Mnu_ExecuteSearch").Description = GetDescription4StatusBar("Mnu_ExecuteSearch")
    
    'Edit-SearchPrevious
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchPrevious").Caption = GetCaption4MenuBar("Mnu_SearchPrevious")
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchPrevious").Description = GetDescription4StatusBar("Mnu_SearchPrevious")
    
    'Edit-SearchNext
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchNext").Caption = GetCaption4MenuBar("Mnu_SearchNext")
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchNext").Description = GetDescription4StatusBar("Mnu_SearchNext")
    
    'View
    BarMenu.Bands("Band_Menu").Tools("View").Caption = GetCaption4MenuBar("View")
    BarMenu.Bands("Band_Menu").Tools("View").Description = GetDescription4StatusBar("View")
    
    'View-FormView
    BarMenu.Bands("Band_View").Tools("Mnu_FormView").Caption = GetCaption4MenuBar("Mnu_FormView")
    BarMenu.Bands("Band_View").Tools("Mnu_FormView").Description = GetDescription4StatusBar("Mnu_FormView")
    
    'View-TableView
    BarMenu.Bands("Band_View").Tools("Mnu_TableView").Caption = GetCaption4MenuBar("Mnu_TableView")
    BarMenu.Bands("Band_View").Tools("Mnu_TableView").Description = GetDescription4StatusBar("Mnu_TableView")
    
    'View-SearchFilter
    BarMenu.Bands("Band_View").Tools("Mnu_SearchFilter").Caption = GetCaption4MenuBar("Mnu_SearchFilter")
    BarMenu.Bands("Band_View").Tools("Mnu_SearchFilter").Description = GetDescription4StatusBar("Mnu_SearchFilter")
    
    'View-Folders
    BarMenu.Bands("Band_View").Tools("Mnu_Folders").Caption = GetCaption4MenuBar("Mnu_Folders")
    BarMenu.Bands("Band_View").Tools("Mnu_Folders").Description = GetDescription4StatusBar("Mnu_Folders")
    
    'View-ToolBar
    BarMenu.Bands("Band_View").Tools("Mnu_ToolBar").Caption = GetCaption4MenuBar("Mnu_ToolBar")
    BarMenu.Bands("Band_View").Tools("Mnu_ToolBar").Description = GetDescription4StatusBar("Mnu_ToolBar")
    
    'Tools
    BarMenu.Bands("Band_Menu").Tools("Tools").Caption = GetCaption4MenuBar("Tools")
    BarMenu.Bands("Band_Menu").Tools("Tools").Description = GetDescription4StatusBar("Tools")
    
    'Tools-Export
    BarMenu.Bands("Band_Tools").Tools("Mnu_Export").Caption = GetCaption4MenuBar("Mnu_Export")
    BarMenu.Bands("Band_Tools").Tools("Mnu_Export").Description = GetDescription4StatusBar("Mnu_Export")
    
    'Tools-Options
    BarMenu.Bands("Band_Tools").Tools("Mnu_Options").Caption = GetCaption4MenuBar("Mnu_Options")
    BarMenu.Bands("Band_Tools").Tools("Mnu_Options").Description = GetDescription4StatusBar("Mnu_Options")
    
    'Tools-Export-ExportWord
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportWord").Caption = GetCaption4MenuBar("Mnu_ExportWord")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportWord").Description = GetDescription4StatusBar("Mnu_ExportWord")
    
    'Tools-Export-ExportExcel
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportExcel").Caption = GetCaption4MenuBar("Mnu_ExportExcel")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportExcel").Description = GetDescription4StatusBar("Mnu_ExportExcel")
    
    'Tools-Export-ExportHtml
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportHtml").Caption = GetCaption4MenuBar("Mnu_ExportHtml")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportHtml").Description = GetDescription4StatusBar("Mnu_ExportHtml")

    'Tools-Export-ExportPDF
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportPDF").Caption = GetCaption4MenuBar("Mnu_ExportPDF")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportPDF").Description = GetDescription4StatusBar("Mnu_ExportPDF")

    'Help-HelpOnLine
    BarMenu.Bands("Band_Help").Tools("Mnu_HelpOnLine").Caption = GetCaption4MenuBar("Mnu_HelpOnLine")
    BarMenu.Bands("Band_Help").Tools("Mnu_HelpOnLine").Description = GetDescription4StatusBar("Mnu_HelpOnLine")
    
    'Help-Arg
    BarMenu.Bands("Band_Help").Tools("Mnu_Arg").Caption = GetCaption4MenuBar("Mnu_Arg")
    BarMenu.Bands("Band_Help").Tools("Mnu_Arg").Description = GetDescription4StatusBar("Mnu_Arg")
    
    'Help-Web
    BarMenu.Bands("Band_Help").Tools("Mnu_Web").Caption = GetCaption4MenuBar("Mnu_Web")
    BarMenu.Bands("Band_Help").Tools("Mnu_Web").Description = GetDescription4StatusBar("Mnu_Web")
    
    
    'Help-Info
    BarMenu.Bands("Band_Help").Tools("Mnu_Info").Caption = GetCaption4MenuBar("Mnu_Info")
    BarMenu.Bands("Band_Help").Tools("Mnu_Info").Description = GetDescription4StatusBar("Mnu_Info")
    
    'Help-Agg_Web
    BarMenu.Bands("Band_Help").Tools("Mnu_Agg_Web").Caption = GetCaption4MenuBar("Mnu_Web")
    BarMenu.Bands("Band_Help").Tools("Mnu_Agg_Web").Description = GetDescription4StatusBar("Mnu_Agg_Web")
    
    'Help-Info
    BarMenu.Bands("Band_Help").Tools("Mnu_Info").Caption = GetCaption4MenuBar("Mnu_Info")
    BarMenu.Bands("Band_Help").Tools("Mnu_Info").Description = GetDescription4StatusBar("Mnu_Info")
    
    'PopUp-RunApplication
    BarMenu.Bands("Band_PopUp").Tools("Mnu_RunApplication").Caption = GetCaption4MenuBar("Mnu_RunApplication")
    
    'PopUp-SearchObject
    BarMenu.Bands("Band_PopUp").Tools("Mnu_SearchObject").Caption = GetCaption4MenuBar("Mnu_SearchObject")
    
    BarMenu.RecalcLayout
End Sub

'**+
'Nome: SetStatusBarVisibility
'
'Parametri:Boolean che valorizzerà la proprietà Visible della StatusBar
'
'Valori di ritorno:
'
'Funzionalità:
'Su richiesta di frmOption, Mostra/Nasconde la Statusbar
'**/
Public Sub SetStatusBarVisibility(ByVal bVisible As Boolean)
    stbStatusbar.Visible = bVisible
End Sub

'**+
'Nome: SetToolBarIcons
'
'Parametri:
'LargeIcons - Il tipo di icona da usare per i bottoni,
'grandi o piccole
'
'Valori di ritorno:
'
'Funzionalità:
'Cambia il tipo di icona della ToolBar standard
'**/
Public Sub SetToolBarIcons(ByVal LargeIcons As Boolean)
    Dim iPicture As Integer

    BarMenu.LargeIcons = LargeIcons
    If LargeIcons Then
        BarMenu.Bands("Standard").Tools("New").SetPicture 0, gResource.GetBitmap(IDB_STD_NEW32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Save").SetPicture 0, gResource.GetBitmap(IDB_STD_SAVE32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Print").SetPicture 0, gResource.GetBitmap(IDB_STD_PRINT32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("PrePrint").SetPicture 0, gResource.GetBitmap(IDB_STD_PREVIEW32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Cut").SetPicture 0, gResource.GetBitmap(IDB_STD_CUT32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Copy").SetPicture 0, gResource.GetBitmap(IDB_STD_COPY32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Paste").SetPicture 0, gResource.GetBitmap(IDB_STD_PASTE32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Delete").SetPicture 0, gResource.GetBitmap(IDB_STD_DELETE32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Clear").SetPicture 0, gResource.GetBitmap(IDB_STD_CLEAR32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("NewSearch").SetPicture 0, gResource.GetBitmap(IDB_STD_FIND32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("ExecuteSearch").SetPicture 0, gResource.GetBitmap(IDB_STD_EXECUTE32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("SearchPrevious").SetPicture 0, gResource.GetBitmap(IDB_STD_PREVIOUS32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("SearchNext").SetPicture 0, gResource.GetBitmap(IDB_STD_NEXT32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Export").SetPicture 0, gResource.GetBitmap(IDB_EXPORT_32), &HC0C0C0
        BarMenu.Bands("Band_Export").Tools("ExportWord").SetPicture 0, gResource.GetBitmap(IDB_STD_WORD32), &HC0C0C0
        BarMenu.Bands("Band_Export").Tools("ExportExcel").SetPicture 0, gResource.GetBitmap(IDB_STD_EXCEL32), &HC0C0C0
        BarMenu.Bands("Band_Export").Tools("ExportHtml").SetPicture 0, gResource.GetBitmap(IDB_STD_HTML32), &HC0C0C0
        BarMenu.Bands("Band_Export").Tools("ExportPDF").SetPicture 0, gResource.GetBitmap(IDB_ACROBAT_32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Web").SetPicture 0, gResource.GetBitmap(IDB_DMT_WEB32), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Agg_Web").SetPicture 0, gResource.GetBitmap(IDB_AGG_WEB32), &HC0C0C0
        
        'cbc - L'icona del pulsante "ChangeView" dipende dalla modalità attuale
        iPicture = IIf(BrwMain.Visible, IDB_STD_FORM32, IDB_STD_GRID32)
        BarMenu.Bands("Standard").Tools("ChangeView").SetPicture 0, gResource.GetBitmap(iPicture), &HC0C0C0
        
        BarMenu.LargeIcons = False
    Else
        BarMenu.Bands("Standard").Tools("New").SetPicture 0, gResource.GetBitmap(IDB_STD_NEW16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Save").SetPicture 0, gResource.GetBitmap(IDB_STD_SAVE16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Print").SetPicture 0, gResource.GetBitmap(IDB_STD_PRINT16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("PrePrint").SetPicture 0, gResource.GetBitmap(IDB_STD_PREVIEW16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Cut").SetPicture 0, gResource.GetBitmap(IDB_STD_CUT16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Copy").SetPicture 0, gResource.GetBitmap(IDB_STD_COPY16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Paste").SetPicture 0, gResource.GetBitmap(IDB_STD_PASTE16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Delete").SetPicture 0, gResource.GetBitmap(IDB_STD_DELETE16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Clear").SetPicture 0, gResource.GetBitmap(IDB_STD_CLEAR16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("NewSearch").SetPicture 0, gResource.GetBitmap(IDB_STD_FIND16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("ExecuteSearch").SetPicture 0, gResource.GetBitmap(IDB_STD_EXECUTE16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("SearchPrevious").SetPicture 0, gResource.GetBitmap(IDB_STD_PREVIOUS16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("SearchNext").SetPicture 0, gResource.GetBitmap(IDB_STD_NEXT16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Export").SetPicture 0, gResource.GetBitmap(IDB_EXPORT_16), &HC0C0C0
        BarMenu.Bands("Band_Export").Tools("ExportWord").SetPicture 0, gResource.GetBitmap(IDB_STD_WORD16), &HC0C0C0
        BarMenu.Bands("Band_Export").Tools("ExportExcel").SetPicture 0, gResource.GetBitmap(IDB_STD_EXCEL16), &HC0C0C0
        BarMenu.Bands("Band_Export").Tools("ExportHtml").SetPicture 0, gResource.GetBitmap(IDB_STD_HTML16), &HC0C0C0
        BarMenu.Bands("Band_Export").Tools("ExportPDF").SetPicture 0, gResource.GetBitmap(IDB_ACROBAT_16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Web").SetPicture 0, gResource.GetBitmap(IDB_DMT_WEB16), &HC0C0C0
        BarMenu.Bands("Standard").Tools("Agg_Web").SetPicture 0, gResource.GetBitmap(IDB_AGG_WEB16), &HC0C0C0
    
        'L'icona del pulsante "ChangeView" dipende dalla modalità attuale
        iPicture = IIf(BrwMain.Visible, IDB_STD_FORM16, IDB_STD_GRID16)
        BarMenu.Bands("Standard").Tools("ChangeView").SetPicture 0, gResource.GetBitmap(iPicture), &HC0C0C0
    End If
    BarMenu.RecalcLayout
End Sub

'**+
'Nome: SetVisibilityIDFields
'
'Parametri: Optional IDVisible As Variant (Boolean)
'           Se IDVisible è presente (chiamata da frmOption) viene usato il suo valore
'           per settare la visibilità dei campi ID, altrimenti viene letta l'impostazione
'           del registry
'
'Valori di ritorno:
'
'Funzionalità: Mostra/Nasconde i campi ID della Browse
'**/
Public Sub SetVisibilityIDFields(Optional ByVal IDVisible As Variant)
    Dim Col As DmtGridCtl.dgColumnHeader
    Dim bValue As Boolean

    'Legge le impostazioni dal registry
    bValue = IIf(IsMissing(IDVisible), AppOptions.IDFieldsVisibility, IDVisible)

    For Each Col In BrwMain.ColumnsHeader
        If Left(Col.FieldName, 2) = "ID" Then
            Col.Visible = bValue
        End If
    Next Col
    
    'L'aspetto della browse viene ridisegnato.
    BrwMain.Refresh
End Sub


'ATTENZIONE: Nella funzione GetDescription4StatusBar vanno impostati tutti i
'            suggerimenti dei pulsanti della Toolbar e delle voci di menu
'            da visualizzare sulla Statusbar.
'            Per gestire l'opzione multilingua occorre inserire nel file di risorse
'            tutte le stringhe occorrenti.

'**+
'Nome:   GetDescription4StatusBar
'
'Parametri: sToolName è il nome del pulsante o della voce di menu per i quali
'           si vuole ottenere il messaggio sulla Statusbar
'
'Valori di ritorno: La stringa da visualizzare sulla StatusBar
'
'Funzionalità: Restituisce la stringa del suggerimento associato ad un bottone
'              della toolbar o ad una voce di menu
'**/
Private Function GetDescription4StatusBar(ByVal sToolName As String) As String
    Dim sApplicationName As String
    Dim sTipoOggetto As String
    Dim sStr As String
    Dim sTemp As String

    
    sApplicationName = m_App.FunctionName
    sTipoOggetto = m_DocType.Name
    
    Select Case sToolName
    
        Case "File"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_App.FunctionName, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_FILE)
        
        Case "New", "Mnu_New"
            sStr = "Crea un nuovo " & sTipoOggetto
            
        Case "Save", "Mnu_Save"
            sStr = "Memorizza il " & sTipoOggetto & " corrente"
        
        Case "Print", "Mnu_Print"
            If BrwMain.Visible Then
                'Si è in modalità tabellare
                'Qui va inserito il plurale di TipoOggetto
                sStr = "Stampa i " & sTipoOggetto & " correnti"
            Else
                'Si è in modalità form
                sStr = "Stampa il " & sTipoOggetto & " corrente"
            End If
            
        Case "PrePrint", "Mnu_PrePrint"
            gResource.CustomStrings.Clear
            If BrwMain.Visible Then
                'Si è in modalità tabellare
                sTemp = sTipoOggetto & " correnti"
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_SETPREVIEW)
            Else
                'Si è in modalità form
                sTemp = sTipoOggetto & " corrente"
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_SETPREVIEW)
            End If
    
        Case "Mnu_Exit"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add TheApp.FunctionName, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_EXIT)
            
        Case "Edit"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_App.FunctionName, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_MODIFY)
    
        Case "Cut", "Mnu_Cut"
            sStr = gResource.GetCustomizedMessage(IDS_SB_CUT)
            
        Case "Copy", "Mnu_Copy"
            sStr = gResource.GetCustomizedMessage(IDS_SB_COPY)
            
        Case "Paste", "Mnu_Paste"
            sStr = gResource.GetCustomizedMessage(IDS_SB_PASTE)
            
        Case "Delete", "Mnu_Delete"
            sStr = "Elimina il " & sTipoOggetto & " corrente"
            
        Case "Clear", "Mnu_Clear"
            sStr = gResource.GetCustomizedMessage(IDS_SB_CLEAR)
            
        Case "NewSearch", "Mnu_NewSearch"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_SEARCHWINDOW)
            
        Case "ExecuteSearch", "Mnu_ExecuteSearch"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_SEARCHEXECUTE)
            
        Case "Mnu_FormView"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_FORM)
            
        Case "Mnu_TableView"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_TABLE)
            
        Case "Mnu_SearchFilter"
            sStr = "Espone " & m_DocType.Name & " in modo <filtri>."
            
        Case "ChangeView"
            If BrwMain.Visible And BrwMain.GuiMode = dgNormal Then
                'Si è in modalità tabellare
                gResource.CustomStrings.Clear
                gResource.CustomStrings.Add m_DocType.Name, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_FORM)
            Else
                'Si è in modalità form
                gResource.CustomStrings.Clear
                gResource.CustomStrings.Add m_DocType.Name, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_TABLE)
            End If
            
        Case "View"
            sStr = gResource.GetMessage(IDS_SB_DISPLAY)
            
        Case "SearchPrevious", "Mnu_SearchPrevious"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_SEARCHPREVIOUS)
            
        Case "SearchNext", "Mnu_SearchNext"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_SEARCHNEXT)
            
        Case "Mnu_Folders"
            sStr = "Riquadro attività"
            
        Case "Mnu_ToolBar"
            sStr = gResource.GetMessage(IDS_SB_TOOLBAR)
            
        Case "Tools"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add TheApp.FunctionName, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_TOOLS)
            
        Case "Mnu_Export"
            sStr = gResource.GetMessage(IDS_SB_EXPORT)
            
        Case "Mnu_Options"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add TheApp.FunctionName, 1
            sStr = gResource.GetCustomizedMessage(IDS_SB_OPTION)

            
        Case "ExportWord", "Mnu_ExportWord"
            gResource.CustomStrings.Clear
            If BrwMain.Visible Then
                'Si è in modalità tabellare
                'Qui va inserito il plurale di TipoOggetto
                sTemp = " i " & sTipoOggetto & " correnti "
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_EXPORTWORD)
            Else
                'Si è in modalità form
                sTemp = " il " & sTipoOggetto & " corrente "
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_EXPORTWORD)
            End If
        
        Case "ExportExcel", "Mnu_ExportExcel"
            gResource.CustomStrings.Clear
            If BrwMain.Visible Then
                'Si è in modalità tabellare
                'Qui va inserito il plurale di TipoOggetto
                sTemp = " i " & sTipoOggetto & " correnti "
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_EXPORTEXCEL)
            Else
                'Si è in modalità form
                sTemp = " il " & sTipoOggetto & " corrente "
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_EXPORTEXCEL)
            End If
        
        Case "ExportHtml", "Mnu_ExportHtml"
            gResource.CustomStrings.Clear
            If BrwMain.Visible Then
                'Si è in modalità tabellare
                'Qui va inserito il plurale di TipoOggetto
                sTemp = " i " & sTipoOggetto & " correnti "
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_EXPORTHTML)
            Else
                'Si è in modalità form
                sTemp = " il " & sTipoOggetto & " corrente "
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_EXPORTHTML)
            End If
        
        Case "ExportPDF", "Mnu_ExportPDF"
            gResource.CustomStrings.Clear
            If BrwMain.Visible Then
                'Si è in modalità tabellare
                'Qui va inserito il plurale di TipoOggetto
                sTemp = " i " & sTipoOggetto & " correnti "
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_EXPORTACROBAT)
            Else
                'Si è in modalità form
                sTemp = " il " & sTipoOggetto & " corrente "
                gResource.CustomStrings.Add sTemp, 1
                sStr = gResource.GetCustomizedMessage(IDS_SB_EXPORTACROBAT)
            End If
        
        Case "Mnu_HelpOnLine"
            sStr = gResource.GetMessage(IDS_SB_SUMMARY)
            
        Case "Mnu_Arg"
            sStr = gResource.GetMessage(IDS_SB_ARG)
            
        Case "Mnu_Web"
            sStr = gResource.GetMessage(IDS_SB_WEB)
            
        Case "Mnu_Info"
            sStr = gResource.GetMessage(IDS_SB_INFO)
            
        Case "Mnu_Web", "Web"
            sStr = gResource.GetMessage(IDS_SB_WEB)
        
        Case "Mnu_Agg_Web", "Agg_Web"
            sStr = gResource.GetMessage(IDS_SB_AGG_WEB)
    End Select
    
    GetDescription4StatusBar = sStr
End Function
'//////////////////////////////////////////////////////////////////////////////////
'ATTENZIONE: Nella funzione GetToolTipText4ToolBar vanno impostate tutte le
'            stringhe dei ToolTipText dei pulsanti della Toolbar.
'            Per gestire l'opzione multilingua occorre inserire nel file di risorse
'            tutte le stringhe occorrenti.
'//////////////////////////////////////////////////////////////////////////////////
'**+
'Nome:   GetToolTipText4ToolBar
'
'Parametri: sToolName è il nome del pulsante per il quale
'           si vuole ottenere la stringa per la proprietà ToolTipText
'
'Valori di ritorno: La stringa ToolTipText
'
'Funzionalità: Restituisce la stringa del suggerimento associato ad un bottone
'              della toolbar (ToolTipext)
'**/
Private Function GetToolTipText4ToolBar(ByVal sToolName As String) As String
    Dim sStr As String
    
    gResource.CustomStrings.Clear
    
    Select Case sToolName
    
        Case "New"
            sStr = gResource.GetMessage(TT_NEW)
            
        Case "Save"
            sStr = gResource.GetMessage(TT_SAVE)
        
        Case "Print"
            sStr = gResource.GetMessage(TT_PRINT)
            
        Case "PrePrint"
            sStr = gResource.GetMessage(TT_PREVIEW)
    
        Case "Cut"
            sStr = gResource.GetMessage(TT_CUT)
            
        Case "Copy"
            sStr = gResource.GetMessage(TT_COPY)
            
        Case "Paste"
            sStr = gResource.GetMessage(TT_PASTE)
            
        Case "Delete"
            sStr = gResource.GetMessage(TT_DELETE)
            
        Case "Clear"
            sStr = gResource.GetMessage(TT_CLEAR)
            
        Case "NewSearch"
            sStr = gResource.GetMessage(TT_SEARCH)
            
        Case "ExecuteSearch"
            sStr = gResource.GetMessage(TT_SEARCHEXECUTE)
            
        Case "ChangeView"
            If BrwMain.Visible And BrwMain.GuiMode = dgNormal Then
                'Si è in modalità tabellare
                sStr = gResource.GetMessage(TT_FORM)
            Else
                'Si è in modalità form
                sStr = gResource.GetMessage(TT_SEARCHRESULT)
            End If
            
        Case "SearchPrevious"
            sStr = gResource.GetMessage(TT_SEARCHPREVIOUS)
            
        Case "SearchNext"
            sStr = gResource.GetMessage(TT_SEARCHNEXT)
            
        Case "ExportWord"
            sStr = gResource.GetMessage(TT_WORD)
        
        Case "ExportExcel"
            sStr = gResource.GetMessage(TT_EXCEL)
        
        Case "ExportHtml"
            sStr = gResource.GetMessage(TT_HTML)
        
        Case "ViewAssistant" 'toolbar
            sStr = gResource.GetMessage(TT_SHOW_ASSISTANT)
            
        Case "Help" 'toolbar e menu
            sStr = gResource.GetMessage(TT_HELP)

    End Select
    
    GetToolTipText4ToolBar = sStr
End Function

'//////////////////////////////////////////////////////////////////////////////////
'ATTENZIONE: Nella funzione GetCaption4MenuBar vanno impostate tutte le
'            stringhe delle Caption delle voci di menu.
'            Per gestire l'opzione multilingua occorre inserire nel file di risorse
'            tutte le stringhe occorrenti.
'//////////////////////////////////////////////////////////////////////////////////
'**+
'Nome:   GetCaption4MenuBar
'
'Parametri: sToolName è il nome della voce di menu per la quale
'           si vuole ottenere la stringa per la Caption
'
'Valori di ritorno: La stringa da visualizzare nella Caption del menu
'
'Funzionalità: Restituisce la stringa della Caption di una voce di menu
'**/
Private Function GetCaption4MenuBar(ByVal sToolName As String) As String
    Dim sStr As String
    
    gResource.CustomStrings.Clear
    
    Select Case sToolName
    
        Case "File"
            sStr = gResource.GetMessage(MNU_FILE)
        
        Case "Mnu_New"
            sStr = gResource.GetMessage(MNU_NEW)
            aryShortCut(1).Value = "Control+N"
            BarMenu.Bands("Band_File").Tools("Mnu_New").ShortCuts = aryShortCut
            
        Case "Mnu_Save"
            If m_App.Language <> 1 Then
                sStr = gResource.GetMessage(MNU_SAVE)
                aryShortCut(1).Value = "Control+S"
                BarMenu.Bands("Band_File").Tools("Mnu_Save").ShortCuts = aryShortCut
            Else
                sStr = gResource.GetMessage(MNU_SAVE)
                aryShortCut(1).Value = "Shift+F12"
                BarMenu.Bands("Band_File").Tools("Mnu_Save").ShortCuts = aryShortCut
            End If
        
        Case "Mnu_PrePrint"
            sStr = gResource.GetMessage(MNU_PREVIEW)
        
        Case "Mnu_Print"
            If m_App.Language <> 1 Then
                sStr = gResource.GetMessage(MNU_PRINT) & "..."
                aryShortCut(1).Value = "Control+P"
                BarMenu.Bands("Band_File").Tools("Mnu_Print").ShortCuts = aryShortCut
            Else
                sStr = gResource.GetMessage(MNU_PRINT) & "..."
                aryShortCut(1).Value = "Control+Shift+F12"
                BarMenu.Bands("Band_File").Tools("Mnu_Print").ShortCuts = aryShortCut
            End If
    
        Case "Mnu_Exit"
            sStr = gResource.GetMessage(MNU_EXIT)
            
        Case "Edit"
            sStr = gResource.GetMessage(MNU_MODIFY)
    
        Case "Mnu_Delete"
            sStr = gResource.GetMessage(MNU_DELETE)
            aryShortCut(1).Value = "Delete"
            BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").ShortCuts = aryShortCut
            
        Case "Mnu_Clear"
            sStr = gResource.GetMessage(MNU_CLEAR)
    
        Case "Mnu_Cut"
            sStr = gResource.GetMessage(MNU_CUT)
            aryShortCut(1).Value = "Control+X"
            frmMain.BarMenu.Bands("Band_Edit").Tools("Mnu_Cut").ShortCuts = aryShortCut
            
        Case "Mnu_Copy"
            sStr = gResource.GetMessage(MNU_COPY)
            aryShortCut(1).Value = "Control+C"
            frmMain.BarMenu.Bands("Band_Edit").Tools("Mnu_Copy").ShortCuts = aryShortCut
            
        Case "Mnu_Paste"
            sStr = gResource.GetMessage(MNU_PASTE)
            aryShortCut(1).Value = "Control+V"
            frmMain.BarMenu.Bands("Band_Edit").Tools("Mnu_Paste").ShortCuts = aryShortCut
            
        Case "Mnu_NewSearch"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetMessage(MNU_FIND)
            aryShortCut(1).Value = "Control+T"
            frmMain.BarMenu.Bands("Band_Edit").Tools("Mnu_NewSearch").ShortCuts = aryShortCut
            
        Case "Mnu_ExecuteSearch"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetMessage(MNU_EXECUTE_SEARCH)
            aryShortCut(1).Value = "Control+E"
            frmMain.BarMenu.Bands("Band_Edit").Tools("Mnu_ExecuteSearch").ShortCuts = aryShortCut
            
        Case "Mnu_SearchPrevious"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetMessage(MNU_PREVIOUS_SEARCH)
            aryShortCut(1).Value = "Control+P"
            frmMain.BarMenu.Bands("Band_Edit").Tools("Mnu_SearchPrevious").ShortCuts = aryShortCut
            
        Case "Mnu_SearchNext"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetMessage(MNU_NEXT_SEARCH)
            aryShortCut(1).Value = "Control+S"
            frmMain.BarMenu.Bands("Band_Edit").Tools("Mnu_SearchNext").ShortCuts = aryShortCut
            
        Case "View"
            sStr = gResource.GetMessage(MNU_DISPLAY)
            
        Case "Mnu_FormView"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetMessage(MNU_FORM)
            aryShortCut(1).Value = "Control+F"
            frmMain.BarMenu.Bands("Band_View").Tools("Mnu_FormView").ShortCuts = aryShortCut
            
        Case "Mnu_TableView"
            gResource.CustomStrings.Clear
            gResource.CustomStrings.Add m_DocType.Name, 1
            sStr = gResource.GetMessage(MNU_TABLE)
            aryShortCut(1).Value = "Control+M"
            frmMain.BarMenu.Bands("Band_View").Tools("Mnu_TableView").ShortCuts = aryShortCut
            
        Case "Mnu_SearchFilter"
            sStr = "Mo&dalità filtri"
            aryShortCut(1).Value = "Control+Shift+T"
            frmMain.BarMenu.Bands("Band_View").Tools("Mnu_SearchFilter").ShortCuts = aryShortCut
            
        Case "Mnu_Folders"
            sStr = "&Riquadro attività"
            
        Case "Mnu_ToolBar"
            sStr = gResource.GetMessage(MNU_TOOLBAR)
            
        Case "Tools"
            sStr = gResource.GetMessage(MNU_TOOL)
            
        Case "Mnu_Export"
            sStr = gResource.GetMessage(MNU_EXPORT)
            
        Case "Mnu_Options"
            sStr = gResource.GetMessage(MNU_OPTION)
            
        Case "Mnu_ExportWord"
                sStr = gResource.GetMessage(MNU_EXPORT_WORD)
        
        Case "Mnu_ExportExcel"
                sStr = gResource.GetMessage(MNU_EXPORT_EXCEL)
        
        Case "Mnu_ExportHtml"
                sStr = gResource.GetMessage(MNU_EXPORT_HTML)
        
        Case "Mnu_ExportPDF"
                sStr = gResource.GetMessage(MNU_EXPORT_ACROBAT)
        
        Case "Help" 'toolbar e menu
            sStr = "&?"

        Case "Mnu_HelpOnLine"
            sStr = gResource.GetMessage(MNU_HELP)
            aryShortCut(1).Value = "F1"
            frmMain.BarMenu.Bands("Band_Help").Tools("Mnu_HelpOnLine").ShortCuts = aryShortCut
            
        Case "Mnu_Arg"
            sStr = gResource.GetMessage(MNU_ARG)
            aryShortCut(1).Value = "Shift+F1"
            frmMain.BarMenu.Bands("Band_Help").Tools("Mnu_Arg").ShortCuts = aryShortCut
            
        Case "Mnu_Web"
            sStr = gResource.GetMessage(MNU_WEB)
            
        Case "Mnu_Agg_Web"
            sStr = gResource.GetMessage(MNU_AGG_WEB)
            
        Case "Mnu_Info"
            sStr = gResource.GetMessage(MNU_INFO)
            
        Case "Mnu_RunApplication"
            sStr = gResource.GetMessage(MNU_EXE_GEST)
            aryShortCut(1).Value = "Control+G"
            frmMain.BarMenu.Bands("Band_PopUp").Tools("Mnu_RunApplication").ShortCuts = aryShortCut
        
        Case "Mnu_SearchObject"
            sStr = gResource.GetMessage(MNU_SEARCH)
            aryShortCut(1).Value = "Control+R"
            frmMain.BarMenu.Bands("Band_PopUp").Tools("Mnu_SearchObject").ShortCuts = aryShortCut
            
    End Select
    
    GetCaption4MenuBar = sStr
End Function


'**+
'Nome:   RefreshDescriptions4StatusBar
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità: Reimposta i messaggi da visualizzare sulla StatusBar per quelle
'              voci che dipendono dalla modalità di visualizzazione (Form/Tabella).
'
'**/
Private Sub RefreshDescriptions4StatusBar()
    'ATTENZIONE:
    'Inserire qui tutte le voci di menu ed i pulsanti della toolbar per i quali si
    'vuole cambiare il suggerimento sulla StatusBar in funzione della modalità di
    'visualizzazione. Ad esempio è possibile avere dei messaggi al SINGOLARE per
    'la modalità form e PLURALE per la modalità tabellare.
    'La funzione GetDescription4StatusBar si occupa di determinare la frase esatta.
    BarMenu.Bands("Band_File").Tools("Mnu_PrePrint").Description = GetDescription4StatusBar("Mnu_PrePrint")
    BarMenu.Bands("Band_File").Tools("Mnu_Print").Description = GetDescription4StatusBar("Mnu_Print")
    BarMenu.Bands("Standard").Tools("Print").Description = GetDescription4StatusBar("Print")
    BarMenu.Bands("Standard").Tools("PrePrint").Description = GetDescription4StatusBar("PrePrint")
    BarMenu.Bands("Standard").Tools("ChangeView").Description = GetDescription4StatusBar("ChangeView")
    BarMenu.Bands("Band_Export").Tools("ExportWord").Description = GetDescription4StatusBar("ExportWord")
    BarMenu.Bands("Band_Export").Tools("ExportExcel").Description = GetDescription4StatusBar("ExportExcel")
    BarMenu.Bands("Band_Export").Tools("ExportHtml").Description = GetDescription4StatusBar("ExportHtml")
    BarMenu.Bands("Band_Export").Tools("ExportPDF").Description = GetDescription4StatusBar("ExportPDF")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportWord").Description = GetDescription4StatusBar("ExportWord")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportExcel").Description = GetDescription4StatusBar("ExportExcel")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportHtml").Description = GetDescription4StatusBar("ExportHtml")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportPDF").Description = GetDescription4StatusBar("ExportPDF")

End Sub


'**+
'Autore: Diamante s.p.a
'Data creazione: 25/09/00
'Autore ultima modifica:
'Data ultima modifica:
'
'Nome: Caption2Display
'
'Parametri:
'  Boolean ReadFromGrid - determina se le stringhe per la costruzione della caption devono essere lette direttamente
'  dai campi del documento o dalla collection AllColumns della BrwMain.
'
'Valori di ritorno: String
'
'Funzionalità:
'                  ///////////////////////////////////////////////////////////////////////////////////////////////////////
'                  In questa funzione va inserito il codice per la determinazione della caption del form principale
'                  per le modalità Modify e Browse in base alle esigenze specifiche.
'                  Di default viene usato esclusivamente il campo del documento individuato dalla
'                  costante CAMPO_PER_CAPTION.
'                  ///////////////////////////////////////////////////////////////////////////////////////////////////////
'
'**/
Private Function Caption2Display(Optional ByVal ReadFromGrid As Boolean, Optional X As neVisualModality) As String
    If Not m_Document.EOF And Not m_Document.BOF Then
        If Not ReadFromGrid Then
            
            Caption2Display = m_App.Caption & ": " & fnNotNull(m_Document.Fields(CAMPO_PER_CAPTION).Value) & " [Versione " & App.Major & "." & App.Minor & "." & App.Revision & "]"
        Else
            
            Caption2Display = m_App.Caption & ": " & fnNotNull(BrwMain.AllColumns(CAMPO_PER_CAPTION).Value) & " [Versione " & App.Major & "." & App.Minor & "." & App.Revision & "]"
        End If
    Else
        Caption2Display = m_App.FunctionName & " [Versione " & App.Major & "." & App.Minor & "." & App.Revision & "]"
    End If
End Function



'**+
'Nome :SetStatus4Modality
'
'Parametri:NewModality rappresenta la modalità di visualizzazione
'          che si vuole ottenere.
'          ModePreview è uno switch per apertura o chiusura anteprima di stampa.
'
'Valori di ritorno:
'
'Funzionalità: Abilita i pulsanti della Toolbar e le voci di menu in funzione
'              di una determinata modalità di visualizzazione.
'              (disabilita tutti i rimanenti pulsanti e voci di menu)
'              Imposta la Caption del form in funzione della modalità di visualizzazione
'**/
Private Sub SetStatus4Modality(ByVal NewModality As neVisualModality, _
                                Optional ByVal ModePreview As nePreviewModality)
    Dim KeyON As Currency
    Dim KeyOFF As Currency
    Dim iPicture As Integer
   
    
    'Indica lo stato di visibilità della ToolBar standard
    'prima della visualizzazione della ToolBar della anteprima
    'di stampa
    Static bToolBarStandardVisible As Boolean
    
    'Indica lo stato di attivazione dei bottoni della ToolBar
    'standard prima della visualizzazione della ToolBar della
    'anteprima di stampa
    Static curToolBarStandardStatus As Currency
    
    
    'Elimina l'acceleratore CUT
    BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").Caption = gResource.GetMessage(MNU_DELETE)
    'Rimuove lo shortcut "Delete"
    aryShortCut(1).Clear
    BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").ShortCuts = aryShortCut
    
    'Imposta i pulsanti e le voci di menu
    Select Case NewModality
    
        Case Insert
            KeyOFF = BTN_SAVE + BTN_PRINT + BTN_PREVIEW + BTN_DELETE + BTN_SEARCH
            KeyOFF = KeyOFF + BTN_SEARCHTABLE + BTN_SEARCHFORM + BTN_VIEWMODE
            KeyOFF = KeyOFF + BTN_FILTER
            KeyOFF = KeyOFF + BTN_PREVIOUS + BTN_NEXT
            KeyOFF = KeyOFF + BTN_WORD + BTN_EXCEL + BTN_HTML + BTN_PDF
            KeyON = BTN_ALL - KeyOFF
            Me.Caption = m_App.Caption
            oFiltersActivity.AbortNewFilter
            
            If BrwMain.GuiMode = dgFilterDefinition Then
                bEnableGuiEvent = False
                BrwMain.GuiMode = dgNormal
                bEnableGuiEvent = True
            End If
            
            m_Search = False
            
        Case Modify
            KeyOFF = BTN_SAVE + BTN_CLEAR + BTN_SEARCH + BTN_SEARCHFORM
            KeyON = BTN_ALL - KeyOFF
            'in modalità variazione si è necessariamente in modalità form
            'pertanto il pulsante ChangeView della toolbar deve visualizzare
            'l'icona della griglia
            iPicture = IIf(GetSetting(REGISTRY_KEY, TheApp.Name & "Settings", "LargeIcon", False), IDB_STD_GRID32, IDB_STD_GRID16)
            BarMenu.Bands("Standard").Tools("ChangeView").SetPicture 0, gResource.GetBitmap(iPicture), &HC0C0C0
            BarMenu.Bands("Standard").Tools("ChangeView").ToolTipText = GetToolTipText4ToolBar("ChangeView")
            If Not (m_Document.EOF = True Or m_Document.BOF = True) Then
                'Monta la caption del form principale
                Me.Caption = Caption2Display(False)
            End If
            oFiltersActivity.AbortNewFilter
                        
            m_Search = False
            
        Case Find
        
            'Solo se esiste almeno un elemento nel data manager.
            If Not (m_Document.EOF = True And m_Document.BOF = True) Then
                KeyON = BTN_VIEWMODE + BTN_SEARCHTABLE + BTN_SEARCHFORM
            End If
            KeyON = KeyON + BTN_NEW + BTN_CUT + BTN_COPY + BTN_PASTE
            KeyON = KeyON + BTN_CLEAR + BTN_SEARCH
            KeyOFF = BTN_ALL - KeyON
            'In modalità Find verrà proposto il pulsante per andare in modalità tabella
            'pertanto il pulsante ChangeView della toolbar deve visualizzare
            'l'icona della griglia
            iPicture = IIf(GetSetting(REGISTRY_KEY, TheApp.Name & "Settings", "LargeIcon", False), IDB_STD_GRID32, IDB_STD_GRID16)
            BarMenu.Bands("Standard").Tools("ChangeView").SetPicture 0, gResource.GetBitmap(iPicture), &HC0C0C0
            BarMenu.Bands("Standard").Tools("ChangeView").ToolTipText = GetToolTipText4ToolBar("ChangeView")
            BarMenu.Bands("Standard").Tools("ChangeView").Description = GetDescription4StatusBar("ChangeView")
            Me.Caption = gResource.GetMessage(TT_SEARCH) & " - " & m_App.Caption
            
            oFiltersActivity.AbortNewFilter
                
            'Cancella eventuali blocchi su qualsiasi azione.
            m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
            
        Case Browse
            KeyOFF = BTN_SAVE + BTN_CLEAR + BTN_SEARCH + BTN_PREVIOUS + BTN_NEXT
            KeyOFF = KeyOFF + BTN_SEARCHTABLE + BTN_CUT + BTN_COPY + BTN_PASTE
            KeyON = BTN_ALL - KeyOFF
            'Seleziona l'icona grande o piccola in base alle impostazioni correnti
            iPicture = IIf(GetSetting(REGISTRY_KEY, TheApp.Name & "Settings", "LargeIcon", False), IDB_STD_FORM32, IDB_STD_FORM16)
            BarMenu.Bands("Standard").Tools("ChangeView").SetPicture 0, gResource.GetBitmap(iPicture), &HC0C0C0
            BarMenu.Bands("Standard").Tools("ChangeView").ToolTipText = GetToolTipText4ToolBar("ChangeView")
            If Not (m_Document.EOF = True Or m_Document.BOF = True) Then
                'Monta la caption del form principale
                Me.Caption = Caption2Display(False)
            End If
            'Inserisce l'acceleratore CUT
            BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").Caption = gResource.GetMessage(MNU_DELETE)
            'Inserisce lo shortcut "Delete"
            aryShortCut(1).Value = "Delete"
            BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").ShortCuts = aryShortCut
            
            'Questo controllo si è reso necessario per evitare un loop infinito
            'con la gestione dell'evento BrwMain_OnChangeGuiMode() quando dal
            'Menu della browse si va in modalità tabellare.
            If BrwMain.GuiMode <> dgNormal Then
                BrwMain.GuiMode = dgNormal
            End If
            
            'Se il filtro attivo è un filtro temporaneo viene abilitato il pulsante
            'Salva Filtro del DocTypeExplorer per poterlo rendere permanente.
            If m_ActiveFilter.ID = -1 Then
                oFiltersActivity.NewFilterBegin   'Abilita il pulsante Salva Filtro
            Else
                oFiltersActivity.AbortNewFilter   'Disabilita il pulsante Salva Filtro
            End If
            ActivityBox.Redraw = True
            
            m_Search = False
            
            'Cancella eventuali blocchi su qualsiasi azione.
            m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
            
            
        Case Preview
            If ModePreview = OpenPrw Then
                bToolBarStandardVisible = BarMenu.Bands("Standard").Visible
                curToolBarStandardStatus = GetStatusToolBar(True)
                KeyON = BTN_PRINT + BTN_EXCEL + BTN_WORD + BTN_HTML + BTN_PDF
                KeyOFF = BTN_ALL - KeyON
                BarMenu.Bands("Band_View").Tools("Mnu_Folders").Enabled = False
                BarMenu.Bands("Band_View").Tools("Mnu_ToolBar").Enabled = False
                BarMenu.Bands("Band_Tools").Tools("Mnu_Options").Enabled = False
                BarMenu.Bands("Standard").Visible = False
                BarMenu.Bands(BAND_CLOSE_PREVIEW).Visible = True
                BarMenu.RecalcLayout
            Else
                BarMenu.Bands(BAND_CLOSE_PREVIEW).Visible = False
                BarMenu.Bands("Standard").Visible = bToolBarStandardVisible
                ActivateBarButtons curToolBarStandardStatus, True
                ActivateBarButtons BTN_ALL - curToolBarStandardStatus, False
                BarMenu.Bands("Band_View").Tools("Mnu_Folders").Enabled = True
                BarMenu.Bands("Band_View").Tools("Mnu_ToolBar").Enabled = True
                BarMenu.Bands("Band_Tools").Tools("Mnu_Options").Enabled = True
                BarMenu.RecalcLayout
            End If
            
    End Select
    
    'Attiva/disattiva i pulsanti e le voci di menu
    ActivateBarButtons KeyON, True
    ActivateBarButtons KeyOFF, False
End Sub

'**+
'Autore                 : Diamante S.p.a
'
'Nome                   : PermissionToSave
'
'Parametri:
'
'Valori di ritorno: True se il documento può essere salvato, False altrimenti.
'
'Funzionalità: Controlli da effettuare PRIMA di salvare il documento corrente
'
'**/
Private Function PermissionToSave() As Boolean
    
    '///////////////////////////////////////////////////////////////////
    'Inserire qui il codice di controllo sulla validità e consistenza
    'dei dati da salvare.
    '///////////////////////////////////////////////////////////////////
If m_Document("IDRV_POCaricoMerceTesta").Value < 0 Then
    If Me.TxtIDAnagrafica.Text < 0 Then
        MsgBox "Manca il nome del socio", vbCritical, "Impossibile salvare"
        Me.txtSocio.SetFocus
        PermissionToSave = False
        Exit Function
    End If
    If Me.cboMagazzinoConf.CurrentID = 0 Then
        MsgBox "Manca il magazzino di conferimento", vbCritical, "Impossibile salvare"
        Me.cboMagazzinoConf.SetFocus
        PermissionToSave = False
        Exit Function
    End If
    If Me.CboMagazzinoVend.CurrentID = 0 Then
        MsgBox "Manca il magazzino di vendita", vbCritical, "Impossibile salvare"
        Me.CboMagazzinoVend.SetFocus
        PermissionToSave = False
        Exit Function
    End If
    
    If Me.cboSezionale.CurrentID = 0 Then
        MsgBox "Manca il sezionale", vbCritical, "Impossibile salvare"
        Me.cboSezionale.SetFocus
        PermissionToSave = False
        Exit Function
    End If
    
    If Me.txtNumeroDocumento.Value = 0 Then
        MsgBox "Manca il numero del documento", vbCritical, "Impossibile salvare"
        Me.txtNumeroDocumento.SetFocus
        PermissionToSave = False
        Exit Function
    End If
    
    If Me.txtDataDocumento.Text = "" Then
        MsgBox "Manca la data del documento", vbCritical, "Impossibile salvare"
        Me.txtDataDocumento.SetFocus
        PermissionToSave = False
        Exit Function
    End If
         
    If ControlloNumeroDocumento = False Then
        MsgBox "Il numero documento è già stato associato ad un precedente documento", vbCritical, "Impossibile salvare"
        Me.txtDataDocumento.SetFocus
        PermissionToSave = False
        Exit Function
    End If
    
    PermissionToSave = True
Else
    PermissionToSave = True
End If
End Function
Private Function ControlloNumeroDocumento() As Boolean
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
    ControlloNumeroDocumento = True
    
    sSQL = "SELECT * FROM Oggetto "
    sSQL = sSQL & "WHERE ((Numero=" & fnNormString(Me.txtNumeroDocumento.Value) & ") "
    sSQL = sSQL & "AND (IDSezionale=" & Me.cboSezionale.CurrentID & ") "
    sSQL = sSQL & "AND (DataEmissione >=" & fnNormDate(DataInizio_Esercizio) & ") "
    sSQL = sSQL & "AND (DataEmissione <=" & fnNormDate(DataFine_Esercizio) & "))"
    
    
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF = False Then
        ControlloNumeroDocumento = False
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End Function

'**+
'Nome: SearchNext
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Posizionamento al record successivo
'**/
Private Sub SearchNext()
On Error GoTo ERR_SearchNext
    
    Me.Enabled = False
    
    m_Document.MoveNext
    
    Me.Enabled = True
    
    If m_Document.EOF Then
        'Si era già sull'ultimo record (prima di MoveNext).
        
        'Si annulla l'operazione
        m_Document.MovePrevious
        sbMsgInfo gResource.GetMessage(MESS_NO_NEXT_ELEMENTS), m_App.FunctionName
        Exit Sub
    Else
        'Controlla la presenza di eventuali conflitti nel caso di multiutenza.
        
        If Not m_Semaphore.IsActionAvailable(m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions) Then
            m_Document.MovePrevious
        Else
            m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
            m_Semaphore.SetObjectAction m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions
        End If
    End If
Exit Sub
ERR_SearchNext:
    MsgBox Err.Description, vbCritical, "SearchNext"
    Me.Enabled = True
End Sub

'**+
'Nome: SearchPrevious
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Posizionamento al record precedente
'**/
Private Sub SearchPrevious()
On Error GoTo ERR_SearchPrevious

    Me.Enabled = False
    
    m_Document.MovePrevious
    
    Me.Enabled = True
    
    If m_Document.BOF Then
        'Si era già sul primo record (prima di MovePrevious).
        
        'Si annulla l'operazione
        m_Document.MoveNext
        sbMsgInfo gResource.GetMessage(MESS_NO_PREVIOUS_ELEMENTS), m_App.FunctionName
        Exit Sub
    Else
        'Controlla la presenza di eventuali conflitti nel caso di multiutenza.
        
        If Not m_Semaphore.IsActionAvailable(m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions) Then
            m_Document.MoveNext
        Else
            m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
            m_Semaphore.SetObjectAction m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions
        End If
    End If

Exit Sub
ERR_SearchPrevious:
    MsgBox Err.Description, vbCritical, "SearchPrevious"
    Me.Enabled = True
End Sub

'**+
'Nome: BrowseReposition
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni da compiere al riposizionamento del record corrente
'**/
Private Sub BrowseReposition()

    'Dopo un Save del documento avviene un Refresh della Browse ma in tal caso
    'è inutile effettuare il refresh del form.
    If Not m_bAvoidReposition Then
    
        'Refresh dei campi del form
        RefreshFormFields
        
        'Refresh della caption del Form
        If Not (m_Document.EOF = True Or m_Document.BOF = True) Then
            'Monta la caption del form principale
            Me.Caption = Caption2Display(False)
        End If
        
    End If
 
    'Refresh delle variabili di stato
    m_Changed = False
    m_Saved = False
    m_Search = False
    
    'Annullamento di un eventuale inizio di inserimento di un nuovo record
    m_Document.AbortNew
    
End Sub



'**+
'Nome: NewRecord
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni su richiesta nuovo record
'**/
Private Sub NewRecord()


'--------------------------------------------------------------------------------------------
'NOTA:
'Il gruppo di istruzioni sottostanti e la riga  'Imposta il blocco su inserimento'
'sono state commentate per far si che la manutenzione NON imposti alcun blocco per
'l'azione Inserimento.
'Pertanto 2 o più utenti potranno effettuare contemporaneamente la suddetta azione.
'Se si intende impedire questa possibilità sarà sufficiente ripristinare le righe commentate.
'--------------------------------------------------------------------------------------------

'------------------------------------------------------------------------------------
'    'Controllo se ho il permesso di salvare ( nel caso di conflitti di multiutenza )
'    If Not m_Semaphore.IsActionAvailable(m_DocType.ID, SemAllObjects, SemInsertAction) Then
'        'C'è un altro utente in modalità inserimento che blocca la medesima azione per
'        'tutti gli altri utenti. Pertanto annullo l'operazione di inserimento ed esco.
'        Exit Sub
'    End If




    'Ho il permesso per l'azione inserimento.
    '
    'Cancella il blocco precedente
    m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
    
    '--------------------------------
    'Imposta il blocco su inserimento
'    m_Semaphore.SetObjectAction m_DocType.ID, SemAllObjects, SemInsertAction
    '
    'A questo punto nessun altro utente potrà effettuare una operazione di inserimento
    'finchè non verrà cancellato il blocco su inserimento.


    'Annulla una eventuale operazione precedente.
    If m_Document.TableNew Then
        m_Document.AbortNew
    End If

    'Creazione buffers vuoti
    m_Document.NewDoc
    
    
    'Refresh delle variabili di stato
    m_Search = False
    m_Changed = False
    m_Saved = False
    
    'Refresh della toolbar in modalità inserimento
    SetStatus4Modality Insert
    
    'Ripristina la vista del Form
    BrwMain.Visible = False
    
    
    'Il primo campo del Form riceve l'input focus
    SetFocusTabIndex0
    
    If (LAVORAZIONE_AUTOMATICA = 0) And (LINK_LAVORAZIONE_DA_MOV = 0) Then
        NewSearch
    End If
    
    'ExecuteSearch
    
End Sub

'**+
'Nome                   : ClearControl
'
'Parametri              : ctrControl As Control - controllo da pulire
'
'Valori di ritorno      :
'
'Funzionalità           : Pulisce un controllo sulla base del tipo del controllo stesso
'
'**/
Private Sub ClearControl(ByVal ctrControl As Control)
    Dim sType As String

    sType = TypeName(ctrControl)
    
    If sType = "fpDateTime" Or sType = "TextBox" Or sType = "fpText" Or sType = "fpLongInteger" Or sType = "fpCurrency" Or sType = "fpDoubleSingle" Or sType = "dmtDate" Then
        ctrControl.Text = ""
    ElseIf sType = "CheckBox" Then
        ctrControl.Value = 0
    ElseIf sType = "fpBoolean" Then
        ctrControl.Value = 0
    ElseIf sType = "ComboBox" Then
        ctrControl.ListIndex = -1
    ElseIf sType = "DMTCombo" Then
        ctrControl.ListIndex = -1
    ElseIf sType = "ListBox" Then
        ctrControl.ListIndex = -1
    ElseIf sType = "ListView" Then
        ctrControl.ListItems.Clear
    ElseIf sType = "TreeView" Then
        ctrControl.Nodes.Clear
    ElseIf sType = "Town" Then
        ctrControl.Reset
    ElseIf sType = "DmtSearchACS" Then
        ctrControl.IDAnagrafica = 0
        ctrControl.Description = ""
        ctrControl.SecondDescription = ""
        
    ElseIf sType = "dmtCurrency" Or sType = "dmtNumber" Then
        ctrControl.Value = 0
        ctrControl.Text = ""
    ElseIf sType = "DmtSearchACS" Then
        ctrControl.IDNode = 0
    ElseIf sType = "DmtFirmGerarchy" Then
        ctrControl.LoadActivity 0
    ElseIf sType = "DMTProgControl" Then
        'Queste istruzioni forzano il refresh
        'e il reset del componente
        ctrControl.IDArticolo = 0
        ctrControl.Show
    End If
End Sub


'**+
'Nome: ClearFormFields
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Pulisce il contenuto dei campi di input del Form
'**/
Private Sub ClearFormFields()
    Dim cField As FormField
    
    For Each cField In m_FormFields
        'Viene ripulito il campo di immissione.
        ClearControl cField.Control
    Next
End Sub

'**+
'Nome: ExecuteMenuCommand
'
'Parametri:
'sToolName - Nome del comando selezionato
'
'Valori di ritorno:
'
'Funzionalità:
'Gestione dei comandi generati dal controllo ActiveBar
'**/
Private Sub ExecuteMenuCommand(ByVal sToolName As String)
    Dim iAnswer As Integer

    'cbcxn
    'Notifica alla (eventuale) applicazione che gestisce il processo On_Extend la
    'pressione di un Tool. Se l'applicazione chiamata restituisce True viene annullata l'operazione.
    'If m_ExtendApplication.BeforeCommandClick(sToolName) Then Exit Sub

    Select Case sToolName
        Case "Cut", "Mnu_Cut"
            SendKeys ("+{DEL}")
            
        Case "Copy", "Mnu_Copy"
            SendKeys ("^{INSERT}")
            
        Case "Paste", "Mnu_Paste"
            SendKeys ("+{INSERT}")
            
        Case "Mnu_Folders"
            OnFolders
            
        Case "ClosePreview"
            ClosePreview
            
        Case "Save", "Mnu_Save"
            
            OnSave
        Case "Mnu_Exit"
            Unload frmMain
            
        Case "Delete", "Mnu_Delete"
            OnNewSearch
            
        Case "Clear", "Mnu_Clear"
            OnClear
            
        Case "ExecuteSearch", "Mnu_ExecuteSearch"
            OnExecuteSearch
        
        Case "SearchNext", "Mnu_SearchNext"
            
            OnMoveCurrentRecord SRCNEXT, sToolName
        
        Case "SearchPrevious", "Mnu_SearchPrevious"
            
            OnMoveCurrentRecord SRCPREVIOUS, sToolName
        
        Case "ChangeView", "Mnu_FormView", "Mnu_TableView"
            OnChangeView sToolName
            
        Case "Mnu_ToolBar"
            OnToolBarOptions
            
        Case "Mnu_Options"
            OnOptions
            
        Case "Mnu_Info"
            OnInfo
            
        Case "PrePrint", "Mnu_PrePrint", "Print", "Mnu_Print", "ExportWord", "Mnu_ExportWord", "ExportExcel", "Mnu_ExportExcel", "ExportHtml", "Mnu_ExportHtml"
            OnPrint sToolName
            
        Case "NewSearch", "Mnu_NewSearch", "Mnu_SearchFilter"
            OnNewSearch
            
        Case "New", "Mnu_New"
            
            'OnNew sToolName
            OnNewSearch
           
        Case "Mnu_RunApplication", "Mnu_SearchObject"
            OnRunApplication sToolName
        Case "Mnu_Summary"
            OnSummary
        Case "Mnu_FastHelp", "Help"
            OnFastHelp
        Case "Mnu_HelpOnLine"
            OnHelpOnLine
        Case "Mnu_Arg"
             OnArg
        Case "Mnu_Web1"
             sbOpenURL hwnd, URL_DIAMANTE
    End Select
    
    
    'cbcxn
    'Notifica alla (eventuale) applicazione che gestisce il processo On_Extend la
    'pressione di un Tool DOPO avere eseguito l'operazione ad esso associata
    'm_ExtendApplication.AfterCommandClick sToolName
    
End Sub

'**+
'Nome: RefreshFormFields
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Riempie i valori dei campi del Form con i valori
'del documento.
'**/
Private Sub RefreshFormFields()

    'rif3 start
    
    Dim Fields As DmtDocManLib.Fields
    Dim Control As Control
    Dim Field As FormField
    
    On Error Resume Next
    
    'In questi casi non si deve far nulla
    If Not (m_Document.EOF = True Or m_Document.BOF = True) Then

       'Passa alla collezione Fields dell'oggetto
        'Document i valori da salvare
        For Each Field In m_FormFields
    
            Select Case TypeName(Field.Control)
                Case "TextBox"
                    Field.Control.Text = fnNotNull(m_Document.Fields(Field.Name).Value)
                Case "DMTCombo"
                    Field.Control.WriteOn fnNotNullN(m_Document.Fields(Field.Name).Value)
                Case "Town"
                    If Field.Name = "IDComune" Then
                        Field.Control.TownID = fnNotNullN(m_Document.Fields(Field.Name).Value)
                    ElseIf Field.Name = "Cap" Then
                        Field.Control.Zip = fnNotNull(m_Document.Fields(Field.Name).Value)
                    End If
                Case "dmtDate"
                    Field.Control.Text = fnNotNull(m_Document.Fields(Field.Name).Value)
                Case "dmtNumber"
                    Field.Control.Text = fnNotNullN(m_Document.Fields(Field.Name).Value)
                    
                Case "dmtCurrency"
                    Field.Control.Text = fnNotNullN((m_Document.Fields(Field.Name).Value))
                Case "dmtTime"
                    Field.Control.Text = fnNormDate(m_Document.Fields(Field.Name).Value)
                Case "DmtSearchACS"
                        Field.Control.Description = fnNotNull(m_Document.Fields("Anagrafica").Value)
                        Field.Control.SecondDescription = fnNotNull(m_Document.Fields("Nome").Value)
                        Field.Control.IDAnagrafica = m_Document.Fields(Field.Name).Value
                Case "CheckBox"
                    Field.Control.Value = Abs(fnNotNullN((m_Document.Fields(Field.Name).Value)))
                Case "DmtCodDesc"
                    Field.Control.Load fnNotNull(m_Document.Fields(Field.Name).Value)
            End Select
           
        Next

  
    End If

    'rif3 end
    
End Sub

'**+
'Nome: ClearFields
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Azzera i valori dei campi del documento
'**/
Private Sub ClearFields()
    Dim Field As DmtDocManLib.Field
    
    For Each Field In m_Document.Fields
        Field.Value = Empty
    Next
End Sub

'**+
'Nome: Change
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni su variazione di un campo del Form
'**/
Private Sub Change()
    'Se si è in modalità tabellare non deve essere eseguita perchè
    'altrimenti al Click della Browse si attiverebbe il pulsante Salva
    If Not m_Search And Not BrwMain.Visible Then
        ActivateBarButtons BTN_SAVE, True
    
        m_Changed = True
        m_Saved = False
        m_Search = False
    End If
End Sub

'**+
'Nome: CreateFormFields
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Crea la collezione FormFields che associa i campi del
'documento con i controlli di input del Form. Vengono
'anche creati i controlli del Form necessari e calcolato
'il layout del Form.
'**/
Private Sub CreateFormFields()
    Dim Field As FormField
        
        
    'rif2 start
    
    'Se non esiste il documento aperto non si può creare la collezione
    If m_Document Is Nothing Then Exit Sub
    
    'Se la collezione è già stata creata esce
    If Not m_FormFields Is Nothing Then Exit Sub
    
    'Istanzia la collezione.  Il codice sottostante viene eseguito soltanto la prima volta
    Set m_FormFields = New FormFields
    
    'rif2   End
    
    
    'Chiuso
    Set Field = New FormField
    Set Field.Control = Me.chkChiusoConferimento
    Field.Name = "Chiuso"
    Field.Visible = True
    Me.chkChiusoConferimento.Tag = Field.Name
    m_FormFields.Add Field
    
End Sub


'**+
'Nome: ClosePreview
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Chiude la finestra della anteprima di stampa
'**/
Private Sub ClosePreview()
    Dim myDate
    
    On Error GoTo errHandler
        
    If m_Report.ClosePreview Then
        m_PreviewWindowHandle = 0
        PicForm.Visible = True
        BrwMain.Visible = m_TabMode
        ActivityBox.Visible = BarMenu.Bands("Band_View").Tools("Mnu_Folders").Checked
        FormRecalcLayout
        Set m_Report = Nothing
        SetStatus4Modality Preview, ClosePrw
    End If
    Exit Sub
errHandler:
    'Se si verifica un errore "SQL server in use"
    'la subroutine entra in un ciclo di attesa per
    '3 secondi prima di tentare nuovamente la chiusura
    myDate = Now
    If Err.Description = "SQL server in use" Then
        While Not (Now = DateAdd("s", 3, myDate))
        Wend
        Resume
    End If
    Err.Raise Err.Number, , Err.Description
End Sub



'**+
'Nome: ShortCut
'
'Parametri:
'KeyCode - Codice del tasto
'Shift - Stato del tasto Shift
'
'Valori di ritorno:
'
'Funzionalità:
'Gestione degli accelleratori da tastiera
'**/
'**+
'Nome: ShortCut
'
'Parametri:
'KeyCode - Codice del tasto
'Shift - Stato del tasto Shift
'
'Valori di ritorno:
'
'Funzionalità:
'Gestione degli accelleratori da tastiera
'**/
Private Function ShortCut(KeyCode As Integer, Shift As Integer) As Boolean
    Dim bCtrlDown As Boolean
    Dim bShiftDown As Boolean
    Dim bAltDown As Boolean
    
    bShiftDown = (Shift And vbShiftMask) > 0
    bCtrlDown = (Shift And vbCtrlMask) > 0
    bAltDown = (Shift And vbAltMask) > 0
    
    Select Case KeyCode
         Case vbKeyF12
            If bShiftDown Then
                If bCtrlDown Then
                    If BarMenu.Bands("Band_File").Tools("Mnu_Print").Enabled Then
                        ExecuteMenuCommand ("Mnu_Print")
                        ShortCut = True
                    End If
                Else
                    If BarMenu.Bands("Band_File").Tools("Mnu_Save").Enabled Then
                    
                        'Forza il lostfocus ed attende l'esecuzione di eventuali eventi associati
                        AutoLostFocus
                        
                        ExecuteMenuCommand ("Mnu_Save")
                        ShortCut = True
                    End If
                End If
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyF1
            SendMessage hwnd, WM_SETREDRAW, 0, 0
            'SendKeys ("{ESC}")
            DoEvents
            SendMessage hwnd, WM_SETREDRAW, 1, 0
            If bShiftDown Then
                'case shift F1
                ExecuteMenuCommand ("Mnu_Arg")
                ShortCut = True
                KeyCode = 0
                Shift = 0
            Else
                ExecuteMenuCommand ("Mnu_HelpOnLine")
                ShortCut = True
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyN
            If bCtrlDown Then
                If BarMenu.Bands("Band_File").Tools("Mnu_New").Enabled Then
                    ExecuteMenuCommand ("Mnu_New")
                    ShortCut = True
                End If
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyX
'            If bCtrlDown Then
'                If BarMenu.Bands("Band_Edit").Tools("Mnu_Cut").Enabled Then
'                    ExecuteMenuCommand ("Mnu_Cut")
'                    ShortCut = True
'                End If
''                KeyCode = 0
''                Shift = 0
'            End If
            
        Case vbKeyC
            If bCtrlDown Then
'                If BarMenu.Bands("Band_Edit").Tools("Mnu_Copy").Enabled Then
'                    ExecuteMenuCommand ("Mnu_Copy")
'                    ShortCut = True
'                End If
                KeyCode = 0
                Shift = 0
            End If
            If bAltDown And BarMenu.Bands(BAND_CLOSE_PREVIEW).Visible Then
                ClosePreview
                ShortCut = True
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyV
            If bCtrlDown Then
'                If BarMenu.Bands("Band_Edit").Tools("Mnu_Paste").Enabled Then
'                    ExecuteMenuCommand ("Mnu_Paste")
'                    ShortCut = True
'                End If
                'KeyCode = 0
                'Shift = 0
            End If
            
        Case vbKeyT
            If bCtrlDown And bShiftDown = False Then   'CTRL + T
                If BarMenu.Bands("Band_Edit").Tools("Mnu_NewSearch").Enabled Then
                    ExecuteMenuCommand ("Mnu_NewSearch")
                    ShortCut = True
                End If
                KeyCode = 0
                Shift = 0
            End If
            If bCtrlDown And bShiftDown = True Then     'CTRL + MAIUSC + T
                If BarMenu.Bands("Band_View").Tools("Mnu_SearchFilter").Enabled Then
                    ExecuteMenuCommand ("Mnu_SearchFilter")
                    ShortCut = True
                End If
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyE
            If bCtrlDown Then
                If BarMenu.Bands("Band_Edit").Tools("Mnu_ExecuteSearch").Enabled Then
                    ExecuteMenuCommand "Mnu_ExecuteSearch"
                    ShortCut = True
                End If
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyP
            If bCtrlDown Then
                If BarMenu.Bands("Band_Edit").Tools("Mnu_SearchPrevious").Enabled Then
                    ExecuteMenuCommand ("Mnu_SearchPrevious")
                    ShortCut = True
                End If
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyS
            If bCtrlDown Then
                If BarMenu.Bands("Band_Edit").Tools("Mnu_SearchNext").Enabled Then
                    ExecuteMenuCommand ("Mnu_SearchNext")
                    ShortCut = True
                End If
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyM
            If bCtrlDown Then
                If BarMenu.Bands("Band_View").Tools("Mnu_TableView").Enabled Then
                    ExecuteMenuCommand ("Mnu_TableView")
                    ShortCut = True
                End If
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyF
            If bCtrlDown Then
                If BarMenu.Bands("Band_View").Tools("Mnu_FormView").Enabled Then
                    ExecuteMenuCommand ("Mnu_FormView")
                    ShortCut = True
                End If
                KeyCode = 0
                Shift = 0
            End If
            
        Case vbKeyDelete
            'Il tasto Canc ha effetto solo se il controllo attivo è la browse principale.
            If ActiveControl.Name = "BrwMain" And Not bShiftDown Then
                If BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").Enabled Then
                    If BrwMain.Visible Then
                        ExecuteMenuCommand ("Mnu_Delete")
                        ShortCut = True
                        KeyCode = 0
                        Shift = 0
                    End If
                End If
            End If
            
        Case vbKeyR
            If bCtrlDown Then
                ExecuteMenuCommand ("Mnu_SearchObject")
                ShortCut = True
                'La condizione sottostante è necessaria per attivare l'acceleratore CTRL+R dalla modalità
                'filtri della DmrGrid
                If Not BrwMain.Visible Or (BrwMain.Visible And BrwMain.GuiMode = dgNormal) Then
                    KeyCode = 0
                    Shift = 0
                End If
            End If
            
        Case vbKeyG
            If bCtrlDown Then
                ExecuteMenuCommand ("Mnu_RunApplication")
                ShortCut = True
                KeyCode = 0
                Shift = 0
            End If
    
        Case vbKeyEscape
             If Not ActiveControl Is Nothing Then
                    If TypeName(ActiveControl) = "DmtGrid" Then
                        If BrwMain.GuiMode = dgFilterDefinition Then
                            If Not (m_Document.EOF = True And m_Document.BOF = True) Then
                                BrwMain.GuiMode = dgNormal
                                ExecuteMenuCommand "Mnu_TableView"
                                ShortCut = True
                            Else
                                'Ripulisce il contenuto delle condizioni.
                                BrwMain.Conditions.ClearValues
                                'Imposta la modalità FilterDefinition
                                BrwMain.GuiMode = dgFilterDefinition
                                ShortCut = True
                            End If
                        End If
                    End If
                KeyCode = 0
                Shift = 0
            End If
    
    End Select

End Function


'**+
'Nome: ShowErrorLog
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Mostra il dialogo di informazioni su l'ultimo errore
'bloccante verificatosi durante l'esecuzione del programma
'**/
Private Sub ShowErrorLog()
    Load frmErrorLog
    frmErrorLog.DMTErrorContol.MainProgram.Comments = App.Comments
    frmErrorLog.DMTErrorContol.MainProgram.Company = App.CompanyName
    frmErrorLog.DMTErrorContol.MainProgram.Copyright = App.LegalCopyright
    frmErrorLog.DMTErrorContol.MainProgram.Description = App.FileDescription
    frmErrorLog.DMTErrorContol.MainProgram.FileName = App.EXEName
    frmErrorLog.DMTErrorContol.MainProgram.Version = App.Major & "." & App.Minor & "." & App.Revision
    frmErrorLog.DMTErrorContol.ErrorNumber = Err.Number
    frmErrorLog.DMTErrorContol.ErrorDescription = Err.Description
    frmErrorLog.DMTErrorContol.Show
    frmErrorLog.Show vbModal
    End
End Sub


'**+
'Nome: OnBeforeOpenDoc
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Inizializzazioni da effettuare prima dell'apertura del documento.
'**/
Private Sub OnBeforeOpenDoc()
Dim rs As DmtOleDbLib.adoResultset
    'Inserire qui le
    'inizializzazioni da effettuare prima dell'apertura del documento.
    
    
    'rif6 begin
    
    Dim NewLink As DmtDocManLib.Link
    
'**************************CORPO DOCUMENTO*******************************

    'Crea un sottodocumento basato sulla tabella di cross "RV_POCaricoMerceRighe"
    
    Set m_DocumentsLink = m_Document.AddDocumentsLink("RV_POAssegnazioneMerce")
          
    'Impostazioni dell'oggetto DocumentsLink
    m_DocumentsLink.EnableRefreshLinks = True '<-- Abilita il refresh dei campi collegati
    m_DocumentsLink.PrimaryKey = "IDRV_POAssegnazioneMerce" '<-- Specifica il campo chiave primaria
    
    'Crea un Link LEFT JOIN sulla tabella Articolo
    Set NewLink = m_DocumentsLink.AddLink("IDUnitaDiMisura", "UnitaDiMisura", ltLeft, "IDUnitaDiMisura")
    NewLink.AddLinkColumn "UnitaDiMisura"
    
    'Crea un Link LEFT JOIN sulla tabella Articolo
    Set NewLink = m_DocumentsLink.AddLink("IDUnitaDiMisuraCoop", "RV_POUnitaDiMisuraCoop", ltLeft, "IDRV_POUnitaDiMisuraCoop")
    NewLink.AddLinkColumn "UnitaDiMisuraCoop"
    
    'Crea un Link LEFT JOIN sulla tabella Articolo
    Set NewLink = m_DocumentsLink.AddLink("IDRV_POTipoCategoria", "RV_POTipoCategoria", ltLeft, "IDRV_POTipoCategoria")
    NewLink.AddLinkColumn "TipoCategoria"
    
    'Crea un Link LEFT JOIN sulla tabella Articolo
    Set NewLink = m_DocumentsLink.AddLink("IDTipoLavorazione", "RV_POTipoLavorazione", ltLeft, "IDRV_POTipoLavorazione")
    NewLink.AddLinkColumn "TipoLavorazione"
    
    'Crea un Link LEFT JOIN sulla tabella Articolo
    Set NewLink = m_DocumentsLink.AddLink("IDRV_POCalibro", "RV_POCalibro", ltLeft, "IDRV_POCalibro")
    NewLink.AddLinkColumn "Calibro"

    'Crea un Link LEFT JOIN sulla tabella Anagrafica
    Set NewLink = m_DocumentsLink.AddLink("IDCliente", "Anagrafica", ltLeft, "IDAnagrafica")
    NewLink.AddLinkColumn "Anagrafica.Anagrafica", "AnagraficaCliente"

    'Crea un Link LEFT JOIN sulla tabella RV_POProcessoIVGamma
    Set NewLink = m_DocumentsLink.AddLink("IDRV_POProcessoIVGammaRighe", "RV_POProcessoIVGammaIN", ltLeft, "IDRV_POProcessoIVGammaRighe")
    NewLink.AddLinkColumn "RV_POProcessoIVGammaIN.AnnoProcesso"
    NewLink.AddLinkColumn "RV_POProcessoIVGammaIN.NumeroProcesso"
    
    'Crea un Link LEFT JOIN sulla tabella Articolo per recuperare il codice e descrizione dell'imballo primario
    Set NewLink = m_DocumentsLink.AddLink("IDArticoloImballoPrimario", "Articolo", ltLeft, "IDArticolo")
    NewLink.AddLinkColumn "Articolo.CodiceArticolo", "CodiceImballoPrimario"
    NewLink.AddLinkColumn "Articolo.Articolo", "DescrizioneImballoPrimario"
    
    
    m_DocumentsLink.AddOrderedColumn "Link_Ordinamento", ocAscending


'************************************************************************************


    'Crea un sottodocumento basato sulla tabella di cross "RV_POCaricoMerceRighe"
    
    Set m_DocumentsLink1 = m_Document.AddDocumentsLink("RV_POLavorazione")
          
    'Impostazioni dell'oggetto DocumentsLink
    m_DocumentsLink1.EnableRefreshLinks = True '<-- Abilita il refresh dei campi collegati
    m_DocumentsLink1.PrimaryKey = "IDRV_POLavorazione" '<-- Specifica il campo chiave primaria
    
    'Crea un Link LEFT JOIN sulla tabella Articolo
    Set NewLink = m_DocumentsLink1.AddLink("IDUnitaDiMisura", "UnitaDiMisura", ltLeft, "IDUnitaDiMisura")
    NewLink.AddLinkColumn "UnitaDiMisura"
    
    'Crea un Link LEFT JOIN sulla tabella Articolo
    Set NewLink = m_DocumentsLink1.AddLink("IDUnitaDiMisuraCoop", "RV_POUnitaDiMisuraCoop", ltLeft, "IDRV_POUnitaDiMisuraCoop")
    NewLink.AddLinkColumn "UnitaDiMisuraCoop"




End Sub


'**+
'Autore: Carlo B. Collovà
'Data creazione: 20/11/00
'Autore ultima modifica:
'Data ultima modifica:
'
'Nome: InitExtensions
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità: Inizializza la componente adibita alla gestione dell'evento On_Extend
'
'**/
'Private Sub InitExtensions()
    'cbcx
    
    'Istanzia l'oggetto
    'Set m_ExtendApplication = New DmtExtendApp.ExtendApplication
    'Set m_ExtendApplication = New DmtExtendAppLib.ExtendApplication
    
    'Assegna un riferimento all'oggetto Application.
    'In questo modo la maggior parte dei parametri di inizializzazione vengono
    'letti da quest'ultimo
    'Set m_ExtendApplication.Application = m_App
    
    'Assegna un riferimento al controllo ActiveBar affinchè la classe
    'che gestisce i dati aggiuntivi possa interagire con la user interface
    'della manutenzione.
    'Set m_ExtendApplication.MenuBar = BarMenu
        
    'Se la funzione correntemente in esecuzione prevede l'evento On_Extend
    'vengono effettuate tutte le inizializzazioni del caso (come l'aggiunta di bottoni
    ' e menu alla BarMenu, ecc.) altrimenti la classe ExtendApplication non effettua
    'alcuna operazione.
    'm_ExtendApplication.Initialize
    
    'NOTA:
    '-----------------------------------------------------------------------------------------------------
    'Tutte le proprietà di m_ExtendApplication presenti anche nell'interfaccia IExtendApplication ed impostate
    'dopo la chiamata al metodo Initialize saranno settate anche in cContactPlus
    '-----------------------------------------------------------------------------------------------------
    
    'Assegna un riferimento del documento corrente
    'Set m_ExtendApplication.CurrentDocument = m_Document

'End Sub


'**+
'Nome: Start
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Inizializzazione e procedura di avvio
'**/
                                                        
                  

                         

'**+
'Nome: ConditionType
'
'Parametri: DBType è il valore di DMTDocManLib.Field.DBType e rappresenta
'           il tipo di dato corrispondente all'oggetto Field in base dati.
'
'Valori di ritorno: una costante di tipo ConditionTypeConstants usata dalla Browse
'                   per costruire una condizione di ricerca.
'
'Funzionalità: Trasforma una costante DBType in una costante compatibile ConditionTypeConstants
'**/
Private Function ConditionType(ByVal DBType As Integer) As DmtGridCtl.ConditionTypeConstants
    Select Case DBType

        'dbTypeCHAR, dbTypeVARCHAR, dbTypeWCHAR, dbTypeWVARCHAR
        Case 1, 12, -8, -9
            ConditionType = dgCondTypeText
       
        'dbTypeNUMERIC, dbTypeDECIMAL, dbTypeINTEGER, dbTypeSMALLINT, dbTypeFLOAT
        'dbTypeREAL, dbTypeDOUBLE, dbTypeBIGINT, dbTypeTINYINT
        Case 2, 3, 4, 5, 6, 7, 8, -5, -6
            ConditionType = dgCondTypeNumber
            
        'dbTypeTIMESTAMP  ////NOTA: Se si desidera un campo dmCondTypeTime occorre gestirlo ad Hoc.
        Case 135
            ConditionType = dgCondTypeDate
    
        'dbTypeBIT
        Case -7, 11
            ConditionType = dgCondTypeBoolean
            
    End Select
End Function

'**+
'Nome: CreateBrowserConditions
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità: Crea automaticamente i campi per la ricerca (modalità DefineFilter)
'              a partire dai campi non ID del documento.
'**/
Private Sub CreateBrowserConditions()
    Dim Field As DmtDocManLib.Field
    Dim Cond As DmtGridCtl.dgCondition
    
    
    If Right(Trim(MenuOptions.ConnectionString), 1) = ";" Then
        Me.BrwMain.ConnectionString = MenuOptions.ConnectionString & "User Id=" & m_App.User & ";Password=" & m_App.Password
    Else
        Me.BrwMain.ConnectionString = MenuOptions.ConnectionString & ";" & "User Id=" & m_App.User & ";Password=" & m_App.Password
    End If
    
    'Vengono creati automaticamente i campi per la ricerca.
    'In una applicazione specifica questo codice andrà sostituito integralmente per definire
    'dei campi di ricerca ad hoc.
    
    'Non viene visualizzata la Check Intervallo perchè attualmente
    'il modello ad oggetti non prevede la gestione di filtri con
    'clausole BETWEEN.

    BrwMain.Conditions.Clear

    BrwMain.Conditions.WidthConditions = 200
    BrwMain.Conditions.WidthFields = 200
    BrwMain.Conditions.WidthIntervals = 100
    
    BrwMain.Title.BackColor = vb3DFace
    BrwMain.Title.ForeColor = vbBlack
    BrwMain.Title.Font.Bold = True
                
    Set Cond = BrwMain.Conditions.Add("CodiceLotto", "Codice lotto", m_DocType.TableName, True, False, , dgCondTypeText)
    Set Cond = BrwMain.Conditions.Add("CodiceArticolo", "Codice articolo", m_DocType.TableName, True, False, , dgCondTypeText)
    Set Cond = BrwMain.Conditions.Add("Articolo", "Articolo", m_DocType.TableName, True, False, , dgCondTypeText)
    Set Cond = BrwMain.Conditions.Add("LottoDiConferimento", "Lotto di produzione", m_DocType.TableName, True, False, , dgCondTypeText)
    Set Cond = BrwMain.Conditions.Add("Anagrafica", "Socio o Fornitore", m_DocType.TableName, True, False, , dgCondTypeText)
    Set Cond = BrwMain.Conditions.Add("CodiceSocio", "Codice socio", m_DocType.TableName, True, False, , dgCondTypeText)
    
    Set Cond = BrwMain.Conditions.Add("IDTipoDocumentoCoop", "Tipo documento", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT IDRV_POTipoDocumentoCoop, TipoDocumentoCoop FROM RV_POTipoDocumentoCoop "
        Cond.DisplayField = "TipoDocumentoCoop"
        Cond.KeyField = "IDRV_POTipoDocumentoCoop"

    Set Cond = BrwMain.Conditions.Add("DataDocumento", "Data conferimento", m_DocType.TableName, False, True, False, dgCondTypeDate)
    Set Cond = BrwMain.Conditions.Add("NumeroDocumento", "Numero conferimento", m_DocType.TableName, False, True, False, dgCondTypeNumber)
    
    Set Cond = BrwMain.Conditions.Add("Chiuso", "Chiuso", m_DocType.TableName, False, False, False, dgCondTypeBoolean)
        Cond.FromValue = "NO"
    Set Cond = BrwMain.Conditions.Add("PreConferimento", "Pre-Conferimento", m_DocType.TableName, False, False, False, dgCondTypeBoolean)

    'Stato della liquidazione
    Set Cond = BrwMain.Conditions.Add("IDRV_POTipoConfLiquidazione", "Stato di liquidazione", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM RV_POTipoConfLiquidazione "
        Cond.DisplayField = "TipoConfLiquidazione"
        Cond.KeyField = "IDRV_POTipoConfLiquidazione"
    'Categoria merceologica
    Set Cond = BrwMain.Conditions.Add("IDCategoriaMerceologica", "Categoria merceologica", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM CategoriaMerceologica "
        Cond.DisplayField = "CategoriaMerceologica"
        Cond.KeyField = "IDCategoriaMerceologica"
    'Prodotto
    Set Cond = BrwMain.Conditions.Add("IDTipoProdotto", "Tipo prodotto", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM TipoProdotto WHERE IDAzienda=" & TheApp.IDFirm
        Cond.DisplayField = "TipoProdotto"
        Cond.KeyField = "IDTipoProdotto"
    'Categoria fiscale
    Set Cond = BrwMain.Conditions.Add("IDCategoriaFiscale", "Categoria fiscale", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM CategoriaFiscale "
        Cond.DisplayField = "CategoriaFiscale"
        Cond.KeyField = "IDCategoriaFiscale"
    'Categoria Categoria provvigione
    Set Cond = BrwMain.Conditions.Add("IDCategoriaProvv", "Categoria provv.", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM CategoriaProvv WHERE IDAzienda=" & TheApp.IDFirm
        Cond.DisplayField = "CategoriaProvv"
        Cond.KeyField = "IDCategoriaProvv"
    'Famiglia prodotto
    Set Cond = BrwMain.Conditions.Add("RV_PO01_IDFamigliaProdotti", "Famiglia", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM RV_PO01_FamigliaProdotti "
        Cond.DisplayField = "FamigliaProdotti"
        Cond.KeyField = "IDRV_PO01_FamigliaProdotti"
    'Varietà
    Set Cond = BrwMain.Conditions.Add("RV_PO01_IDVarieta", "Varietà", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM RV_PO01_Varieta "
        Cond.DisplayField = "Varieta"
        Cond.KeyField = "IDRV_PO01_Varieta"
    Set Cond = BrwMain.Conditions.Add("IDLuogoPresaMerce", "Sede stoccaggio merce", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM SitoPerAnagrafica WHERE IDAnagrafica=" & GET_LINK_ANAGRAFICA_AZIENDA(TheApp.IDFirm)
        Cond.DisplayField = "SitoPerAnagrafica"
        Cond.KeyField = "IDSitoPerAnagrafica"
    Set Cond = BrwMain.Conditions.Add("IDVettore", "Vettore", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM Vettore"
        Cond.DisplayField = "Vettore"
        Cond.KeyField = "IDVettore"
    Set Cond = BrwMain.Conditions.Add("IDRV_POTipoOrdineConforme", "Tipo ordine conforme", m_DocType.TableName, False, False, , dgCondTypeComboDB)
        Cond.Indentation = 20
        Cond.RecordSource = "SELECT * FROM RV_POTipoOrdineConforme ORDER BY TipoOrdineConforme"
        Cond.DisplayField = "TipoOrdineConforme"
        Cond.KeyField = "IDRV_POTipoOrdineConforme"
End Sub

'**+
'Nome: Export
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Esegue l'esportazione del documento con controllo di errore
'**/
Private Sub ExportDocument(ByVal Appl As Long)
    On Error GoTo errHandler
    
    Dim OLDCursor As Integer
    
    OLDCursor = Screen.MousePointer
    
    Screen.MousePointer = vbHourglass
    m_Document.Export m_Report, Appl
    Screen.MousePointer = OLDCursor
    Exit Sub
errHandler:
    Screen.MousePointer = OLDCursor
    
    If Err.Number = 20507 Then
        'Errore "Invalid file Name" generato quando non è possibile trovare il file .rpt
        sbMsgInfo "File di report non trovato", m_App.FunctionName
    Else
        sbMsgInfo Err.Description, m_App.FunctionName
    End If
End Sub

'**+
'Nome: PrintDocument
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Esegue la stampa del documento con controllo di errore per nessuna stampante
'definita
'**/
Private Sub PrintDocument(ByVal ToolName As String)
    On Error GoTo errHandler
    
    Dim OLDCursor As Integer
    
    '**+ Riferimento al cursore corrente
    OLDCursor = Screen.MousePointer
    
    '**+ Inizializzazione selezioni di stampa
    m_Report.Copies = 1
    m_Report.Orientation = ocPortrait
    m_Report.PrinterName = ""
    
    If ToolName = "Mnu_Print" Then
        '**+ stampa con dialogo
        Set DmtPrnDlg.Report = m_Report
        DmtPrnDlg.Show
        If Not DmtPrnDlg.Cancel Then
            Screen.MousePointer = vbHourglass
            m_Document.DoPrint m_Report
        End If
    Else
        'Stampa diretta
        Screen.MousePointer = vbHourglass
        m_Document.DoPrint m_Report
    End If
    
    Screen.MousePointer = OLDCursor
    Exit Sub

errHandler:
    Screen.MousePointer = OLDCursor
    If Err.Number = vbObjectError + 36 Then
        ' errore generato all'interno della DMTDocManLib per nessuna stampante
        sbMsgInfo "Non è possibile ottenere informazioni sulla stampante." & Chr(13) & "Controllare che sia installata correttamente", m_App.FunctionName
    ElseIf Err.Number = vbObjectError + 4 Then
        'Si è annullata la stampa.
    Else
        sbMsgInfo Err.Description, m_App.FunctionName
    End If
    
End Sub

'**+
'Nome: DoNewDocument
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Procedure per la richiesta di un nuovo documento
'**/
Private Function DoNewDocument() As Integer
    
    '------------------------------------------------
    'Inserire qui se occorre del codice specifico
    'per la manutenzione.
    '------------------------------------------------
    
    DoNewDocument = ChooseAboutSaving
End Function

'**+
'Nome: WriteStatusBar
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Scrive una stringa di testo nella StatusBar
'**/
Private Sub WriteStatusBar(ByVal sTesto As String)
    If stbStatusbar.Style = sbrSimple Then
        stbStatusbar.SimpleText = sTesto
    Else
        stbStatusbar.Panels(1).Text = sTesto
    End If
End Sub

'**+
'Nome: FormUnload
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Esegue i controlli alla richiesta di abbandono del form
'**/
Private Function FormUnload() As Integer
On Error GoTo ERR_FormUnload
    Dim sMessage As String
    Dim sMessage1 As String
    Dim lIDField As Long

    
    If m_Changed Then
        Select Case ChooseAboutSaving
            Case vbCancel
                FormUnload = 1
                Exit Function
            Case vbYes
                OnSave
                'Se la registrazione non è andata a buon fine
                'esce e non chiude il programma
                If Not m_Saved Then
                    FormUnload = 1
                    Exit Function
                End If
        End Select
    End If
        
    
    If m_PreviewWindowHandle > 0 Then
        ClosePreview
    End If
    
    SaveRegistrySettings
    
    If (LAVORAZIONE_AUTOMATICA > 0) Then DeleteSetting REGISTRY_KEY, App.EXEName, "LavorazioneAutomatica"
    If (LINK_PROCESSO_RIGHE_PROD > 0) Then DeleteSetting REGISTRY_KEY, App.EXEName, "IDProcessoRiga"
    If (LINK_PROCESSO_PROD > 0) Then DeleteSetting REGISTRY_KEY, App.EXEName, "IDProcesso"
    If (LINK_LINEA_PROD > 0) Then DeleteSetting REGISTRY_KEY, App.EXEName, "IDLineaProduzione"
    If (LINK_LAVORAZIONE_DA_MOV > 0) Then DeleteSetting REGISTRY_KEY, App.EXEName, "IDLavorazione"
    If (TIPO_LAVORAZIONE_DA_MOV > 0) Then DeleteSetting REGISTRY_KEY, App.EXEName, "Tipo"
    
    'Se il programma è stato chiamato da un link occorre restituire l'ID del record attivo
    'all'applicazione chiamante.
    
    
    If bNotReturnValue = True Then
        If Len(m_App.Caller) > 0 Then
            'Il programma è stato chiamato da un link.
            
            'Se non verrà correttamente selezionato un elemento sarà restituito il valore -1 all'applicazione client.
            lIDField = -1
            
            'Se il documento è vuoto non si deve far nulla.
            'Se la browse è in modalità Filter Definition non formula la domanda di riporto dei dati nel programma chiamante.
            If (Not (m_Document.EOF And m_Document.BOF)) And (BrwMain.GuiMode <> dgFilterDefinition) Then
            
                'ATTENZIONE: La stringa sMessage1 deve essere personalizzata a seconda dei casi!!!
                sMessage1 = " il " & m_DocType.Name
                sMessage = sMessage1 & " """ & m_Document.Fields(CAMPO_PER_CAPTION).Value & """"
                
                gResource.CustomStrings.Clear
                gResource.CustomStrings.Add sMessage, 1
                                  
                'Viene chiesto se si intende riportare il record corrente al programma chiamante.
                If fnMsgQuestion(gResource.GetCustomizedMessage(MESS_QUERYPASTE), m_App.FunctionName) = vbYes Then
                    'Legge l'ID del record corrente affinchè venga riportato all'applicazione chiamante.
                    lIDField = m_Document.Fields("ID" & m_App.TableName).Value
                End If
                
            End If
            
            
            'Scrive sul registry l'ID da passare all'aplicazione chiamante.
            SaveSetting REGISTRY_KEY, m_App.Caller, "IDField", lIDField

        End If
    End If
Exit Function
ERR_FormUnload:
    MsgBox Err.Description, vbCritical, "FormUnload"
End Function

'**+
'Nome: FormRecalcLayout
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Ricalcolo del layout del form
'**/
Private Sub FormRecalcLayout()
    Dim Height As Single
    Dim Width As Single

    'Se il form è minimizzato non serve il ricalcolo del layout
    If WindowState <> vbMinimized Then
        ActivityBox.Top = BarMenu.ClientAreaTop
        ActivityBox.Left = BarMenu.ClientAreaLeft
        ActivityBox.Height = IIf(BarMenu.ClientAreaHeight > 0, BarMenu.ClientAreaHeight, 0)
        
        imgSplitter.Visible = ActivityBox.Visible
        imgSplitter.Top = ActivityBox.Top
        imgSplitter.Height = ActivityBox.Height
        
        If ActivityBox.Visible Then
            imgSplitter.Left = ActivityBox.Width + ActivityBox.Left
            picSplitter.Left = imgSplitter.Left
        End If
        
        PicForm.Top = BarMenu.ClientAreaTop
        
        If ActivityBox.Visible Then
            PicForm.Left = imgSplitter.Left + imgSplitter.Width
        Else
            PicForm.Left = BarMenu.ClientAreaLeft
        End If
        


        Width = BarMenu.ClientAreaWidth - IIf(ActivityBox.Visible, ActivityBox.Width + imgSplitter.Width, 0)
        Height = BarMenu.ClientAreaHeight
        
        PicForm.Width = IIf(Width < 100, 100, Width)
        PicForm.Height = IIf(Height < 100, 100, Height)
        
        'RIDIMENSIONA LA SPLIT BAR IN BASE ALLA DIMENSIONE DEL FORM
        DMTSplitBar1.Move PicForm.Left, PicForm.Top, PicForm.Width, PicForm.Height
        'INIZIALIZZA LA SPLIT BAR
        DMTSplitBar1.SetSplitBar Height, Width, Me.PicForm2.Height, Me.PicForm2.Width
        
        'PicForm.Top = BarMenu.ClientAreaTop
        
        'If ActivityBox.Visible Then
        '    PicForm.Left = imgSplitter.Left + imgSplitter.Width
        'Else
        '    PicForm.Left = BarMenu.ClientAreaLeft
        'End If
        
        BrwMain.Top = PicForm.ScaleTop
        BrwMain.Left = PicForm.ScaleLeft
        BrwMain.Width = PicForm.ScaleWidth
        BrwMain.Height = PicForm.ScaleHeight
        

    End If
End Sub

'**+
'Nome: GetStatusToolBar
'
'Parametri:
'Enabled - Stato di abilitazione da controllare
'
'Valori di ritorno:
'
'Funzionalità:
'Calcola lo stato dei bottoni della ToolBar standard
'**/
Private Function GetStatusToolBar(ByVal Enabled As Boolean) As Currency
    Dim Valore As Currency

    Valore = 0
    If BarMenu.Bands("Standard").Tools("New").Enabled = Enabled Then Valore = Valore Or BTN_NEW
    If BarMenu.Bands("Standard").Tools("Save").Enabled = Enabled Then Valore = Valore Or BTN_SAVE
    If BarMenu.Bands("Standard").Tools("Print").Enabled = Enabled Then Valore = Valore Or BTN_PRINT
    If BarMenu.Bands("Standard").Tools("PrePrint").Enabled = Enabled Then Valore = Valore Or BTN_PREVIEW
    If BarMenu.Bands("Standard").Tools("Cut").Enabled = Enabled Then Valore = Valore Or BTN_CUT
    If BarMenu.Bands("Standard").Tools("Copy").Enabled = Enabled Then Valore = Valore Or BTN_COPY
    If BarMenu.Bands("Standard").Tools("Paste").Enabled = Enabled Then Valore = Valore Or BTN_PASTE
    If BarMenu.Bands("Standard").Tools("Delete").Enabled = Enabled Then Valore = Valore Or BTN_DELETE
    If BarMenu.Bands("Standard").Tools("Clear").Enabled = Enabled Then Valore = Valore Or BTN_CLEAR
    If BarMenu.Bands("Standard").Tools("NewSearch").Enabled = Enabled Then Valore = Valore Or BTN_FIND
    If BarMenu.Bands("Standard").Tools("ExecuteSearch").Enabled = Enabled Then Valore = Valore Or BTN_SEARCH
    If BarMenu.Bands("Standard").Tools("ChangeView").Enabled = Enabled Then Valore = Valore Or BTN_VIEWMODE
    If BarMenu.Bands("Standard").Tools("SearchPrevious").Enabled = Enabled Then Valore = Valore Or BTN_PREVIOUS
    If BarMenu.Bands("Standard").Tools("SearchNext").Enabled = Enabled Then Valore = Valore Or BTN_NEXT
    If BarMenu.Bands("Standard").Tools("Export").Enabled = Enabled Then Valore = Valore Or BTN_EXPORT
    If BarMenu.Bands("Band_Export").Tools("ExportWord").Enabled = Enabled Then Valore = Valore Or BTN_WORD
    If BarMenu.Bands("Band_Export").Tools("ExportExcel").Enabled = Enabled Then Valore = Valore Or BTN_EXCEL
    If BarMenu.Bands("Band_Export").Tools("ExportHtml").Enabled = Enabled Then Valore = Valore Or BTN_HTML
    If BarMenu.Bands("Band_Export").Tools("ExportPDF").Enabled = Enabled Then Valore = Valore Or BTN_PDF
    
    If BarMenu.Bands("Band_View").Tools("Mnu_FormView").Enabled = Enabled Then Valore = Valore Or BTN_SEARCHFORM
    If BarMenu.Bands("Band_View").Tools("Mnu_TableView").Enabled = Enabled Then Valore = Valore Or BTN_SEARCHTABLE
    If BarMenu.Bands("Band_View").Tools("Mnu_SearchFilter").Enabled = Enabled Then Valore = Valore Or BTN_FILTER

    If BarMenu.Bands("Band_File").Tools("Mnu_New").Enabled = Enabled Then Valore = Valore Or BTN_NEW
    If BarMenu.Bands("Band_File").Tools("Mnu_Save").Enabled = Enabled Then Valore = Valore Or BTN_SAVE
    If BarMenu.Bands("Band_File").Tools("Mnu_Print").Enabled = Enabled Then Valore = Valore Or BTN_PRINT
    If BarMenu.Bands("Band_File").Tools("Mnu_PrePrint").Enabled = Enabled Then Valore = Valore Or BTN_PREVIEW

    If BarMenu.Bands("Band_Edit").Tools("Mnu_Cut").Enabled = Enabled Then Valore = Valore Or BTN_CUT
    If BarMenu.Bands("Band_Edit").Tools("Mnu_Copy").Enabled = Enabled Then Valore = Valore Or BTN_COPY
    If BarMenu.Bands("Band_Edit").Tools("Mnu_Paste").Enabled = Enabled Then Valore = Valore Or BTN_PASTE
    If BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").Enabled = Enabled Then Valore = Valore Or BTN_DELETE
    If BarMenu.Bands("Band_Edit").Tools("Mnu_Clear").Enabled = Enabled Then Valore = Valore Or BTN_CLEAR
    If BarMenu.Bands("Band_Edit").Tools("Mnu_NewSearch").Enabled = Enabled Then Valore = Valore Or BTN_FIND
    If BarMenu.Bands("Band_Edit").Tools("Mnu_ExecuteSearch").Enabled = Enabled Then Valore = Valore Or BTN_SEARCH
    If BarMenu.Bands("Band_Edit").Tools("Mnu_SearchPrevious").Enabled = Enabled Then Valore = Valore Or BTN_PREVIOUS
    If BarMenu.Bands("Band_Edit").Tools("Mnu_SearchNext").Enabled = Enabled Then Valore = Valore Or BTN_NEXT

    If BarMenu.Bands("Band_View").Tools("Mnu_ToolBar").Enabled = Enabled Then Valore = Valore Or BTN_TOOLS
    If BarMenu.Bands("Band_View").Tools("Mnu_FormView").Enabled = Enabled Then Valore = Valore Or BTN_SEARCHFORM
    If BarMenu.Bands("Band_View").Tools("Mnu_TableView").Enabled = Enabled Then Valore = Valore Or BTN_SEARCHTABLE

    If BarMenu.Bands("Band_Tools").Tools("Mnu_Export").Enabled = Enabled Then Valore = Valore Or BTN_EXPORT
    If BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportWord").Enabled = Enabled Then Valore = Valore Or BTN_WORD
    If BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportExcel").Enabled = Enabled Then Valore = Valore Or BTN_EXCEL
    If BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportHtml").Enabled = Enabled Then Valore = Valore Or BTN_HTML
    If BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportPDF").Enabled = Enabled Then Valore = Valore Or BTN_PDF

    GetStatusToolBar = Valore
End Function


'**+
'Nome: ReadRegistrySettings
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Legge i valori registrati nel registry relativi allo stato
'dei controlli del Form
'
'
'**/
Private Sub ReadRegistrySettings()
    Dim Index As Integer
    Dim FormHeight As Single
    Dim FormWidth As Single
    Dim NomeBanda As String
    Dim lngIDLanguage As Long
    Dim bFoldersVisible As Boolean
    Dim lValue As Long
           
           
    'Lettura file di help
    App.HelpFile = MenuOptions.ProgramsPath & "\Diamante.chm"
           
    ' Legge dal Registry le impostazioni sulla lingua
    lngIDLanguage = AppOptions.IDLanguage
           
    ' Modifica tutte le stringhe nel linguaggio corrente ( se <> da default )
    If lngIDLanguage <> NATIVE_LANGUAGE Then
        gResource.IDCurrentLanguage = lngIDLanguage
        'Setta i nuovi ToolTipText della Toolbar
        'e le Caption dei menu
        ChangeMenuLanguage
        ChangeToolBarLanguage
        'Traduce tutte le stringhe presenti sul form
        '(Solo se ChangeStringsLanguage è gestita dal programmatore !!!)
        ChangeStringsLanguage
    End If
    
    'Settaggio per la statusbar
    stbStatusbar.Visible = AppOptions.StatusBarVisibility
        
        
    '**+ settaggi per la barra degli strumenti
    With BarMenu
    
        '**+ E' necessario verificare la versione dell'activebar xchè nella nuova vesione 3.0
        'sono stati cambiati i valori di impostazione della proprietà DockingArea
        If AppOptions.BARMENUVERSION = BARMENUVERSION Then
    
            For Index = 0 To .Bands.Count - 1
            
                'Settaggi sulle toolbar (ancoraggio e dimensioni)
                If .Bands(Index).Type <> ddBTPopup Then
                    With .Bands(Index)
                        If AppOptions.ToolbarDockingArea(Index) > -1 Then
                            .DockingArea = AppOptions.ToolbarDockingArea(Index)
                            .DockLine = AppOptions.ToolbarDockLine(Index)
                            lValue = AppOptions.ToolbarHeight(Index)
                            If lValue > 0 Then .Height = lValue
                            lValue = AppOptions.ToolbarWidth(Index)
                            If lValue > 0 Then .Width = lValue
                            '**+ Attenzione le impostazioni del Left e Top devono essere effettuate dopo
                            'quelle dell'Height e del Width xchè se siamo in presenza di valori superiori
                            'a quelli della ClientArea azzera il left e top impostati in precedenza **/
                            lValue = AppOptions.ToolbarLeft(Index)
                            If lValue > 0 Then .Left = lValue
                            lValue = AppOptions.ToolbarTop(Index)
                            If lValue > 0 Then .Top = lValue
                            .DockingOffset = AppOptions.ToolbarDockingOffset(Index)
                        End If
                    End With
                End If
            
                'Settaggi sulla visibilità delle toolbar.
                If .Bands(Index).Type = ddBTNormal And .Bands(Index).Name <> BAND_CLOSE_PREVIEW Then
                     NomeBanda = .Bands(Index).Name
                     .Bands(NomeBanda).Visible = AppOptions.ToolbarVisibility(NomeBanda)
                End If
        
            Next Index
            
        End If
        
        'Settaggio sulla visualizzazione dei tooltip.
        .DisplayToolTips = AppOptions.DisplayTooltip
    End With
        
    
    'Dimensione delle icone della ToolBar
    SetToolBarIcons AppOptions.LargeIcon
    
    BarMenu.RecalcLayout
   
    bFoldersVisible = AppOptions.FoldersVisibility
   
    'Settaggi del riquadro attività
    ActivityBox.Visible = bFoldersVisible
    ActivityBox.Width = AppOptions.FoldersWidth
    BarMenu.Bands("Band_View").Tools("Mnu_Folders").Checked = bFoldersVisible
    m_DefaultActivity = AppOptions.DefaultActivity
    
    '**+ settaggi per la finestra principale del programma
    WindowState = AppOptions.WindowState
    If WindowState = 0 Then
        FormHeight = AppOptions.FormHeight
        If FormHeight <> -1 Then
            Height = FormHeight
        End If
        FormWidth = AppOptions.FormWidth
        If FormWidth <> -1 Then
            Width = FormWidth
        End If
    End If
End Sub

'**+
'Nome: SaveRegistrySettings
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Salva i valori relativi allo stato dei controlli del Form
'nel registry
'
'**/
Private Sub SaveRegistrySettings()
    Dim I As Integer

    '**+ Salva le impostazioni relative alle toolbar
    With AppOptions
        
        For I = 0 To BarMenu.Bands.Count - 1
            If BarMenu.Bands(I).Type <> ddBTPopup Then
                    .ToolbarDockingArea(I) = BarMenu.Bands(I).DockingArea
                    .ToolbarDockLine(I) = BarMenu.Bands(I).DockLine
                    .ToolbarLeft(I) = BarMenu.Bands(I).Left
                    .ToolbarTop(I) = BarMenu.Bands(I).Top
                    .ToolbarHeight(I) = BarMenu.Bands(I).Height
                    .ToolbarWidth(I) = BarMenu.Bands(I).Width
                    .ToolbarDockingOffset(I) = BarMenu.Bands(I).DockingOffset
            End If
        Next I
        .BARMENUVERSION = BARMENUVERSION
        
        'Salva le impostazioni relative alla finestra principale.
        If WindowState <> vbMinimized Then
            .FormHeight = Height
            .FormWidth = Width
            .WindowState = WindowState
        End If
        
        'Salva le impostazioni del riquadro attività
        .FoldersWidth = ActivityBox.Width
        .FoldersVisibility = ActivityBox.Visible
        .DefaultActivity = ActivityBox.CurrentActivityKey
    End With
End Sub

'**+
'Nome: ChangeView
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Cambia modalità di visualizzazione dei dati tra Form e vista tabellare
'
'**/
Private Sub ChangeView(Optional ByVal sToolName As Variant)

    'Se non vi sono record presenti nel browser
    'la modalità di visualizzazione non cambia e si esce.
    If (m_Document.EOF = True And m_Document.BOF = True) Then Exit Sub

    'Se si proviene dalla modalità tabellare
    '( o dalla modalità filtro provenendo dalla modalità tabellare )
    'potrebbe essere necessario allineare il documento con l'ultima selezione fatta nella browse.
    If BrwMain.Visible = True Then
        If BrwMain.ListIndex > 0 Then
            m_Document.Move BrwMain.ListIndex - 1
        End If
    End If
    

    If IsMissing(sToolName) Then sToolName = "ChangeView"

    'Cambia la visibiltà del browser
    If sToolName = "ChangeView" Then
        BrwMain.Visible = IIf(BrwMain.Visible And BrwMain.GuiMode = dgNormal, False, True)
    Else
        BrwMain.Visible = IIf((sToolName = "Mnu_FormView"), False, True)
    End If
    
    'Se si va in modalità form ed il record è bloccato si torna in modalità tabellare
    'impedendo di effettuare modifiche su quel record.
    'Quando si va in modalità tabellare il controllo non è necessario.
    If Not BrwMain.Visible Then

        If Not m_Semaphore.IsActionAvailable(m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions) Then
            'Il record è bloccato - si va in modalità tabellare
            
            BrwMain.Visible = True

            'Input Focus al browser
            'BrwMain.SetFocus
            
            'Refresh dello stato dei bottoni della ToolBar standard e dei menu
            SetStatus4Modality Browse

            Exit Sub
        Else
            m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
            m_Semaphore.SetObjectAction m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions
        End If

    End If
    
    
    
    'Se si era in fase di immissione di un nuovo record viene annullata
    m_Document.AbortNew
    
    If BrwMain.Visible Then 'Modalità tabellare
        
        'Input Focus al browser
        'BrwMain.SetFocus
        
        'Refresh dello stato dei bottoni della ToolBar standard e dei menu
        SetStatus4Modality Browse
        
    Else 'Modalità form
        
        'Refresh dello stato dei bottoni della ToolBar standard e dei menu
        SetStatus4Modality Modify
        
        'Input Focus al primo campo del form
        SetFocusTabIndex0
    End If
       
    'Imposta i suggerimenti da visualizzare sulla Statusbar in funzione
    'della modalità di visualizzazione corrente.
    'Ad esempio in alcuni casi le frasi sono al Singolare/Plurare.
    'La funzione GetDescription4StatusBar si occupa di determinare la frase esatta.
    'La Sub RefreshDescriptions4StatusBar deve essere chiamata anche in Execute_Search()--> Vedi.
    RefreshDescriptions4StatusBar
End Sub

'**+
'Nome: InitMenuBar
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Inizializzazione della MenuBar
'
'**/
Private Sub InitMenuBar(ByRef ToolID As Integer)
    BarMenu.Bands.Add "Band_Menu"
    BarMenu.Bands("Band_Menu").WrapTools = True
    BarMenu.Bands("Band_Menu").Type = ddBTMenuBar
    BarMenu.Bands("Band_Menu").DockLine = 1
    BarMenu.Bands("Band_Menu").Flags = ddBFDockTop Or ddBFDockLeft Or ddBFFloat Or ddBFDockRight Or ddBFDockBottom
    BarMenu.Bands("Band_Menu").GrabHandleStyle = ddGSNormal

    'File
    BarMenu.Bands.Add "Band_File"
    BarMenu.Bands("Band_File").Type = ddBTPopup
    BarMenu.Bands("Band_File").DockingArea = ddDATop
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Menu").Tools.Add ToolID, "File"
    BarMenu.Bands("Band_Menu").Tools("File").SubBand = "Band_File"
    BarMenu.Bands("Band_Menu").Tools("File").Caption = GetCaption4MenuBar("File")
    BarMenu.Bands("Band_Menu").Tools("File").Description = GetDescription4StatusBar("File")

    'File-New
    ToolID = ToolID + 1
    BarMenu.Bands("Band_File").Tools.Add ToolID, "Mnu_New"
    BarMenu.Bands("Band_File").Tools("Mnu_New").SetPicture 0, gResource.GetBitmap(IDB_STD_NEW16), &HC0C0C0
    BarMenu.Bands("Band_File").Tools("Mnu_New").Caption = GetCaption4MenuBar("Mnu_New")
    BarMenu.Bands("Band_File").Tools("Mnu_New").Description = GetDescription4StatusBar("Mnu_New")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Band_File").Tools.Add ToolID, "SepMnu_Save"
    BarMenu.Bands("Band_File").Tools("SepMnu_Save").ControlType = ddTTSeparator
    
    'File-Save
    ToolID = ToolID + 1
    BarMenu.Bands("Band_File").Tools.Add ToolID, "Mnu_Save"
    BarMenu.Bands("Band_File").Tools("Mnu_Save").SetPicture 0, gResource.GetBitmap(IDB_STD_SAVE16), &HC0C0C0
    If m_App.Language <> 1 Then
        BarMenu.Bands("Band_File").Tools("Mnu_Save").Caption = GetCaption4MenuBar("Mnu_Save")
    Else
        BarMenu.Bands("Band_File").Tools("Mnu_Save").Caption = GetCaption4MenuBar("Mnu_Save")
    End If
    BarMenu.Bands("Band_File").Tools("Mnu_Save").Description = GetDescription4StatusBar("Mnu_Save")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Band_File").Tools.Add ToolID, "SepMnu_PrePrint"
    BarMenu.Bands("Band_File").Tools("SepMnu_PrePrint").ControlType = ddTTSeparator
    
    'File-PrePrint
    ToolID = ToolID + 1
    BarMenu.Bands("Band_File").Tools.Add ToolID, "Mnu_PrePrint"
    BarMenu.Bands("Band_File").Tools("Mnu_PrePrint").SetPicture 0, gResource.GetBitmap(IDB_STD_PREVIEW16), &HC0C0C0
    BarMenu.Bands("Band_File").Tools("Mnu_PrePrint").Caption = GetCaption4MenuBar("Mnu_PrePrint")
    BarMenu.Bands("Band_File").Tools("Mnu_PrePrint").Description = GetDescription4StatusBar("Mnu_PrePrint")
    
    'File-Print
    ToolID = ToolID + 1
    BarMenu.Bands("Band_File").Tools.Add ToolID, "Mnu_Print"
    BarMenu.Bands("Band_File").Tools("Mnu_Print").SetPicture 0, gResource.GetBitmap(IDB_STD_PRINT16), &HC0C0C0
    If m_App.Language <> 1 Then
        BarMenu.Bands("Band_File").Tools("Mnu_Print").Caption = GetCaption4MenuBar("Mnu_Print")
    Else
        BarMenu.Bands("Band_File").Tools("Mnu_Print").Caption = GetCaption4MenuBar("Mnu_Print")
    End If
    BarMenu.Bands("Band_File").Tools("Mnu_Print").Description = GetDescription4StatusBar("Mnu_Print")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Band_File").Tools.Add ToolID, "SepMnu_Exit"
    BarMenu.Bands("Band_File").Tools("SepMnu_Exit").ControlType = ddTTSeparator
    
    'File-Exit
    ToolID = ToolID + 1
    BarMenu.Bands("Band_File").Tools.Add ToolID, "Mnu_Exit"
    BarMenu.Bands("Band_File").Tools("Mnu_Exit").Caption = GetCaption4MenuBar("Mnu_Exit")
    BarMenu.Bands("Band_File").Tools("Mnu_Exit").Description = GetDescription4StatusBar("Mnu_Exit")
    
    'Edit
    BarMenu.Bands.Add "Band_Edit"
    BarMenu.Bands("Band_Edit").Type = ddBTPopup
    BarMenu.Bands("Band_Edit").DockingArea = ddDATop
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Menu").Tools.Add ToolID, "Edit"
    BarMenu.Bands("Band_Menu").Tools("Edit").SubBand = "Band_Edit"
    BarMenu.Bands("Band_Menu").Tools("Edit").Caption = GetCaption4MenuBar("Edit")
    BarMenu.Bands("Band_Menu").Tools("Edit").Description = GetDescription4StatusBar("Edit")
    
    'Edit-Delete
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "Mnu_Delete"
    BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").SetPicture 0, gResource.GetBitmap(IDB_STD_DELETE16), &HC0C0C0
    BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").Caption = GetCaption4MenuBar("Mnu_Delete")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").Description = GetDescription4StatusBar("Mnu_Delete")
    
    'Edit-Clear
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "Mnu_Clear"
    BarMenu.Bands("Band_Edit").Tools("Mnu_Clear").SetPicture 0, gResource.GetBitmap(IDB_STD_CLEAR16), &HC0C0C0
    BarMenu.Bands("Band_Edit").Tools("Mnu_Clear").Caption = GetCaption4MenuBar("Mnu_Clear")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Clear").Description = GetDescription4StatusBar("Mnu_Clear")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "SepMnu_Cut"
    BarMenu.Bands("Band_Edit").Tools("SepMnu_Cut").ControlType = ddTTSeparator
    
    'Edit-Cut
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "Mnu_Cut"
    BarMenu.Bands("Band_Edit").Tools("Mnu_Cut").SetPicture 0, gResource.GetBitmap(IDB_STD_CUT16), &HC0C0C0
    BarMenu.Bands("Band_Edit").Tools("Mnu_Cut").Caption = GetCaption4MenuBar("Mnu_Cut")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Cut").Description = GetDescription4StatusBar("Mnu_Cut")
    
    'Edit-Copy
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "Mnu_Copy"
    BarMenu.Bands("Band_Edit").Tools("Mnu_Copy").SetPicture 0, gResource.GetBitmap(IDB_STD_COPY16), &HC0C0C0
    BarMenu.Bands("Band_Edit").Tools("Mnu_Copy").Caption = GetCaption4MenuBar("Mnu_Copy")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Copy").Description = GetDescription4StatusBar("Mnu_Copy")
    
    'Edit-Paste
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "Mnu_Paste"
    BarMenu.Bands("Band_Edit").Tools("Mnu_Paste").SetPicture 0, gResource.GetBitmap(IDB_STD_PASTE16), &HC0C0C0
    BarMenu.Bands("Band_Edit").Tools("Mnu_Paste").Caption = GetCaption4MenuBar("Mnu_Paste")
    BarMenu.Bands("Band_Edit").Tools("Mnu_Paste").Description = GetDescription4StatusBar("Mnu_Paste")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "SepMnu_NewSearch"
    BarMenu.Bands("Band_Edit").Tools("SepMnu_NewSearch").ControlType = ddTTSeparator
    
    'Edit-NewSearch
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "Mnu_NewSearch"
    BarMenu.Bands("Band_Edit").Tools("Mnu_NewSearch").SetPicture 0, gResource.GetBitmap(IDB_STD_FIND16), &HC0C0C0
    BarMenu.Bands("Band_Edit").Tools("Mnu_NewSearch").Caption = GetCaption4MenuBar("Mnu_NewSearch")
    BarMenu.Bands("Band_Edit").Tools("Mnu_NewSearch").Description = GetDescription4StatusBar("Mnu_NewSearch")
    
    'Edit-ExecuteSearch
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "Mnu_ExecuteSearch"
    BarMenu.Bands("Band_Edit").Tools("Mnu_ExecuteSearch").SetPicture 0, gResource.GetBitmap(IDB_STD_EXECUTE16), &HC0C0C0
    BarMenu.Bands("Band_Edit").Tools("Mnu_ExecuteSearch").Caption = GetCaption4MenuBar("Mnu_ExecuteSearch")
    BarMenu.Bands("Band_Edit").Tools("Mnu_ExecuteSearch").Description = GetDescription4StatusBar("Mnu_ExecuteSearch")
    
    'Edit-SearchPrevious
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "Mnu_SearchPrevious"
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchPrevious").SetPicture 0, gResource.GetBitmap(IDB_STD_PREVIOUS16), &HC0C0C0
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchPrevious").Caption = GetCaption4MenuBar("Mnu_SearchPrevious")
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchPrevious").Description = GetDescription4StatusBar("Mnu_SearchPrevious")
    
    'Edit-SearchNext
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Edit").Tools.Add ToolID, "Mnu_SearchNext"
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchNext").SetPicture 0, gResource.GetBitmap(IDB_STD_NEXT16), &HC0C0C0
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchNext").Caption = GetCaption4MenuBar("Mnu_SearchNext")
    BarMenu.Bands("Band_Edit").Tools("Mnu_SearchNext").Description = GetDescription4StatusBar("Mnu_SearchNext")
    
    'View
    BarMenu.Bands.Add "Band_View"
    BarMenu.Bands("Band_View").Type = ddBTPopup
    BarMenu.Bands("Band_View").DockingArea = ddDATop
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Menu").Tools.Add ToolID, "View"
    BarMenu.Bands("Band_Menu").Tools("View").SubBand = "Band_View"
    BarMenu.Bands("Band_Menu").Tools("View").Caption = GetCaption4MenuBar("View")
    BarMenu.Bands("Band_Menu").Tools("View").Description = GetDescription4StatusBar("View")
    
    'View-FormView
    ToolID = ToolID + 1
    BarMenu.Bands("Band_View").Tools.Add ToolID, "Mnu_FormView"
    BarMenu.Bands("Band_View").Tools("Mnu_FormView").SetPicture 0, gResource.GetBitmap(IDB_STD_FORM16), &HC0C0C0
    BarMenu.Bands("Band_View").Tools("Mnu_FormView").Caption = GetCaption4MenuBar("Mnu_FormView")
    BarMenu.Bands("Band_View").Tools("Mnu_FormView").Description = GetDescription4StatusBar("Mnu_FormView")
    
    'View-TableView
    ToolID = ToolID + 1
    BarMenu.Bands("Band_View").Tools.Add ToolID, "Mnu_TableView"
    BarMenu.Bands("Band_View").Tools("Mnu_TableView").SetPicture 0, gResource.GetBitmap(IDB_STD_GRID16), &HC0C0C0
    BarMenu.Bands("Band_View").Tools("Mnu_TableView").Caption = GetCaption4MenuBar("Mnu_TableView")
    BarMenu.Bands("Band_View").Tools("Mnu_TableView").Description = GetDescription4StatusBar("Mnu_TableView")
    
    'View - SearchFilter
    ToolID = ToolID + 1
    BarMenu.Bands("Band_View").Tools.Add ToolID, "Mnu_SearchFilter"
    BarMenu.Bands("Band_View").Tools("Mnu_SearchFilter").SetPicture 0, gResource.GetBitmap(IDB_FILTRO16), &HC0C0C0
    BarMenu.Bands("Band_View").Tools("Mnu_SearchFilter").Caption = GetCaption4MenuBar("Mnu_SearchFilter")
    BarMenu.Bands("Band_View").Tools("Mnu_SearchFilter").Description = GetDescription4StatusBar("Mnu_SearchFilter")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Band_View").Tools.Add ToolID, "SepMnu_Folders"
    BarMenu.Bands("Band_View").Tools("SepMnu_Folders").ControlType = ddTTSeparator
    
    'View-Folders
    ToolID = ToolID + 1
    BarMenu.Bands("Band_View").Tools.Add ToolID, "Mnu_Folders"
    BarMenu.Bands("Band_View").Tools("Mnu_Folders").Caption = GetCaption4MenuBar("Mnu_Folders")
    BarMenu.Bands("Band_View").Tools("Mnu_Folders").Description = GetDescription4StatusBar("Mnu_Folders")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Band_View").Tools.Add ToolID, "SepMnu_ToolBar"
    BarMenu.Bands("Band_View").Tools("SepMnu_ToolBar").ControlType = ddTTSeparator
    
    'View-ToolBar
    ToolID = ToolID + 1
    BarMenu.Bands("Band_View").Tools.Add ToolID, "Mnu_ToolBar"
    BarMenu.Bands("Band_View").Tools("Mnu_ToolBar").Caption = GetCaption4MenuBar("Mnu_ToolBar")
    BarMenu.Bands("Band_View").Tools("Mnu_ToolBar").Description = GetDescription4StatusBar("Mnu_ToolBar")
    
    'Tools
    BarMenu.Bands.Add "Band_Tools"
    BarMenu.Bands("Band_Tools").Type = ddBTPopup
    BarMenu.Bands("Band_Tools").DockingArea = ddDATop
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Menu").Tools.Add ToolID, "Tools"
    BarMenu.Bands("Band_Menu").Tools("Tools").SubBand = "Band_Tools"
    BarMenu.Bands("Band_Menu").Tools("Tools").Caption = GetCaption4MenuBar("Tools")
    BarMenu.Bands("Band_Menu").Tools("Tools").Description = GetDescription4StatusBar("Tools")
    
    'Tools-Export
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Tools").Tools.Add ToolID, "Mnu_Export"
    BarMenu.Bands("Band_Tools").Tools("Mnu_Export").ControlType = ddTTLabel
    BarMenu.Bands("Band_Tools").Tools("Mnu_Export").SubBand = "Mnu_Band_Export"
    BarMenu.Bands("Band_Tools").Tools("Mnu_Export").Caption = GetCaption4MenuBar("Mnu_Export")
    BarMenu.Bands("Band_Tools").Tools("Mnu_Export").Description = GetDescription4StatusBar("Mnu_Export")
    
    'Tools-Options
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Tools").Tools.Add ToolID, "Mnu_Options"
    BarMenu.Bands("Band_Tools").Tools("Mnu_Options").Caption = GetCaption4MenuBar("Mnu_Options")
    BarMenu.Bands("Band_Tools").Tools("Mnu_Options").Description = GetDescription4StatusBar("Mnu_Options")
    
    'Tools-Export
    BarMenu.Bands.Add "Mnu_Band_Export"
    BarMenu.Bands("Mnu_Band_Export").Type = ddBTPopup
    BarMenu.Bands("Mnu_Band_Export").DockingArea = ddDAPopup
    
    'Tools-Export-ExportPDF
    ToolID = ToolID + 1
    BarMenu.Bands("Mnu_Band_Export").Tools.Add ToolID, "Mnu_ExportPDF"
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportPDF").SetPicture 0, gResource.GetBitmap(IDB_ACROBAT_16), &HC0C0C0
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportPDF").Caption = GetCaption4MenuBar("Mnu_ExportPDF")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportPDF").Description = GetDescription4StatusBar("Mnu_ExportPDF")
    
    'Tools-Export-ExportWord
    ToolID = ToolID + 1
    BarMenu.Bands("Mnu_Band_Export").Tools.Add ToolID, "Mnu_ExportWord"
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportWord").SetPicture 0, gResource.GetBitmap(IDB_STD_WORD16), &HC0C0C0
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportWord").Caption = GetCaption4MenuBar("Mnu_ExportWord")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportWord").Description = GetDescription4StatusBar("Mnu_ExportWord")
    
    'Tools-Export-ExportExcel
    ToolID = ToolID + 1
    BarMenu.Bands("Mnu_Band_Export").Tools.Add ToolID, "Mnu_ExportExcel"
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportExcel").SetPicture 0, gResource.GetBitmap(IDB_STD_EXCEL16), &HC0C0C0
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportExcel").Caption = GetCaption4MenuBar("Mnu_ExportExcel")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportExcel").Description = GetDescription4StatusBar("Mnu_ExportExcel")
    
    'Tools-Export-ExportHtml
    ToolID = ToolID + 1
    BarMenu.Bands("Mnu_Band_Export").Tools.Add ToolID, "Mnu_ExportHtml"
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportHtml").SetPicture 0, gResource.GetBitmap(IDB_STD_HTML16), &HC0C0C0
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportHtml").Caption = GetCaption4MenuBar("Mnu_ExportHtml")
    BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportHtml").Description = GetDescription4StatusBar("Mnu_ExportHtml")

    'Help
    BarMenu.Bands.Add "Band_Help"
    BarMenu.Bands("Band_Help").Type = ddBTPopup
    BarMenu.Bands("Band_Help").DockingArea = ddDATop
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Menu").Tools.Add ToolID, "Help"
    BarMenu.Bands("Band_Menu").Tools("Help").Caption = GetCaption4MenuBar("Help")
    BarMenu.Bands("Band_Menu").Tools("Help").Description = GetDescription4StatusBar("Help")
    BarMenu.Bands("Band_Menu").Tools("Help").SubBand = "Band_Help"
    
    'Help-HelpOnLine
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Help").Tools.Add ToolID, "Mnu_HelpOnLine"
    BarMenu.Bands("Band_Help").Tools("Mnu_HelpOnLine").Caption = GetCaption4MenuBar("Mnu_HelpOnLine")
    BarMenu.Bands("Band_Help").Tools("Mnu_HelpOnLine").Description = GetDescription4StatusBar("Mnu_HelpOnLine")
    
    'Help-Arg
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Help").Tools.Add ToolID, "Mnu_Arg"
    BarMenu.Bands("Band_Help").Tools("Mnu_Arg").Caption = GetCaption4MenuBar("Mnu_Arg")
    BarMenu.Bands("Band_Help").Tools("Mnu_Arg").Description = GetDescription4StatusBar("Mnu_Arg")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Help").Tools.Add ToolID, "SepMnu_Web"
    BarMenu.Bands("Band_Help").Tools("SepMnu_Web").ControlType = ddTTSeparator
    
    'Help-Web
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Help").Tools.Add ToolID, "Mnu_Web"
    BarMenu.Bands("Band_Help").Tools("Mnu_Web").SetPicture 0, gResource.GetBitmap(IDB_DMT_WEB16), &HC0C0C0
    BarMenu.Bands("Band_Help").Tools("Mnu_Web").Caption = GetCaption4MenuBar("Mnu_Web")
    BarMenu.Bands("Band_Help").Tools("Mnu_Web").Description = GetDescription4StatusBar("Mnu_Web")
    
    'Help-Blog
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Help").Tools.Add ToolID, "Mnu_Agg_Web"
    BarMenu.Bands("Band_Help").Tools("Mnu_Agg_Web").SetPicture 0, gResource.GetBitmap(IDB_AGG_WEB16), &HC0C0C0
    BarMenu.Bands("Band_Help").Tools("Mnu_Agg_Web").Caption = GetCaption4MenuBar("Mnu_Agg_Web")
    BarMenu.Bands("Band_Help").Tools("Mnu_Agg_Web").Description = GetDescription4StatusBar("Mnu_Agg_Web")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Help").Tools.Add ToolID, "SepMnu_Info"
    BarMenu.Bands("Band_Help").Tools("SepMnu_Info").ControlType = ddTTSeparator
    
    'Help-Info
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Help").Tools.Add ToolID, "Mnu_Info"
    BarMenu.Bands("Band_Help").Tools("Mnu_Info").Caption = GetCaption4MenuBar("Mnu_Info")
    BarMenu.Bands("Band_Help").Tools("Mnu_Info").Description = GetDescription4StatusBar("Mnu_Info")
    
    'PopUp
    BarMenu.Bands.Add "Band_PopUp"
    BarMenu.Bands("Band_PopUp").Type = ddBTPopup
    BarMenu.Bands("Band_PopUp").DockingArea = ddDAPopup
    
    'PopUp-RunApplication
    ToolID = ToolID + 1
    BarMenu.Bands("Band_PopUp").Tools.Add ToolID, "Mnu_RunApplication"
    BarMenu.Bands("Band_PopUp").Tools("Mnu_RunApplication").Caption = GetCaption4MenuBar("Mnu_RunApplication")
    
    'PopUp-SearchObject
    ToolID = ToolID + 1
    BarMenu.Bands("Band_PopUp").Tools.Add ToolID, "Mnu_SearchObject"
    BarMenu.Bands("Band_PopUp").Tools("Mnu_SearchObject").Caption = GetCaption4MenuBar("Mnu_SearchObject")
    
    BarMenu.RecalcLayout
End Sub

'**+
'Nome: InitToolBar
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Inizializzazione della ToolBar
'
'**/
Private Sub InitToolBar(ByRef ToolID As Integer)


    BarMenu.Bands.Add "Standard"
    BarMenu.Bands("Standard").DockLine = 2
    BarMenu.Bands("Standard").Type = ddBTNormal
    BarMenu.Bands("Standard").Flags = ddBFDockTop Or ddBFDockLeft Or ddBFFloat Or ddBFDockRight Or ddBFDockBottom
    BarMenu.Bands("Standard").GrabHandleStyle = ddGSNormal
    BarMenu.Bands.Add BAND_CLOSE_PREVIEW
    BarMenu.Bands(BAND_CLOSE_PREVIEW).DockLine = 2
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Type = ddBTMenuBar
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Caption = "Chiudi"
    BarMenu.Bands(BAND_CLOSE_PREVIEW).DockingArea = ddDATop
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Visible = False

    'New
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "New"
    BarMenu.Bands("Standard").Tools("New").ToolTipText = GetToolTipText4ToolBar("New")
    BarMenu.Bands("Standard").Tools("New").Description = GetDescription4StatusBar("New")
    
    'Save
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Save"
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Sep2"
    BarMenu.Bands("Standard").Tools("Sep2").ControlType = ddTTSeparator
    BarMenu.Bands("Standard").Tools("Save").ToolTipText = GetToolTipText4ToolBar("Save")
    BarMenu.Bands("Standard").Tools("Save").Description = GetDescription4StatusBar("Save")
    
    'Print
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Print"
    BarMenu.Bands("Standard").Tools("Print").ToolTipText = GetToolTipText4ToolBar("Print")
    BarMenu.Bands("Standard").Tools("Print").Description = GetDescription4StatusBar("Print")
    
    'PrePrint
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "PrePrint"
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Sep3"
    BarMenu.Bands("Standard").Tools("Sep3").ControlType = ddTTSeparator
    BarMenu.Bands("Standard").Tools("PrePrint").ToolTipText = GetToolTipText4ToolBar("PrePrint")
    BarMenu.Bands("Standard").Tools("PrePrint").Description = GetDescription4StatusBar("PrePrint")
    
    'Cut
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Cut"
    BarMenu.Bands("Standard").Tools("Cut").ToolTipText = GetToolTipText4ToolBar("Cut")
    BarMenu.Bands("Standard").Tools("Cut").Description = GetDescription4StatusBar("Cut")
    
    'Copy
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Copy"
    BarMenu.Bands("Standard").Tools("Copy").ToolTipText = GetToolTipText4ToolBar("Copy")
    BarMenu.Bands("Standard").Tools("Copy").Description = GetDescription4StatusBar("Copy")
    
    'Paste
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Paste"
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Sep"
    BarMenu.Bands("Standard").Tools("Sep").ControlType = ddTTSeparator
    BarMenu.Bands("Standard").Tools("Paste").ToolTipText = GetToolTipText4ToolBar("Paste")
    BarMenu.Bands("Standard").Tools("Paste").Description = GetDescription4StatusBar("Paste")
    
    'Delete
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Delete"
    BarMenu.Bands("Standard").Tools("Delete").ToolTipText = GetToolTipText4ToolBar("Delete")
    BarMenu.Bands("Standard").Tools("Delete").Description = GetDescription4StatusBar("Delete")
    
    'Clear
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Clear"
    BarMenu.Bands("Standard").Tools("Clear").ToolTipText = GetToolTipText4ToolBar("Clear")
    BarMenu.Bands("Standard").Tools("Clear").Description = GetDescription4StatusBar("Clear")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "SepNewSearch"
    BarMenu.Bands("Standard").Tools("SepNewSearch").ControlType = ddTTSeparator
    
    'NewSearch
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "NewSearch"
    BarMenu.Bands("Standard").Tools("NewSearch").ToolTipText = GetToolTipText4ToolBar("NewSearch")
    BarMenu.Bands("Standard").Tools("NewSearch").Description = GetDescription4StatusBar("NewSearch")
    
    'ExecuteSearch
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "ExecuteSearch"
    BarMenu.Bands("Standard").Tools("ExecuteSearch").ToolTipText = GetToolTipText4ToolBar("ExecuteSearch")
    BarMenu.Bands("Standard").Tools("ExecuteSearch").Description = GetDescription4StatusBar("ExecuteSearch")
    
    'ChangeView
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "ChangeView"
    BarMenu.Bands("Standard").Tools("ChangeView").ControlType = ddTTButtonDropDown
    BarMenu.Bands("Standard").Tools("ChangeView").SubBand = "Band_ChangeView"
    BarMenu.Bands("Standard").Tools("ChangeView").ToolTipText = GetToolTipText4ToolBar("ChangeView")
    BarMenu.Bands("Standard").Tools("ChangeView").Description = GetDescription4StatusBar("ChangeView")
    BarMenu.Bands.Add "Band_ChangeView"
    BarMenu.Bands("Band_ChangeView").Type = ddBTPopup
    BarMenu.Bands("Band_ChangeView").DockingArea = ddDATop
    
    'ChangeView - Form
    ToolID = ToolID + 1
    BarMenu.Bands("Band_ChangeView").Tools.Add ToolID, "Mnu_FormView"
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_FormView").SetPicture 0, gResource.GetBitmap(IDB_STD_FORM16), &HC0C0C0
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_FormView").Caption = GetCaption4MenuBar("Mnu_FormView")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_FormView").Description = GetDescription4StatusBar("Mnu_FormView")
    
    'ChangeView - Tabella
    ToolID = ToolID + 1
    BarMenu.Bands("Band_ChangeView").Tools.Add ToolID, "Mnu_TableView"
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_TableView").SetPicture 0, gResource.GetBitmap(IDB_STD_GRID16), &HC0C0C0
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_TableView").Caption = GetCaption4MenuBar("Mnu_TableView")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_TableView").Description = GetDescription4StatusBar("Mnu_TableView")
    
     'ChangeView - Filtro
    ToolID = ToolID + 1
    BarMenu.Bands("Band_ChangeView").Tools.Add ToolID, "Mnu_SearchFilter"
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_SearchFilter").SetPicture 0, gResource.GetBitmap(IDB_FILTRO16), &HC0C0C0
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_SearchFilter").Caption = GetCaption4MenuBar("Mnu_SearchFilter")
    BarMenu.Bands("Band_ChangeView").Tools("Mnu_SearchFilter").Description = GetDescription4StatusBar("Mnu_SearchFilter")
    
    'SearchPrevious
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "SearchPrevious"
    BarMenu.Bands("Standard").Tools("SearchPrevious").ToolTipText = GetToolTipText4ToolBar("SearchPrevious")
    BarMenu.Bands("Standard").Tools("SearchPrevious").Description = GetDescription4StatusBar("SearchPrevious")
    
    'SearchNext
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "SearchNext"
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Sep4"
    BarMenu.Bands("Standard").Tools("Sep4").ControlType = ddTTSeparator
    BarMenu.Bands("Standard").Tools("SearchNext").ToolTipText = GetToolTipText4ToolBar("SearchNext")
    BarMenu.Bands("Standard").Tools("SearchNext").Description = GetDescription4StatusBar("SearchNext")
        
    'Export
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Export"
    BarMenu.Bands("Standard").Tools("Export").ControlType = ddTTButtonDropDown
    BarMenu.Bands("Standard").Tools("Export").SubBand = "Band_Export"
    BarMenu.Bands("Standard").Tools("Export").ToolTipText = GetToolTipText4ToolBar("Export")
    BarMenu.Bands("Standard").Tools("Export").Description = GetDescription4StatusBar("Mnu_Export")
    BarMenu.Bands.Add "Band_Export"
    BarMenu.Bands("Band_Export").Type = ddBTPopup
    BarMenu.Bands("Band_Export").DockingArea = ddDATop
    
    'ExportPDF
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Export").Tools.Add ToolID, "ExportPDF"
    BarMenu.Bands("Band_Export").Tools("ExportPDF").Caption = GetCaption4MenuBar("Mnu_ExportPDF")
    BarMenu.Bands("Band_Export").Tools("ExportPDF").ToolTipText = GetToolTipText4ToolBar("ExportPDF")
    BarMenu.Bands("Band_Export").Tools("ExportPDF").Description = GetDescription4StatusBar("ExportPDF")
    
    'ExportWord
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Export").Tools.Add ToolID, "ExportWord"
    BarMenu.Bands("Band_Export").Tools("ExportWord").Caption = GetCaption4MenuBar("Mnu_ExportWord")
    BarMenu.Bands("Band_Export").Tools("ExportWord").ToolTipText = GetToolTipText4ToolBar("ExportWord")
    BarMenu.Bands("Band_Export").Tools("ExportWord").Description = GetDescription4StatusBar("ExportWord")
    
    'ExportExcel
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Export").Tools.Add ToolID, "ExportExcel"
    BarMenu.Bands("Band_Export").Tools("ExportExcel").Caption = GetCaption4MenuBar("Mnu_ExportExcel")
    BarMenu.Bands("Band_Export").Tools("ExportExcel").ToolTipText = GetToolTipText4ToolBar("ExportExcel")
    BarMenu.Bands("Band_Export").Tools("ExportExcel").Description = GetDescription4StatusBar("ExportExcel")
    
    'ExportHtml
    ToolID = ToolID + 1
    BarMenu.Bands("Band_Export").Tools.Add ToolID, "ExportHtml"
    BarMenu.Bands("Band_Export").Tools("ExportHtml").Caption = GetCaption4MenuBar("Mnu_ExportHtml")
    BarMenu.Bands("Band_Export").Tools("ExportHtml").ToolTipText = GetToolTipText4ToolBar("ExportHtml")
    BarMenu.Bands("Band_Export").Tools("ExportHtml").Description = GetDescription4StatusBar("ExportHtml")
    
    'Bottone chiusura anteprima
    ToolID = ToolID + 1
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Tools.Add ToolID, "ClosePreview"
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Tools("ClosePreview").Style = ddSText
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Tools("ClosePreview").Caption = "&Chiudi"
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Tools("ClosePreview").ToolTipText = "Chiudi anteprima"
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Tools("ClosePreview").Description = "Esci da modalità Anteprima di stampa"
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Tools("ClosePreview").ControlType = ddTTButton
    BarMenu.Bands(BAND_CLOSE_PREVIEW).Tools("ClosePreview").Visible = True
    
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Sep5"
    BarMenu.Bands("Standard").Tools("Sep5").ControlType = ddTTSeparator
    
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Web"
    BarMenu.Bands("Standard").Tools("Web").ToolTipText = GetToolTipText4ToolBar("Web")
    BarMenu.Bands("Standard").Tools("Web").Description = GetDescription4StatusBar("Web")
    
    ToolID = ToolID + 1
    BarMenu.Bands("Standard").Tools.Add ToolID, "Agg_Web"
    BarMenu.Bands("Standard").Tools("Agg_Web").ToolTipText = GetToolTipText4ToolBar("Agg_Web")
    BarMenu.Bands("Standard").Tools("Agg_Web").Description = GetDescription4StatusBar("Agg_Web")
    
    BarMenu.RecalcLayout
End Sub




'**+
'Nome: ChooseAboutSaving
'
'Parametri:
'Ritorna i valori vbYes, vbNo o vbCancel a seconda della risposta data
'
'Valori di ritorno:
'
'Funzionalità:
'Richiesta della registrazione di un record
'**/
Private Function ChooseAboutSaving() As Integer
    If m_Changed Then
        gResource.CustomStrings.Clear
        gResource.CustomStrings.Add Chr(34) & TheApp.FunctionName & Chr(34), 1

        ChooseAboutSaving = fnMsgQuestionWithCancel((gResource.GetCustomizedMessage(MESS_QUERYSAVE)), TheApp.FunctionName)
    End If
End Function

'**+
'Nome: ChooseAboutSavingOkCancel
'
'Parametri:
'
'Valori di ritorno:
'Ritorna i valori vbOK o vbCancel a seconda della risposta data
'
'Funzionalità:
'Come ChooseAboutSaving ma con pulsanti Ok e Annulla
'**/
Private Function ChooseAboutSavingOkCancel() As Integer
    Dim sRecord As String

    sRecord = IIf(m_Document.Fields(CAMPO_PER_CAPTION).Value <> Empty, m_Document.Fields(CAMPO_PER_CAPTION).Value, TheApp.FunctionName)
  
    gResource.CustomStrings.Clear
    gResource.CustomStrings.Add Chr(34) & sRecord & Chr(34), 1
    ChooseAboutSavingOkCancel = fnMsgQuestionOKCancel((gResource.GetCustomizedMessage(MESS_QUERYSAVE)), m_App.FunctionName)
    
End Function

'**+
'Nome: ActivateBarButtons
'
'Parametri:
'Buttons - Variabile lunga 8 byte con la combinazione
'della maschera di bit che indica di quali bottoni cambiare
'lo stato di abilitazione
'Enable - Valore booleano che indica lo stato di abilitazione
'da applicare
'
'Valori di ritorno:
'
'Funzionalità:
'Abilita o meno gruppi di bottoni e voci di menu
'**/
Private Sub ActivateBarButtons(ByVal Buttons As Currency, ByVal Enable As Boolean)

    'Pulsanti della Toolbar
    '----------------------
    If (Buttons And BTN_NEW) Then BarMenu.Bands("Standard").Tools("New").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_SAVE) Then BarMenu.Bands("Standard").Tools("Save").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_PRINT) Then BarMenu.Bands("Standard").Tools("Print").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_PREVIEW) Then BarMenu.Bands("Standard").Tools("PrePrint").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_CUT) Then BarMenu.Bands("Standard").Tools("Cut").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_COPY) Then BarMenu.Bands("Standard").Tools("Copy").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_PASTE) Then BarMenu.Bands("Standard").Tools("Paste").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_DELETE) Then BarMenu.Bands("Standard").Tools("Delete").Enabled = CheckRights("Cancellazione", Enable)
    If (Buttons And BTN_CLEAR) Then BarMenu.Bands("Standard").Tools("Clear").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_FIND) Then BarMenu.Bands("Standard").Tools("NewSearch").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_SEARCH) Then BarMenu.Bands("Standard").Tools("ExecuteSearch").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_VIEWMODE) Then BarMenu.Bands("Standard").Tools("ChangeView").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_PREVIOUS) Then BarMenu.Bands("Standard").Tools("SearchPrevious").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_NEXT) Then BarMenu.Bands("Standard").Tools("SearchNext").Enabled = CheckRights("Selezione", Enable)
    If Not oExportActivity Is Nothing Then
        If (Buttons And BTN_EXPORT) Then oExportActivity.EnableItems CheckRights("Stampa", Enable)
    End If
    If (Buttons And BTN_EXPORT) Then BarMenu.Bands("Standard").Tools("Export").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_WORD) Then BarMenu.Bands("Band_Export").Tools("ExportWord").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_EXCEL) Then BarMenu.Bands("Band_Export").Tools("ExportExcel").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_HTML) Then BarMenu.Bands("Band_Export").Tools("ExportHtml").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_PDF) Then BarMenu.Bands("Band_Export").Tools("ExportPDF").Enabled = CheckRights("Stampa", Enable)
    
    If (Buttons And BTN_SEARCHFORM) Then
        BarMenu.Bands("Band_ChangeView").Tools("Mnu_FormView").Enabled = CheckRights("Selezione", Enable)
        BarMenu.Bands("Band_ChangeView").Tools("Mnu_FormView").Checked = Not Enable
    End If
    
    If (Buttons And BTN_SEARCHTABLE) Then
        BarMenu.Bands("Band_ChangeView").Tools("Mnu_TableView").Enabled = CheckRights("Selezione", Enable)
        BarMenu.Bands("Band_ChangeView").Tools("Mnu_TableView").Checked = Not Enable
    End If
    
    If (Buttons And BTN_FILTER) Then BarMenu.Bands("Band_ChangeView").Tools("Mnu_SearchFilter").Enabled = CheckRights("Selezione", Enable)
    
    'VOCI DI MENU
    '------------
    
    'Menu File
    '---------
    If (Buttons And BTN_NEW) Then BarMenu.Bands("Band_File").Tools("Mnu_New").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_SAVE) Then BarMenu.Bands("Band_File").Tools("Mnu_Save").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_PRINT) Then BarMenu.Bands("Band_File").Tools("Mnu_Print").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_PREVIEW) Then BarMenu.Bands("Band_File").Tools("Mnu_PrePrint").Enabled = CheckRights("Stampa", Enable)
    
    'Menu Edit
    '---------
    If (Buttons And BTN_CUT) Then BarMenu.Bands("Band_Edit").Tools("Mnu_Cut").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_COPY) Then BarMenu.Bands("Band_Edit").Tools("Mnu_Copy").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_PASTE) Then BarMenu.Bands("Band_Edit").Tools("Mnu_Paste").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_DELETE) Then BarMenu.Bands("Band_Edit").Tools("Mnu_Delete").Enabled = CheckRights("Cancellazione", Enable)
    If (Buttons And BTN_CLEAR) Then BarMenu.Bands("Band_Edit").Tools("Mnu_Clear").Enabled = CheckRights("Modifica", Enable)
    If (Buttons And BTN_FIND) Then BarMenu.Bands("Band_Edit").Tools("Mnu_NewSearch").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_SEARCH) Then BarMenu.Bands("Band_Edit").Tools("Mnu_ExecuteSearch").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_PREVIOUS) Then BarMenu.Bands("Band_Edit").Tools("Mnu_SearchPrevious").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_NEXT) Then BarMenu.Bands("Band_Edit").Tools("Mnu_SearchNext").Enabled = CheckRights("Selezione", Enable)
    
    'Menu Visualizza
    '---------------
    If (Buttons And BTN_FILTER) Then BarMenu.Bands("Band_View").Tools("Mnu_SearchFilter").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_SEARCHFORM) Then BarMenu.Bands("Band_View").Tools("Mnu_FormView").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_SEARCHTABLE) Then BarMenu.Bands("Band_View").Tools("Mnu_TableView").Enabled = CheckRights("Selezione", Enable)
    If (Buttons And BTN_VIEWMODE) Then
        BarMenu.Bands("Band_View").Tools("Mnu_FormView").Enabled = CheckRights("Selezione", Enable)
    End If

    'Menu Export
    '-----------
    If Not oExportActivity Is Nothing Then
        If (Buttons And BTN_EXPORT) Then oExportActivity.EnableItems CheckRights("Stampa", Enable)
    End If
    If (Buttons And BTN_EXPORT) Then BarMenu.Bands("Band_Tools").Tools("Mnu_Export").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_WORD) Then BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportWord").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_EXCEL) Then BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportExcel").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_HTML) Then BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportHtml").Enabled = CheckRights("Stampa", Enable)
    If (Buttons And BTN_PDF) Then BarMenu.Bands("Mnu_Band_Export").Tools("Mnu_ExportPDF").Enabled = CheckRights("Stampa", Enable)
End Sub


'**+
'Nome: NewSearch
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni da compiere in caso di richiesta di una nuova ricerca
'**/
Private Sub NewSearch()

    'Refresh dello stato del Form
    m_Changed = False
    m_Saved = False
    m_Search = True
    
    'Annulla una eventuale operazione di inserimento di un nuovo record
    If m_Document.TableNew Then
        m_Document.AbortNew
        RefreshFormFields
    End If
    
    BrwMain.Conditions.Item("CodiceLotto").FromValue = ""
    
    'Ripristina la vista del Form
    BrwMain.Visible = True
    
    'Predispone la modalità DefineFilter della Browse
    BrwMain.AbortFilterEdit = False
    BrwMain.GuiMode = dgFilterDefinition
    BrwMain.SetFocus
    
    'Refresh dello stato dei bottoni delle barre dei menu per la modalità ricerca
    SetStatus4Modality Find
    
End Sub

'**+
'Nome: ExecuteSearch
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Esegue la ricerca impostata.
'
'**/
Private Sub ExecuteSearch()
On Error GoTo ERR_ExecuteSearch
    Dim Cond As DmtGridCtl.dgCondition
    Dim Field As DmtDocManLib.Field
    Dim OLDCursor As Integer
    Dim sWhere As String
    
    
    'Gestione della clessidra
    OLDCursor = Screen.MousePointer
    Screen.MousePointer = vbHourglass
    
    
    'Se non è stato selezionato nessun filtro dal controllo DocTypeExplorer
    'viene creato un filtro temporaneo in memoria e reso il filtro attivo
    If Not m_FilterSelected Then
        
        'Comunica all'oggetto DocType i valori da usare per la ricerca
        sWhere = fnFillDocTypeCondition
        
        'Rimuove il filtro precedente
        m_DocType.RemoveFilter "Temp"
        
        'Crea un nuovo filtro temporaneo a partire dalle condizioni di ricerca
        'e viene reso filtro attivo
        Set m_ActiveFilter = m_DocType.AddFilterWithConditions("Temp")
        
        'Aggiunge al filtro eventuali condizioni aggiuntive restituite dalla funzione fnFillDocTypeCondition
        If sWhere <> "" Then m_ActiveFilter.AddCondition sWhere
        
    End If
    
    'Comunica al documento il nuovo filtro da usare
    Set m_Document.ActiveFilter = m_ActiveFilter
    
    
    
    'Viene effettuata la ricerca
    m_Document.OpenDoc
    
    
    'Assegnazione del riferimento alla fonte dati (binding sul recordset del documento)
    
    'rif13
    
    'Set BrwMain.Recordset = m_Document.Dataset.Recordset
    Set BrwMain.Recordset = m_Document.data
    
    
    
    'Ripristina il cursore
    Screen.MousePointer = OLDCursor
    
    'Operazioni da effettuare dopo l'esecuzione della ricerca.
    AfterExecuteSearch

Exit Sub
ERR_ExecuteSearch:
    MsgBox Err.Description, vbCritical, "ExecuteSearch"
End Sub

'**+
'Nome: AfterExecuteSearch
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità: Determina quali operazioni compiere dopo ExecuteSearch
'              in funzione dell'esito della ricerca.
'
'**/
Private Sub AfterExecuteSearch()

    If Not (m_Document.EOF = True And m_Document.BOF = True) Then
        'La ricerca ha avuto esito positivo
        'Attiva la vista tabellare
        BrwMain.Visible = True
        BrwMain.SetFocus

        'Imposta i menu e la toolbar per la modalità tabellare
        SetStatus4Modality Browse

        'Attiva le procedure di creazione di un nuovo filtro solo se l'ExecuteSearch
        'non è stata chiamata da una selezione del DocTypeExplorer

        'Se l'ExecuteSearch non è stata chiamata da un filtro del riquadro attività
        'si permette di salvare il nuovo filtro ed aggiungerlo nel ramo dei filtri.
        If Not m_FilterSelected Then
            oFiltersActivity.NewFilterBegin
        End If

        'Imposta i suggerimenti da visualizzare sulla Statusbar in funzione
        'della modalità di visualizzazione corrente.
        'Ad esempio in alcuni casi le frasi sono al Singolare/Plurare.
        'Le impostazioni sottostanti servono soltanto all'avvio del programma dopo la prima
        'ricerca. (in quanto ChangeView non è stata ancora eseguita)
        'La Sub RefreshDescriptions4StatusBar deve essere chiamata anche in ChangeView()--> Vedi.
        RefreshDescriptions4StatusBar

        m_Search = False
    Else
        'La ricerca ha avuto esito negativo. Viene mostrato un messaggio
        'e si torna in modalità ricerca.

        'Per questioni estetiche viene subito mostrata la modalità FilterDefinition
        'al posto della browse vuota e quindi viene mostrato il messaggio.
        BrwMain.GuiMode = dgFilterDefinition

        'Se si è selezionato il filtro "Nessun record" non occorre
        'visualizzare il messaggio
        If m_ActiveFilter.NothingSelected = False Or m_FilterSelected = False Then
            'Messaggio  "Nessun elemento trovato"
            sbMsgInfo gResource.GetMessage(MESS_NORECFOUND), m_App.FunctionName
        End If

        'Si torna in modalità form (modalità ricerca)
        OnNewSearch
    End If
    
End Sub


'**+
'Autore: Diamante s.p.a
'Data creazione: 26/09/00
'Autore ultima modifica:
'Data ultima modifica:
'
'Nome: fnFillDocTypeCondition
'
'Parametri:
'
'Valori di ritorno: String - in base alle esigenze specifiche di una manutenzione è possibile montare ad hoc
'                                 una clausola WHERE che potrà poi essere presa in considerazione nel filtro di selezione
'                                 con il metodo AddCondition dell'oggetto DmtDocManLib.Filter
'
'Funzionalità: Comunica all'oggetto DocType i valori da usare per la ricerca
'
'**/
Private Function fnFillDocTypeCondition() As String
    Dim Field As DmtDocManLib.Field
    Dim Cond As DmtGridCtl.dgCondition
    Dim sWhere As String
    
    
    'NOTA per l'uso dei campi RANGE
    '--------------------------------------------------------------------------------------------------
    'E' consentito l'inserimento, nella modalità filtri e nel caso di campi di tipo range, del solo il valore iniziale
    '(in questo caso vengono filtrati tutti gli elementi maggiori o uguali a quello inserito)
    'o solo quello finale (in questo vengono filtrati tutti gli elementi minori o uguali a quello inserito).
    'Questo funzionamento vale per tutte le tipologie di campo.
    
    'Nel caso di condizione RANGE la sintassi da usare è del tipo della riga sotto:
    'm_DocType.Fields(Cond.FieldName).Value = Array(Cond.FromValue, Cond.ToValue)
    '--------------------------------------------------------------------------------------------------
    
    sWhere = vbNullString
    
    'Ripulisce la collezione Fields dell'oggetto DocType
    For Each Field In m_DocType.Fields
        Field.Value = Empty
    Next
    
    m_DocType.Fields("IDFiliale").Value = m_App.Branch
    m_DocType.Fields("IDAzienda").Value = m_App.IDFirm
    Me.BrwMain.Refresh
    'Comunica all'oggetto DocType i valori da usare per la ricerca
    For Each Cond In BrwMain.Conditions
        If Cond.IsHeader = False Then
              Select Case Cond.ConditionType
                  
                  'Condizione boolean
                  Case dgCondTypeBoolean
                      m_DocType.Fields(Cond.FieldName).Value = IIf(IsEmpty(Cond.FromValue), Empty, Abs(CDbl(Cond.FromValue = "SI")))
                      
                  'Condizione associata ad una combo box
                  Case dgCondTypeComboDB
                      m_DocType.Fields(Cond.FieldName).Value = BrwMain.Conditions(Cond.FieldName).FromValueID
                  
                  'Condizione di tipo text, numeric, data, time
                  Case dgCondTypeText
                      If Cond.RangeChecked = True Then
                          m_DocType.Fields(Cond.FieldName).Value = Array(Cond.FromValue, Cond.ToValue)
                      Else
                          m_DocType.Fields(Cond.FieldName).Value = Cond.FromValue
                      End If
                  Case dgCondTypeNumber
                      If Cond.RangeChecked = True Then
                          m_DocType.Fields(Cond.FieldName).Value = Array(Cond.FromValue, Cond.ToValue)
                      Else
                          m_DocType.Fields(Cond.FieldName).Value = Cond.FromValue
                      End If
                  
                  Case dgCondTypeDate
                      If Cond.RangeChecked = True Then
                          m_DocType.Fields(Cond.FieldName).Value = Array(Cond.FromValue, Cond.ToValue)
                          
                          'sWhere = Cond.FieldName & ">=" & fnNormDate(Cond.FromValue)
                          'sWhere = sWhere & " AND " & Cond.FieldName & "<=" & fnNormDate(Cond.ToValue)
                      Else
                          m_DocType.Fields(Cond.FieldName).Value = Cond.FromValue
                      End If
                  
                  Case dgCondTypeTime
                      If Cond.RangeChecked = True Then
                          sWhere = Cond.FieldName & ">=" & fnNormTime(Cond.FromValue)
                          sWhere = sWhere & " AND " & Cond.FieldName & "<=" & fnNormTime(Cond.ToValue)
                      Else
                          m_DocType.Fields(Cond.FieldName).Value = Cond.FromValue
                      End If
                
                  'Altre condizioni
                  Case Else
                      m_DocType.Fields(Cond.FieldName).Value = Cond.FromValue
                      
        
              End Select
        End If
    Next Cond
        
    fnFillDocTypeCondition = sWhere
    
    
End Function



'**+
'Nome: CheckRights
'
'Parametri:
'ActionName - Nome della azione
'Enable - Valore da modificare o ritornare inalterato
'
'Valori di ritorno:
'Il valore in Enable o False se l'azione non è abilitata
'per il tipo di documento
'
'Funzionalità:
'Controlla se l'azione passata è abilitata per il tipo documento
'**/
Private Function CheckRights(ByVal ActionName As String, ByVal Enable As Boolean) As Boolean
    Dim Action As DmtDocManLib.Action
    Dim dummy As String
    
    If m_DocType.Actions.Count = 0 Then
        CheckRights = Enable
        Exit Function
    End If
    For Each Action In m_DocType.Actions
        If Action.Name = "TUTTE LE AZIONI" Then
            CheckRights = Enable
            Exit Function
        End If
    Next
    On Error GoTo ActionNotFound
    dummy = m_DocType.Actions(ActionName).Name
    CheckRights = Enable
    Exit Function
ActionNotFound:
    CheckRights = False
End Function

'**+
'Nome: SetFocusTabIndex0
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Da l'input focus al campo con TabIndex uguale a 0.
'**/
Private Sub SetFocusTabIndex0()
    On Error GoTo SetFocusTabIndex0_Error
    
    Dim ControlObject As Control
    Dim iIndex As Long
    Dim bError As Boolean
    
    If m_ControlTabIndex0 Is Nothing Then
        For Each ControlObject In frmMain.Controls
            iIndex = ControlObject.TabIndex
            If bError Then
                '**+ Controllo corrente non ha proprietà TabIndex,
                '    quindi va saltato.
                bError = False
            Else
                If ControlObject.TabIndex = 0 Then
                    Set m_ControlTabIndex0 = ControlObject
                    Exit For
                End If
            End If
        Next
    End If
    m_ControlTabIndex0.SetFocus

    Exit Sub
SetFocusTabIndex0_Error:
    bError = True
    Resume Next
End Sub

'**+
'Nome: IsFieldInput
'
'Parametri:
'Control - un oggetto Control da controllare
'
'Valori di ritorno:
'Se il controllo è abilitato all'input torna vero altrimenti falso
'
'Funzionalità:
'Controllo se un certo controllo è usabile come campo
'di input dei dati del Form
'**/
Private Function IsFieldInput(ByVal Control As Control) As Boolean
    'Controlla se il Controllo è di Immissione
    IsFieldInput = IsFieldInput Or TypeName(Control) = "TextBox"
    IsFieldInput = IsFieldInput Or TypeName(Control) = "CheckBox"
    IsFieldInput = IsFieldInput Or TypeName(Control) = "ComboBox"
    IsFieldInput = IsFieldInput Or TypeName(Control) = "OptionButton"
    
    'rif5 begin
    
    IsFieldInput = IsFieldInput Or TypeName(Control) = "DMTCombo"
    IsFieldInput = IsFieldInput Or TypeName(Control) = "Town"
    
    'rif5 end
    
    
End Function

'**+
'Nome: FieldPresent
'
'Parametri:
'Name - Nome del campo
'
'Valori di ritorno:
'Se il campo specificato nel parametro è presente nella
'collezione FormFields torna vero altrimenti torna falso
'
'Funzionalità:
'Controlla la presenza di un campo nella collezione FormFields
'**/
Private Function FieldPresent(ByVal Name As String) As Boolean
    Dim Field As FormField

    For Each Field In m_FormFields
        FieldPresent = (Name = Field.Name)
        If FieldPresent Then Exit For
    Next
End Function

'**+
'Nome: OnStart
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Altre inizializzazioni dopo quelle predefinite
'**/
Private Sub OnStart()
Dim sSQL As String
  
'SETTARE LE GRIGLIE DEI SOTTODOCUMENTI
    Dim cl As DmtGridCtl.dgColumnHeader

    'Inizializzazione della griglia adibita alla visualizzazione tabellare dei sotto-documenti
    '-------------------------------------------------------------------------------
    Set gPaintNotify = New PaintNotify

    If Me.GrigliaCorpo.ColumnsHeader.Count = 0 Then
        'Crea un'istanza dell'oggetto
        
        Set GrigliaCorpo.PaintNotifyObj = gPaintNotify
        With Me.GrigliaCorpo.ColumnsHeader
            .Add "IDRV_POAssegnazioneMerce", "IDRV_POAssegnazioneMerce", dgNumeric, False, 500, dgAlignRight
            .Add "IDRV_POCaricoMerceRighe", "IDRV_POCaricoMerceRighe", dgNumeric, False, 500, dgAlignRight
            .Add "CodicePedana", "Codice pedana", dgchar, True, 2000, 0, True, True, False
            '.Add "TipoPedana", "TipoPedana", dgchar, True, 1500, dgAlignleft, True, True, True
            .Add "CodiceArticolo", "Cod. Articolo", dgchar, True, 2000, 0, True, True, False
            .Add "Articolo", "Articolo", dgchar, True, 2000, 0, True, True, False
            .Add "UnitaDiMisura", "U.M", dgchar, True, 1000, 0, True, True, False
            .Add "UnitaDiMisuraCoop", "U.M coop", dgchar, False, 1000, 0, True, True, False
            
            Set cl = .Add("Colli", "Colli", dgDouble, True, 1000, dgAlignRight, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("PesoLordo", "Peso Lordo", dgDouble, True, 1000, dgAlignRight, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("PesoNetto", "Peso netto", dgDouble, True, 1000, dgAlignRight, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("Tara", "Tara", dgDouble, True, 1000, dgAlignRight, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("Pezzi", "Pezzi", dgDouble, True, 1000, dgAlignRight, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("Qta_UM", "Q.tà", dgDouble, True, 1000, dgAlignRight, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            .Add "CodiceLottoVendita", "Cod. lotto", dgchar, True, 2000, 0, True, True, False
'            .Add "DescrizioneLottoVendita", "Descrizione lotto", dgchar, True, 2000, 0, True, True, False
            .Add "CodiceImballoVendita", "Cod. Imballo", dgchar, True, 2000, 0, True, True, False
            .Add "ImballoVendita", "Imballo", dgchar, True, 2000, 0, True, True, False
            .Add "AnagraficaCliente", "Cliente", dgchar, True, 2000, 0, True, True, False
            .Add "DataOrdine", "Data ordine", dgDate, True, 2000, 0, True, True, False
            .Add "NumeroOrdine", "Numero ordine", dgNumeric, True, 2000, 0, True, True, False
            .Add "IDRV_POProcessoIVGammaRighe", "IDRV_POProcessoIVGammaRighe", dgNumeric, False, 500, dgAlignRight
            .Add "AnnoProcesso", "Anno processo IV Gamma", dgNumeric, False, 1500, dgAlignRight
            .Add "NumeroProcesso", "Numero processo IV Gamma", dgNumeric, False, 1500, dgAlignRight
            .Add "Movimentato", "Movimentato", dgBoolean, True, 1500, dgAligncenter
            
            .Add "IDArticoloImballoPrimario", "IDArticoloImballoPrimario", dgNumeric, False, 500, dgAlignRight
            .Add "CodiceImballoPrimario", "Cod. Imballo primario", dgchar, False, 2000, 0, True, True, False
            .Add "DescrizioneImballoPrimario", "Imballo primario", dgchar, False, 2000, 0, True, True, False
            Set cl = .Add("NumeroConfezioniPerImballo", "N° confez.", dgDouble, False, 1000, dgAlignRight, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("TaraConfezioneImballo", "Tara confez.", dgDouble, False, 1000, dgAlignRight, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 5
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("CostoConfezioneImballo", "Costo confez.", dgDouble, False, 1000, dgAlignRight, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 5
                cl.FormatOptions.FormatNumericThousandSep = "."
        End With
    End If
    Me.GrigliaCorpo.EnableMove = True


    If Me.GrigliaScarti.ColumnsHeader.Count = 0 Then
        With Me.GrigliaScarti.ColumnsHeader
            .Add "CodiceArticolo", "Cod. Articolo", dgchar, True, 2000, 0, True, True, False
            .Add "Articolo", "Articolo", dgchar, True, 2000, 0, True, True, False
            .Add "UnitaDiMisura", "U.M", dgchar, True, 1000, 0, True, True, False
            .Add "UnitaDiMisuraCoop", "U.M coop", dgchar, True, 1000, 0, True, True, False
            
            Set cl = .Add("Colli", "Colli", dgDouble, True, 1000, 0, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("PesoLordo", "Peso Lordo", dgDouble, True, 1000, 0, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("PesoNetto", "Peso netto", dgDouble, True, 1000, 0, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("Tara", "Tara", dgDouble, True, 1000, 0, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("Pezzi", "Pezzi", dgDouble, True, 1000, 0, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            Set cl = .Add("Qta_UM", "Q.tà", dgDouble, True, 1000, 0, True, True, False)
                cl.FormatOptions.FormatNumericRegionalSettings = False
                cl.FormatOptions.UseFormatControlSettings = False
                cl.FormatOptions.FormatNumericDecSep = ","
                cl.FormatOptions.FormatNumericDecimals = 2
                cl.FormatOptions.FormatNumericThousandSep = "."
            .Add "CodiceImballoVendita", "Cod. Imballo", dgchar, True, 2000, 0, True, True, False
            .Add "ImballoVendita", "Imballo", dgchar, True, 2000, 0, True, True, False
        End With
    End If
    Me.GrigliaScarti.EnableMove = True

    
    
'''''''''''''''''''''''''CONTROLLI STANDARD''''''''''''''''''''''''''''''''''''
         
    
    'Magazzino di conferimento
    With Me.cboMagazzinoConf
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDMagazzino"
        .DisplayField = "Magazzino"
        .SQL = "SELECT * FROM Magazzino WHERE IDFiliale=" & m_App.Branch
        .Fill
    End With
    
    'Magazzino di vendita
    With Me.CboMagazzinoVend
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDMagazzino"
        .DisplayField = "Magazzino"
        .SQL = "SELECT * FROM Magazzino WHERE IDFiliale=" & m_App.Branch
        .Fill
    End With
    
    'Tipo documento di conferimento
    With Me.cboTipoDocumentoCoop
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDRV_POTipoDocumentoCoop"
        .DisplayField = "TipoDocumentoCoop"
        .SQL = "SELECT * FROM RV_POTipoDocumentoCoop"
        .Fill
    End With
    
    'Sezionale
    With Me.cboSezionale
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDSezionale"
        .DisplayField = "Sezionale"
        .SQL = "SELECT RV_POSezionalePerDocumento.IDSezionale, Sezionale.Sezionale, RV_POSchemaCoop.IDFiliale, RV_POSchemaCoop.IDUtente, "
        .SQL = .SQL & "RV_POSezionalePerDocumento.IDDocumentoCoop "
        .SQL = .SQL & "FROM RV_POSchemaCoop INNER JOIN "
        .SQL = .SQL & "RV_POSezionalePerDocumento ON "
        .SQL = .SQL & "RV_POSchemaCoop.IDRV_POSchemaCoop = RV_POSezionalePerDocumento.IDRV_POSchemaCoop INNER JOIN "
        .SQL = .SQL & "Sezionale ON RV_POSezionalePerDocumento.IDSezionale = dbo.Sezionale.IDSezionale "
        .SQL = .SQL & "WHERE (RV_POSchemaCoop.IDFiliale = " & m_App.Branch & ") And (dbo.RV_POSchemaCoop.IDUtente = 0) And (dbo.RV_POSezionalePerDocumento.IDDocumentoCoop = 4)"
        .Fill
    End With
    
     With Me.CDArticolo
        Set .Application = m_App
        Set .Database = m_App.Database
        .HwndContainer = Me.hwnd
        .CodeField = "CodiceArticolo"
        .DescriptionField = "Articolo"
        .KeyField = "IDArticolo"
        .TableName = "Articolo"
        .Filter = "VirtualDelete = 0 AND IDAzienda = " & m_App.IDFirm & " AND ((IDTipoProdotto <> " & Link_TipoImballo & ") OR (IDTipoProdotto IS NULL))"
        .MenuFunctions("EseguiGestione").Enabled = True
        .PropCodice.Caption = "Codice"
        'Caption da associare alla label del campo Descrizione
        .PropDescrizione.Caption = "Descrizione"
        'Caption da associare alla intestazione della colonna della Find per il campo Codice
        .CodeCaption4Find = "Codice Articolo"
        'Caption da associare alla intestazione della colonna della Find per il campo Descrizione
        .DescriptionCaption4Find = "Descrizione Articolo"
        'Identificativo della Funzione Diamante per l'Esegui Gestione
        .IDExecuteFunction = fncTrovaIDFunzione("Articoli", "Greentop - Articoli") 'Articoli
        'Indica se il campo Codice è un campo numerico
        .CodeIsNumeric = False
    End With

     With Me.CDArticolo_Q
        Set .Application = m_App
        Set .Database = m_App.Database
        .HwndContainer = Me.hwnd
        .CodeField = "CodiceArticolo"
        .DescriptionField = "Articolo"
        .KeyField = "IDArticolo"
        .TableName = "Articolo"
        .Filter = "VirtualDelete = 0 AND IDAzienda = " & m_App.IDFirm & " AND ((IDTipoProdotto = " & Link_TipoScarto & ") OR (IDTipoProdotto = " & Link_TipoAumentoPeso & ") OR (IDTipoProdotto = " & Link_TipoCaloPeso & "))"
        .MenuFunctions("EseguiGestione").Enabled = True
        .PropCodice.Caption = "Codice"
        'Caption da associare alla label del campo Descrizione
        .PropDescrizione.Caption = "Descrizione"
        'Caption da associare alla intestazione della colonna della Find per il campo Codice
        .CodeCaption4Find = "Codice Articolo"
        'Caption da associare alla intestazione della colonna della Find per il campo Descrizione
        .DescriptionCaption4Find = "Descrizione Articolo"
        'Identificativo della Funzione Diamante per l'Esegui Gestione
        .IDExecuteFunction = fncTrovaIDFunzione("Articoli", "Greentop - Articoli") 'Articoli
        'Indica se il campo Codice è un campo numerico
        .CodeIsNumeric = False
    End With

    'Imballo
    With Me.CDCodiceImballo
        Set .Application = m_App
        Set .Database = m_App.Database
        .HwndContainer = Me.hwnd
        .CodeField = "CodiceArticolo"
        .DescriptionField = "Articolo"
        .KeyField = "IDArticolo"
        .TableName = "Articolo"
        .Filter = "VirtualDelete = 0 AND IDAzienda = " & m_App.IDFirm & " AND IDTipoProdotto = " & Link_TipoImballo
        .MenuFunctions("EseguiGestione").Enabled = True
        .PropCodice.Caption = "Codice"
        'Caption da associare alla label del campo Descrizione
        .PropDescrizione.Caption = "Descrizione"
        'Caption da associare alla intestazione della colonna della Find per il campo Codice
        .CodeCaption4Find = "Codice Articolo"
        'Caption da associare alla intestazione della colonna della Find per il campo Descrizione
        .DescriptionCaption4Find = "Descrizione Articolo"
        'Identificativo della Funzione Diamante per l'Esegui Gestione
        .IDExecuteFunction = fncTrovaIDFunzione("Articoli", "Greentop - Articoli")
        'Indica se il campo Codice è un campo numerico
        .CodeIsNumeric = False
    End With
    
    'Imballo
    With Me.CDCodiceImballo_Q
        Set .Application = m_App
        Set .Database = m_App.Database
        .HwndContainer = Me.hwnd
        .CodeField = "CodiceArticolo"
        .DescriptionField = "Articolo"
        .KeyField = "IDArticolo"
        .TableName = "Articolo"
        .Filter = "VirtualDelete = 0 AND IDAzienda = " & m_App.IDFirm & " AND IDTipoProdotto=" & Link_TipoImballo
        .MenuFunctions("EseguiGestione").Enabled = True
        .PropCodice.Caption = "Codice"
        'Caption da associare alla label del campo Descrizione
        .PropDescrizione.Caption = "Descrizione"
        'Caption da associare alla intestazione della colonna della Find per il campo Codice
        .CodeCaption4Find = "Codice Articolo"
        'Caption da associare alla intestazione della colonna della Find per il campo Descrizione
        .DescriptionCaption4Find = "Descrizione Articolo"
        'Identificativo della Funzione Diamante per l'Esegui Gestione
        .IDExecuteFunction = fncTrovaIDFunzione("Articoli", "Greentop - Articoli")
        'Indica se il campo Codice è un campo numerico
        .CodeIsNumeric = False
    End With
    
    'Imballo
    With Me.CDImballoPrimario
        Set .Application = m_App
        Set .Database = m_App.Database
        .HwndContainer = Me.hwnd
        .CodeField = "CodiceArticolo"
        .DescriptionField = "Articolo"
        .KeyField = "IDArticolo"
        .TableName = "Articolo"
        .Filter = "VirtualDelete = 0 AND IDAzienda = " & m_App.IDFirm & " AND IDTipoProdotto=" & Link_TipoImballo
        .MenuFunctions("EseguiGestione").Enabled = True
        .PropCodice.Caption = "Codice"
        'Caption da associare alla label del campo Descrizione
        .PropDescrizione.Caption = "Descrizione"
        'Caption da associare alla intestazione della colonna della Find per il campo Codice
        .CodeCaption4Find = "Codice Articolo"
        'Caption da associare alla intestazione della colonna della Find per il campo Descrizione
        .DescriptionCaption4Find = "Descrizione Articolo"
        'Identificativo della Funzione Diamante per l'Esegui Gestione
        .IDExecuteFunction = fncTrovaIDFunzione("Articoli", "Greentop - Articoli")
        'Indica se il campo Codice è un campo numerico
        .CodeIsNumeric = False
    End With
    
    
     With Me.CboTipoLavorazione
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDRV_POTipoLavorazione"
        .DisplayField = "TipoLavorazione"
        .SQL = "SELECT * FROM RV_POTipoLavorazione ORDER BY TipoLavorazione"
        .Fill
    End With

    With Me.cboTipoLavConf
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDRV_POTipoLavorazione"
        .DisplayField = "TipoLavorazione"
        .SQL = "SELECT * FROM RV_POTipoLavorazione ORDER BY TipoLavorazione"
        .Fill
    End With
    
    With Me.CboTipoLavorazione_Q
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDRV_POTipoLavorazione"
        .DisplayField = "TipoLavorazione"
        .SQL = "SELECT * FROM RV_POTipoLavorazione ORDER BY TipoLavorazione"
        .Fill
    End With
    
    'Unita di misura
    With Me.cboUM
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDUnitaDiMisura"
        .DisplayField = "UnitaDiMisura"
        .SQL = "SELECT * FROM UnitaDiMisura"
        .Fill
    End With
    
    'Unita di misura
    With Me.cboUM_Q
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDUnitaDiMisura"
        .DisplayField = "UnitaDiMisura"
        .SQL = "SELECT * FROM UnitaDiMisura"
        .Fill
    End With
    'Unita di misura di imballo
    With Me.cboUMImballo
        Set .Database = m_App.Database.Connection
        .AddFieldKey "IDUnitaDiMisura"
        .DisplayField = "UnitaDiMisura"
        .SQL = "SELECT * FROM UnitaDiMisura"
        .Fill
    End With
    
    'Cliente per ordine
     With Me.cdCliente
        Set .Application = m_App
        Set .Database = m_App.Database
        .HwndContainer = Me.hwnd
        .CodeField = "Codice"
        .DescriptionField = "Anagrafica"
        .KeyField = "IDAnagrafica"
        .TableName = "RV_POIETipoAnagraficaCliente"
        .Filter = "IDAzienda = " & m_App.IDFirm
        '.MenuFunctions("EseguiGestione").Enabled = True
        .PropCodice.Caption = "Codice"
        'Caption da associare alla label del campo Descrizione
        .PropDescrizione.Caption = "Clienti"
        'Caption da associare alla intestazione della colonna della Find per il campo Codice
        .CodeCaption4Find = "Codice"
        'Caption da associare alla intestazione della colonna della Find per il campo Descrizione
        .DescriptionCaption4Find = "Anagrafica"
        'Identificativo della Funzione Diamante per l'Esegui Gestione
        .IDExecuteFunction = fncTrovaIDFunzione("Anagrafica") 'Articoli
        'Indica se il campo Codice è un campo numerico
        .CodeIsNumeric = False
    End With
    
    With Me.cboCalibro
        Set .Database = TheApp.Database.Connection
        .AddFieldKey "IDRV_POCalibro"
        .DisplayField = "Calibro"
        .SQL = "SELECT * FROM RV_POCalibro"
        .SQL = .SQL & " ORDER BY Calibro"
    End With
  
    With Me.cboTipoCategoria
        Set .Database = TheApp.Database.Connection
        .AddFieldKey "IDRV_POTipoCategoria"
        .DisplayField = "TipoCategoria"
        .SQL = "SELECT * FROM RV_POTipoCategoria"
        .SQL = .SQL & " ORDER BY TipoCategoria"
    End With
    
    With Me.cboUtente
        'Imposta la connessione corrente al database DMT
        '(passa la connessione di tipo dmtoledblib.AdoConnection)
        Set .Database = TheApp.Database.Connection
        'Indica il campo chiave univoco di accesso al record
        .AddFieldKey "IDUtente"
        'Indica il campo da visualizzare nella combo
        .DisplayField = "Utente"
        'Indica la query SQL da utilizzare per il reperimento dei dati
        .SQL = "SELECT * FROM Utente"
        .SQL = .SQL & " ORDER BY Utente"
    End With
    
    With Me.cboLinguaCliente
        'Imposta la connessione corrente al database DMT
        '(passa la connessione di tipo dmtoledblib.AdoConnection)
        Set .Database = TheApp.Database.Connection
        'Indica il campo chiave univoco di accesso al record
        .AddFieldKey "IDLinguaDescrizioneArticolo"
        'Indica il campo da visualizzare nella combo
        .DisplayField = "LinguaDescrizioneArticolo"
        'Indica la query SQL da utilizzare per il reperimento dei dati
        .SQL = "SELECT * FROM LinguaDescrizioneArticolo"
        .SQL = .SQL & " ORDER BY LinguaDescrizioneArticolo"
    End With

    With Me.cboLinguaPred
        'Imposta la connessione corrente al database DMT
        '(passa la connessione di tipo dmtoledblib.AdoConnection)
        Set .Database = TheApp.Database.Connection
        'Indica il campo chiave univoco di accesso al record
        .AddFieldKey "IDLinguaDescrizioneArticolo"
        'Indica il campo da visualizzare nella combo
        .DisplayField = "LinguaDescrizioneArticolo"
        'Indica la query SQL da utilizzare per il reperimento dei dati
        .SQL = "SELECT * FROM LinguaDescrizioneArticolo"
        .SQL = .SQL & " ORDER BY LinguaDescrizioneArticolo"
    End With

'    With Me.cboIvaCliente
'        'Imposta la connessione corrente al database DMT
'        '(passa la connessione di tipo dmtoledblib.AdoConnection)
'        Set .Database = TheApp.Database.Connection
'        'Indica il campo chiave univoco di accesso al record
'        .AddFieldKey "IDIva"
'        'Indica il campo da visualizzare nella combo
'        .DisplayField = "Iva"
'        'Indica la query SQL da utilizzare per il reperimento dei dati
'        .SQL = "SELECT * FROM Iva "
'        .SQL = .SQL & " ORDER BY Codice"
'    End With



'    With Me.cboVettore
'        Set .Database = TheApp.Database.Connection
'        .AddFieldKey "IDVettore"
'        .DisplayField = "Vettore"
'        .SQL = "SELECT * FROM Vettore ORDER BY Vettore"
'        .Fill
'    End With
    
    If ETICHETTE_PRO_PER_UTENTE_DMT_LAV = 0 Then
        'Report per etichette di lavorazione
        With Me.cboReportNew
            Set .Database = m_App.Database.Connection
            .AddFieldKey "IDRV_POConfigurazioneEtichetta"
            .DisplayField = "ConfigurazioneEtichetta"
            .SQL = "SELECT * FROM RV_POConfigurazioneEtichetta "
            .SQL = .SQL & "WHERE IDAzienda=" & TheApp.IDFirm
            .SQL = .SQL & " AND IDRV_POTipoEtichetta=1 "
            .SQL = .SQL & " ORDER BY ConfigurazioneEtichetta "
            .Fill
        End With
    Else
        'Report per etichette di lavorazione
        With Me.cboReportNew
            Set .Database = m_App.Database.Connection
            .AddFieldKey "RV_POConfigurazioneEtichetta.IDRV_POConfigurazioneEtichetta"
            .DisplayField = "ConfigurazioneEtichetta"
            .SQL = "SELECT RV_POConfigurazioneEtichettaPerUtenteDMT.IDUtente, RV_POConfigurazioneEtichetta.ConfigurazioneEtichetta, "
            .SQL = .SQL & "RV_POConfigurazioneEtichetta.IDRV_POConfigurazioneEtichetta, RV_POConfigurazioneEtichetta.IDAzienda, "
            .SQL = .SQL & "RV_POConfigurazioneEtichetta.IDRV_POTipoEtichetta "
            .SQL = .SQL & "FROM RV_POConfigurazioneEtichettaPerUtenteDMT INNER JOIN "
            .SQL = .SQL & "RV_POConfigurazioneEtichetta ON "
            .SQL = .SQL & "RV_POConfigurazioneEtichettaPerUtenteDMT.IDRV_POConfigurazioneEtichetta = RV_POConfigurazioneEtichetta.IDRV_POConfigurazioneEtichetta "
            .SQL = .SQL & "WHERE RV_POConfigurazioneEtichetta.IDAzienda=" & TheApp.IDFirm
            .SQL = .SQL & " AND RV_POConfigurazioneEtichetta.IDRV_POTipoEtichetta=1 "
            .SQL = .SQL & " AND RV_POConfigurazioneEtichettaPerUtenteDMT.IDUtente=" & TheApp.IDUser
            .SQL = .SQL & " ORDER BY RV_POConfigurazioneEtichetta.ConfigurazioneEtichetta "
            .Fill
        End With
        
    End If
    
    If ETICHETTE_PRO_PER_UTENTE_DMT_PED = 0 Then
        'Report per etichette di pedana
        With Me.cboReportPedNew
            Set .Database = m_App.Database.Connection
            .AddFieldKey "IDRV_POConfigurazioneEtichetta"
            .DisplayField = "ConfigurazioneEtichetta"
            .SQL = "SELECT * FROM RV_POConfigurazioneEtichetta "
            .SQL = .SQL & "WHERE IDAzienda=" & TheApp.IDFirm
            .SQL = .SQL & " AND IDRV_POTipoEtichetta=2 "
            .SQL = .SQL & " ORDER BY ConfigurazioneEtichetta "
            .Fill
        End With
    Else
        'Report per etichette di pedana
        With Me.cboReportPedNew
            Set .Database = m_App.Database.Connection
            .AddFieldKey "RV_POConfigurazioneEtichetta.IDRV_POConfigurazioneEtichetta"
            .DisplayField = "ConfigurazioneEtichetta"
            .SQL = "SELECT RV_POConfigurazioneEtichettaPerUtenteDMT.IDUtente, RV_POConfigurazioneEtichetta.ConfigurazioneEtichetta, "
            .SQL = .SQL & "RV_POConfigurazioneEtichetta.IDRV_POConfigurazioneEtichetta, RV_POConfigurazioneEtichetta.IDAzienda, "
            .SQL = .SQL & "RV_POConfigurazioneEtichetta.IDRV_POTipoEtichetta "
            .SQL = .SQL & "FROM RV_POConfigurazioneEtichettaPerUtenteDMT INNER JOIN "
            .SQL = .SQL & "RV_POConfigurazioneEtichetta ON "
            .SQL = .SQL & "RV_POConfigurazioneEtichettaPerUtenteDMT.IDRV_POConfigurazioneEtichetta = RV_POConfigurazioneEtichetta.IDRV_POConfigurazioneEtichetta "
            .SQL = .SQL & "WHERE RV_POConfigurazioneEtichetta.IDAzienda=" & TheApp.IDFirm
            .SQL = .SQL & " AND RV_POConfigurazioneEtichetta.IDRV_POTipoEtichetta=2 "
            .SQL = .SQL & " AND RV_POConfigurazioneEtichettaPerUtenteDMT.IDUtente=" & TheApp.IDUser
            .SQL = .SQL & " ORDER BY RV_POConfigurazioneEtichetta.ConfigurazioneEtichetta "
            .Fill
        End With
    End If
'    With Me.cboVettoreSuccessivo
'        Set .Database = TheApp.Database.Connection
'        .AddFieldKey "IDVettore"
'        .DisplayField = "Vettore"
'        .SQL = "SELECT * FROM Vettore ORDER BY Vettore"
'        .Fill
'    End With

'    With Me.cboLuogoPresaMerce
'        Set .Database = TheApp.Database.Connection
'        .AddFieldKey "IDSitoPerAnagrafica"
'        .DisplayField = "SitoPerAnagrafica"
'        .SQL = "SELECT * FROM SitoPerAnagrafica  "
'        .SQL = .SQL & "WHERE IDAnagrafica=" & GET_LINK_ANAGRAFICA_AZIENDA(TheApp.IDFirm)
'        .SQL = .SQL & " ORDER BY SitoPerAnagrafica "
'        .Fill
'    End With
'
'    With Me.cboTipoTrasporto
'        Set .Database = TheApp.Database.Connection
'        .AddFieldKey "IDTipoSpedizione"
'        .DisplayField = "TipoSpedizione"
'        .SQL = "SELECT * FROM TipoSpedizione  ORDER BY TipoSpedizione "
'        .Fill
'    End With
    
    With Me.cboListino
        Set .Database = TheApp.Database.Connection
        .AddFieldKey "IDListino"
        .DisplayField = "Listino"
        .SQL = "SELECT * FROM Listino  "
        .SQL = .SQL & "WHERE IDAzienda=" & TheApp.IDFirm
        .SQL = .SQL & " ORDER BY Listino "
        .Fill
    End With


     'Tipo di Pedana
    With Me.CDTipoPedana
        Set .Application = TheApp
        Set .Database = TheApp.Database
        .HwndContainer = Me.hwnd
        .CodeField = "CodiceTipoPedana"
        .DescriptionField = "TipoPedana"
        .KeyField = "IDRV_POTipoPedana"
        .TableName = "RV_POIETipoPedana"
        .Filter = "IDAzienda = " & TheApp.IDFirm
        .MenuFunctions("EseguiGestione").Enabled = True
        .PropCodice.Caption = "Codice"
        'Caption da associare alla label del campo Descrizione
        .PropDescrizione.Caption = "Descrizione"
        'Caption da associare alla intestazione della colonna della Find per il campo Codice
        .CodeCaption4Find = "Codice Articolo"
        'Caption da associare alla intestazione della colonna della Find per il campo Descrizione
        .DescriptionCaption4Find = "Descrizione Articolo"
        'Identificativo della Funzione Diamante per l'Esegui Gestione
        .IDExecuteFunction = GET_FUNZIONE(fnGetTipoOggetto("RV_POTipoPedana")) 'Articoli
        'Indica se il campo Codice è un campo numerico
        .CodeIsNumeric = False
    End With

    With Me.cboSezionaleOrdOri
        Set .Database = TheApp.Database.Connection
        .AddFieldKey "IDSezionale"
        .DisplayField = "Sezionale"
        .SQL = "SELECT  Sezionale.IDSezionale, Sezionale.Sezionale, RegistroIvaPerTipoOggetto.IDFiliale "
        .SQL = .SQL & "FROM Sezionale INNER JOIN "
        .SQL = .SQL & "RegistroIvaPerTipoOggetto ON Sezionale.IDRegistroIva = RegistroIvaPerTipoOggetto.IDRegistroIva AND "
        .SQL = .SQL & "Sezionale.IDFiliale = RegistroIvaPerTipoOggetto.IDFiliale "
        .SQL = .SQL & "WHERE RegistroIvaPerTipoOggetto.IDTipoOggetto = " & 15
        .SQL = .SQL & " AND RegistroIvaPerTipoOggetto.IDFiliale = " & TheApp.Branch
    End With
    



    'Inizializzazione della LabelLink
    '----------------------------
    'Set LabelLink1.Application = TheApp    'Loggetto Application
    'LabelLink1.WindowHandleClient = Me.hwnd   'LHandle del Form che contiene la LabelLink
    'LabelLink1.IDFunction = GET_FUNZIONE("RV_POLavorazioneL")
    
    'Viene disabilitata la voce "Ricerca" del menu popup
    'LabelLink1.PopMenuItems("Mnu_SearchObject").Enabled = False

    'Inizializzazione della LabelLink
    '----------------------------
    Set LabelLink2.Application = TheApp    'Loggetto Application
    LabelLink2.WindowHandleClient = Me.hwnd   'LHandle del Form che contiene la LabelLink
    LabelLink2.IDFunction = GET_FUNZIONE("RV_POPedana")
    LabelLink2.PopMenuItems("Mnu_SearchObject").Enabled = False

    Set lblLinkOrdine.Application = TheApp    'Loggetto Application
    lblLinkOrdine.WindowHandleClient = Me.hwnd   'LHandle del Form che contiene la LabelLink
    lblLinkOrdine.IDFunction = GET_FUNZIONE("RV_POOrdineL")
    lblLinkOrdine.PopMenuItems("Mnu_SearchObject").Enabled = False

End Sub

'**+
'Nome: OnSave
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando Save
'**/
Private Sub OnSave()
On Error GoTo ERR_OnSave
    Dim Field As DmtDocManLib.Field
    Dim DocLink As DmtDocManLib.DocumentsLink
    Dim NumeroRecordRighe As Long
    Dim sSQL As String
    Dim OLD_Cursor As Long
    
    
    If MODULO_ATTIVATO = 0 Then
        If Len(MODULO_DESCRIZIONE) > 0 Then
            MsgBox "Il modulo " & MODULO_DESCRIZIONE & " non è stato abilitato", vbInformation, TheApp.FunctionName
        Else
            MsgBox "Questa funzionalità non può essere avviata senza abilitazione", vbInformation, TheApp.FunctionName
        End If
    Exit Sub
    End If
    
    AggiornamentoDocumento = 1
    NumeroRecordRighe = Me.GrigliaCorpo.ListIndex
    'If Not PermissionToSave Then
    '    Exit Sub
    'End If
        

    'Passa alla collezione Fields dell'oggetto
    'Document i valori da salvare
    'If m_Document("IDRV_POCaricoMerceTesta").Value < 0 Then
    '    Link_Oggetto = fnGetNewKey("Oggetto", "IDOggetto")
    '    Me.txtNumeroDocumento.Value = fnGetNumeroDocumento
    'End If
    For Each Field In m_Document.Fields
        'Sul campo chiave primaria non si deve far nulla
        If Not Field.PrimaryKey Then
            If FieldPresent(Field.Name) Then
               
                'rif4 begin
                
                Select Case TypeName(m_FormFields(Field.Name).Control)
                    Case "TextBox"
                        Field.Value = m_FormFields(Field.Name).Control.Text
                    Case "DmtCodDesc"
                        Field.Value = m_FormFields(Field.Name).Control.KeyFieldID
                    Case "DMTCombo"
                        Field.Value = m_FormFields(Field.Name).Control.CurrentID
                    Case "Town"
                        If Field.Name = "IDComune" Then
                            Field.Value = m_FormFields(Field.Name).Control.CityID
                        ElseIf Field.Name = "Cap" Then
                            Field.Value = m_FormFields(Field.Name).Control.Zip
                        End If
                    Case "dmtDate"
                        If (m_FormFields(Field.Name).Control.Text = "") Or (IsNull(m_FormFields(Field.Name).Control.Value)) Then
                            Field.Value = Null
                        Else
                            Field.Value = m_FormFields(Field.Name).Control.Value
                        End If
                    Case "dmtNumber"
                        Field.Value = m_FormFields(Field.Name).Control.Value
                    Case "dmtCurrency"
                        Field.Value = m_FormFields(Field.Name).Control.Value
                    
                    Case "dmtTime"
                        Field.Value = m_FormFields(Field.Name).Control.Value
                    Case "DmtSearchACS"
                        Field.Value = m_FormFields(Field.Name).Control.IDAnagrafica
                    Case "CheckBox"
                        Field.Value = fnNormBoolean(m_FormFields(Field.Name).Control.Value)
                    Case "Label"
                        Field.Value = m_FormFields(Field.Name).Control.Caption
                
                End Select
                
                'rif4 end
                
            Else
                If Field.Name = m_LinkedField Then
                    Field.Value = m_App.CallerFieldValue
                End If
                If Field.Name = "IDRV_POTipoConfLiquidazione" Then
                    Field.Value = LINK_STATO_LIQ_CHIUSO
                End If
                
            End If
        End If
    Next

 
    OLD_Cursor = Cn.CursorLocation
    Cn.CursorLocation = adUseClient
    
    m_Document.SaveDocument
       
    sSQL = "DELETE FROM RV_POAssegnazioneMerce "
    sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & m_Document(m_Document.PrimaryKey).Value
    sSQL = sSQL & " AND IDArticolo IS NULL"
    Cn.Execute sSQL
           
    
    'SalvataggioRighe
    
    Cn.CursorLocation = OLD_Cursor
    
    m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
    m_Semaphore.SetObjectAction m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions
    
    'Refresh delle variabili di stato
    m_Changed = False
    m_Search = False
    m_Saved = True
    
    'Refresh dello stato della ToolBar standard in modalità variazione
    SetStatus4Modality Modify
       
    
    m_DocumentsLink.Refresh
    
    If Not (m_DocumentsLink.BOF And m_DocumentsLink.EOF) Then
        m_DocumentsLink.Move NumeroRecordRighe - 1
    End If
   
    If Me.chkPareggiaConferimento.Value = vbChecked Then
        Me.Enabled = False
        Me.Caption = "PAREGGIA CONFERIMENTO IN CORSO............."
        DoEvents
        PareggiaConferimento
        Me.chkPareggiaConferimento.Value = vbUnchecked
        
        Me.Caption = Caption2Display
        Me.Enabled = True
    End If
    
    
    
    'GET_RIEPILOGO_CONFERIMENTO
    AggiornamentoDocumento = 0
    
    
    
    'If Not (m_DocumentsLink.BOF And m_DocumentsLink.EOF) Then
    '    m_DocumentsLink.Move 0
    'End If
    
    'Start_Liquidazione
Exit Sub
ERR_OnSave:
    MsgBox Err.Description, vbCritical, "OnSave"
End Sub

'**+
'Nome: OnSaveDocumentsLink
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando OnSaveDocumentsLink
'**/
Private Sub OnSaveDocumentsLink(ByVal DocumentLink As DmtDocManLib.DocumentsLink)

End Sub

'**+
'Nome: OnDelete
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando Delete
'**/
Private Sub OnDelete()
    Dim sToRemove As String
    Dim DocLink As DmtDocManLib.DocumentsLink
    
    
    'Se si è in modalità tabellare potrebbe essere necessario sincronizzare
    'il documento con il record evidenziato nella browse
    If BrwMain.Visible = True Then
        If Not (m_Document.EOF = True And m_Document.BOF = True) Then
            m_Document.Move BrwMain.ListIndex - 1
        End If
    End If
    
    
    If Not m_Semaphore.IsActionAvailable(m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemDeleteAction) Then
        Exit Sub
    End If
    
    'Se in fase di inserimento di un nuovo
    'record non c'è niente da fare
    If m_Document.TableNew Then
        Exit Sub
    End If
    
    'Conferma della cancellazione
    gResource.CustomStrings.Clear
    sToRemove = m_Document.Fields(CAMPO_PER_CAPTION).Value
    gResource.CustomStrings.Add Chr(34) & sToRemove & Chr(34), 1
    If fnMsgQuestion(gResource.GetCustomizedMessage(MESS_QUERYREMOVE), m_App.FunctionName) = vbYes Then
        If ControlloRigheMovimentate = True Then
            
            EliminaRigheDaDocumento
            
            'fnEliminaOggetto
        
                If Not (m_Document.EOF Or m_Document.BOF) Then
                    'Cancella l'eventuale blocco sul record da cancellare.
                    m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
                End If
        
        
                m_Document.DeleteDocument
        
        
        
        
                If (m_Document.EOF = True And m_Document.BOF = True) Then
                    'Se è stato cancellato l'ultimo record si va in modalità inserimento
                    NewRecord
                Else
                    'Refresh dello stato della ToolBar standard e dei menu
                    If BrwMain.Visible Then
                        'Va in modalità tabellare
                        SetStatus4Modality Browse
                    Else
                    'Essendo in modalità variazione occorre controllare se il record su cui
                    'ci si è posizionati è bloccato.
                    'Se non lo è lo si blocca e si procede altrimenti si andrà in modalità tabellare.
                        If Not m_Semaphore.IsActionAvailable(m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions) Then
                        'Il record è bloccato.
                        'Va in modalità tabellare
                        BrwMain.Visible = True
                        SetStatus4Modality Browse
                    Else
                    'Il record non è bloccato.
                    
                    m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
                    m_Semaphore.SetObjectAction m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions
                    
                    'Va in modalità variazione
                    SetStatus4Modality Modify
                    End If
            
                    RefreshDescriptions4StatusBar
                End If
            End If
        
            'Refresh delle variabili di stato
            m_Changed = False
            m_Saved = True
            m_Search = False
        Else
           MsgBox "Impossibile eliminare il documento poichè alcuni lotti del documento risultano movimenatti da altri documenti!", vbCritical, "Impossibile eliminare"
        End If
End If
End Sub

'**+
'Nome: OnDeleteDocumentsLink
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni relative ai documents link sul comando Delete
'**/
Private Sub OnDeleteDocumentsLink(ByVal DocumentLink As DmtDocManLib.DocumentsLink)

End Sub

'**+
'Nome: OnClear
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando Clear
'**/
Private Sub OnClear()
'Se si è in modalità Filtro occorre ripulire i campi di immissione altrimenti,
'se si è in modalità Form, si cancella il contenuto di tutti i controlli
    
    
    If BrwMain.Visible And BrwMain.GuiMode = dgFilterDefinition Then
        '---Modalità Filtro---
        'Ripulisce i campi di immissione delle condizioni di ricerca.
        BrwMain.Conditions.ClearValues
    Else
        '---Modalità Form---
        'Ripulisce i campi del form
        ClearFormFields
        SetFocusTabIndex0
        
        'Se si era in modalità Nuovo viene disabilitato il pulsante Salva
        'e si ripristina la modalità stessa.
        If m_Document.TableNew Then
            ActivateBarButtons BTN_SAVE, False
            m_Changed = False
            m_Saved = True
        End If
    End If
End Sub

'**+
'Nome: OnExecuteSearch
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando ExecuteSearch
'**/
Private Sub OnExecuteSearch()
    
    AGGIORNA_NUMERAZIONE_ORDINE
    
    'Nota: utilizzo la chiamata al metodo ApplyFilter della dmtGrid piuttosto
    'che la chiamata diretta di ExecuteSearch perchè in questo modo la dmtGrid
    'può gestire internamente le conditions di ricerca.
    'Verrà generato l'evento BrwMain_OnApplyFilter()
    '
    'ExecuteSearch
    '
    AggiornamentoDocumento = 1
    BrwMain.ApplyFilter
    AggiornamentoDocumento = 0
        
End Sub

'**+
'Nome: OnMoveCurrentRecord
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando di riposizionamento del record corrente
'**/
Private Sub OnMoveCurrentRecord(ByVal Tipo As Integer, ByVal sToolName As String)
    Dim iResponse As Integer
    
    iResponse = ChooseAboutSaving
    If iResponse = vbYes Then
        OnSave
        'Se la registrazione non è andata a buon fine esce
        If Not m_Saved Then
            Exit Sub
        End If
    End If
    If iResponse <> vbCancel Then
       Select Case Tipo
           Case SRCNEXT
               SearchNext
           Case SRCPREVIOUS
               SearchPrevious
       End Select
       m_Changed = False
       ActivateBarButtons BTN_SAVE, False
    End If
End Sub

'**+
'Nome: OnRepositionDocumentsLink
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando di riposizionamento del record corrente
'per i DocumentsLink
'**/
Private Sub OnRepositionDocumentsLink(ByVal DocumentsLink As DmtDocManLib.DocumentsLink)

End Sub

'**+
'Nome: OnChangeView
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando ChangeView
'**/
Private Sub OnChangeView(ByVal sToolName As String)
    Dim iResponse   As Integer
    
    If Not BrwMain.Visible And m_Changed Then
        iResponse = ChooseAboutSaving
        
        If iResponse = vbYes Then
            OnSave
            'Se la registrazione non è andata a buon fine esce
            If Not m_Saved Then
                Exit Sub
            End If
        End If
        
        If iResponse <> vbCancel Then
            'cbc 20/04/1999
            'se si è scelto NO ripulisce i campi e va in modalità tabellare annullando
            'le ultime modifiche
            RefreshFormFields
            ChangeView sToolName
            m_Changed = False
        End If
    Else
        ChangeView sToolName
    End If
    
End Sub

'**+
'Nome: OnToolBarOptions
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando ToolBar
'
'
'**/
Private Sub OnToolBarOptions()
    Dim dlgToolBars As frmToolBars
    Dim bVisible As Boolean
    
    On Error Resume Next
    
    Set dlgToolBars = New frmToolBars
    'Imposta un riferimento al form chiamante
    Set dlgToolBars.FormClient = Me
    dlgToolBars.Show vbModal, Me
    Set dlgToolBars = Nothing
    
    'All'uscita dal form di dialogo la visibilità della toolbar dei filtri dipende dalla
    'visibilità del Riquadro attività e dall'impostazione fatta nel dialogo.
    bVisible = GetSetting(REGISTRY_KEY, TheApp.Name & "Settings", "Riquadro attività", True)
    BarMenu.RecalcLayout
End Sub

'**+
'Nome: OnOptions
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando Option
'**/
Private Sub OnOptions()
    Dim dlgOption As frmOption
    
    Set dlgOption = New frmOption
    Set dlgOption.FormClient = Me
    dlgOption.Show vbModal, Me
    
    
    Set dlgOption = Nothing
    
    'Impedisce il 'blocco' della Toolbar alla chiusura di un form di dialogo.
    'BarMenu.ResetHooks
End Sub

'**+
'Nome: OnInfo
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando Info
'**/
Private Sub OnInfo()
    Dim dlgInfo As frmInformazioni
    
    Set dlgInfo = New frmInformazioni
    dlgInfo.Show vbModal, Me
    
    'Impedisce il 'blocco' della Toolbar alla chiusura di un form di dialogo.
    BarMenu.ResetHooks
End Sub

'**+
'Nome: OnPrint
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando Print
'**/
Private Sub OnPrint(ByVal ToolName As String)
    Dim lFlags As Long
    Dim OLDCursor As Integer
    Dim sStr As String
    Dim Field As DmtDocManLib.Field
    
    
    OLDCursor = Screen.MousePointer
    
    'Se il filtro attivo è "Nessun record" è possibile eseguire una stampa/esportazione soltanto se
    'si è in modalità form. In tal caso, infatti, verrà passato al Crystals Reports un filtro
    'creato ad hoc sull'ID del record attuale.
    If m_ActiveFilter.NothingSelected And BrwMain.Visible Then
        sStr = "Impossibile effettuare l'operazione richiesta." & vbCrLf
        sStr = sStr & "Prima di procedere occorre eseguire un filtro."
        sbMsgInfo sStr, m_App.FunctionName
        Screen.MousePointer = OLDCursor
        Exit Sub
    End If
    
    'Se non esiste un report attivo occorre annullare l'operazione.
    If Len(oReportsActivity.SelectedReportName) > 0 Then
        Set m_Report = m_DocType.Reports.Item(oReportsActivity.SelectedReportName)
    End If
    If m_Report Is Nothing Then
        sbMsgError "Impossibile eseguire - Nessun report predefinito.", m_App.FunctionName
        GoTo OnPrint_Exit
    End If
    m_iNumeroCopieDefault = m_Report.Copies
    m_OrientamentoDefault = m_Report.Orientation
    
    
    'Se è attivo il pulsante Salva deve essere visualizzato un messaggio di avviso
    'con i pulsanti OK e annulla (occorre salvare PRIMA della stampa)
    If m_Changed Then
        Select Case ChooseAboutSavingOkCancel
            Case vbOK
                OnSave
                'Se la registrazione non è andata a buon fine esce
                If Not m_Saved Then
                    GoTo OnPrint_Exit
                End If
                
            Case vbCancel
                GoTo OnPrint_Exit
        End Select
    End If
    If Not BrwMain.Visible Then
        'Modalità Form - deve stampare solo il record corrente
        
        'Ripulisce la collezione Fields dell'oggetto DocType.
        For Each Field In m_DocType.Fields
            Field.Value = Empty
        Next
        
        'Viene inserita la condizione di ricerca basata sull'ID del record corrente.
        m_DocType.Fields("ID" & m_App.TableName).Value = m_Document.Fields("ID" & m_App.TableName).Value
        
        'Viene creato un filtro temporaneo per il Crystals Reports.
        m_DocType.RemoveFilter "Form"
        Set m_Report.Filter = m_DocType.AddFilterWithConditions("Form")
    Else
        'Modalità vista tabellare
        
        'Viene passato il filtro corrente al Crystals Reports.
        Set m_Report.Filter = m_ActiveFilter
    End If
            
    
    Select Case ToolName
    
        Case "PrePrint", "Mnu_PrePrint"
            On Error GoTo ErrorHandler
            
            Screen.MousePointer = vbHourglass
            
            m_TabMode = BrwMain.Visible
            PicForm.Visible = False
            BrwMain.Visible = False
            ActivityBox.Visible = False
            
            SetStatus4Modality Preview, OpenPrw
            Refresh
            
            m_PreviewWindowHandle = m_Document.Preview(m_Report, "", hwnd, CInt(BarMenu.ClientAreaLeft / Screen.TwipsPerPixelX), CInt(BarMenu.ClientAreaTop / Screen.TwipsPerPixelY), CInt(BarMenu.ClientAreaWidth / Screen.TwipsPerPixelX), CInt(BarMenu.ClientAreaHeight / Screen.TwipsPerPixelY), False)
            lFlags = SWP_NOSIZE Or SWP_NOREPOSITION Or SWP_NOMOVE
            SetWindowPos m_PreviewWindowHandle, HWND_TOP, 0, 0, 0, 0, lFlags
            
        Case "Print", "Mnu_Print"
            PrintDocument ToolName
            
        Case "ExportWord", "Mnu_ExportWord"
            ExportDocument ecWord
            fnExtractNameFromTag BarMenu.Bands("Standard").Tools("Export"), Word, TheApp.Name

        Case "ExportExcel", "Mnu_ExportExcel"
            ExportDocument ecExcel
            fnExtractNameFromTag BarMenu.Bands("Standard").Tools("Export"), Excel, TheApp.Name
            
        Case "ExportHtml", "Mnu_ExportHtml"
            ExportDocument ecHtml
            fnExtractNameFromTag BarMenu.Bands("Standard").Tools("Export"), HTML, TheApp.Name
        
        Case "ExportPDF", "Mnu_ExportPDF"
            ExportDocument ecPdf
            fnExtractNameFromTag BarMenu.Bands("Standard").Tools("Export"), PDF, TheApp.Name
        
        Case "MailWord"
            SendDocument ecWord
            
        Case "MailExcel"
            SendDocument ecExcel
            
        Case "MailHtml"
            SendDocument ecHtml
        
        Case "MailPDF"
            SendDocument ecPdf
    End Select
    
   
OnPrint_Exit:
    Set Field = Nothing
    Screen.MousePointer = OLDCursor
    Exit Sub
    
ErrorHandler:
    Const ERROR_PRINTING_ABORTED = 3
    Const ERROR_PRINTING_CANCELLED = 4
    Select Case Err.Number
        Case 20507
            'Errore "Invalid file Name" generato quando non è possibile trovare il file .rpt
            sbMsgInfo "File di report non trovato", m_App.FunctionName
        Case ERROR_PRINTING_ABORTED, ERROR_PRINTING_CANCELLED
            'non deve far niente, è stato già segnalato da CrystalReport
        Case Else
            If Len(Trim(Err.Description)) > 0 Then
                sbMsgInfo Err.Description, m_App.FunctionName
            End If
    End Select

    'Si è verificato un errore durante la procedura di anteprima.
    Screen.MousePointer = OLDCursor
    
    'Ripristina la situazione del form
    m_PreviewWindowHandle = 0
    PicForm.Visible = True

    BrwMain.Visible = m_TabMode
    ActivityBox.Visible = BarMenu.Bands("Band_View").Tools("Mnu_Folders").Checked
    FormRecalcLayout
    'SetStatus4Modality Preview, 0 'ClosePrw
        
    Set Field = Nothing
    
    
End Sub


'**+
'Nome: OnNewSearch
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando NewSearch
'**/
Private Sub OnNewSearch()
    Dim iResponse As Integer

    m_FilterSelected = False
    
    If Not m_Changed Then
        NewSearch
    Else
        'cbc 20/04/1999
        'deve mostrare il messaggio con Si, No, Annulla
        iResponse = ChooseAboutSaving
        If iResponse = vbYes Then
            OnSave
            'Se la registrazione non è andata a buon fine esce
            If Not m_Saved Then
                Exit Sub
            End If
        End If
        If iResponse <> vbCancel Then
            'se si è scelto NO ripristina i dati precedenti annullando le ultime modifiche
            'e predispone la modalità ricerca.
            RefreshFormFields
            NewSearch
            m_Changed = False
        End If
    
    End If
    
    
    
End Sub

'**+
'Nome: OnNew
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando New
'**/
Private Sub OnNew(ByVal sToolName As String)
    
    Select Case DoNewDocument
        Case vbYes
            'Si è risposto affermativamente alla
            'richiesta di Update delle modifiche apportate
            OnSave
            'Se la registrazione non è andata a buon fine esce
            If Not m_Saved Then
                Exit Sub
            End If
            NewRecord
            
        Case vbCancel
            'Si è risposto Annulla alla richiesta di Update
            Exit Sub
            
        Case Else
            'Si è premuto il tasto <No> alla richiesta di Update
            NewRecord
    End Select
End Sub

'**+
'Nome: OnNewDocumentsLink
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando New per i documentslink
'**/
Private Sub OnNewDocumentsLink(ByVal DocumentsLink As DmtDocManLib.DocumentsLink)

End Sub

'**+
'Nome: OnSummary
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando Summary
'**/
Private Sub OnSummary()
    Dim lRes As Long
    
    lRes = WinHelp(hwnd, App.HelpFile, HELP_FINDER, 0)
End Sub

'**+
'Nome: OnFastHelp
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando FastHelp
'**/
Private Sub OnFastHelp()
    frmMain.WhatsThisMode
End Sub

'**+
'Nome: OnHelpOnLine
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando HelpOnLine
'**/
Private Sub OnHelpOnLine()
    Dim lRes As Long
    
    If Not ActiveControl Is Nothing Then
        If ActiveControl.HelpContextID <> 0 Then
            lRes = WinHelp(hwnd, App.HelpFile, HELP_CONTEXT, ActiveControl.HelpContextID)
        Else
            ExecuteMenuCommand "Mnu_Arg"
        End If
    End If
End Sub

'**+
'Nome: OnArg
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando Arg
'**/
Private Sub OnArg()
    Dim lRes As Long
    
    If m_App.ContextHelpID <> 0 Then
        lRes = WinHelp(hwnd, App.HelpFile, HELP_CONTEXT, m_App.ContextHelpID)
    Else
        ExecuteMenuCommand "Mnu_Summary"
    End If
End Sub

'**+
'Nome: OnViewAssistant
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando ViewAssistant
'**/
Private Sub OnViewAssistant()
    BarMenu.Bands("Band_Assistant").Tools("Mnu_ViewAssistant").Checked = Not BarMenu.Bands("Band_Assistant").Tools("Mnu_ViewAssistant").Checked
    If BarMenu.Bands("Band_Assistant").Tools("Mnu_ViewAssistant").Checked Then
   Else
    End If
End Sub

'**/
'Autore                 : Diamante S.p.a
'
'Nome                   : OnFolders
'
'Parametri:
'
'
'Valori di ritorno:
'
'Funzionalità:
'Permette la visualizzazione o meno del DocTypeExplorer e della relativa toolbar.
'**/
Private Sub OnFolders()
    ActivityBox.Visible = Not ActivityBox.Visible
    BarMenu.Bands("Band_View").Tools("Mnu_Folders").Checked = ActivityBox.Visible
    FormRecalcLayout
    
    BarMenu.RecalcLayout
End Sub

'**+
'Nome: OnRunApplication
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Operazioni sul comando RunApplication
'**/
Private Sub OnRunApplication(ByVal sToolName As String)


End Sub




Private Function fncListinoDefault() As Long
    Dim sSQL As String
    Dim rs As DmtOleDbLib.adoResultset
    
    sSQL = "Select IDListinoDiBase From ConfigurazioneVendite Where IDAzienda=" & m_App.IDFirm
    
    Set rs = Cn.OpenResultset(sSQL)
    If rs.EOF = False Then
        fncListinoDefault = rs!IDListinoDiBase
    
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End Function









Private Sub BarMenu_BandClose(ByVal Band As ActiveBar3LibraryCtl.Band)
     'Se la banda è una Toolbar allora viene registrata la chiusura.
    If Band.Type = ddBTNormal And Band.Name <> BAND_CLOSE_PREVIEW Then
        
        'Salva nel registry l'impostazione sulla visibilità della toolbar
        AppOptions.ToolbarVisibility(Band.Name) = False
        
    End If
End Sub

Private Sub BarMenu_BandMove(ByVal Band As ActiveBar3LibraryCtl.Band)
    Form_Resize
End Sub

Private Sub BarMenu_BandOpen(ByVal Band As ActiveBar3LibraryCtl.Band, ByVal Cancel As ActiveBar3LibraryCtl.ReturnBool)
     'Se la banda è una Toolbar allora viene registrata l'apertura.
    If Band.Type = ddBTNormal And Band.Name <> BAND_CLOSE_PREVIEW Then
        AppOptions.ToolbarVisibility(Band.Name) = True
    End If
End Sub

Private Sub BarMenu_MenuItemEnter(ByVal Tool As ActiveBar3LibraryCtl.Tool)
    WriteStatusBar Tool.Description
End Sub

Private Sub BarMenu_MenuItemExit(ByVal Tool As ActiveBar3LibraryCtl.Tool)
    WriteStatusBar ""
End Sub

Private Sub BarMenu_MouseEnter(ByVal Tool As ActiveBar3LibraryCtl.Tool)
    WriteStatusBar Tool.Description
End Sub

Private Sub BarMenu_MouseExit(ByVal Tool As ActiveBar3LibraryCtl.Tool)
    WriteStatusBar ""
End Sub

Private Sub BrwMain_ConditionEdit(ByVal Name As String, Value As Variant)
    Dim oSearch As dmtFind.Find
    Dim sSQL As String
    Dim oRes As DmtOleDbLib.adoResultset

    'Crea un'istanza dell'oggetto Find
    Set oSearch = New dmtFind.Find
    
    'Assegna la connessione aperta
    oSearch.Database = TheApp.Database.Connection

If Name = "Socio o Fornitore" Then
    'La Caption della finestra di ricerca
    oSearch.Caption = "Anagrafica"

    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Anagrafica" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    oSearch.AddDisplayField "Anagrafica", "Anagrafica", 1 'STRINGTYPE
    oSearch.AddDisplayField "Nome", "Nome", 1   'STRINGTYPE
 
    'Assegna la condizione iniziale
    oSearch.Start = Value

    'Query SQL con cui effettuare le ricerche in base dati.
    sSQL = "SELECT Anagrafica.IDAnagrafica, Anagrafica.Anagrafica, Anagrafica.Nome "
    sSQL = sSQL & "FROM Anagrafica INNER JOIN "
    sSQL = sSQL & "Fornitore ON Anagrafica.IDAnagrafica = Fornitore.IDAnagrafica "
    sSQL = sSQL & "WHERE Fornitore.IDAzienda=" & TheApp.IDFirm
    'sSQL = sSQL & "Anagrafica.IDCategoriaAnagrafica=" & Link_TipoSocio & " "
    sSQL = sSQL & " ORDER BY Anagrafica"

    'Assegnazione della query di ricerca
    oSearch.SQL = sSQL
    
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
    Set oRes = oSearch.Exec
    
    If Not oRes.EOF Then
        'Riporta il valore della riga selezionata nella maschera del filtro
             
        Value = oRes("Anagrafica")
                
    End If
End If
If Name = "Codice socio" Then
    'La Caption della finestra di ricerca
    oSearch.Caption = "Codice"

    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Anagrafica" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    oSearch.AddDisplayField "Codice", "Codice", 1 'STRINGTYPE
    oSearch.AddDisplayField "Anagrafica", "Anagrafica", 1   'STRINGTYPE
 
    'Assegna la condizione iniziale
    oSearch.Start = Value

    'Query SQL con cui effettuare le ricerche in base dati.
    sSQL = "SELECT Anagrafica.IDAnagrafica, Fornitore.Codice, Anagrafica.Anagrafica "
    sSQL = sSQL & "FROM Anagrafica INNER JOIN "
    sSQL = sSQL & "Fornitore ON Anagrafica.IDAnagrafica = Fornitore.IDAnagrafica "
    sSQL = sSQL & "WHERE Fornitore.IDAzienda=" & TheApp.IDFirm
    'sSQL = sSQL & "Anagrafica.IDCategoriaAnagrafica=" & Link_TipoSocio & " "
    sSQL = sSQL & " ORDER BY Anagrafica"

    'Assegnazione della query di ricerca
    oSearch.SQL = sSQL
    
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
    Set oRes = oSearch.Exec
    
    If Not oRes.EOF Then
        'Riporta il valore della riga selezionata nella maschera del filtro
             
        Value = oRes("Codice")
                
    End If
End If
If Name = "Codice articolo" Then
    'La Caption della finestra di ricerca
    oSearch.Caption = "Codice articolo"

    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Comune" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    oSearch.AddDisplayField "Codice", "CodiceArticolo", 1 'STRINGTYPE
    oSearch.AddDisplayField "Descrizione", "Articolo", 1   'STRINGTYPE
 
    'Assegna la condizione iniziale
    oSearch.Start = Value

    'Query SQL con cui effettuare le ricerche in base dati.
    sSQL = "SELECT IDArticolo, CodiceArticolo, Articolo "
    sSQL = sSQL & "FROM Articolo "
    sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
    sSQL = sSQL & " ORDER BY CodiceArticolo"

    'Assegnazione della query di ricerca
    oSearch.SQL = sSQL
    
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
    Set oRes = oSearch.Exec
    
    If Not oRes.EOF Then
        'Riporta il valore della riga selezionata nella maschera del filtro
             
        Value = oRes("CodiceArticolo")
                
    End If
End If
If Name = "Articolo" Then
    'La Caption della finestra di ricerca
    oSearch.Caption = "Descrizione articolo"

    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Comune" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    oSearch.AddDisplayField "Descrizione", "Articolo", 1   'STRINGTYPE
    oSearch.AddDisplayField "Codice", "CodiceArticolo", 1 'STRINGTYPE
 
    'Assegna la condizione iniziale
    oSearch.Start = Value

    'Query SQL con cui effettuare le ricerche in base dati.
    sSQL = "SELECT IDArticolo, CodiceArticolo, Articolo "
    sSQL = sSQL & "FROM Articolo "
    sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
    sSQL = sSQL & " ORDER BY Articolo"

    'Assegnazione della query di ricerca
    oSearch.SQL = sSQL
    
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
    Set oRes = oSearch.Exec
    
    If Not oRes.EOF Then
        'Riporta il valore della riga selezionata nella maschera del filtro
             
        Value = oRes("Articolo")
                
    End If
End If
If Name = "Codice lotto" Then
    'La Caption della finestra di ricerca
    oSearch.Caption = "Codice lotto"

    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Comune" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    oSearch.AddDisplayField "Codice", "CodiceLotto", 1   'STRINGTYPE
    oSearch.AddDisplayField "Descrizione", "DescrizioneLotto", 1 'STRINGTYPE
 
    'Assegna la condizione iniziale
    oSearch.Start = Value

    'Query SQL con cui effettuare le ricerche in base dati.
    sSQL = "SELECT IDRV_POCaricoMerceRighe, CodiceLotto, DescrizioneLotto "
    sSQL = sSQL & "FROM RV_POCaricoMerceRighe INNER JOIN "
    sSQL = sSQL & "RV_POCaricoMerceTesta ON RV_POCaricoMerceRighe.IDRV_POCaricoMerceTesta = RV_POCaricoMerceTesta.IDRV_POCaricoMerceTesta "
    sSQL = sSQL & "WHERE RV_POCaricoMerceTesta.IDAzienda=" & TheApp.IDFirm
    sSQL = sSQL & " ORDER BY CodiceLotto"

    'Assegnazione della query di ricerca
    oSearch.SQL = sSQL
    
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
    Set oRes = oSearch.Exec
    
    If Not oRes.EOF Then
        'Riporta il valore della riga selezionata nella maschera del filtro
             
        Value = oRes("CodiceLotto")
                
    End If
End If

If Name = "Descrizione lotto" Then
    'La Caption della finestra di ricerca
    oSearch.Caption = "Descrizione lotto"

    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Comune" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    oSearch.AddDisplayField "Descrizione", "DescrizioneLotto", 1 'STRINGTYPE
    oSearch.AddDisplayField "Codice", "CodiceLotto", 1   'STRINGTYPE
 
    'Assegna la condizione iniziale
    oSearch.Start = Value

    'Query SQL con cui effettuare le ricerche in base dati.
    sSQL = "SELECT IDRV_POCaricoMerceRighe, CodiceLotto, DescrizioneLotto "
    sSQL = sSQL & "FROM RV_POCaricoMerceRighe INNER JOIN "
    sSQL = sSQL & "RV_POCaricoMerceTesta ON RV_POCaricoMerceRighe.IDRV_POCaricoMerceTesta = RV_POCaricoMerceTesta.IDRV_POCaricoMerceTesta "
    sSQL = sSQL & "WHERE RV_POCaricoMerceTesta.IDAzienda=" & TheApp.IDFirm
    sSQL = sSQL & " ORDER BY DescrizioneLotto"

    'Assegnazione della query di ricerca
    oSearch.SQL = sSQL
    
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
    Set oRes = oSearch.Exec
    
    If Not oRes.EOF Then
        'Riporta il valore della riga selezionata nella maschera del filtro
             
        Value = oRes("DescrizioneLotto")
                
    End If
End If


    Set oRes = Nothing
    Set oSearch = Nothing

End Sub

Private Function RecuperaSegnoPerDisponibilita(IDFunzione) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset


    sSQL = "SELECT Funzione.Funzione, ProcessoPerFunzione.IDProcesso, ProcessoPerFunzione.IDFunzione,"
    sSQL = sSQL & "ContatoreArticoloPerMagazzino.PartecipaGiacenza, ContatoreArticoloPerMagazzino.PartecipaDisponibilita, Processo.Processo,"
    sSQL = sSQL & "ContatorePerProcesso.IDProcessoPerFunzione, ContatorePerProcesso.Numero,ContatorePerProcesso.Quantita,"
    sSQL = sSQL & "ContatorePerProcesso.Valore, ContatorePerProcesso.DataVariazione, ContatoreArticolo.ContatoreArticolo, Processo.IDTipoProcesso,"
    sSQL = sSQL & "ContatoreArticoloPerMagazzino.IDMagazzino "
    sSQL = sSQL & "FROM ContatoreArticolo LEFT OUTER JOIN "
    sSQL = sSQL & "ContatoreArticoloPerMagazzino ON "
    sSQL = sSQL & "ContatoreArticolo.IDContatoreArticolo = ContatoreArticoloPerMagazzino.IDContatoreArticolo RIGHT OUTER JOIN "
    sSQL = sSQL & "Funzione INNER JOIN "
    sSQL = sSQL & "ProcessoPerFunzione ON Funzione.IDFunzione = ProcessoPerFunzione.IDFunzione INNER JOIN "
    sSQL = sSQL & "Processo ON ProcessoPerFunzione.IDProcesso = Processo.IDProcesso LEFT OUTER JOIN "
    sSQL = sSQL & "ContatorePerProcesso ON ProcessoPerFunzione.IDProcessoPerFunzione = ContatorePerProcesso.IDProcessoPerFunzione ON "
    sSQL = sSQL & "ContatoreArticolo.IDContatoreArticolo = ContatorePerProcesso.IDContatoreArticolo "
    sSQL = sSQL & "WHERE (Processo.IDTipoProcesso = 2) And (ProcessoPerFunzione.IDFunzione =" & IDFunzione & ") And (ContatoreArticoloPerMagazzino.IDMagazzino = " & Me.cboMagazzinoConf.CurrentID & ")"


Set rs = Cn.OpenResultset(sSQL)
    
If rs.EOF Then
    RecuperaSegnoPerDisponibilita = ""
Else
    Select Case fnNotNull(rs!PartecipaDisponibilita)
        Case "-"
            RecuperaSegnoPerDisponibilita = "-"
        Case "+"
            RecuperaSegnoPerDisponibilita = "+"
        Case ""
            RecuperaSegnoPerDisponibilita = ""
    End Select
End If

rs.CloseResultset
Set rs = Nothing
End Function

Private Sub cboCalibro_Click()
    Me.txtCalibroInLiguaPred.Text = GET_DESCRIZIONE_CALIBRO_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.cboCalibro.CurrentID)
    Me.txtCalibroInLingua.Text = GET_DESCRIZIONE_CALIBRO_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.cboCalibro.CurrentID)

End Sub





Private Sub cboDestinazione_Click()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

'''''''''''''''''''''''DESTINAZIONE MERCE ORDINE'''''''''''''''''''''''''''
sSQL = "SELECT SitoPerAnagrafica.IDSitoPerAnagrafica, SitoPerAnagrafica.IDTipoSito, SitoPerAnagrafica.SitoPerAnagrafica, SitoPerAnagrafica.IDNazione, "
sSQL = sSQL & "SitoPerAnagrafica.IDComune, SitoPerAnagrafica.Indirizzo, SitoPerAnagrafica.Cap, SitoPerAnagrafica.Telefono, SitoPerAnagrafica.Fax, Comune.Comune,"
sSQL = sSQL & "Provincia.Provincia , Nazione.Nazione "
sSQL = sSQL & "FROM Nazione RIGHT OUTER JOIN "
sSQL = sSQL & "SitoPerAnagrafica ON Nazione.IDNazione = SitoPerAnagrafica.IDNazione LEFT OUTER JOIN "
sSQL = sSQL & "Provincia RIGHT OUTER JOIN "
sSQL = sSQL & "Comune ON Provincia.IDProvincia = Comune.IDProvincia ON SitoPerAnagrafica.IDComune = Comune.IDComune "
sSQL = sSQL & "WHERE SitoPerAnagrafica.IDSitoPerAnagrafica=" & Me.cboDestinazione.CurrentID
Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    DESTINAZIONE_MERCE = ""
    DESTINAZIONE_INDIRIZZO = ""
    DESTINAZIONE_COMUNE = ""
    DESTINAZIONE_PROVINCIA = ""
    DESTINAZIONE_CAP = ""
    DESTINAZIONE_TELEFONO = ""
    DESTINAZIONE_FAX = ""
    DESTINAZIONE_NAZIONE = ""
Else
    DESTINAZIONE_MERCE = fnNotNull(rs!SitoPerAnagrafica)
    DESTINAZIONE_INDIRIZZO = fnNotNull(rs!Indirizzo)
    DESTINAZIONE_COMUNE = fnNotNull(rs!Comune)
    DESTINAZIONE_PROVINCIA = fnNotNull(rs!Provincia)
    DESTINAZIONE_CAP = fnNotNull(rs!Cap)
    DESTINAZIONE_TELEFONO = fnNotNull(rs!Telefono)
    DESTINAZIONE_FAX = fnNotNull(rs!Fax)
    DESTINAZIONE_NAZIONE = fnNotNull(rs!Nazione)

End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Me.cboListino.WriteOn GET_LISTINO_DEFAULT(Me.cdCliente.KeyFieldID, Me.cboDestinazione.CurrentID)

End Sub

Private Sub cboLinguaCliente_Click()
    
    Me.txtDescrizioneArticoloInLinguaCliente.Text = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.CDArticolo.KeyFieldID)
    Me.txtCategoriaInLingua.Text = GET_DESCRIZIONE_CATEGORIA_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.cboTipoCategoria.CurrentID)
    Me.txtCalibroInLingua.Text = GET_DESCRIZIONE_CALIBRO_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.cboCalibro.CurrentID)
    Me.txtDescrizioneImballoInLinguaCliente = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.CDImballoPrimario.KeyFieldID)
    DESCR_IMB_PRIM_LINGUA_CLIENTE = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.CDImballoPrimario.KeyFieldID)
End Sub

Private Sub cboLinguaPred_Click()
    
    Me.txtArticoloInLinguaPred.Text = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.CDArticolo.KeyFieldID)
    Me.txtCategoriaInLinguaPred.Text = GET_DESCRIZIONE_CATEGORIA_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.cboTipoCategoria.CurrentID)
    Me.txtCalibroInLiguaPred.Text = GET_DESCRIZIONE_CALIBRO_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.cboCalibro.CurrentID)
    DESCR_IMB_LINGUA_PRED = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.CDCodiceImballo.KeyFieldID)
    DESCR_IMB_PRIM_LINGUA_PRED = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.CDImballoPrimario.KeyFieldID)
    
End Sub

Private Sub cboMagazzinoConf_Click()
    If Not (BrwMain.Visible) Then Change
End Sub

Private Sub CboMagazzinoVend_Change()
    If Not (BrwMain.Visible) Then Change
End Sub

Private Sub cboReport_Click()
    Me.cboStampa.Text = Get_TrovaStampante(Me.cboReport.CurrentID)
End Sub



Private Sub cboReportNew_Click()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT NomeReport, DataUltimaModifica, OraUltimaModifica, Larghezza_X,Altezza_Y, Orientamento "
sSQL = sSQL & "FROM RV_POConfigurazioneEtichetta "
sSQL = sSQL & " WHERE IDRV_POConfigurazioneEtichetta=" & Me.cboReportNew.CurrentID

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.txtNomeReportLavorazione.Text = ""
    Me.txtDataCreazioneReportLavorazione.Text = ""
    Me.txt_X_Lavorazione.Text = 0
    Me.txt_Y_Lavorazione.Text = 0
    Me.txtOrientamentoLavorazione.Text = 0
    Me.txtOraCreazioneReportLavorazione.Text = ""
Else
    Me.txtNomeReportLavorazione.Text = fnNotNull(rs!NomeReport)
    Me.txtDataCreazioneReportLavorazione.Text = fnNotNull(rs!DataUltimaModifica)
    Me.txt_X_Lavorazione.Text = fnNotNullN(rs!Larghezza_X)
    Me.txt_Y_Lavorazione.Text = fnNotNullN(rs!Altezza_Y)
    Me.txtOrientamentoLavorazione.Text = fnNotNullN(rs!Orientamento) + 1
    Me.txtOraCreazioneReportLavorazione.Text = fnNotNull(rs!OraUltimaModifica)
End If

rs.CloseResultset
Set rs = Nothing


''''''''''STAMPANTE PREDEFINITA PER UTENTE
sSQL = "SELECT NomeStampante "
sSQL = sSQL & "FROM RV_POConfigurazioneEtichettaPerUtente "
sSQL = sSQL & " WHERE IDRV_POConfigurazioneEtichetta=" & Me.cboReportNew.CurrentID
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND NomeUtentePC=" & fnNormString(GET_NOMEUTENTE)
sSQL = sSQL & " AND NomePC=" & fnNormString(GET_NOMECOMPUTER)

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.cboStampaNew.Text = ""
Else
    Me.cboStampaNew.Text = fnNotNull(rs!NomeStampante)
End If

rs.CloseResultset
Set rs = Nothing

'''''''''''''''''''''''''''''''''''''''''''
End Sub

Private Sub cboReportPed_Click()
    Me.cboStampantePed.Text = Get_TrovaStampante(Me.cboReportPed.CurrentID)
End Sub

Private Sub cboReportPedNew_Click()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT NomeReport, DataUltimaModifica, OraUltimaModifica, Larghezza_X, Altezza_Y, Orientamento "
sSQL = sSQL & "FROM RV_POConfigurazioneEtichetta "
sSQL = sSQL & " WHERE IDRV_POConfigurazioneEtichetta=" & Me.cboReportPedNew.CurrentID

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.txtNomeReportPedana.Text = ""
    Me.txtDataCreazioneReportPedana.Text = ""
    Me.txt_X_Pedana.Text = ""
    Me.txt_Y_Pedana.Text = ""
    Me.txtOrientamentoPedana.Text = ""
    Me.txtOraCreazioneReportPedana.Text = ""
Else
    Me.txtNomeReportPedana.Text = fnNotNull(rs!NomeReport)
    Me.txtDataCreazioneReportPedana.Text = fnNotNull(rs!DataUltimaModifica)
    Me.txt_X_Pedana.Text = fnNotNullN(rs!Larghezza_X)
    Me.txt_Y_Pedana.Text = fnNotNullN(rs!Altezza_Y)
    Me.txtOrientamentoPedana.Text = fnNotNullN(rs!Orientamento) + 1
    Me.txtOraCreazioneReportPedana.Text = fnNotNull(rs!OraUltimaModifica)
End If

rs.CloseResultset
Set rs = Nothing



''''''''''STAMPANTE PREDEFINITA PER UTENTE
sSQL = "SELECT NomeStampante "
sSQL = sSQL & "FROM RV_POConfigurazioneEtichettaPerUtente "
sSQL = sSQL & " WHERE IDRV_POConfigurazioneEtichetta=" & Me.cboReportPedNew.CurrentID
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND NomeUtentePC=" & fnNormString(GET_NOMEUTENTE)
sSQL = sSQL & " AND NomePC=" & fnNormString(GET_NOMECOMPUTER)

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.cboStampantePedNew.Text = ""
Else
    Me.cboStampantePedNew.Text = fnNotNull(rs!NomeStampante)
End If

rs.CloseResultset
Set rs = Nothing


'''''''''''''''''''''''''''''''''''''''''''
End Sub

Private Sub cboSezionale_Click()
    Link_Sezionale = Me.cboSezionale.CurrentID
    Me.txtNumeroDocumento.Value = fnGetNumeroDocumento
    If Not (BrwMain.Visible) Then Change
End Sub

Private Sub cboTipoCategoria_Click()
    Me.txtCategoriaInLinguaPred.Text = GET_DESCRIZIONE_CATEGORIA_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.cboTipoCategoria.CurrentID)
    Me.txtCategoriaInLingua.Text = GET_DESCRIZIONE_CATEGORIA_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.cboTipoCategoria.CurrentID)

End Sub



Private Sub cboUM_Click()
On Error GoTo ERR_cboUM_Click
    Link_UnitaDiMisura_Coop = fnGetUMCoop(Me.cboUM.CurrentID)
    
    Select Case Link_UnitaDiMisura_Coop
        Case 1
            txtColli_Change
        Case 2
            txtPesoLordo_Change
        Case 3
            txtPesoNetto_Change
        Case 4
            txtTara_LostFocus
        Case 5
            txtPezzi_Change
    End Select
    
    txtColli_LostFocus

Exit Sub
ERR_cboUM_Click:
    MsgBox Err.Description, vbCritical, "cboUM_Click"
End Sub
Private Sub cboUM_Q_Click()
    Link_UnitaDiMisura_Coop_Q = fnGetUMCoop(Me.cboUM_Q.CurrentID)
End Sub

Private Sub cboUtente_Click()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Descrizione "
sSQL = sSQL & "FROM Utente "
sSQL = sSQL & "WHERE IDUtente=" & Me.cboUtente.CurrentID

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.txtCodicePostazione.Text = ""
Else
    Me.txtCodicePostazione.Text = fnNotNull(rs!Descrizione)
End If

rs.CloseResultset
Set rs = Nothing
End Sub

Private Sub GET_INFO_VETTORE(IDVettore As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

'''''''''''''''''''''''DESTINAZIONE MERCE ORDINE'''''''''''''''''''''''''''
sSQL = "SELECT Vettore.IDVettore, Vettore.IDComune, Vettore.IDNazione, Vettore.Vettore, Vettore.Indirizzo, Vettore.CAP, Vettore.Fax, Vettore.Telefono, Vettore.PartitaIva, "
sSQL = sSQL & "Vettore.NumeroAlbo , Comune.Comune, Provincia.Provincia, Nazione.Nazione "
sSQL = sSQL & "FROM Provincia RIGHT OUTER JOIN "
sSQL = sSQL & "Comune ON Provincia.IDProvincia = Comune.IDProvincia RIGHT OUTER JOIN "
sSQL = sSQL & "Vettore ON Comune.IDComune = Vettore.IDComune LEFT OUTER JOIN "
sSQL = sSQL & "Nazione ON Vettore.IDNazione = Nazione.IDNazione "
sSQL = sSQL & "WHERE Vettore.IDVettore=" & IDVettore

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    VETTORE = ""
    VETTORE_INDIRIZZO = ""
    VETTORE_COMUNE = ""
    VETTORE_PROVINCIA = ""
    VETTORE_CAP = ""
    VETTORE_TELEFONO = ""
    VETTORE_FAX = ""
    VETTORE_NAZIONE = ""
    VETTORE_PARTITA_IVA = ""
    VETTORE_NUMERO_ALBO = ""
Else
    VETTORE = fnNotNull(rs!VETTORE)
    VETTORE_INDIRIZZO = fnNotNull(rs!Indirizzo)
    VETTORE_COMUNE = fnNotNull(rs!Comune)
    VETTORE_PROVINCIA = fnNotNull(rs!Provincia)
    VETTORE_CAP = fnNotNull(rs!Cap)
    VETTORE_TELEFONO = fnNotNull(rs!Telefono)
    VETTORE_FAX = fnNotNull(rs!Fax)
    VETTORE_NAZIONE = fnNotNull(rs!Nazione)
    VETTORE_PARTITA_IVA = fnNotNull(rs!PartitaIva)
    VETTORE_NUMERO_ALBO = fnNotNull(rs!NumeroAlbo)

End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
End Sub

Private Sub CDArticolo_ChangeElement()
On Error Resume Next
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsFunc As DmtOleDbLib.adoResultset
Dim Link_CausaleMovimentoScarto As Long
Dim Link_Lotto As Long
Dim LINK_TIPO_PESO_LORDO_ARTICOLO_LOCAL As Long
Dim AvviaRicalcoloRiga As Long

If CDArticolo.KeyFieldID > 0 Then
    Me.TxtArticolo.Text = Me.CDArticolo.Description
    
    sSQL = "SELECT IDUnitaDiMisuraAcquisto, IDUnitaDiMisuraVendita, RV_POIDImballoVendita, RV_POIDCalibro, "
    sSQL = sSQL & "IDTipoProdotto, RV_POIDTipoCategoria, RV_POIDUnitaDiMisuraLiq, "
    sSQL = sSQL & "RV_POQuantitaPerCollo, RV_POMoltiplicatore, PesoNetto, RV_POIDTipoPesoArticolo "
    sSQL = sSQL & "FROM Articolo WHERE IDArticolo=" & Me.CDArticolo.KeyFieldID
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF = False Then
        If ((IsNull(m_DocumentsLink("IDArticolo").Value)) Or (fnNotNullN(m_DocumentsLink("IDArticolo").Value) <> Me.CDArticolo.KeyFieldID)) Then
            If GET_ARTICOLO_ANNULLATO(Me.CDArticolo.KeyFieldID) = True Then
                MsgBox "ATTENZIONE!!!" & vbCrLf & "L'articolo selezionato è stato bloccato e pertanto non può essere utilizzato", vbInformation, "Inserimento dati"
                Me.TxtArticolo.Text = ""
                Me.CDArticolo.Load 0
            Exit Sub
            End If
        End If
        
        Link_UnitaDiMisura_Acquisto = IIf(IsNull(rs!IDUnitaDiMisuraAcquisto), 0, rs!IDUnitaDiMisuraAcquisto)
        Me.cboUM.WriteOn fnNotNullN(rs!IDUnitaDiMisuraVendita)
        
        
        If (fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0) Then
            If Me.txtIDRigaOrdine.Value = 0 Then
                If Me.CDCodiceImballo.KeyFieldID = 0 Then
                    Me.CDCodiceImballo.Load fnNotNullN(rs!RV_POIDImballoVendita)
                End If
            End If
        Else
            If Me.CDCodiceImballo.KeyFieldID = 0 Then
                Me.CDCodiceImballo.Load fnNotNullN(rs!RV_POIDImballoVendita)
            End If
        End If
        

        Link_TipoProdotto = fnNotNullN(rs!IDTipoProdotto)
        Me.cboCalibro.WriteOn fnNotNullN(rs!RV_POIDCalibro)
        Me.cboTipoCategoria.WriteOn fnNotNullN(rs!RV_POIDTipoCategoria)
        LINK_UM_LIQUIDAZIONE = fnNotNullN(rs!RV_POIDUnitaDiMisuraLiq)
        
        LINK_TIPO_PESO_LORDO_ARTICOLO_LOCAL = fnNotNullN(rs!RV_POIDTipoPesoArticolo)
        VARIETA_ARTICOLO_LAVORATO = GET_VARIETA_ARTICOLO(Me.CDArticolo.KeyFieldID)
        FAMIGLIA_ARTICOLO_LAVORATO = GET_FAMIGLIA_ARTICOLO(Me.CDArticolo.KeyFieldID)
        GET_CERTIFICAZIONE_FAM_PER_ETI_LAV fnNotNullN(m_Document("IDAnagrafica").Value), Me.CDArticolo.KeyFieldID
        TIPO_PRODOTTO_ARTICOLO_LAVORATO = GET_DESCRIZIONE_TIPO_PRODOTTO_ARTICOLO(Me.CDArticolo.KeyFieldID)
        CATEGORIA_MERCEOLOGICA_ARTICOLO_LAVORATO = GET_CATEGORIA_MERCEOLOGICA_ARTICOLO(Me.CDArticolo.KeyFieldID)
        Me.txtCodBarreArtAzienda.Text = GET_CODICEABARRE(Me.CDArticolo.KeyFieldID)
        Me.txtDescrCodBarreArtAzienda.Text = GET_DESCRIZIONECODICEABARRE(Me.CDArticolo.KeyFieldID)
        ParametroPesoArticolo
        If LINK_TIPO_PESO_LORDO_ARTICOLO_LOCAL = 0 Then
            ParametroPesoArticolo
            'TIPO_PESO_ARTICOLO = 0
        Else
            TIPO_PESO_ARTICOLO = LINK_TIPO_PESO_LORDO_ARTICOLO_LOCAL
        End If
        If (PESO_TOTALE_PEDANA_DA_PROD > 0) Then
            TIPO_PESO_ARTICOLO = 1
        End If
        SegnoMovimentoScarto = "-"
        
        If ((IsNull(m_DocumentsLink("IDArticolo").Value)) Or (fnNotNullN(m_DocumentsLink("IDArticolo").Value) <> Me.CDArticolo.KeyFieldID)) Then
            AvviaRicalcoloRiga = 1
            
            If (NON_RICALCOLARE_ALLE_MODIFICHE = 1) Then
                If (bLoadingDaProcesso = False) Then
                    If (fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) > 0) Then
                        AvviaRicalcoloRiga = 0
                    End If
                End If
            End If

            
            If (AvviaRicalcoloRiga = 1) Then
                
                QUANTITA_PER_COLLO = fnNotNullN(rs!RV_POQuantitaPerCollo)
                PESO_LORDO_ARTICOLO = fnNotNullN(rs!PesoNetto)
                MOLTIPLICATORE = fnNotNullN(rs!RV_POMoltiplicatore)
                
                If Me.txtIDRigaOrdine.Value = 0 Then
                    If Me.CDCodiceImballo.KeyFieldID = 0 Then
                        GET_IMBALLO_PER_ARTICOLO_CONF Me.CDArticolo.KeyFieldID
                    End If
                End If
                If m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value <= 0 Then
                    Me.txtColli.Value = 1
                    If Me.CDCodiceImballo.KeyFieldID > 0 Then
                        If Me.txtIDRigaOrdine.Value = 0 Then
                            Me.txtColli.Value = GET_COLLI_PER_IMBALLO(Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.CDCodiceImballo.KeyFieldID)
                        End If
                    End If
                End If
                If TIPO_PESO_ARTICOLO <= 1 Then
                    Me.txtPesoLordo.Value = PESO_LORDO_ARTICOLO * Me.txtColli.Value
                Else
                    Me.txtPesoNetto.Value = PESO_LORDO_ARTICOLO
                    Me.txtPesoLordo.Value = Me.txtPesoNetto.Value + Me.txtTara.Value
                End If
            
                txtColli_LostFocus
                
                If QUANTITA_PER_COLLO = 0 Then
                    Me.txtPezzi.Value = 0
                End If
            
            End If
            
            Me.txtArticoloInLinguaPred.Text = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.CDArticolo.KeyFieldID)
            Me.txtDescrizioneArticoloInLinguaCliente.Text = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.CDArticolo.KeyFieldID)
            
            If (AvviaRicalcoloRiga = 1) Then
                If LAVORAZIONE_AUTOMATICA = 0 Then
                    If Me.txtIDRigaOrdine.Value = 0 Then
                        If Flag_GestioneArticoli = True Then
                            If rs!IDTipoProdotto = Link_TipoGrezzo Then
                                MsgBox "Si sta inserendo un prodotto di tipo grezzo", vbInformation, "Inserimento articoli"
                            End If
                            fnEsistenzaArticoloDerivato
                            If Bool_EsistenzaArticoloDerivato = False Then
                                MsgBox "L'articolo selezionato non è un prodotto derivato dall'articolo " & m_Document("Articolo").Value, vbInformation, "Esistenza articoli derivati"
                            End If
                            
                        End If
                    End If
                End If
            End If
            If Me.CboTipoLavorazione.CurrentID = 0 Then
                Me.CboTipoLavorazione.WriteOn fnGetTipoLavorazione
                If AGGIORNA_TIPO_LAVORAZIONE = 1 Then
                    If Me.cboTipoLavConf.CurrentID > 0 Then
                        Me.CboTipoLavorazione.WriteOn Me.cboTipoLavConf.CurrentID
                    End If
                End If
            End If
            
            Me.txtDataLavorazione.Value = Date
            
        End If
    
    End If
End If

rs.CloseResultset
Set rs = Nothing
    
Link_TipoPassaportoArticolo = GET_LINK_TIPO_PASS_ARTICOLO(Me.CDArticolo.KeyFieldID, Link_Tipo_Passaporto_Azienda)

If Link_TipoPassaportoArticolo = 2 Then
    Me.txtNumeroProtocollo.Enabled = True
Else
    Me.txtNumeroProtocollo.Enabled = False
    Me.txtNumeroProtocollo.Value = 0
End If

GET_INFO_CLIENTE Me.cdCliente.KeyFieldID
GET_IMBALLO_CODICE_A_BARRE_CLIENTE Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID
GET_ARTICOLO_CODICE_A_BARRE_CLIENTE Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID

Me.cboReportNew.WriteOn GET_DEFAULT_REPORT_NEW(1)
Me.cboReportPedNew.WriteOn GET_DEFAULT_REPORT_NEW(2)

If BrwMain.GuiMode <> dgFilterDefinition Then
    If (Me.CDArticolo.KeyFieldID > 0) And (Me.TxtArticolo.Text <> "") Then
        If Me.CDCodiceImballo.KeyFieldID = 0 Then
            Me.CDCodiceImballo.SetFocus
        Else
            'Me.txtColli.SetFocus
        End If
    End If
End If
End Sub

Private Sub CDArticolo_Q_ChangeElement()
On Error Resume Next
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsFunc As DmtOleDbLib.adoResultset
Dim Link_CausaleMovimentoScarto As Long
Dim Link_Lotto As Long

    If CDArticolo_Q.KeyFieldID > 0 Then
        If ((IsNull(m_DocumentsLink1("IDArticolo").Value)) Or (fnNotNullN(m_DocumentsLink1("IDArticolo").Value) <> Me.CDArticolo_Q.KeyFieldID)) Then
            If GET_ARTICOLO_ANNULLATO(Me.CDArticolo_Q.KeyFieldID) = True Then
                MsgBox "ATTENZIONE!!!" & vbCrLf & "L'articolo selezionato è stato bloccato e pertanto non può essere utilizzato", vbInformation, "Inserimento dati"
                Me.TxtArticolo_Q.Text = ""
                Me.CDArticolo_Q.Load 0
            Exit Sub
            End If
        End If
        Me.TxtArticolo_Q.Text = Me.CDArticolo_Q.Description
        
        sSQL = "SELECT IDUnitaDiMisuraVendita, IDTipoProdotto, RV_POIDTipoLavorazione "
        sSQL = sSQL & "FROM Articolo WHERE IDArticolo=" & Me.CDArticolo_Q.KeyFieldID
        
        Set rs = Cn.OpenResultset(sSQL)
        
        If rs.EOF = False Then
            Me.cboUM_Q.WriteOn fnNotNullN(rs!IDUnitaDiMisuraVendita)
            Link_TipoProdotto_Q = fnNotNullN(rs!IDTipoProdotto)
            If Me.CDArticolo_Q.KeyFieldID <> fnNotNullN(m_DocumentsLink1("IDArticolo").Value) Then
                Me.CboTipoLavorazione_Q.WriteOn fnNotNullN(rs!RV_POIDTipoLavorazione)
            End If
        End If

        rs.CloseResultset
        Set rs = Nothing
    End If
    
    If fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey).Value) <= 0 Then
    
        Me.txtDataLavorazione_Q.Value = Date
        
        CalcoloScarto
        
    End If
    
    
    
End Sub

Private Sub cdCliente_ChangeElement()
On Error Resume Next
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

''''''''''''''''''LINGUA DESCRIZIONE ARTICOLI''''''''''''''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT IDLinguaDescrizioneArticoli "
sSQL = sSQL & "FROM Cliente "
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDAnagrafica=" & Me.cdCliente.KeyFieldID

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.cboLinguaCliente.WriteOn GET_LINK_LINGUA_PREDEFINITA
Else
    If fnNotNullN(rs!IDLinguaDescrizioneArticoli) > 0 Then
        Me.cboLinguaCliente.WriteOn fnNotNullN(rs!IDLinguaDescrizioneArticoli)
    Else
        Me.cboLinguaCliente.WriteOn GET_LINK_LINGUA_PREDEFINITA
    End If
End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''''''GENERALITA CLIENTE'''''''''''''''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT Cliente.IDAnagrafica, Cliente.IDAzienda, Anagrafica.PartitaIva, Anagrafica.Anagrafica, Anagrafica.Indirizzo, Anagrafica.Cap, Anagrafica.EMailInterno, "
sSQL = sSQL & "Anagrafica.Fax , Anagrafica.EMailInternet, Anagrafica.Telefono, Comune.Comune, Provincia.Provincia, Regione.Regione, Nazione.Nazione, Anagrafica.Nome "
sSQL = sSQL & "FROM Provincia LEFT OUTER JOIN "
sSQL = sSQL & "Regione ON Provincia.IDRegione = Regione.IDRegione RIGHT OUTER JOIN "
sSQL = sSQL & "Comune ON Provincia.IDProvincia = Comune.IDProvincia RIGHT OUTER JOIN "
sSQL = sSQL & "Anagrafica INNER JOIN "
sSQL = sSQL & "Cliente ON Anagrafica.IDAnagrafica = Cliente.IDAnagrafica ON Comune.IDComune = Anagrafica.IDComune LEFT OUTER JOIN "
sSQL = sSQL & "Nazione ON Anagrafica.IDNazione = Nazione.IDNazione "
sSQL = sSQL & "WHERE Cliente.IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND Cliente.IDAnagrafica=" & Me.cdCliente.KeyFieldID

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    CLIENTE_NOME = ""
    CLIENTE_INDIRIZZO = ""
    CLIENTE_COMUNE = ""
    CLIENTE_REGIONE = ""
    CLIENTE_NAZIONE = ""
    CLIENTE_CAP = ""
    CLIENTE_PROVINCIA = ""
    CLIENTE_TELEFONO = ""
    CLIENTE_FAX = ""
    CLIENTE_EMAIL = ""
    CLIENTE_INDIRIZZOWEB = ""
    CLIENTE_PARTITA_IVA = ""
Else
    CLIENTE_NOME = fnNotNull(rs!Nome)
    CLIENTE_INDIRIZZO = fnNotNull(rs!Indirizzo)
    CLIENTE_COMUNE = fnNotNull(rs!Comune)
    CLIENTE_REGIONE = fnNotNull(rs!Regione)
    CLIENTE_NAZIONE = fnNotNull(rs!Nazione)
    CLIENTE_CAP = fnNotNull(rs!Cap)
    CLIENTE_PROVINCIA = fnNotNull(rs!Provincia)
    CLIENTE_TELEFONO = fnNotNull(rs!Telefono)
    CLIENTE_FAX = fnNotNull(rs!Fax)
    CLIENTE_EMAIL = fnNotNull(rs!EMailInterno)
    CLIENTE_INDIRIZZOWEB = fnNotNull(rs!EMailInternet)
    CLIENTE_PARTITA_IVA = fnNotNull(rs!PartitaIva)
End If


rs.CloseResultset
Set rs = Nothing

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

With Me.cboDestinazione
    Set .Database = TheApp.Database.Connection
    .AddFieldKey "IDSitoPerAnagrafica"
    .DisplayField = "SitoPerAnagrafica"
    .SQL = "SELECT * FROM SitoPerAnagrafica WHERE IDAnagrafica=" & Me.cdCliente.KeyFieldID
    .Fill
End With

GET_INFO_CLIENTE Me.cdCliente.KeyFieldID
'Me.chkPrezzoInclusoImballo.Value = GET_PREZZO_IMBALLO_INCLUSO(Me.CDCodiceImballo.KeyFieldID, Me.cdCliente.KeyFieldID)
Me.chkPrezzoInclusoImballo.Value = GET_PREZZO_IMBALLO_INCLUSO_2(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cdCliente.KeyFieldID)
GET_IMBALLO_CODICE_A_BARRE_CLIENTE Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID
GET_ARTICOLO_CODICE_A_BARRE_CLIENTE Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID
GET_IMBALLO_PRIM_CODICE_A_BARRE_CLIENTE Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID

Me.cboReportNew.WriteOn GET_DEFAULT_REPORT_NEW(1)
Me.cboReportPedNew.WriteOn GET_DEFAULT_REPORT_NEW(2)

Me.txtDescrizioneArticoloInLinguaCliente.Text = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.CDArticolo.KeyFieldID)
Me.txtCategoriaInLingua.Text = GET_DESCRIZIONE_CATEGORIA_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.cboTipoCategoria.CurrentID)
Me.txtCalibroInLingua.Text = GET_DESCRIZIONE_CALIBRO_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.cboCalibro.CurrentID)

Me.cboListino.WriteOn GET_LINK_LISTINO

'If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
    GET_ARTICOLO_CODICE_PEDANA Me.cdCliente.KeyFieldID, fnGetEsercizio(Me.txtDataLavorazione.Text)
'End If

If Me.cdCliente.KeyFieldID = 0 Then
    Me.txtDataOrdine.Value = 0
    Me.txtNumeroOrdine.Value = 0
End If

If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
    If Me.txtIDOrdineCliente.Value = 0 Then
        If Me.cdCliente.KeyFieldID > 0 Then
            If FORZA_LINK_ORDINE = False Then
                AVVIO_RICERCA_ORDINE = True
                cmdSelezionaOrdine_Click
                AVVIO_RICERCA_ORDINE = False
            End If
        End If
    End If
End If

End Sub

Private Sub CDCodiceImballo_ChangeElement()
On Error Resume Next
Dim AvviaRicalcoloRiga As Long
    
    AvviaRicalcoloRiga = 1
    
    If (NON_RICALCOLARE_ALLE_MODIFICHE = 1) Then
        If (bLoadingDaProcesso = False) Then
            AvviaRicalcoloRiga = 0
        End If
    End If
    
    If B_LOADING_RIGA = False Then
        If COPIA_RIGA_COME_NUOVO = 0 Then
            If IDIMBALLO_SEL <> Me.CDCodiceImballo.KeyFieldID Then
                CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
                
                IDIMBALLO_SEL = Me.CDCodiceImballo.KeyFieldID
            End If
        End If
    End If
    
    If Me.CDCodiceImballo.KeyFieldID > 0 Then
        If ((IsNull(m_DocumentsLink("IDImballoVendita").Value)) Or (fnNotNullN(m_DocumentsLink("IDImballoVendita").Value) <> Me.CDCodiceImballo.KeyFieldID)) Then
            If GET_ARTICOLO_ANNULLATO(Me.CDCodiceImballo.KeyFieldID) = True Then
                MsgBox "ATTENZIONE!!!" & vbCrLf & "L'articolo selezionato è stato bloccato e pertanto non può essere utilizzato", vbInformation, "Inserimento dati"
                Me.txtImballo.Text = ""
                Me.CDCodiceImballo.Load 0
                Me.CDCodiceImballo.SetFocus
            Exit Sub
            End If
        End If
        
        Me.txtImballo.Text = Me.CDCodiceImballo.Description
        Me.cboUMImballo.WriteOn GET_LINK_UM_ARTICOLO(Me.CDCodiceImballo.KeyFieldID)
        Me.chkTracciaImballoGest.Value = GET_TRACCIABILITA_IMBALLO(Me.CDCodiceImballo.KeyFieldID)
        
        
        If B_LOADING_LOTTO_IMBALLO = False Then
            RECUPERO_DATI_GIACENZA_LOTTO_IMBALLO Me.CDCodiceImballo.KeyFieldID, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value), Me.chkLottoUtilizzoEsclusivo.Value
        End If
        
        If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
            If Me.txtColli.Value <= 1 Then
                Me.txtColli.Value = GET_COLLI_PER_IMBALLO(Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.CDCodiceImballo.KeyFieldID)
            End If
            If COPIA_RIGA_COME_NUOVO = 0 Then
                If Me.txtIDRigaOrdine.Value = 0 Then
                    GET_CONFEZIONI_IMBALLO_PER_ARTICOLO Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID
                End If
            End If
        End If
        
        Me.txtCodBarreImbAzienda.Text = GET_CODICEABARRE(Me.CDCodiceImballo.KeyFieldID)
        Me.txtDescrCodBarreImbAzienda.Text = GET_DESCRIZIONECODICEABARRE(Me.CDCodiceImballo.KeyFieldID)
        Me.txtTaraUnitaria.Value = fnGetTaraImballo
        Me.txtDescrizioneImballoInLinguaCliente = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.CDCodiceImballo.KeyFieldID)
        DESCR_IMB_LINGUA_PRED = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.CDImballoPrimario.KeyFieldID)
        
        'Me.chkPrezzoInclusoImballo.Value = GET_PREZZO_IMBALLO_INCLUSO(Me.CDCodiceImballo.KeyFieldID, Me.cdCliente.KeyFieldID)
        Me.chkPrezzoInclusoImballo.Value = GET_PREZZO_IMBALLO_INCLUSO_2(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cdCliente.KeyFieldID)
        
        GET_IMBALLO_CODICE_A_BARRE_CLIENTE Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID
        
        txtColli_LostFocus
        
        'Me.txtDataLavorazione.SetFocus

    Else
        Me.txtImballo.Text = ""
        Me.cboUMImballo.WriteOn 0
        Me.txtTaraUnitaria.Value = 0
        Me.chkTracciaImballoGest.Value = 0
        Me.chkConfermaDaUtente.Value = 0
    End If

End Sub
Private Function GET_COLLI_PER_IMBALLO(IDPedana As Long, IDTipoPedana As Long, IDArticoloImballo As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim LOCAL_QUANTITA As Double
Dim LOCAL_QUANTITA_LAVORATA As Double
Dim Testo As String

sSQL = "SELECT Quantita FROM RV_POTipoPedanaImballo "
sSQL = sSQL & "WHERE IDRV_POTipoPedana=" & IDTipoPedana
sSQL = sSQL & " AND IDArticolo=" & IDArticoloImballo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    LOCAL_QUANTITA = 0
Else
    LOCAL_QUANTITA = fnNotNullN(rs!Quantita)
End If

rs.CloseResultset
Set rs = Nothing


If LOCAL_QUANTITA = 0 Then
    GET_COLLI_PER_IMBALLO = LOCAL_QUANTITA
    Exit Function
End If


sSQL = "SELECT SUM(Colli) AS NumeroColli "
sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
sSQL = sSQL & " WHERE IDRV_POPedana=" & IDPedana
'sSQL = sSQL & " AND IDImballoVendita=" & IDArticoloImballo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    LOCAL_QUANTITA_LAVORATA = 0
Else
    LOCAL_QUANTITA_LAVORATA = fnNotNullN(rs!NumeroColli)
End If

rs.CloseResultset
Set rs = Nothing

If LOCAL_QUANTITA - LOCAL_QUANTITA_LAVORATA < 0 Then
    If Me.BrwMain.Visible = False Then
        Testo = "ATTENZIONE!!!" & vbCrLf
        Testo = Testo & "La quantita max da utilizzare per questo tipo di pedana è " & LOCAL_QUANTITA & "." & vbCrLf
        Testo = Testo & "Fino ad adesso in questa pedana risultano esserci " & LOCAL_QUANTITA_LAVORATA & vbCrLf
        Testo = Testo & "Continuare ad utilizzare questa pedana?"
    
        If MsgBox(Testo, vbQuestion + vbYesNo, "Pedana X imballo") = vbNo Then
            GET_COLLI_PER_IMBALLO = 0
        Else
            GET_COLLI_PER_IMBALLO = 0
        End If
    Else
        GET_COLLI_PER_IMBALLO = 0
    End If
Else
    GET_COLLI_PER_IMBALLO = LOCAL_QUANTITA - LOCAL_QUANTITA_LAVORATA
End If

End Function
Private Function GET_LINK_UM_ARTICOLO(IDArticolo) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDUnitaDiMisuraVendita FROM Articolo "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_UM_ARTICOLO = 0
Else
    GET_LINK_UM_ARTICOLO = fnNotNullN(rs!IDUnitaDiMisuraVendita)
End If

rs.CloseResultset
Set rs = Nothing
End Function



Private Sub CDCodiceImballo_Q_ChangeElement()
On Error Resume Next
    If Me.CDCodiceImballo_Q.KeyFieldID > 0 Then
        If ((IsNull(m_DocumentsLink1("IDImballoVendita").Value)) Or (fnNotNullN(m_DocumentsLink1("IDImballoVendita").Value) <> Me.CDCodiceImballo_Q.KeyFieldID)) Then
            If GET_ARTICOLO_ANNULLATO(Me.CDCodiceImballo_Q.KeyFieldID) = True Then
                MsgBox "ATTENZIONE!!!" & vbCrLf & "L'articolo selezionato è stato bloccato e pertanto non può essere utilizzato", vbInformation, "Inserimento dati"
                Me.txtImballo_Q.Text = ""
                Me.CDCodiceImballo_Q.Load 0
            Exit Sub
            End If
        End If
        
        Me.txtImballo_Q.Text = Me.CDCodiceImballo_Q.Description
        'If (m_DocumentsLink1("Tara").Value = 0) Or IsNull(m_DocumentsLink1("Tara").Value) Then
        'If ((IsNull(m_DocumentsLink1("IDImballoVendita").Value)) Or (fnNotNullN(m_DocumentsLink1("IDImballoVendita").Value) <> Me.CDCodiceImballo_Q.KeyFieldID)) Then
            Me.txtTaraUnitaria_Q.Value = fnGetTaraImballo_Q
        'End If
        'End If
    End If
    
    'Me.txtColli_Q.SetFocus
End Sub

Private Sub CDImballoPrimario_ChangeElement()
'On Error GoTo ERR_CDImballoPrimario_ChangeElement
On Error Resume Next
    If B_LOADING_RIGA = False Then
        If COPIA_RIGA_COME_NUOVO = 0 Then
            If IDIMBALLOPRIM_SEL <> Me.CDImballoPrimario.KeyFieldID Then
                CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
                
                IDIMBALLOPRIM_SEL = Me.CDImballoPrimario.KeyFieldID
            End If
        End If
    End If
    
    If Me.CDImballoPrimario.KeyFieldID > 0 Then
        If ((IsNull(m_DocumentsLink("IDImballoPrimario").Value)) Or (fnNotNullN(m_DocumentsLink("IDImballoPrimario").Value) <> Me.CDImballoPrimario.KeyFieldID)) Then
            If GET_ARTICOLO_ANNULLATO(Me.CDImballoPrimario.KeyFieldID) = True Then
                MsgBox "ATTENZIONE!!!" & vbCrLf & "L'articolo selezionato è stato bloccato e pertanto non può essere utilizzato", vbInformation, "Inserimento dati"
                
                Me.CDImballoPrimario.Load 0
                
            Exit Sub
            End If
        End If
        
        DESCR_IMB_PRIM_LINGUA_CLIENTE = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.CDImballoPrimario.KeyFieldID)
        DESCR_A_BARRE_IMB_PRIM_PRED = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.CDImballoPrimario.KeyFieldID)
        
        COD_A_BARRE_IMB_PRIM_PRED = GET_CODICEABARRE(Me.CDImballoPrimario.KeyFieldID)
        DESCR_A_BARRE_IMB_PRIM_PRED = GET_DESCRIZIONECODICEABARRE(Me.CDImballoPrimario.KeyFieldID)
        
        GET_IMBALLO_PRIM_CODICE_A_BARRE_CLIENTE Me.cdCliente.KeyFieldID, Me.CDImballoPrimario.KeyFieldID
        
        Me.chkTracciaImballoGestPrim.Value = GET_TRACCIABILITA_IMBALLO(Me.CDImballoPrimario.KeyFieldID)
        If B_LOADING_LOTTO_IMBALLO_PRIM = False Then
            RECUPERO_DATI_GIACENZA_LOTTO_IMBALLO_PRIM Me.CDImballoPrimario.KeyFieldID, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
        End If
        
        'If PESO_LORDO_ARTICOLO = 0 Then PESO_LORDO_ARTICOLO = GET_PESO_MERCE_IN_CONF(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID)
        


    Else
        Me.chkTracciaImballoGestPrim.Value = 0
        Me.chkConfermaDaUtentePrim.Value = 0
    End If
    
    If ((IsNull(m_DocumentsLink("IDImballoPrimario").Value)) Or (fnNotNullN(m_DocumentsLink("IDImballoPrimario").Value) <> Me.CDImballoPrimario.KeyFieldID)) Then
        GET_PROP_CONFEZIONI Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID
        
        txtColli_LostFocus
    End If

Exit Sub
ERR_CDImballoPrimario_ChangeElement:
    MsgBox Err.Description, vbCritical, "CDImballoPrimario_ChangeElement"
End Sub
Private Sub CDTipoPedana_ChangeElement()
On Error Resume Next
Dim Link_Articolo_Tipo_Pedana As Long

If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
    If Me.CDTipoPedana.KeyFieldID > 0 Then
        Link_Articolo_Tipo_Pedana = GET_LINK_ARTICOLO_TIPO_PEDANA(Me.CDTipoPedana.KeyFieldID)
        If GET_ARTICOLO_ANNULLATO(Link_Articolo_Tipo_Pedana) = True Then
            MsgBox "L'articolo collegato al tipo di pedana selezionato risulta annullato", vbInformation, "Inserimento dati"
            Me.CDTipoPedana.Load 0
        End If
    End If
End If

Me.txtPesoPedana.Value = GET_PESO_PEDANA(Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID)

End Sub

Private Sub chkChiusoConferimento_Click()
    If Not (BrwMain.Visible) Then Change
End Sub


Private Sub chkNuovoMetodo_Click()
    If Me.chkNuovoMetodo.Value = 0 Then
        Me.FraEtichette.Visible = False
        Me.FraEtichetteOLD.Visible = True
        'If Me.cmdEspandiGriglia.Visible = True Then
        '    Me.GrigliaCorpo.Height = 2775
        'End If
    Else
        Me.FraEtichette.Visible = True
        Me.FraEtichetteOLD.Visible = False
        'If Me.cmdEspandiGriglia.Visible = True Then
        '    Me.GrigliaCorpo.Height = 2055
        'End If
    End If
End Sub

Private Sub chkPareggiaConferimento_Click()
    If AggiornamentoDocumento = 0 Then
        Change
    End If
End Sub

Private Sub chkSoloLavorazioniPostazione_Click()
Dim m_condition As DmtDocManLib.Condition

If Me.chkSoloLavorazioniPostazione.Value = vbChecked Then
    
    m_DocumentsLink.ClearConditions

    Set m_condition = m_DocumentsLink.AddCondition("IDUtente=" & Me.cboUtente.CurrentID)

Else
    
    m_DocumentsLink.ClearConditions

End If

m_DocumentsLink.Refresh

End Sub

Private Sub chkTracciaImballoGest_Click()
    If Me.chkTracciaImballoGest.Value = 0 Then
        Me.cmdLottoImballo.Enabled = False
    Else
        Me.cmdLottoImballo.Enabled = True
    End If
End Sub

Private Sub cmdAggiornaOrdineCliente_Click()
If Me.chkPreConferimento.Value = vbChecked Then Exit Sub

If Me.txtIDOrdineCliente.Value > 0 Then
    
    NUOVO_ORDINE_LISTA_PRELIEVO = False

    Me.lblLinkOrdine.DisableDoEvents = True
    Me.lblLinkOrdine.IDReturn = Me.txtIDOrdineCliente.Value
    Me.lblLinkOrdine.RunApplication
    
    txtIDOrdineCliente_Change
        
End If



End Sub

Private Sub cmdAggiornaOrdinePadre_Click()

If Me.chkPreConferimento.Value = vbChecked Then Exit Sub
If Me.txtIDOrdinePadre.Value > 0 Then
    
    NUOVO_ORDINE_LISTA_PRELIEVO = False
    
    Me.lblLinkOrdine.DisableDoEvents = True
    Me.lblLinkOrdine.IDReturn = Me.txtIDOrdinePadre.Value
    Me.lblLinkOrdine.RunApplication
   
End If


End Sub

Private Sub cmdAltriDatiLav_Click()
    frmAltriDatilavorazione.Show vbModal
    txtColli_LostFocus
End Sub

Private Sub cmdAnalizzaOrdine_Click()
On Error GoTo ERR_cmdAnalizzaOrdine_Click
    If Me.chkPreConferimento.Value = vbChecked Then Exit Sub
    
    If Me.txtIDOrdinePadre.Value > 0 Then
        LINK_ORDINE_SELEZIONATO = Me.txtIDOrdinePadre.Value
        LINK_ART_ORD_PADRE_SEL = 0
        frmAnalizzaOrdine.Show vbModal
    End If
Exit Sub
ERR_cmdAnalizzaOrdine_Click:
    MsgBox Err.Description, vbCritical, "cmdAnalizzaOrdine_Click"
End Sub

Private Sub cmdAnalizzaPedana_Click()
    
    If Me.chkPreConferimento.Value = vbChecked Then Exit Sub
    frmAnalizzaPedana.Show vbModal
End Sub

Private Sub cmdApriFrameCliente_Click()
    If Me.FraCliente.Height = 915 Then
        Me.FraCliente.ZOrder 0
        Me.FraCliente.Height = 5235
    Else
        Me.FraCliente.Height = 915
    End If
End Sub

Private Sub cmdApriFrameConferimento_Click()

If Me.FraConferimento.Height = 2295 Then
    Me.ZOrder 0
    Me.FraConferimento.Height = 3255
Else
    Me.FraConferimento.Height = 2295
End If

End Sub

Private Sub cmdApriFrameOrdine_Click()
    If Me.FraOrdineCliente.Height = 1095 Then
        Me.FraOrdineCliente.ZOrder 0
        Me.FraOrdineCliente.Height = 3615
        
    Else
        Me.FraOrdineCliente.Height = 1095
    End If
End Sub

Private Sub cmdArticoliDerivati_Click()
    
Select Case TIPO_COMPORTAMENTO_LAVORAZIONE
    Case 1
       
    Case 2
        If STATO_ORDINE = 2 Then
            MsgBox "Impossibile modificare poichè l'ordine risulta chiuso", vbInformation, "Errore salvataggio"
            Exit Sub
        End If
    Case 3
        If STATO_ORDINE = 1 Then
            MsgBox "Impossibile modificare poichè l'ordine risulta confermato per la vendita", vbInformation, "Errore salvataggio"
            Exit Sub
        End If
    
    Case 4
        If (STATO_ORDINE = 1) Or (STATO_ORDINE = 2) Then
            MsgBox "Impossibile modificare poichè l'ordine risulta confermato per la vendita o è chiuso", vbInformation, "Errore salvataggio"

            Exit Sub
        End If
    Case Else
End Select

    
Link_ArticoloPadre = fnNotNullN(m_Document("IDArticolo").Value)

Me.chkChiusoConferimento.Enabled = False
frmArticoliDerivati.Show vbModal
Me.chkChiusoConferimento.Enabled = True
End Sub

Private Sub cmdAssegnazioneMerce_Click()

If Me.chkPreConferimento.Value = vbChecked Then Exit Sub

    If frmMain.txtIDOrdinePadre.Value > 0 Then
        frmAssegnazioneMerce.Show vbModal
        If (RIGA_ORDINE_SELEZIONATA = 1) Then
            Me.cmdSalva.SetFocus
        End If
    End If

End Sub

Private Sub cmdCalcoloPesi_Click()

 frmPesiMedi.Show

End Sub
Private Sub cmdDuplicaRiga_Click()
Dim LINK_LAV_DA_COPIARE As Long

    If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey)) <= 0 Then Exit Sub
    
    LINK_LAV_DA_COPIARE = fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey))
    
    cmdNuovo_Click
    
    GET_DUPLICA_RIGA LINK_LAV_DA_COPIARE
    
    Me.txtCodicePedana.SetFocus
End Sub

Private Sub cmdElimina_Click()
On Error GoTo ERR_cmdElimina_Click
Dim LINK_LAVORAZIONE As Long
Dim OLD_Cursor  As Long
Dim NumeroRecord As Long
Dim sSQL As String
Dim rsConf As DmtOleDbLib.adoResultset
Dim Testo As String

If CHECK_ABILITAZIONE_DIAMANTE = False Then Exit Sub

OLD_Cursor = Cn.CursorLocation

If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then Exit Sub

If LINK_PROCESSO_RIGA > 0 Then
    Testo = "La riga di lavorazione è stata generata dal processo di IV Gamma"
    MsgBox Testo, vbCritical, "Impossibile eliminare"
    Exit Sub
Else
    If GET_NUMERO_PROCESSI_COLLEGATI(fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)) > 0 Then
        Testo = "La lavorazione è collegata a uno o più processi di IV Gamma"
        MsgBox Testo, vbCritical, "Impossibile eliminare"
        Exit Sub
    End If
End If

txtIDOrdineCliente_Change

If STATO_ORDINE = 3 Then
    MsgBox "Impossibile eliminare poichè l'ordine risulta bloccato da un altro utente", vbCritical, "Controllo salvataggio"
    Exit Sub
End If

'''''''''CONTROLLO DELL'ORDINE BLOCCATO DA GESTORE ORDINE STANDARD''''''''''''''''''''''''''''''''''
sSQL = "SELECT * FROM Semaforo "
sSQL = sSQL & "WHERE IDOggetto=" & Me.txtIDOrdineCliente.Value
sSQL = sSQL & " AND IDTipoOggetto=" & 15
sSQL = sSQL & "  AND IDFunzione=" & 128

Set rsConf = Cn.OpenResultset(sSQL)
If Not rsConf.EOF Then
    MsgBox "L'ordine è bloccato dall'utente " & GET_UTENTE(rsConf!IDUtente), vbCritical, "Impossibile aggiornare ordine"

    rsConf.CloseResultset
    Set rsConf = Nothing
    Exit Sub
End If

rsConf.CloseResultset
Set rsConf = Nothing
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'''''''''CONTROLLO DELL'ORDINE BLOCCATO DA GESTORE ORDINE GREEN TOP'''''''''''''''''''''''''''''''''''''
sSQL = "SELECT * FROM Semaforo "
sSQL = sSQL & "WHERE IDOggetto=" & Me.txtIDOrdineCliente.Value
sSQL = sSQL & " AND IDTipoOggetto=" & fnGetTipoOggetto("RV_POOrdineL")
sSQL = sSQL & "  AND IDFunzione=" & GET_FUNZIONE_PER_TIPO_OGGETTO(fnGetTipoOggetto("RV_POOrdineL"))

Set rsConf = Cn.OpenResultset(sSQL)
If Not rsConf.EOF Then
    MsgBox "L'ordine è bloccato dall'utente " & GET_UTENTE(rsConf!IDUtente), vbCritical, "Impossibile aggiornare ordine"
    rsConf.CloseResultset
    Set rsConf = Nothing
    
    Exit Sub
End If

rsConf.CloseResultset
Set rsConf = Nothing
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''



Select Case TIPO_COMPORTAMENTO_LAVORAZIONE
    Case 1
       
    Case 2
        If STATO_ORDINE = 2 Then
            MsgBox "Impossibile eliminare poichè l'ordine risulta chiuso", vbInformation, "Errore salvataggio"
            Exit Sub
        End If
    Case 3
        If STATO_ORDINE = 1 Then
            MsgBox "Impossibile eliminare poichè l'ordine risulta confermato per la vendita", vbInformation, "Errore salvataggio"
            Exit Sub
        End If
    
    Case 4
        If (STATO_ORDINE = 1) Or (STATO_ORDINE = 2) Then
            MsgBox "Impossibile eliminare poichè l'ordine risulta confermato per la vendita o è chiuso", vbInformation, "Errore salvataggio" '
            Exit Sub
        End If
    Case Else
End Select

If MsgBox("Eliminare la riga selezionata?", vbInformation + vbYesNo, "Eliminazione riga") = vbNo Then Exit Sub

If GET_CONTROLLA_ESISTENZA_COLLEGAMENTO(fnNotNullN(m_Document(m_Document.PrimaryKey).Value), m_DocType.ID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)) = True Then
    MsgBox "Impossibile eliminare poichè la lavorazione di questo conferimento risulta legato al flusso della tracciabilità", vbInformation, "Eliminazione lavorazione"
    Exit Sub
End If
If Me.chkPreConferimento.Value = vbChecked Then
    'CONTROLLO DELLA RIGA MERCE COLLEGATA SE E' MOVIMENTATA IN LAVORAZIONE E IN VENDITA
    'Se è movimentata allora non si può eliminare la riga
    'Altrimenti
    'Prendere il riferimento della riga merce collegata ed eliminare dal conferimento e eliminare dal movimento
    
    If GET_CONTROLLO_DELETE_RIGA_PRE_CONF(fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)) = True Then
        MsgBox "Impossibile eliminare poichè la lavorazione di questo conferimento risulta legato al flusso della tracciabilità", vbInformation, "Eliminazione lavorazione"
        Exit Sub
    End If

End If

Screen.MousePointer = 11

frmAttesa.Show
Me.Enabled = False


Me.Caption = "RIPRISTINO LOTTI IMBALLO...."
DoEvents

RIPRISTINO_LOTTI_DA_MOVIMENTO fnNotNullN(m_Document(m_Document.PrimaryKey).Value), m_DocType.ID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)


OLD_Cursor = Cn.CursorLocation
Cn.CursorLocation = adUseClient

Me.Caption = "ELIMINAZIONE IN CORSO MOVIMENTI...."
DoEvents

frmAttesa.lblInfo = Me.Caption
DoEvents

LINK_LAVORAZIONE = fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)

If EliminaMovimento(LINK_LAVORAZIONE) = False Then

    Unload frmAttesa
    Me.Enabled = True
    Me.SetFocus
    
    Cn.CursorLocation = OLD_Cursor
    
    MsgBox "Ci sono stati dei problemi ad eliminare i movimenti della riga di lavorazione." & vbCrLf & "Tentare di eliminare di nuovo la riga di lavorazione", vbCritical, "Eliminazione riga"
    
    Screen.MousePointer = 0
    Me.Caption = Caption2Display(False)

    Exit Sub

End If

Me.Caption = "ELIMINAZIONE IN CORSO LAVORAZIONE...."
DoEvents

frmAttesa.lblInfo = Me.Caption
DoEvents

Cn.BeginTrans

m_DocumentsLink.Delete

Cn.CommitTrans

DELETE_KIT LINK_LAVORAZIONE
DELETE_CONFERIMENTO_COLLEGATO LINK_LAVORAZIONE

Unload frmAttesa
Me.Enabled = True
Me.SetFocus

Me.Caption = Caption2Display(False)

m_DocumentsLink.Refresh

Cn.CursorLocation = OLD_Cursor

GET_RIEPILOGO_CONFERIMENTO

If VISUALIZZA_ANDAMENTO_ORDINE = 1 Then
    GET_ANDAMENTO_ORDINE Me.txtIDOrdinePadre.Value
    GET_ANDAMENTO_ORDINE_LAVORAZIONE Me.txtIDOrdinePadre.Value, Me.CDArticolo.KeyFieldID, Me.txtRaggrOrd.Text
End If

If Me.GrigliaCorpo.ListIndex > 0 Then
    m_DocumentsLink.Move Me.GrigliaCorpo.ListIndex - 1
End If

Screen.MousePointer = 0
Exit Sub
ERR_cmdElimina_Click:
    Unload frmAttesa
    Me.Enabled = True
    Me.SetFocus
    MsgBox Err.Description, vbCritical, "cmdElimina_Click"
    
    Cn.RollbackTrans
    
    NumeroRecordGriglia = Me.GrigliaCorpo.ListIndex - 1
    
    m_DocumentsLink.Refresh
    
    Cn.CursorLocation = OLD_Cursor
    
    GET_RIEPILOGO_CONFERIMENTO

    If Not (m_DocumentsLink.BOF And m_DocumentsLink.EOF) Then
        m_DocumentsLink.Move NumeroRecordGriglia
    End If

    Screen.MousePointer = 0
    
    Me.Caption = Caption2Display(False)
End Sub

Private Sub cmdElimina_Q_Click()
On Error GoTo ERR_cmdElimina_Click
Dim LINK_LAVORAZIONE As Long
Dim OLD_Cursor  As Long
Dim NumeroRecordGriglia As Long

If CHECK_ABILITAZIONE_DIAMANTE = False Then Exit Sub

OLD_Cursor = Cn.CursorLocation

If fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey).Value) <= 0 Then Exit Sub

If MsgBox("Eliminare la riga selezionata?", vbInformation + vbYesNo, "Eliminazione riga") = vbNo Then Exit Sub

Screen.MousePointer = 11

If Me.chkPreConferimento.Value = vbChecked Then
    'CONTROLLO DELLA RIGA MERCE COLLEGATA SE E' MOVIMENTATA IN LAVORAZIONE E IN VENDITA
    'Se è movimentata allora non si può eliminare la riga
    'Altrimenti
    'Prendere il riferimento della riga merce collegata ed eliminare dal conferimento e eliminare dal movimento
    
    If GET_CONTROLLO_DELETE_RIGA_PRE_CONF(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey).Value), 1) = True Then
        MsgBox "Impossibile eliminare poichè la lavorazione di questo conferimento risulta legato al flusso della tracciabilità", vbInformation, "Eliminazione lavorazione"
        Exit Sub
    End If

End If


frmAttesa.Show
Me.Enabled = False

OLD_Cursor = Cn.CursorLocation
Cn.CursorLocation = adUseClient

Me.Caption = "ELIMINAZIONE IN CORSO MOVIMENTI...."
DoEvents

frmAttesa.lblInfo = Me.Caption
DoEvents


LINK_LAVORAZIONE = fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey).Value)


If EliminaMovimentoQuadraturaPerEliminazioneRiga(LINK_LAVORAZIONE) = False Then
    
    Unload frmAttesa
    Me.Enabled = True
    Me.SetFocus
    
    Cn.CursorLocation = OLD_Cursor
    
    MsgBox "Ci sono stati dei problemi ad eliminare i movimenti della riga di quadratura." & vbCrLf & "Tentare di eliminare di nuovo la riga di quadratura", vbCritical, "Eliminazione riga"
    
    Screen.MousePointer = 0
    Me.Caption = Caption2Display(False)

    Exit Sub

End If

Me.Caption = "ELIMINAZIONE IN CORSO QUADRATURA...."
DoEvents

frmAttesa.lblInfo = Me.Caption
DoEvents


Cn.BeginTrans

m_DocumentsLink1.Delete

Cn.CommitTrans

DELETE_CONFERIMENTO_COLLEGATO LINK_LAVORAZIONE, 1

Unload frmAttesa
Me.Enabled = True
Me.SetFocus

Cn.CursorLocation = OLD_Cursor

GET_RIEPILOGO_CONFERIMENTO

If Me.GrigliaScarti.ListIndex > 0 Then
    m_DocumentsLink1.Move Me.GrigliaScarti.ListIndex - 1
End If

Screen.MousePointer = 0

Me.Caption = Caption2Display(False)
Exit Sub
ERR_cmdElimina_Click:
    
    Unload frmAttesa
    Me.Enabled = True
    Me.SetFocus
    
    MsgBox Err.Description, vbCritical, "cmdElimina_Click"
    
    Cn.RollbackTrans
    
    
    Cn.CursorLocation = OLD_Cursor
    
    GET_RIEPILOGO_CONFERIMENTO
    
    Screen.MousePointer = 0
End Sub

Private Sub cmdEliminaRifOrdine_Click()
Dim Testo As String

    txtIDOrdineCliente_Change
    
    Select Case TIPO_COMPORTAMENTO_LAVORAZIONE
        Case 1
           
        Case 2
            Testo = "ATTENZIONE!!!!" & vbCrLf
            Testo = Testo & "L'ordine risulta chiuso" & vbCrLf
            Testo = Testo & "Se si vuole cambiare l'associazione ad un nuovo ordine è bene sapere che questa operazione potrebbe comportare un mal funzionamento nel proseguio delle attività per questa lavorazione" & vbCrLf
            Testo = Testo & "Continuare?"
            If STATO_ORDINE = 2 Then
                If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo inserimento dati") = vbNo Then Exit Sub
            End If
        Case 3
    
            Testo = "ATTENZIONE!!!!" & vbCrLf
            Testo = Testo & "L'ordine risulta confermato" & vbCrLf
            Testo = Testo & "Se si vuole cambiare l'associazione ad un nuovo ordine è bene sapere che questa operazione potrebbe comportare un mal funzionamento nel proseguio delle attività per questa lavorazione" & vbCrLf
            Testo = Testo & "Continuare?"
            If STATO_ORDINE = 1 Then
                If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo inserimento dati") = vbNo Then Exit Sub
            End If
        
        Case 4
            Testo = "ATTENZIONE!!!!" & vbCrLf
            Testo = Testo & "L'ordine risulta confermato o chiuso" & vbCrLf
            Testo = Testo & "Se si vuole cambiare l'associazione ad un nuovo ordine è bene sapere che questa operazione potrebbe comportare un mal funzionamento nel proseguio delle attività per questa lavorazione" & vbCrLf
            Testo = Testo & "Continuare?"
    
            If (STATO_ORDINE = 1) Or (STATO_ORDINE = 2) Then
                If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo inserimento dati") = vbNo Then Exit Sub
            End If
        Case Else
        
    End Select


Testo = "Sei sicuro di voler eliminare il riferimento all'ordine?"

If MsgBox(Testo, vbQuestion + vbYesNo, "Elimazione riferimento ordine") = vbNo Then Exit Sub

Me.txtIDOrdineCliente.Value = 0
End Sub

Private Sub cmdEliminaRifRigaOrd_Click()
    If Me.txtIDRigaOrdine.Value > 0 Then
        If MsgBox("Sei sicuro di eliminare il riferimento alla riga ordine?", vbQuestion + vbYesNo, "Controllo dati") = vbNo Then Exit Sub
    End If
    
    Me.txtIDRigaOrdine.Value = 0
End Sub
Private Sub cmdEspandiGriglia_Click()
    Me.GrigliaCorpo.Height = 4335
    
    Me.FraEtichette.Visible = False
    Me.FraEtichetteOLD.Visible = False
    
    Me.cmdEspandiGriglia.Visible = False
    Me.cmdRiduciGriglia.Visible = True
    
End Sub

Private Sub cmdLottoImballo_Click()
    CONFERMA_LOTTO_IMBALLO_DA_UTENTE = Me.chkConfermaDaUtente.Value
    
    
    frmLottoImballo.Show vbModal
    
    Me.chkConfermaDaUtente.Value = CONFERMA_LOTTO_IMBALLO_DA_UTENTE
End Sub

Private Sub cmdLottoImballoPrim_Click()
    CONFERMA_LOTTO_IMBALLO_DA_UTENTE_PRIM = Me.chkConfermaDaUtentePrim.Value
    
    frmLottoImballoPrim.Show vbModal
    
    Me.chkConfermaDaUtentePrim.Value = CONFERMA_LOTTO_IMBALLO_DA_UTENTE_PRIM
End Sub

Private Sub cmdNListaPrelievo_Click()
    
    If Me.chkPreConferimento.Value = vbChecked Then Exit Sub

    LINK_ORDINE_PADRE_SEL = 0
    
    If (Me.txtIDOrdinePadre.Value > 0) Then
        LINK_ORDINE_PADRE_SEL = Me.txtIDOrdinePadre.Value
    Else
        frmTrovaOrdinePadre.Show vbModal
        
    End If
    
    If LINK_ORDINE_PADRE_SEL = 0 Then Exit Sub
    
    NUOVO_ORDINE_LISTA_PRELIEVO = True
    
    Me.lblLinkOrdine.DisableDoEvents = True
    Me.lblLinkOrdine.IDReturn = LINK_ORDINE_PADRE_SEL
    Me.lblLinkOrdine.RunApplication
End Sub
Private Sub cmdNuovaPedana_Click()
On Error GoTo ERR_cmdNuovaPedana_Click
Dim X As Long
Dim ErroreCoda As Boolean
Dim sSQL As String



If Me.txtIDPedana.Value > 0 Then
    If MsgBox("Questa riga ha già assegnata una pedana." & vbCrLf & "Vuoi crearla una nuova?", vbYesNo + vbQuestion, "Creazione nuova pedana") = vbNo Then Exit Sub
End If

SCRIVI_CODA_PEDANA 0, fnGetTipoOggetto("RV_POPedana")
APERTURA_FORM_CODA = False = False

Me.Enabled = False

''''''''''''''''''''''''''''''CONTROLLA LA CODA DEI SALVATAGGI'''''''''''''''''''''''''''''
X = 0
ErroreCoda = False
Do
    X = GET_NUMERO_DOCUMENTO_PEDANA(True, fnGetTipoOggetto("RV_POPedana"))
    If X = -1 Then
        X = 1
        ErroreCoda = True
    End If
Loop Until X = 1

If ErroreCoda = True Then
    X = -1
End If

If X = -1 Then
    Me.Enabled = True
    Me.SetFocus
    Me.Caption = Caption2Display
    Screen.MousePointer = 0
    ''''''''''''''''''''ELIMINAZIONE RIGA DI CODA'''''''''''''''''''''''''''''''
    sSQL = "DELETE FROM RV_POTMP "
    sSQL = sSQL & "WHERE IDUtente=" & m_App.IDUser
    'sSQL = sSQL & " AND IDTipoOggetto=" & fnGetTipoOggetto("RV_POPedana")
    Cn.Execute sSQL
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    Exit Sub
End If
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Me.Enabled = True
Me.SetFocus

''''''''''''''''''''ELIMINAZIONE RIGA DI CODA'''''''''''''''''''''''''''''''
sSQL = "DELETE FROM RV_POTMP "
sSQL = sSQL & "WHERE IDUtente=" & m_App.IDUser
'sSQL = sSQL & " AND IDTipoOggetto=" & fnGetTipoOggetto("RV_POPedana")
Cn.Execute sSQL
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'Me.cdCliente.Enabled = True
If LAVORAZIONE_AUTOMATICA = 0 Then
    If Me.CDArticolo.KeyFieldID = 0 Then
        If Flag_GestioneArticoli = True Then
            Link_ArticoloPadre = fnNotNullN(m_Document("IDArticolo").Value)
            Me.chkChiusoConferimento.Enabled = False
            If PREZZI_ARTICOLI_DA_ORDINE = 0 Then
'                If GET_ESISTENZA_ARTICOLI_DERIVATI(fnNotNullN(m_Document("IDArticolo").Value)) = True Then
'                    frmArticoliDerivati.Show vbModal
'                End If
                If GET_ESISTENZA_ARTICOLI_DERIVATI = True Then
                    frmArticoliDerivati.Show vbModal
                End If
            End If
            Me.chkChiusoConferimento.Enabled = True
        End If
        If PREZZI_ARTICOLI_DA_ORDINE = 1 Then
            If VIS_ELENCO_ORD_NEW_PED = 1 Then
                If Me.txtIDOrdineCliente.Value = 0 Then cmdSelezionaOrdine_Click
            End If
            If GET_CONTROLLO_MERCE_IN_ORDINE(Me.txtIDOrdinePadre.Value) = False Then
                If Flag_GestioneArticoli = True Then
                    Link_ArticoloPadre = fnNotNullN(m_Document("IDArticolo").Value)
                    Me.chkChiusoConferimento.Enabled = False
                    
'                    If GET_ESISTENZA_ARTICOLI_DERIVATI(fnNotNullN(m_Document("IDArticolo").Value)) = True Then
'                        frmArticoliDerivati.Show vbModal
'                    End If
                    If GET_ESISTENZA_ARTICOLI_DERIVATI = True Then
                        frmArticoliDerivati.Show vbModal
                    End If
                    Me.chkChiusoConferimento.Enabled = True
                End If
            End If
        End If
    End If
    
    If (Me.CDArticolo.KeyFieldID > 0) And (Me.TxtArticolo.Text <> "") Then
        If Me.CDCodiceImballo.KeyFieldID = 0 Then
            Me.CDCodiceImballo.SetFocus
        Else
            Me.txtColli.SetFocus
        End If
    End If
End If

Exit Sub

ERR_cmdNuovaPedana_Click:
    MsgBox Err.Description, vbCritical, "cmdNuovaPedana_Click"
    Me.Enabled = True
    Me.SetFocus
    ''''''''''''''''''''ELIMINAZIONE RIGA DI CODA'''''''''''''''''''''''''''''''
    sSQL = "DELETE FROM RV_POTMP "
    sSQL = sSQL & "WHERE IDUtente=" & m_App.IDUser
    'sSQL = sSQL & " AND IDTipoOggetto=" & fnGetTipoOggetto("RV_POPedana")
    Cn.Execute sSQL
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
End Sub

Private Sub cmdNuovo_Click()

'On Error GoTo ERR_cmdNuovo_Click
    If Not (m_DocumentsLink.BOF And m_DocumentsLink.EOF) Then
        AggiornamentoDocumento = 1
        
        m_DocumentsLink.MoveLast
    
        If IsNull(m_DocumentsLink("IDArticolo").Value) Then
            m_DocumentsLink.DeleteRowFromBuffer
        End If
        
        AggiornamentoDocumento = 0
    End If
    
    If m_DocumentsLink.TableNew Then
        m_DocumentsLink.AbortNewRow
    End If
    'Crea una nuova riga vuota nel buffer della lavorazione
    
    m_DocumentsLink.NewRow
        
    Me.cmdSalva.Enabled = True
    Me.cmdElimina.Enabled = True
    AVVIO_RICERCA_ORDINE = False
    FORZA_LINK_ORDINE = False
    
    Me.txtGiacLottoImballo.Value = 0
    Me.txtDispLottoImballo.Value = 0
    Me.chkTracciaImballoGest.Value = 0
    
    Me.CDArticolo.Load 0
    PESO_LORDO_ARTICOLO = 0
    Me.CDCodiceImballo.Load 0
    Link_LottoArticolo = 0
    Me.cboUtente.WriteOn m_App.IDUser
    VARIAZIONE_DA_PESATURA = False
    Me.cboLinguaPred.WriteOn GET_LINK_LINGUA_PREDEFINITA
    Me.txtDataLavorazione.Value = Date
    Me.txtNomeMacchina.Text = GET_NOMECOMPUTER
    Me.txtUtenteMacchina.Text = GET_NOMEUTENTE
    Me.txtOraLav.Text = GET_ORARIO(Now)
    Me.txtImportoUnitarioListino.Value = 0
    Me.txtNoteAgg.Text = fnNotNull(m_Document("AnnotazioniAggiuntive").Value)
    
    Me.txtRaggrOrd.Locked = False
    If (ATTIVA_SEL_LOTTO_PROD_IN_LAV = 1) Then
        Me.txtRaggrOrd.Locked = True
        LINK_LOTTO_PROD_LAV = 0
        Me.txtRaggrOrd.Text = GET_DESCRIZIONE_LOTTO_PROD_LAV(LINK_LOTTO_PROD_LAV)
    End If
    
    Set rsKIT = Nothing
    
    If Link_Tipo_Passaporto_Azienda = 2 Then
        If Link_Sezionale_Dettagliato > 0 Then
            Link_Periodo_IVA_Protocollo = GET_PERIODO_IVA_PROTOCOLLO(Me.txtDataLavorazione.Text)
            Numero_Protocollo_Dettagliato = GET_NUMERO_PROTOCOLLO(Link_Sezionale_Dettagliato, Link_Periodo_IVA_Protocollo)
            Me.txtNumeroProtocollo.Value = Numero_Protocollo_Dettagliato
        End If
    End If
    
    Me.cboListino.WriteOn GET_LINK_LISTINO
    
    If LAVORAZIONE_AUTOMATICA = 0 Then
        Me.cmdSelezionaPedana.SetFocus
    End If

    bVariazioneDettaglio = False
Exit Sub
ERR_cmdNuovo_Click:
    MsgBox Err.Description, vbCritical, "Nuovo record"
End Sub
Private Sub cmdNuovo_Q_Click()
    If Not (m_DocumentsLink1.BOF And m_DocumentsLink1.EOF) Then
    
        m_DocumentsLink1.MoveLast
    
        If IsNull(m_DocumentsLink1("IDArticolo").Value) Then
            m_DocumentsLink1.DeleteRowFromBuffer
        End If
        
    End If
    
    If m_DocumentsLink1.TableNew Then
        m_DocumentsLink1.AbortNewRow
    End If
    'Crea una nuova riga vuota nel buffer della lavorazione
    
    m_DocumentsLink1.NewRow
    
    Me.txtQtaLavPrec.Value = 0
    
    Me.txtDataLavorazione_Q.Value = Date
    Me.txtOraLav_Q.Text = GET_ORARIO(Now)
    Me.CDArticolo_Q.SetFocus
    Me.txtSequenzaPrelievo.Value = GET_SEQUENZA_SCARTO(fnNotNullN(m_Document(m_Document.PrimaryKey).Value))
    
    
    If Flag_GestioneArticoli = True Then
        Link_ArticoloPadre = fnNotNullN(m_Document("IDArticolo").Value)
        frmArticoliDerivatiQ.Show vbModal
    End If
End Sub

Private Sub cmdNuovoOrdine_Click()
Dim Testo As String

If Me.chkPreConferimento.Value = vbChecked Then Exit Sub

txtIDOrdineCliente_Change

Select Case TIPO_COMPORTAMENTO_LAVORAZIONE
    Case 1
    
    Case 2
        Testo = "ATTENZIONE!!!!" & vbCrLf
        Testo = Testo & "L'ordine risulta chiuso" & vbCrLf
        Testo = Testo & "Se si vuole cambiare l'associazione ad un nuovo ordine è bene sapere che questa operazione potrebbe comportare un mal funzionamento nel proseguio delle attività per questa lavorazione" & vbCrLf
        Testo = Testo & "Continuare?"
        If STATO_ORDINE = 2 Then
            If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo inserimento dati") = vbNo Then Exit Sub
        End If
    Case 3
        Testo = "ATTENZIONE!!!!" & vbCrLf
        Testo = Testo & "L'ordine risulta confermato" & vbCrLf
        Testo = Testo & "Se si vuole cambiare l'associazione ad un nuovo ordine è bene sapere che questa operazione potrebbe comportare un mal funzionamento nel proseguio delle attività per questa lavorazione" & vbCrLf
        Testo = Testo & "Continuare?"
        If STATO_ORDINE = 1 Then
            If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo inserimento dati") = vbNo Then Exit Sub
        End If
    Case 4
        Testo = "ATTENZIONE!!!!" & vbCrLf
        Testo = Testo & "L'ordine risulta confermato o chiuso" & vbCrLf
        Testo = Testo & "Se si vuole cambiare l'associazione ad un nuovo ordine è bene sapere che questa operazione potrebbe comportare un mal funzionamento nel proseguio delle attività per questa lavorazione" & vbCrLf
        Testo = Testo & "Continuare?"

        If (STATO_ORDINE = 1) Or (STATO_ORDINE = 2) Then
            If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo inserimento dati") = vbNo Then Exit Sub
        End If
    Case Else
    
End Select
    
    Me.txtIDOrdineCliente.Value = 0
    Me.cdCliente.Load 0
    Me.txtDataOrdine.Value = 0
    Me.txtNumeroOrdine.Value = 0
    Me.txtDataPartenza.Value = 0
    
    NUOVO_ORDINE_LISTA_PRELIEVO = False
    
    Me.lblLinkOrdine.DisableDoEvents = True
    Me.lblLinkOrdine.IDReturn = 0
    Me.lblLinkOrdine.RunApplication

    'frmNuovoOrdine.Show vbModal
    
End Sub

Private Sub cmdPesaturaAutomatica_Click()
    
    If Me.txtIDPedana.Value > 0 Then
        VARIAZIONE_DA_PESATURA = False
        frmPesaturaPedana.Show vbModal
        If VARIAZIONE_DA_PESATURA = True Then
            txtColli_LostFocus
            'CalcoloPesoNetto
            Me.cmdSalva.SetFocus
            VARIAZIONE_DA_PESATURA = False
        End If
    End If
End Sub

Private Sub cmdPropEtiLavPro_Click()
If FraPropEtiLavPro.Visible = False Then
    Me.FraPropEtiLavPro.Visible = True
    Me.FraPropEtiPedPro.Visible = False
Else
    Me.FraPropEtiLavPro.Visible = False
End If
End Sub

Private Sub cmdPropEtiPedPro_Click()
If FraPropEtiPedPro.Visible = False Then
    Me.FraPropEtiLavPro.Visible = False
    Me.FraPropEtiPedPro.Visible = True
Else
    Me.FraPropEtiPedPro.Visible = False
End If

End Sub

Private Sub cmdRefreshKit_Click()
On Error GoTo ERR_cmdRefreshKit_Click
    CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    
    frmKIT.Show vbModal
Exit Sub
ERR_cmdRefreshKit_Click:
    MsgBox Err.Description, vbCritical, "ERR_cmdRefreshKit_Click"
End Sub

Private Sub cmdRefreshPrezzoDaOrd_Click()
    If Me.txtIDRigaOrdine.Value = 0 Then
        If PREZZI_ARTICOLI_DA_ORDINE = 0 Then
            GET_CONFIGURAZIONE_IMPORTI_ARTICOLO Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
            GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
        Else
            If (GET_CONFIGURAZIONE_PREZZO_DA_ORDINE(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.txtIDOrdinePadre.Value) = False) Then
                GET_CONFIGURAZIONE_IMPORTI_ARTICOLO Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
                GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
            Else
                If RETURN_SEL_PREZZO_IMB_DA_ORD = 0 Then
                    GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
                End If
            End If
        End If
    Else
        If (GET_CONFIGURAZIONE_PREZZO_DA_ORDINE(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.txtIDOrdinePadre.Value) = False) Then
            GET_CONFIGURAZIONE_IMPORTI_ARTICOLO Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
            GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
        Else
            If RETURN_SEL_PREZZO_IMB_DA_ORD = 0 Then
                GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
            End If
        End If
    End If
End Sub

Private Sub cmdRiduciGriglia_Click()
    'If Me.chkNuovoMetodo.Value = 0 Then
        Me.GrigliaCorpo.Height = 2775
        Me.FraEtichetteOLD.Visible = True
    'Else
    '    Me.GrigliaCorpo.Height = 2055
    '    Me.FraEtichette.Visible = True
    'End If
    
    Me.cmdEspandiGriglia.Visible = True
    Me.cmdRiduciGriglia.Visible = False
End Sub

Private Sub cmdRiprendiDatiCliente_Click()
    cdCliente_ChangeElement
End Sub
Private Sub cmdSalva_Click()
On Error GoTo ERR_cmdSalva_Click
Dim Variazione As Boolean
Dim IDListinoDefault As Long
Dim Cliente As String
Dim DataOrdine As String
Dim NumeroOrdine As Long
Dim QtaVenduta As Double
Dim ERRORI_MOVIMENTI As String
Dim OLD_Cursor As Long
Dim Testo As String
Dim sSQL As String
Dim NumeroRecordGriglia As Long
Dim rsConf As DmtOleDbLib.adoResultset
Dim NuovoDocumento As Boolean
Dim X As Long
Dim ErroreCoda As Boolean
Dim LINK_LAV_MOV As Long

B_LOADING_RIGA = True

If MODULO_ATTIVATO = 0 Then
    If Len(MODULO_DESCRIZIONE) > 0 Then
        MsgBox "Il modulo " & MODULO_DESCRIZIONE & " non è stato abilitato", vbInformation, TheApp.FunctionName
    Else
        MsgBox "Questa funzionalità non può essere avviata senza abilitazione", vbInformation, TheApp.FunctionName
    End If
Exit Sub
End If


If CHECK_ABILITAZIONE_DIAMANTE = False Then Exit Sub

Variazione = bVariazioneDettaglio

'''''RICALCOLO DEI PESI'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
If Me.txtIDRigaOrdine.Value = 0 Then
    Me.chkPrezzoInclusoImballo.Value = GET_PREZZO_IMBALLO_INCLUSO_2(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cdCliente.KeyFieldID)
End If
CalcoloPesoNetto
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

If PermessoSalvataggio = False Then Exit Sub

If Me.chkPreConferimento.Value = vbUnchecked Then
    RECUPERO_PREZZI_DA_ORD = True
    txtIDOrdineCliente_Change
    RECUPERO_PREZZI_DA_ORD = False
    If STATO_ORDINE = 3 Then
        MsgBox "Impossibile salvare poichè l'ordine risulta bloccato da un altro utente", vbCritical, "Controllo salvataggio"
        Exit Sub
    End If
    
    Testo = "La lavorazione risulta collegata al flusso della tracciabilità" & vbCrLf
    Testo = Testo & "Se si continua con questo comando si potrebbero avere valori squadrati" & vbCrLf
    Testo = Testo & "Continuare con questo comando?"
    
    
    Select Case TIPO_COMPORTAMENTO_LAVORAZIONE
        Case 1
            If fnNotNullN(m_Document(m_Document.PrimaryKey).Value) > 0 Then
                If GET_CONTROLLA_ESISTENZA_COLLEGAMENTO(fnNotNullN(m_Document(m_Document.PrimaryKey).Value), m_DocType.ID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)) = True Then
                    If MsgBox(Testo, vbInformation, "Controllo salvataggio") = vbNo Then Exit Sub
                End If
            End If
        Case 2
            If STATO_ORDINE = 2 Then
                MsgBox "Impossibile salvare poichè l'ordine risulta chiuso", vbInformation, "Errore salvataggio"
                Exit Sub
            Else
                If fnNotNullN(m_Document(m_Document.PrimaryKey).Value) > 0 Then
                    If GET_CONTROLLA_ESISTENZA_COLLEGAMENTO(fnNotNullN(m_Document(m_Document.PrimaryKey).Value), m_DocType.ID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)) = True Then
                        If MsgBox(Testo, vbInformation, "Controllo salvataggio") = vbNo Then Exit Sub
                    End If
                End If
            End If
        Case 3
            If STATO_ORDINE = 1 Then
                MsgBox "Impossibile salvare poichè l'ordine risulta confermato per la vendita", vbInformation, "Errore salvataggio"
                Exit Sub
            Else
                If fnNotNullN(m_Document(m_Document.PrimaryKey).Value) > 0 Then
                    If GET_CONTROLLA_ESISTENZA_COLLEGAMENTO(fnNotNullN(m_Document(m_Document.PrimaryKey).Value), m_DocType.ID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)) = True Then
                        If MsgBox(Testo, vbInformation, "Controllo salvataggio") = vbNo Then Exit Sub
                    End If
                End If
            End If
        Case 4
            If (STATO_ORDINE = 1) Or (STATO_ORDINE = 2) Then
                MsgBox "Impossibile salvare poichè l'ordine risulta confermato per la vendita o è chiuso", vbInformation, "Errore salvataggio"
    
                Exit Sub
            Else
                If fnNotNullN(m_Document(m_Document.PrimaryKey).Value) > 0 Then
                    If GET_CONTROLLA_ESISTENZA_COLLEGAMENTO(fnNotNullN(m_Document(m_Document.PrimaryKey).Value), m_DocType.ID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)) = True Then
                        If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo salvataggio") = vbNo Then Exit Sub
                    End If
                End If
            End If
        Case Else
    End Select
End If

'CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)

Set rsNew = New ADODB.Recordset

If m_DocumentsLink(m_DocumentsLink.PrimaryKey) <= 0 Then
    sSQL = "SELECT * FROM RV_POAssegnazioneMerce "
    sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=0"
    sSQL = sSQL & " AND IDRV_POAssegnazioneMerce=0"
    rsNew.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic
    
    rsNew.AddNew
    NuovoDocumento = True
Else
    sSQL = "SELECT * FROM RV_POAssegnazioneMerce "
    sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    sSQL = sSQL & " AND IDRV_POAssegnazioneMerce=" & fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
        
    rsNew.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic
    NuovoDocumento = False
End If

SCRIVI_CODA fnNotNullN(m_Document(m_Document.PrimaryKey)), m_DocType.ID

APERTURA_FORM_CODA = False

NumeroRecordGriglia = Me.GrigliaCorpo.ListIndex - 1

Screen.MousePointer = 11
'    If Me.txtIDRigaOrdine.Value = 0 Then 'Or ((Me.txtIDOrdinePadre.Value <> fnNotNull(m_DocumentsLink("IDOggettoOrdinePadre").Value)) And (fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)))) Then
'        If PREZZI_ARTICOLI_DA_ORDINE = 0 Then
'            GET_CONFIGURAZIONE_IMPORTI_ARTICOLO Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'            GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'        Else
'            If (GET_CONFIGURAZIONE_PREZZO_DA_ORDINE(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.txtIDOrdinePadre.Value) = False) Then
'                GET_CONFIGURAZIONE_IMPORTI_ARTICOLO Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'                GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'            Else
'                If RETURN_SEL_PREZZO_IMB_DA_ORD = 0 Then
'                    GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'                End If
'            End If
'        End If
'    Else
'        If (Me.txtIDOrdinePadre.Value <> fnNotNull(m_DocumentsLink("IDOggettoOrdinePadre").Value)) And (fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) > 0) Then
'            If PREZZI_ARTICOLI_DA_ORDINE = 0 Then
'                GET_CONFIGURAZIONE_IMPORTI_ARTICOLO Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'                GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'            Else
'                If (GET_CONFIGURAZIONE_PREZZO_DA_ORDINE(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.txtIDOrdinePadre.Value) = False) Then
'                    GET_CONFIGURAZIONE_IMPORTI_ARTICOLO Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'                    GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'                Else
'                    If RETURN_SEL_PREZZO_IMB_DA_ORD = 0 Then
'                        GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
'                    End If
'                End If
'            End If
'
'        End If
'    End If
    
    If ((Me.txtIDRigaOrdine.Value = 0) Or ((Me.txtIDOrdinePadre.Value <> fnNotNull(m_DocumentsLink("IDOggettoOrdinePadre").Value)) And (fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) > 0))) Then
        If PREZZI_ARTICOLI_DA_ORDINE = 0 Then
            GET_CONFIGURAZIONE_IMPORTI_ARTICOLO Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
            GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
        Else
            If (GET_CONFIGURAZIONE_PREZZO_DA_ORDINE(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.txtIDOrdinePadre.Value) = False) Then
                GET_CONFIGURAZIONE_IMPORTI_ARTICOLO Me.cdCliente.KeyFieldID, Me.CDArticolo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
                GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
            Else
                If RETURN_SEL_PREZZO_IMB_DA_ORD = 0 Then
                    GET_CONFIGURAZIONE_IMPORTI_IMBALLO Me.cdCliente.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.cboListino.CurrentID, LINK_LISTINO_AZIENDA, Me.txtQta_UM.Value
                End If
            End If
        End If
    
    End If
    
    rsNew("IDRV_POCaricoMerceRighe").Value = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    rsNew("IDRV_POProcessoIVGamma").Value = 0
    rsNew("DataDocumento").Value = Me.txtDataLavorazione.Text
    rsNew("IDArticolo").Value = Me.CDArticolo.KeyFieldID
    rsNew("CodiceArticolo").Value = Me.CDArticolo.Code
    rsNew("Articolo").Value = Me.TxtArticolo.Text
    rsNew("IDUnitaDiMisuraCoop").Value = Link_UnitaDiMisura_Coop
    rsNew("IDUnitaDiMisura").Value = Me.cboUM.CurrentID
    rsNew("Colli").Value = Me.txtColli.Value
    rsNew("PesoLordo").Value = Me.txtPesoLordo.Value
    rsNew("PesoNetto").Value = Me.txtPesoNetto.Value
    rsNew("TaraUnitaria").Value = Me.txtTaraUnitaria.Value
    rsNew("Tara").Value = Me.txtTara.Value
    rsNew("Pezzi").Value = Me.txtPezzi.Value
    rsNew("Qta_UM").Value = Me.txtQta_UM.Value
    rsNew("IDImballoVendita").Value = Me.CDCodiceImballo.KeyFieldID
    rsNew("CodiceImballoVendita").Value = Me.CDCodiceImballo.Code
    rsNew("ImballoVendita").Value = Me.txtImballo.Text
    rsNew("IDTipoLavorazione").Value = Me.CboTipoLavorazione.CurrentID
    rsNew("IDRV_POCalibro").Value = Me.cboCalibro.CurrentID
    rsNew("IDRV_POTipoCategoria").Value = Me.cboTipoCategoria.CurrentID
    rsNew("IDCliente").Value = Me.cdCliente.KeyFieldID
    rsNew("IDOggettoOrdine").Value = Me.txtIDOrdineCliente.Value
    rsNew("NumeroOrdine").Value = Me.txtNumeroOrdine.Value
    rsNew("DataOrdine").Value = Me.txtDataOrdine.Value
    rsNew("IDRV_POPedana").Value = Me.txtIDPedana.Value
    rsNew("CodicePedana").Value = Me.txtCodicePedana.Text
    rsNew("CodiceLottoVendita").Value = Me.txtLottoVendita.Text
    rsNew("IDAnagraficaSocio").Value = Me.TxtIDAnagrafica.Text
    rsNew("AnagraficaSocio").Value = Me.txtSocio.Text
    rsNew("NomeSocio").Value = Me.txtNomeSocio.Text
    rsNew("DataConferimento").Value = Me.txtDataDocumento.Text
    rsNew("NumeroConferimento").Value = Me.txtNumeroDocumento.Value
    rsNew("CodiceSocio").Value = Me.txtCodiceSocio.Text
    rsNew("LottoCliente").Value = Me.txtLottoCliente.Text
    rsNew("AltreAnnotazioniPerCliente").Value = Me.txtAltreAnnotazioniCliente.Text
    rsNew("IDUtente").Value = Me.cboUtente.CurrentID
    rsNew("CodiceUtente").Value = Me.txtCodicePostazione.Text
    rsNew("NumeroPedanaCliente").Value = Me.txtCodicePedanaCliente.Value
    rsNew("MerceInclusoImballo").Value = Me.chkPrezzoInclusoImballo.Value
    rsNew("UtentePC").Value = Me.txtNomeMacchina.Text
    rsNew("NomePC").Value = Me.txtUtenteMacchina.Text
    rsNew("IDLinguaPredefinita").Value = Me.cboLinguaPred.CurrentID
    rsNew("IDLinguaCliente").Value = Me.cboLinguaCliente.CurrentID
    rsNew("CodicePedanaCliente").Value = Me.txtCodificaCodicePedanaCliente.Text
    rsNew("CodiceGSI").Value = Me.txtCodiceGSICliente.Text
    rsNew("CodiceAssociatoPressoCliente").Value = Me.txtCodiceAssociatoPressoCliente.Text
    rsNew("CodiceABarreArticoloCliente").Value = Me.txtCodificaArticoloCodiceABarre.Text
    rsNew("DescrizioneCodiceABarreArticoloCliente").Value = Me.txtCodiceABarreArticoloCliente.Text
    rsNew("CodiceABarreImballoCliente").Value = Me.txtCodificaImballoCodiceABarre.Text
    rsNew("DescrizioneCodiceABarreImballoCliente").Value = Me.txtCodiceABarreImballoCliente.Text
    rsNew("DescrizioneArticoloInLinguaPred").Value = Me.txtArticoloInLinguaPred.Text
    rsNew("DescrizioneCalibroInLinguaPred").Value = Me.txtCalibroInLiguaPred.Text
    rsNew("DescrizioneCategoriaInLinguaPred").Value = Me.txtCategoriaInLinguaPred.Text
    rsNew("DescrizioneArticoloInLinguaCliente").Value = Me.txtDescrizioneArticoloInLinguaCliente.Text
    rsNew("DescrizioneCalibroInLinguaCliente").Value = Me.txtCalibroInLingua.Text
    rsNew("DescrizioneCategoriaInLinguaCliente").Value = Me.txtCategoriaInLingua.Text
    rsNew("CodiceABarreArticoloPred").Value = Me.txtCodBarreArtAzienda.Text
    rsNew("DescrizioneCodiceABarreArticoloPred").Value = Me.txtDescrCodBarreArtAzienda.Text
    rsNew("CodiceABarreImballoPred").Value = Me.txtCodBarreImbAzienda.Text
    rsNew("DescrizioneCodiceABarreImballoPred").Value = Me.txtDescrCodBarreImbAzienda.Text
    rsNew("LinguaPredefinita").Value = Me.cboLinguaPred.Text
    rsNew("LinguaCliente").Value = Me.cboLinguaCliente.Text
    rsNew("OraLavorazione").Value = Me.txtOraLav.Text
    rsNew("ImportoUnitarioArticolo").Value = Me.txtImportoUnitarioArticolo.Value
    rsNew("Sconto1").Value = Me.txtSconto1.Value
    rsNew("Sconto2").Value = Me.txtSconto2.Value
    rsNew("ImportoUnitarioImballo").Value = Me.txtImportoUnitarioImballo.Value
    
    rsNew("TracciaImballo").Value = Me.chkTracciaImballoGest.Value
    rsNew("ConfermaDaUtente").Value = Me.chkConfermaDaUtente.Value
    rsNew("RV_POImportoUnitarioListino").Value = Me.txtImportoUnitarioListino.Value
    
    rsNew("NotaRigaOrdRaggr") = Me.txtRaggrOrd.Text
    rsNew("IDValoriOggettoDettaglioRigaOrd") = Me.txtIDRigaOrdine.Value
    rsNew("AnnotazioniAggiuntiveLav") = Me.txtNoteAgg.Text
    
    rsNew("NumeroListaPrelievo").Value = Me.txtNListaPrelievo.Value
    rsNew("IDOggettoOrdinePadre").Value = Me.txtIDOrdinePadre.Value
    
    
    rsNew("IDArticoloImballoPrimario").Value = Me.CDImballoPrimario.KeyFieldID
    rsNew("NumeroConfezioniPerImballo").Value = Me.txtNumeroConfImballo.Value
    rsNew("TaraConfezioneImballo").Value = Me.txtTaraConfImballo.Value
    rsNew("CostoConfezioneImballo").Value = Me.txtCostoConfezione.Value
    
    
    rsNew("TracciaImballoPrim").Value = Me.chkTracciaImballoGestPrim.Value
    rsNew("ConfermaDaUtentePrim").Value = Me.chkConfermaDaUtentePrim.Value
    
    rsNew("DescrizioneImballoInLinguaCliente").Value = Me.txtDescrizioneImballoInLinguaCliente.Text
    rsNew("DescrizioneImballoInLinguaPred").Value = DESCR_IMB_LINGUA_PRED
    
    rsNew("DescrizioneImballoPrimInLinguaCliente").Value = DESCR_IMB_PRIM_LINGUA_CLIENTE
    rsNew("DescrizioneImballoPrimInLinguaPred").Value = DESCR_IMB_PRIM_LINGUA_PRED
    
    rsNew("CodiceABarreImballoPrimCliente").Value = COD_A_BARRE_IMB_PRIM_CLI
    rsNew("DescrizioneCodiceABarreImballoPrimCliente").Value = DESCR_A_BARRE_IMB_PRIM_CLI
    
    rsNew("CodiceABarreImballoPrimPred").Value = COD_A_BARRE_IMB_PRIM_PRED
    rsNew("DescrizioneCodiceABarreImballoPrimPred").Value = DESCR_A_BARRE_IMB_PRIM_PRED
    
    rsNew("QuantitaPerCollo").Value = QUANTITA_PER_COLLO
    rsNew("PesoPerCollo").Value = PESO_LORDO_ARTICOLO
    rsNew("MoltiplicatorePerCollo").Value = MOLTIPLICATORE
    If IDLineaProduzione = 0 Then
        rsNew("IDRV_POLineaProduzione").Value = Null
    Else
        rsNew("IDRV_POLineaProduzione").Value = IDLineaProduzione
    End If
    If IDProcessoProd = 0 Then
        rsNew("IDRV_POProcessoLavorazione").Value = Null
    Else
        rsNew("IDRV_POProcessoLavorazione").Value = IDProcessoProd
    End If
    If IDRigaProcessoProd = 0 Then
        rsNew("IDRV_POProcessoLavorazioneRighe").Value = Null
    Else
        rsNew("IDRV_POProcessoLavorazioneRighe").Value = IDRigaProcessoProd
    End If
    rsNew("IDRV_PO01_LottoCampagna").Value = LINK_LOTTO_PROD_LAV
    If LINK_LOTTO_PROD_LAV = 0 Then
        If (ATTIVA_SEL_LOTTO_PROD_IN_LAV = 1) Then
            LINK_LOTTO_PROD_LAV = fnNotNullN(m_Document("IDLottoDiCampagna").Value)
            rsNew("NotaRigaOrdRaggr") = GET_DESCRIZIONE_LOTTO_PROD_LAV(LINK_LOTTO_PROD_LAV)
            rsNew("IDRV_PO01_LottoCampagna").Value = LINK_LOTTO_PROD_LAV
        End If
    End If
    
    rsNew("PreConferimento").Value = Abs(Me.chkPreConferimento.Value)
    
    '''GESTIONE PASSAPORTO''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    If Link_TipoPassaportoArticolo = 2 Then
        If Link_Sezionale_Dettagliato > 0 Then
            rsNew("RV_PO01_NumeroPassaportoRighe").Value = Me.txtNumeroProtocollo.Value
            rsNew("RV_PO01_IDSezionaleRighe").Value = Link_Sezionale_Dettagliato
            If Me.txtNumeroProtocollo.Value >= Numero_Protocollo_Dettagliato Then
                INCREMENTO_NUMERO_SEZIONALE_PROT Link_Sezionale_Dettagliato, Link_Periodo_IVA_Protocollo, Me.txtNumeroProtocollo.Value
            End If
        End If
    End If
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    rsNew("IDRV_POProcessoIVGammaRighe").Value = 0
    
    If fnNotNullN(rsNew("Link_Ordinamento").Value) = 0 Then
        rsNew("Link_Ordinamento").Value = LINK_ORDINAMENTO
        LINK_ORDINAMENTO = LINK_ORDINAMENTO + 1
    End If
    

    ''''''''''''''''''''''''''''''CONTROLLA LA CODA DEI SALVATAGGI'''''''''''''''''''''''''''''
    Me.Enabled = False
    X = 0
    ErroreCoda = False
    Do
        X = GET_NUMERO_DOCUMENTO(m_DocType.ID, NuovoDocumento)
        If X = -1 Then
            X = 1
            ErroreCoda = True
        End If
    Loop Until X = 1
    
    If ErroreCoda = True Then
        X = -1
    End If
    
    If X = -1 Then
        Me.Enabled = True
        Me.SetFocus
        Me.Caption = Caption2Display
        Screen.MousePointer = 0
        ''''''''ELIMINAZIONE RIFERIMENTO CODA'''''''''''''''''''''''''''''''
        sSQL = "DELETE FROM RV_POTMP "
        sSQL = sSQL & "WHERE IDUtente=" & m_App.IDUser
        'sSQL = sSQL & " AND IDTipoOggetto=" & m_DocType.ID
        Cn.Execute sSQL
        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        B_LOADING_RIGA = False
        Exit Sub
    End If
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    
    OLD_Cursor = Cn.CursorLocation
    Cn.CursorLocation = adUseClient
    
    
    'Cn.BeginTrans
    rsNew.Update
    'Cn.CommitTrans
    
    LINK_LAV_MOV = rsNew!IDRV_POAssegnazioneMerce
    
    rsNew.Close
    Set rsNew = Nothing

    'AGGIORNAMENTO TIPO PEDANA
    AGGIORNA_TIPO_PEDANA Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtPesoPedana.Value

    'AGGIORNAMENTO NUMERO PEDANA CLIENTE
    AGGIORNA_NUMERO_PEDANA_CLIENTE Me.txtCodicePedanaCliente.Value, Me.cdCliente.KeyFieldID

    ''''''''ELIMINAZIONE RIFERIMENTO CODA'''''''''''''''''''''''''''''''
    sSQL = "DELETE FROM RV_POTMP "
    sSQL = sSQL & "WHERE IDUtente=" & m_App.IDUser
    'sSQL = sSQL & " AND IDTipoOggetto=" & m_DocType.ID
    Cn.Execute sSQL
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    
    
    
    B_LOADING_LOTTO_IMBALLO = True
    B_LOADING_LOTTO_IMBALLO_PRIM = True
    B_LOADING_RIGA = True
    
    m_DocumentsLink.Refresh
    
    Me.Enabled = True

    If NuovoDocumento = False Then
        m_DocumentsLink.Move NumeroRecordGriglia
    Else
        m_DocumentsLink.Move Me.GrigliaCorpo.ListCount - 1
    End If

    B_LOADING_RIGA = True
    frmAttesa.Show
    Me.Enabled = False
    DoEvents
    
    If rsKIT Is Nothing Then CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, LINK_LAV_MOV
    
    SALVA_KIT LINK_LAV_MOV
    
    
    'Me.Caption = "SALVATAGGIO IN CORSO..................."
    'DoEvents
    
    frmAttesa.lblInfo = Me.Caption
    DoEvents
    
    'MOVIMENTANZIONE
    Me.Caption = "MOVIMENTAZIONE IN CORSO..................."
    DoEvents
    
    frmAttesa.lblInfo = Me.Caption
    DoEvents
    
    ERRORI_MOVIMENTI = MOVIMENTAZIONE_RIGA_LAVORAZIONE(LINK_LAV_MOV)
    If ERRORI_MOVIMENTI <> "" Then
        Unload frmAttesa
        Me.Enabled = True
        
        MsgBox "ATTENZIONE!!!!" & vbCrLf & ERRORI_MOVIMENTI & vbCrLf & "Si tenterà di eseguire il salvataggio della riga", vbCritical, "Errori su movimenti"
        ERRORI_MOVIMENTI = ""
        Me.SetFocus
        B_LOADING_RIGA = False
        B_LOADING_LOTTO_IMBALLO = False
        cmdSalva_Click
    End If
    
    
    If Me.chkPreConferimento.Value = vbChecked Then
        Me.Caption = "AGGIORNAMENTO CONFERIMENTO COLLEGATO..................."
        DoEvents
        
        frmAttesa.lblInfo = Me.Caption
        DoEvents
        
        CREA_RIGA_CONFERIMENTO LINK_LAV_MOV
        
    End If
    
    Unload frmAttesa
    Me.Enabled = True
    Me.SetFocus

    Cn.CursorLocation = OLD_Cursor
    
    'CALCOLO DEI TOTALI DI CONFERIMENTO
    GET_RIEPILOGO_CONFERIMENTO
    
    If VISUALIZZA_ANDAMENTO_ORDINE = 1 Then
        GET_ANDAMENTO_ORDINE Me.txtIDOrdinePadre.Value
    End If
    
    Screen.MousePointer = 0
    
    Me.Caption = Caption2Display(False)
    
    If msg_CONFERIMENTO_NEGATIVO = 1 Then
        If Me.txtQtaDifferenza.Value < 0 Then
            Testo = "ATTENZIONE!!!" & vbCrLf
            Testo = Testo & "Il conferimento ha una quantità residua minore di zero"
            MsgBox Testo, vbCritical, "Conferimento negativo"
        End If
    
    End If
    
    RECUPERO_DATI_GIACENZA_LOTTO_IMBALLO Me.CDCodiceImballo.KeyFieldID, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    
    RECUPERO_DATI_GIACENZA_LOTTO_IMBALLO_PRIM Me.CDImballoPrimario.KeyFieldID, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    
    CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    
    B_LOADING_LOTTO_IMBALLO = False
    B_LOADING_LOTTO_IMBALLO_PRIM = False
        
    If Me.chkPreConferimento.Value = vbUnchecked Then
        CONTROLLO_MOVIMENTAZIONE fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    End If

B_LOADING_RIGA = False
Exit Sub

ERR_cmdSalva_Click:
    Unload frmAttesa
    Me.Enabled = True
    Me.SetFocus
    
    MsgBox Err.Description, vbCritical, "cmdSalva_Click"
    Screen.MousePointer = 0
    Cn.RollbackTrans
    ''''''''ELIMINAZIONE RIFERIMENTO CODA'''''''''''''''''''''''''''''''
    sSQL = "DELETE FROM RV_POTMP "
    sSQL = sSQL & "WHERE IDUtente=" & m_App.IDUser
    'sSQL = sSQL & " AND IDTipoOggetto=" & m_DocType.ID
    Cn.Execute sSQL
    ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    Screen.MousePointer = 0
    B_LOADING_RIGA = False
    B_LOADING_LOTTO_IMBALLO = False
    Me.Caption = Caption2Display(False)
End Sub

Private Sub cmdSalva_Q_Click()
On Error GoTo ERR_cmdSalva_Q_Click
Dim ERRORI_MOVIMENTI As String
Dim OLD_Cursor As Long
Dim Testo As String
Dim sSQL As String
Dim NumeroRecord As Long
Dim IDLavorazione As Long

If CHECK_ABILITAZIONE_DIAMANTE = False Then Exit Sub

If PermessoSalvataggio_Q = False Then Exit Sub
    
    CalcoloPesoNetto_Q
    
    'SCRIVI_CODA fnNotNullN(m_Document(m_Document.PrimaryKey))
    'APERTURA_FORM_CODA = False
    
    NumeroRecord = Me.GrigliaScarti.ListIndex - 1
    
    m_DocumentsLink1("IDArticolo").Value = Me.CDArticolo_Q.KeyFieldID
    m_DocumentsLink1("CodiceArticolo").Value = Me.CDArticolo_Q.Code
    m_DocumentsLink1("Articolo").Value = Me.TxtArticolo_Q.Text
    m_DocumentsLink1("IDUnitaDiMisuraCoop").Value = Link_UnitaDiMisura_Coop_Q
    m_DocumentsLink1("IDUnitaDiMisura").Value = Me.cboUM_Q.CurrentID
    m_DocumentsLink1("Colli").Value = Me.txtColli_Q.Value
    m_DocumentsLink1("PesoLordo").Value = Me.txtPesoLordo_Q.Value
    m_DocumentsLink1("PesoNetto").Value = Me.txtPesoNetto_Q.Value
    m_DocumentsLink1("TaraUnitaria").Value = Me.txtTaraUnitaria_Q.Value
    m_DocumentsLink1("Tara").Value = Me.txtTara_Q.Value
    m_DocumentsLink1("Pezzi").Value = Me.txtPezzi_Q.Value
    m_DocumentsLink1("Qta_UM").Value = Me.txtQta_UM_Q.Value
    m_DocumentsLink1("IDImballoVendita").Value = Me.CDCodiceImballo_Q.KeyFieldID
    m_DocumentsLink1("CodiceImballoVendita").Value = Me.CDCodiceImballo_Q.Code
    m_DocumentsLink1("ImballoVendita").Value = Me.txtImballo_Q.Text
    m_DocumentsLink1("DataDocumento").Value = Me.txtDataLavorazione_Q.Text
    m_DocumentsLink1("OraLavorazione").Value = Me.txtOraLav_Q.Text
    m_DocumentsLink1("IDTipoLavorazione").Value = Me.CboTipoLavorazione_Q.CurrentID
    m_DocumentsLink1("QtaPrelevata").Value = Me.txtQtaPrelievoQ.Value
    m_DocumentsLink1("Sequenza").Value = Me.txtSequenzaPrelievo.Value
    'GET_NUMERO_DOCUMENTO
    frmAttesa.Show
    Me.Enabled = False
    
    Me.Caption = "SALVATAGGIO IN CORSO..................."
    DoEvents
    
    frmAttesa.lblInfo = Me.Caption
    DoEvents
    
    
    OLD_Cursor = Cn.CursorLocation
    Cn.CursorLocation = adUseClient
    
    Cn.BeginTrans
    
    m_DocumentsLink1.Save
    IDLavorazione = fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey).Value)
    
    
    Cn.CommitTrans
    
    
    
    'MOVIMENTANZIONE
    Me.Caption = "MOVIMENTAZIONE IN CORSO..................."
    DoEvents
    
    frmAttesa.lblInfo = Me.Caption
    DoEvents
    
    ERRORI_MOVIMENTI = MOVIMENTAZIONE_RIGA_QUADRATURA
    If ERRORI_MOVIMENTI <> "" Then
        MsgBox "ATTENZIONE!!!!" & vbCrLf & ERRORI_MOVIMENTI & vbCrLf & "Si tenterà di eseguire il salvataggio della riga", vbCritical, "Errori su movimenti"
        ERRORI_MOVIMENTI = ""
        Unload frmAttesa
        Me.Enabled = True
        Me.SetFocus
        cmdSalva_Q_Click
    End If
    
    If Me.chkPreConferimento.Value = vbChecked Then
        Me.Caption = "AGGIORNAMENTO CONFERIMENTO COLLEGATO..................."
        DoEvents
        
        frmAttesa.lblInfo = Me.Caption
        DoEvents
        
        CREA_RIGA_CONFERIMENTO IDLavorazione, 1
        
    End If
    
    
    Unload frmAttesa
    Me.Enabled = True
    Me.SetFocus

    Cn.CursorLocation = OLD_Cursor

    'CALCOLO DEI TOTALI DI CONFERIMENTO
    GET_RIEPILOGO_CONFERIMENTO
        
    m_DocumentsLink1.Move NumeroRecord
        
        
     
    Screen.MousePointer = 0
    
    Me.Caption = Caption2Display(False)
Exit Sub
ERR_cmdSalva_Q_Click:
    MsgBox Err.Description, vbCritical, "cmdSalva_Q_Click"
    Cn.RollbackTrans
    Cn.CursorLocation = OLD_Cursor
    
    GET_RIEPILOGO_CONFERIMENTO
    
    Screen.MousePointer = 0
    
    Me.Caption = Caption2Display(False)
End Sub

Private Sub cmdScaricaImbPrim_Click()
On Error GoTo ERR_cmdScaricaImbPrim_Click
    If rsKIT Is Nothing Then CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    
    frmKIT.Show vbModal
Exit Sub
ERR_cmdScaricaImbPrim_Click:
    MsgBox Err.Description, vbCritical, "ERR_cmdScaricaImbPrim_Click"
End Sub

Private Sub cmdSelezionaOrdine_Click()
Dim Testo As String
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
Dim IDCliente As Long
Dim NumeroDocumento As Long
Dim DataDocumento As String


If Me.chkPreConferimento.Value = vbChecked Then Exit Sub

AGGIORNA_NUMERAZIONE_ORDINE

IDCliente = Me.cdCliente.KeyFieldID
NumeroDocumento = Me.txtNumeroOrdine.Value
DataDocumento = Me.txtDataOrdine.Text


If AVVIO_RICERCA_ORDINE = False Then
    
    txtIDOrdineCliente_Change
    
    Select Case TIPO_COMPORTAMENTO_LAVORAZIONE
        Case 1
           
        Case 2
            Testo = "ATTENZIONE!!!!" & vbCrLf
            Testo = Testo & "L'ordine risulta chiuso" & vbCrLf
            Testo = Testo & "Se si vuole cambiare l'associazione ad un nuovo ordine è bene sapere che questa operazione potrebbe comportare un mal funzionamento nel proseguio delle attività per questa lavorazione" & vbCrLf
            Testo = Testo & "Continuare?"
            If STATO_ORDINE = 2 Then
                If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo inserimento dati") = vbNo Then Exit Sub
            End If
        Case 3
    
            Testo = "ATTENZIONE!!!!" & vbCrLf
            Testo = Testo & "L'ordine risulta confermato" & vbCrLf
            Testo = Testo & "Se si vuole cambiare l'associazione ad un nuovo ordine è bene sapere che questa operazione potrebbe comportare un mal funzionamento nel proseguio delle attività per questa lavorazione" & vbCrLf
            Testo = Testo & "Continuare?"
            If STATO_ORDINE = 1 Then
                If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo inserimento dati") = vbNo Then Exit Sub
            End If
        
        Case 4
            Testo = "ATTENZIONE!!!!" & vbCrLf
            Testo = Testo & "L'ordine risulta confermato o chiuso" & vbCrLf
            Testo = Testo & "Se si vuole cambiare l'associazione ad un nuovo ordine è bene sapere che questa operazione potrebbe comportare un mal funzionamento nel proseguio delle attività per questa lavorazione" & vbCrLf
            Testo = Testo & "Continuare?"
    
            If (STATO_ORDINE = 1) Or (STATO_ORDINE = 2) Then
                If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo inserimento dati") = vbNo Then Exit Sub
            End If
        Case Else
        
    End Select
End If


If AVVIO_RICERCA_ORDINE = True Then
    Me.cdCliente.Load IDCliente
    Me.txtNumeroOrdine.Value = NumeroDocumento
    Me.txtDataOrdine.Text = DataDocumento
    
    If GET_NUMERO_ORDINI_DA_RICERCA(Me.cdCliente.KeyFieldID, Me.txtNumeroOrdine.Value, Me.txtDataOrdine.Text, Me.txtDataPartenza.Text) > 1 Then
        frmTrovaOrdine.Show vbModal
    End If
Else
    Me.cdCliente.Load IDCliente
    Me.txtNumeroOrdine.Value = NumeroDocumento
    Me.txtDataOrdine.Text = DataDocumento
    frmTrovaOrdine.Show vbModal
End If

End Sub
Private Sub cmdSelezionaPedana_Click()
On Error GoTo ERR_cmdSelezionaPedana_Click
Dim Testo As String
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
Dim Riporta As Boolean



WHERE_TROVA_PEDANA = 1

frmTrovaPedana.Show vbModal

If LINK_PEDANA > 0 Then
    sSQL = "SELECT * FROM RV_POAssegnazioneMerce "
    sSQL = sSQL & "WHERE IDRV_POPedana=" & LINK_PEDANA
    
    If LINK_ORDINE_RIF > 0 Then
        sSQL = sSQL & " AND IDOggettoOrdine=" & LINK_ORDINE_RIF
    End If
    sSQL = sSQL & " ORDER BY IDRV_POAssegnazioneMerce DESC"
    
    Set rs = Cn.OpenResultset(sSQL)
    
    Riporta = True
    
    If Not rs.EOF Then
       
        If Me.CDArticolo.KeyFieldID > 0 Then
            
            If (Me.CDArticolo.KeyFieldID <> fnNotNullN(rs!IDArticolo)) Then
               Testo = "ATTENZIONE!!!" & vbCrLf
               Testo = Testo & "L'articolo selezionato non fa parte dell'ultimo articolo utilizzato in pedana" & vbCrLf
               Testo = Testo & "Vuoi continuare?"
               
               If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo dati") = vbYes Then
                    Riporta = False
               End If
            End If
        End If

        
        If Riporta = True Then
           
            RIPORTA_RIGA_DA_ORDINE = 0
        
            Me.txtIDPedana.Value = LINK_PEDANA
            Me.CDTipoPedana.Load GET_TIPO_PEDANA(LINK_PEDANA)
            Me.txtIDOrdineCliente.Value = fnNotNullN(rs!IDOggettoOrdine)
            
            Me.cdCliente.Load fnNotNullN(rs!IDCliente)
            Me.txtNumeroOrdine.Value = fnNotNullN(rs!NumeroOrdine)
            Me.txtDataOrdine.Value = fnNotNullN(rs!DataOrdine)
                
            If RIPORTA_RIGA_DA_ORDINE = 0 Then
                
                Me.CDCodiceImballo.Load fnNotNullN(rs!IDImballoVendita)
                
                If GET_ESISTENZA_ARTICOLI_DERIVATI(fnNotNullN(rs!IDArticolo)) = True Then
                    
                    Me.CDArticolo.Load fnNotNullN(rs!IDArticolo)
                    If Me.CDArticolo.KeyFieldID > 0 Then
                        Me.TxtArticolo.Text = fnNotNull(rs!Articolo)
                    End If
                End If
                Me.cboTipoCategoria.WriteOn fnNotNullN(rs!IDRV_POTipoCategoria)
                Me.cboCalibro.WriteOn fnNotNullN(rs!IDRV_POCalibro)
                Me.CboTipoLavorazione.WriteOn fnNotNullN(rs!IDTipoLavorazione)
                Me.cdCliente.Enabled = False
                Me.txtLottoCliente.Text = fnNotNull(rs!LottoCliente)
                Me.cboLinguaCliente.WriteOn fnNotNullN(rs!IDLinguaCliente)
                Me.txtCodicePedanaCliente.Value = fnNotNullN(rs!NumeroPedanaCliente)
                
                If GET_ESISTENZA_ARTICOLI_DERIVATI(fnNotNullN(rs!IDArticolo)) = False Then
                    Me.CDArticolo.SetFocus
                End If
            End If
'            Else
'                Me.CDArticolo.SetFocus
'                If Flag_GestioneArticoli = True Then
'                    Link_ArticoloPadre = fnNotNullN(m_Document("IDArticolo").Value)
'                    If PREZZI_ARTICOLI_DA_ORDINE = 0 Then
'                        If GET_ESISTENZA_ARTICOLI_DERIVATI(fnNotNullN(m_Document("IDArticolo").Value)) = True Then
'                            frmArticoliDerivati.Show vbModal
'                        End If
'                    End If
'                End If
'            End If
            
            RIPORTA_RIGA_DA_ORDINE = 0
        Else
            Me.txtIDPedana.Value = LINK_PEDANA
            Me.CDTipoPedana.Load GET_TIPO_PEDANA(LINK_PEDANA)
            Me.txtPesoPedana.Value = GET_PESO_PEDANA(Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID)
        End If
    
    Else

        Me.txtIDPedana.Value = LINK_PEDANA
        Me.CDTipoPedana.Load GET_TIPO_PEDANA(LINK_PEDANA)
        Me.txtPesoPedana.Value = GET_PESO_PEDANA(Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID)

    End If
    
    
    
    If Not (rs Is Nothing) Then
        rs.CloseResultset
        Set rs = Nothing
    End If
End If

Exit Sub
ERR_cmdSelezionaPedana_Click:
    MsgBox Err.Description, vbCritical, "cmdSelezionaPedana_Click"
End Sub

Public Sub RecuperaDati()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsNew As ADODB.Recordset

sSQL = "SELECT RV_POAssegnazioneMerce.*, Anagrafica.Anagrafica AS Cliente, RV_POCaricoMerceRighe.CodiceArticolo as CodiceArticoloConferito, "
sSQL = sSQL & "RV_POCaricoMerceRighe.Articolo AS ArticoloConferito, RV_POCaricoMerceTesta.DataDocumento AS DataDocumentoConferimento, "
sSQL = sSQL & "RV_POCaricoMerceTesta.NumeroDocumento AS NumeroDocumentoConferimento "
sSQL = sSQL & "FROM RV_POCaricoMerceTesta RIGHT OUTER JOIN "
sSQL = sSQL & "RV_POCaricoMerceRighe ON "
sSQL = sSQL & "RV_POCaricoMerceTesta.IDRV_POCaricoMerceTesta = RV_POCaricoMerceRighe.IDRV_POCaricoMerceTesta RIGHT OUTER JOIN "
sSQL = sSQL & "RV_POAssegnazioneMerce ON "
sSQL = sSQL & "RV_POCaricoMerceRighe.IDRV_POCaricoMerceRighe = RV_POAssegnazioneMerce.IDRV_POCaricoMerceRighe LEFT OUTER JOIN "
sSQL = sSQL & "Anagrafica ON RV_POAssegnazioneMerce.IDCliente = Anagrafica.IDAnagrafica "
sSQL = sSQL & "WHERE RV_POcaricoMerceTesta.IDFiliale = " & TheApp.Branch
sSQL = sSQL & " AND RV_POAssegnazioneMerce.Colli > 0 "
sSQL = sSQL & " AND RV_POAssegnazioneMerce.IDRV_POAssegnazioneMerce=" & LINK_ASSEGNAZIONE

Set rs = Cn.OpenResultset(sSQL)

sSQL = "DELETE FROM RV_POEtichette WHERE IDUtente=" & TheApp.IDUser
Cn.Execute sSQL

Set rsNew = New ADODB.Recordset
rsNew.Open "RV_POEtichette", Cn.InternalConnection, adOpenDynamic, adLockPessimistic


While Not rs.EOF
    rsNew.AddNew
        GET_ColliStampati fnNotNullN(rs!IDRV_POAssegnazioneMerce), fnNotNullN(rs!Colli)

        rsNew!IDRV_POEtichette = fnGetNewKey("RV_POEtichette", "IDRV_POEtichette")
        rsNew!DaStampare = True
        rsNew!IDUtente = TheApp.IDUser
        rsNew!IDRV_POAssegnazioneMerce = fnNotNullN(rs!IDRV_POAssegnazioneMerce)
        rsNew!CodiceSocio = fnNotNull(rs!CodiceSocio)
        rsNew!DataConferimento = rs!DataDocumentoConferimento
        rsNew!NumeroConferimento = fnNotNullN(rs!NumeroDocumentoConferimento)
        rsNew!CodiceArticoloConferito = fnNotNull(rs!CodiceArticoloConferito)
        rsNew!ArticoloConferito = fnNotNull(rs!ArticoloConferito)
        rsNew!DataLavorazione = fnNotNull(rs!DataDocumento)
        rsNew!IDArticolo = fnNotNullN(rs!IDArticolo)
        rsNew!CodiceArticolo = fnNotNull(rs!CodiceArticolo)
        rsNew!Articolo = fnNotNull(rs!Articolo)
        rsNew!CodiceLotto = fnNotNull(rs!CodiceLottoVendita)
        rsNew!Colli = fnNotNullN(rs!Colli)
        rsNew!ColliDaStampare = fnNotNullN(ColliDaStampare)
        rsNew!ColliStampati = fnNotNullN(ColliStampati)
        rsNew!PesoNetto = fnNotNullN(rs!PesoNetto)
        rsNew!PesoLordo = fnNotNullN(rs!PesoLordo)
        rsNew!Pezzi = fnNotNullN(rs!Pezzi)
        rsNew!Tara = fnNotNullN(rs!Tara)
        rsNew!NumeroOrdine = fnNotNull(rs!NumeroOrdine)
        rsNew!DataOrdine = fnNotNull(rs!DataOrdine)
        rsNew!Cliente = fnNotNull(rs!Cliente)
        rsNew!CodicePedana = fnNotNull(rs!CodicePedana)
        rsNew!IDRV_POPedana = fnNotNull(rs!IDRV_POPedana)
        
    rsNew.Update
    
    
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing




End Sub

Private Sub GET_ColliStampati(IDLavorazione As Long, ColliLavorazione As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT ColliStampati FROM RV_POEtichetteLavorazione WHERE IDRV_POlavorazione=" & IDLavorazione

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    ColliStampati = 0
   
Else
    ColliStampati = fnNotNullN(rs!ColliStampati)
   
End If

ColliDaStampare = ColliLavorazione - ColliStampati

rs.CloseResultset
Set rs = Nothing
End Sub




Private Sub cmdSelRigaOrdine_Click()

If Me.chkPreConferimento.Value = vbChecked Then Exit Sub
Dim Testo As String

    MODALITA_RECUPERO_RIGA_ORD = 1
    LINK_ORDINE_PER_PREZZO = Me.txtIDOrdinePadre.Value
    
    If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) > 0 Then RECUPERO_PREZZI_DA_ORD = True
    
    frmCorpoOrdine.Show vbModal
    
    If VIS_NOTE_LAV_DA_ORD = 1 Then
        If Me.txtIDRigaOrdine.Value > 0 Then
            Testo = GET_TESTO_RIGA_LAV_DA_ORD(Me.txtIDRigaOrdine.Value)
            If Len(Trim(Testo)) > 0 Then
                MsgBox Testo, vbInformation, "Note lavorazione da ordine"
            End If
        End If
    End If
    
    RECUPERO_PREZZI_DA_ORD = False
End Sub

Private Sub cmdStampaEtichettaPedana_Click()
Dim f As FileSystemObject
Dim DATA_CREAZIONE_FILE As String


Set f = New FileSystemObject
If Me.chkNuovoMetodo.Value = 0 Then
    If Me.txtNumeroEtichettePed.Value > 0 Then
        If Me.cboReportPed.CurrentID > 0 Then
            If Len(Me.cboStampantePed.Text) > 0 Then
                CREA_PEDANA_PER_STAMPA Me.txtIDPedana.Value, True
            End If
        End If
    End If
Else
    If Len(Me.cboStampantePedNew.Text) > 0 Then
        If Me.txtNumeroEtichettePedNew.Value > 0 Then
            If f.FileExists(MenuOptions.ReportsPath & "\" & Me.txtNomeReportPedana.Text) = False Then
                 CREA_REPORT Me.cboReportPedNew.CurrentID, Me.txtNomeReportPedana.Text
            Else
                DATA_CREAZIONE_FILE = f.GetFile((MenuOptions.ReportsPath & "\" & Me.txtNomeReportPedana.Text)).DateLastAccessed
                If DateDiff("d", DATA_CREAZIONE_FILE, Me.txtDataCreazioneReportPedana.Text) > 0 Then
                   CREA_REPORT Me.cboReportPedNew.CurrentID, Me.txtNomeReportPedana.Text
                End If
            End If
        End If
    End If

    If Len(Me.cboStampantePedNew.Text) > 0 Then
        If Me.txtNumeroEtichettePedNew.Value > 0 Then
            SCRIVI_ETICHETTE_PEDANA_NEW Me.txtIDPedana.Value, True, Me.cboReportPedNew.CurrentID
            StampaNew Me.cboStampantePedNew.Text, Me.txtNomeReportPedana.Text, Me.txtNumeroEtichettePedNew.Value, Me.txt_X_Pedana.Text, Me.txt_Y_Pedana.Text, Me.txtOrientamentoPedana.Text
        End If
    End If
    
End If
End Sub

Private Sub cmdStampaEtichette_Click()
'On Error GoTo ERR_CmdStampaEtichette_Click
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim rsEti As ADODB.Recordset
Dim rsNew As ADODB.Recordset
Dim I As Integer
Dim Unita_progresso
Dim NumeroRecord As Long
Dim Link_Lotto As Long
Dim NonStampareEtichetteColli As Long

NonStampareEtichetteColli = 1

    If Me.cboReport.CurrentID = 0 Then
        NonStampareEtichetteColli = 0
    End If
    
    If Len(Me.cboStampa.Text) = 0 Then
        NonStampareEtichetteColli = 0
    End If
    
If NonStampareEtichetteColli = 1 Then
    If Me.txtNumeroEtichette.Value > 0 Then
    
        sSQL = "DELETE FROM RV_POTMPStampaEtichetteRighe "
        sSQL = sSQL & "WHERE IDUtente=" & TheApp.IDUser
        Cn.Execute sSQL
        

        Cn.BeginTrans
        
        Screen.MousePointer = 11
        Set rsNew = New ADODB.Recordset
        rsNew.Open "RV_POTMPStampaEtichetteRighe", Cn.InternalConnection, adOpenDynamic, adLockPessimistic

            rsNew.AddNew
                'CAMPI OBBLIGATORI
                rsNew!IDUtente = TheApp.IDUser
                rsNew!IDAzienda = TheApp.IDFirm
                rsNew!IDFiliale = TheApp.Branch
                rsNew!IDRV_POAssegnazioneMerce = fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
                rsNew!IDRV_POPedana = Me.txtIDPedana.Value
                rsNew!CodicePedana = Me.txtCodicePedana.Text

                'CAMPI LAVORAZIONE
                rsNew!IDArticolo = Me.CDArticolo.KeyFieldID
                rsNew!CodiceArticolo = Me.CDArticolo.Code
                rsNew!Articolo = Me.TxtArticolo.Text
                rsNew!IDArticoloImballo = Me.CDCodiceImballo.KeyFieldID
                rsNew!CodiceImballo = Me.CDCodiceImballo.Code
                rsNew!Imballo = Me.CDCodiceImballo.Description
                rsNew!Colli = Me.txtColli.Value
                rsNew!PesoLordo = Me.txtPesoLordo.Value
                rsNew!Tara = Me.txtTara.Value
                rsNew!PesoNetto = Me.txtPesoNetto.Value
                rsNew!Pezzi = Me.txtPezzi.Value
                rsNew!Qta_UM = Me.txtQta_UM.Value
                If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
                    Link_Lotto = GET_NUMERO_LOTTO
                    rsNew!CodiceLotto = fnGetCodiceLotto(2, 1, Me.txtLottoVendita.Text, Link_Lotto)
                Else
                    rsNew!CodiceLotto = Me.txtLottoVendita.Text
                End If
                rsNew!IDAnagraficaSocio = fnNotNullN(m_Document("IDAnagrafica").Value)
                rsNew!AnagraficaSocio = fnNotNull(m_Document("Anagrafica").Value)
                rsNew!NomeSocio = fnNotNull(m_Document("Nome").Value)
                rsNew!CodiceSocio = fnNotNull(m_Document("CodiceSocio").Value)
                rsNew!IDRV_POCalibro = Me.cboCalibro.CurrentID
                rsNew!Calibro = Me.cboCalibro.Text
                rsNew!IDRV_POTipoCategoria = Me.cboTipoCategoria.CurrentID
                rsNew!TipoCategoria = Me.cboTipoCategoria.Text
                rsNew!CodiceABarreArticolo = fnNotNull(GET_CODICEABARRE(Me.CDArticolo.KeyFieldID)) 'X
                rsNew!DescrizioneCodiceABarreArticoloAzienda = fnNotNull(GET_DESCRIZIONECODICEABARRE(Me.CDArticolo.KeyFieldID)) 'X
                rsNew!CodiceABarreImballoAzienda = fnNotNull(GET_CODICEABARRE(Me.CDCodiceImballo.KeyFieldID)) 'X
                rsNew!DescrizioneCodiceABarreImballoAzienda = fnNotNull(GET_DESCRIZIONECODICEABARRE(Me.CDCodiceImballo.KeyFieldID)) 'X
                rsNew!LinguaPredefinita = Me.cboLinguaPred.Text
                rsNew!CodicePostazioneUtente = Me.txtCodicePostazione.Text
                rsNew!TipoProdottoArticoloLavorato = TIPO_PRODOTTO_ARTICOLO_LAVORATO
                rsNew!CategoriaMerceologicaArticoloLavorato = CATEGORIA_MERCEOLOGICA_ARTICOLO_LAVORATO
                rsNew!FamigliaArticoloLavorato = FAMIGLIA_ARTICOLO_LAVORATO
                rsNew!VarietaArticoloLavorato = VARIETA_ARTICOLO_LAVORATO
                rsNew!UnitaDiMisuraArticoloLavorato = Me.cboUM.Text
                rsNew!UnitaDiMisuraImballoLavorato = Me.cboUMImballo.Text
                If Me.txtDataOrdine.Value > 0 Then
                    rsNew!DataOrdine = Me.txtDataOrdine.Text
                End If
                rsNew!NumeroOrdine = Me.txtNumeroOrdine.Value
                If Me.txtDataOrdineCliente.Value > 0 Then
                    rsNew!DataOrdinePressoCliente = Me.txtDataOrdineCliente.Text
                End If
                rsNew!NumeroOrdinePressoCliente = Me.txtNumeroOrdineCliente.Text
            
                If Trim(Me.txtArticoloInLinguaPred.Text) <> "" Then
                    rsNew!DescrizioneArticoloInLinguaPredefinita = Me.txtArticoloInLinguaPred.Text
                Else
                     rsNew!DescrizioneArticoloInLinguaPredefinita = Me.TxtArticolo.Text
                End If
                If Trim(Me.txtCalibroInLiguaPred.Text) <> "" Then
                    rsNew!DescrizioneCalibroInLinguaPredefinita = Me.txtCalibroInLiguaPred.Text
                Else
                    rsNew!DescrizioneCalibroInLinguaPredefinita = Me.cboCalibro.Text
                End If
                
                If Trim(Me.txtCategoriaInLinguaPred.Text) <> "" Then
                    rsNew!DescrizioneCategoriaInLinguaPredefinita = Me.txtCategoriaInLinguaPred.Text
                Else
                    rsNew!DescrizioneCategoriaInLinguaPredefinita = Me.cboTipoCategoria.Text
                End If
                'MERCE
                'rsNew!IDRegione = fnNotNullN(m_Document("IDRegione").Value)
                rsNew!Regione = REGIONE_PROVENIENZA 'Me.txtRegioneProvenienza.Text
                'rsNew!IDNazione = fnNotNullN(m_Document("IDNazione").Value)
                rsNew!Nazione = NAZIONE_PROVENIENZA ' Me.txtNazioneProvenienza.Text
                'rsNew!IDComune = fnNotNullN(m_Document("IDComune").Value)
                rsNew!Comune = COMUNE_PROVENIENZA ' Me.txtComuneProvenienza.Text
                'rsNew!IDProvincia = fnNotNullN(m_Document("IDProvincia").Value)
                rsNew!Provincia = PROVINCIA_PROVENIENZA ' Me.txtProvinciaProvenienza.Text
      
                
                'DATI CONFERIMENTO
                rsNew!LottoDiConferimento = Me.txtCodiceLotto_Conf.Text
                rsNew!BNDOO = BNDOO ' Me.txtBNDOO.Text
                rsNew!IDLottoDiCampagna = fnNotNullN(m_Document("IDLottoDiCampagna").Value)
                rsNew!CodiceCertificazioneLotto = CODICE_CERTIFICAZIONE_LOTTO_ETI
                rsNew!DescrizioneCertificazioneLotto = DESCRIZIONE_CERTIFICAZIONE_LOTTO_ETI
                rsNew!ProtocolloCertificazioneLotto = PROTOCOLLO_CERTIFICAZIONE_LOTTO_ETI
                rsNew!EnteCertificatoreLotto = ENTE_CERTIFICAZIONE_LOTTO_ETI
                rsNew!CodiceCertificazioneSocioPred = CODICE_CERTIFICAZIONE_SOCIO_ETI
                rsNew!DescrizioneCertificazioneSocioPred = DESCRIZIONE_CERTIFICAZIONE_SOCIO_ETI
                rsNew!ProtocolloCertificazioneSocioPred = PROTOCOLLO_CERTIFICAZIONE_SOCIO_ETI
                rsNew!EnteCertificatoreSocioPred = ENTE_CERTIFICAZIONE_SOCIO_ETI
                rsNew!IDCategoriaMerceologica = fnNotNullN(m_Document("IDCategoriaMerceologica").Value) 'X
                rsNew!CategoriaMerceologica = fnNotNull(m_Document("CategoriaMerceologica").Value) 'X
                rsNew!IDTipoProdotto = fnNotNullN(m_Document("IDTipoProdotto").Value) 'X
                rsNew!TipoProdotto = fnNotNull(m_Document("TipoProdotto").Value) 'X
                rsNew!CodiceLottoEntrata = Me.txtLottoEntrata.Text
                rsNew!CodiceAssociato = CODICE_ASSOCIATO_PRED ' Me.txtCodiceAssociatoPredefinito.Text
                rsNew!IDVarietaLottoCampagna = LINK_VARIETA_LOTTO_CAMPAGNA
                rsNew!IDFamigliaLottoCampagna = LINK_FAMIGLIA_LOTTO_CAMPAGNA
                rsNew!VarietaLottoCampagna = VARIETA_LOTTO_CAMPAGNA
                rsNew!FamigliaLottoCampagna = FAMIGLIA_LOTTO_CAMPAGNA
                rsNew!IDTipoProduzioneLottoCampagna = LINK_TIPO_PRODUZIONE_LOTTO_CAMPAGNA
                rsNew!TipoProduzioneLottoCampagna = TIPO_PRODUZIONE_LOTTO_CAMPAGNA
                rsNew!VarietaArticoloConferito = VARIETA_ARTICOLO_CONFERITO
                rsNew!FamigliaArticoloConferito = FAMIGLIA_ARTICOLO_CONFERITO
                

                
                'CAMPI CLIENTE
                rsNew!NumeroPedanaCliente = Me.txtCodicePedanaCliente.Value
                rsNew!CodicePedanaCliente = Me.txtCodificaCodicePedanaCliente.Text
                rsNew!IDAnagraficaCliente = Me.cdCliente.KeyFieldID
                rsNew!AnagraficaCliente = Me.cdCliente.Description
                rsNew!LottoCliente = Me.txtLottoCliente.Text
                rsNew!AltreAnnotazioniCliente = Me.txtAltreAnnotazioniCliente.Text
                rsNew!CLIENTE_INDIRIZZO = CLIENTE_INDIRIZZO
                rsNew!CLIENTE_COMUNE = CLIENTE_COMUNE
                rsNew!CLIENTE_PROVINCIA = CLIENTE_PROVINCIA
                rsNew!CLIENTE_REGIONE = CLIENTE_REGIONE
                rsNew!CLIENTE_NAZIONE = CLIENTE_NAZIONE
                rsNew!CLIENTE_PARTITAIVA = CLIENTE_PARTITA_IVA
                rsNew!CLIENTE_CAP = CLIENTE_CAP
                rsNew!CLIENTE_PROVINCIA = CLIENTE_PROVINCIA
                rsNew!CLIENTE_TELEFONO = CLIENTE_TELEFONO
                rsNew!CLIENTE_FAX = CLIENTE_FAX
                rsNew!CLIENTE_EMAIL = CLIENTE_EMAIL
                rsNew!CLIENTE_INDIRIZZOWEB = CLIENTE_INDIRIZZOWEB
                If Me.txtDataPartenza.Value > 0 Then
                    rsNew!DataPartenzaOrdine = Me.txtDataPartenza.Text
                End If
                rsNew!CodiceAssociatoPressoCliente = Me.txtCodiceAssociatoPressoCliente.Text
                rsNew!CodiceABarreArticoloCliente = Me.txtCodificaArticoloCodiceABarre.Text
                rsNew!DescrizioneCodiceABarreArticoloCliente = Me.txtCodiceABarreArticoloCliente.Text
                rsNew!CodiceABarreImballoCliente = Me.txtCodificaImballoCodiceABarre.Text
                rsNew!DescrizioneCodiceABarreImballoCliente = Me.txtCodiceABarreImballoCliente.Text
                rsNew!DescrizioneArticoloInLinguaCliente = Me.txtDescrizioneArticoloInLinguaCliente.Text
                rsNew!DescrizioneCalibroInLinguaCliente = Me.txtCalibroInLingua.Text
                rsNew!DescrizioneCategoriaInLinguaCliente = Me.txtCategoriaInLingua.Text
                rsNew!LinguaCliente = Me.cboLinguaCliente.Text
                rsNew!CodiceGSI = Me.txtCodiceGSICliente.Text
                

                'DATI AZIENDA
                rsNew!AZIENDA_DENOMINAZIONE = AZIENDA_DENOMINAZIONE
                rsNew!AZIENDA_INDIRIZZO = AZIENDA_INDIRIZZO
                rsNew!AZIENDA_COMUNE = AZIENDA_COMUNE
                rsNew!AZIENDA_PROVINCIA = AZIENDA_PROVINCIA
                rsNew!AZIENDA_NAZIONE = AZIENDA_NAZIONE
                rsNew!AZIENDA_CAP = AZIENDA_CAP
                rsNew!AZIENDA_REGIONE = AZIENDA_REGIONE
                rsNew!AZIENDA_TELEFONO = AZIENDA_TELEFONO
                rsNew!Azienda_PartitaIva = AZIENDA_PARTITA_IVA
                rsNew!AZIENDA_FAX = AZIENDA_FAX
                rsNew!AZIENDA_EMAIL = AZIENDA_EMAIL
                rsNew!AZIENDA_INDIRIZZOWEB = AZIENDA_INDIRIZZOWEB
                
                'DATI FILIALE
                rsNew!FILIALE_DENOMINAZIONE = FILIALE_DENOMINAZIONE
                rsNew!FILIALE_INDIRIZZO = FILIALE_INDIRIZZO
                rsNew!FILIALE_COMUNE = FILIALE_COMUNE
                rsNew!FILIALE_REGIONE = FILIALE_REGIONE
                rsNew!FILIALE_PROVINCIA = FILIALE_PROVINCIA
                rsNew!FILIALE_NAZIONE = FILIALE_PROVINCIA
                rsNew!FILIALE_CAP = FILIALE_CAP
                
                'DATI SOCIO
                rsNew!SOCIO_INDIRIZZO = SOCIO_INDIRIZZO
                rsNew!SOCIO_COMUNE = SOCIO_COMUNE
                rsNew!SOCIO_CAP = SOCIO_CAP
                rsNew!SOCIO_NAZIONE = SOCIO_NAZIONE
                rsNew!SOCIO_REGIONE = SOCIO_REGIONE
                rsNew!SOCIO_PROVINCIA = SOCIO_PROVINCIA
                rsNew!SOCIO_TELEFONO = SOCIO_TELEFONO
                rsNew!SOCIO_FAX = SOCIO_FAX
                rsNew!SOCIO_EMAIL = SOCIO_EMAIL
                rsNew!SOCIO_INDIRIZZOWEB = SOCIO_INDIRIZZOWEB
                rsNew!Socio_PartitaIva = SOCIO_PARTITA_IVA
                
                'CERTIFIZIONE AZIENDA
                rsNew!CodiceCertificazioneAzienda = CODICE_CERTIFICAZIONE_AZIENDA
                rsNew!DescrizioneCertificazioneAzienda = DESCRIZIONE_CERTIFICAZIONE_AZIENDA
                rsNew!ProtocolloCertificazioneAzienda = PROTOCOLLO_CERTIFICAZIONE_AZIENDA
                rsNew!EnteCertificatoreAzienda = ENTE_CERTIFICAZIONE_AZIENDA
                

                'CERTIFIZIONE FAMIGLIA PRODOTTO DELL'ARTICOLO LAVORATO
                rsNew!CodiceCertificazioneFamLav = CODICE_CERTIFICAZIONE_FAM_LAV
                rsNew!DescrizioneCertificazioneFamLav = DESCRIZIONE_CERTIFICAZIONE_FAM_LAV
                rsNew!ProtocolloCertificazioneFamLav = PROTOCOLLO_CERTIFICAZIONE_FAM_LAV
                rsNew!EnteCertificatoreFamLav = ENTE_CERTIFICAZIONE_FAM_LAV
                
                
                'CERTIFIZIONE FAMIGLIA PRODOTTO DELL'ARTICOLO CONFERITO
                rsNew!CodiceCertificazioneFamConf = CODICE_CERTIFICAZIONE_FAM_CONF
                rsNew!DescrizioneCertificazioneFamConf = DESCRIZIONE_CERTIFICAZIONE_FAM_CONF
                rsNew!ProtocolloCertificazioneFamConf = PROTOCOLLO_CERTIFICAZIONE_FAM_CONF
                rsNew!EnteCertificatoreFamConf = ENTE_CERTIFICAZIONE_FAM_CONF

                'DATI DESTINAZIONE MERCE
                rsNew!Cliente_DestinazioneOrdine = DESTINAZIONE_MERCE
                rsNew!Cliente_DestinazioneIndirizzo = DESTINAZIONE_INDIRIZZO
                rsNew!Cliente_DestinazioneComune = DESTINAZIONE_COMUNE
                rsNew!Cliente_DestinazioneProvincia = DESTINAZIONE_PROVINCIA
                rsNew!Cliente_DestinazioneCap = DESTINAZIONE_CAP
                rsNew!Cliente_DestinazioneNazione = DESTINAZIONE_NAZIONE
                rsNew!Cliente_DestinazioneTelefono = DESTINAZIONE_TELEFONO
                rsNew!Cliente_DestinazioneFax = DESTINAZIONE_FAX
                
                'DATI VETTORE
                rsNew!Vettore_Ordine = VETTORE
                rsNew!VETTORE_INDIRIZZO = VETTORE_INDIRIZZO
                rsNew!VETTORE_COMUNE = VETTORE_COMUNE
                rsNew!VETTORE_PROVINCIA = VETTORE_PROVINCIA
                rsNew!VETTORE_CAP = VETTORE_CAP
                rsNew!VETTORE_NAZIONE = VETTORE_NAZIONE
                rsNew!VETTORE_TELEFONO = VETTORE_TELEFONO
                rsNew!VETTORE_FAX = VETTORE_FAX
                rsNew!Vettore_PartitaIva = VETTORE_PARTITA_IVA
                rsNew!Vettore_NumeroAlbo = VETTORE_NUMERO_ALBO
                
                ''PASSAPORTO
                rsNew!RV_PO01_NumeroPassaportoRighe = Me.txtNumeroProtocollo.Value
                rsNew!RV_PO01_IDSezionaleRighe = Link_Sezionale_Dettagliato
                
                'LOTTO IMBALLO
                GET_LOTTI_IMBALLO_PER_ETICHETTA rsNew
                
                
            rsNew.Update
            
            Cn.CommitTrans
            
            DoEvents
            'Exit Sub
            Screen.MousePointer = 0
            
            StampaEtichette
            DoEvents
 
            
            rsNew.Close
            Set rsNew = Nothing
            
            'rsEti.Close
            'Set rsEti = Nothing
            Screen.MousePointer = 0
    End If
End If
        
If GET_STAMPA_PEDANA = True Then
    If Me.txtNumeroEtichettePed.Value > 0 Then
        If Me.cboReportPed.CurrentID > 0 Then
            If Len(Me.cboStampantePed.Text) > 0 Then
                CREA_PEDANA_PER_STAMPA Me.txtIDPedana.Value, True
            End If
        End If
    End If
End If

Exit Sub
ERR_CmdStampaEtichette_Click:
    MsgBox Err.Description, vbCritical, "cmdStampaEtichette_Click"
    Screen.MousePointer = 0
    Cn.RollbackTrans
End Sub
Private Function GET_CODICE_PEDANA_CLIENTE(NumeroPedanaCliente As Long) As String
Dim I As Integer
GET_CODICE_PEDANA_CLIENTE = ""
For I = Len(CStr(NumeroPedanaCliente)) To MAX_CARATTERI_PEDANA_CLIENTE
    GET_CODICE_PEDANA_CLIENTE = GET_CODICE_PEDANA_CLIENTE & "0"
Next

GET_CODICE_PEDANA_CLIENTE = GET_CODICE_PEDANA_CLIENTE & CStr(NumeroPedanaCliente)
End Function
Private Sub cmdStampaEtichetteNew_Click()
Dim f As FileSystemObject
Dim DATA_CREAZIONE_FILE As String

If (m_DocumentsLink.BOF And m_DocumentsLink.EOF) Then Exit Sub

Set f = New FileSystemObject

If Len(Me.cboStampaNew.Text) > 0 Then
    If Me.txtNumeroEtichetteNew.Value > 0 Then
        REFRESH_DATI_ETICHETTA 1, Me.cboReportNew.CurrentID
    
        If f.FileExists(MenuOptions.ReportsPath & "\" & Me.txtNomeReportLavorazione.Text) = False Then
            CREA_REPORT Me.cboReportNew.CurrentID, Me.txtNomeReportLavorazione.Text
        Else
            DATA_CREAZIONE_FILE = f.GetFile((MenuOptions.ReportsPath & "\" & Me.txtNomeReportLavorazione.Text)).DateLastAccessed
            If DateDiff("n", DATA_CREAZIONE_FILE, Me.txtDataCreazioneReportLavorazione.Text & " " & Me.txtOraCreazioneReportLavorazione.Text) > 0 Then
                CREA_REPORT Me.cboReportNew.CurrentID, Me.txtNomeReportLavorazione.Text
            End If
        End If
    End If
End If

If Len(Me.cboStampantePedNew.Text) > 0 Then
    If Me.txtNumeroEtichettePedNew.Value > 0 Then
        REFRESH_DATI_ETICHETTA 2, Me.cboReportPedNew.CurrentID
        
        If f.FileExists(MenuOptions.ReportsPath & "\" & Me.txtNomeReportPedana.Text) = False Then
             CREA_REPORT Me.cboReportPedNew.CurrentID, Me.txtNomeReportPedana.Text
        Else
            DATA_CREAZIONE_FILE = f.GetFile((MenuOptions.ReportsPath & "\" & Me.txtNomeReportPedana.Text)).DateLastAccessed
            If DateDiff("n", DATA_CREAZIONE_FILE, Me.txtDataCreazioneReportPedana.Text & " " & Me.txtOraCreazioneReportPedana.Text) > 0 Then
               CREA_REPORT Me.cboReportPedNew.CurrentID, Me.txtNomeReportPedana.Text
            End If
        End If
    End If
End If

If Len(Me.cboStampaNew.Text) > 0 Then
    If Me.txtNumeroEtichetteNew.Value > 0 Then
        SCRIVI_ETICHETTE_LAVORAZIONE_NEW Me.cboReportNew.CurrentID
        StampaNew Me.cboStampaNew.Text, Me.txtNomeReportLavorazione.Text, Me.txtNumeroEtichetteNew.Value, Me.txt_X_Lavorazione.Text, Me.txt_Y_Lavorazione.Text, Me.txtOrientamentoLavorazione.Text
    End If
End If

If Len(Me.cboStampantePedNew.Text) > 0 Then
    If Me.txtNumeroEtichettePedNew.Value > 0 Then
        SCRIVI_ETICHETTE_PEDANA_NEW Me.txtIDPedana.Value, True, Me.cboReportPedNew.CurrentID
        StampaNew Me.cboStampantePedNew.Text, Me.txtNomeReportPedana.Text, Me.txtNumeroEtichettePedNew.Value, Me.txt_X_Pedana.Text, Me.txt_Y_Pedana.Text, Me.txtOrientamentoPedana.Text
    End If
End If

Screen.MousePointer = 0
End Sub

Private Sub cmdStampaPedanaCliente_Click()
Dim f As FileSystemObject
Dim DATA_CREAZIONE_FILE As String

Set f = New FileSystemObject
If Me.chkNuovoMetodo.Value = 0 Then
    If Me.txtNumeroEtichettePed.Value > 0 Then
        If Me.cboReportPed.CurrentID > 0 Then
            If Len(Me.cboStampantePed.Text) > 0 Then
                CREA_PEDANA_PER_STAMPA Me.txtCodicePedanaCliente.Value, False
            End If
        End If
    End If
Else
    If Len(Me.cboStampantePedNew.Text) > 0 Then
        If Me.txtNumeroEtichettePedNew.Value > 0 Then
            If f.FileExists(MenuOptions.ReportsPath & "\" & Me.txtNomeReportPedana.Text) = False Then
                 CREA_REPORT Me.cboReportPedNew.CurrentID, Me.txtNomeReportPedana.Text
            Else
                DATA_CREAZIONE_FILE = f.GetFile((MenuOptions.ReportsPath & "\" & Me.txtNomeReportPedana.Text)).DateLastAccessed
                If DateDiff("d", DATA_CREAZIONE_FILE, Me.txtDataCreazioneReportPedana.Text) > 0 Then
                   CREA_REPORT Me.cboReportPedNew.CurrentID, Me.txtNomeReportPedana.Text
                End If
            End If
        End If
    End If

    If Len(Me.cboStampantePedNew.Text) > 0 Then
        If Me.txtNumeroEtichettePedNew.Value > 0 Then
            SCRIVI_ETICHETTE_PEDANA_NEW Me.txtCodicePedanaCliente.Value, False, Me.cboReportPedNew.CurrentID
            StampaNew Me.cboStampantePedNew.Text, Me.txtNomeReportPedana.Text, Me.txtNumeroEtichettePedNew.Value, Me.txt_X_Pedana.Text, Me.txt_Y_Pedana.Text, Me.txtOrientamentoPedana.Text
        End If
    End If

End If
End Sub
Private Sub Command1_Click()
    CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
End Sub

Private Sub Command2_Click()
    GET_IMBALLO_PER_ARTICOLO_CONF Me.CDArticolo.KeyFieldID
End Sub

Private Sub Command3_Click()
    GET_CONFEZIONI_IMBALLO_PER_ARTICOLO Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID
End Sub

Private Sub Form_Activate()
On Error GoTo ERR_Form_Activate
    'Il codice di Form_Activate deve essere eseguito soltanto la prima volta,
    'all'avvio del programma.
    '
    'La variabile m_bOnFirstTime è usata per evitare di eseguire il codice seguente
    'quando si chiude un Form di dialogo e si riattiva frmMain.
    '
    'Queste inizializzazioni non sono state effettuate nella Sub Main() per evitare di
    'rendere visibili le variabili m_DocType, m_Document e m_Changed.
    If m_bOnFirstTime = True Then
        
        Me.txtPesoLordo.DecimalPlaces = Numero_Decimali_Pesi
        Me.txtPesoLordo_Q.DecimalPlaces = Numero_Decimali_Pesi
        Me.txtPesoNetto.DecimalPlaces = Numero_Decimali_Pesi
        Me.txtPesoNetto_Q.DecimalPlaces = Numero_Decimali_Pesi
        Me.txtTara.DecimalPlaces = Numero_Decimali_Pesi
        Me.txtTara_Q.DecimalPlaces = Numero_Decimali_Pesi
        
        
        m_bOnFirstTime = False

        'Se il filtro di default restituisce dei record si va in modalità variazione
        'ma solo se il primo record non è bloccato altrimenti si va in modalità tabellare
        If Not (m_Document.EOF = True And m_Document.BOF = True) Then
            'Il filtro ha restituito almeno un record
             
            'Controlla se il primo record su cui si dovrebbe andare in variazione è bloccato.
            If m_Semaphore.IsActionAvailable(m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions) Then
                'Il primo record NON è bloccato
                'allora si effettua il blocco e si va in modalità Variazione
                
                m_Semaphore.SetObjectAction m_DocType.ID, m_Document.Fields("ID" & m_App.TableName).Value, SemAllActions
                
                'La vista alla partenza deve essere quella del Form
                BrwMain.Visible = False
                
                If LAVORAZIONE_AUTOMATICA = 1 Then
                    m_Document.AbortNew
                    m_Changed = False
                    ActivateBarButtons BTN_SAVE, False
                    bLoadingDaProcesso = True
                    If (LINK_PROCESSO_RIGHE_PROD = 0) Then
                        
                        GET_PREPARAZIONE_RIGA_CONFERIMENTO_AUTOMATICO fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
                        
                        If PEDANA_AUTOMATICA = 1 Then
                            cmdNuovaPedana_Click
                        End If
                        If ORDINE_AUTOMATICO = 1 Then
                            If fnNotNullN(m_Document("IDOggettoOrdine").Value) = 0 Then
                                Me.cdCliente.Load LINK_CLIENTE_ORD_PRED
                                Me.txtDataOrdine.Text = DATA_ORDINE_PRED
                                Me.txtNumeroOrdine.Value = NUMERO_ORDINE_PRED
                            Else
                                Me.cdCliente.Load fnNotNullN(m_Document("IDAnagraficaOrdine").Value)
                                Me.txtDataOrdine.Text = fnNotNull(m_Document("DataOrdine").Value)
                                Me.txtNumeroOrdine.Value = fnNotNullN(m_Document("NumeroOrdine").Value)
                            End If
                            LINK_ORDINE_RIF = GET_ESISTENZA_ORDINE
                            Me.txtIDOrdineCliente.Value = LINK_ORDINE_RIF
                        End If
                    Else
                        
                        GET_PREPARAZIONE_RIGA_DA_PROCESSO LINK_PROCESSO_RIGHE_PROD
                    End If
                    bLoadingDaProcesso = False
                End If
                'Imposta la modalità variazione
                SetStatus4Modality Browse
            Else
                'Il primo record è bloccato
                'allora si parte in modalità tabellare
                
                BrwMain.Visible = True
                
                SetStatus4Modality Browse
            End If

            RefreshDescriptions4StatusBar
        Else
            'Il filtro di default non ha restituito nessun record.
            'Si va in modalità inserimento nuovo record
            NewRecord
            'BrwMain.GuiMode = dgFilterDefinition
            'BrwMain.Visible = True
                
            'SetStatus4Modality Find

        End If
               
    End If
    
    If MODULO_ATTIVATO = 0 Then
        If Len(MODULO_DESCRIZIONE) > 0 Then
            MsgBox "Il modulo " & MODULO_DESCRIZIONE & " non è stato abilitato", vbInformation, TheApp.FunctionName
        Else
            MsgBox "Questa funzionalità non può essere avviata senza abilitazione", vbInformation, TheApp.FunctionName
        End If
    End If
Exit Sub
ERR_Form_Activate:
    MsgBox Err.Description, vbCritical, "Form_Activate"
End Sub

Private Sub Form_Initialize()
    ActivityBox.Visible = True
    
    'Impostazione iniziale del flag
    m_bOnFirstTime = True
    
    bEnableGuiEvent = True
End Sub

Private Sub Form_Load()
    'La vista tabellare deve trovarsi sopra tutti gli altri controlli
    BrwMain.ZOrder
    
    'IMPOSTA IL CONTROLLO CHE CONTIENTE I TUTTI GLI ALTRI CONTROLLI
    Set DMTSplitBar1.dContainer = Me.PicForm2
    'IMPOSTA L'UNITA' DI MISURA DEL FORM
    DMTSplitBar1.ScaleMode = DMTSplit_Twips
    'INIZIALIZZA LA SPLIT BAR
    DMTSplitBar1.SetSplitBar Me.ScaleHeight, Me.ScaleWidth, Me.PicForm.ScaleHeight, Me.PicForm.ScaleWidth

End Sub

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    If FORM_PESI_MEDI_SHOW = True Then
        Unload frmPesiMedi
    End If
End Sub

Private Sub Form_Resize()
    If Me.WindowState = vbMinimized Then Exit Sub
    If ActivityBox.Visible Then
        imgSplitter.Left = ActivityBox.Width + ActivityBox.Left
    End If
    If m_PreviewWindowHandle > 0 Then
        MoveWindow m_PreviewWindowHandle, CInt(BarMenu.ClientAreaLeft / Screen.TwipsPerPixelX), CInt(BarMenu.ClientAreaTop / Screen.TwipsPerPixelY), CInt(BarMenu.ClientAreaWidth / Screen.TwipsPerPixelY), CInt(BarMenu.ClientAreaHeight / Screen.TwipsPerPixelX), True
    Else
        FormRecalcLayout
    End If
End Sub

Private Sub Form_KeyDown(KeyCode As Integer, Shift As Integer)
On Error GoTo ERR_Form_KeyDown
    Dim bHandled As Boolean
    
    m_EatKey = False
    
    ShortCut KeyCode, Shift
    If KeyCode = 0 And Shift = 0 Then
        m_EatKey = True
    Else
        m_EatKey = False
    End If
    
    
    Select Case KeyCode
        Case vbKeyPageDown
            DMTSplitBar1.ScrollDown
        Case vbKeyPageUp
            DMTSplitBar1.ScrollUp
    End Select

            
    If KeyCode = vbKeyF12 Then
        If SSTab1.Tab = 0 Then
            Link_ArticoloPadre = m_Document("IDArticolo").Value
            frmArticoliDerivati.Show vbModal
        End If
    End If
    If KeyCode = vbKeyF11 Then
        If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) > 0 Then
            LINK_LAVORAZIONE_RIEP = fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
            
            frmRiepilogoLottoVend.Show vbModal
        End If
    
    End If
    If KeyCode = vbKeyReturn Then
        If Me.BrwMain.Visible = False Then
            Select Case SSTab1.Tab
                        
                Case 0
                    If Me.FraOrdineCliente.Height = 1095 Then
                        'txtColli_LostFocus
                        cmdSalva_Click
                    End If
                Case 1
                    cmdSalva_Q_Click
            End Select
        Else
            If Me.BrwMain.GuiMode = dgFilterDefinition Then
                ExecuteMenuCommand "ExecuteSearch"
            End If
        End If
    End If
    If KeyCode = vbKeyF2 Then
        ExecuteMenuCommand "New"
    End If
    If KeyCode = vbKeyF3 Then
        ExecuteMenuCommand "Save"
    End If
    If KeyCode = vbKeyF7 Then
        ExecuteMenuCommand "Delete"
    End If
    If KeyCode = vbKeyF5 Then
        ExecuteMenuCommand "NewSearch"
    End If
    If KeyCode = vbKeyF8 Then
        Link_ArticoloPadre = m_Document("IDArticolo").Value
        frmArticoliDerivati.Show vbModal
    End If
    If KeyCode = vbKeyF4 Then
        If fnNotNullN(m_Document(m_Document.PrimaryKey)) > 0 Then
            KeyCode = 0
            Link_RigaConferimento = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
            frmRiepilogo.Show vbModal
        End If
    End If
Exit Sub
ERR_Form_KeyDown:
    MsgBox Err.Description, vbInformation, "ERR_Form_KeyDown"
    
End Sub

Private Sub Form_KeyPress(KeyAscii As Integer)
    If m_EatKey Then KeyAscii = 0
End Sub

Private Sub Form_Unload(Cancel As Integer)

    ' ATTENZIONE
    '-------------------------------------------------------------------------------------
    ' In questo metodo qualsiasi riferimento a proprietà o metodi di un oggetto dovrebbe
    ' essere 'protetto' dal test
    '
    '                                         If obj Is Nothing then .....
    '
    ' perchè il form potrebbe essere scaricato prima che l'oggetto stesso vengana istanziato.
    '-------------------------------------------------------------------------------------
    
    'chiude e distrugge il riferimento alle connessioni
        'CloseConnection
    'Distrugge il riferimento al recordset
    Set BrwMain.Recordset = Nothing
    
    Cancel = FormUnload
End Sub

Private Sub Form_Terminate()

    'Distrugge tutti gli oggetti allocati e provvede ad eliminare gli eventuali blocchi
    'effettuati dalla Semaforo.
    '(Inserire in DestroyObjects il codice per la distruzione degli oggetti allocati)
    DestroyObjects

End Sub

Private Sub brwMain_DblClick()
    
    
'-------------------------------------------------------------------
    'Il documento si sincronizza con la browse
'    If BrwMain.ListIndex > 0 Then
'        m_Document.Move BrwMain.ListIndex - 1
'    End If
'-------------------------------------------------------------------
'NOTA: La versione attuale della dmtGrid effettua automaticamente il
'      Move sul documento.
'-------------------------------------------------------------------
    
    'Se si è in modalità FilterDefinition il DblClick e la pressione
    'di Invio non devono avere alcun effetto
    If BrwMain.GuiMode <> dgFilterDefinition Then
        AggiornamentoDocumento = 1
        ChangeView
        BrowseReposition
        
        m_Document.AbortNew
        m_Changed = False
        ActivateBarButtons BTN_SAVE, False
        AggiornamentoDocumento = 0
        If LAVORAZIONE_AUTOMATICA = 0 Then
            m_DocumentsLink_OnReposition
            m_DocumentsLink1_OnReposition
        End If
    
        
    End If
End Sub

Private Sub brwMain_KeyDown(KeyCode As Integer, Shift As Integer)

    'Alla pressione del tasto INVIO dalla modalità tabellare si passa in modalità form.
    If KeyCode = vbKeyReturn And BrwMain.GuiMode = dgNormal And BrwMain.Visible Then
        brwMain_DblClick
    End If
    
    'Viene intercettata la pressione del tasto CANC
    'e la si comunica al form.
    If KeyCode = vbKeyDelete Then
    
        'Prima di cancellare sincronizzo il documento con la selezione
        'fatta nella browse
        If BrwMain.GuiMode = dgNormal And BrwMain.ListIndex > 0 Then
            m_Document.Move BrwMain.ListIndex - 1
        End If
    
        ShortCut KeyCode, Shift
    End If
    
End Sub


'Quando si selezionano i documenti dalla modalità tabellare la Caption del form
'va costruita leggendo i valori direttamente dalla riga selezionata nella griglia
'e non da un campo del documento perchè in modalità tabellare non viene eseguito
'il Move sul documento.
Private Sub BrwMain_Reposition(ByVal AllColumns As DmtGridCtl.dgColumns)
    If Not (m_Document.EOF = True Or m_Document.BOF = True) Then
        'Monta la caption del form principale
        Me.Caption = Caption2Display(True)
    End If
End Sub


Private Sub BrwMain_OnChangeGuiMode()
    'Se si cambia modalità tramite il menù presente nel controllo
    'dmtGrid occorre effettuare delle impostazioni preliminari nella UserInterface
    
    If bEnableGuiEvent Then
    
        'Modalità FilterDefinition
        If BrwMain.GuiMode = dgFilterDefinition Then
            'Annulla una eventuale operazione di inserimento di un nuovo record
            If m_Document.TableNew Then
                m_Document.AbortNew
            End If
            
            'Impostazioni per la modalità Ricerca
            SetStatus4Modality Find
        End If


        'Modalità tabellare
        If BrwMain.GuiMode = dgNormal Then
            'Se si è premuto il pulsante "Visualizzazione tabellare" dalla browse
            'in modalità FilterDefinition e con il recordset vuoto, non si deve andare in
            'modalità tabellare (browse vuota) ma si deve restare in modalità ricerca.
            If (m_Document.EOF = True And m_Document.BOF = True) Then
                BrwMain.GuiMode = dgFilterDefinition
            Else
                'Impostazioni per la modalità tabellare
                SetStatus4Modality Browse
            End If
        End If
    
    End If
End Sub

'Scatenato prima che venga visualizzata la Toolbar della DmtGrid
Private Sub BrwMain_BeforeShowActions()
    
    'Quando si è in modalità FilterDefinition si può andare in
    'modalità tabellare solo se il documento contiene almeno un record.
    If BrwMain.GuiMode = dgFilterDefinition Then
        'Abilita/disabilita il pulsante Modalità Tabellare della dmtGrid
        BrwMain.Actions("TableMode").Enabled = (m_Document.EOF <> True And m_Document.BOF <> True)
    End If
End Sub

'Scatenato quando dalla Browse ( in modalità FilterDefinition ) si clicca su esegui ricerca.
Private Sub BrwMain_OnApplyFilter(ByVal Filter As String)
    ExecuteSearch
End Sub



Private Sub FraPedana_DblClick()
    
    If Me.FraPedana.Height = 855 Then
        Me.FraPedana.Height = 5175
    Else
        Me.FraPedana.Height = 855
    End If
End Sub

Private Sub GrigliaCorpo_Click()
Dim NumeroRecord As Long

If m_DocumentsLink.TableNew = True Then
    Screen.MousePointer = 11
    If Not (m_DocumentsLink.BOF And m_DocumentsLink.EOF) Then
        NumeroRecord = Me.GrigliaCorpo.ListIndex - 1
        AggiornamentoDocumento = 1
        
        Me.Enabled = False
        
        m_DocumentsLink.Refresh
        AggiornamentoDocumento = 0
        If Not (m_DocumentsLink.BOF And m_DocumentsLink.EOF) Then
            m_DocumentsLink.Move NumeroRecord
        End If
        
        Me.Enabled = True
    End If
    Screen.MousePointer = 0
End If

End Sub

Private Sub GrigliaScarti_Click()
Dim NumeroRecord As Long

If m_DocumentsLink1.TableNew = True Then
    Screen.MousePointer = 11
    If Not (m_DocumentsLink1.BOF And m_DocumentsLink1.EOF) Then
        NumeroRecord = Me.GrigliaScarti.ListIndex - 1
        AggiornamentoDocumento = 1
        
        Me.Enabled = False
        
        m_DocumentsLink1.Refresh
        
        AggiornamentoDocumento = 0
        
        If Not (m_DocumentsLink1.BOF And m_DocumentsLink1.EOF) Then
            m_DocumentsLink1.Move NumeroRecord
        End If
        
        Me.Enabled = True
    End If
    Screen.MousePointer = 0
End If

End Sub

Private Sub imgSplitter_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    With imgSplitter
        picSplitter.Move .Left, .Top, .Width, ActivityBox.Height
        picSplitter.AutoRedraw = True
    End With
    picSplitter.Visible = True
    m_SplitterMoving = True
    picSplitter.ZOrder
End Sub

Private Sub imgSplitter_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim sglPos As Single

    If m_SplitterMoving Then
        sglPos = X + imgSplitter.Left
        If sglPos < SPLITLIMIT Then
            picSplitter.Left = SPLITLIMIT
        ElseIf sglPos > BarMenu.ClientAreaWidth - SPLITLIMIT Then
            picSplitter.Left = BarMenu.ClientAreaWidth - SPLITLIMIT
        Else
            picSplitter.Left = sglPos
        End If
    End If
End Sub

Private Sub imgSplitter_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    ActivityBox.Width = picSplitter.Left - ActivityBox.Left
    FormRecalcLayout
    picSplitter.Visible = False
    m_SplitterMoving = False
End Sub

Private Sub LabelLink1_AfterRunServerApplication(ByVal lIDResultKey As Long)
    Me.txtQtaQuadrata.Value = GET_RIEPILOGO_QUANTITA_LAVORAZIONE(fnNotNullN(m_Document(m_Document.PrimaryKey).Value))
    Me.txtQtaDifferenza.Value = Me.txtDisponibiltaLottoCaricato.Value - (Me.txtQtaQuadrata.Value + Me.txtQtaVenduta.Value)
    m_DocumentsLink1.Refresh
End Sub
Private Sub LabelLink1_BeforeRunServerApplication()
    'Me.LabelLink1.IDReturn = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
End Sub

Private Sub LabelLink2_AfterRunServerApplication(ByVal lIDResultKey As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

LINK_PEDANA = lIDResultKey

If LINK_PEDANA > 0 Then
    sSQL = "SELECT Codice FROM RV_POPedana WHERE IDRV_POPedana=" & LINK_PEDANA
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If Not (rs.EOF) Then
        Me.txtCodicePedana.Text = fnNotNull(rs!Codice)
    Else
        Me.txtCodicePedana.Text = ""
    End If
    rs.CloseResultset
    Set rs = Nothing
End If

End Sub
Private Sub LabelLink2_BeforeRunServerApplication()
    Me.LabelLink2.IDReturn = Me.txtIDPedana.Value
End Sub
Private Sub lblArticolo_Click()
On Error GoTo ERR_lblArticolo_Click
    Dim oSearch As dmtFind.Find
    Dim sSQL As String
    Dim oRes As DmtOleDbLib.adoResultset
If Me.CDArticolo.Code = "" Then
    'Crea un'istanza dell'oggetto Find
    Set oSearch = New dmtFind.Find
    
    'Assegna la connessione aperta
    oSearch.Database = Cn
    
    'La Caption della finestra di ricerca
    oSearch.Caption = "Articoli"
    
    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Comune" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    
    
    oSearch.AddDisplayField "Articolo", "Articolo", 1
    oSearch.AddDisplayField "Codice Articolo", "CodiceArticolo", 1

    
    
    'oSearch.AddDisplayField "Listino", "Listino", 0
    'oSearch.AddDisplayField "Sconto", "ScontoPercentuale", 0
    
    
    'Imposta un valore di default per il filtro sul campo Comune
    
    oSearch.Filters.Add "Articolo", Me.TxtArticolo.Text
    
    'Con la query SQL montata sotto l'impostazione di questa proprietà
    'non è necessaria
    'oSearch.IDName = "Comune.IDComune"
 
    'Quando si apre la finestra viene effettuta una ricerca preliminare con il filtro
    'SELECT ... FROM ... WHERE Comune LIKE XXX%  (essendo TextBox(0).Text = "XXX")
    oSearch.Start = Me.TxtArticolo.Text

    'Query SQL con cui effettuare le ricerche in base dati.
    'Attenzione:
    'Il campo chiave primaria (Comune.IDComune in questo caso) deve essere presente
    'nella SELECT
    sSQL = "SELECT IDArticolo, Articolo, CodiceArticolo, IDUnitaDiMisuraAcquisto,RV_POIDTipoLavorazione "
    sSQL = sSQL & "FROM Articolo "
    sSQL = sSQL & "WHERE ((IDTipoProdotto <> " & Link_TipoImballo & ") "
    sSQL = sSQL & "AND (IDTipoProdotto <> " & Link_TipoAumentoPeso & ") "
    sSQL = sSQL & "AND (IDTipoProdotto <> " & Link_TipoScarto & ") "
    sSQL = sSQL & "AND (IDTipoProdotto <> " & Link_TipoCaloPeso & ") "
    sSQL = sSQL & "AND (IDAzienda=" & m_App.IDFirm & "))"
    
    'Assegnazione della query di ricerca
    oSearch.SQL = fnAnsi2Jet(sSQL)
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
    
    Set oRes = oSearch.Exec
    
    
    If Not oRes.EOF Then
        Me.CDArticolo.Load oRes!IDArticolo
        Me.CDArticolo.Code = oRes!CodiceArticolo
        If Me.CDArticolo.KeyFieldID > 0 Then
            Me.TxtArticolo.Text = oRes!Articolo
            Link_UnitaDiMisura_Coop = fnGetUMCoop(fnNotNullN(oRes!IDUnitaDiMisuraAcquisto))
            Me.CboTipoLavorazione.WriteOn fnNotNullN(oRes!RV_POIDTipoLavorazione)
        End If
    End If
            
End If
    
    Set oRes = Nothing
    Set oSearch = Nothing
Exit Sub
ERR_lblArticolo_Click:
    MsgBox Err.Description, vbCritical, "lblArticolo_Click"
End Sub

Private Sub lblGestioneEtichette_Click()
On Error GoTo ERR_CmdStampaEtichette_Click
    If (m_DocumentsLink.BOF Or m_DocumentsLink.EOF) Then
        MsgBox "Selezionare una lavorazione", vbInformation, "Stampa etichette"
        Exit Sub
    End If
    LINK_ASSEGNAZIONE = fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    RecuperaDati
    
    FrmStampaEtichette.Show vbModal
Exit Sub
ERR_CmdStampaEtichette_Click:
    MsgBox Err.Description, vbCritical, "Stampa etichette"
End Sub

Private Sub lblArticolo_Q_Click()
Dim oSearch As dmtFind.Find
 Dim sSQL As String
 Dim oRes As DmtOleDbLib.adoResultset
If (Me.CDArticolo_Q.Code = "") And (Len(Me.TxtArticolo_Q) > 0) Then
    'Crea un'istanza dell'oggetto Find
    Set oSearch = New dmtFind.Find
    
    'Assegna la connessione aperta
    oSearch.Database = Cn
    
    'La Caption della finestra di ricerca
    oSearch.Caption = "Articoli"
    
    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Comune" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    oSearch.AddDisplayField "Articolo", "Articolo", 1
    oSearch.AddDisplayField "Codice Articolo", "CodiceArticolo", 1

    
    
    'oSearch.AddDisplayField "Listino", "Listino", 0
    'oSearch.AddDisplayField "Sconto", "ScontoPercentuale", 0
    
    
    'Imposta un valore di default per il filtro sul campo Comune
    
    oSearch.Filters.Add "Articolo", Me.TxtArticolo_Q.Text
    
    'Con la query SQL montata sotto l'impostazione di questa proprietà
    'non è necessaria
    'oSearch.IDName = "Comune.IDComune"
 
    'Quando si apre la finestra viene effettuta una ricerca preliminare con il filtro
    'SELECT ... FROM ... WHERE Comune LIKE XXX%  (essendo TextBox(0).Text = "XXX")
    oSearch.Start = Me.TxtArticolo_Q.Text

    'Query SQL con cui effettuare le ricerche in base dati.
    'Attenzione:
    'Il campo chiave primaria (Comune.IDComune in questo caso) deve essere presente
    'nella SELECT
        sSQL = "SELECT IDArticolo, Articolo, CodiceArticolo, IDUnitaDiMisuraAcquisto,RV_POIDTipoLavorazione "
        sSQL = sSQL & "FROM Articolo "
        sSQL = sSQL & "WHERE (IDAzienda=" & m_App.IDFirm & ")"
        sSQL = sSQL & " AND ((IDTipoProdotto = " & Link_TipoAumentoPeso & ") "
        sSQL = sSQL & " OR (IDTipoProdotto = " & Link_TipoCaloPeso & ") "
        sSQL = sSQL & " OR (IDTipoProdotto = " & Link_TipoScarto & ")) "
    
    
    
    'Assegnazione della query di ricerca
    oSearch.SQL = fnAnsi2Jet(sSQL)
    
    
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
   
    
    Set oRes = oSearch.Exec
    
    
    If Not oRes.EOF Then
        Me.CDArticolo_Q.Load oRes!IDArticolo
        Me.CDArticolo_Q.Code = oRes!CodiceArticolo
        If Me.CDArticolo_Q.KeyFieldID > 0 Then
            Me.TxtArticolo_Q.Text = oRes!Articolo
            Link_UnitaDiMisura_Coop = fnGetUMCoop(fnNotNullN(oRes!IDUnitaDiMisuraAcquisto))
        End If
    End If
            
End If
    
    Set oRes = Nothing
    Set oSearch = Nothing
End Sub



Private Sub lblImballo_Click()
On Error GoTo ERR_lblImballo_Click
Dim oSearch As dmtFind.Find
Dim sSQL As String
Dim oRes As DmtOleDbLib.adoResultset
If Me.CDCodiceImballo.Code = "" Then
    'Crea un'istanza dell'oggetto Find
    Set oSearch = New dmtFind.Find
    
    'Assegna la connessione aperta
    oSearch.Database = Cn
    
    'La Caption della finestra di ricerca
    oSearch.Caption = "Imballi"
    
    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Comune" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    
    oSearch.AddDisplayField "Articolo", "Articolo", 1
    oSearch.AddDisplayField "Codice Articolo", "CodiceArticolo", 1
    
    'oSearch.AddDisplayField "Listino", "Listino", 0
    'oSearch.AddDisplayField "Sconto", "ScontoPercentuale", 0
    'Imposta un valore di default per il filtro sul campo Comune
    
    oSearch.Filters.Add "Articolo", Me.txtImballo.Text
    
    'Con la query SQL montata sotto l'impostazione di questa proprietà
    'non è necessaria
    'oSearch.IDName = "Comune.IDComune"
 
    'Quando si apre la finestra viene effettuta una ricerca preliminare con il filtro
    'SELECT ... FROM ... WHERE Comune LIKE XXX%  (essendo TextBox(0).Text = "XXX")
    oSearch.Start = Me.txtImballo.Text

    'Query SQL con cui effettuare le ricerche in base dati.
    'Attenzione:
    'Il campo chiave primaria (Comune.IDComune in questo caso) deve essere presente
    'nella SELECT
    sSQL = "SELECT IDArticolo, Articolo, CodiceArticolo "
    sSQL = sSQL & "FROM Articolo "
    sSQL = sSQL & "WHERE ((IDTipoProdotto = " & Link_TipoImballo & ") "
    sSQL = sSQL & "AND (IDAzienda=" & m_App.IDFirm & "))"
        
    
    
    
    'Assegnazione della query di ricerca
    oSearch.SQL = fnAnsi2Jet(sSQL)
    
    
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
   
    
    Set oRes = oSearch.Exec
    
    
    If Not oRes.EOF Then
            Me.CDCodiceImballo.Load oRes!IDArticolo
            Me.CDCodiceImballo.Code = oRes!CodiceArticolo
            If Me.CDCodiceImballo.KeyFieldID > 0 Then
                Me.txtImballo.Text = oRes!Articolo
                Me.txtTaraUnitaria.Value = fnGetTaraImballo
                Me.txtColli.SetFocus
            End If
    End If
            
End If
    
    Set oRes = Nothing
    Set oSearch = Nothing
Exit Sub
ERR_lblImballo_Click:
    MsgBox Err.Description, vbCritical, "lblImballo_Click"

End Sub



Private Sub lblImballo_Q_Click()
Dim oSearch As dmtFind.Find
Dim sSQL As String
Dim oRes As DmtOleDbLib.adoResultset

If (Me.CDCodiceImballo_Q.Code = "") And (Len(Me.txtImballo_Q.Text) > 0) Then
    'Crea un'istanza dell'oggetto Find
    Set oSearch = New dmtFind.Find
    
    'Assegna la connessione aperta
    oSearch.Database = Cn
    
    'La Caption della finestra di ricerca
    oSearch.Caption = "Imballi"
    
    'Vengono assegnati i campi su cui effettuare la ricerca.
    'Questi campi verranno visualizzati nella tabella della finestra di ricerca
    'ed in quella per l'impostazione del filtro.
    'NOTA:
    'Il primo campo inserito (ovvero "Comune" in questo caso) verrà associato alla combo
    'presente nella finestra di ricerca.
    
    oSearch.AddDisplayField "Articolo", "Articolo", 1
    oSearch.AddDisplayField "Codice Articolo", "CodiceArticolo", 1

    
    
    'oSearch.AddDisplayField "Listino", "Listino", 0
    'oSearch.AddDisplayField "Sconto", "ScontoPercentuale", 0
    
    
    'Imposta un valore di default per il filtro sul campo Comune
    
    oSearch.Filters.Add "Articolo", Me.txtImballo_Q.Text
    
    'Con la query SQL montata sotto l'impostazione di questa proprietà
    'non è necessaria
    'oSearch.IDName = "Comune.IDComune"
 
    'Quando si apre la finestra viene effettuta una ricerca preliminare con il filtro
    'SELECT ... FROM ... WHERE Comune LIKE XXX%  (essendo TextBox(0).Text = "XXX")
    oSearch.Start = Me.txtImballo_Q.Text

    'Query SQL con cui effettuare le ricerche in base dati.
    'Attenzione:
    'Il campo chiave primaria (Comune.IDComune in questo caso) deve essere presente
    'nella SELECT
        sSQL = "SELECT IDArticolo, Articolo, CodiceArticolo "
        sSQL = sSQL & "FROM Articolo "
        sSQL = sSQL & "WHERE ((IDTipoProdotto = " & Link_TipoImballo & ") "
        'sSQL = sSQL & "AND (GestioneLotti=" & fnNormBoolean(1) & ") "
        sSQL = sSQL & "AND (IDAzienda=" & m_App.IDFirm & "))"
        
    
    
    
    'Assegnazione della query di ricerca
    oSearch.SQL = fnAnsi2Jet(sSQL)
    
    
    'Esegue la ricerca e restituisce l'eventuale riga selezionata dall'utente
   
    
    Set oRes = oSearch.Exec
    
    
    If Not oRes.EOF Then
            Me.CDCodiceImballo_Q.Load fnNotNullN(oRes!IDArticolo)
            Me.CDCodiceImballo_Q.Code = fnNotNull(oRes!CodiceArticolo)
            If Me.CDCodiceImballo_Q.KeyFieldID > 0 Then
                Me.txtImballo_Q.Text = fnNotNull(oRes!Articolo)
                Me.txtTaraUnitaria_Q.Value = fnGetTaraImballo_Q
                Me.txtColli_Q.SetFocus
            End If
    End If
            
End If
    
Set oRes = Nothing
Set oSearch = Nothing
End Sub

Private Sub lblLinkOrdine_AfterRunServerApplication(ByVal lIDResultKey As Long)
    If lIDResultKey > 0 Then
        Me.txtIDOrdineCliente.Value = lIDResultKey
    End If
End Sub

Private Sub lblLinkOrdine_BeforeRunServerApplication()
    If NUOVO_ORDINE_LISTA_PRELIEVO = True Then
        SaveSetting Trim(gResource.GetMessage(LBL_REGISTRY_KEY)), "RV_POOrdineL", "IDOggettoOrdinePadre", LINK_ORDINE_PADRE_SEL
        SaveSetting Trim(gResource.GetMessage(LBL_REGISTRY_KEY)), "RV_POOrdineL", "NoReturnValue", 1
    Else
        SaveSetting Trim(gResource.GetMessage(LBL_REGISTRY_KEY)), "RV_POOrdineL", "NoReturnValue", 0
        SaveSetting Trim(gResource.GetMessage(LBL_REGISTRY_KEY)), "RV_POOrdineL", "IDOggettoOrdinePadre", 0
    End If
End Sub

Private Sub m_App_OnRun(ByVal Proc As Process)
    Dim Parameter As DMTRunAppLib.Parameter

    On Error GoTo ErrorHandler
    
    Set m_Process = Proc
    Set m_DocType = m_Process.IDocType
    
    
    '.................................................................................................................................
    '.................................................................................................................................
    'Gestione preliminare della Semaforo per il controllo dei conflitti di multiutenza
    
    
    'Inizializza la Semaforo
    InitSemaphore
    
    ' Verifica se l'applicazione corrente è bloccata da altri gestori.
    ' (Il controllo avviene sul Tipo Oggetto correntemente trattato.)
    If Not m_Semaphore.IsActionAvailable(m_DocType.ID, SemAllObjects, SemAllActions) Then
        '-------------------------------------------------------------
        'Il programma è bloccato da un'altra manutenzione in esecuzione.
        '-------------------------------------------------------------
        
        'Scarica il form
        Unload Me
       
        'Prima di terminare il programma è bene distruggere tutti gli oggetti allocati
        DestroyObjects
       
        'Termina il programma
        End
    End If
    
    '----------------------------------------------------
    'Il programma non è bloccato e prosegue normalmente.
    '----------------------------------------------------
    
    'Ripulisce la tabella semaforo.
    'Se era avvenuto un crash di sistema questo garantisce il ripristino della situazione.
    SemaphoreUnlock
    
    'Imposta gli eventuali blocchi (semaforo) su altre manutenzioni.
    SemaphoreLock
    '.................................................................................................................................
    '.................................................................................................................................
    
    
    
    Select Case Proc.Name
        '*
        'Inserire il codice per la gestione del processo
        '*
        Case "Manutenzione"
        '   For Each Parameter In Proc.Parameters
        '       Select Case Parameter.Name
        '       *
        '       Inserire il codice per la gestione del parametro
        '       *
        '       Case ParameterName??????
        '       End Select
        '   next
           Start 'di solito
    
    Case Else
    
        'cbcx
        'QUESTA PARTE DEVE ESSERE RIVISTA
        '-----------------------------------------------------------------
        
'''''        Dim ErrorMsg As String
'''''
'''''        ErrorMsg = "No processes to execute" & vbCrLf
'''''        ErrorMsg = ErrorMsg & "This application is able to execute these processes:" & vbCrLf
'''''        '*
'''''        'Inserire i processi che l'applicazione sa eseguire
'''''        '*
'''''        'ErrorMsg = ErrorMsg & PROCESS_MANUTENZIONE & vbCrLf
'''''        'ErrorMsg = ErrorMsg & PROCESS_MANUTENZIONE_EXTENDED_DATABASE & vbCrLf
'''''        'ErrorMsg = ErrorMsg & PROCESS_MANUTENZIONE_DA_SHELL & vbCrLf
'''''        Err.Raise ERR_NO_PROCESSES, , ErrorMsg


    End Select
    Exit Sub
ErrorHandler:
    SemaphoreUnlock
    ShowErrorLog
End Sub

Private Sub m_Document_OnReposition()
        
    'Viene creata (se non è già stato fatto) la collezione FormFields
    CreateFormFields
        
    If Not m_Document.TableNew Then
        'Se EOF = true o BOF = true vuol dire che si è andati oltre l'ultimo o
        'prima del primo record. In tal caso non si deve fare il refresh dei
        'controlli del form.
        If Not (m_Document.EOF Or m_Document.BOF) Then
            BrowseReposition
            
            'cbcx
            '---------------------------------------------
            'Gestione processo On_Extend
'            If Not m_ExtendApplication Is Nothing Then
'                'Notifica l'identificativo unico del documento corrente
'                m_ExtendApplication.PrimaryID = m_Document.Fields("ID" & m_App.TableName).Value
'            End If
            
        End If
    Else
        'Nel caso di inserimento nuovo record ripulisce i campi del form
        'ClearFormFields
    End If
    
    
    
    'rif11 begin
    
   'If Me.GrigliaFasiIntervento.ColumnsHeader.Count > 0 Then
       On Error Resume Next
        'Binding mediante le proprietà DataMember e DataSource.
        'Me.GrigliaFasiIntervento.DataMember = m_DocumentsLink2.TableName
        'Set Me.GrigliaFasiIntervento.DataSource = m_Document

        'Binding mediante la proprietà Recordset
        Set Me.GrigliaCorpo.Recordset = m_Document.DocumentsLinks.Item(m_DocumentsLink.TableName).data
        Set Me.GrigliaScarti.Recordset = m_Document.DocumentsLinks.Item(m_DocumentsLink1.TableName).data
    'End If
'Variabile contatore che serve per il consolidamento delle righe eliminate
RefreshArray
ContDelete = 0


ParametriDiDefault Date
'INIZIALIZZAZIONE DEL DOCUMENTO
    If m_Document("IDRV_POCaricoMerceRighe").Value > 0 Then
        
        LINK_CONFERIMENTO_RIGA = m_Document(m_Document.PrimaryKey).Value
        Me.cboTipoDocumentoCoop.WriteOn fnNotNullN(m_Document("IDTipoDocumentoCoop").Value)
        Me.txtDataDocumento.Text = m_Document("DataDocumento").Value
        Me.txtSocio = m_Document("Anagrafica").Value
        Me.TxtIDAnagrafica.Text = m_Document("IDAnagrafica").Value
        Me.txtNomeSocio.Text = m_Document("Nome").Value
        Me.cboMagazzinoConf.WriteOn Link_Magazzino_Conferimento
        Me.CboMagazzinoVend.WriteOn Link_Magazzino_Vendita
        Me.cboSezionale.WriteOn Link_Sezionale
        Me.txtNumeroDocumento.Value = m_Document("NumeroDocumento").Value
        Me.txtArticolo_Conf.Text = m_Document("Articolo").Value
        Me.txtCodiceArticolo_Conf.Text = m_Document("CodiceArticolo").Value
        Me.chkChiusoConferimento.Value = IIf(IsNull(m_Document("Chiuso").Value), 0, fnNormBoolean(m_Document("Chiuso").Value))
        Me.fraRighe.Enabled = True
        Me.FraQuadratura.Visible = False
        Me.txtCodiceImballo_Conferimento.Text = fnNotNull(m_Document("CodiceImballo").Value)
        Me.txtArticoloImballo_Conferimento.Text = fnNotNull(m_Document("DescrizioneImballo").Value)
        Me.txtUnitaDiMisura_Conferimento.Text = GET_UNITA_DI_MISURA(fnNotNullN(m_Document("IDUnitaDiMisuraDiamante").Value))
        Me.txtNumeroColliCaricati.Value = fnNotNullN(m_Document("Colli").Value)
        Link_UnitaDiMisura_Coop_Conferimento = fnNotNullN(m_Document("IDUnitaDiMisura").Value)
        Me.txtLottoEntrata.Text = fnNotNull(m_Document("CodiceLotto").Value)
        Me.txtDisponibiltaLottoCaricato.Value = fnNotNullN(m_Document("Qta_UM").Value)
        Me.txtCodiceLotto_Conf.Text = fnNotNull(m_Document("LottoDiConferimento").Value)
        GET_CERTIFICAZIONE_LOTTO_CAMPAGNA_PER_ETICHETTE fnNotNullN(m_Document("IDLottoDiCampagna").Value) 'testa
        GET_CERTIFICAZIONE_SOCIO_PER_ETICHETTE fnNotNullN(m_Document("IDAnagrafica").Value) 'Testa
        GET_DATI_LOTTO_CAMPAGNA_PER_ETICHETTE fnNotNullN(m_Document("IDLottoDiCampagna").Value)  'testa
        
'        Me.txtRegioneProvenienza.Text = fnNotNull(m_Document("Regione_Merce").Value)
'        Me.txtNazioneProvenienza.Text = fnNotNull(m_Document("Nazione_Merce").Value)
'        Me.txtComuneProvenienza.Text = fnNotNull(m_Document("Comune_Merce").Value)
'        Me.txtProvinciaProvenienza.Text = fnNotNull(m_Document("Provincia_Merce").Value)
        
        REGIONE_PROVENIENZA = fnNotNull(m_Document("Regione_Merce").Value)
        NAZIONE_PROVENIENZA = fnNotNull(m_Document("Nazione_Merce").Value)
        COMUNE_PROVENIENZA = fnNotNull(m_Document("Comune_Merce").Value)
        PROVINCIA_PROVENIENZA = fnNotNull(m_Document("Provincia_Merce").Value)
        
        Me.txtCodiceSocio.Text = fnNotNull(m_Document("CodiceSocio").Value)
        'Me.txtDataDiSblocco.Text = fnNotNull(m_Document("DataSbloccoLottoCampagna").Value)
        DATA_SBLOCCO_LOTTO_CAMPAGNA = fnNotNull(m_Document("DataSbloccoLottoCampagna").Value)
        Me.cboTipoLavConf.WriteOn fnNotNullN(m_Document("IDRV_POTipoLavorazione").Value)
        Me.chkPrezzoMedioConf.Value = fnNotNullN(m_Document("PrezzoMedio").Value)
        
        VARIETA_ARTICOLO_CONFERITO = GET_VARIETA_ARTICOLO(fnNotNullN(m_Document("IDArticolo").Value))
        FAMIGLIA_ARTICOLO_CONFERITO = GET_FAMIGLIA_ARTICOLO(fnNotNullN(m_Document("IDArticolo").Value))
        GET_CERTIFICAZIONE_FAM_PER_ETI_CONF fnNotNullN(m_Document("IDAnagrafica").Value), fnNotNullN(m_Document("IDArticolo").Value)
        Me.txtRaggrOrd.Locked = False
        If (ATTIVA_SEL_LOTTO_PROD_IN_LAV = 1) Then
            Me.txtRaggrOrd.Locked = True
        End If
        If Link_Tipo_Passaporto_Azienda = 2 Then
            If Link_Sezionale_Dettagliato > 0 Then
                Me.txtLottoVendita.Width = 4575
                Me.txtNumeroProtocollo.Visible = True
                Me.lblProtocollo.Visible = True
            End If
        End If
        Me.chkPreConferimento.Value = Abs(fnNotNullN(m_Document("PreConferimento").Value))
        Me.chkLottoUtilizzoEsclusivo.Value = Abs(fnNotNullN(m_Document("LottoImballoUtilizzoEsclusivo").Value))
'        If fnNotNullN(m_Document("IDLottoDiCampagna").Value) > 0 Then
'            Me.txtFamigliaLottoCampagna.Text = FAMIGLIA_LOTTO_CAMPAGNA
'            Me.txtVarietaLottoCampagna.Text = VARIETA_LOTTO_CAMPAGNA
'            Me.txtTipoProduzione.Text = TIPO_PRODUZIONE_LOTTO_CAMPAGNA
'        Else
'            Me.txtFamigliaLottoCampagna.Text = ""
'            Me.txtVarietaLottoCampagna.Text = ""
'            Me.txtTipoProduzione.Text = ""
'        End If
            
        'Me.txtCodiceAssociatoPredefinito.Text = fnNotNull(GET_CODICEFORNITORE(TheApp.Branch))
        'Me.txtBNDOO.Text = fnNotNull(GET_BNDOO(TheApp.Branch))
        CODICE_ASSOCIATO_PRED = fnNotNull(GET_CODICEFORNITORE(TheApp.Branch))
        BNDOO = fnNotNull(GET_BNDOO(TheApp.Branch))
        
        GET_INFO_SOCIO TheApp.IDFirm, Me.TxtIDAnagrafica.Text
    
        GET_RIEPILOGO_CONFERIMENTO
        
        If NUOVA_RIGA_INIZIO = 1 Then cmdNuovo_Click
        
    End If
    
    
    InitControlliPerEtichette
    
    Me.cboReportNew.WriteOn GET_DEFAULT_REPORT_NEW(1)
    Me.cboReportPedNew.WriteOn GET_DEFAULT_REPORT_NEW(2)

    cboReportNew_Click
    cboReportPedNew_Click

    
    If m_Document(m_Document.PrimaryKey).Value > 0 Then
       LINK_ORDINAMENTO = GET_LINK_ORDINAMENTO(m_DocumentsLink.TableName)
    Else
       LINK_ORDINAMENTO = 1
    End If
    Me.chkNuovoMetodo.Value = ParametroNuovoMetodoEtichette
    
    chkNuovoMetodo_Click
    
    Me.SSTab1.Tab = 0
    
    If LINK_LAVORAZIONE_DA_MOV > 0 Then
        If TIPO_LAVORAZIONE_DA_MOV = 1 Then
            If Not (m_DocumentsLink.BOF And m_DocumentsLink.EOF) Then
                m_DocumentsLink.MoveFirst
                While Not m_DocumentsLink.EOF
                    If LINK_LAVORAZIONE_DA_MOV = fnNotNullN(m_DocumentsLink("IDRV_POAssegnazioneMerce").Value) Then
                        Exit Sub
                    End If
                m_DocumentsLink.MoveNext
                Wend
            End If
        End If
        If TIPO_LAVORAZIONE_DA_MOV = 2 Then
            If Not (m_DocumentsLink1.BOF And m_DocumentsLink1.EOF) Then
                m_DocumentsLink1.MoveFirst
                While Not m_DocumentsLink1.EOF
                    If LINK_LAVORAZIONE_DA_MOV = fnNotNullN(m_DocumentsLink1("IDRV_POLavorazione").Value) Then
                        Exit Sub
                    End If
                m_DocumentsLink1.MoveNext
                Wend
            End If
        End If
    End If
    
    m_Changed = False
    
    
End Sub


'**+
'Autore: Diamante s.p.a
'Data creazione: 07/09/00
'Autore ultima modifica:
'Data ultima modifica:
'
'Nome: AutoLostFocus
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità: Forza un LostFocus del controllo attivo ed attende la gestione di eventuali eventi associati.
'                  Alla fine ripristina il fuoco sul controllo iniziale.
'                  Usata quando si clicca sulla toolbar e quando si utilizza l'acceleratore per il salvataggio SHIFT + F12
'                  (in tal caso infatti non viene scatenato l'evento BarMenu_Click)
'
'**/
Private Sub AutoLostFocus()
    Dim Ctr As Control

    
    'Se si è in modalità FilterDefinition non si deve spostare il fuoco
    'altrimenti Taglia, Copia e Incolla (dalla toolbar) non possono funzionare
    If BrwMain.GuiMode <> dgFilterDefinition And Not Me.ActiveControl Is Nothing Then
    
        'Memorizza il controllo che ha il fuoco
        Set Ctr = Me.ActiveControl
    
        'Forza il lost focus del controllo attivo
        Globali.SetFocus PicForm.hwnd
        
        'Vengono gestiti gli eventi LostFocus (se previsti)
        DoEvents
        
        'Ripristina il fuoco sul controllo.
        Ctr.SetFocus
        
    End If

End Sub


'**+
'Autore: Diamante s.p.a
'Data creazione: 11/09/00
'Autore ultima modifica:
'Data ultima modifica:
'
'Nome: InitSemaphore
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità: Inizializzazione del semaforo per la gestione
'                  dei conflitti in caso di multiutenza

'
'**/
Private Sub InitSemaphore()

    Set m_Semaphore = New Semaforo.dmtSemaphore
    Set m_Semaphore.Database = m_App.Database.Connection
    Set m_Semaphore.objRes = gResource
    
    m_Semaphore.IDUser = m_App.IDUser
    m_Semaphore.IDBranch = m_App.Branch
    m_Semaphore.IDFunction = m_App.FunctionID
    
End Sub


'**+
'Autore: Diamante s.p.a
'Data creazione: 12/09/00
'Autore ultima modifica:
'Data ultima modifica:
'
'Nome: SemaphoreLock
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'                 ////////////////////////////////////////////////////////////////////////
'                     Impostare qui gli eventuali blocchi sulle altre manutenzioni
'                 ////////////////////////////////////////////////////////////////////////
'**/
Private Sub SemaphoreLock()
    If Not m_Semaphore Is Nothing Then
        
        '/////////////////////////////////////////////////////////////////////////////////////////////////
        'Personalizzare, se necessario, le righe sottostanti
        '/////////////////////////////////////////////////////////////////////////////////////////////////
        
'        m_Semaphore.SetObjectAction TO_TIPO_OGGETTO_XXX, SemAllObjects, SemAllActions
'        m_Semaphore.SetObjectAction TO_TIPO_OGGETTO_YYY, SemAllObjects, SemAllActions
'        m_Semaphore.SetObjectAction TO_TIPO_OGGETTO_ZZZ, SemAllObjects, SemAllActions

    End If
End Sub

'**+
'Autore: Diamante s.p.a
'Data creazione: 12/09/00
'Autore ultima modifica:
'Data ultima modifica:
'
'Nome: SemaphoreUnlock
'
'Parametri:
'
'Valori di ritorno:

'Funzionalità:
'                 //////////////////////////////////////////////////////////////////////////////////////////////////
'                     Sbloccare qui le altre manutenzioni (bloccate precedentemente in SemaphoreLock)
'                 //////////////////////////////////////////////////////////////////////////////////////////////////
'
'**/
Private Sub SemaphoreUnlock()
    If Not m_Semaphore Is Nothing Then
    
        'Ripulisce la tabella semaforo per quanto riguarda il Tipo Oggetto e l'utente correnti
        m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
        
        
        
        '/////////////////////////////////////////////////////////////////////////////////////////////////
        'Personalizzare, se necessario, le righe sottostanti
        '/////////////////////////////////////////////////////////////////////////////////////////////////
        
        'Sblocca le manutenzioni bloccate precedentemente
'        m_Semaphore.ClearObjectAction TO_TIPO_OGGETTO_XXX, SemAllObjects, SemAllActions
'        m_Semaphore.ClearObjectAction TO_TIPO_OGGETTO_YYY, SemAllObjects, SemAllActions
'        m_Semaphore.ClearObjectAction TO_TIPO_OGGETTO_ZZZ, SemAllObjects, SemAllActions
    
    End If
End Sub




'**+
'Autore: Diamante s.p.a
'Data creazione: 11/09/00
'Autore ultima modifica:
'Data ultima modifica:
'
'Nome: DestroyObjects
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'                  ////////////////////////////////////////////////////////////////////////////////////////////////////
'                  /         Inserire qui il codice per distruggere (prima che venga terminato il programma)     /
'                  /         tutti gli oggetti allocati                                                                              /
'                  ////////////////////////////////////////////////////////////////////////////////////////////////////
'
'**/
Private Sub DestroyObjects()
    
    'Sblocca gli eventuali gestori bloccati da questa manutenzione
    SemaphoreUnlock

    Set m_FormFields = Nothing
    Set m_Report = Nothing
    Set m_ActiveFilter = Nothing
    Set m_Document = Nothing
    Set m_Process = Nothing
    Set m_App = Nothing
    Set m_Semaphore = Nothing
    
    'cbcx
    'Set m_ExtendApplication = Nothing
End Sub



'rif8 begin

'**+
'Autore: Diamante s.p.a
'Data creazione: 03/11/00
'Autore ultima modifica:
'Data ultima modifica:
'
'Nome: m_DocumentsLink_OnReposition
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità: Operazioni da effettuare al Reposition del sottodocumento.
'
'**/
Private Sub m_DocumentsLink_OnReposition()
 Dim bValue As Boolean
 Dim iIndex As Integer
 Dim Testo As String
 Dim NumeroRecord As Long
 On Error Resume Next

Screen.MousePointer = 11
DoEvents

B_LOADING_RIGA = True
If AggiornamentoDocumento = 0 Then
    If Not (m_DocumentsLink.BOF And m_DocumentsLink.EOF) Then
        'Il DocumentsLink non è vuoto - contiene dei dati.
        
        IDRigaProcessoProd = fnNotNullN(m_DocumentsLink("IDRV_POProcessoLavorazioneRighe").Value)
        IDProcessoProd = fnNotNullN(m_DocumentsLink("IDRV_POProcessoLavorazione").Value)
        IDLineaProduzione = fnNotNullN(m_DocumentsLink("IDRV_POLineaProduzione").Value)
        
        IDIMBALLOPRIM_SEL = fnNotNullN(m_DocumentsLink("IDArticoloImballoPrimario").Value)
        IDIMBALLO_SEL = fnNotNullN(m_DocumentsLink("IDImballoVendita").Value)
        
        Me.txtIDPedana.Value = fnNotNullN(m_DocumentsLink("IDRV_POPedana").Value)
        Me.txtCodicePedana.Text = fnNotNull(m_DocumentsLink("CodicePedana").Value)
        Me.CDTipoPedana.Load GET_TIPO_PEDANA(Me.txtIDPedana.Text)
        Me.txtPesoPedana.Value = GET_PESO_PEDANA(Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID)
        
        Link_TipoProdotto = GET_TIPO_PRODOTTO_ARTICOLO(fnNotNullN(m_DocumentsLink("IDArticolo").Value))
        Me.CDArticolo.Load fnNotNullN(m_DocumentsLink("IDArticolo").Value)
        Me.CDArticolo.Code = fnNotNull(m_DocumentsLink("CodiceArticolo").Value)
        Me.TxtArticolo.Text = fnNotNull(m_DocumentsLink("Articolo").Value)
        Me.cboUM.WriteOn IIf(IsNull(m_DocumentsLink("IDUnitaDiMisura").Value), 0, m_DocumentsLink("IDUnitaDiMisura").Value)
        Link_UnitaDiMisura_Coop = fnNotNullN(m_DocumentsLink("IDUnitaDiMisuraCoop").Value)
        Me.CDCodiceImballo.Load fnNotNullN(m_DocumentsLink("IDImballoVendita").Value)
        Me.CDCodiceImballo.Code = fnNotNull(m_DocumentsLink("CodiceImballoVendita").Value)
        Me.txtImballo.Text = fnNotNull(m_DocumentsLink("ImballoVendita").Value)
        Me.txtTaraUnitaria.Value = fnNotNullN(m_DocumentsLink("TaraUnitaria").Value)
        Me.txtDataLavorazione.Value = fnNotNull(m_DocumentsLink("DataDocumento").Value)
                
        ''''QUI I VALORI DEI PESI
        Me.txtColli.Value = fnNotNullN(m_DocumentsLink("Colli").Value)
        Me.txtPesoLordo.Value = fnNotNullN(m_DocumentsLink("PesoLordo").Value)
        Me.txtPesoNetto.Value = fnNotNullN(m_DocumentsLink("PesoNetto").Value)

        Me.txtTara.Value = fnNotNullN(m_DocumentsLink("Tara").Value)
        Me.txtPezzi.Value = fnNotNullN(m_DocumentsLink("Pezzi").Value)
        Me.txtQta_UM.Value = fnNotNullN(m_DocumentsLink("Qta_UM").Value)

        Link_Movimento_Carico = fnNotNull(m_DocumentsLink("IDMovimento_carico").Value)
        Link_Movimento_Scarico = fnNotNull(m_DocumentsLink("IDMovimento_vendita").Value)
        Me.CboTipoLavorazione.WriteOn fnNotNullN(m_DocumentsLink("IDTipoLavorazione").Value)
        Me.cboTipoCategoria.WriteOn fnNotNullN(m_DocumentsLink("IDRV_POTipoCategoria").Value)
        Me.cboCalibro.WriteOn fnNotNullN(m_DocumentsLink("IDRV_POCalibro").Value)
        Me.cboLinguaPred.WriteOn fnNotNullN(m_DocumentsLink("IDLinguaPredefinita").Value)
        
        Me.cdCliente.Load fnNotNullN(m_DocumentsLink("IDCliente").Value)
        Me.txtIDOrdineCliente.Value = fnNotNullN(m_DocumentsLink("IDOggettoOrdine").Value)
        Me.txtNumeroOrdine.Value = fnNotNullN(m_DocumentsLink("NumeroOrdine").Value)
        Me.txtDataOrdine.Value = fnNotNullN(m_DocumentsLink("DataOrdine").Value)
        Me.txtNListaPrelievo.Value = fnNotNullN(m_DocumentsLink("NumeroListaPrelievo").Value)
        Me.txtIDOrdinePadre.Value = fnNotNullN(m_DocumentsLink("IDOggettoOrdinePadre").Value)
        
        Me.cboLinguaCliente.WriteOn fnNotNullN(m_DocumentsLink("IDLinguaCliente").Value)
        Me.txtCodicePedanaCliente.Value = fnNotNullN(m_DocumentsLink("NumeroPedanaCliente").Value)
        Me.txtCodificaCodicePedanaCliente.Text = fnNotNull(m_DocumentsLink("CodicePedanaCliente").Value)
        
        Me.txtLottoVendita.Text = fnNotNull(m_DocumentsLink("CodiceLottoVendita").Value)
        Me.txtLottoCliente.Text = fnNotNull(m_DocumentsLink("LottoCliente").Value)
        Me.txtAltreAnnotazioniCliente.Text = fnNotNull(m_DocumentsLink("AltreAnnotazioniPerCliente").Value)
        
        Me.cboUtente.WriteOn fnNotNullN(m_DocumentsLink("IDUtente").Value)
        Me.txtCodicePostazione.Text = fnNotNull(m_DocumentsLink("CodiceUtente").Value)
    
        Me.txtCodicePedanaCliente.Value = fnNotNullN(m_DocumentsLink("NumeroPedanaCliente").Value)
        Me.chkPrezzoInclusoImballo.Value = Abs(fnNotNullN(m_DocumentsLink("MerceInclusoImballo").Value))
        Me.txtNomeMacchina.Text = m_DocumentsLink("UtentePC").Value
        Me.txtUtenteMacchina.Text = m_DocumentsLink("NomePC").Value

        Me.txtCodiceGSICliente.Text = fnNotNull(m_DocumentsLink("CodiceGSI").Value)
        Me.txtCodiceAssociatoPressoCliente.Text = fnNotNull(m_DocumentsLink("CodiceAssociatoPressoCliente").Value)
        Me.txtCodificaArticoloCodiceABarre.Text = fnNotNull(m_DocumentsLink("CodiceABarreArticoloCliente").Value)
        
        Me.txtCodiceABarreArticoloCliente.Text = fnNotNull(m_DocumentsLink("DescrizioneCodiceABarreArticoloCliente").Value)
        Me.txtCodificaImballoCodiceABarre.Text = fnNotNull(m_DocumentsLink("CodiceABarreImballoCliente").Value)
        Me.txtCodiceABarreImballoCliente.Text = fnNotNull(m_DocumentsLink("DescrizioneCodiceABarreImballoCliente").Value)
        Me.txtArticoloInLinguaPred.Text = fnNotNull(m_DocumentsLink("DescrizioneArticoloInLinguaPred").Value)
        Me.txtCalibroInLiguaPred.Text = fnNotNull(m_DocumentsLink("DescrizioneCalibroInLinguaPred").Value)
        Me.txtCategoriaInLinguaPred.Text = fnNotNull(m_DocumentsLink("DescrizioneCategoriaInLinguaPred").Value)
        Me.txtDescrizioneArticoloInLinguaCliente.Text = fnNotNull(m_DocumentsLink("DescrizioneArticoloInLinguaCliente").Value)
        Me.txtCalibroInLingua.Text = fnNotNull(m_DocumentsLink("DescrizioneCalibroInLinguaCliente").Value)
        Me.txtCategoriaInLingua.Text = fnNotNull(m_DocumentsLink("DescrizioneCategoriaInLinguaCliente").Value)
        Me.txtOraLav.Text = fnNotNull(m_DocumentsLink("OraLavorazione").Value)
        SegnoMovimentoScarto = m_DocumentsLink("SegnoMovimento").Value
        Me.txtNumeroProtocollo.Value = fnNotNullN(m_DocumentsLink("RV_PO01_NumeroPassaportoRighe").Value)
        LINK_PROCESSO_RIGA = fnNotNullN(m_DocumentsLink("IDRV_POProcessoIVGammaRighe").Value)
        
        Me.txtImportoUnitarioArticolo.Value = fnNotNullN(m_DocumentsLink("ImportoUnitarioArticolo").Value)
        Me.txtSconto1.Value = fnNotNullN(m_DocumentsLink("Sconto1").Value)
        Me.txtSconto2.Value = fnNotNullN(m_DocumentsLink("Sconto2").Value)
        Me.txtImportoUnitarioImballo.Value = fnNotNullN(m_DocumentsLink("ImportoUnitarioImballo").Value)
        Me.txtImportoUnitarioListino.Value = fnNotNullN(m_DocumentsLink("RV_POImportoUnitarioListino").Value)
        Me.txtIDRigaOrdine.Value = fnNotNullN(m_DocumentsLink("IDValoriOggettoDettaglioRigaOrd").Value)
        Me.txtRaggrOrd.Text = fnNotNull(m_DocumentsLink("NotaRigaOrdRaggr").Value)
        
        Me.chkTracciaImballoGest.Value = fnNotNullN(m_DocumentsLink("TracciaImballo").Value)
        Me.chkConfermaDaUtente.Value = fnNotNullN(m_DocumentsLink("ConfermaDaUtente").Value)
        Me.chkTracciaImballoGestPrim.Value = fnNotNullN(m_DocumentsLink("TracciaImballoPrim").Value)
        Me.chkConfermaDaUtentePrim.Value = fnNotNullN(m_DocumentsLink("ConfermaDaUtentePrim").Value)

        Me.txtNoteAgg.Text = fnNotNull(m_DocumentsLink("AnnotazioniAggiuntiveLav").Value)
        
        Me.CDImballoPrimario.Load fnNotNullN(m_DocumentsLink("IDArticoloImballoPrimario").Value)
        Me.txtNumeroConfImballo.Value = fnNotNullN(m_DocumentsLink("NumeroConfezioniPerImballo").Value)
        Me.txtTaraConfImballo.Value = fnNotNullN(m_DocumentsLink("TaraConfezioneImballo").Value)
        Me.txtCostoConfezione.Value = fnNotNullN(m_DocumentsLink("CostoConfezioneImballo").Value)
        Me.chkTracciaImballoGestPrim.Value = fnNotNullN(m_DocumentsLink("TracciaImballoPrim").Value)
        Me.chkConfermaDaUtentePrim.Value = fnNotNullN(m_DocumentsLink("ConfermaDaUtentePrim").Value)
        
        Me.txtDescrizioneImballoInLinguaCliente = fnNotNull(m_DocumentsLink("DescrizioneImballoInLinguaCliente").Value)
        DESCR_IMB_LINGUA_PRED = fnNotNull(m_DocumentsLink("DescrizioneImballoInLinguaPred").Value)
        
        DESCR_IMB_PRIM_LINGUA_CLIENTE = fnNotNull(m_DocumentsLink("DescrizioneImballoPrimInLinguaCliente").Value)
        DESCR_IMB_PRIM_LINGUA_PRED = fnNotNull(m_DocumentsLink("DescrizioneImballoPrimInLinguaPred").Value)
        
        COD_A_BARRE_IMB_PRIM_CLI = fnNotNull(m_DocumentsLink("CodiceABarreImballoPrimCliente").Value)
        DESCR_A_BARRE_IMB_PRIM_CLI = fnNotNull(m_DocumentsLink("DescrizioneCodiceABarreImballoPrimCliente").Value)
        
        COD_A_BARRE_IMB_PRIM_PRED = fnNotNull(m_DocumentsLink("CodiceABarreImballoPrimPred").Value)
        DESCR_A_BARRE_IMB_PRIM_PRED = fnNotNull(m_DocumentsLink("DescrizioneCodiceABarreImballoPrimPred").Value)
        
        QUANTITA_PER_COLLO = fnNotNull(m_DocumentsLink("QuantitaPerCollo").Value)
        PESO_LORDO_ARTICOLO = fnNotNull(m_DocumentsLink("PesoPerCollo").Value)
        MOLTIPLICATORE = fnNotNull(m_DocumentsLink("MoltiplicatorePerCollo").Value)
        LINK_LOTTO_PROD_LAV = fnNotNullN(m_DocumentsLink("IDRV_PO01_LottoCampagna").Value)
        'Me.txtRaggrOrd.Text = GET_DESCRIZIONE_LOTTO_PROD_LAV(LINK_LOTTO_PROD_LAV)
        bValue = True
        
        'NumeroRecordGriglia = Me.GrigliaCorpo.ListIndex - 1
        '----------------------------------------------------------------------------
        'Popola i controlli associati al sottodocumento con i valori presenti
        'nell'oggetto DocumentsLink
        '----------------------------------------------------------------------------
       
    Else
        'Il DocumentsLink è vuoto - non contiene righe.
        '---------------------------------------------
        'Ripulisce i controlli associati al sottodocumento
        '---------------------------------------------
        
        bValue = False
        
        Me.CDArticolo.Load 0
        Me.CDArticolo.Code = ""
        Me.TxtArticolo.Text = ""
        Link_UnitaDiMisura_Coop = 0
        Me.cboUM.WriteOn 0
        Me.txtColli.Value = 0
        Me.txtPesoLordo.Value = 0
        Me.txtPesoNetto.Value = 0
        Me.txtTara.Value = 0
        Me.txtTaraUnitaria.Value = 0
        Me.txtPezzi.Value = 0
        Me.txtQta_UM.Value = 0
        Me.CDCodiceImballo.Load 0
        Me.CDCodiceImballo.Code = ""
        Me.txtImballo.Text = ""
        Link_Movimento_Carico = 0
        Link_Movimento_Scarico = 0
        Me.txtDataLavorazione.Value = 0
        Me.CboTipoLavorazione.WriteOn 0
        Me.cboCalibro.WriteOn 0
        Me.txtLottoVendita.Text = ""
        Me.cdCliente.Load 0
        LINK_ORDINE_RIF = 0
        Me.txtIDOrdineCliente.Value = 0
        Me.txtNumeroOrdine.Value = 0
        Me.txtDataOrdine.Value = 0
        LINK_PEDANA = 0
        Me.CDTipoPedana.Load 0
        Me.txtCodicePedana.Text = ""
        Me.txtLottoCliente.Text = ""
        Me.txtAltreAnnotazioniCliente.Text = ""
        Me.txtOraLav.Text = ""
        LINK_PROCESSO_RIGA = 0
        Me.txtNumeroProtocollo.Value = 0
        Me.txtImportoUnitarioArticolo.Value = 0
        Me.txtSconto1.Value = 0
        Me.txtSconto2.Value = 0
        Me.txtImportoUnitarioImballo.Value = 0
        Me.chkTracciaImballoGest.Value = 0
        Me.chkConfermaDaUtente.Value = 0
        Me.txtNoteAgg.Text = ""
        Me.CDImballoPrimario.Load 0
        Me.txtNumeroConfImballo.Value = 0
        Me.txtTaraConfImballo.Value = 0
        Me.txtCostoConfezione.Value = 0
        
        Me.chkTracciaImballoGestPrim.Value = 0
        Me.chkConfermaDaUtentePrim.Value = 0
        Me.txtDescrizioneImballoInLinguaCliente.Text = ""
        DESCR_IMB_LINGUA_PRED = 0
        
        DESCR_IMB_PRIM_LINGUA_CLIENTE = ""
        DESCR_IMB_PRIM_LINGUA_PRED = ""
        COD_A_BARRE_IMB_PRIM_CLI = ""
        DESCR_A_BARRE_IMB_PRIM_CLI = ""
        COD_A_BARRE_IMB_PRIM_PRED = ""
        DESCR_A_BARRE_IMB_PRIM_PRED = ""

        QUANTITA_PER_COLLO = 0
        PESO_LORDO_ARTICOLO = 0
        MOLTIPLICATORE = 0
        IDProcessoProd = 0
        IDRigaProcessoProd = 0
        IDLineaProduzione = 0
        LINK_LOTTO_PROD_LAV = 0
        Me.txtRaggrOrd.Text = ""
    End If
    
    
    

    
    'Abilita/disabilita i controlli a seconda che ci sia o meno almeno un sottodocumento
        'If m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value < 0 Then
        '    Me.CDArticolo.Enabled = bValue
        '    Me.TxtArticolo.Enabled = bValue
        'Else
        '    Me.CDArticolo.Enabled = False
        '    Me.TxtArticolo.Enabled = False
        'End If
        Me.txtColli.Enabled = bValue
        Me.txtPesoLordo.Enabled = bValue
        Me.txtPesoNetto.Enabled = bValue
        Me.txtTara.Enabled = bValue
        Me.txtTaraUnitaria.Enabled = bValue
        Me.txtPezzi.Enabled = bValue
        'Me.txtQta_UM.Enabled = bValue
        Me.CDCodiceImballo.Enabled = bValue
        Me.txtImballo.Enabled = bValue
        Me.txtDataLavorazione.Enabled = bValue
        Me.lblArticolo.Enabled = bValue
        Me.lblImballo.Enabled = bValue
        Me.cdCliente.Enabled = bValue
        Me.txtCodicePedana.Enabled = bValue
        Me.cmdNuovaPedana.Enabled = bValue
        Me.cmdSelezionaOrdine.Enabled = bValue
        Me.cmdSelezionaPedana.Enabled = bValue
        Me.cmdNuovoOrdine.Enabled = bValue
        Me.cmdAnalizzaPedana.Enabled = bValue
        Me.txtLottoCliente.Enabled = bValue
        Me.txtAltreAnnotazioniCliente.Enabled = bValue
        Me.CboTipoLavorazione.Enabled = bValue
        Me.cboCalibro.Enabled = bValue
        Me.cboTipoCategoria.Enabled = bValue
        Me.cmdPesaturaAutomatica.Enabled = bValue
        Me.cmdStampaEtichettaPedana.Enabled = bValue
        Me.cmdArticoliDerivati.Enabled = bValue
        Me.cmdAggiornaOrdineCliente.Enabled = bValue
        Me.cmdDuplicaRiga.Enabled = bValue
        Me.CDTipoPedana.Enabled = bValue
        Me.txtOraLav.Enabled = bValue
        Me.LabelLink2.Enabled = bValue
        'Me.txtNumeroProtocollo.Enabled = bValue
        Me.chkTracciaImballoGest.Enabled = bValue
        Me.chkConfermaDaUtente.Enabled = bValue
        
        Me.chkTracciaImballoGestPrim.Enabled = bValue
        Me.chkConfermaDaUtentePrim.Enabled = bValue
        
        Me.txtNoteAgg.Enabled = bValue
        
        Me.CDImballoPrimario.Enabled = bValue
        Me.txtNumeroConfImballo.Enabled = bValue
        Me.txtTaraConfImballo.Enabled = bValue
        Me.txtCostoConfezione.Enabled = bValue
        
        Me.txtDescrizioneImballoInLinguaCliente.Enabled = bValue
        
        'Pulsanti Nuovo, Salva, Elimina del sottodocumento.
        Me.cmdNuovo.Enabled = True
        Me.cmdSalva.Enabled = bValue
        Me.cmdElimina.Enabled = bValue
        
        AVVIO_RICERCA_ORDINE = False
        FORZA_LINK_ORDINE = False
        
        
        
        If Me.CDArticolo.KeyFieldID > 0 Then
            bVariazioneDettaglio = True
        Else
            bVariazioneDettaglio = False
        End If

    'Me.txtArticoloInLinguaPred.Text = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.CDArticolo.KeyFieldID)
    'Me.txtCategoriaInLinguaPred.Text = GET_DESCRIZIONE_CATEGORIA_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.cboTipoCategoria.CurrentID)
    'Me.txtCalibroInLiguaPred.Text = GET_DESCRIZIONE_CALIBRO_IN_LINGUA(Me.cboLinguaPred.CurrentID, Me.cboCalibro.CurrentID)

    'Me.txtDescrizioneArticoloInLinguaCliente.Text = GET_DESCRIZIONE_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.CDArticolo.KeyFieldID)
    'Me.txtCategoriaInLingua.Text = GET_DESCRIZIONE_CATEGORIA_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.cboTipoCategoria.CurrentID)
    'Me.txtCalibroInLingua.Text = GET_DESCRIZIONE_CALIBRO_IN_LINGUA(Me.cboLinguaCliente.CurrentID, Me.cboCalibro.CurrentID)

    Me.txtNumeroEtichette.Value = Me.txtColli.Value
    Me.txtNumeroEtichetteNew.Value = Me.txtColli.Value
    Me.txtNumeroEtichettePed.Value = GET_NUMERO_COPIE_DA_PARAMETRI
    Me.txtNumeroEtichettePedNew.Value = Me.txtNumeroEtichettePed.Value
    VARIETA_ARTICOLO_LAVORATO = GET_VARIETA_ARTICOLO(Me.CDArticolo.KeyFieldID)
    FAMIGLIA_ARTICOLO_LAVORATO = GET_FAMIGLIA_ARTICOLO(Me.CDArticolo.KeyFieldID)
    TIPO_PRODOTTO_ARTICOLO_LAVORATO = GET_DESCRIZIONE_TIPO_PRODOTTO_ARTICOLO(Me.CDArticolo.KeyFieldID)
    CATEGORIA_MERCEOLOGICA_ARTICOLO_LAVORATO = GET_CATEGORIA_MERCEOLOGICA_ARTICOLO(Me.CDArticolo.KeyFieldID)
    
    If VISUALIZZA_ANDAMENTO_ORDINE = 1 Then
        GET_ANDAMENTO_ORDINE_LAVORAZIONE Me.txtIDOrdinePadre.Value, Me.CDArticolo.KeyFieldID, Me.txtRaggrOrd.Text
    End If
    
    If B_LOADING_LOTTO_IMBALLO = False Then
        RECUPERO_DATI_GIACENZA_LOTTO_IMBALLO Me.CDCodiceImballo.KeyFieldID, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
        'End If
        If Me.chkTracciaImballoGest.Value = 0 Then
            CREA_RECORDSET_LOTTI_IMBALLI Me.CDCodiceImballo.KeyFieldID, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
        End If
    End If
    
    If B_LOADING_LOTTO_IMBALLO_PRIM = False Then
        RECUPERO_DATI_GIACENZA_LOTTO_IMBALLO_PRIM Me.CDImballoPrimario.KeyFieldID, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
        'End If
        If Me.chkTracciaImballoGestPrim.Value = 0 Then
            CREA_RECORDSET_LOTTI_IMBALLI_PRIM Me.CDImballoPrimario.KeyFieldID, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
        End If
    End If
    
'    Set rsKIT = Nothing
'    Set rsKITLotti = Nothing
    
    CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    
    GET_RIEPILOGO_PESI
    
    If fnNotNullN(m_Document("PreConferimento").Value) = 0 Then
        CONTROLLO_MOVIMENTAZIONE fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    End If
End If

Screen.MousePointer = 0
B_LOADING_RIGA = False
DoEvents

End Sub
Public Sub ConnessioneDiamanteADO()
On Error GoTo ERR_ConnessioneDiamanteADO
    '------------------------------
    'APERTURA DELLA CONNESSIONE
    '------------------------------
    
    'Leggiamo il tipo di database utilizzato (Access o SQL Server)
    'Apriamo la connessione in base al tipo di database rilevato
    '(MenuOptions.DBType restituisce il valore del DBType)
    'Select Case MenuOptions.DBType
    '    Case 0 'CONNESSIONE_SQL_SERVER            'Microsoft SQL Server
    '        Set Cn = adoEngine.adoEnvironments(0).OpenConnection("", , , "DSN=Diamante;UID=sa;PWD=")
    '    Case 1 'CONNESSIONE_ACCESS               'Microsoft ACCESS
    '        Set Cn = adoEngine.adoEnvironments(0).OpenConnection("", , , "DSN=Diamante;UID=admin;PWD=dmt192981046")
    '    Case -1
            'Se la voce DBType non viene trovata nel file di registro
            'vuol dire che Diamante non è stato installato correttamente
    '        MsgBox "Impossibile avviare il programma. Diamante non è stato installatto correttamente!", vbCritical, "Aggiornamento scadenze"
    '        End
    'End Select
    
    Set Cn = m_App.Database.Connection
    Cn.QueryTimeout = 90
    
    
Exit Sub
ERR_ConnessioneDiamanteADO:
    MsgBox Err.Description, vbCritical, "Connessione Diamante di tipo ADO"
End Sub



Private Sub ParametroImballo()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoImballo FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Link_TipoImballo = rs!IDTipoImballo
Else
    Link_TipoImballo = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub ParametroSocio()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDCategoriaAnagrafica FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Link_TipoSocio = rs!IDCategoriaAnagrafica
Else
    Link_TipoSocio = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub ParametriDiDefault(DataDocumento As String)
    
    Link_Esercizio = fnGetEsercizio(DataDocumento)
    Link_PeriodoIVA = fnGetPeriodoIVA(Date)
    Link_Sezionale = fnGetSezionale(4)
    
    'Link_Magazzino_Conferimento = fnGetParametriMagazzino("IDMagazzino_Carico")
    'Link_Magazzino_Vendita = fnGetParametriMagazzino("IDMagazzino_Vendita")
    'Link_Causale_MagCar_Conf = fnGetParametriMagazzino("IDCausale_Carico_Mag_Carico")
    'Link_Causale_MagScar_Conf = fnGetParametriMagazzino("IDCausale_Scarico_Mag_Carico")
    'Link_Causale_MagCar_Vend = fnGetParametriMagazzino("IDCausale_Carico_Mag_Vendita")
    'Link_Causale_MagScar_Vend = fnGetParametriMagazzino("IDCausale_Scarico_Mag_vendita")
    'VAR_QtaMinimaPerConferimento = fnGetParametriMagazzino("QtaMinimaConfPerChiusura")
    'VAR_QtaMinimaPerVendita = fnGetParametriMagazzino("QtaMinimaVendPerChiusura")
    'Link_Arrontondamento = fnGetParametriMagazzino("IDTipoArrotondamento")
    
    
End Sub

Public Function fnGetSezionale(Link_DocumentoCoop) As Long
    Dim rsEse As DmtOleDbLib.adoResultset
    Dim sSQL As String
    
    sSQL = "SELECT RV_POSezionalePerDocumento.IDSezionale "
    sSQL = sSQL & "FROM RV_POSchemaCoop INNER JOIN "
    sSQL = sSQL & "RV_POSezionalePerDocumento ON RV_POSchemaCoop.IDRV_POSchemaCoop = RV_POSezionalePerDocumento.IDRV_POSchemaCoop "
    sSQL = sSQL & "WHERE ((IDFiliale=" & m_App.Branch & ") "
    sSQL = sSQL & "AND (IDDocumentoCoop=" & Link_DocumentoCoop & ") "
    sSQL = sSQL & "AND (Predefinito=" & fnNormBoolean(1) & "))"
    
    
    Set rsEse = Cn.OpenResultset(sSQL)
    
    If rsEse.EOF = False Then
        fnGetSezionale = rsEse!IDSezionale
    Else
        fnGetSezionale = 0
    End If
    
    rsEse.CloseResultset
    Set rsEse = Nothing
End Function
Public Function fnGetParametriMagazzino() As Long
On Error GoTo ERR_fnGetParametriMagazzino
Dim rsEse As DmtOleDbLib.adoResultset
Dim sSQL As String
    

sSQL = "SELECT * FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE ((IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"
       
Set rsEse = Cn.OpenResultset(sSQL)

If rsEse.EOF = False Then
    Link_Magazzino_Conferimento = fnNotNullN(rsEse("IDMagazzino_Carico"))
    Link_Magazzino_Vendita = fnNotNullN(rsEse("IDMagazzino_Vendita"))
    Link_Causale_MagCar_Conf = fnNotNullN(rsEse("IDCausale_Carico_Mag_Carico"))
    Link_Causale_MagScar_Conf = fnNotNullN(rsEse("IDCausale_Scarico_Mag_Carico"))
    Link_Causale_MagCar_Vend = fnNotNullN(rsEse("IDCausale_Carico_Mag_Vendita"))
    Link_Causale_MagScar_Vend = fnNotNullN(rsEse("IDCausale_Scarico_Mag_vendita"))
    VAR_QtaMinimaPerConferimento = fnNotNullN(rsEse("QtaMinimaConfPerChiusura"))
    VAR_QtaMinimaPerVendita = fnNotNullN(rsEse("QtaMinimaVendPerChiusura"))
    Link_Arrontondamento = fnNotNullN(rsEse("IDTipoArrotondamento"))
    Numero_Decimali_Pesi = fnNotNullN(rsEse("IDRV_POTipoDecimaliPesiLavorazione").Value) - 1
    TROVA_PREZZI_ORD_CAT = fnNotNullN(rsEse("AbilitaCategoriaImportoOrdine").Value)
    TROVA_PREZZI_ORD_CAL = fnNotNullN(rsEse("AbilitaCalibroImportoOrdine").Value)
    NUOVA_RIGA_INIZIO = fnNotNullN(rsEse("NuovoRecordInLav").Value)
    TROVA_PREZZI_NO_IMB = fnNotNullN(rsEse("NonAbilitareImportoImballo").Value)
    VISUALIZZA_MERCE_ORDINATA = fnNotNullN(rsEse("VisListaMerceOrdinata").Value)
    RIP_DIFF_COLLI_DA_ORD = fnNotNullN(rsEse("RipDiffColliDaLavDaOrd").Value)
    VIS_ELENCO_ORD_NEW_PED = fnNotNullN(rsEse("VisualizzaListaOrdineNuovaPedana").Value)
    VIS_NOTE_LAV_DA_ORD = fnNotNullN(rsEse("VisualizzaNoteLavDaOrdine").Value)
    ATTIVA_SEL_LOTTO_PROD_IN_LAV = fnNotNullN(rsEse("SelezionaLottoCampagnaInLavorazione").Value)
    NON_VIS_RIGHE_ORD_COMPLETE = fnNotNullN(rsEse("NonVisualizzaRigheOrdiniCompletateInSelLav").Value)
    IDSOCIO_PRE_CONF = fnNotNullN(rsEse!IDAnagraficaSocioMovPreConferimento)
    NON_RICALCOLARE_ALLE_MODIFICHE = fnNotNullN(rsEse("ModificaLavorazioneSenzaRicalcolo").Value)
    If Numero_Decimali_Pesi < 0 Then
        Numero_Decimali_Pesi = 2
    End If
Else
    Link_Magazzino_Conferimento = 0
    Link_Magazzino_Vendita = 0
    Link_Causale_MagCar_Conf = 0
    Link_Causale_MagScar_Conf = 0
    Link_Causale_MagCar_Vend = 0
    Link_Causale_MagScar_Vend = 0
    VAR_QtaMinimaPerConferimento = 0
    VAR_QtaMinimaPerVendita = 0
    Link_Arrontondamento = 0
    Numero_Decimali_Pesi = 2
    TROVA_PREZZI_ORD_CAT = 0
    TROVA_PREZZI_ORD_CAL = 0
    NUOVA_RIGA_INIZIO = 0
    TROVA_PREZZI_NO_IMB = 0
    VISUALIZZA_MERCE_ORDINATA = 0
    RIP_DIFF_COLLI_DA_ORD = 0
    VIS_ELENCO_ORD_NEW_PED = 0
    VIS_NOTE_LAV_DA_ORD = 0
    ATTIVA_SEL_LOTTO_PROD_IN_LAV = 0
    NON_VIS_RIGHE_ORD_COMPLETE = 0
    NON_RICALCOLARE_ALLE_MODIFICHE = 0
    IDSOCIO_PRE_CONF = 0
End If

rsEse.CloseResultset
Set rsEse = Nothing

Exit Function
ERR_fnGetParametriMagazzino:
    MsgBox Err.Description, vbCritical, "fnGetParametriMagazzino"
End Function
Public Function fnGetNumeroDocumento()
    Dim rsEse As DmtOleDbLib.adoResultset
    Dim sSQL As String
    
    sSQL = "SELECT ProgressivoDisponibile FROM ProgressivoSezionale "
    sSQL = sSQL & "WHERE ((IDPeriodoIva=" & Link_PeriodoIVA & ") "
    sSQL = sSQL & "AND (IDSezionale=" & Link_Sezionale & "))"
    
    
    Set rsEse = Cn.OpenResultset(sSQL)
    
    If rsEse.EOF = False Then
        NumeroDocumentoDisponibile = rsEse!ProgressivoDisponibile
        fnGetNumeroDocumento = rsEse!ProgressivoDisponibile
    Else
        NumeroDocumentoDisponibile = 1
        fnGetNumeroDocumento = 1
    End If
    
    rsEse.CloseResultset
    Set rsEse = Nothing


End Function
Private Sub m_DocumentsLink1_OnReposition()
Dim bValue As Boolean
Dim iIndex As Integer
Dim Testo As String

On Error Resume Next
    
If AggiornamentoDocumento = 1 Then Exit Sub
    If Not (m_DocumentsLink1.BOF And m_DocumentsLink1.EOF) Then
        'Il DocumentsLink non è vuoto - contiene dei dati.
        
        
                
        Link_TipoProdotto_Q = GET_TIPO_PRODOTTO_ARTICOLO(fnNotNullN(m_DocumentsLink1("IDArticolo").Value))
        Me.CDArticolo_Q.Load fnNotNullN(m_DocumentsLink1("IDArticolo").Value)
        Me.CDArticolo_Q.Code = fnNotNull(m_DocumentsLink1("CodiceArticolo").Value)
        Me.TxtArticolo_Q.Text = fnNotNull(m_DocumentsLink1("Articolo").Value)
        Me.cboUM_Q.WriteOn IIf(IsNull(m_DocumentsLink1("IDUnitaDiMisura").Value), 0, m_DocumentsLink1("IDUnitaDiMisura").Value)
        Link_UnitaDiMisura_Coop_Q = fnNotNullN(m_DocumentsLink1("IDUnitaDiMisuraCoop").Value)
        Me.txtColli_Q.Value = fnNotNullN(m_DocumentsLink1("Colli").Value)
        Me.txtPesoLordo_Q.Value = fnNotNullN(m_DocumentsLink1("PesoLordo").Value)
        Me.txtTara_Q.Value = fnNotNullN(m_DocumentsLink1("Tara").Value)
        Me.txtPesoNetto_Q.Value = fnNotNullN(m_DocumentsLink1("PesoNetto").Value)
        Me.txtTaraUnitaria_Q.Value = fnNotNullN(m_DocumentsLink1("TaraUnitaria").Value)
        Me.txtPezzi_Q.Value = fnNotNullN(m_DocumentsLink1("Pezzi").Value)
        Me.txtQta_UM_Q.Value = fnNotNullN(m_DocumentsLink1("Qta_UM").Value)
        Me.CDCodiceImballo_Q.Load fnNotNull(m_DocumentsLink1("IDImballoVendita").Value)
        Me.CDCodiceImballo_Q.Code = fnNotNull(m_DocumentsLink1("CodiceImballoVendita").Value)
        Me.txtImballo_Q.Text = fnNotNull(m_DocumentsLink1("ImballoVendita").Value)
        Me.txtDataLavorazione_Q.Value = fnNotNullN(m_DocumentsLink1("DataDocumento").Value)
        Me.txtOraLav_Q.Text = fnNotNull(m_DocumentsLink1("OraLavorazione").Value)
        Me.CboTipoLavorazione_Q.WriteOn fnNotNullN(m_DocumentsLink1("IDTipoLavorazione").Value)
        Me.txtQtaPrelievoQ.Value = fnNotNullN(m_DocumentsLink1("QtaPrelevata").Value)
        Me.txtSequenzaPrelievo.Value = fnNotNullN(m_DocumentsLink1("Sequenza").Value)
        bValue = True
        
       
    Else
        'Il DocumentsLink è vuoto - non contiene righe.
        '---------------------------------------------
        'Ripulisce i controlli associati al sottodocumento
        '---------------------------------------------
        
        bValue = False
        
        Me.CDArticolo_Q.Load 0
        Me.CDArticolo_Q.Code = ""
        Me.TxtArticolo_Q.Text = ""
        Link_UnitaDiMisura_Coop_Q = 0
        Me.cboUM_Q.WriteOn 0
        Me.txtColli_Q.Value = 0
        Me.txtPesoLordo_Q.Value = 0
        Me.txtPesoNetto_Q.Value = 0
        Me.txtTara_Q.Value = 0
        Me.txtTaraUnitaria_Q.Value = 0
        Me.txtPezzi_Q.Value = 0
        Me.txtQta_UM_Q.Value = 0
        Me.CDCodiceImballo_Q.Load 0
        Me.CDCodiceImballo_Q.Code = ""
        Me.txtImballo_Q.Text = ""
        Me.txtDataLavorazione_Q.Value = 0
        Me.txtOraLav_Q.Text = ""
        Me.CboTipoLavorazione_Q.WriteOn 0
        Me.txtQtaPrelievoQ.Value = 0
        Me.txtSequenzaPrelievo.Value = 0
    End If
    
    
    'Abilita/disabilita i controlli a seconda che ci sia o meno almeno un sottodocumento
        If fnNotNullN(m_DocumentsLink1("IDRV_POLavorazione").Value) <= 0 Then
            Me.CDArticolo_Q.Enabled = bValue
            Me.TxtArticolo_Q.Enabled = bValue
            Me.lblArticolo_Q.Enabled = bValue
        Else
            Me.CDArticolo_Q.Enabled = False
            Me.TxtArticolo_Q.Enabled = False
            Me.lblArticolo_Q.Enabled = False
        End If
        Me.txtColli_Q.Enabled = bValue
        Me.txtPesoLordo_Q.Enabled = bValue
        Me.txtPesoNetto_Q.Enabled = bValue
        Me.txtTara_Q.Enabled = bValue
        Me.txtPezzi_Q.Enabled = bValue
        Me.CDCodiceImballo_Q.Enabled = bValue
        Me.txtImballo_Q.Enabled = bValue
        Me.txtDataLavorazione_Q.Enabled = bValue
        Me.lblArticolo_Q.Enabled = bValue
        Me.lblImballo_Q.Enabled = bValue
        Me.txtDataLavorazione_Q.Enabled = bValue
        Me.txtOraLav_Q.Enabled = bValue
        Me.CboTipoLavorazione_Q.Enabled = bValue
        Me.txtQtaPrelievoQ.Enabled = bValue
        
    'Pulsanti Nuovo, Salva, Elimina del sottodocumento.
    
        Me.cmdNuovo_Q.Enabled = True
        Me.cmdSalva_Q.Enabled = bValue
        Me.cmdElimina_Q.Enabled = bValue
        
    'Funzione
        
        If Me.CDArticolo_Q.KeyFieldID > 0 Then
            bVariazioneDettaglio = True
        Else
            bVariazioneDettaglio = False
        End If
        
        If (Me.txtQtaPrelievoQ.Value > 0) Then
            Me.txtQtaLavPrec.Value = txtDisponibiltaLottoCaricato.Value - (Me.txtDisponibiltaLottoCaricato.Value - (fnNotNullN(m_DocumentsLink1("QtaPrelevata").Value) - fnNotNullN(m_DocumentsLink1("Qta_UM").Value)))
        Else
            Me.txtQtaLavPrec.Value = 0
        End If
        
        GET_PERC_RESO
End Sub



Private Sub PBOrdine_Click()
    cmdAnalizzaOrdine_Click
End Sub

Private Sub PBOrdine_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
Dim cursHnd As Long

    cursHnd = LoadCursor(0, HandCursor)
    If cursHnd > 0 Then SetCursor cursHnd
End Sub

Private Sub PBOrdineDettaglio_Click()
On Error GoTo ERR_PBOrdineDettaglio_Click
    If Me.txtIDOrdineCliente.Value > 0 Then
        Screen.MousePointer = 0
        LINK_ORDINE_SELEZIONATO = Me.txtIDOrdineCliente.Value
        LINK_ART_ORD_PADRE_SEL = Me.CDArticolo.KeyFieldID 'GET_LINK_ARTICOLO_PADRE_ORDINATO(Me.CDArticolo.KeyFieldID)
        frmAnalizzaOrdine.Show vbModal
    End If

Exit Sub
ERR_PBOrdineDettaglio_Click:
    MsgBox Err.Description, vbCritical, "PBOrdineDettaglio_Click"
End Sub

Private Sub PBOrdineDettaglio_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
Dim cursHnd As Long

    cursHnd = LoadCursor(0, HandCursor)
    If cursHnd > 0 Then SetCursor cursHnd
End Sub

Private Sub txtAndamentoOrdineDett_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
Dim cursHnd As Long

    cursHnd = LoadCursor(0, HandCursor)
    If cursHnd > 0 Then SetCursor cursHnd
End Sub

Private Sub TxtArticolo_LostFocus()
On Error GoTo ERR_TxtArticolo_LostFocus

Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
Dim I As Long
    
 If Me.CDArticolo.Code = "" Then
    If Me.TxtArticolo.Text <> "" Then
        sSQL = "SELECT IDArticolo, Articolo, CodiceArticolo, IDUnitaDiMisuraAcquisto,RV_POIDTipoLavorazione "
        sSQL = sSQL & "FROM Articolo "
        sSQL = sSQL & "WHERE ((IDTipoProdotto <> " & Link_TipoImballo & ") "

        sSQL = sSQL & "AND (IDAzienda=" & m_App.IDFirm & ") "
        sSQL = sSQL & "AND (Articolo LIKE " & fnNormString(Me.TxtArticolo.Text & "%") & "))"
    
        Set rs = Cn.OpenResultset(sSQL, adOpenKeyset)

        I = 0
        If rs.EOF = False Then
        
            While Not rs.EOF
                I = I + 1
                If I > 1 Then
                    rs.MoveLast
                End If
            rs.MoveNext
            Wend
        End If
        
        If I = 1 Then
            sSQL = "SELECT IDArticolo, Articolo, CodiceArticolo, IDUnitaDiMisuraAcquisto, RV_POIDTipoLavorazione, IDTipoProdotto "
            sSQL = sSQL & "FROM Articolo "
            sSQL = sSQL & "WHERE ((IDTipoProdotto <> " & Link_TipoImballo & ") "

            sSQL = sSQL & "AND (IDAzienda=" & m_App.IDFirm & ") "
            sSQL = sSQL & "AND (Articolo LIKE " & fnNormString(Me.TxtArticolo.Text & "%") & "))"

            Set rs = Cn.OpenResultset(sSQL)
                Me.CDArticolo.Load rs!IDArticolo
                Me.CDArticolo.Code = rs!CodiceArticolo
                Me.TxtArticolo.Text = rs!Articolo
                Link_UnitaDiMisura_Coop = fnGetUMCoop(IIf(IsNull(rs!IDUnitaDiMisuraAcquisto), 0, rs!IDUnitaDiMisuraAcquisto))
                Me.CboTipoLavorazione.WriteOn fnNotNullN(rs!RV_POIDTipoLavorazione)
                Me.txtColli.SetFocus
            rs.CloseResultset
            Set rs = Nothing
        End If
        If I = 0 Then
            MsgBox "Non sono stati trovati i dati per i filtri impostati", vbInformation, "Articolo"
        End If
        If I > 1 Then
            rs.CloseResultset
            Set rs = Nothing
        
            lblArticolo_Click
            Me.txtColli.SetFocus
        End If
        
    End If
End If
Exit Sub
ERR_TxtArticolo_LostFocus:
    MsgBox Err.Description, vbCritical, "TxtArticolo_LostFocus"
End Sub



Private Sub TxtArticolo_Q_LostFocus()
    lblArticolo_Q_Click
End Sub



Private Sub txtCodiceABarreArticoloCliente_LostFocus()

Dim CodiceABarreDaPassare As String

If Len(Trim(txtCodiceABarreArticoloCliente)) <= 11 Then
    txtCodificaArticoloCodiceABarre = ""
End If
If Len(Trim(txtCodiceABarreArticoloCliente)) > 13 Then
    txtCodificaArticoloCodiceABarre = ""
End If
If Len(Trim(txtCodiceABarreArticoloCliente)) = 13 Then
    CodiceABarreDaPassare = Mid(fnNotNull(Trim(txtCodiceABarreArticoloCliente)), 1, Len(Trim(txtCodiceABarreArticoloCliente)) - 1)
    txtCodificaArticoloCodiceABarre = ean13$(CodiceABarreDaPassare)
End If
If Len(Trim(txtCodiceABarreArticoloCliente)) = 12 Then
    txtCodificaArticoloCodiceABarre = ean13$(fnNotNull(Trim(txtCodiceABarreArticoloCliente)))
End If
    

End Sub

Private Sub txtCodicePedanaCliente_Change()
    Me.txtCodificaCodicePedanaCliente.Text = GET_CODICE_PEDANA_CLIENTE(Me.txtCodicePedanaCliente.Value)
End Sub

Private Sub txtColli_Change()
    If Link_UnitaDiMisura_Coop = 1 Then
        Me.txtQta_UM.Value = Me.txtColli.Value
    End If
End Sub

Private Sub txtColli_LostFocus()
On Error Resume Next
Dim Quantita As Double

    If B_LOADING_RIGA = True Then Exit Sub
    
    Me.txtTara.Value = Me.txtColli.Value * (Me.txtTaraUnitaria.Value + (Me.txtNumeroConfImballo.Value * Me.txtTaraConfImballo.Value))
    
    If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
        If VARIAZIONE_DA_PESATURA = False Then
            If TIPO_PESO_ARTICOLO <= 1 Then
                If PESO_LORDO_ARTICOLO > 0 Then
                    Me.txtPesoLordo.Value = PESO_LORDO_ARTICOLO * Me.txtColli.Value
                End If
            Else
                If PESO_LORDO_ARTICOLO > 0 Then
                    Me.txtPesoNetto.Value = PESO_LORDO_ARTICOLO * Me.txtColli.Value
                    Me.txtPesoLordo.Value = Me.txtPesoNetto.Value + Me.txtTara.Value
                End If
            End If
        End If
    Else
        If VARIAZIONE_DA_PESATURA = False Then
            If (PESO_LORDO_ARTICOLO > 0) Then
                If TIPO_PESO_ARTICOLO <= 1 Then
                    Me.txtPesoLordo.Value = PESO_LORDO_ARTICOLO * Me.txtColli.Value
                Else
                    Me.txtPesoNetto.Value = PESO_LORDO_ARTICOLO * Me.txtColli.Value
                    Me.txtPesoLordo.Value = Me.txtPesoNetto.Value + Me.txtTara.Value
                End If
            End If
        End If
    End If
    
'    If txtNumeroConfImballo.Value > 0 Then
'        Me.txtPezzi.Value = Me.txtColli.Value * txtNumeroConfImballo.Value * GET_QTA_PER_COLLO_CONFEZ(Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID)
'    Else
'        If QUANTITA_PER_COLLO > 0 Then
'            Me.txtPezzi.Value = Me.txtColli.Value * QUANTITA_PER_COLLO
'        End If
'    End If
    
    If txtNumeroConfImballo.Value > 0 Then
        If QUANTITA_PER_COLLO > 0 Then
            Me.txtPezzi.Value = Me.txtColli.Value * QUANTITA_PER_COLLO
        Else
            Me.txtPezzi.Value = Me.txtColli.Value * txtNumeroConfImballo.Value
        End If
    Else
        If QUANTITA_PER_COLLO > 0 Then
            Me.txtPezzi.Value = Me.txtColli.Value * QUANTITA_PER_COLLO
        End If
    End If
    
    CalcoloPesoNetto
    
    If Me.txtColli.Value <> fnNotNullN(m_DocumentsLink("Colli").Value) Then
        CREA_RECORDSET_KIT Me.CDArticolo.KeyFieldID, Me.CDCodiceImballo.KeyFieldID, Me.CDImballoPrimario.KeyFieldID, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
    End If
    
    
End Sub

Private Sub txtColli_Q_Change()
    If Link_UnitaDiMisura_Coop_Q = 1 Then
        Me.txtQta_UM_Q.Value = Me.txtColli_Q.Value
    End If
    
    GET_PERC_RESO
End Sub

Private Sub txtColli_Q_LostFocus()
On Error Resume Next
    'If fnNotNullN(m_DocumentsLink("Tara").Value) <= 0 Then
    CalcoloPesoNetto_Q
    'End If
End Sub


Private Sub txtDataDocumento_Change()
    If Not (BrwMain.Visible) Then Change
End Sub



Private Sub txtDataLavorazione_LostFocus()
On Error Resume Next
    If m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value <= 0 Then
        'Me.txtCodiceLotto.Text = fnGetCodiceLotto
        'Me.txtDescrizioneLotto.Text = fnGetDescrizioneLotto
    End If
End Sub


Private Sub txtDataOrdine_LostFocus()
If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
    If Me.txtIDOrdineCliente.Value = 0 Then
        If Me.txtDataOrdine.Value > 0 Then
            If FORZA_LINK_ORDINE = False Then
                AVVIO_RICERCA_ORDINE = True
                cmdSelezionaOrdine_Click
                AVVIO_RICERCA_ORDINE = False
            End If

        End If
    End If
End If
End Sub

Private Sub txtDataPartenza_LostFocus()
If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
    If Me.txtIDOrdineCliente.Value = 0 Then
        If Me.txtDataPartenza.Value > 0 Then
            If FORZA_LINK_ORDINE = False Then
                AVVIO_RICERCA_ORDINE = True
                cmdSelezionaOrdine_Click
                AVVIO_RICERCA_ORDINE = False
            End If

        End If
    End If
End If
End Sub

Private Sub txtIDOrdineCliente_Change()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

If Me.txtIDOrdineCliente.Value = 0 Then
    Me.lblStatoOrdine.Caption = "ORDINE NON ASSEGNATO"
    Me.lblStatoOrdine.BackColor = vbRed
    STATO_ORDINE = 0
    Me.cdCliente.Load 0
    Me.lblNomeCliente.Caption = ""
    Me.txtDataOrdine.Value = 0
    Me.txtNumeroOrdine.Value = 0
    Me.txtNListaPrelievo.Value = 0
    
    Me.cboDestinazione.WriteOn 0
    
    Me.txtDataPartenza.Value = 0
    Me.txtDataOrdineCliente.Value = 0
    Me.txtNumeroOrdineCliente.Text = ""
   
    Me.txtDataOrdineOri.Value = 0
    Me.txtNumeroOrdineOri.Text = ""
    Me.txtIDOrdinePadre.Value = 0
   
    Me.cboSezionaleOrdOri.WriteOn 0
    
    ORDINE_TIPO_ORDINE = ""
    ORDINE_TARGA_AUTOMEZZO = ""
    ORDINE_ISTRUZIONI_MITT = ""
    ORDINE_NOTE_FATT = ""
    ORDINE_NOTE_CORPO = ""
    ORDINE_NOTE_INTERNE = ""
    
    
    GET_INFO_VETTORE 0
    
    If VISUALIZZA_ANDAMENTO_ORDINE = 1 Then
        GET_ANDAMENTO_ORDINE Me.txtIDOrdinePadre.Value
        GET_ANDAMENTO_ORDINE_LAVORAZIONE Me.txtIDOrdinePadre.Value, Me.CDArticolo.KeyFieldID, Me.txtRaggrOrd.Text
    End If
    
    Exit Sub
End If

sSQL = "SELECT Link_Vet_Vettore, Link_nom_ult_sito, Doc_ordine_chiuso, Doc_data_prevista_evasione, Nom_nome, "
sSQL = sSQL & "Doc_data_presso_nom, Doc_numero_presso_nom, Doc_annotazioni_variazio, RV_POAnnotazioniInterna, "
sSQL = sSQL & "RV_PODescrizioneCorpoDocEv, RV_POIDLuogoPresaMerce, RV_POIDTrasportatoreSuccessivo, RV_POIDUtenteBlocco, "
sSQL = sSQL & "RV_PODataArrivoMerceLuogo, RV_POOraArrivoMerceLuogo, RV_PODataArrivoMerce, RV_POOraArrivoMerce, "
sSQL = sSQL & "Link_Doc_spedizione, Link_Nom_Lettera_intento, Link_Nom_IVA, Doc_data, Doc_numero, Link_nom_Anagrafica, "
sSQL = sSQL & "RV_PODataOrdinePadre, RV_PONumeroOrdinePadre, RV_POIDOrdinePadre, RV_PONumeroListaPrelievo, Link_Doc_sezionale, "
sSQL = sSQL & "RV_POIDTipoOrdine, RV_POTargaAutomezzo, RV_POIstruzioniMittente, Doc_annotazioni_variazio, RV_PODescrizioneCorpoDocEv, RV_POAnnotazioniInterna "
sSQL = sSQL & "FROM ValoriOggettoPerTipo000F "
sSQL = sSQL & " WHERE IDOggetto=" & Me.txtIDOrdineCliente.Value

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.lblStatoOrdine.Caption = "ORDINE NON TROVATO"
    STATO_ORDINE = 0
    Me.cdCliente.Load 0
    Me.lblNomeCliente.Caption = ""
    Me.txtDataOrdine.Value = 0
    Me.txtNumeroOrdine.Value = 0
    Me.txtNListaPrelievo.Value = 0
    
    Me.cboDestinazione.WriteOn 0

    Me.txtDataPartenza.Value = 0
    Me.txtDataOrdineCliente.Value = 0
    Me.txtNumeroOrdineCliente.Text = ""
    
    Me.txtIDOrdinePadre = 0
    Me.txtNumeroOrdineOri.Text = ""
    Me.txtDataOrdineOri.Value = 0
    Me.cboSezionaleOrdOri.WriteOn 0
    
    GET_INFO_VETTORE 0
    
    ORDINE_TIPO_ORDINE = ""
    ORDINE_TARGA_AUTOMEZZO = ""
    ORDINE_ISTRUZIONI_MITT = ""
    ORDINE_NOTE_FATT = ""
    ORDINE_NOTE_CORPO = ""
    ORDINE_NOTE_INTERNE = ""
Else
    Me.cdCliente.Load fnNotNullN(rs!Link_nom_anagrafica)
    Me.lblNomeCliente.Caption = fnNotNull(rs!Nom_nome)
    If Len(fnNotNull(rs!Doc_numero_presso_nom)) > 0 Then
        Me.lblNomeCliente.Caption = Me.lblNomeCliente.Caption & " (" & fnNotNull(rs!Doc_numero_presso_nom) & ")"
    End If
    
    
    Me.txtDataOrdine.Value = fnNotNullN(rs!RV_PODataOrdinePadre) ' fnNotNullN(rs!Doc_Data)
    Me.txtNumeroOrdine.Value = fnNotNullN(rs!RV_PONumeroOrdinePadre) 'fnNotNullN(rs!Doc_Numero)
    Me.txtNListaPrelievo.Value = fnNotNullN(rs!RV_PONumeroListaPrelievo)
    
    Me.cboDestinazione.WriteOn fnNotNullN(rs!Link_Nom_ult_sito)

    Me.txtDataPartenza.Value = fnNotNullN(rs!Doc_data_prevista_evasione)
    Me.txtDataOrdineCliente.Value = fnNotNullN(rs!Doc_data_presso_nom)
    Me.txtNumeroOrdineCliente.Text = fnNotNull(rs!Doc_numero_presso_nom)
    
    'Me.cboIvaCliente.WriteOn fnNotNullN(rs!Link_Nom_IVA)
    Me.txtIDOrdinePadre = fnNotNullN(rs!RV_POIDOrdinePadre)
    Me.txtNumeroOrdineOri.Text = fnNotNullN(rs!Doc_Numero)
    Me.txtDataOrdineOri.Value = fnNotNullN(rs!Doc_Data)
    Me.cboSezionaleOrdOri.WriteOn fnNotNullN(rs!Link_Doc_sezionale)
    
    GET_INFO_VETTORE fnNotNullN(rs!Link_Vet_vettore)
    
    If fnNotNullN(rs!Doc_ordine_chiuso) = False Then
        Me.lblStatoOrdine.Caption = "ORDINE APERTO"
        Me.lblStatoOrdine.BackColor = vbGreen
        STATO_ORDINE = 0
    Else
        Me.lblStatoOrdine.Caption = "ORDINE CHIUSO"
        Me.lblStatoOrdine.BackColor = vbRed
        STATO_ORDINE = 1
    End If
    If fnNotNullN(rs!RV_POIDUtenteBlocco) > 0 Then
        
        If TheApp.IDUser <> fnNotNullN(rs!RV_POIDUtenteBlocco) Then
            Me.lblStatoOrdine.Caption = "ORDINE BLOCCATO"
            Me.lblStatoOrdine.BackColor = vbRed
            STATO_ORDINE = 3
        Else
            Me.lblStatoOrdine.Caption = "ORDINE APERTO"
            Me.lblStatoOrdine.BackColor = vbGreen
            STATO_ORDINE = 0
        End If
        
    End If
    
    ORDINE_TIPO_ORDINE = GET_TIPO_ORDINE(fnNotNullN(rs!RV_POIDTipoOrdine))
    ORDINE_TARGA_AUTOMEZZO = fnNotNull(rs!RV_POTargaAutomezzo)
    ORDINE_ISTRUZIONI_MITT = fnNotNull(rs!RV_POIstruzioniMittente)
    ORDINE_NOTE_FATT = fnNotNull(rs!Doc_annotazioni_variazio)
    ORDINE_NOTE_CORPO = fnNotNull(rs!RV_PODescrizioneCorpoDocEv)
    ORDINE_NOTE_INTERNE = fnNotNull(rs!RV_POAnnotazioniInterna)
End If

rs.CloseResultset
Set rs = Nothing

'''''''''''''''''''''''CONTROLLO SE ORDINE CONFERMATO'''''''''''''''''''''
sSQL = "SELECT IDOggetto FROM RV_POTMPEvasioneOrdini "
sSQL = sSQL & "WHERE IDOggetto=" & Me.txtIDOrdineCliente.Value

Set rs = Cn.OpenResultset(sSQL)
If Not rs.EOF Then
    Me.lblStatoOrdine.Caption = "ORDINE IN CONFERMA"
    Me.lblStatoOrdine.BackColor = vbYellow
    STATO_ORDINE = 2
End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

If VISUALIZZA_ANDAMENTO_ORDINE = 1 Then
    GET_ANDAMENTO_ORDINE Me.txtIDOrdinePadre.Value
End If
If VISUALIZZA_MERCE_ORDINATA = 1 Then
    If ((fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0)) Then
        'PARAMETRO VISUALIZZA RIGA ORDINE ALLA SELEZIONE DELL'ORDINE QUANDO E' UNA NUOVA LAVORAZIONE
        If Me.CDArticolo.KeyFieldID = 0 Then
            If ((Me.txtIDOrdineCliente.Value > 0) And (RECUPERO_PREZZI_DA_ORD = False)) Then
                If GET_CONTROLLO_MERCE_IN_ORDINE(Me.txtIDOrdinePadre.Value) = True Then
                    MODALITA_RECUPERO_RIGA_ORD = 1
                    LINK_ORDINE_PER_PREZZO = Me.txtIDOrdinePadre.Value
                    frmCorpoOrdine.Show vbModal
                End If
            End If
        End If
    Else
        If B_LOADING_RIGA = False Then
            If (fnNotNullN(m_DocumentsLink("IDOggettoOrdinePadre").Value) <> Me.txtIDOrdinePadre.Value) Then
                If ((Me.txtIDOrdineCliente.Value > 0) And (RECUPERO_PREZZI_DA_ORD = False)) Then
                    If GET_CONTROLLO_MERCE_IN_ORDINE(Me.txtIDOrdinePadre.Value) = True Then
                        MODALITA_RECUPERO_RIGA_ORD = 1
                        LINK_ORDINE_PER_PREZZO = Me.txtIDOrdinePadre.Value
                        frmCorpoOrdine.Show vbModal
                    End If
                End If
            End If
        End If
    End If
End If
End Sub

Private Sub txtIDRigaOrdine_Change()
On Error GoTo ERR_txtIDRigaOrdine_Change
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim NumeroColliOrdinati As Double
Dim NumeroColliLavorati As Double
Dim Testo As String
Dim NumeroColliPerPedana As Long
Dim PesoParziale As Double

If fnNotNullN(m_DocumentsLink("IDValoriOggettoDettaglioRigaOrd").Value) = Me.txtIDRigaOrdine.Value Then
    GET_ETICHETTE_DA_RIGA_ORD Me.txtIDRigaOrdine.Value
    Exit Sub
End If
If Me.txtIDRigaOrdine.Value = 0 Then Exit Sub
If RECUPERO_PREZZI_DA_ORD = True Then Exit Sub

sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & "WHERE IDValoriOggettoDettaglio=" & Me.txtIDRigaOrdine.Value
sSQL = sSQL & "  AND RV_POTipoRiga=1"

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    
    If Me.CDArticolo.KeyFieldID = 0 Then Me.CDArticolo.Load fnNotNullN(rs!Link_Art_articolo)
    
    If Me.CDCodiceImballo.KeyFieldID = 0 Then Me.CDCodiceImballo.Load fnNotNullN(rs!RV_POIDImballo)
    
    If Me.CDImballoPrimario.KeyFieldID = 0 Then Me.CDImballoPrimario.Load fnNotNullN(rs!RV_POIDImballoPrimario)
    Me.txtNumeroConfImballo.Value = fnNotNullN(rs!RV_PONumeroConfezioniPerImballo)
    Me.txtTaraConfImballo.Value = fnNotNullN(rs!RV_POTaraImballoPrimario)

    NumeroColliPerPedana = GET_COLLI_PER_IMBALLO(Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.CDCodiceImballo.KeyFieldID)
    QUANTITA_PER_COLLO = fnNotNullN(rs!RV_POQuantitaPerCollo)
    PESO_LORDO_ARTICOLO = fnNotNullN(rs!RV_POPesoPerCollo)
    MOLTIPLICATORE = fnNotNullN(rs!RV_POMoltiplicatorePerCollo)
    
    If RIP_DIFF_COLLI_DA_ORD = 1 Then
        NumeroColliOrdinati = GET_TOTALI_ORDINE_DETTAGLIO_COLLI(Me.txtIDOrdinePadre.Value, 0, "", Me.txtIDRigaOrdine.Value)
        NumeroColliLavorati = GET_NUMERO_COLLI_LAVORATI_PER_ARTICOLO_ORDINATO(Me.txtIDOrdinePadre.Value, 0, "", Me.txtIDRigaOrdine.Value)
        Me.txtColli.Value = NumeroColliOrdinati - NumeroColliLavorati
        If NumeroColliPerPedana > 0 Then
            If Me.txtColli.Value > NumeroColliPerPedana Then
                Me.txtColli.Value = NumeroColliPerPedana
            End If
        End If
        
        If Me.txtColli.Value < 0 Then
            Me.txtColli.Value = 0
        End If
        
        If PESO_LORDO_ARTICOLO = 0 Then
            If fnNotNullN(rs!Art_numero_colli) > 0 Then
                PesoParziale = (fnNotNullN(rs!Art_peso) / fnNotNullN(rs!Art_numero_colli)) * Me.txtColli.Value
                Me.txtPesoLordo.Value = PesoParziale
            End If
        End If
    Else
        Me.txtColli.Value = fnNotNullN(rs!Art_numero_colli)
        Me.txtPesoLordo.Value = fnNotNullN(rs!Art_peso)
        Me.txtTara.Value = fnNotNullN(rs!Art_tara)
        Me.txtPesoNetto.Value = Me.txtPesoLordo.Value - Me.txtTara.Value
        Me.txtPezzi.Value = fnNotNullN(rs!Art_quantita_pezzi)
        Me.txtQta_UM.Value = fnNotNullN(rs!art_quantita_totale)
    End If

'    If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey)) < 0 Then
'        If Me.txtColli.Value <> fnNotNullN(rs!Art_numero_colli) Then
'            Testo = "ATTENZIONE!!!" & vbCrLf
'            Testo = Testo & "Il numero dei colli predefinito differisce dalla riga ordine selezionata" & vbCrLf
'            Testo = Testo & "Vuoi riportare gli stessi colli dall'ordine?"
'
'            If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo dati") = vbYes Then
'                If RIP_DIFF_COLLI_DA_ORD = 1 Then
'                    Me.txtColli.Value = fnNotNullN(rs!Art_numero_colli) - NumeroColliLavorati
'                Else
'                    Me.txtColli.Value = fnNotNullN(rs!Art_numero_colli)
'                End If
'                Me.txtPesoLordo.Value = fnNotNullN(rs!Art_peso)
'                Me.txtTara.Value = fnNotNullN(rs!Art_tara)
'                Me.txtPesoNetto.Value = Me.txtPesoLordo.Value - Me.txtTara.Value
'                Me.txtPezzi.Value = fnNotNullN(rs!Art_quantita_pezzi)
'                Me.txtQta_UM.Value = fnNotNullN(rs!art_quantita_totale)
'            End If
'        End If
'    End If
    
    txtColli_LostFocus
    CalcoloPesoNetto
    
    Me.txtImportoUnitarioArticolo.Value = fnNotNullN(rs!Art_prezzo_unitario_netto_IVA)
    Me.txtImportoUnitarioListino.Value = fnNotNullN(rs!RV_POImportoUnitarioListino)
    Me.txtSconto1.Value = fnNotNullN(rs!Art_sco_in_percentuale_1)
    Me.txtSconto2.Value = fnNotNullN(rs!Art_sco_in_percentuale_2)
    Me.chkPrezzoInclusoImballo.Value = fnNotNullN(rs!RV_POImportoImballoInArticolo)
    Me.txtImportoUnitarioImballo.Value = GET_IMPORTO_IMBALLO_DA_RIGA_ORDINE(Me.txtIDOrdinePadre.Value, fnNotNullN(rs!RV_POLinkRiga))
    If (ATTIVA_SEL_LOTTO_PROD_IN_LAV = 0) Then
        Me.txtRaggrOrd.Text = fnNotNull(rs!RV_PONotaRigaOrdRaggr)
    Else
        LINK_LOTTO_PROD_LAV = fnNotNullN(rs!RV_POIDLottoCampagnaLavorazione)
        Me.txtRaggrOrd.Text = GET_DESCRIZIONE_LOTTO_PROD_LAV(LINK_LOTTO_PROD_LAV)
    End If
    
    
    If (Me.CDTipoPedana.KeyFieldID = 0) Then
        Me.CDTipoPedana.Load fnNotNullN(rs!RV_POIDTipoPedana)
        Me.txtPesoPedana.Value = GET_PESO_PEDANA(Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID)
    End If
    
    Me.cboCalibro.WriteOn fnNotNullN(rs!RV_POIDCalibro)
    Me.cboTipoCategoria.WriteOn fnNotNullN(rs!RV_POIDTipoCategoria)
    
    If AGGIORNA_TIPO_LAVORAZIONE = 1 Then
        If Me.cboTipoLavConf.CurrentID > 0 Then
            Me.CboTipoLavorazione.WriteOn Me.cboTipoLavConf.CurrentID
        End If
        
    Else
        Me.CboTipoLavorazione.WriteOn fnGetTipoLavorazione
    End If
    
    If fnNotNullN(rs!RV_POIDTipoLavorazione) > 0 Then Me.CboTipoLavorazione.WriteOn fnNotNullN(rs!RV_POIDTipoLavorazione)
    
    GET_ETICHETTE_DA_RIGA_ORD Me.txtIDRigaOrdine.Value

End If

rs.CloseResultset
Set rs = Nothing

Exit Sub
ERR_txtIDRigaOrdine_Change:
    MsgBox Err.Description, vbCritical, "txtIDRigaOrdine_Change"
End Sub

Private Sub txtImballo_LostFocus()
On Error GoTo ERR_txtImballo_LostFocus
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
Dim I As Long
    
 If Me.CDCodiceImballo.Code = "" Then
    If Me.txtImballo.Text <> "" Then
        sSQL = "SELECT IDArticolo, Articolo, CodiceArticolo "
        sSQL = sSQL & "FROM Articolo "
        sSQL = sSQL & "WHERE ((IDTipoProdotto = " & Link_TipoImballo & ") "
        sSQL = sSQL & "AND (IDAzienda=" & m_App.IDFirm & ") "
        sSQL = sSQL & "AND (Articolo LIKE " & fnNormString(Me.txtImballo.Text & "%") & "))"
    
        Set rs = Cn.OpenResultset(sSQL, adOpenKeyset)
    
        I = 0
        If rs.EOF = False Then
        
            While Not rs.EOF
                I = I + 1
                If I > 1 Then
                    rs.MoveLast
                End If
            rs.MoveNext
            Wend
        End If
    
        If I = 1 Then
        sSQL = "SELECT IDArticolo, Articolo, CodiceArticolo "
        sSQL = sSQL & "FROM Articolo "
        sSQL = sSQL & "WHERE ((IDTipoProdotto = " & Link_TipoImballo & ") "
        sSQL = sSQL & "AND (IDAzienda=" & m_App.IDFirm & ") "
        sSQL = sSQL & "AND (Articolo LIKE " & fnNormString(Me.txtImballo.Text & "%") & "))"

            Set rs = Cn.OpenResultset(sSQL)
                Me.CDCodiceImballo.Load rs!IDArticolo
                Me.CDCodiceImballo.Code = rs!CodiceArticolo
                Me.txtImballo.Text = rs!Articolo
                Me.txtTaraUnitaria.Value = fnGetTaraImballo
                
            rs.CloseResultset
            Set rs = Nothing
            
            Me.txtDataLavorazione.SetFocus
        End If
        If I = 0 Then
            MsgBox "Non sono stati trovati i dati per i filtri impostati", vbInformation, "Articolo"
        End If
        If I > 1 Then
            rs.CloseResultset
            Set rs = Nothing
        
            lblImballo_Click
            
        End If
        
    End If
End If
Exit Sub
ERR_txtImballo_LostFocus:
    MsgBox Err.Description, vbCritical, "txtImballo_LostFocus"
    
End Sub



Private Sub txtImballo_Q_LostFocus()
    lblImballo_Q_Click
End Sub

Private Sub txtNumeroConfImballo_LostFocus()
    txtColli_LostFocus
End Sub

Private Sub txtNumeroDocumento_Change()
    If Not (BrwMain.Visible) Then Change
End Sub

Private Sub txtNumeroOrdine_LostFocus()
If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
    If Me.txtIDOrdineCliente.Value = 0 Then
        If Me.txtNumeroOrdine.Value > 0 Then
            If FORZA_LINK_ORDINE = False Then
                AVVIO_RICERCA_ORDINE = True
                cmdSelezionaOrdine_Click
                AVVIO_RICERCA_ORDINE = False
            End If

        End If
    End If
End If
End Sub

Private Sub txtOraLav_DblClick()
    frmOraArrivoMerce.Show vbModal
End Sub

Private Sub txtOraLav_Q_DblClick()
    frmOraArrivoMerceQ.Show vbModal
End Sub

Private Sub txtPesoLordo_Change()
    If Link_UnitaDiMisura_Coop = 2 Then
        Me.txtQta_UM.Value = Me.txtPesoLordo.Value
    End If
End Sub

Private Sub txtPesoLordo_LostFocus()
    CalcoloPesoNetto

    If Link_UnitaDiMisura_Coop = 2 Then
        Me.txtQta_UM.Value = Me.txtPesoLordo.Value
    End If
End Sub
Private Sub txtPesoNetto_Change()
    If Link_UnitaDiMisura_Coop = 3 Then
        Me.txtQta_UM.Value = Me.txtPesoNetto.Value
    End If
End Sub
Private Sub txtPesoNetto_LostFocus()
    Me.txtPesoLordo.Value = Me.txtPesoNetto.Value + Me.txtTara.Value
    
    CalcoloPesoNetto
    
    If Link_UnitaDiMisura_Coop = 3 Then
        Me.txtQta_UM.Value = Me.txtPesoNetto.Value
    End If
End Sub

Private Sub txtPezzi_Change()
    If Link_UnitaDiMisura_Coop = 5 Then
        Me.txtQta_UM.Value = Me.txtPezzi.Value
    End If
    
End Sub

Private Function fnGetTipoOggetto(Optional Gestore As String) As Long
    Dim sSQL As String
    Dim rs As DmtOleDbLib.adoResultset
    
    sSQL = "SELECT TipoOggetto.IDTipoOggetto "
    sSQL = sSQL & "FROM TipoOggetto INNER JOIN "
    sSQL = sSQL & "Gestore ON TipoOggetto.IDGestore = Gestore.IDGestore "
    If Gestore = "" Then
        sSQL = sSQL & "WHERE Gestore.Gestore=" & fnNormString(App.EXEName)
    Else
        sSQL = sSQL & "WHERE Gestore.Gestore=" & fnNormString(Gestore)
    End If
    
    Set rs = Cn.OpenResultset(sSQL)
    If rs.EOF = False Then
        fnGetTipoOggetto = fnNotNullN(rs!IDTipoOggetto)
    Else
        fnGetTipoOggetto = 0
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End Function
Private Function fnGetUMCoop(Link_UMAcq As Long) As Long
    Dim sSQL As String
    Dim rs As DmtOleDbLib.adoResultset
    
    sSQL = "SELECT RV_POIDUnitaDiMisuraCoop FROM UnitaDiMisura WHERE "
    sSQL = sSQL & "IDUnitaDiMisura = " & Link_UMAcq
    
    Set rs = Cn.OpenResultset(sSQL)
    If rs.EOF = False Then
        fnGetUMCoop = fnNotNullN(rs!RV_POIDUnitaDiMisuraCoop)
    Else
        fnGetUMCoop = 0
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End Function

Private Function fnGetCodiceLotto(TipoLotto As Integer, TipoStringaLotto As Integer, StringaLotto As String, Link_LottoArticolo As Long) As String
On Error GoTo ERR_fnGetCodiceLotto
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
Dim Codice As String
Dim I As Integer
Dim PosizioneCodice As Integer
Dim Stringa As String
Dim StringaElaborata As String
Dim SenzaIndentificativo As Boolean

sSQL = "SELECT RV_POLottoCostruzioneRighe.IDRV_POLottoComp, RV_POLottoCostruzioneRighe.Posizione, RV_POLottoCostruzioneRighe.Lunghezza, "
sSQL = sSQL & "RV_POLottoCostruzioneRighe.Testo, RV_POLottoCostruzioneTesta.PosVendita, RV_POLottoCostruzioneTesta.PosConferimento, "
sSQL = sSQL & "RV_POLottoCostruzioneRighe.SXDX, RV_POLottoCostruzioneTesta.SenzaCodiceRiferimento_Vend "
sSQL = sSQL & "FROM RV_POLottoCostruzioneRighe INNER JOIN "
sSQL = sSQL & "RV_POLottoCostruzioneTesta ON "
sSQL = sSQL & "RV_POLottoCostruzioneRighe.IDRV_POLottoCostruzioneTesta = RV_POLottoCostruzioneTesta.IDRV_POLottoCostruzioneTesta "
sSQL = sSQL & "WHERE RV_POLottoCostruzioneTesta.IDFiliale=" & TheApp.Branch
sSQL = sSQL & " AND RV_POLottoCostruzioneRighe.TipoLotto=" & TipoLotto
sSQL = sSQL & " AND RV_POLottoCostruzioneRighe.TipoStringaLotto=" & TipoStringaLotto
sSQL = sSQL & " ORDER BY Posizione"


fnGetCodiceLotto = ""
StringaElaborata = ""
Codice = ""
PosizioneCodice = 0
SenzaIndentificativo = False

Set rs = Cn.OpenResultset(sSQL)


If Link_LottoArticolo > 0 Then
    For I = Len(CStr(Link_LottoArticolo)) To 7
        Codice = Codice & "0"
    Next
    
    Codice = Codice & Link_LottoArticolo & CODICE_WEB_AZIENDA
End If

If rs.EOF Then
    StringaElaborata = ""
Else
    PosizioneCodice = fnNotNullN(rs!PosVendita)
    SenzaIndentificativo = fnNotNullN(rs!SenzaCodiceRiferimento_Vend)
    fnGetCodiceLotto = StringaLotto
    While Not rs.EOF
        Select Case fnNotNullN(rs!IDRV_POLottoComp)
            Case 1 'Codice socio
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(Me.txtCodiceSocio.Text), 0, fnNotNullN(rs!SXDX))
            Case 2 'Ragione sociale
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(Me.txtSocio.Text), 1, fnNotNullN(rs!SXDX))
            Case 3 'Ragione sociale
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(Me.txtNomeSocio.Text), 1, fnNotNullN(rs!SXDX))
            Case 4 'Giorno conferimento
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), DatePart("d", fnNotNull(m_Document("DataDocumento"))), 0, fnNotNullN(rs!SXDX))
            Case 5 'Mese del conferimento
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), DatePart("m", fnNotNull(m_Document("DataDocumento"))), 0, fnNotNullN(rs!SXDX))
            Case 6 'Anno del conferimento
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), DatePart("yyyy", fnNotNull(m_Document("DataDocumento"))), 0, fnNotNullN(rs!SXDX))
            Case 7 'Giorno lavorazione
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(DatePart("d", Me.txtDataLavorazione.Text)), 0, fnNotNullN(rs!SXDX))
            Case 8 'Mese lavorazione
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(DatePart("m", Me.txtDataLavorazione.Text)), 0, fnNotNullN(rs!SXDX))
            Case 9 'Anno lavorazione
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(DatePart("yyyy", Me.txtDataLavorazione.Text)), 0, fnNotNullN(rs!SXDX))
            Case 10 'calibro
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(fnNotNull(Me.cboCalibro.Text)), 1, fnNotNullN(rs!SXDX))
            Case 11 'Tipo lavorazione
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(fnNotNull(Me.CboTipoLavorazione.Text)), 1, fnNotNullN(rs!SXDX))
            Case 12 'Tipo categoria
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(fnNotNull(Me.cboTipoCategoria.Text)), 1, fnNotNullN(rs!SXDX))
            Case 13 'Carattere speciale "_"
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr("_"), 1, fnNotNullN(rs!SXDX))
            Case 14 'Carattere speciale "-"
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr("-"), 1, fnNotNullN(rs!SXDX))
            Case 15 'Stringa personalizzata
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(fnNotNull(rs!Testo)), 1, fnNotNullN(rs!SXDX))
            Case 16 'Codice imballo
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(fnNotNull(Me.CDCodiceImballo.Code)), 1, fnNotNullN(rs!SXDX))
            Case 17 'Descrizione imballo
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(fnNotNull(Me.CDCodiceImballo.Description)), 1, fnNotNullN(rs!SXDX))
            Case 18 'Codice pedana
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(fnNotNull(Me.txtCodicePedana.Text)), 1, fnNotNullN(rs!SXDX))
            Case 19 'Codice articolo
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(fnNotNull(Me.CDArticolo.Code)), 1, fnNotNullN(rs!SXDX))
            Case 20 'Descrizione articolo
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(fnNotNull(Me.CDArticolo.Description)), 1, fnNotNullN(rs!SXDX))
            Case 22 'Numero della settimana
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(DatePart("ww", Me.txtDataLavorazione.Text)), 0, fnNotNullN(rs!SXDX))
            Case 23 'giorno dell'anno
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(DatePart("y", Me.txtDataLavorazione.Text)), 0, fnNotNullN(rs!SXDX))
            Case 24 'Lotto di campagna
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(Me.txtCodiceLotto_Conf.Text), 1, fnNotNullN(rs!SXDX))
            Case 25 'Lotto di conferimento
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(m_Document("CodiceLotto")), 1, fnNotNullN(rs!SXDX))
            Case 26 'Numero conferimento
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(Me.txtNumeroDocumento.Value), 1, fnNotNullN(rs!SXDX))
            Case 27 'Codice certificazione del socio
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_SOCIO(fnNotNullN(m_Document("IDAnagrafica")), "CodiceCertificazione")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_SOCIO(LINK_SOCIO_LOTTO_PROD_LAV, "CodiceCertificazione")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 28 'Descrizione certificazione del socio
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_SOCIO(fnNotNullN(m_Document("IDAnagrafica")), "DescrizioneCertificazione")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_SOCIO(LINK_SOCIO_LOTTO_PROD_LAV, "DescrizioneCertificazione")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 29 'Protocollo certificazione del socio
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_SOCIO(fnNotNullN(m_Document("IDAnagrafica")), "ProtocolloCertificazione")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_SOCIO(LINK_SOCIO_LOTTO_PROD_LAV, "ProtocolloCertificazione")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 30 'Codice certificazione del lotto di campagna
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_LOTTO_CAMPAGNA(fnNotNullN(m_Document("IDLottoDiCampagna").Value), "CodiceCertificazione")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_LOTTO_CAMPAGNA(LINK_LOTTO_PROD_LAV, "CodiceCertificazione")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 31 'Descrizione certificazione del lotto di campagna
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_LOTTO_CAMPAGNA(fnNotNullN(m_Document("IDLottoDiCampagna").Value), "DescrizioneCertificazione")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_LOTTO_CAMPAGNA(LINK_LOTTO_PROD_LAV, "DescrizioneCertificazione")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 32 'Protocollo certificazione del lotto di campagna
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_LOTTO_CAMPAGNA(fnNotNullN(m_Document("IDLottoDiCampagna").Value), "ProtocolloCertificazione")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_LOTTO_CAMPAGNA(LINK_LOTTO_PROD_LAV, "ProtocolloCertificazione")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 33 'Giorno della settimana
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(DatePart("w", Me.txtDataLavorazione.Text) - 1), 0, fnNotNullN(rs!SXDX))
            Case 34 'Codice utente
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(Me.txtCodicePostazione.Text), 1, fnNotNullN(rs!SXDX))
            Case 35 'Descrizione del lotto di campagna
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_LOTTO_CAMPAGNA(fnNotNullN(m_Document("IDLottoDiCampagna").Value), "DescrizioneLotto")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_LOTTO_CAMPAGNA(LINK_LOTTO_PROD_LAV, "DescrizioneLotto")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 36 'Codice certificazione della famiglia del prodotto venduto
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO(fnNotNullN(m_Document("IDAnagrafica")), "CodiceCertificazione", Me.CDArticolo.KeyFieldID)), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO(LINK_SOCIO_LOTTO_PROD_LAV, "CodiceCertificazione", Me.CDArticolo.KeyFieldID)), 1, fnNotNullN(rs!SXDX))
                End If
            Case 37 'Descrizione certificazione della famiglia del prodotto venduto
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO(fnNotNullN(m_Document("IDAnagrafica")), "DescrizioneCertificazione", Me.CDArticolo.KeyFieldID)), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO(LINK_SOCIO_LOTTO_PROD_LAV, "DescrizioneCertificazione", Me.CDArticolo.KeyFieldID)), 1, fnNotNullN(rs!SXDX))
                End If
            Case 38 'Protocollo certificazione della famiglia del prodotto venduto
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO(fnNotNullN(m_Document("IDAnagrafica")), "ProtocolloCertificazione", Me.CDArticolo.KeyFieldID)), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO(LINK_SOCIO_LOTTO_PROD_LAV, "ProtocolloCertificazione", Me.CDArticolo.KeyFieldID)), 1, fnNotNullN(rs!SXDX))
                End If
            Case 39 'Annotazioni aggiuntive conferimento
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), fnNotNull(m_Document("AnnotazioniAggiuntive").Value), 1, fnNotNullN(rs!SXDX))
            Case 40 'Annotazioni aggiuntive lavorazione
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), Me.txtNoteAgg.Text, 1, fnNotNullN(rs!SXDX))
            Case 41 'Numero giorno della settimana di conferimento
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), DatePart("w", fnNotNull(m_Document("DataDocumento") - 1)), 0, fnNotNullN(rs!SXDX))
            Case 43 'Varietà dell'articolo conferito
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_VARIETA_ART(fnNotNullN(m_Document("IDArticolo")), "Varieta")), 1, fnNotNullN(rs!SXDX))
            Case 44 'Codice della varietà dell'articolo conferito
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_VARIETA_ART(fnNotNullN(m_Document("IDArticolo")), "CodiceImEx")), 1, fnNotNullN(rs!SXDX))
            Case 45 'Varietà dell'articolo lavorato/venduto
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_VARIETA_ART(Me.CDArticolo.KeyFieldID, "Varieta")), 1, fnNotNullN(rs!SXDX))
            Case 46 'Codice della varietà dell'articolo lavorato/venduto
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_VARIETA_ART(Me.CDArticolo.KeyFieldID, "CodiceImEx")), 1, fnNotNullN(rs!SXDX))
            Case 47 'Famiglia dell'articolo conferito
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_FAMIGLIA_ART(fnNotNullN(m_Document("IDArticolo")), "FamigliaProdotti")), 1, fnNotNullN(rs!SXDX))
            Case 48 'Codice della famiglia dell'articolo conferito
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_FAMIGLIA_ART(fnNotNullN(m_Document("IDArticolo")), "CodiceImEx")), 1, fnNotNullN(rs!SXDX))
            Case 49 'Famiglia dell'articolo lavorato/venduto
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_FAMIGLIA_ART(Me.CDArticolo.KeyFieldID, "FamigliaProdotti")), 1, fnNotNullN(rs!SXDX))
            Case 50 'Codice della famiglia dell'articolo lavorato/venduto
                StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_FAMIGLIA_ART(Me.CDArticolo.KeyFieldID, "CodiceImEx")), 1, fnNotNullN(rs!SXDX))
            Case 51 'Varietà del lotto di produzione
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_LOTTO_CAMPAGNA(fnNotNullN(m_Document("IDLottoDiCampagna").Value), "Varieta")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_LOTTO_CAMPAGNA(LINK_LOTTO_PROD_LAV, "Varieta")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 52 'Codice varietà del lotto di produzione
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_LOTTO_CAMPAGNA(fnNotNullN(m_Document("IDLottoDiCampagna").Value), "CodiceImExVarieta")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_LOTTO_CAMPAGNA(LINK_LOTTO_PROD_LAV, "CodiceImExVarieta")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 53 'Famiglia del lotto di produzione
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_LOTTO_CAMPAGNA(fnNotNullN(m_Document("IDLottoDiCampagna").Value), "FamigliaProdotti")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_LOTTO_CAMPAGNA(LINK_LOTTO_PROD_LAV, "FamigliaProdotti")), 1, fnNotNullN(rs!SXDX))
                End If
            Case 54 'Codice famiglia del lotto di produzione
                If LINK_LOTTO_PROD_LAV = 0 Then
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_LOTTO_CAMPAGNA(fnNotNullN(m_Document("IDLottoDiCampagna").Value), "CodiceImEx")), 1, fnNotNullN(rs!SXDX))
                Else
                    StringaElaborata = StringaElaborata & GET_STRINGALOTTO(fnNotNullN(rs!IDRV_POLottoComp), fnNotNullN(rs!Lunghezza), CStr(GET_CODICE_LOTTO_CAMPAGNA(LINK_LOTTO_PROD_LAV, "CodiceImEx")), 1, fnNotNullN(rs!SXDX))
                End If
        End Select
    rs.MoveNext
    Wend
End If

    
If StringaElaborata = "" Then
    If SenzaIndentificativo = False Then
        If PosizioneCodice = 1 Then
            fnGetCodiceLotto = Mid(Codice, 1, Len(Codice) - 1)
        Else
            fnGetCodiceLotto = Mid(Codice, 2, Len(Codice))
        End If
    Else
        fnGetCodiceLotto = StringaElaborata
    End If
Else
    If SenzaIndentificativo = False Then
        If PosizioneCodice = 1 Then
            fnGetCodiceLotto = Codice & StringaElaborata
        Else
            fnGetCodiceLotto = StringaElaborata & Codice
        End If
    Else
        fnGetCodiceLotto = StringaElaborata
    End If
End If


Exit Function
ERR_fnGetCodiceLotto:
    If StringaElaborata = "" Then
        If SenzaIndentificativo = False Then
            If PosizioneCodice = 1 Then
                fnGetCodiceLotto = Mid(Codice, 1, Len(Codice) - 1)
            Else
                fnGetCodiceLotto = Mid(Codice, 2, Len(Codice))
            End If
        Else
            fnGetCodiceLotto = StringaElaborata
        End If
    Else
        If SenzaIndentificativo = False Then
            If PosizioneCodice = 1 Then
                fnGetCodiceLotto = Codice & StringaElaborata
            Else
                fnGetCodiceLotto = StringaElaborata & Codice
            End If
        Else
            fnGetCodiceLotto = StringaElaborata
        End If
    End If

End Function
Private Function GET_STRINGALOTTO(IDRV_POLottoComp As Long, Lunghezza As Integer, Stringa As String, TipoStringa As Integer, SXDX As Integer, Optional TestoPersonalizzato As String) As String
Dim Parziale As String
Dim I As Integer
Parziale = ""

        If Len(Stringa) >= Lunghezza Then
            If SXDX = 2 Then 'Da destra verso sinistra
                GET_STRINGALOTTO = Right(Stringa, Lunghezza)
            Else
                'Da sinistra verso destra
                GET_STRINGALOTTO = Mid(Stringa, 1, Lunghezza)
            End If
        Else
            If SXDX <= 1 Then 'Da sinistra verso destra
                For I = Len(Stringa) To Lunghezza - 1
                    If TipoStringa = 0 Then
                        Parziale = "0" & Parziale
                    Else
                        Parziale = "" & Parziale
                    End If
                Next
                GET_STRINGALOTTO = Parziale & Stringa
            Else
                'Da destra verso sinistra
                GET_STRINGALOTTO = Right(Stringa, Lunghezza)
            End If
        End If
End Function

Private Function fnGetLottoArticolo() As Long

    
    
End Function
Private Function InserimentoLottoInMagazzino() As Boolean

    
End Function


Public Sub Movimenti(IDTipoProdotto As Long, Quantita As Double, CodiceArticolo As String, Descrizione As String)

     
End Sub



Private Function fnGetIDMovimentoMagazzino() As Long
    Dim sSQL As String
    Dim rs As DmtOleDbLib.adoResultset
    
    sSQL = "SELECT IDMovimento FROM Movimento ORDER BY IDMovimento DESC"
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF = False Then
        fnGetIDMovimentoMagazzino = rs!IDMovimento
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End Function
Public Function fnGetMagazzinoCarico() As Long
   Dim sSQL As String
    Dim rs As DmtOleDbLib.adoResultset
    
    sSQL = "SELECT RV_POSchemaCoop.IDFiliale, RV_POProcessiDocumentoCoop.IDRV_POProcessiDocumentoCoop, "
    sSQL = sSQL & "RV_POProcessiDocumentoCoop.IDRV_POSchemaCoop, RV_POProcessiDocumentoCoop.IDDocumentoCoop,"
    sSQL = sSQL & "RV_POProcessiDocumentoCoop.IDTipoProcessoCoop, RV_POProcessiDocumentoCoop.IDMagazzino,"
    sSQL = sSQL & "RV_POProcessiDocumentoCoop.IDTipoMagazzino , RV_POSchemaCoop.IDUtente "
    sSQL = sSQL & "FROM RV_POSchemaCoop INNER JOIN "
    sSQL = sSQL & "RV_POProcessiDocumentoCoop ON "
    sSQL = sSQL & "RV_POSchemaCoop.IDRV_POSchemaCoop = RV_POProcessiDocumentoCoop.IDRV_POSchemaCoop "
    sSQL = sSQL & "WHERE (RV_POSchemaCoop.IDFiliale = " & m_App.Branch & ") AND "
    sSQL = sSQL & "(RV_POProcessiDocumentoCoop.IDDocumentoCoop = 10) AND (RV_POSchemaCoop.IDUtente = 0) AND "
    sSQL = sSQL & "(RV_POProcessiDocumentoCoop.IDTipoProcessoCoop = 1)"
    
    Set rs = Cn.OpenResultset(sSQL)
    If rs.EOF = False Then
        Select Case rs!IDTipoMagazzino
            Case 1
                Link_Magazzino_Carico = Me.cboMagazzinoConf.CurrentID
                Link_CausaleCarico = Link_Causale_MagCar_Conf
            Case 2
                Link_Magazzino_Carico = Me.CboMagazzinoVend.CurrentID
                Link_CausaleCarico = Link_Causale_MagCar_Vend
                
        End Select
    Else
        Link_Magazzino_Carico = Me.cboMagazzinoConf.CurrentID
        Link_CausaleCarico = Link_Causale_MagCar_Conf
       
    End If
        
    
End Function
Public Function fnGetMagazzinoScarico() As Long
   Dim sSQL As String
    Dim rs As DmtOleDbLib.adoResultset
    
    sSQL = "SELECT RV_POSchemaCoop.IDFiliale, RV_POProcessiDocumentoCoop.IDRV_POProcessiDocumentoCoop, "
    sSQL = sSQL & "RV_POProcessiDocumentoCoop.IDRV_POSchemaCoop, RV_POProcessiDocumentoCoop.IDDocumentoCoop,"
    sSQL = sSQL & "RV_POProcessiDocumentoCoop.IDTipoProcessoCoop, RV_POProcessiDocumentoCoop.IDMagazzino,"
    sSQL = sSQL & "RV_POProcessiDocumentoCoop.IDTipoMagazzino , RV_POSchemaCoop.IDUtente "
    sSQL = sSQL & "FROM RV_POSchemaCoop INNER JOIN "
    sSQL = sSQL & "RV_POProcessiDocumentoCoop ON "
    sSQL = sSQL & "RV_POSchemaCoop.IDRV_POSchemaCoop = RV_POProcessiDocumentoCoop.IDRV_POSchemaCoop "
    sSQL = sSQL & "WHERE (RV_POSchemaCoop.IDFiliale = " & m_App.Branch & ") AND "
    sSQL = sSQL & "(RV_POProcessiDocumentoCoop.IDDocumentoCoop = 10) AND (RV_POSchemaCoop.IDUtente = 0) AND "
    sSQL = sSQL & "(RV_POProcessiDocumentoCoop.IDTipoProcessoCoop = 2)"
    
    Set rs = Cn.OpenResultset(sSQL)
    If rs.EOF = False Then
        Select Case rs!IDTipoMagazzino
            Case 1
                Link_Magazzino_Scarico = Me.cboMagazzinoConf.CurrentID
                Link_CausaleScarico = Link_Causale_MagScar_Conf
            Case 2
                Link_Magazzino_Scarico = Me.CboMagazzinoVend.CurrentID
                Link_CausaleScarico = Link_Causale_MagScar_Vend
                
        End Select
    Else
        Link_Magazzino_Carico = Me.cboMagazzinoConf.CurrentID
        Link_CausaleCarico = Link_Causale_MagCar_Conf
       
    End If
        
    
End Function
Private Sub AggiornamentoMovimenti()
On Error Resume Next
Dim Messagggio As String

Dim Mov As DmtMovim.cMovimentazione
Set Mov = New DmtMovim.cMovimentazione

If m_DocumentsLink("IDMovimento_Vendita").Value > 0 Then
    Set Mov.Connection = TheApp.Database.Connection
    Mov.Read m_DocumentsLink("IDMovimento_Vendita").Value
    
    
    Mov.IDEsercizio = Link_Esercizio
    'Mov.IDOggetto = Link_Oggetto
    Mov.IDTipoOggetto = fnGetTipoOggetto
    
    Mov.Field "QuantitaTotale", m_DocumentsLink("Qta_UM").Value
    
    Mov.Insert
    
    
   
End If

    

If m_DocumentsLink("IDMovimento_Carico").Value > 0 Then
    Set Mov.Connection = TheApp.Database.Connection
    Mov.Read m_DocumentsLink("IDMovimento_Carico").Value

    Mov.IDEsercizio = Link_Esercizio
    'Mov.IDOggetto = Link_Oggetto
    Mov.IDTipoOggetto = fnGetTipoOggetto
    
    Mov.Field "QuantitaTotale", m_DocumentsLink("Qta_UM").Value
    
    Mov.Insert
    
    
End If



End Sub
Private Sub AggiornamentoMovimentiQuadratura()
Dim Messagggio As String

Dim Mov As DmtMovim.cMovimentazione
Set Mov = New DmtMovim.cMovimentazione

If m_DocumentsLink1("IDMovimento_Carico").Value > 0 Then
    Set Mov.Connection = TheApp.Database.Connection
    Mov.Read m_DocumentsLink1("IDMovimento_Carico").Value
    
    
    Mov.IDEsercizio = Link_Esercizio
    'Mov.IDOggetto = Link_Oggetto
    Mov.IDTipoOggetto = fnGetTipoOggetto
    
    Mov.Field "QuantitaTotale", m_DocumentsLink1("QtaCausale").Value
    
    Mov.Insert
    
    
   
End If

End Sub

Private Function ControlloAltraMovimentazioneRiga() As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

    If Link_LottoArticolo > 0 Then
        sSQL = "SELECT * FROM Movimento WHERE ("
        sSQL = sSQL & "(IDTipoOggetto<>" & fnGetTipoOggetto & ") "
        sSQL = sSQL & "AND (IDTipoOggetto<10000) "
        sSQL = sSQL & "AND (IDTipoOggetto<>4) "
        sSQL = sSQL & "AND (IDLottoArticolo=" & Link_LottoArticolo & "))"
    
        Set rs = Cn.OpenResultset(sSQL)

        If rs.EOF = False Then
            ControlloAltraMovimentazioneRiga = True
        Else
            ControlloAltraMovimentazioneRiga = False
        End If

        rs.CloseResultset
        Set rs = Nothing
    Else
        ControlloAltraMovimentazioneRiga = False
    End If
End Function
Private Function fnGetTaraImballo() As Double
    Dim sSQL As String
    Dim rs As DmtOleDbLib.adoResultset
    
    sSQL = "SELECT Tara FROM Articolo WHERE "
    sSQL = sSQL & "IDArticolo = " & Me.CDCodiceImballo.KeyFieldID
    
    Set rs = Cn.OpenResultset(sSQL)
    If rs.EOF = False Then
        If IsNull(rs!Tara) Then
            fnGetTaraImballo = 0
        Else
            fnGetTaraImballo = rs!Tara
        End If
        
    Else
        
            fnGetTaraImballo = 0
        
    End If
    
    rs.CloseResultset
    Set rs = Nothing

End Function
Private Function fnGetTaraImballo_Q() As Double
    Dim sSQL As String
    Dim rs As DmtOleDbLib.adoResultset
    
    sSQL = "SELECT Tara FROM Articolo WHERE "
    sSQL = sSQL & "IDArticolo = " & Me.CDCodiceImballo_Q.KeyFieldID
    
    Set rs = Cn.OpenResultset(sSQL)
    If rs.EOF = False Then
        If IsNull(rs!Tara) Then
            fnGetTaraImballo_Q = 0
        Else
            fnGetTaraImballo_Q = fnNotNullN(rs!Tara)
        End If
        
    Else
        
        fnGetTaraImballo_Q = 0
        
    End If
    
    rs.CloseResultset
    Set rs = Nothing

End Function
Private Sub CalcoloPesoNetto()
On Error Resume Next
Dim ArrayPesoNetto() As String
Dim PesoNetto As Double
Dim Decimal_PesoNetto As Double
Dim Tara As Double

'Me.txtTara.Value = Me.txtTaraUnitaria.Value * Me.txtColli.Value
Me.txtTara.Value = Me.txtColli.Value * (Me.txtTaraUnitaria.Value + (Me.txtNumeroConfImballo.Value * Me.txtTaraConfImballo.Value))

If TIPO_PESO_ARTICOLO <= 1 Then
    Me.txtPesoNetto.Value = Me.txtPesoLordo.Value - Me.txtTara.Value
Else
    If PESO_LORDO_ARTICOLO = 0 Then
        Me.txtPesoNetto.Value = Me.txtPesoLordo.Value - Me.txtTara.Value
    Else
        Me.txtPesoLordo.Value = Me.txtTara.Value + Me.txtPesoNetto.Value
    End If
        
End If

Select Case Link_Arrontondamento
    Case 1 'Nessun arrotondamento
        Me.txtPesoNetto.Value = Me.txtPesoLordo.Value - Me.txtTara.Value
    Case 2 'Matematico
        Me.txtPesoNetto.Value = fnRoundChange(Me.txtPesoNetto.Value, 1, 3)
        Me.txtTara.Value = Me.txtPesoLordo.Value - Me.txtPesoNetto.Value
    Case 3 'Difetto
        Me.txtPesoNetto.Value = fnRoundDown(Me.txtPesoNetto.Value)
        Me.txtTara.Value = Me.txtPesoLordo.Value - Me.txtPesoNetto.Value
    Case 4 'Eccesso
        Me.txtPesoNetto.Value = fnRoundUp(Me.txtPesoNetto.Value)
        Me.txtTara.Value = Me.txtPesoLordo.Value - Me.txtPesoNetto.Value
End Select
    
    
'Me.txtTaraUnitaria.Value = Me.txtTara.Value / Me.txtColli.Value

GET_RIEPILOGO_PESI

End Sub

Private Sub txtPezzi_LostFocus()
    GET_RIEPILOGO_PESI
End Sub

Private Sub txtQtaPrelievoQ_LostFocus()
    If (Me.txtQtaPrelievoQ.Value > 0) Then
        CalcoloScartoPrelievo
    Else
        CalcoloScarto
    End If
    
    GET_PERC_RESO
End Sub
Private Sub txtRaggrOrd_DblClick()
On Error GoTo ERR_txtRaggrOrd_DblClick
    If (ATTIVA_SEL_LOTTO_PROD_IN_LAV = 1) Then
        frmSelezionaLottoDiCampagna.Show vbModal
    End If
Exit Sub
ERR_txtRaggrOrd_DblClick:
    MsgBox Err.Description, vbCritical, "txtRaggrOrd_DblClick"
End Sub

Private Sub txtRaggrOrd_KeyDown(KeyCode As Integer, Shift As Integer)
On Error GoTo ERR_txtRaggrOrd_KeyDown
Dim Testo As String
    If ((KeyCode = vbKeyDelete) Or (KeyCode = vbKeyBack)) Then
        If ((ATTIVA_SEL_LOTTO_PROD_IN_LAV = 1)) Then
            Testo = "ATTENZIONE!!!" & vbCrLf
            Testo = Testo & "Sei sicuro di voler eliminare il riferimento del sublotto?"
            If MsgBox(Testo, vbQuestion + vbYesNo, "Validazione dati") = vbNo Then Exit Sub
            LINK_LOTTO_PROD_LAV = 0
            Me.txtRaggrOrd.Text = GET_DESCRIZIONE_LOTTO_PROD_LAV(LINK_LOTTO_PROD_LAV)
        End If
    End If
Exit Sub
ERR_txtRaggrOrd_KeyDown:
    MsgBox Err.Description, vbCritical, "txtRaggrOrd_KeyDown"
End Sub

Private Sub txtTara_LostFocus()
    If Link_UnitaDiMisura_Coop = 4 Then
        Me.txtQta_UM.Value = Me.txtTara.Value
    End If
    CalcoloPesoNetto
End Sub
Private Function ControlloRigheMovimentate() As Boolean
'RESTITUISCE TRUE SE NON SONO STATE MOVIMENTATE LE RIGHE DA ALTRI GESTORI
'ALTRIMENTI RESTITUISCE FALSE

Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDCodiceLotto FROM RV_POCaricoMerceRighe "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceTesta=" & m_Document("IDRV_POCaricoMerceTesta").Value

Set rs = Cn.OpenResultset(sSQL, adOpenKeyset)

If rs.EOF = True Then
    ControlloRigheMovimentate = True

Else
    While Not rs.EOF
        If IsNull(rs!IDCodiceLotto) Then
            ControlloRigheMovimentate = True
        Else
            If ControlloAltraMovimentazioneRigaPerEliminazione(rs!IDCodiceLotto) = True Then
                ControlloRigheMovimentate = True
            Else
                ControlloRigheMovimentate = False
                rs.MoveLast
            End If
        End If
    rs.MoveNext
    Wend
End If

rs.CloseResultset
Set rs = Nothing

ControlloRigheMovimentate = ControlloRigheMovimentate


End Function
Private Function ControlloAltraMovimentazioneRigaPerEliminazione(IDLottoArticolo) As Boolean
'RESTITUSCE TRUE SE NON E STATA SE IL RECORDSET E' VUOTO

Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
    sSQL = "SELECT * FROM Movimento WHERE ("
    sSQL = sSQL & "(IDTipoOggetto<>" & fnGetTipoOggetto & ") "
    sSQL = sSQL & "AND (IDLottoArticolo=" & IDLottoArticolo & "))"

    Set rs = Cn.OpenResultset(sSQL)
    If rs.EOF = True Then
        ControlloAltraMovimentazioneRigaPerEliminazione = True
    Else
        ControlloAltraMovimentazioneRigaPerEliminazione = False
    End If
    rs.CloseResultset
    Set rs = Nothing

End Function

Private Sub EliminaRigheDaDocumento()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT * FROM RV_POCaricoMerceRighe "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceTesta=" & m_Document("IDRV_POCaricoMerceTesta").Value

Set rs = Cn.OpenResultset(sSQL)
While Not rs.EOF
    If rs!IDMovimento_Carico > 0 Then
        EliminaMovimento rs!IDMovimento_Carico
    End If
    If rs!IDMovimento_Vendita > 0 Then
        EliminaMovimento rs!IDMovimento_Vendita
    End If
    If rs!IDCodiceLotto > 0 Then
        EliminaLotto rs!IDCodiceLotto
    End If
        
    
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing


End Sub
Private Function EliminaMovimento(IDRiga As Long, Optional Gestore As String) As Boolean
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
Dim IDMovimento_Local As Long

EliminaMovimento = True

sSQL = "SELECT IDMovimento FROM Movimento "

sSQL = sSQL & "WHERE IDValoriOggettoDettaglio=" & IDRiga
sSQL = sSQL & " AND IDTipoOggetto=" & m_DocType.ID

Set rs = Cn.OpenResultset(sSQL, adOpenKeyset)

Set Mov = New DmtMovim.cMovimentazione

Set Mov.Connection = TheApp.Database.Connection

While Not rs.EOF
    Cn.BeginTrans
    EliminaMovimento = Mov.Delete(fnNotNullN(rs!IDMovimento))
    
    If EliminaMovimento = False Then
        Cn.RollbackTrans
        MsgBox "Impossibile eliminare il movimento (IDMovimento: " & fnNotNullN(rs!IDMovimento) & ")", vbCritical, "Eliminazione movimento di carico"
        EliminaMovimento = False
        rs.MoveLast
    End If
    Cn.CommitTrans
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing

Set Mov = Nothing


End Function
Private Sub EliminaLotto(IDLottoArticolo As Long)
On Error GoTo ERR_EliminaLotto
Dim Errore As String
Dim sSQL As String

Errore = "Eliminazione lotto articolo"
sSQL = "DELETE FROM LottoArticolo WHERE IDLottoArticolo=" & IDLottoArticolo
Cn.Execute sSQL

Errore = "Eliminazione lotto articolo per magazzino"
sSQL = "DELETE FROM LottoArticoloPerMagazzino WHERE IDLottoArticolo=" & IDLottoArticolo
Cn.Execute sSQL

Errore = "Eliminazione del collegamento"
sSQL = "DELETE FROM RV_POCollegamento WHERE IDLottoArticolo=" & IDLottoArticolo
Cn.Execute sSQL
Exit Sub
ERR_EliminaLotto:
    MsgBox Err.Description, vbCritical, Errore
End Sub
Private Function ControlloQuantitaDiCarico()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset


sSQL = "SELECT * FROM Movimento WHERE IDMovimento=" & m_DocumentsLink("IDMovimento_Vendita").Value
Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    If rs!IDTipoOggetto <> fnGetTipoOggetto Then
        If rs!QuantitaTotale <> m_DocumentsLink("Qta_UM").Value Then
        'NumeroRiga = m_DocumentsLink("IDRV_POCaricoMerceRighe").Value
            Me.txtQta_UM.Value = rs!QuantitaTotale
            m_DocumentsLink("Qta_UM").Value = rs!QuantitaTotale
        
            Select Case Link_UnitaDiMisura_Coop
            Case 1
                Me.txtColli.Value = Me.txtQta_UM.Value
            Case 2
                Me.txtPesoLordo.Value = Me.txtQta_UM.Value
            Case 3
                Me.txtPesoNetto.Value = Me.txtQta_UM.Value
            Case 4
                Me.txtTara.Value = Me.txtQta_UM.Value
            Case 5
                Me.txtPezzi.Value = Me.txtQta_UM.Value
            End Select
            cmdSalva_Click
        
        End If
    End If
End If

rs.CloseResultset
Set rs = Nothing
End Function

Private Sub Start()
    Dim OLDCursor As Integer
    Dim ToolID As Integer
    Dim Field As DmtDocManLib.Field
    Dim oActivity As IActivity
    Dim o As Activity
    Dim oFilter As Filter

        
    
    'Apertura del documento
    If Len(m_ExtendedDatabase) > 0 Then
        'Apre un nuovo documento usando il database esteso
        Set m_Document = m_App.OpenDocument(m_DocType, m_ExtendedDatabase)
    Else
        'Apre un nuovo documento usando il database diamante
        Set m_Document = m_App.OpenDocument(m_DocType)
    End If
    
    
    'NOTA: Con la sottostante proprietà settata a TRUE i metodi OnXXXDocumentsLink()
    'non sono più necessari in quanto il modello ad oggetti si occupa della gestione
    'dei sottodocumenti.
    '
    'Abilita la gestione automatica degli eventuali DocumentsLink
    m_Document.EnableRefreshDocumentsLinks = True
    
    'Clessidra
    OLDCursor = Screen.MousePointer
    Screen.MousePointer = vbHourglass
    
    Caption = m_App.Caption
    
    'Inizializzazione del controllo ActiveBar
    InitMenuBar ToolID
    InitToolBar ToolID
    ActivateBarButtons BTN_ALL, True
    
    'Inizializzazione del riquadro attività
    With ActivityBox
        .Activities.Clear
        
        'Aggiunge l'attività dei reports
        Set oActivity = .Activities.Add("DmtActBoxLib.ReportsActivity", "Reports")
        Set oActivity.Connection = TheApp.Database.InternalConnection
        oActivity.Load m_DocType.ID, TheApp.IDFirm
        Set o = oActivity
        Set oReportsActivity = o.InternalClass
        
        'Aggiunge l'attività dei filtri
        Set oActivity = .Activities.Add("DmtActBoxLib.FiltersActivity", "Filters")
        Set oActivity.Connection = TheApp.Database.InternalConnection
        oActivity.Load m_DocType
        Set o = oActivity
        Set oFiltersActivity = o.InternalClass
        
        'Aggiunge l'attività delle viste tabellari
        Set oActivity = .Activities.Add("DmtActBoxLib.TableViewsActivity", "TableViews")
        Set oActivity.Connection = TheApp.Database.InternalConnection
        oActivity.Load m_DocType.ID
        Set o = oActivity
        Set oTableViewsActivity = o.InternalClass

        'Aggiunge l'attività delle esportazioni
        Set oActivity = .Activities.Add("DmtActBoxLib.ExportActivity", "Export")
        Set oActivity.Connection = TheApp.Database.InternalConnection
        oActivity.Load m_DocType.ID
        Set o = oActivity
        Set oExportActivity = o.InternalClass
        
        'Aggiunge l'attività del supporto tecnico
        Set oActivity = .Activities.Add("DmtActBoxLib.SupportActivity", "Support")
        Set oActivity.Connection = TheApp.Database.InternalConnection
        oActivity.Load
        Set o = oActivity
        Set oSupportActivity = o.InternalClass
        
        'attiva/disattiva la visualizzazione delle attività
        EnableDOMActivitiesItems
        
        'imposta quale attività deve essere attivata per default
        If m_DefaultActivity <> "" Then
            Set .CurrentActivity = .Activities(m_DefaultActivity)
        End If
        
        'ridisegna il controllo
        .Redraw = True
    End With


    'Lettura impostazioni dal registry
    ReadRegistrySettings
        
    'Aggiunge due filtri temporanei, uno per le ricerche temporanee
    'e uno per la stampa in modalità form
    m_DocType.AddFilter "Temp"
    m_DocType.AddFilter "Form"
    
    
    'Connessione di tipo dmtdatalayer
        'ConnessioneDiamanteOLD
    'Connessione di tipo DMTADODBLib
        ConnessioneDiamanteADO
        
        ParametroSocio
        ParametroImballo
        ParametroGrezzo
        ParametroLavorato
        RecuperaOperazioniDocumento
        ParametroTipoCaloPeso
        ParametroTipoAumentoPeso
        ParametroTipoScarto
        ParametroTipoQuadratura
        GET_CLIENTE_ORDINE_PRED
        NOME_COMPUTER = GET_NOMECOMPUTER
        fnDefaultReport
        fnDefaultReportPedana
        ParametroNuovoCalcolo
        ParametroComportamentoLavorazione
        ParametroPesoArticolo
        fnGetParametriMagazzino
        ParametroPedanaAutomatica
        ParametroOrdineAutomatico
        ParametroPrezzoMedioAutomatico
        ParametroAggiornaPrezzoMedioDaConf
        ParametroAggiornaTipoLavorazioneDaConf
        ParametroGestioneOrdineVivaio
        ParametroAttivaImportoRiepConf
        ParametroStampeEtichettePDF
        
        
        GET_INFO_AZIENDA TheApp.IDFirm
        GET_INFO_FILIALE TheApp.IDFirm
        GET_INFO_CERTIFICAZIONE_AZIENDA TheApp.IDFirm
        LAVORAZIONE_AUTOMATICA = 0
        ParametroAndamentoOrdine
        GET_PREZZI_DA_ORDINE
        LINK_LISTINO_AZIENDA = GET_LINK_LISTINO_AZIENDA
        LINK_LISTINO_IMBALLI_AZIENDA = GET_LISTINO_DEFAULT_PARAMETRI_AZIENDA
        EtichetteProPerUtenteDMTPed
        EtichetteProPerUtenteDMTLav
        Link_Tipo_Passaporto_Azienda = GET_LINK_TIPO_PASSAPORTO_AZIENDA("IDRV_PO01_TipoPassaporto")
        Link_Sezionale_Dettagliato = GET_LINK_SEZIONALE_PROT_DETT("IDSezionaleProtDett")
        Link_Periodo_IVA_Protocollo = GET_PERIODO_IVA_PROTOCOLLO(Date)
        CODICE_WEB_AZIENDA = GET_CODICE_TRACCIABILITA_WEB(TheApp.Branch)
        GET_TIPO_LIQUIDAZIONE_PER_CONFERIMENTO TheApp.Branch
        ParametroMessaggioConferimentoNegativo
        GET_MODULO_ATTIVATO MODULO_CODICE, 80
        LINK_LOTTO_IMBALLO_PRED = GET_LINK_LOTTO_IMBALLO_PRED(TheApp.IDFirm)
        BLOCCO_QTA_LAV = GET_BLOCCO_QTA_LAVORATA(TheApp.IDUser)
    'Inizializzazioni da fare prima dell'apertura del documento
        OnBeforeOpenDoc
        
        
    'rif12
    'Altre inizializzazioni
        OnStart
    
        
    
    If Len(m_App.Caller) > 0 And m_App.CallerFieldValue > 0 Then
        '-------------------------------------------------
        '     Il programma è stato chiamato da un link.
        '-------------------------------------------------
        
        'In tal caso occorre mostrare in modalità variazione il record richiesto dal programma client.
        
        'Ripulisce la collezione Fields dell'oggetto DocType.
        For Each Field In m_DocType.Fields
            Field.Value = Empty
        Next
                
        'Imposta una condizione di ricerca basata sull'ID del record richiesto dal programma client.
        m_DocType.Fields("ID" & m_App.TableName).Value = m_App.CallerFieldValue   '1880
        
        'Rimuove il filtro precedente
        m_DocType.RemoveFilter "Temp"
        
        'Crea un nuovo filtro temporaneo a partire dalle condizioni di ricerca
        'e viene reso filtro attivo
        Set m_ActiveFilter = m_DocType.AddFilterWithConditions("Temp")
        
        'Inidica, nel caso di esegui gestione, se riportare il valore corrente al chiamante
        bNotReturnValue = CBool(Val(GetSetting(REGISTRY_KEY, App.EXEName, "NoReturnValue", "0")))
        LAVORAZIONE_AUTOMATICA = Val(GetSetting(REGISTRY_KEY, App.EXEName, "LavorazioneAutomatica"))
        LINK_PROCESSO_RIGHE_PROD = Val(GetSetting(REGISTRY_KEY, App.EXEName, "IDProcessoRiga"))
        LINK_PROCESSO_PROD = Val(GetSetting(REGISTRY_KEY, App.EXEName, "IDProcesso"))
        LINK_LINEA_PROD = Val(GetSetting(REGISTRY_KEY, App.EXEName, "IDLineaProduzione"))
        
        LINK_LAVORAZIONE_DA_MOV = Val(GetSetting(REGISTRY_KEY, App.EXEName, "IDLavorazione"))  '12665
        TIPO_LAVORAZIONE_DA_MOV = Val(GetSetting(REGISTRY_KEY, App.EXEName, "Tipo")) '12665
        Set m_Document.ActiveFilter = m_ActiveFilter
        
    Else
        '---------------------------------------------------
        '     Il programma non è stato chiamato da un link.
        '---------------------------------------------------
   '
        'Il filtro attivo alla partenza è quello predefinito
        For Each oFilter In m_DocType.Filters
            If oFilter.ID = oFiltersActivity.DefaultFilterID Then
                Set m_ActiveFilter = m_DocType.Filters(oFilter.Name)
                Exit For
            End If
        Next '

        'Si comunica al documento quale filtro eseguire all'avvio.
        Set m_Document.ActiveFilter = m_ActiveFilter
        Set BrwMain.Recordset = m_Document.data
        m_Document.Dataset.Recordset.Sort = "DataDocumento DESC, OraArrivoMerce ASC"
        Set Me.BrwMain.Recordset = m_Document.Dataset.Recordset
    End If
    
        
    'Prima di aprire il documento occorre comunicargli qual'è il campo chiave primaria.
    m_Document.PrimaryKey = "ID" & m_Document.TableName
    'Apertura del documento.
    AggiornamentoDocumento = 1
    m_Document.OpenDoc
    AggiornamentoDocumento = 0
    
    
    
    'Questa impostazione serve per conservare le impostazioni grafiche
    BrwMain.IDUser = m_App.IDUser
    'Permette di gestire l'evento BrwMain_OnApplyFilter
    BrwMain.AutoFiltering = False
    'Con questa impostazione la dmtGrid NON effettua mai il Move sul documento.
    'Questo pertanto andrà forzato in BrwMain_DblClick e BrwMain_KeyDown.
    BrwMain.EnableMove = False
    'Inizializza le colonne da visualizzare nella griglia
    If m_DocType.DefaultTableView Is Nothing Then
        Err.Raise ERR_NO_DEFAULT_TABLEVIEW, , "Default TableView not found"
    Else
        BrwMain.LoadColumns m_DocType.DefaultTableView
        BrwMain.LoadUserSettings
        SetVisibilityIDFields
    End If
    
    'Crea i campi per la ricerca.
    CreateBrowserConditions
    'Assegnazione del riferimento alla fonte dati (binding sul recordset del documento)
    
    'rif14
    
    'Set BrwMain.Recordset = m_Document.Dataset.Recordset
    Set BrwMain.Recordset = m_Document.data
            
    'Viene inizializzato il dialogo di stampa
    With DmtPrnDlg
        Set .Application = m_App
        Set .DocType = m_DocType
    End With

    'Ripulisco la tabella semaforo.
    'Se era avvenuto un crash di sistema questo garantisce il ripristino della situazione.
    m_Semaphore.ClearObjectAction m_DocType.ID, SemAllObjects, SemAllActions
    
    'Evita il blocco della toolbar
    'BarMenu.ResetHooks
    
    Screen.MousePointer = OLDCursor
    
    If LINK_LAVORAZIONE_DA_MOV > 0 Then
        If TIPO_LAVORAZIONE_DA_MOV = 1 Then
            m_DocumentsLink_OnReposition
        End If
        If TIPO_LAVORAZIONE_DA_MOV = 2 Then
            m_DocumentsLink1_OnReposition
        End If
        
        SSTab1.Tab = TIPO_LAVORAZIONE_DA_MOV - 1
        m_Changed = False
    End If

End Sub
Private Function GET_TIPO_PRODOTTO_ARTICOLO(IDArticolo As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoProdotto FROM Articolo WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TIPO_PRODOTTO_ARTICOLO = 0
Else
    GET_TIPO_PRODOTTO_ARTICOLO = fnNotNullN(rs!IDTipoProdotto)
End If

rs.CloseResultset
Set rs = Nothing
End Function

Private Sub EliminazioneRighe()
Dim I As Integer
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String

For I = 0 To 150
    If ArrayDelete(I) > 0 Then
        EliminaMovimento ArrayDelete(I)
    End If
Next


End Sub

Public Function ControlloQuantita() As Boolean
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String

sSQL = "SELECT Qta_UM From RV_POLavorazione WHERE IDRV_POLavorazione=" & m_DocumentsLink("IDRV_POLavorazione").Value

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = True Then
    ControlloQuantita = False
Else
    If m_DocumentsLink("Qta_UM").Value <> rs!Qta_UM Then
        ControlloQuantita = True
    Else
        ControlloQuantita = False
    End If
End If

rs.CloseResultset
Set rs = Nothing



End Function
Public Function ControlloQuantitaQuadratura() As Boolean
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String

sSQL = "SELECT QtaCausale From RV_POQuadraturaLavorazione WHERE IDRV_POQuadraturaLavorazione=" & m_DocumentsLink1("IDRV_POQuadraturaLavorazione").Value

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = True Then
    ControlloQuantitaQuadratura = False
Else
    If m_DocumentsLink1("QtaCausale").Value <> rs!QtaCausale Then
        ControlloQuantitaQuadratura = True
    Else
        ControlloQuantitaQuadratura = False
    End If
End If

rs.CloseResultset
Set rs = Nothing
End Function

Public Function PermessoSalvataggio() As Boolean
PermessoSalvataggio = True
Dim Testo As String
Dim TestoControlloKit As String

If LINK_PROCESSO_RIGA > 0 Then
    Testo = "La riga di lavorazione è stata generata dal processo di IV Gamma"
    PermessoSalvataggio = False
    MsgBox Testo, vbCritical, "Impossibile salvare"
    Exit Function
End If

If Me.CDArticolo.KeyFieldID <= 0 Then
    MsgBox "Inserire l'articolo", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Me.CDArticolo.SetFocus
    Exit Function
End If

If Me.txtQta_UM.Value <= 0 Then
    MsgBox "La quantità deve essere maggiore di zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Select Case Link_UnitaDiMisura_Coop
        Case 1
            Me.txtColli.SetFocus
        Case 2
            Me.txtPesoLordo.SetFocus
        Case 3
            Me.txtPesoNetto.SetFocus
        Case 4
            Me.txtTara.SetFocus
        Case 5
            Me.txtPezzi.SetFocus
    End Select
    Exit Function
End If
If Me.txtColli.Value < 0 Then
    MsgBox "La quantità dei colli deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Me.txtColli.SetFocus
    Exit Function
    
End If

If Me.txtPesoLordo.Value < 0 Then
    MsgBox "La quantità del peso lordo deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Me.txtPesoLordo.SetFocus
    Exit Function
    
End If
If Me.txtPesoNetto.Value < 0 Then
    MsgBox "La quantità del peso netto deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Me.txtPesoNetto.SetFocus
    Exit Function
    
End If
If Me.txtPezzi.Value < 0 Then
    MsgBox "La quantità dei pezzi deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Me.txtPezzi.SetFocus
    Exit Function
    
End If
If Me.txtTara.Value < 0 Then
    MsgBox "La quantità della tara deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Me.txtTara.SetFocus
    Exit Function
    
End If
If (Me.txtPesoLordo.Value < Me.txtPesoNetto.Value) Then
    MsgBox "La quantità del peso netto deve essere minore o uguale al valore del peso lordo", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Me.txtPesoLordo.SetFocus
    Exit Function
End If
If txtNumeroConfImballo.Value > 0 Then
    If QUANTITA_PER_COLLO > 0 Then
        Me.txtPezzi.Value = Me.txtColli.Value * QUANTITA_PER_COLLO
    Else
        Me.txtPezzi.Value = Me.txtColli.Value * txtNumeroConfImballo.Value
    End If
Else
    If QUANTITA_PER_COLLO > 0 Then
        If (Me.txtColli.Value * QUANTITA_PER_COLLO) <> Me.txtPezzi.Value Then
            If MsgBox("Il numero dei pezzi non è congruente con il numero dei colli" & vbCrLf & "Continuare?", vbQuestion + vbYesNo, "Errore salvataggio") = vbNo Then
                PermessoSalvataggio = False
                Me.txtColli.SetFocus
                Exit Function
            End If
        End If
    End If
End If
If Me.cboUM.CurrentID <= 0 Then
    MsgBox "Non è stata impostata l'unità misura dell'articolo.", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Me.CDArticolo.SetFocus
    Exit Function
End If

If (Link_TipoProdotto = Link_TipoCaloPeso) Or (Link_TipoProdotto = Link_TipoAumentoPeso) Or (Link_TipoProdotto = Link_TipoScarto) Then
    MsgBox "Il prodotto selezionato non è un prodotto di vendita", vbInformation, "Errore salvataggio"
    PermessoSalvataggio = False
    Exit Function
End If

If ((Me.txtNumeroConfImballo.Value > 0) And (Me.CDImballoPrimario.KeyFieldID = 0)) Then
    Testo = "ATTENZIONE!!!" & vbCrLf
    Testo = Testo & "È stato inserito il numero di confezioni, ma non è stato impostato l'imballo primario" & vbCrLf
    Testo = Testo & "Vuoi continuare?"
    
    If MsgBox(Testo, vbQuestion + vbYesNo, "Validazione dati") = vbNo Then
        PermessoSalvataggio = False
        Exit Function
    End If
    
End If

If ((Me.txtNumeroConfImballo.Value = 0) And (Me.CDImballoPrimario.KeyFieldID > 0)) Then
    Testo = "ATTENZIONE!!!" & vbCrLf
    Testo = Testo & "È stato inserito l'imballo primario, ma non è stato impostato il numero di confezioni" & vbCrLf
    Testo = Testo & "Vuoi continuare?"
    
    If MsgBox(Testo, vbQuestion + vbYesNo, "Validazione dati") = vbNo Then
        PermessoSalvataggio = False
        Exit Function
    End If
    
End If
If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value <= 0) Then
    If BLOCCO_QTA_LAV = 1 Then
        If CONTROLLO_QTA_LAVORATA = True Then
            MsgBox "La quantità lavorata è maggiore della quantità conferita", vbInformation, "Salvataggio dati"
            PermessoSalvataggio = False
            Exit Function
        End If
    End If
End If

If (Me.chkPreConferimento.Value = vbUnchecked) Then
    If Me.txtIDOrdineCliente.Value = 0 Then
        If MsgBox("Ordine non indicato" & vbCrLf & "Inserire le merce in giacenza?", vbQuestion + vbYesNo, "Salvataggio dati") = vbYes Then
            FORZA_LINK_ORDINE = True
            Me.cdCliente.Load LINK_CLIENTE_ORD_PRED
            Me.txtDataOrdine.Text = DATA_ORDINE_PRED
            Me.txtNumeroOrdine.Value = NUMERO_ORDINE_PRED
            
            LINK_ORDINE_RIF = GET_ESISTENZA_ORDINE
            Me.txtIDOrdineCliente.Value = LINK_ORDINE_RIF
            
            FORZA_LINK_ORDINE = False
            If Me.txtIDOrdineCliente.Value = 0 Then
                MsgBox "Inserire nei parametri filiale l'ordine che identifica la merce in giacenza", vbInformation, "Salvataggio dati"
                PermessoSalvataggio = False
                Me.cdCliente.SetFocus
                Exit Function
            End If
        Else
            PermessoSalvataggio = False
            Me.cdCliente.SetFocus
            Exit Function
        End If
    End If
    
    If (Me.cdCliente.KeyFieldID > 0) And (Me.txtIDOrdineCliente.Value = 0) Then
        If MsgBox("Ordine non indicato" & vbCrLf & "Inserire le merce in giacenza?", vbQuestion + vbYesNo, "Salvataggio dati") = vbYes Then
            FORZA_LINK_ORDINE = True
            Me.cdCliente.Load LINK_CLIENTE_ORD_PRED
            Me.txtDataOrdine.Text = DATA_ORDINE_PRED
            Me.txtNumeroOrdine.Value = NUMERO_ORDINE_PRED
            LINK_ORDINE_RIF = GET_ESISTENZA_ORDINE
            Me.txtIDOrdineCliente.Value = LINK_ORDINE_RIF
            FORZA_LINK_ORDINE = False
        Else
            PermessoSalvataggio = False
            Me.cdCliente.SetFocus
            Exit Function
        End If
    End If
    
    If Me.txtDataOrdine.Value = 0 Then
        MsgBox "Inserire la data dell'ordine", vbInformation, "Errore salvataggio"
        PermessoSalvataggio = False
        
        Me.cmdSelezionaOrdine.SetFocus
        Exit Function
    End If
    If Me.txtNumeroOrdine.Value = 0 Then
        MsgBox "Inserire il numero dell'ordine", vbInformation, "Errore salvataggio"
        PermessoSalvataggio = False
        Me.cmdSelezionaOrdine.SetFocus
        Exit Function
    End If
    If Me.cdCliente.KeyFieldID = 0 Then
        MsgBox "Inserire il cliente per l'assegnazione merce", vbInformation, "Errore salvataggio"
        PermessoSalvataggio = False
        Me.cdCliente.SetFocus
        Exit Function
    End If
    
    If Me.txtIDPedana.Value = 0 Then
        MsgBox "Pedana obbligatoria", vbInformation, "Salvataggio dati"
        PermessoSalvataggio = False
        Me.txtCodicePedana.SetFocus
        Exit Function
    End If
    
    If GET_LINK_ANAGRAFICA_ORDINE(Me.txtIDOrdineCliente.Value) <> Me.cdCliente.KeyFieldID Then
        MsgBox "Il cliente non appartiene all'ordine associato", vbInformation, "Salvataggio dati"
        PermessoSalvataggio = False
        Me.cmdSelezionaOrdine.SetFocus
        Exit Function
    End If
    
    If GET_CONTROLLO_PEDANA_ORDINE(Me.txtIDPedana.Value, Me.txtIDOrdineCliente.Value, fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)) = True Then
        MsgBox "La pedana risulta associata ad un altro ordine", vbInformation, "Salvataggio dati"
        Me.txtCodicePedana.SetFocus
        PermessoSalvataggio = False
        Exit Function
    End If
End If

Link_Esercizio = fnGetEsercizio(Me.txtDataLavorazione.Text)

If Link_Esercizio = 0 Then
    MsgBox "L'esercizio inerente alla data di lavorazione non esiste", vbInformation, "Salvataggio dati"
    Me.txtDataLavorazione.SetFocus
    PermessoSalvataggio = False
    
    Exit Function
End If

If Me.chkTracciaImballoGest.Value = vbChecked Then
    If Me.txtColli.Value > Me.txtDispLottoImballo.Value Then
        Testo = "ATTENZIONE!!" & vbCrLf
        Testo = Testo & "L'imballo selezionato è configurato per la tracciabilità, tuttavia la disponibilità dei lotti non è sufficiente " & vbCrLf
        'Testo = Testo & "la disponibilità dei lotti non è abbastanza per evadere la richiesta " & vbCrLf
        Testo = Testo & "Vuoi continuare?"
        If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo tracciabilità lotti imballo") = vbNo Then
            PermessoSalvataggio = False
            Exit Function
        End If
    End If
End If

If Me.chkTracciaImballoGestPrim.Value = vbChecked Then
    If (Me.txtColli.Value * Me.txtNumeroConfImballo.Value) > Me.txtDispLottoImballoPrim.Value Then
        Testo = "ATTENZIONE!!" & vbCrLf
        Testo = Testo & "La confezione selezionata è configurata per la tracciabilità, tuttavia la disponibilità dei lotti non è sufficiente " & vbCrLf
        'Testo = Testo & "la disponibilità dei lotti non è abbastanza per evadere la richiesta " & vbCrLf
        Testo = Testo & "Vuoi continuare?"
        If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo tracciabilità lotti confezione") = vbNo Then
            PermessoSalvataggio = False
            Exit Function
        End If
    End If
End If

TestoControlloKit = CONTROLLO_DISP_LOTTO_KIT
If Len(TestoControlloKit) > 0 Then
    Testo = "ATTENZIONE!!" & vbCrLf
    Testo = Testo & "Alcuni componenti del KIT sono configurati per la tracciabilità, tuttavia la disponibilità dei lotti non è sufficiente: " & vbCrLf
    Testo = Testo & TestoControlloKit
    Testo = Testo & "Vuoi continuare?"
    If MsgBox(Testo, vbQuestion + vbYesNo, "Controllo tracciabilità lotti componenti KIT") = vbNo Then
        PermessoSalvataggio = False
        Exit Function
    End If
End If

If Me.txtIDRigaOrdine.Value > 0 Then
    If (Me.txtIDOrdinePadre.Value <> GET_ORDINE_DA_RIGA_ORD(Me.txtIDRigaOrdine.Value)) Then
        Testo = "ATTENZIONE!!" & vbCrLf
        Testo = Testo & "La riga ordine collegata non fa parte dell'ordine selezionato" & vbCrLf
        Testo = Testo & "Vuoi continuare?" & vbCrLf
        If MsgBox(Testo, vbQuestion + vbYesNo, "Validazione dati") = vbNo Then
            PermessoSalvataggio = False
            Exit Function
        Else
            Me.txtIDRigaOrdine.Value = 0
        End If
    End If
End If
If GET_ESISTENZA_RIGA_CONF(fnNotNullN(m_Document(m_Document.PrimaryKey).Value)) = False Then
    Testo = "ATTENZIONE!!" & vbCrLf
    Testo = Testo & "Il conferimento selezionato non è più disponibile, probabilmente è stato eliminato." & vbCrLf
    Testo = Testo & "Impossibile continuare!" & vbCrLf
    MsgBox Testo, vbCritical, "Validazione dati"
    PermessoSalvataggio = False
    Exit Function
End If
End Function
Private Function DispLotto() As Double
    Dim lIndex As Integer
    Dim Prog As dmtProg.cQuantita
    Set Prog = New dmtProg.cQuantita
    Set Prog.Connessione = TheApp.Database.Connection
    
    Prog.IDAzienda = m_App.IDFirm
    Prog.IDEsercizio = fnGetEsercizio(Date)
    Prog.IDArticolo = m_Document("IDArticolo").Value
    
    For lIndex = 1 To Prog.Magazzini.Count
        If Prog.Magazzini(lIndex).IDMagazzino = Me.cboMagazzinoConf.CurrentID Then
            DispLotto = Prog.Magazzini(lIndex).GetDisponibilita
        End If
    'Me.lblDisp.Caption = Prog.GetDisponibilita(Me.cboMagazzinoRicambio.CurrentID, Me.CDRicambio.KeyFieldID)
    Next


End Function
Private Sub AggiornaProgressivoArticolo()
Dim prg As dmtProg.cRicostruzione
Set prg = New dmtProg.cRicostruzione

Set prg.Connessione = TheApp.Database.Connection
    prg.Filtri.Add m_App.IDFirm, "IDAzienda"

    prg.Filtri.Add Link_Esercizio, "IDEsercizio"

    prg.Filtri.Add Link_Magazzino_Carico, "IDMagazzino"

    prg.Where = "Articolo.CodiceArticolo = " & fnNormString(m_Document("CodiceArticolo").Value)
    'Vengono ricostruiti in questo caso le giacenze dei lotti degli articoli che hanno codice compreso tra 'A000' e 'A999', di esercizio, azienda e magazzino specificati

   
    prg.RicostruzioneProgressivi
Set prg = Nothing

End Sub
Private Sub AggiornaProgressivoArticoloPerQuadratura()
Dim prg As dmtProg.cRicostruzione
Set prg = New dmtProg.cRicostruzione

Set prg.Connessione = TheApp.Database.Connection
    prg.Filtri.Add m_App.IDFirm, "IDAzienda"

    prg.Filtri.Add Link_Esercizio, "IDEsercizio"

    prg.Filtri.Add Link_Magazzino_Carico, "IDMagazzino"

    prg.Where = "Articolo.CodiceArticolo = " & fnNormString(m_Document("CodiceArticolo").Value)
    'Vengono ricostruiti in questo caso le giacenze dei lotti degli articoli che hanno codice compreso tra 'A000' e 'A999', di esercizio, azienda e magazzino specificati
    prg.RicostruzioneLotti
    prg.RicostruzioneProgressivi
    
Set prg = Nothing
End Sub

Private Function fncTrovaIDFunzione(Gestore As String, Optional Funzione As String) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Funzione.IDFunzione, Gestore.Gestore "
sSQL = sSQL & "FROM Gestore INNER JOIN "
sSQL = sSQL & "TipoOggetto ON Gestore.IDGestore = TipoOggetto.IDGestore INNER JOIN "
sSQL = sSQL & "Funzione ON TipoOggetto.IDTipoOggetto = Funzione.IDTipoOggetto "
sSQL = sSQL & "WHERE Gestore.Gestore = " & fnNormString(Gestore)
sSQL = sSQL & " AND Funzione = " & fnNormString(Funzione)
sSQL = sSQL & " AND Funzione.IDFunzione >= 10000"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    fncTrovaIDFunzione = fnNotNullN(rs!IDFunzione)
Else
    fncTrovaIDFunzione = 0
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub fncTabellaDiCollegamentoVendita()
Dim sSQL As String
Dim rsCtrl As DmtOleDbLib.adoResultset

sSQL = "SELECT IDLottoArticolo FROM RV_POCollegamento "
sSQL = sSQL & "WHERE IDLottoArticolo = " & m_DocumentsLink("IDCodiceLotto_Vendita").Value


Set rsCtrl = Cn.OpenResultset(sSQL)

If rsCtrl.EOF Then
    sSQL = "INSERT INTO RV_POCollegamento (IDLottoArticolo, QtaColliCaricati, QtaColliVenduti) "
    sSQL = sSQL & "VALUES ("
    sSQL = sSQL & m_DocumentsLink("IDCodiceLotto_Vendita").Value & ", "
    sSQL = sSQL & m_DocumentsLink("Colli").Value & ", "
    sSQL = sSQL & 0 & ")"
Else
    sSQL = "UPDATE RV_POCollegamento SET "
    sSQL = sSQL & "QtaColliCaricati=" & m_DocumentsLink("Colli").Value & " "
    sSQL = sSQL & "WHERE IDLottoArticolo=" & m_DocumentsLink("IDCodiceLotto_Vendita").Value
End If

Cn.Execute sSQL

rsCtrl.CloseResultset
Set rsCtrl = Nothing


End Sub
Private Function GetColliVenduti() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

If IsNull(m_DocumentsLink("IDCodiceLotto_vendita")) Then
    GetColliVenduti = 0
Else
sSQL = "SELECT QtaColliVenduti FROM RV_POCollegamento "
sSQL = sSQL & "WHERE IDLottoArticolo=" & m_DocumentsLink("IDCodiceLotto_Vendita").Value

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GetColliVenduti = 0
Else
    If IsNull(rs!QtaColliVenduti) Then
        GetColliVenduti = 0
    Else
        GetColliVenduti = rs!QtaColliVenduti
    End If
End If

rs.CloseResultset
Set rs = Nothing

End If


End Function
Private Sub ParametroGrezzo()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoGrezzo FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Link_TipoGrezzo = rs!IDTipoGrezzo
Else
    Link_TipoGrezzo = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub ParametroLavorato()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoLavorato FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Link_TipoLavorato = rs!IDTipoLavorato
Else
    Link_TipoLavorato = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub

Private Sub RecuperaOperazioniDocumento()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT RV_POOperazionePerDoc.GestioneArticoli, RV_POOperazionePerDoc.CreazioneAutomaticaLottoVend "
sSQL = sSQL & "FROM RV_POOperazionePerDoc INNER JOIN "
sSQL = sSQL & "RV_POSchemaCoop ON RV_POOperazionePerDoc.IDRV_POSchemaCoop = RV_POSchemaCoop.IDRV_POSchemaCoop "
sSQL = sSQL & "WHERE (RV_POSchemaCoop.IDFiliale =" & m_App.Branch & ") And (RV_POSchemaCoop.IDUtente = 0) And (RV_POOperazionePerDoc.IDRV_PODocumentoCoop =" & IDDocumento & ")"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Flag_GestioneArticoli = rs!GestioneArticoli
    Flag_AutomazioneLotti = rs!CreazioneAutomaticaLottoVend
Else
    Flag_GestioneArticoli = 0
    Flag_AutomazioneLotti = 0
End If

rs.CloseResultset
Set rs = Nothing

End Sub

Private Function fnEsistenzaArticoloDerivato() As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT * FROM RV_POArticoloFiglio WHERE ("
sSQL = sSQL & "(IDArticolo=" & m_Document("IDArticolo").Value & ") "
sSQL = sSQL & "AND (IDArticoloFiglio=" & Me.CDArticolo.KeyFieldID & "))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = True Then
    Bool_EsistenzaArticoloDerivato = False
    Link_TipoLavorazione = 0
Else
    Bool_EsistenzaArticoloDerivato = True
    Link_TipoLavorazione = fnNotNullN(rs!IDRV_POTipoLavorazione)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function fnGetTipoLavorazione() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

fnGetTipoLavorazione = 0

'If fnEsistenzaArticoloDerivato = True Then
'    If Link_TipoLavorazione > 0 Then
'        fnGetTipoLavorazione = Link_TipoLavorazione
'        Exit Function
'    End If
'End If

sSQL = "SELECT RV_POIDTipoLavorazione FROM Articolo WHERE IDArticolo=" & Me.CDArticolo.KeyFieldID

Set rs = Cn.OpenResultset(sSQL)
If rs.EOF = False Then
    fnGetTipoLavorazione = fnNotNullN(rs!RV_POIDTipoLavorazione)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function fnGetValoreQta_ScaricoMagazzino() As Double
    
    
        Select Case fnNotNullN(m_Document("IDUnitaDiMisura").Value)
        
            Case 1
                fnGetValoreQta_ScaricoMagazzino = fnNotNull(m_DocumentsLink("Colli").Value)
            Case 2
                fnGetValoreQta_ScaricoMagazzino = fnNotNull(m_DocumentsLink("PesoLordo").Value)
            Case 3
                fnGetValoreQta_ScaricoMagazzino = fnNotNull(m_DocumentsLink("PesoNetto").Value)
            Case 4
                fnGetValoreQta_ScaricoMagazzino = fnNotNull(m_DocumentsLink("Tara").Value)
            Case 5
                fnGetValoreQta_ScaricoMagazzino = fnNotNull(m_DocumentsLink("Pezzi").Value)
            Case Default
                fnGetValoreQta_ScaricoMagazzino = 0
        End Select
    
    
End Function

Private Function GET_TIPO_PRODOTTO(IDArticolo As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoProdotto FROM Articolo "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo
sSQL = sSQL & " AND IDAzienda=" & m_App.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TIPO_PRODOTTO = 0
Else
    GET_TIPO_PRODOTTO = fnNotNullN(rs!IDTipoProdotto)
End If

rs.CloseResultset
Set rs = Nothing
End Function


Private Function GET_Numero_Riga_Lavorazione() As Long
Dim IDEsercizio As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim NumeroRiga As Long

IDEsercizio = fnGetEsercizio(Date)

sSQL = "SELECT * FROM RV_POTMPRigaLavorazione "
sSQL = sSQL & "WHERE IDesercizio = " & IDEsercizio & " AND "
sSQL = sSQL & "IDUtente=" & TheApp.IDUser

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    NumeroRiga = fnGetNewKey("RV_POLavorazione", "Link_riga_Interno")
    sSQL = "INSERT INTO RV_POTMPRigaLavorazione (IDUtente, IDEsercizio, NumeroRiga) "
    sSQL = sSQL & "VALUES ("
    sSQL = sSQL & TheApp.IDUser & ", "
    sSQL = sSQL & IDEsercizio & ", "
    sSQL = sSQL & NumeroRiga & ")"
Else
    NumeroRiga = fnNotNullN(rs!NumeroRiga) + 1
    sSQL = "UPDATE RV_POTMPRigaLavorazione SET "
    sSQL = sSQL & "NumeroRiga=" & NumeroRiga & " "
    sSQL = sSQL & "WHERE IDUtente=" & TheApp.IDUser & " AND "
    sSQL = sSQL & "IDEsercizio=" & IDEsercizio
End If

Cn.Execute sSQL

GET_Numero_Riga_Lavorazione = TheApp.IDUser & NumeroRiga

rs.CloseResultset
Set rs = Nothing

End Function
Private Sub ParametroTipoCaloPeso()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoCaloPeso FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Link_TipoCaloPeso = fnNotNullN(rs!IDTipoCaloPeso)
Else
    Link_TipoCaloPeso = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub ParametroTipoAumentoPeso()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoAumentoPeso FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Link_TipoAumentoPeso = fnNotNullN(rs!IDTipoAumentoPeso)
Else
    Link_TipoAumentoPeso = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub ParametroTipoScarto()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoScarto FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Link_TipoScarto = fnNotNullN(rs!IDTipoScarto)
Else
    Link_TipoScarto = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub ParametroTipoQuadratura()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoQuadratura FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Link_TipoQuadratura = fnNotNullN(rs!IDTipoQuadratura)
Else
    Link_TipoQuadratura = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Function GET_CAUSALE_QUADRATURA(NomeCampo As String) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT " & NomeCampo & " FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    GET_CAUSALE_QUADRATURA = fnNotNullN(rs.adoColumns(NomeCampo).Value)
Else
    GET_CAUSALE_QUADRATURA = 0
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub PareggiaConferimento()
On Error GoTo ERR_PareggiaConferimento
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim IDTipoProdottoQ As Long
Dim IDTipoOggettoConferimento As Long
Dim Link_Carico_Pred As Long
Dim Link_Scarico_Pred As Long
Dim IDTipoDocumentoCoop As Long

Link_Carico_Pred = 0
Link_Scarico_Pred = 0



'''''VARIABILI PER LA RIGA DI CONFERIMENTO
Dim QtaTotale As Double
Dim PesoLordo As Double
Dim PesoNetto As Double
Dim Tara As Double
Dim Pezzi As Double
Dim Colli As Double

''''VARIABILI PER LA LAVORAZIONE
Dim PesoLordoLav As Double
Dim PesoNettoLav As Double
Dim TaraLav As Double
Dim PezziLav As Double
Dim ColliLav As Double

''''VARIABILI PER LA QUADRATURA
Dim PesoLordoQ As Double
Dim PesoNettoQ As Double
Dim TaraQ As Double
Dim PezziQ As Double
Dim ColliQ As Double
Dim X As Boolean
Dim Mov As DmtMovim.cMovimentazione

'''SETTAGGIO DELLE VARIABILI QUANTITA DELLA RIGA CONFERIMENTO
QtaTotale = 0
PesoLordo = 0
PesoNetto = 0
Tara = 0
Pezzi = 0
Colli = 0

'''SETTAGGIO DELLE VARIABILI QUANTITA DELLA LAVORAZIONE DELLA RIGA CONFERIMENTO
PesoLordoLav = 0
PesoNettoLav = 0
TaraLav = 0
PezziLav = 0
ColliLav = 0

'''SETTAGGIO DELLE VARIABILI QUANTITA DELLA QUADRATURA DELLA RIGA CONFERIMENTO
PesoLordoQ = 0
PesoNettoQ = 0
TaraQ = 0
PezziQ = 0
ColliQ = 0

DoEvents

'TOTALI DELLA LAVORAZIONE'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT SUM(Qta_UM) AS Qta_UM, SUM(Colli) AS Colli, SUM(PesoLordo) AS PesoLordo, "
sSQL = sSQL & "SUM(PesoNetto) AS PesoNetto, SUM(Tara) AS Tara, SUM(Pezzi) AS Pezzi "
sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
sSQL = sSQL & "WHERE (IDRV_POCaricoMerceRighe =" & fnNotNullN(m_Document("IDRV_POCaricoMerceRighe")) & ")"

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    ColliLav = fnNotNullN(rs!Colli)
    PesoNettoLav = fnNotNullN(rs!PesoNetto)
    TaraLav = fnNotNullN(rs!Tara)
    PesoLordoLav = fnNotNullN(rs!PesoLordo)
    PezziLav = fnNotNullN(rs!Pezzi)
End If

rs.CloseResultset
Set rs = Nothing
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

sSQL = "SELECT IDArticolo, Colli, PesoLordo, PesoNetto, Tara, Pezzi "
sSQL = sSQL & "FROM RV_POLavorazione "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & fnNotNullN(m_Document("IDRV_POCaricoMerceRighe").Value)

Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    
    IDTipoProdottoQ = GET_TIPO_PRODOTTO(fnNotNullN(rs!IDArticolo))
    
    Select Case IDTipoProdottoQ
        Case Link_TipoScarto
            ColliQ = ColliQ + fnNotNullN(rs!Colli)
            PesoLordoQ = PesoLordoQ + fnNotNullN(rs!PesoLordo)
            TaraQ = TaraQ + fnNotNullN(rs!Tara)
            PesoNettoQ = PesoNettoQ + fnNotNullN(rs!PesoNetto)
            PezziQ = PezziQ + fnNotNullN(rs!Pezzi)
        Case Link_TipoCaloPeso
            ColliQ = ColliQ + fnNotNullN(rs!Colli)
            PesoLordoQ = PesoLordoQ + fnNotNullN(rs!PesoLordo)
            TaraQ = TaraQ + fnNotNullN(rs!Tara)
            PesoNettoQ = PesoNettoQ + fnNotNullN(rs!PesoNetto)
            PezziQ = PezziQ + fnNotNullN(rs!Pezzi)
        Case Link_TipoAumentoPeso
            ColliQ = ColliQ - fnNotNullN(rs!Colli)
            PesoLordoQ = PesoLordoQ - fnNotNullN(rs!PesoLordo)
            TaraQ = TaraQ - fnNotNullN(rs!Tara)
            PesoNettoQ = PesoNettoQ - fnNotNullN(rs!PesoNetto)
            PezziQ = PezziQ - fnNotNullN(rs!Pezzi)
        Case Else
            ColliQ = ColliQ + fnNotNullN(rs!Colli)
            PesoLordoQ = PesoLordoQ + fnNotNullN(rs!PesoLordo)
            TaraQ = TaraQ + fnNotNullN(rs!Tara)
            PesoNettoQ = PesoNettoQ + fnNotNullN(rs!PesoNetto)
            PezziQ = PezziQ + fnNotNullN(rs!Pezzi)
    
    End Select
    
rs.MoveNext
Wend
rs.CloseResultset
Set rs = Nothing

    Select Case fnNotNullN(m_Document("IDUnitaDiMisura").Value)
        Case 1
            Colli = fnNotNullN(m_Document("Colli").Value) 'ColliLav + ColliQ
            PesoNetto = PesoNettoLav + PesoNettoQ
            Tara = ((Colli * fnNotNullN(m_Document("TaraUnitaria").Value)) + (fnNotNullN(m_Document("QuantitaPedana").Value) * fnNotNullN(m_Document("TaraPedana").Value))) + fnNotNullN(m_Document("TaraMezzo").Value)
            PesoLordo = PesoNetto + Tara
            Pezzi = PezziLav + PezziQ
            QtaTotale = Colli
        Case 2
            Colli = fnNotNullN(m_Document("Colli").Value) 'ColliLav + ColliQ
            PesoLordo = PesoLordoLav + PesoLordoQ
            Tara = (Colli * fnNotNullN(m_Document("TaraUnitaria").Value)) + (fnNotNullN(m_Document("QuantitaPedana").Value) * fnNotNullN(m_Document("TaraPedana").Value))
            PesoNetto = PesoLordo - Tara
            Pezzi = PezziLav + PezziQ
            QtaTotale = PesoLordo
        Case 3
            Colli = fnNotNullN(m_Document("Colli").Value) 'ColliLav + ColliQ
            PesoNetto = PesoNettoLav + PesoNettoQ
            Tara = (Colli * fnNotNullN(m_Document("TaraUnitaria").Value)) + (fnNotNullN(m_Document("QuantitaPedana").Value) * fnNotNullN(m_Document("TaraPedana").Value)) + fnNotNullN(m_Document("TaraMezzo").Value)
            PesoLordo = PesoNetto + Tara
            Pezzi = PezziLav + PezziQ
            QtaTotale = PesoNetto
        Case 4
            Colli = fnNotNullN(m_Document("Colli").Value) 'ColliLav + ColliQ
            PesoNetto = PesoNettoLav + PesoNettoQ
            Tara = (Colli * fnNotNullN(m_Document("TaraUnitaria").Value)) + (fnNotNullN(m_Document("QuantitaPedana").Value) * fnNotNullN(m_Document("TaraPedana").Value)) + fnNotNullN(m_Document("TaraMezzo").Value)
            PesoLordo = PesoNetto + Tara
            Pezzi = PezziLav + PezziQ
            QtaTotale = Tara
        Case 5
            Colli = fnNotNullN(m_Document("Colli").Value) 'ColliLav + ColliQ
            PesoNetto = PesoNettoLav + PesoNettoQ
            Tara = (Colli * fnNotNullN(m_Document("TaraUnitaria").Value)) + (fnNotNullN(m_Document("QuantitaPedana").Value) * fnNotNullN(m_Document("TaraPedana").Value)) + fnNotNullN(m_Document("TaraMezzo").Value)
            PesoLordo = PesoNetto + Tara
            Pezzi = PezziLav + PezziQ
            QtaTotale = Pezzi
    End Select
    
    AggiornaQuantitaDiConferimento fnNotNullN(QtaTotale), PesoLordo, PesoNetto, Tara, Pezzi, Colli
    
    Set Mov = New DmtMovim.cMovimentazione
    
    Set Mov.Connection = TheApp.Database.Connection
    
    'ELIMINAZIONE MOVIMENTI
    IDTipoOggettoConferimento = 1 'fnNotNullN(m_Document("IDTipoDocumentoCoop").Value)
    
    If fnNotNullN(m_Document("IDTipoDocumentoCoop").Value) = 1 Then
        IDTipoOggettoConferimento = fnGetTipoOggetto("RV_POCaricoMerceL")
        IDTipoDocumentoCoop = 4
    Else
        IDTipoOggettoConferimento = fnGetTipoOggetto("RV_POFattAcqL")
        IDTipoDocumentoCoop = 1
    End If
    
'    Mov.IDTipoOggetto = IDTipoOggettoConferimento
'    Mov.IDOggetto = fnNotNullN(m_Document("IDRV_POCaricoMerceTesta").Value)
'    Mov.Delete
    
    'ELIMINAZIONE MOVIMENTI DELLA RIGA CONFERITA''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    sSQL = "SELECT IDMovimento FROM Movimento "
    sSQL = sSQL & " WHERE IDTipoOggetto=" & IDTipoOggettoConferimento
    sSQL = sSQL & " AND IDOggetto=" & fnNotNullN(m_Document("IDRV_POCaricoMerceTesta").Value)
    sSQL = sSQL & " AND IDValoriOggettoDettaglio=" & fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    
    Set rs = Cn.OpenResultset(sSQL)
    
    While Not rs.EOF
        X = Mov.Delete(fnNotNullN(rs!IDMovimento))
    rs.MoveNext
    Wend
    
    rs.CloseResultset
    Set rs = Nothing
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    
    
    'MOVIMENTO ARTICOLO
    Mov.DataMovimento = m_Document("DataDocumento").Value
    Mov.FattoreDiConversione = Null
    
    Mov.GestioneMatricole = False
    Mov.IDEsercizio = Link_Esercizio
    Mov.IDOggetto = m_Document("IDRV_POCaricoMerceTesta").Value
    Mov.IDTipoOggetto = IDTipoOggettoConferimento
    
    Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(IDTipoDocumentoCoop, 1)
    Mov.IDUtente = TheApp.IDUser
    Mov.IDMagazzinoEntrata = Me.cboMagazzinoConf.CurrentID
    Mov.IDMagazzinoUscita = Me.cboMagazzinoConf.CurrentID
    Mov.Cessione = 0
    Mov.Field "IDAzienda", TheApp.IDFirm
    Mov.Field "IDAnagrafica", Val(Me.TxtIDAnagrafica.Text)
    Mov.Field "IDTipoAnagrafica", 3
    Mov.Field "IDArticolo", fnNotNullN(m_Document("IDArticolo").Value)
    Mov.Field "IDUnitaDiMisura", fnNotNullN(m_Document("IDUnitaDiMisuraDiamante").Value)
    Mov.Field "IDcambio", Null
    Mov.Field "DescrizioneArticolo", fnNotNull(m_Document("Articolo").Value)
    Mov.Field "QuantitaTotale", QtaTotale
    Mov.Field "Importo", fnNotNullN(m_Document("TotaleImponibileRiga").Value)
    Mov.Field "PrezzoUnitario", fnNotNullN(m_Document("ImportoUnitario").Value)
    Mov.Field "DataDocumento", Me.txtDataDocumento.Text
    If fnNotNullN(m_Document("IDTipoDocumentoCoop").Value) = 1 Then
        Mov.Field "Oggetto", Mid("Conferimento del " & Me.txtDataDocumento & " Numero " & Me.txtNumeroDocumento, 1, 100)
    Else
        Mov.Field "Oggetto", Mid("Acquisto merce del " & Me.txtDataDocumento & " Numero " & Me.txtNumeroDocumento, 1, 100)
    End If
    Mov.Field "IDTipoMovimento", 1
    
    Mov.Field "TipoRiga", trcNessuno
    'DATI DI CONFERIMENTO
    Mov.Field "IDValoriOggettoDettaglio", fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    Mov.Field "RV_POTipoRiga", 1
    Mov.Field "RV_POIDCaricoMerceRighe", m_Document(m_Document.PrimaryKey).Value
    Mov.Field "RV_POIDAssegnazioneMerce", 0
    Mov.Field "RV_POIDProcessoIVGamma", 0
    Mov.Field "RV_POIDAnagraficaSocio", Me.TxtIDAnagrafica.Text
    Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
    Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
    Mov.Field "RV_POCodiceLotto", Me.txtLottoEntrata.Text
    Mov.Field "RV_POCodiceLottoCampagna", Me.txtCodiceLotto_Conf.Text
    Mov.Field "RV_POQuantitaLiquidazione", 0
    Mov.Field "RV_POImportoInclusoImballo", 0
    Mov.Field "RV_POImportoLiquidazione", 0
    Mov.Field "RV_POQuantitaMovimentata", QtaTotale
    Mov.Field "RV_PONumeroColli", Colli
    Mov.Field "RV_POPesoLordo", PesoLordo
    Mov.Field "RV_POPesoNetto", PesoNetto
    Mov.Field "RV_POTara", Tara
    Mov.Field "RV_POQuantitaPezzi", Pezzi

    X = Mov.Insert
    
    'MOVIMENTO IMBALLO
    If ((fnNotNullN(m_Document("IDImballo").Value) > 0) And (Colli > 0)) Then
        Mov.DataMovimento = m_Document("DataDocumento").Value
        Mov.FattoreDiConversione = Null
        
        Mov.GestioneMatricole = False
        Mov.IDEsercizio = Link_Esercizio
        Mov.IDOggetto = m_Document("IDRV_POCaricoMerceTesta").Value
        Mov.IDTipoOggetto = IDTipoOggettoConferimento
        Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(IDTipoDocumentoCoop, 1)
        Mov.IDUtente = TheApp.IDUser
        Mov.IDMagazzinoEntrata = Me.cboMagazzinoConf.CurrentID
        Mov.IDMagazzinoUscita = Me.cboMagazzinoConf.CurrentID
        Mov.Cessione = 0
        Mov.Field "IDAzienda", TheApp.IDFirm
        Mov.Field "IDAnagrafica", Val(Me.TxtIDAnagrafica.Text)
        Mov.Field "IDTipoAnagrafica", 3
        Mov.Field "IDArticolo", fnNotNullN(m_Document("IDImballo").Value)
        Mov.Field "IDUnitaDiMisura", 8
        Mov.Field "IDcambio", Null
        Mov.Field "DescrizioneArticolo", fnNotNull(m_Document("DescrizioneImballo").Value)
        Mov.Field "QuantitaTotale", Colli
        Mov.Field "Importo", 0
        Mov.Field "DataDocumento", Me.txtDataDocumento.Text
        If fnNotNullN(m_Document("IDTipoDocumentoCoop").Value) = 1 Then
            Mov.Field "Oggetto", Mid("Conferimento del " & Me.txtDataDocumento & " Numero " & Me.txtNumeroDocumento, 1, 100)
        Else
            Mov.Field "Oggetto", Mid("Acquisto merce del " & Me.txtDataDocumento & " Numero " & Me.txtNumeroDocumento, 1, 100)
        End If
        Mov.Field "IDTipoMovimento", 1
        
        Mov.Field "TipoRiga", trcNessuno
    
        Mov.Field "IDValoriOggettoDettaglio", m_Document(m_Document.PrimaryKey).Value
        Mov.Field "RV_POTipoRiga", 2
        Mov.Field "RV_POIDCaricoMerceRighe", m_Document(m_Document.PrimaryKey).Value
        Mov.Field "RV_POIDAssegnazioneMerce", 0
        Mov.Field "RV_POIDProcessoIVGamma", 0
        Mov.Field "RV_POIDAnagraficaSocio", Me.TxtIDAnagrafica.Text
        Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
        Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
        Mov.Field "RV_POCodiceLotto", Me.txtLottoEntrata.Text
        Mov.Field "RV_POCodiceLottoCampagna", Me.txtCodiceLotto_Conf.Text
        Mov.Field "RV_POQuantitaLiquidazione", 0
        Mov.Field "RV_POImportoInclusoImballo", 0
        Mov.Field "RV_POImportoLiquidazione", 0
        Mov.Field "RV_POQuantitaMovimentata", Colli
        Mov.Field "RV_PONumeroColli", 0
        Mov.Field "RV_POPesoLordo", 0
        Mov.Field "RV_POPesoNetto", 0
        Mov.Field "RV_POTara", 0
        Mov.Field "RV_POQuantitaPezzi", 0
    
        X = Mov.Insert
    End If
            
    'MOVIMENTO PEDANA
    If ((fnNotNullN(m_Document("QuantitaPedana").Value) > 0) And (fnNotNullN(m_Document("IDArticoloPedana").Value) > 0)) Then
        Mov.DataMovimento = m_Document("DataDocumento").Value
        Mov.FattoreDiConversione = Null
        
        Mov.GestioneMatricole = False
        Mov.IDEsercizio = Link_Esercizio
        Mov.IDOggetto = m_Document("IDRV_POCaricoMerceTesta").Value
        Mov.IDTipoOggetto = IDTipoOggettoConferimento
        Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(IDTipoDocumentoCoop, 1)
        Mov.IDUtente = TheApp.IDUser
        Mov.IDMagazzinoEntrata = Me.cboMagazzinoConf.CurrentID
        Mov.IDMagazzinoUscita = Me.cboMagazzinoConf.CurrentID
        Mov.Cessione = 0
        Mov.Field "IDAzienda", TheApp.IDFirm
        Mov.Field "IDAnagrafica", Val(Me.TxtIDAnagrafica.Text)
        Mov.Field "IDTipoAnagrafica", 3
        Mov.Field "IDArticolo", fnNotNullN(m_Document("IDArticoloPedana").Value)
        Mov.Field "IDUnitaDiMisura", 8
        Mov.Field "IDcambio", Null
        Mov.Field "DescrizioneArticolo", fnNotNull(m_Document("DescrizionePedana").Value)
        Mov.Field "QuantitaTotale", fnNotNullN(m_Document("QuantitaPedana").Value)
        Mov.Field "Importo", 0
        Mov.Field "PrezzoUnitario", 0
        Mov.Field "DataDocumento", Me.txtDataDocumento.Text
        If fnNotNullN(m_Document("IDTipoDocumentoCoop").Value) = 1 Then
            Mov.Field "Oggetto", Mid("Conferimento del " & Me.txtDataDocumento & " Numero " & Me.txtNumeroDocumento, 1, 100)
        Else
            Mov.Field "Oggetto", Mid("Acquisto merce del " & Me.txtDataDocumento & " Numero " & Me.txtNumeroDocumento, 1, 100)
        End If
        
        Mov.Field "IDTipoMovimento", 1
        
        Mov.Field "TipoRiga", trcNessuno
        Mov.Field "IDValoriOggettoDettaglio", m_Document(m_Document.PrimaryKey).Value
        Mov.Field "RV_POTipoRiga", 2
        Mov.Field "RV_POIDCaricoMerceRighe", m_Document(m_Document.PrimaryKey).Value
        Mov.Field "RV_POIDAssegnazioneMerce", 0
        Mov.Field "RV_POIDProcessoIVGamma", 0
        Mov.Field "RV_POIDAnagraficaSocio", Me.TxtIDAnagrafica.Text
        Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
        Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
        Mov.Field "RV_POCodiceLotto", Me.txtLottoEntrata.Text
        Mov.Field "RV_POCodiceLottoCampagna", Me.txtCodiceLotto_Conf.Text
        Mov.Field "RV_POQuantitaLiquidazione", 0
        Mov.Field "RV_POImportoInclusoImballo", 0
        Mov.Field "RV_POImportoLiquidazione", 0
        Mov.Field "RV_POQuantitaMovimentata", fnNotNullN(m_Document("QuantitaPedana").Value)
        Mov.Field "RV_PONumeroColli", 0
        Mov.Field "RV_POPesoLordo", 0
        Mov.Field "RV_POPesoNetto", 0
        Mov.Field "RV_POTara", 0
        Mov.Field "RV_POQuantitaPezzi", 0
        
        X = Mov.Insert
    End If

Me.txtDisponibiltaLottoCaricato.Value = QtaTotale
Me.txtNumeroColliCaricati.Value = Colli
GET_RIEPILOGO_CONFERIMENTO

Exit Sub
ERR_PareggiaConferimento:
    MsgBox Err.Description, vbCritical, "Pareggia conferimento"
End Sub
Private Function GET_TOTALI_QUANTITA(NomeCampo As Double) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT SUM(" & NomeCampo & ") FROM RV_POAssegnazioneMerce "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & m_Document(m_Document.PrimaryKey).Value

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TOTALI_QUANTITA = 0
Else
    GET_TOTALI_QUANTITA = fnNotNullN(rs.adoColumns(NomeCampo).Value)
End If

rs.CloseResultset
Set rs = Nothing

End Function

Private Sub AggiornaQuantitaDiConferimento(Quantita As Double, PesoLordo As Double, PesoNetto As Double, Tara As Double, Pezzi As Double, Colli As Double)
Dim sSQL As String

sSQL = "UPDATE RV_POCaricoMerceRighe SET "
sSQL = sSQL & "Qta_UM=" & fnNormNumber(Quantita) & ", "
sSQL = sSQL & "PesoLordo=" & fnNormNumber(PesoLordo) & ", "
sSQL = sSQL & "PesoNetto=" & fnNormNumber(PesoNetto) & ", "
sSQL = sSQL & "Tara=" & fnNormNumber(Tara) & ", "
sSQL = sSQL & "Colli=" & fnNormNumber(Colli) & ", "
sSQL = sSQL & "Pezzi=" & fnNormNumber(Pezzi) & " "

sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & fnNotNullN(m_Document("IDRV_POCaricoMerceRighe").Value)

Cn.Execute sSQL

End Sub
Private Function fnGetCodiceSocio(IDAnagrafica As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Codice FROM Fornitore WHERE "
sSQL = sSQL & "IDAzienda=" & TheApp.IDFirm & " AND "
sSQL = sSQL & "IDAnagrafica=" & IDAnagrafica

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    fnGetCodiceSocio = 0
Else
    fnGetCodiceSocio = fnNotNull(rs!Codice)
End If

rs.CloseResultset
Set rs = Nothing
End Function



Private Function GET_RIEPILOGO_QUANTITA_LAVORAZIONE(IDConferimentoRiga As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim SegnoMovimento As String

GET_RIEPILOGO_QUANTITA_LAVORAZIONE = 0


If ATTIVAZIONE_NUOVO_CALCOLO = True Then
    sSQL = "SELECT IDArticolo, IDFunzione, RV_POQuantitaMovimentata FROM Movimento "
    sSQL = sSQL & "WHERE RV_POIDCaricoMerceRighe=" & IDConferimentoRiga
    sSQL = sSQL & " AND IDTipoOggetto=" & fnGetTipoOggetto("RV_POLavorazioneL")
    sSQL = sSQL & " AND RV_POTipoRiga=1"
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_RIEPILOGO_QUANTITA_LAVORAZIONE = 0
    Else
        While Not rs.EOF
            Select Case GET_TIPO_PRODOTTO(rs!IDArticolo)
                Case Link_TipoCaloPeso
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE + fnNotNullN(rs!RV_POQuantitaMovimentata)
                Case Link_TipoScarto
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE + fnNotNullN(rs!RV_POQuantitaMovimentata)
                Case Link_TipoAumentoPeso
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE - fnNotNullN(rs!RV_POQuantitaMovimentata)
                Case Else
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE + fnNotNullN(rs!RV_POQuantitaMovimentata)
            End Select
        rs.MoveNext
        Wend
    End If
    
    rs.CloseResultset
    Set rs = Nothing
    
    


Else
    
    sSQL = "SELECT SegnoMovimento, Colli, PesoLordo, PesoNetto, Tara, Pezzi "
    sSQL = sSQL & "FROM RV_POLavorazione "
    sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDConferimentoRiga
    
    Set rs = Cn.OpenResultset(sSQL)
    
    While Not rs.EOF
        Select Case m_Document("IDUnitaDiMisura").Value
            Case 1
                If Trim(fnNotNull(rs!SegnoMovimento)) = "+" Then
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE - fnNotNullN(rs!Colli)
                Else
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE + fnNotNullN(rs!Colli)
                End If
            Case 2
                If Trim(fnNotNull(rs!SegnoMovimento)) = "+" Then
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE - fnNotNullN(rs!PesoLordo)
                Else
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE + fnNotNullN(rs!PesoLordo)
                End If
            Case 3
                If Trim(fnNotNull(rs!SegnoMovimento)) = "+" Then
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE - fnNotNullN(rs!PesoNetto)
                Else
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE + fnNotNullN(rs!PesoNetto)
                End If
            Case 4
                If Trim(fnNotNull(rs!SegnoMovimento)) = "+" Then
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE - fnNotNullN(rs!Tara)
                Else
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE + fnNotNullN(rs!Tara)
                End If
    
            Case 5
                If Trim(fnNotNull(rs!SegnoMovimento)) = "+" Then
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE - fnNotNullN(rs!Pezzi)
                Else
                    GET_RIEPILOGO_QUANTITA_LAVORAZIONE = GET_RIEPILOGO_QUANTITA_LAVORAZIONE + fnNotNullN(rs!Pezzi)
                End If
    
        End Select
    rs.MoveNext
    Wend
    
    rs.CloseResultset
    Set rs = Nothing

End If

End Function
Private Function GET_RIEPILOGO_QUANTITA_VENDUTO(IDConferimentoRiga As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_RIEPILOGO_QUANTITA_VENDUTO = 0

If ATTIVAZIONE_NUOVO_CALCOLO = False Then
    sSQL = "SELECT SUM(Qta_UM) AS Qta_UM, SUM(Colli) AS Colli, SUM(PesoLordo) AS PesoLordo, "
    sSQL = sSQL & "SUM(PesoNetto) AS PesoNetto, SUM(Tara) AS Tara, SUM(Pezzi) AS Pezzi "
    sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
    sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDConferimentoRiga
    Set rs = Cn.OpenResultset(sSQL)
    
    
    
    If rs.EOF Then
        GET_RIEPILOGO_QUANTITA_VENDUTO = 0
    Else
        Select Case m_Document("IDUnitaDiMisura").Value
            Case 1
                GET_RIEPILOGO_QUANTITA_VENDUTO = fnNotNullN(rs!Colli)
            Case 2
                GET_RIEPILOGO_QUANTITA_VENDUTO = fnNotNullN(rs!PesoLordo)
            Case 3
                GET_RIEPILOGO_QUANTITA_VENDUTO = fnNotNullN(rs!PesoNetto)
            Case 4
                GET_RIEPILOGO_QUANTITA_VENDUTO = fnNotNullN(rs!Tara)
            Case 5
                GET_RIEPILOGO_QUANTITA_VENDUTO = fnNotNullN(rs!Pezzi)
        End Select
            
    End If
    
    rs.CloseResultset
    Set rs = Nothing
Else

    sSQL = "SELECT Sum (RV_POQuantitaMovimentata) AS Quantita FROM Movimento "
    sSQL = sSQL & "WHERE RV_POIDCaricoMerceRighe=" & IDConferimentoRiga
    sSQL = sSQL & " AND IDTipoOggetto=" & fnGetTipoOggetto(App.EXEName)
    sSQL = sSQL & " AND RV_POTipoRiga=1"
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_RIEPILOGO_QUANTITA_VENDUTO = 0
    Else
        GET_RIEPILOGO_QUANTITA_VENDUTO = fnNotNullN(rs!Quantita)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
    
    Exit Function
End If
End Function
Private Sub GET_RIEPILOGO_CONFERIMENTO()
'On Error GoTo ERR_GET_RIEPILOGO_CONFERIMENTO
Dim qtaDiff As Double
Dim qtavend As Double
Dim qtaquad As Double

    
    qtavend = GET_RIEPILOGO_QUANTITA_VENDUTO(fnNotNullN(m_Document(m_Document.PrimaryKey).Value)) + GET_RIEPILOGO_QUANTITA_PROCESSO(fnNotNullN(m_Document(m_Document.PrimaryKey).Value))
    
    qtaquad = GET_RIEPILOGO_QUANTITA_LAVORAZIONE(fnNotNullN(m_Document(m_Document.PrimaryKey).Value))
    
    qtaDiff = Me.txtDisponibiltaLottoCaricato.Value - (qtaquad + qtavend)
            
    qtaDiff = FormatNumber(qtaDiff, 5)
        
    Me.txtQtaVenduta.Value = qtavend
    
    Me.txtQtaQuadrata.Value = qtaquad
    
    Me.txtQtaDifferenza.Value = qtaDiff
    
    If Me.txtQtaDifferenza.Value < 0 Then
        Me.txtQtaDifferenza.BackColor = vbRed
        Me.Image1.Visible = True
    Else
        Me.txtQtaDifferenza.BackColor = vbWhite
        Me.Image1.Visible = False
    End If
    
    Me.txtNumeroPedaneLav.Value = GET_NUMERO_PEDANE_LAVORATE(fnNotNullN(m_Document(m_Document.PrimaryKey).Value))
    Me.txtNumeroColliLav.Value = GET_TOTALI_COLLI_LAV(fnNotNullN(m_Document(m_Document.PrimaryKey).Value))

Exit Sub
ERR_GET_RIEPILOGO_CONFERIMENTO:
    MsgBox Err.Description, vbCritical, "GET_RIEPILOGO_CONFERIMENTO"
End Sub

Private Sub Start_Liquidazione()
'On Error GoTo ERR_START_LIQUIDAZIONE
Dim sSQL As String
Cn.Execute "DELETE FROM RV_POTMPLiquidazioneRigheEla"


Screen.MousePointer = 11
    fncElaborazioneLiquidazione fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
Screen.MousePointer = 0

RegistrazioneLiquidazione

Exit Sub

ERR_START_LIQUIDAZIONE:
    Screen.MousePointer = 0
    MsgBox Err.Description, vbCritical, "START_LIQUIDAZIONE"
End Sub



'''''''''''''''''''''''''CALCOLO LIQUIDAZIONE'''''''''''''''''''''

Private Sub fncElaborazioneLiquidazione(IDCaricoMerceRighe As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsVend As DmtOleDbLib.adoResultset
Dim ArrayLiquidazione(100, 1) As Long
Dim ArrayVendite(100, 4) As Long
Dim RConf As Integer
Dim CConf As Integer
Dim RVend As Integer
Dim CVend As Integer

Cn.Execute "DELETE FROM RV_POTMPLiquidazione"
Cn.Execute "DELETE FROM RV_POTMPLiquidazioneRigheEla"
Cn.Execute "DELETE FROM RV_POTMPLiquidazioneRighe"



sSQL = "SELECT IDRV_POLiquidazione, IDRV_POLiquidazionePeriodo "
sSQL = sSQL & "FROM RV_POLiquidazioneRigheEla "
sSQL = sSQL & "WHERE (IDRV_POCaricoMerceRighe = " & IDCaricoMerceRighe & ") "
sSQL = sSQL & "GROUP BY IDRV_POLiquidazione, IDRV_POLiquidazionePeriodo"
    
    
'Eliminazione array Liquidazione
RConf = 0
CConf = 0

For RConf = 0 To 100
    ArrayLiquidazione(RConf, 0) = 0
    ArrayLiquidazione(RConf, 1) = 0
Next
    


Set rs = Cn.OpenResultset(sSQL)


RConf = 0
While Not rs.EOF
    CConf = 0
        
        ArrayLiquidazione(RConf, 0) = fnNotNullN(rs!IDRV_POLiquidazione)
        ArrayLiquidazione(RConf, 1) = fnNotNullN(rs!IDRV_POLiquidazionePeriodo)
    
    RConf = RConf + 1
    rs.MoveNext
    Wend
    rs.CloseResultset
    Set rs = Nothing
    
    RConf = 0
    CConf = 0

    For RConf = 0 To 100
        If ArrayLiquidazione(RConf, 0) > 0 Then
            sSQL = "SELECT RV_POLiquidazionePeriodo.IDRV_POLiquidazionePeriodo, RV_POLiquidazionePeriodo.Periodo, RV_POLiquidazionePeriodo.NumeroLiquidazione, "
            sSQL = sSQL & "RV_POLiquidazionePeriodo.DataInizio, RV_POLiquidazionePeriodo.DataFine, RV_POLiquidazionePeriodo.IDTipoImportoArticolo,"
            sSQL = sSQL & "RV_POLiquidazionePeriodo.IDSocio , Anagrafica.Anagrafica, Anagrafica.Nome, "
            sSQL = sSQL & "RV_POLiquidazionePeriodo.IDTipoImportoDocumento, RV_POLiquidazionePeriodo.IDTipoQuantita, "
            sSQL = sSQL & "RV_POLiquidazionePeriodo.ArticoliDiQuadratura, RV_POLiquidazionePeriodo.IDTipoLiquidazione,RV_POLiquidazionePeriodo.IDTipoPrezzoMedio "
            sSQL = sSQL & "FROM RV_POLiquidazionePeriodo LEFT OUTER JOIN "
            sSQL = sSQL & "Anagrafica ON RV_POLiquidazionePeriodo.IDSocio = Anagrafica.IDAnagrafica "
            sSQL = sSQL & "WHERE IDRV_POLiquidazionePeriodo=" & ArrayLiquidazione(RConf, 1)
        
            Set rs = Cn.OpenResultset(sSQL)
            
            If rs.EOF = False Then
                DATA_INIZIO = fnNotNull(rs!DataInizio)
                DATA_FINE = fnNotNull(rs!DataFine)
                LINK_SOCIO = fnNotNullN(rs!IDSocio)
                TIPO_IMPORTO_ARTICOLO = fnNotNullN(rs!IDTipoImportoArticolo)
                TIPO_IMPORTO_DOCUMENTO = fnNotNullN(rs!IDTipoImportoDocumento)
                TIPO_QUANTITA = fnNotNullN(rs!IDTipoQuantita)
                ARTICOLI_DI_QUAD = fnNormBoolean(fnNotNullN(rs!ArticoliDiQuadratura))
                TIPO_LIQUIDAZIONE = fnNotNullN(rs!IDTipoLiquidazione)
                TIPO_CALCOLO_PREZZO_MEDIO = fnNotNullN(rs!IDTipoPrezzoMedio)
                LINK_PERIODO = ArrayLiquidazione(RConf, 1)
                
                EsecuzioneElaborazione IDCaricoMerceRighe, ArrayLiquidazione(RConf, 0), ArrayLiquidazione(RConf, 1)
                
            End If
        End If

    Next

End Sub
Public Sub RegistrazioneLiquidazione()
    EliminazioneDatiLiquidazioneRegistrata
    
    Registrazione
    
    AggiornamentoTestataLiquidazione
    
End Sub

Private Sub EliminazioneDatiLiquidazioneRegistrata()
Dim sSQL As String
Dim rs As ADODB.Recordset

sSQL = "SELECT IDRV_POLiquidazionePeriodo, IDRV_POTMPLiquidazione, IDRV_POCaricoMerceRighe "
sSQL = sSQL & "FROM  RV_POTMPLiquidazioneRigheEla "
sSQL = sSQL & "GROUP BY IDRV_POLiquidazionePeriodo, IDRV_POTMPLiquidazione, IDRV_POCaricoMerceRighe"

Set rs = New ADODB.Recordset
rs.Open sSQL, Cn.InternalConnection

While Not rs.EOF
    
    sSQL = "DELETE FROM RV_POLiquidazioneRigheEla "
    sSQL = sSQL & "WHERE IDRV_POLiquidazione=" & fnNotNullN(rs!IDRV_POTMPLiquidazione)
    sSQL = sSQL & " AND IDRV_POLiquidazionePeriodo=" & fnNotNullN(rs!IDRV_POLiquidazionePeriodo)
    sSQL = sSQL & " AND IDRV_POCaricoMerceRighe=" & fnNotNullN(rs!IDRV_POCaricoMerceRighe)
    
    Cn.Execute sSQL

rs.MoveNext
Wend

rs.Close
Set rs = Nothing



End Sub
Private Sub Registrazione()
Dim sSQL As String
Dim rsEla As ADODB.Recordset
Dim rsUPD As ADODB.Recordset
Dim I As Integer

sSQL = "SELECT * FROM RV_POTMPLiquidazioneRigheEla "

Set rsEla = New ADODB.Recordset
Set rsUPD = New ADODB.Recordset

rsEla.Open sSQL, Cn.InternalConnection
rsUPD.Open "RV_POLiquidazioneRigheEla", Cn.InternalConnection, adOpenDynamic, adLockPessimistic
While Not rsEla.EOF
    rsUPD.AddNew
        rsUPD!IDRV_POLiquidazioneRigheEla = fnGetNewKey("RV_POLiquidazioneRigheEla", "IDRV_POLiquidazioneRigheEla")
        rsUPD!IDRV_POLiquidazione = rsEla!IDRV_POTMPLiquidazione
        rsUPD!IDRV_POLiquidazionePeriodo = rsEla!IDRV_POLiquidazionePeriodo
        For I = 2 To rsEla.Fields.Count - 1
            rsUPD.Fields(rsEla.Fields(I).Name) = rsEla.Fields(I).Value
        Next
    rsUPD.Update
rsEla.MoveNext
Wend
rsUPD.Close
Set rsUPD = Nothing

rsEla.Close
Set rsEla = Nothing
End Sub
Public Sub AggiornamentoTestataLiquidazione()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsAgg As DmtOleDbLib.adoResultset
Dim NettoLiquidazione As Double

sSQL = "SELECT IDRV_POTMPLiquidazione, IDRV_POLiquidazionePeriodo "
sSQL = sSQL & "FROM  RV_POTMPLiquidazioneRigheEla "
sSQL = sSQL & "GROUP BY IDRV_POTMPLiquidazione, IDRV_POLiquidazionePeriodo "


Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    sSQL = "SELECT SUM(ImponibileDaReg) AS TotaleDocumento, SUM(ImpostaDaReg) AS ImpostaDocumento, SUM(ImportoLordoDaReg) AS TotaleDocumentoLordoIva, "
    sSQL = sSQL & "SUM(TrattenutePerLavorazione) AS TrattenutaPerLavorazione, SUM(TrattenuteGenerali) AS TrattenutaGenerale, SUM(TrattenuteTotali) "
    sSQL = sSQL & "AS TrattenutaTotale "
    sSQL = sSQL & "FROM RV_POLiquidazioneRigheEla "
    sSQL = sSQL & "WHERE (IDRV_POLiquidazione = " & fnNotNullN(rs!IDRV_POTMPLiquidazione) & ")"
    
    Set rsAgg = Cn.OpenResultset(sSQL)
    
    If rsAgg.EOF = False Then
        TIPO_IMPORTO_DOCUMENTO = GET_PARAMETRO_TIPO_IMPORTO_DOCUMENTO(rs!IDRV_POLiquidazionePeriodo)
        If TIPO_IMPORTO_DOCUMENTO = 1 Then
            NettoLiquidazione = rsAgg!TotaleDocumento - rsAgg!TrattenutaTotale
        Else
            NettoLiquidazione = rsAgg!TotaleDocumentoLordoIva - rsAgg!TrattenutaTotale
        End If
            
        sSQL = "UPDATE RV_POLiquidazione SET "
        sSQL = sSQL & "TotaleDocumento = " & fnNormNumber(rsAgg!TotaleDocumento) & ", "
        sSQL = sSQL & "TotaleIva = " & fnNormNumber(rsAgg!ImpostaDocumento) & ", "
        sSQL = sSQL & "TotaleDocumentoLordoIva = " & fnNormNumber(rsAgg!TotaleDocumentoLordoIva) & ", "
        sSQL = sSQL & "TotaleTrattenutaPerLavorazione = " & fnNormNumber(rsAgg!TrattenutaPerLavorazione) & ", "
        sSQL = sSQL & "TotaleTrattenutaGenerale = " & fnNormNumber(rsAgg!TrattenutaGenerale) & ", "
        sSQL = sSQL & "TotaleTrattenuta = " & fnNormNumber(rsAgg!TrattenutaTotale) & ", "
        sSQL = sSQL & "NettoLiquidazione = " & fnNormNumber(NettoLiquidazione) & " "
        sSQL = sSQL & "WHERE IDRV_POLiquidazione=" & fnNotNullN(rs!IDRV_POTMPLiquidazione)
        
        Cn.Execute sSQL
    End If
    
    
    rsAgg.CloseResultset
    Set rsAgg = Nothing
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing

    
End Sub
Private Function GET_PARAMETRO_TIPO_IMPORTO_DOCUMENTO(IDPeriodoLiquidazione As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoImportoDocumento FROM RV_POLiquidazionePeriodo "
sSQL = sSQL & "WHERE IDRV_POLiquidazionePeriodo=" & IDPeriodoLiquidazione


Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_PARAMETRO_TIPO_IMPORTO_DOCUMENTO = 1
Else
    GET_PARAMETRO_TIPO_IMPORTO_DOCUMENTO = fnNotNullN(rs!IDTipoImportoDocumento)
End If

rs.CloseResultset
Set rs = Nothing
End Function

Public Function GET_ESISTENZA_ORDINE() As Long
Dim sSQL As String
Dim sSQL_WHERE As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT ValoriOggettoPerTipo000F.IDOggetto "
sSQL = sSQL & "FROM ValoriOggettoPerTipo000F INNER JOIN "
sSQL = sSQL & "Oggetto ON ValoriOggettoPerTipo000F.IDOggetto = Oggetto.IDOggetto "
sSQL = sSQL & "AND ValoriOggettoPerTipo000F.IDTipoOggetto = Oggetto.IDTipoOggetto "
sSQL = sSQL & "WHERE Doc_ordine_chiuso = 0 "
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
    
    If Me.cdCliente.KeyFieldID > 0 Then
        sSQL_WHERE = sSQL_WHERE & " AND Link_nom_anagrafica=" & Me.cdCliente.KeyFieldID
    End If
    
    If Me.txtNumeroOrdine.Value > 0 Then
        sSQL_WHERE = sSQL_WHERE & " AND Doc_numero=" & Me.txtNumeroOrdine.Value
    End If
    
    If Me.txtDataOrdine.Value > 0 Then
        sSQL_WHERE = sSQL_WHERE & " AND Doc_data=" & fnNormDate(Me.txtDataOrdine.Value)
    End If
    
    sSQL = sSQL & sSQL_WHERE & " ORDER BY Doc_data DESC, Doc_numero DESC"

Set rs = Cn.OpenResultset(sSQL)
If rs.EOF Then
    GET_ESISTENZA_ORDINE = 0
Else
    GET_ESISTENZA_ORDINE = fnNotNullN(rs!IDOggetto)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_NUMERO_LOTTO() As Long
Dim sSQL As String
Dim rs As ADODB.Recordset

sSQL = "SELECT NumerazioneLotto FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & TheApp.Branch

Set rs = New ADODB.Recordset

rs.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

If rs.EOF Then
    GET_NUMERO_LOTTO = 0
Else
    If (fnNotNullN(rs!NumerazioneLotto) + 1) < 10000000 Then
        GET_NUMERO_LOTTO = fnNotNullN(rs!NumerazioneLotto) + 1
        rs!NumerazioneLotto = fnNotNullN(rs!NumerazioneLotto) + 1
    Else
        GET_NUMERO_LOTTO = 1
        rs!NumerazioneLotto = 1
    End If
    rs.Update
End If

rs.Close
Set rs = Nothing
End Function
Private Function GetNumeroPedana(Anno As Long) As String
On Error GoTo ERR_GetNumeroPedana
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim CodicePedana As String
Dim NumeroPedana As Long
Dim X As Long
Dim ErroreCoda As Boolean


sSQL = "SELECT MAX(CodiceID) AS NumeroPedana FROM RV_POPedana "
sSQL = sSQL & "WHERE Anno=" & Anno
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDFiliale=" & TheApp.Branch

Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        CodicePedana = Anno & GET_CODICE_PEDANA(1)
        NumeroPedana = 1
    Else
        NumeroPedana = (fnNotNullN(rs!NumeroPedana) + 1)
        CodicePedana = Anno & GET_CODICE_PEDANA((fnNotNullN(rs!NumeroPedana) + 1))
    End If
    
rs.CloseResultset
Set rs = Nothing

LINK_PEDANA = fnGetNewKey("RV_POPedana", "IDRV_POPedana")
sSQL = "INSERT INTO RV_POPedana ("
sSQL = sSQL & "IDRV_POPedana, CodiceID, IDAzienda, IDFiliale, Anno, Mese, Giorno, IDRV_POTipoPedana, Codice) "
sSQL = sSQL & "VALUES ("
sSQL = sSQL & LINK_PEDANA & ", "
sSQL = sSQL & NumeroPedana & ","
sSQL = sSQL & TheApp.IDFirm & ", "
sSQL = sSQL & TheApp.Branch & ", "
sSQL = sSQL & DatePart("yyyy", Date) & ", "
sSQL = sSQL & Month(Date) & ", "
sSQL = sSQL & Day(Date) & ", "
sSQL = sSQL & GET_TIPO_PEDANA_DEFAULT & ", "
sSQL = sSQL & fnNormString(CodicePedana) & " "
sSQL = sSQL & ")"

Cn.Execute sSQL

GetNumeroPedana = CodicePedana
Exit Function
ERR_GetNumeroPedana:
    MsgBox Err.Description, vbCritical, "Nuova pedana"
    LINK_PEDANA = 0
    GetNumeroPedana = ""
End Function
Private Function GET_CODICE_PEDANA(NumeroPedana As String) As String
Dim I As Integer
Const MAX_CAR As Integer = 7
GET_CODICE_PEDANA = ""
For I = Len(NumeroPedana) + 1 To MAX_CAR
GET_CODICE_PEDANA = GET_CODICE_PEDANA & "0"
    
Next
GET_CODICE_PEDANA = GET_CODICE_PEDANA & NumeroPedana
End Function
Private Function GET_FUNZIONE(Gestore As String) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Funzione.IDFunzione "
sSQL = sSQL & "FROM Funzione INNER JOIN "
sSQL = sSQL & "TipoOggetto ON Funzione.IDTipoOggetto = TipoOggetto.IDTipoOggetto INNER JOIN "
sSQL = sSQL & "Gestore ON TipoOggetto.IDGestore = Gestore.IDGestore "
sSQL = sSQL & "WHERE Gestore.Gestore=" & fnNormString(Gestore)

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_FUNZIONE = 0
Else
    GET_FUNZIONE = fnNotNullN(rs!IDFunzione)
End If
End Function
Private Function GET_FUNZIONE_PER_TIPO_OGGETTO(IDTipoOggetto As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDFunzione "
sSQL = sSQL & "FROM Funzione  "
sSQL = sSQL & "WHERE IDTipoOggetto=" & IDTipoOggetto

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_FUNZIONE_PER_TIPO_OGGETTO = 0
Else
    GET_FUNZIONE_PER_TIPO_OGGETTO = fnNotNullN(rs!IDFunzione)
End If

rs.CloseResultset
Set rs = Nothing

End Function

Private Sub GET_CLIENTE_ORDINE_PRED()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDClienteCoop, DataOrdineCoop, NumeroOrdineCoop "
sSQL = sSQL & "FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & m_App.Branch

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    LINK_CLIENTE_ORD_PRED = 0
    DATA_ORDINE_PRED = ""
    NUMERO_ORDINE_PRED = 0
Else
    LINK_CLIENTE_ORD_PRED = fnNotNullN(rs!IDClienteCoop)
    DATA_ORDINE_PRED = fnNotNull(rs!DataOrdineCoop)
    NUMERO_ORDINE_PRED = fnNotNullN(rs!NumeroOrdineCoop)
End If

rs.CloseResultset
Set rs = Nothing
End Sub

Private Function GET_LISTINO_DEFAULT(IDAnagraficaCliente As Long, IDDestinazione As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsAzienda As DmtOleDbLib.adoResultset
Dim Link_Listino_Imballo As Long

GET_LISTINO_DEFAULT = 0


''''''LISTINO CLIENTE PER DESTINAZIONE'''''''''''''''''''''''''''''''''''''''''''''''''''
If IDDestinazione > 0 Then
    sSQL = "SELECT IDListino "
    sSQL = sSQL & "FROM RV_POConfigurazioneClienteListino "
    sSQL = sSQL & "WHERE IDAnagrafica=" & IDAnagraficaCliente
    sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
    sSQL = sSQL & " AND IDSitoPerAnagrafica=" & IDDestinazione
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_LISTINO_DEFAULT = 0
    Else
        GET_LISTINO_DEFAULT = fnNotNullN(rs!IDListino)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

If GET_LISTINO_DEFAULT > 0 Then Exit Function

''''''''''''''''''''LISTINO CLIENTE''''''''''''''''''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT IDListinoDefault "
sSQL = sSQL & "FROM Cliente "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDAnagraficaCliente
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LISTINO_DEFAULT = 0
Else
    GET_LISTINO_DEFAULT = fnNotNullN(rs!IDListinoDefault)
End If

rs.CloseResultset
Set rs = Nothing
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

If GET_LISTINO_DEFAULT > 0 Then Exit Function


'''''LISTINO NEI PARAMETRI DI GREENTOP''''''''''''''''''''''''''''''''''''''''''''''''''
GET_LISTINO_DEFAULT = GET_LISTINO_DEFAULT_PARAMETRI_AZIENDA
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
If GET_LISTINO_DEFAULT > 0 Then Exit Function

'''''''''''''''''''''''LISTINO AZIENDA'''''''''''''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT IDListinoDiBase "
sSQL = sSQL & "FROM ConfigurazioneVendite "
sSQL = sSQL & " WHERE IDAzienda=" & m_App.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LISTINO_DEFAULT = 0
Else
    GET_LISTINO_DEFAULT = fnNotNullN(rs!IDListinoDiBase)
End If
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
End Function

Private Function GET_LISTINO_DEFAULT_PARAMETRI_AZIENDA() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsAzienda As DmtOleDbLib.adoResultset

sSQL = "SELECT IDListinoImballiDefault "
sSQL = sSQL & "FROM RV_POSchemaCoop "
sSQL = sSQL & " WHERE IDFiliale=" & m_App.Branch

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LISTINO_DEFAULT_PARAMETRI_AZIENDA = 0
Else
    GET_LISTINO_DEFAULT_PARAMETRI_AZIENDA = fnNotNullN(rs!IDListinoImballiDefault)
    
End If
rs.CloseResultset
Set rs = Nothing

End Function
Private Function GET_PREZZO_IMBALLO(IDListino As Long, IDArticolo As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT PrezzoNettoIVA "
sSQL = sSQL & "FROM ListinoPerArticolo "
sSQL = sSQL & "WHERE IDListino=" & IDListino
sSQL = sSQL & " AND IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_PREZZO_IMBALLO = 0
Else
    GET_PREZZO_IMBALLO = fnNotNullN(rs!PrezzoNettoIva)
End If

rs.CloseResultset
Set rs = Nothing

End Function
Private Function GET_TIPO_PEDANA_DEFAULT() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDTipoPedanaDefault "
sSQL = sSQL & "FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & m_App.Branch


Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TIPO_PEDANA_DEFAULT = 0
Else
    GET_TIPO_PEDANA_DEFAULT = fnNotNullN(rs!IDTipoPedanaDefault)
    
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub txtTara_Q_LostFocus()
    If Link_UnitaDiMisura_Coop_Q = 4 Then
        Me.txtQta_UM_Q.Value = Me.txtTara_Q.Value
    End If
    
    CalcoloPesoNetto_Q
    
    GET_PERC_RESO
End Sub

Private Sub txtTaraConfImballo_LostFocus()
    txtColli_LostFocus
End Sub

Private Sub txtTaraUnitaria_Change()
    If B_LOADING_RIGA = True Then Exit Sub
    Me.txtTara.Value = Me.txtColli.Value * Me.txtTaraUnitaria.Value
    CalcoloPesoNetto
End Sub

Private Sub txtTaraUnitaria_LostFocus()
    Me.txtTara.Value = Me.txtColli.Value * Me.txtTaraUnitaria.Value
    CalcoloPesoNetto
End Sub
Private Function GET_CERTIFICAZIONE_SOCIO_PER_ETICHETTE(IDSocio As Long) As String
On Error Resume Next
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset


sSQL = "SELECT CodiceCertificazione, DescrizioneCertificazione, ProtocolloCertificazione, EnteCertificazione " '& NomeCampo
sSQL = sSQL & "FROM RV_PO01_CertificazioneSocio INNER JOIN "
sSQL = sSQL & "RV_PO01_Certificazione ON "
sSQL = sSQL & "RV_PO01_CertificazioneSocio.IDRV_PO01_Certificazione = RV_PO01_Certificazione.IDRV_PO01_Certificazione LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_EnteCertificazione ON RV_PO01_Certificazione.IDRV_PO01_EnteCertificazione = RV_PO01_EnteCertificazione.IDRV_PO01_EnteCertificazione "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDSocio
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)

Set rs = Cn.OpenResultset(sSQL)

ENTE_CERTIFICAZIONE_SOCIO_ETI = ""
CODICE_CERTIFICAZIONE_SOCIO_ETI = ""
DESCRIZIONE_CERTIFICAZIONE_SOCIO_ETI = ""
PROTOCOLLO_CERTIFICAZIONE_SOCIO_ETI = ""

If rs.EOF Then
    ENTE_CERTIFICAZIONE_SOCIO_ETI = ""
    CODICE_CERTIFICAZIONE_SOCIO_ETI = ""
    DESCRIZIONE_CERTIFICAZIONE_SOCIO_ETI = ""
    PROTOCOLLO_CERTIFICAZIONE_SOCIO_ETI = ""
Else
    ENTE_CERTIFICAZIONE_SOCIO_ETI = fnNotNull(rs!EnteCertificazione)
    CODICE_CERTIFICAZIONE_SOCIO_ETI = fnNotNull(rs!CodiceCertificazione)
    DESCRIZIONE_CERTIFICAZIONE_SOCIO_ETI = fnNotNull(rs!DescrizioneCertificazione)
    PROTOCOLLO_CERTIFICAZIONE_SOCIO_ETI = fnNotNull(rs!ProtocolloCertificazione)
End If


rs.CloseResultset
Set rs = Nothing

End Function

Private Function GET_CERTIFICAZIONE_LOTTO_CAMPAGNA_PER_ETICHETTE(IDLottoDiCampagna As Long) As String
On Error Resume Next
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT RV_PO01_LottoCampagna.IDRV_PO01_LottoCampagna,RV_PO01_LottoCampagna.IDRV_PO01_CertificazioneSocio, RV_PO01_LottoCampagna.ProtocolloCertificazione, "
sSQL = sSQL & "RV_PO01_Certificazione.CodiceCertificazione, RV_PO01_Certificazione.DescrizioneCertificazione, "
sSQL = sSQL & "RV_PO01_Certificazione.IDRV_PO01_EnteCertificazione , RV_PO01_EnteCertificazione.EnteCertificazione "
sSQL = sSQL & "FROM RV_PO01_EnteCertificazione RIGHT OUTER JOIN "
sSQL = sSQL & "RV_PO01_Certificazione ON "
sSQL = sSQL & "RV_PO01_EnteCertificazione.IDRV_PO01_EnteCertificazione = RV_PO01_Certificazione.IDRV_PO01_EnteCertificazione RIGHT OUTER JOIN "
sSQL = sSQL & "RV_PO01_LottoCampagna ON RV_PO01_Certificazione.IDRV_PO01_Certificazione = RV_PO01_LottoCampagna.IDRV_PO01_CertificazioneSocio "
sSQL = sSQL & "WHERE RV_PO01_LottoCampagna.IDRV_PO01_LottoCampagna=" & IDLottoDiCampagna

Set rs = Cn.OpenResultset(sSQL)

ENTE_CERTIFICAZIONE_LOTTO_ETI = ""
CODICE_CERTIFICAZIONE_LOTTO_ETI = ""
DESCRIZIONE_CERTIFICAZIONE_LOTTO_ETI = ""
PROTOCOLLO_CERTIFICAZIONE_LOTTO_ETI = ""

If rs.EOF Then
    ENTE_CERTIFICAZIONE_LOTTO_ETI = ""
    CODICE_CERTIFICAZIONE_LOTTO_ETI = ""
    DESCRIZIONE_CERTIFICAZIONE_LOTTO_ETI = ""
    PROTOCOLLO_CERTIFICAZIONE_LOTTO_ETI = ""
Else
    ENTE_CERTIFICAZIONE_LOTTO_ETI = fnNotNull(rs!EnteCertificazione)
    CODICE_CERTIFICAZIONE_LOTTO_ETI = fnNotNull(rs!CodiceCertificazione)
    DESCRIZIONE_CERTIFICAZIONE_LOTTO_ETI = fnNotNull(rs!DescrizioneCertificazione)
    PROTOCOLLO_CERTIFICAZIONE_LOTTO_ETI = fnNotNull(rs!ProtocolloCertificazione)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_DATI_LOTTO_CAMPAGNA_PER_ETICHETTE(IDLottoDiCampagna As Long) As String
On Error Resume Next
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset


'If GET_ESISTENZA_BIO(2) = False Then
'    LINK_VARIETA_LOTTO_CAMPAGNA = 0
'    LINK_FAMIGLIA_LOTTO_CAMPAGNA = 0
'    VARIETA_LOTTO_CAMPAGNA = ""
'    FAMIGLIA_LOTTO_CAMPAGNA = ""
'    Exit Function
'End If

sSQL = "SELECT RV_PO01_LottoCampagna.IDRV_PO01_LottoCampagna, RV_PO01_LottoCampagna.IDRV_PO01_FamigliaProdotti, "
sSQL = sSQL & "RV_PO01_LottoCampagna.IDRV_PO01_Varieta, RV_PO01_FamigliaProdotti.FamigliaProdotti, RV_PO01_Varieta.Varieta,"
sSQL = sSQL & "RV_PO01_TipoProduzione.TipoProduzione , RV_PO01_LottoCampagna.IDRV_PO01_TipoProduzione "
sSQL = sSQL & "FROM RV_PO01_LottoCampagna LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_TipoProduzione ON "
sSQL = sSQL & "RV_PO01_LottoCampagna.IDRV_PO01_TipoProduzione = RV_PO01_TipoProduzione.IDRV_PO01_TipoProduzione LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_Varieta ON RV_PO01_LottoCampagna.IDRV_PO01_Varieta = RV_PO01_Varieta.IDRV_PO01_Varieta LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_FamigliaProdotti ON RV_PO01_LottoCampagna.IDRV_PO01_FamigliaProdotti = RV_PO01_FamigliaProdotti.IDRV_PO01_FamigliaProdotti "
sSQL = sSQL & "WHERE IDRV_PO01_LottoCampagna=" & IDLottoDiCampagna

Set rs = Cn.OpenResultset(sSQL)

LINK_VARIETA_LOTTO_CAMPAGNA = 0
LINK_FAMIGLIA_LOTTO_CAMPAGNA = 0
LINK_TIPO_PRODUZIONE_LOTTO_CAMPAGNA = 0
VARIETA_LOTTO_CAMPAGNA = ""
FAMIGLIA_LOTTO_CAMPAGNA = ""
TIPO_PRODUZIONE_LOTTO_CAMPAGNA = ""

If rs.EOF Then
    LINK_VARIETA_LOTTO_CAMPAGNA = 0
    LINK_FAMIGLIA_LOTTO_CAMPAGNA = 0
    LINK_TIPO_PRODUZIONE_LOTTO_CAMPAGNA = 0
    VARIETA_LOTTO_CAMPAGNA = ""
    FAMIGLIA_LOTTO_CAMPAGNA = ""
    TIPO_PRODUZIONE_LOTTO_CAMPAGNA = ""
Else
    LINK_VARIETA_LOTTO_CAMPAGNA = fnNotNullN(rs!IDRV_PO01_Varieta)
    LINK_FAMIGLIA_LOTTO_CAMPAGNA = fnNotNullN(rs!IDRV_PO01_FamigliaProdotti)
    VARIETA_LOTTO_CAMPAGNA = fnNotNull(rs!Varieta)
    FAMIGLIA_LOTTO_CAMPAGNA = fnNotNull(rs!FamigliaProdotti)
    LINK_TIPO_PRODUZIONE_LOTTO_CAMPAGNA = fnNotNullN(rs!IDRV_PO01_TipoProduzione)
    TIPO_PRODUZIONE_LOTTO_CAMPAGNA = fnNotNull(rs!TipoProduzione)
End If

rs.CloseResultset
Set rs = Nothing
End Function


Public Function GET_NOMECOMPUTER() As String
Dim dwLen As Long
Dim strString As String
Const MAX_COMPUTERNAME_LENGTH As Long = 31
    
    'Create a buffer
    dwLen = MAX_COMPUTERNAME_LENGTH + 1
    strString = String(dwLen, "X")
    'Get the computer name
    GetComputerName strString, dwLen
    'get only the actual data
    strString = Left(strString, dwLen)
    'Show the computer name
    GET_NOMECOMPUTER = strString
End Function

Function GET_NOMEUTENTE() As String
    Dim strString As String
    Dim lunghezzaStringa As Long
    lunghezzaStringa = 32
    strString = String(lunghezzaStringa, " ")
    GetUserName strString, lunghezzaStringa
    strString = Left(strString, lunghezzaStringa)
    GET_NOMEUTENTE = strString
    GET_NOMEUTENTE = Mid(GET_NOMEUTENTE, 1, Len(GET_NOMEUTENTE) - 1)
End Function

'**+
'Nome: SendDocument
'
'Parametri:
'
'Valori di ritorno:
'
'Funzionalità:
'Esegue l'esportazione del documento con controllo di errore
'**/
Private Sub SendDocument(ByVal Appl As Long)
    On Error GoTo errHandler
    
    Dim OLDCursor As Integer
    
    OLDCursor = Screen.MousePointer
    
    Screen.MousePointer = vbHourglass
    m_Document.SendMail m_Report, Appl
    Screen.MousePointer = OLDCursor
    Exit Sub
errHandler:
    Screen.MousePointer = OLDCursor
    
    If Err.Number = 20507 Then
        'Errore "Invalid file Name" generato quando non è possibile trovare il file .rpt
        sbMsgInfo "File di report non trovato", m_App.FunctionName
    Else
        sbMsgInfo Err.Description, m_App.FunctionName
    End If
End Sub

'**+
'Autore                     : Diamante s.p.a
'Data creazione             :
'Nome                       : InitSemaphore
'
'Parametri                  :
'
'Funzionalità               : Attiva/disattiva le attività del Riquadro attività
'
'**/
Private Sub EnableDOMActivitiesItems()
    oFiltersActivity.EnableItems (BrwMain.GuiMode = dgNormal And BrwMain.Visible)
    oTableViewsActivity.EnableItems (BrwMain.GuiMode = dgNormal And BrwMain.Visible)
    
    ActivityBox.Redraw = True
End Sub
'**+
'Autore                     : Diamante s.p.a
'Data creazione             :
'Nome                       : ActivityBox_CloseButtonPressed
'
'Parametri                  :
'
'Funzionalità               : Gestione della chiusura del Riquadro attività
'
'**/
Private Sub ActivityBox_CloseButtonPressed()
    OnFolders
End Sub

'**+
'Autore                     : Diamante s.p.a
'Data creazione             :
'Nome                       : ActivityBox_ItemSelected
'
'Parametri                  :
'
'Funzionalità               : Gestione della selezione delle voci del Riquadro attività
'
'**/
Private Sub ActivityBox_ItemSelected(ByVal Item As DmtActBoxTlb.Item, NeedRedraw As Boolean)
    Dim oFilter As Filter
    Dim oTableView As TableView
    
    If BrwMain.Visible And BrwMain.GuiMode = dgNormal Then
        Select Case ActivityBox.CurrentActivity.Caption
            Case "Filtri"
                For Each oFilter In m_DocType.Filters
                    If oFilter.ID = Val(Item.Tag) Then
                        Set m_ActiveFilter = m_DocType.Filters(oFilter.Name)
                        Exit For
                    End If
                Next
                'Flag usato per specificare che deve essere eseguito un filtro permanente.
                m_FilterSelected = True
                
                '---Modalità Filtro---
                'Ripulisce i campi di immissione delle condizioni di ricerca.
                BrwMain.Conditions.ClearValues
                
                'Se attivo, viene disabilitato il pulsante Salva Filtro del DocTypeExplorer.
                oFiltersActivity.AbortNewFilter
                ActivityBox.Redraw = True
                
                'Viene eseguita la ricerca basata sul nuovo filtro.
                ExecuteSearch

            Case "Viste tabellari"
                For Each oTableView In m_DocType.TableViews
                    If oTableView.ID = Val(Item.Tag) Then
                        Set m_ActiveTableView = m_DocType.TableViews(oTableView.Name)
                        Exit For
                    End If
                Next
                BrwMain.LoadColumns m_ActiveTableView
                SetVisibilityIDFields
        End Select
    End If
    If ActivityBox.CurrentActivity.Caption = "Esportazioni" Then
        If Item.Hyperlink Then
            Select Case Item.Name
                Case "E" & ExportConstants.PDF
                    ExecuteMenuCommand "ExportPDF"
                Case "E" & ExportConstants.Word
                    ExecuteMenuCommand "ExportWord"
                Case "E" & ExportConstants.Excel
                    ExecuteMenuCommand "ExportExcel"
                Case "E" & ExportConstants.HTML
                    ExecuteMenuCommand "ExportHtml"
                Case "S" & ExportConstants.PDF
                    ExecuteMenuCommand "MailPDF"
                Case "S" & ExportConstants.Word
                    ExecuteMenuCommand "MailWord"
                Case "S" & ExportConstants.Excel
                    ExecuteMenuCommand "MailExcel"
                Case "S" & ExportConstants.HTML
                    ExecuteMenuCommand "MailHtml"
            End Select
        End If
    End If
End Sub
Private Sub BarMenu_QueryUnload(Cancel As Integer)
    Cancel = True
End Sub

Private Sub BarMenu_Resize(ByVal Left As Long, ByVal Top As Long, ByVal Width As Long, ByVal Height As Long)
    Form_Resize
End Sub

Private Sub BarMenu_ToolClick(ByVal Tool As ActiveBar3LibraryCtl.Tool)
    Dim iKeyCode As Integer
    Dim iShift As Integer
    Dim bContinue As Boolean
    
    On Error GoTo BarMenu_ClickError
        
    'Forza il lostfocus ed attende l'esecuzione di eventuali eventi associati
    AutoLostFocus
        
    bContinue = True
    iShift = GetShift(Tool)
    iKeyCode = GetKeyCode(Tool)
    
    If iKeyCode <> 0 Or iShift <> 0 Then
        bContinue = Not ShortCut(iKeyCode, iShift)
        If bContinue Then
            SendKeys GetSendKeys(Tool) & "(" & GetKey(Tool) & ")"      '"^(R)"
        End If
    Else
        ExecuteMenuCommand Tool.Name
    End If
    
    Exit Sub
    
BarMenu_ClickError:
    If Err.Number = ERR_NDELFILTER Then
        'In seguito a particolari sequenze di eventi può risultare abilitato il cancella filtro sul
        'filtro di default. Se si esegue la cancellazione viene sollevata una eccezione.
        sbMsgError "Non è possibile eliminare il filtro di default.", m_App.FunctionName
    Else
        sbMsgError Err.Description, m_App.FunctionName
    End If
    
    Resume Next
End Sub
Private Sub fnDefaultReport()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
    
sSQL = "SELECT IDReportPerTipoOggetto, Stampante FROM RV_POEtichetteDefault "
sSQL = sSQL & "WHERE Predefinito=" & fnNormBoolean(1)
sSQL = sSQL & " AND IDUtente=" & TheApp.IDUser
sSQL = sSQL & " AND NomeComputer=" & fnNormString(NOME_COMPUTER)
sSQL = sSQL & " AND IDRV_POTipoEtichetta=1"
Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    LINK_REPORT_LAV_DEFAULT = fnNotNullN(rs!IDReportPerTipoOggetto)
    STAMPANTE_LAVORAZIONE = fnNotNull(rs!Stampante)
Else
    LINK_REPORT_LAV_DEFAULT = 0
    STAMPANTE_LAVORAZIONE = ""
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub fnDefaultReportPedana()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
    
sSQL = "SELECT IDReportPerTipoOggetto, Stampante FROM RV_POEtichetteDefault "
sSQL = sSQL & "WHERE Predefinito=" & fnNormBoolean(1)
sSQL = sSQL & " AND IDUtente=" & TheApp.IDUser
sSQL = sSQL & " AND NomeComputer=" & fnNormString(NOME_COMPUTER)
sSQL = sSQL & " AND IDRV_POTipoEtichetta=2"
Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    LINK_REPORT_PED_DEFAULT = fnNotNullN(rs!IDReportPerTipoOggetto)
    STAMPANTE_PEDANA = fnNotNull(rs!Stampante)
Else
    LINK_REPORT_PED_DEFAULT = 0
    STAMPANTE_PEDANA = ""
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub StampaEtichette()
On Error GoTo ERR_CmdStampaEtichette_Click
Dim IDReport As Long
Dim Stampante As String
Dim Pr As Printer
Dim NomeStampantePredefinita As String
Dim IDTipoOggettoPrg As Long


        

        IDTipoOggettoPrg = fncIDTipoOggettoPrg("RV_POEtichetteLavorazione")
        
        NomeStampantePredefinita = Printer.DeviceName
            
        Set oReport = New dmtReportLib.dmtReport
            Set oReport.Connection = Cn
            If MenuOptions.DBType = 1 Then
                'parametri di accesso al database ACCESS
                oReport.Password = "dmt192981046"
                oReport.User = "admin"
            Else
                'parametri di accesso al database SQL Server
                oReport.Password = TheApp.Password
                oReport.User = TheApp.User
            End If
        
        
        'Imposta l'idfiliale di appartenenza del documento da stampare
            oReport.BranchID = TheApp.Branch 'IDFiliale
        'Imposta l'identificativo del tipo di documento
            oReport.DocTypeID = IDTipoOggettoPrg
                
            oReport.Where = "IDUtente=" & TheApp.IDUser
            
            'IDReport = LINK_REPORT_LAV_DEFAULT
            IDReport = Me.cboReport.CurrentID
            
            If IDReport > 0 Then
                fncImpostaDefaultReport IDReport, IDTipoOggettoPrg
                        
                    
                'Stampante = STAMPANTE_LAVORAZIONE
                Stampante = Me.cboStampa.Text
                If Stampante <> NomeStampantePredefinita Then
                    For Each Pr In Printers
                        If Pr.DeviceName = Stampante Then
                            If WinNTSetDefaultPrinter(Pr.DeviceName) = True Then
                                Exit For
                            Else
                                MsgBox "Problemi con la stampante " & Me.cboStampa.Text 'STAMPANTE_LAVORAZIONE
                                Exit Sub
                            End If
                        End If
                    Next
                End If
                'oReport.Copies = Me.txtColli.Value
                oReport.Copies = Me.txtNumeroEtichette.Value
                
                oReport.DoPrint Stampante
                
                If Stampante <> NomeStampantePredefinita Then
                    WinNTSetDefaultPrinter NomeStampantePredefinita
                End If
                
                
                StampaEtichettaPDF_DMT oReport
            Else
                
                MsgBox "ATTENZIONE!!!!" & vbCrLf & "Il report non è stato trovato!", vbCritical, "Impossibile stampare"
            
            End If

Exit Sub
ERR_CmdStampaEtichette_Click:
MsgBox Err.Description, vbCritical, "Errore nella stampa delle etichette"

If Stampante <> NomeStampantePredefinita Then
    WinNTSetDefaultPrinter NomeStampantePredefinita
End If

  
    
End Sub

Private Function fncIDTipoOggettoPrg(Gestore As String) As Long
    Dim rs As DmtOleDbLib.adoResultset
    Dim sSQL As String
    
    sSQL = "SELECT TipoOggetto.IDTipoOggetto, Gestore.Gestore"
    sSQL = sSQL & " FROM Gestore INNER JOIN TipoOggetto ON Gestore.IDGestore = TipoOggetto.IDGestore"
    sSQL = sSQL & " WHERE (((Gestore.Gestore)=" & fnNormString(Gestore) & "))"
    
    Set rs = Cn.OpenResultset(sSQL)
        
    If rs.EOF = False Then
        fncIDTipoOggettoPrg = rs!IDTipoOggetto
    Else
        fncIDTipoOggettoPrg = 0
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End Function

Private Function fncTrovaReport(IDReport As String, IDTipoOggetto As Long) As Long
On Error GoTo ERR_fncTrovaReport
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDReportTipoOggetto FROM ReportTipoOggetto "
sSQL = sSQL & "WHERE ((ReportTipoOggetto=" & fnNormString(IDReport) & ") AND (IDTipoOggetto=" & IDTipoOggetto & "))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    fncTrovaReport = fnNotNullN(rs!IDReportTipoOggetto)
Else
    fncTrovaReport = 1
End If

rs.CloseResultset
Set rs = Nothing

Exit Function
ERR_fncTrovaReport:
    MsgBox Err.Description, vbCritical, "Trova report per stampa"
    fncTrovaReport = 0

End Function
Private Function fncImpostaDefaultReport(ByVal IDReportDefault As Long, IDTipoOggetto As Long)
On Error GoTo ERR_fncImpostaDefaultReport
    Dim sSQL As String
    
    sSQL = "UPDATE DefaultFilialePerTipoOggetto SET "
    sSQL = sSQL & "IDReportTipoOggetto=" & IDReportDefault
    sSQL = sSQL & " WHERE IDTipoOggetto = " & IDTipoOggetto & " AND IDFiliale = " & TheApp.Branch
    
    Cn.Execute sSQL
    
Exit Function
ERR_fncImpostaDefaultReport:
    MsgBox Err.Description, vbCritical, "Settaggio report di default"
End Function
Private Function WinNTSetDefaultPrinter(ByRef DeviceName As String) As Boolean
    Dim Buffer As String
    Dim DriverName As String
    Dim PrinterPort As String
    Dim R As Long
   
    If DeviceName <> "" Then
        'Preleva le informazioni sulla stampante desiderata dal file WIN.INI file.
        Buffer = Space(1024)
        R = GetProfileString("PrinterPorts", DeviceName, "", Buffer, Len(Buffer))
       
        'Esegue il parsing della stringa ricavata dalla chiamata precedente...
        Call GetDriverAndPort(Buffer, DriverName, PrinterPort)
        If DriverName <> "" And PrinterPort <> "" Then
            WinNTSetDefaultPrinter = SetDefaultPrinter(DeviceName, DriverName, PrinterPort)
        Else
            WinNTSetDefaultPrinter = False
        End If
    End If
End Function
Private Sub GetDriverAndPort(ByVal Buffer As String, ByRef DriverName As String, ByRef PrinterPort As String)
    Dim iDriver As Integer
    Dim iPort As Integer
   
    DriverName = ""
    PrinterPort = ""
 
    'Il nome del driver è la prima stringa delimitata dalla ","
    iDriver = InStr(Buffer, ",")
    If iDriver > 0 Then
        DriverName = Left(Buffer, iDriver - 1)
        'Il numero di porta è tra le due ","
        iPort = InStr(iDriver + 1, Buffer, ",")
        If iPort > 0 Then
            PrinterPort = Mid(Buffer, iDriver + 1, iPort - iDriver - 1)
        End If
    End If
End Sub
Private Function SetDefaultPrinter(ByVal DeviceName As String, ByVal DriverName As String, ByVal PrinterPort As String) As Boolean
    Dim DeviceLine As String
    Dim R As Long
    Dim l As Long
   
    DeviceLine = DeviceName & "," & DriverName & "," & PrinterPort
    'Memorizza le informazioni della stampante nella sezione  [WINDOWS] del file Win.ini alla voce DEVICE
    R = WriteProfileString("windows", "Device", DeviceLine)
   
    If R Then
        'Avverte tutte le applicazioni attive che il file .INI è cambiato:
        'l = SendMessage(HWND_BROADCAST, WM_WININICHANGE, 0, "windows")
        SetDefaultPrinter = True
    Else
        SetDefaultPrinter = False
    End If
End Function

Private Function GET_BNDOO(IDFiliale As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
sSQL = "SELECT BNDOO FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & IDFiliale

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_BNDOO = ""
Else
    GET_BNDOO = Trim(fnNotNull(rs!BNDOO))
End If
    
    
    
rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_CODICEFORNITORE(IDFiliale As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
sSQL = "SELECT CodiceAssociato FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & IDFiliale

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_CODICEFORNITORE = ""
Else
    GET_CODICEFORNITORE = Trim(fnNotNull(rs!CodiceAssociato))
End If
    
    
    
rs.CloseResultset
Set rs = Nothing
End Function


Private Function GET_CODICEABARRE(IDArticolo As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim CodiceABarreDaPassare As String

sSQL = "SELECT CodiceBarre FROM ArticoloPerTipoCodiceBarre "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)
sSQL = sSQL & " AND IDTipoCodiceBarre=13"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_CODICEABARRE = ""
Else
    If Len((fnNotNull(Trim(rs!CodiceBarre)))) <= 11 Then
        GET_CODICEABARRE = ""
    End If
    If Len((fnNotNull(Trim(rs!CodiceBarre)))) > 13 Then
        GET_CODICEABARRE = ""
    End If
    If Len((fnNotNull(Trim(rs!CodiceBarre)))) = 13 Then
        CodiceABarreDaPassare = Mid(fnNotNull(Trim(rs!CodiceBarre)), 1, Len(fnNotNull(Trim(rs!CodiceBarre))) - 1)
        GET_CODICEABARRE = ean13$(CodiceABarreDaPassare)
    End If
    If Len((fnNotNull(Trim(rs!CodiceBarre)))) = 12 Then
        GET_CODICEABARRE = ean13$((fnNotNull(Trim(rs!CodiceBarre))))
    End If
End If

rs.CloseResultset
Set rs = Nothing

End Function
Private Function GET_DESCRIZIONECODICEABARRE(IDArticolo As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT CodiceBarre FROM ArticoloPerTipoCodiceBarre "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)
sSQL = sSQL & " AND IDTipoCodiceBarre=13"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_DESCRIZIONECODICEABARRE = ""
Else
    GET_DESCRIZIONECODICEABARRE = fnNotNull(Trim(rs!CodiceBarre))
    
End If

rs.CloseResultset
Set rs = Nothing


End Function

Private Function AggiornaEtichetteStampate(IDLavorazione As Long, ColliDaStampare As Long)
Dim sSQL As String
Dim rs As ADODB.Recordset

Set rs = New ADODB.Recordset

sSQL = "SELECT * FROM RV_POEtichetteLavorazione WHERE IDRV_POLavorazione=" & IDLavorazione

rs.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

If rs.EOF Then
    rs.AddNew
    rs!IDRV_POLavorazione = IDLavorazione
    rs!ColliStampati = ColliDaStampare
    rs!DataUltimaStampa = Date
    rs!OraUltimaStampa = time
    rs!NumeroUltimaStampa = ColliDaStampare
Else
    rs!ColliStampati = fnNotNullN(rs!ColliStampati) + ColliDaStampare
    rs!DataUltimaStampa = Date
    rs!OraUltimaStampa = time
    rs!NumeroUltimaStampa = ColliDaStampare

End If
    
    rs.Update
        
    
rs.Close
Set rs = Nothing
End Function
Private Sub CREA_PEDANA_PER_STAMPA(IDCodicePedana As String, PedanaAzienda As Boolean)
On Error GoTo ERR_CREA_PEDANA_PER_STAMPA
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim rsNew As ADODB.Recordset
Dim cmdPedana As ADODB.Command
Dim Prm1 As ADODB.Parameter
Dim Prm2 As ADODB.Parameter
Dim Prm3 As ADODB.Parameter
Dim OLD_Cursor As Long

'ELIMINAZIONE DATI TABELLA ETICHETTA PER UTENTE'''''''''''''''
    sSQL = "DELETE FROM RV_POTMPStampaEtichetteRighe "
    sSQL = sSQL & "WHERE IDUtente=" & TheApp.IDUser
    Cn.Execute sSQL
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Set rs = New ADODB.Recordset
Set rsNew = New ADODB.Recordset

OLD_Cursor = Cn.CursorLocation
Cn.CursorLocation = adUseClient

sSQL = "SELECT * FROM RV_POIEStampaEtichette "  '
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDFiliale=" & TheApp.IDFirm
If PedanaAzienda = True Then
    sSQL = sSQL & " AND IDRV_POPedana=" & IDCodicePedana
Else
    sSQL = sSQL & " AND NumeroPedanaCliente=" & IDCodicePedana
End If

rs.Open sSQL, Cn.InternalConnection


rsNew.Open "RV_POTMPStampaEtichetteRighe", Cn.InternalConnection, adOpenDynamic, adLockPessimistic
Screen.MousePointer = 11


Cn.BeginTrans
If rs.EOF = False Then
    DoEvents
    While Not rs.EOF
        rsNew.AddNew
            'CAMPI OBBLIGATORI
            rsNew!IDUtente = TheApp.IDUser
            rsNew!IDAzienda = TheApp.IDFirm
            rsNew!IDFiliale = TheApp.Branch
            rsNew!IDRV_POAssegnazioneMerce = fnNotNullN(rs!IDRV_POAssegnazioneMerce)
            
            rsNew!IDRV_POPedana = fnNotNullN(rs!IDRV_POPedana)
            rsNew!CodicePedana = fnNotNull(rs!CodicePedana)

            'CAMPI LAVORAZIONE
            rsNew!IDArticolo = fnNotNullN(rs!IDArticolo)
            rsNew!CodiceArticolo = fnNotNull(rs!CodiceArticolo)
            rsNew!Articolo = fnNotNull(rs!Articolo)
            rsNew!IDArticoloImballo = fnNotNullN(rs!IDImballoVendita)
            rsNew!CodiceImballo = fnNotNull(rs!CodiceImballoVendita)
            rsNew!Imballo = fnNotNull(rs!ImballoVendita)
            rsNew!Colli = fnNotNullN(rs!Colli)
            rsNew!PesoLordo = fnNotNullN(rs!PesoLordo)
            rsNew!Tara = fnNotNullN(rs!Tara)
            rsNew!PesoNetto = fnNotNullN(rs!PesoNetto)
            rsNew!Pezzi = fnNotNullN(rs!Pezzi)
            rsNew!Qta_UM = fnNotNullN(rs!Qta_UM)
            rsNew!CodiceLotto = fnNotNull(rs!CodiceLottoVendita)
            rsNew!IDAnagraficaSocio = fnNotNullN(rs!IDAnagraficaSocio)
            rsNew!AnagraficaSocio = fnNotNull(rs!AnagraficaSocio)
            rsNew!NomeSocio = fnNotNull(rs!NomeSocio)
            rsNew!CodiceSocio = fnNotNull(rs!CodiceSocio)
            rsNew!IDRV_POCalibro = fnNotNullN(rs!IDRV_POCalibro)
            rsNew!Calibro = fnNotNull(rs!Calibro)
            rsNew!IDRV_POTipoCategoria = fnNotNullN(rs!IDRV_POTipoCategoria)
            rsNew!TipoCategoria = fnNotNull(rs!TipoCategoria)
            rsNew!CodiceABarreArticolo = fnNotNull(rs!CodiceABarreArticoloPred)
            rsNew!CodiceABarreImballoAzienda = fnNotNull(rs!CodiceABarreImballoPred)
            rsNew!DescrizioneCodiceABarreArticoloAzienda = fnNotNull(rs!DescrizioneCodiceABarreArticoloPred)
            rsNew!DescrizioneCodiceABarreImballoAzienda = fnNotNull(rs!DescrizioneCodiceABarreImballoPred)
            rsNew!LinguaPredefinita = fnNotNull(rs!LinguaPredefinita)
            rsNew!CodicePostazioneUtente = fnNotNull(rs!CodiceUtente)
            rsNew!DataOrdine = fnNotNull(rs!DataOrdine)
            rsNew!NumeroOrdine = fnNotNullN(rs!NumeroOrdine)
            If Len(fnNotNull(rs!DataOrdinePressoCliente)) > 0 Then
                rsNew!DataOrdinePressoCliente = fnNotNull(rs!DataOrdinePressoCliente)
            End If
            rsNew!NumeroOrdinePressoCliente = fnNotNull(rs!NumeroOrdinePressoCliente)

            If Trim(fnNotNull(rs!DescrizioneArticoloInLinguaPred)) <> "" Then
                rsNew!DescrizioneArticoloInLinguaPredefinita = fnNotNull(rs!DescrizioneArticoloInLinguaPred)
            Else
                rsNew!DescrizioneArticoloInLinguaPredefinita = fnNotNull(rs!Articolo)
            End If
            If Trim(fnNotNull(rs!DescrizioneCalibroInLinguaPred)) <> "" Then
                rsNew!DescrizioneCalibroInLinguaPredefinita = fnNotNull(rs!DescrizioneCalibroInLinguaPred)
            Else
                rsNew!DescrizioneCalibroInLinguaPredefinita = fnNotNull(rs!Calibro)
            End If
            If Trim(fnNotNull(rs!DescrizioneCategoriaInLinguaPred)) <> "" Then
                rsNew!DescrizioneCategoriaInLinguaPredefinita = fnNotNull(rs!DescrizioneCategoriaInLinguaPred)
            Else
                rsNew!DescrizioneCategoriaInLinguaPredefinita = fnNotNull(rs!TipoCategoria)
            End If
            rsNew!Regione = fnNotNull(rs!Regione_Merce)
            rsNew!Nazione = fnNotNull(rs!Nazione_Merce)
            rsNew!Comune = fnNotNull(rs!Comune_Merce)
            rsNew!Provincia = fnNotNull(rs!Provincia_Merce)
            rsNew!UnitaDiMisuraArticoloLavorato = fnNotNull(rs!UnitaDiMisuraArticoloLavorato)
            

            'DATI CONFERIMENTO
            rsNew!LottoDiConferimento = Me.txtCodiceLotto_Conf.Text
            rsNew!BNDOO = BNDOO 'Me.txtBNDOO.Text
            rsNew!IDLottoDiCampagna = fnNotNullN(m_Document("IDLottoDiCampagna").Value)
            rsNew!CodiceCertificazioneLotto = CODICE_CERTIFICAZIONE_LOTTO_ETI
            rsNew!DescrizioneCertificazioneLotto = DESCRIZIONE_CERTIFICAZIONE_LOTTO_ETI
            rsNew!ProtocolloCertificazioneLotto = PROTOCOLLO_CERTIFICAZIONE_LOTTO_ETI
            rsNew!EnteCertificatoreLotto = ENTE_CERTIFICAZIONE_LOTTO_ETI
            rsNew!CodiceCertificazioneSocioPred = CODICE_CERTIFICAZIONE_SOCIO_ETI
            rsNew!DescrizioneCertificazioneSocioPred = DESCRIZIONE_CERTIFICAZIONE_SOCIO_ETI
            rsNew!ProtocolloCertificazioneSocioPred = PROTOCOLLO_CERTIFICAZIONE_SOCIO_ETI
            rsNew!EnteCertificatoreSocioPred = ENTE_CERTIFICAZIONE_SOCIO_ETI
            rsNew!IDCategoriaMerceologica = fnNotNullN(m_Document("IDCategoriaMerceologica").Value) 'X
            rsNew!CategoriaMerceologica = fnNotNull(m_Document("CategoriaMerceologica").Value) 'X
            rsNew!IDTipoProdotto = fnNotNull(m_Document("IDTipoProdotto").Value) 'X
            rsNew!TipoProdotto = fnNotNull(m_Document("TipoProdotto").Value) 'X
            rsNew!CodiceLottoEntrata = Me.txtLottoEntrata.Text
            rsNew!CodiceAssociato = CODICE_ASSOCIATO_PRED 'Me.txtCodiceAssociatoPredefinito.Text
            rsNew!IDVarietaLottoCampagna = LINK_VARIETA_LOTTO_CAMPAGNA
            rsNew!IDFamigliaLottoCampagna = LINK_FAMIGLIA_LOTTO_CAMPAGNA
            rsNew!VarietaLottoCampagna = VARIETA_LOTTO_CAMPAGNA
            rsNew!FamigliaLottoCampagna = FAMIGLIA_LOTTO_CAMPAGNA
            rsNew!IDTipoProduzioneLottoCampagna = LINK_TIPO_PRODUZIONE_LOTTO_CAMPAGNA
            rsNew!TipoProduzioneLottoCampagna = TIPO_PRODUZIONE_LOTTO_CAMPAGNA
            
            'CAMPI CLIENTE
            rsNew!NumeroPedanaCliente = fnNotNullN(rs!NumeroPedanaCliente)
            rsNew!CodicePedanaCliente = fnNotNull(rs!CodicePedanaCliente)
            rsNew!IDAnagraficaCliente = fnNotNullN(rs!IDCliente)
            rsNew!AnagraficaCliente = fnNotNull(rs!Anagrafica_Cliente)
            rsNew!LottoCliente = fnNotNull(rs!LottoCliente)
            rsNew!AltreAnnotazioniCliente = fnNotNull(rs!AltreAnnotazioniPerCliente)
            rsNew!CLIENTE_INDIRIZZO = fnNotNull(rs!Indirizzo_cliente)
            rsNew!CLIENTE_COMUNE = fnNotNull(rs!Comune_cliente)
            rsNew!CLIENTE_PROVINCIA = fnNotNull(rs!Provincia_Cliente)
            rsNew!CLIENTE_REGIONE = fnNotNull(rs!Regione_Cliente)
            rsNew!CLIENTE_NAZIONE = fnNotNull(rs!Nazione_Cliente)
            rsNew!CLIENTE_PARTITAIVA = fnNotNull(rs!PartitaIva_cliente)
            rsNew!CLIENTE_CAP = fnNotNull(rs!Cap_Cliente)
            rsNew!CLIENTE_TELEFONO = fnNotNull(rs!Telefono_Cliente)
            rsNew!CLIENTE_FAX = fnNotNull(rs!Fax_Cliente)
            rsNew!CLIENTE_EMAIL = fnNotNull(rs!Email_Cliente)
            rsNew!CLIENTE_INDIRIZZOWEB = fnNotNull(rs!IndirizzoWeb_Cliente)
            If Len(fnNotNull(rs!DataPartenzaOrdine)) > 0 Then
                rsNew!DataPartenzaOrdine = fnNotNull(rs!DataPartenzaOrdine)
            End If
            rsNew!CodiceAssociatoPressoCliente = fnNotNull(rs!CodiceAssociatoPressoCliente)
            rsNew!CodiceABarreArticoloCliente = fnNotNull(rs!CodiceABarreArticoloCliente)
            rsNew!DescrizioneCodiceABarreArticoloCliente = fnNotNull(rs!DescrizioneCodiceABarreArticoloCliente)
            rsNew!CodiceABarreImballoCliente = fnNotNull(rs!CodiceABarreImballoCliente)
            rsNew!DescrizioneCodiceABarreImballoCliente = fnNotNull(rs!DescrizioneCodiceABarreImballoCliente)
            rsNew!DescrizioneArticoloInLinguaCliente = fnNotNull(rs!DescrizioneArticoloInLinguaCliente)
            rsNew!DescrizioneCalibroInLinguaCliente = fnNotNull(rs!DescrizioneCalibroInLinguaCliente)
            rsNew!DescrizioneCategoriaInLinguaCliente = fnNotNull(rs!DescrizioneCategoriaInLinguaCliente)
            rsNew!LinguaCliente = fnNotNull(rs!LinguaCliente)
            rsNew!CodiceGSI = fnNotNull(rs!CodiceGSI)
            
            'DATI AZIENDA
            rsNew!AZIENDA_DENOMINAZIONE = AZIENDA_DENOMINAZIONE
            rsNew!AZIENDA_INDIRIZZO = AZIENDA_INDIRIZZO
            rsNew!AZIENDA_COMUNE = AZIENDA_COMUNE
            rsNew!AZIENDA_PROVINCIA = AZIENDA_PROVINCIA
            rsNew!AZIENDA_NAZIONE = AZIENDA_NAZIONE
            rsNew!AZIENDA_CAP = AZIENDA_CAP
            rsNew!AZIENDA_REGIONE = AZIENDA_REGIONE
            rsNew!AZIENDA_TELEFONO = AZIENDA_TELEFONO
            rsNew!Azienda_PartitaIva = AZIENDA_PARTITA_IVA
            rsNew!AZIENDA_FAX = AZIENDA_FAX
            rsNew!AZIENDA_EMAIL = AZIENDA_EMAIL
            rsNew!AZIENDA_INDIRIZZOWEB = AZIENDA_INDIRIZZOWEB
            
            'DATI FILIALE
            rsNew!FILIALE_DENOMINAZIONE = FILIALE_DENOMINAZIONE
            rsNew!FILIALE_INDIRIZZO = FILIALE_INDIRIZZO
            rsNew!FILIALE_COMUNE = FILIALE_COMUNE
            rsNew!FILIALE_REGIONE = FILIALE_REGIONE
            rsNew!FILIALE_PROVINCIA = FILIALE_PROVINCIA
            rsNew!FILIALE_NAZIONE = FILIALE_PROVINCIA
            rsNew!FILIALE_CAP = FILIALE_CAP
            
            'DATI SOCIO
            rsNew!SOCIO_INDIRIZZO = SOCIO_INDIRIZZO
            rsNew!SOCIO_COMUNE = SOCIO_COMUNE
            rsNew!SOCIO_CAP = SOCIO_CAP
            rsNew!SOCIO_NAZIONE = SOCIO_NAZIONE
            rsNew!SOCIO_REGIONE = SOCIO_REGIONE
            rsNew!SOCIO_PROVINCIA = SOCIO_PROVINCIA
            rsNew!SOCIO_TELEFONO = SOCIO_TELEFONO
            rsNew!SOCIO_FAX = SOCIO_FAX
            rsNew!SOCIO_EMAIL = SOCIO_EMAIL
            rsNew!SOCIO_INDIRIZZOWEB = SOCIO_INDIRIZZOWEB
            rsNew!Socio_PartitaIva = SOCIO_PARTITA_IVA

            'CERTIFIZIONE AZIENDA
            rsNew!CodiceCertificazioneAzienda = CODICE_CERTIFICAZIONE_AZIENDA
            rsNew!DescrizioneCertificazioneAzienda = DESCRIZIONE_CERTIFICAZIONE_AZIENDA
            rsNew!ProtocolloCertificazioneAzienda = PROTOCOLLO_CERTIFICAZIONE_AZIENDA
            rsNew!EnteCertificatoreAzienda = ENTE_CERTIFICAZIONE_AZIENDA
            
            
            'DATI DESTINAZIONE MERCE
            rsNew!Cliente_DestinazioneOrdine = fnNotNull(rs!DESTINAZIONE_MERCE)
            rsNew!Cliente_DestinazioneIndirizzo = fnNotNull(rs!DESTINAZIONE_INDIRIZZO)
            rsNew!Cliente_DestinazioneComune = fnNotNull(rs!DESTINAZIONE_COMUNE)
            rsNew!Cliente_DestinazioneProvincia = fnNotNull(rs!DESTINAZIONE_PROVINCIA)
            rsNew!Cliente_DestinazioneCap = fnNotNull(rs!DESTINAZIONE_CAP)
            rsNew!Cliente_DestinazioneNazione = fnNotNull(rs!DESTINAZIONE_NAZIONE)
            rsNew!Cliente_DestinazioneTelefono = fnNotNull(rs!DESTINAZIONE_TELEFONO)
            rsNew!Cliente_DestinazioneFax = fnNotNull(rs!DESTINAZIONE_FAX)
            
            'DATI VETTORE
            rsNew!Vettore_Ordine = fnNotNull(rs!VETTORE)
            rsNew!VETTORE_INDIRIZZO = fnNotNull(rs!VETTORE_INDIRIZZO)
            rsNew!VETTORE_COMUNE = fnNotNull(rs!VETTORE_COMUNE)
            rsNew!VETTORE_PROVINCIA = fnNotNull(rs!VETTORE_PROVINCIA)
            rsNew!VETTORE_CAP = fnNotNull(rs!VETTORE_CAP)
            rsNew!VETTORE_NAZIONE = fnNotNull(rs!VETTORE_NAZIONE)
            rsNew!VETTORE_TELEFONO = fnNotNull(rs!VETTORE_TELEFONO)
            rsNew!VETTORE_FAX = fnNotNull(rs!VETTORE_FAX)
            rsNew!Vettore_PartitaIva = fnNotNull(rs!Vettore_PartitaIva)
            rsNew!Vettore_NumeroAlbo = fnNotNull(rs!Vettore_NumeroAlbo)

            ''PASSAPORTO
            rsNew!RV_PO01_NumeroPassaportoRighe = Me.txtNumeroProtocollo.Value
            rsNew!RV_PO01_IDSezionaleRighe = Link_Sezionale_Dettagliato
            
            
            GET_LOTTI_IMBALLO_PER_ETICHETTA rsNew
        rsNew.Update

    rs.MoveNext
    Wend
End If

Cn.CommitTrans
Cn.CursorLocation = OLD_Cursor


rs.Close
Set rs = Nothing

rsNew.Close
Set rsNew = Nothing

Screen.MousePointer = 0

StampaEtichettePedana

Exit Sub
ERR_CREA_PEDANA_PER_STAMPA:
    MsgBox Err.Description, vbCritical, "CREA_PEDANA_PER_STAMPA"
    Screen.MousePointer = 0
    Cn.RollbackTrans
End Sub
Private Function AggiornaEtichettePedanaStampate(IDPedana As Long)
Dim sSQL As String
Dim rs As ADODB.Recordset

Set rs = New ADODB.Recordset

sSQL = "SELECT * FROM RV_POEtichettePedana WHERE IDRV_POPedana=" & IDPedana

rs.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

If rs.EOF Then
    rs.AddNew
    rs!IDRV_POPedana = IDPedana
    rs!DataUltimaStampa = Date
    rs!OraUltimaStampa = time
Else
    rs!DataUltimaStampa = Date
    rs!OraUltimaStampa = time
End If
    
    rs.Update
        
    
rs.Close
Set rs = Nothing
End Function
Private Sub StampaEtichettePedana()
On Error GoTo ERR_CmdStampaEtichette_Click
Dim IDReport As Long
Dim Stampante As String
Dim Pr As Printer
Dim NomeStampantePredefinita As String
Dim IDTipoOggettoPrg As Long
        
        IDTipoOggettoPrg = fncIDTipoOggettoPrg("RV_POEtichetteLavorazione")
        
        NomeStampantePredefinita = Printer.DeviceName
            
        Set oReport = New dmtReportLib.dmtReport
            Set oReport.Connection = Cn
            If MenuOptions.DBType = 1 Then
                'parametri di accesso al database ACCESS
                oReport.Password = "dmt192981046"
                oReport.User = "admin"
            Else
                'parametri di accesso al database SQL Server
                oReport.Password = TheApp.Password
                oReport.User = TheApp.User
            End If
        
        
        'Imposta l'idfiliale di appartenenza del documento da stampare
            oReport.BranchID = TheApp.Branch 'IDFiliale
        'Imposta l'identificativo del tipo di documento
            oReport.DocTypeID = IDTipoOggettoPrg
                
            oReport.Where = "IDUtente=" & TheApp.IDUser
            
            'IDReport = LINK_REPORT_PED_DEFAULT
            IDReport = Me.cboReportPed.CurrentID
            If IDReport > 0 Then
                fncImpostaDefaultReport IDReport, IDTipoOggettoPrg
                
                    
                'Stampante = STAMPANTE_PEDANA
                Stampante = Me.cboStampantePed.Text
                If Stampante <> NomeStampantePredefinita Then
                    For Each Pr In Printers
                        If Pr.DeviceName = Stampante Then
                            If WinNTSetDefaultPrinter(Pr.DeviceName) = True Then
                                Exit For
                            Else
                                MsgBox "Problemi con la stampante " & Me.cboStampantePed.Text 'STAMPANTE_PEDANA
                                Exit Sub
                            End If
                        End If
                    Next
                End If
                
                'oReport.Copies = GET_NUMERO_COPIE_DA_PARAMETRI
                oReport.Copies = Me.txtNumeroEtichettePed.Value

                oReport.DoPrint Stampante

                If Stampante <> NomeStampantePredefinita Then
                    WinNTSetDefaultPrinter NomeStampantePredefinita
                End If
                
                StampaEtichettaPDF_DMT oReport
            Else
                
                MsgBox "ATTENZIONE!!!!" & vbCrLf & "Il report non è stato trovato!", vbCritical, "Impossibile stampare"
            
            End If
          
            
      


Exit Sub
ERR_CmdStampaEtichette_Click:
MsgBox Err.Description, vbCritical, "Errore nella stampa delle etichette"
If Stampante <> NomeStampantePredefinita Then
    WinNTSetDefaultPrinter NomeStampantePredefinita
End If

End Sub
Private Function GET_STAMPA_PEDANA() As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT StampaPedana FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & TheApp.Branch

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_STAMPA_PEDANA = False
Else
    If fnNotNullN(rs!StampaPedana) = 0 Then
        GET_STAMPA_PEDANA = False
    Else
        GET_STAMPA_PEDANA = True
    End If
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_NUMERO_COPIE_DA_PARAMETRI() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT StampaPedana, NumeroEtichettePedana FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & TheApp.Branch

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_NUMERO_COPIE_DA_PARAMETRI = 1
Else
    If fnNotNullN(rs!StampaPedana) = 0 Then
        If fnNotNullN(rs!NumeroEtichettePedana) = 0 Then
            GET_NUMERO_COPIE_DA_PARAMETRI = 1
        Else
            GET_NUMERO_COPIE_DA_PARAMETRI = fnNotNullN(rs!NumeroEtichettePedana)
        End If
    Else
        GET_NUMERO_COPIE_DA_PARAMETRI = fnNotNullN(rs!NumeroEtichettePedana)
    End If
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_CERTIFICAZIONE_SOCIO(IDSocio As Long, NomeCampo As String) As String
On Error Resume Next
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
'If GET_ESISTENZA_BIO(2) = False Then
'    GET_CERTIFICAZIONE_SOCIO = ""
'Exit Function
'End If

sSQL = "SELECT " & NomeCampo & " "
sSQL = sSQL & "FROM RV_PO01_CertificazioneSocio INNER JOIN "
sSQL = sSQL & "RV_PO01_Certificazione ON "
sSQL = sSQL & "RV_PO01_CertificazioneSocio.IDRV_PO01_Certificazione = RV_PO01_Certificazione.IDRV_PO01_Certificazione LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_EnteCertificazione ON RV_PO01_Certificazione.IDRV_PO01_EnteCertificazione = RV_PO01_EnteCertificazione.IDRV_PO01_EnteCertificazione "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDSocio
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_CERTIFICAZIONE_SOCIO = ""
Else
    GET_CERTIFICAZIONE_SOCIO = fnNotNull(rs.adoColumns(NomeCampo).Value)
End If

rs.CloseResultset
Set rs = Nothing

End Function

Private Function GET_CERTIFICAZIONE_LOTTO_CAMPAGNA(IDLottoDiCampagna As Long, NomeCampo As String) As String
On Error Resume Next
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

'If GET_ESISTENZA_BIO(2) = False Then'
'
'    GET_CERTIFICAZIONE_LOTTO_CAMPAGNA = ""
'Exit Function
'End If

sSQL = "SELECT " & NomeCampo
sSQL = sSQL & " FROM RV_PO01_LottoCampagna INNER JOIN "
sSQL = sSQL & "RV_PO01_Certificazione ON "
sSQL = sSQL & "RV_PO01_LottoCampagna.IDRV_PO01_CertificazioneSocio = RV_PO01_Certificazione.IDRV_PO01_Certificazione INNER JOIN "
sSQL = sSQL & "RV_PO01_EnteCertificazione ON RV_PO01_Certificazione.IDRV_PO01_EnteCertificazione = RV_PO01_EnteCertificazione.IDRV_PO01_EnteCertificazione "
sSQL = sSQL & "WHERE IDRV_PO01_LottoCampagna=" & IDLottoDiCampagna

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_CERTIFICAZIONE_LOTTO_CAMPAGNA = ""
Else
    GET_CERTIFICAZIONE_LOTTO_CAMPAGNA = fnNotNull(rs.adoColumns(NomeCampo).Value)
End If

rs.CloseResultset
Set rs = Nothing
End Function



Public Sub InitControlliPerEtichette()
fncStampanti
fncStampantiPedana
fncReport
fncReportPedana


Me.cboReport.WriteOn fnDefaultReport_PRED
Me.cboReportPed.WriteOn fnDefaultReportPedana_PRED
End Sub
Private Sub fncStampanti()
Dim prn As Printer

Me.cboStampa.Clear
Me.cboStampaNew.Clear

For Each prn In Printers
    Me.cboStampa.AddItem prn.DeviceName
    Me.cboStampaNew.AddItem prn.DeviceName
Next

End Sub
Private Sub fncStampantiPedana()
Dim prn As Printer

Me.cboStampantePed.Clear
Me.cboStampantePedNew.Clear

For Each prn In Printers
    Me.cboStampantePed.AddItem prn.DeviceName
    Me.cboStampantePedNew.AddItem prn.DeviceName
Next

End Sub

Private Sub fncReport()
Dim sSQL As String
    With Me.cboReport
        Set .Database = TheApp.Database.Connection
        .AddFieldKey "IDReportTipoOggetto"
        .DisplayField = "ReportTipoOggetto"
        sSQL = "SELECT * FROM RV_POEtichetteDefault INNER JOIN "
        sSQL = sSQL & "ReportTipoOggetto ON RV_POEtichetteDefault.IDReportPerTipoOggetto = ReportTipoOggetto.IDReportTipoOggetto "
        sSQL = sSQL & "WHERE IDRV_POTipoEtichetta=1"
        sSQL = sSQL & " AND NomeComputer=" & fnNormString(NOME_COMPUTER)
        sSQL = sSQL & " AND IDUtente=" & TheApp.IDUser
        .SQL = sSQL
        .Fill
    End With
End Sub
Private Sub fncReportPedana()
Dim sSQL As String
    With Me.cboReportPed
        Set .Database = TheApp.Database.Connection
        .AddFieldKey "IDReportTipoOggetto"
        .DisplayField = "ReportTipoOggetto"
        sSQL = "SELECT * FROM RV_POEtichetteDefault INNER JOIN "
        sSQL = sSQL & "ReportTipoOggetto ON RV_POEtichetteDefault.IDReportPerTipoOggetto = ReportTipoOggetto.IDReportTipoOggetto "
        sSQL = sSQL & "WHERE IDRV_POTipoEtichetta=2"
        sSQL = sSQL & " AND NomeComputer=" & fnNormString(NOME_COMPUTER)
        sSQL = sSQL & " AND IDUtente=" & TheApp.IDUser
        .SQL = sSQL
        .Fill
    End With
End Sub
Private Function fnDefaultReport_PRED() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
    
sSQL = "SELECT IDReportPerTipoOggetto, Stampante FROM RV_POEtichetteDefault "
sSQL = sSQL & "WHERE Predefinito=" & fnNormBoolean(1)
sSQL = sSQL & " AND IDUtente=" & TheApp.IDUser
sSQL = sSQL & " AND NomeComputer=" & fnNormString(NOME_COMPUTER)
sSQL = sSQL & " AND IDRV_POTipoEtichetta=1"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    fnDefaultReport_PRED = fnNotNullN(rs!IDReportPerTipoOggetto)
    Me.cboStampa.Text = fnNotNull(rs!Stampante)
Else
    fnDefaultReport_PRED = 0
    Me.cboStampa.Text = ""
End If

rs.CloseResultset
Set rs = Nothing

End Function
Private Function fnDefaultReportPedana_PRED() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
    
sSQL = "SELECT IDReportPerTipoOggetto, Stampante FROM RV_POEtichetteDefault "
sSQL = sSQL & "WHERE Predefinito=" & fnNormBoolean(1)
sSQL = sSQL & " AND IDUtente=" & TheApp.IDUser
sSQL = sSQL & " AND NomeComputer=" & fnNormString(NOME_COMPUTER)
sSQL = sSQL & " AND IDRV_POTipoEtichetta=2"
Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    fnDefaultReportPedana_PRED = fnNotNullN(rs!IDReportPerTipoOggetto)
    Me.cboStampantePed.Text = fnNotNull(rs!Stampante)
Else
    fnDefaultReportPedana_PRED = 0
    Me.cboStampantePed.Text = ""
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GeneraMovimentoDiCarico(IDAssegnazione As Long, IDRigaConferimento As Long, CodiceLottoVendita As String, CodiceLottoCampagna As String, IDArticolo As Long, IDUMDiamante As Long, Articolo As String, Qta_UM As Double, DataLavorazione As String, QuantitaMovimentata As Double, _
Colli As Double, PesoLordo As Double, PesoNetto As Double, Tara As Double, Pezzi As Double, IDImballo As Long, IDTipoDocumentoCoop As Long, CodiceImballo As String, DescrizioneImballo As String, _
IDTipoLavorazione As Long, IDTipoCategoria As Long, IDCalibro As Long, IDTipoLavorazioneConf As Long, PrezzoMedioConf As Long, _
IDPedana As Long, IDTipoPedana As Long, CodicePedana As String, PesoPedana As Double, IDImballoPrim As Long, CodiceImballoPrim As String, DescrizioneImballoPrim As String, _
NumeroConfezioni As Long, TaraUnitariaConfezione As Double, CostoImballoConfezione As Double) As Long


Mov.DataMovimento = DataLavorazione
Mov.FattoreDiConversione = Null

Mov.GestioneMatricole = False
Mov.IDEsercizio = Link_Esercizio
Mov.IDTipoOggetto = m_DocType.ID
Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 1)
Mov.IDUtente = TheApp.IDUser
Mov.IDMagazzinoEntrata = CboMagazzinoVend.CurrentID
Mov.IDMagazzinoUscita = CboMagazzinoVend.CurrentID
Mov.Cessione = 0
Mov.Field "IDAzienda", TheApp.IDFirm
Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
Mov.Field "IDTipoAnagrafica", 3
Mov.Field "IDArticolo", IDArticolo
Mov.Field "IDUnitaDiMisura", IDUMDiamante
Mov.Field "IDcambio", Null
Mov.Field "DescrizioneArticolo", Articolo
Mov.Field "QuantitaTotale", Qta_UM
Mov.Field "Importo", 0
Mov.Field "DataDocumento", DataLavorazione
Mov.Field "Oggetto", "Lavorazione merce del " & DataLavorazione
Mov.Field "IDTipoMovimento", 1

'DATI DI CONFERIMENTO
Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
Mov.Field "RV_POTipoRiga", 1
Mov.Field "RV_POIDCaricoMerceRighe", IDRigaConferimento
Mov.Field "RV_POIDAssegnazioneMerce", IDAssegnazione
Mov.Field "RV_POIDProcessoIVGamma", 0
Mov.Field "RV_POIDAnagraficaSocio", fnNotNullN(m_Document("IDAnagrafica").Value)
Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
Mov.Field "RV_POCodiceLottoVendita", CodiceLottoVendita
Mov.Field "RV_POQuantitaLiquidazione", 0
Mov.Field "RV_POImportoInclusoImballo", 0
Mov.Field "RV_POImportoLiquidazione", 0
Mov.Field "RV_POQuantitaMovimentata", QuantitaMovimentata '* GET_MOLTIPLICATORE_ARTICOLO(IDArticolo)
Mov.Field "RV_PONumeroColli", Colli
Mov.Field "RV_POPesoLordo", PesoLordo
Mov.Field "RV_POPesoNetto", PesoNetto
Mov.Field "RV_POTara", Tara
Mov.Field "RV_POQuantitaPezzi", Pezzi
Mov.Field "RV_POIDTipoDocumentoCoop", IDTipoDocumentoCoop
Mov.Field "RV_POIDImballo", IDImballo
Mov.Field "RV_POCodiceImballo", CodiceImballo
Mov.Field "RV_PODescrizioneImballo", DescrizioneImballo

Mov.Field "RV_PODataLavorazione", DataLavorazione
Mov.Field "RV_POIDTipoLavorazione", IDTipoLavorazione
Mov.Field "RV_POIDCalibro", IDCalibro
Mov.Field "RV_POIDTipoCategoria", IDTipoCategoria
Mov.Field "RV_POIDTipoLavorazioneConf", IDTipoLavorazioneConf
Mov.Field "RV_POPrezzoMedioConf", PrezzoMedioConf

Mov.Field "RV_POIDPedana", IDPedana
Mov.Field "RV_POIDTipoPedana", IDTipoPedana
Mov.Field "RV_POCodicePedana", CodicePedana
Mov.Field "RV_POPesoPedana", PesoPedana

Mov.Field "RV_POIDImballoPrim", IDImballoPrim
Mov.Field "RV_POCodiceImballoPrim", CodiceImballoPrim
Mov.Field "RV_PODescrizioneImballoPrim", DescrizioneImballoPrim
Mov.Field "RV_PONumeroConfezioniPerImballo", NumeroConfezioni
Mov.Field "RV_POTaraConfezioneImballo", TaraUnitariaConfezione
Mov.Field "RV_POQuantitaTotaleConfImballo", Colli * NumeroConfezioni
Mov.Field "RV_POCostoConfezioneImballo", CostoImballoConfezione

Mov.Field "TipoRiga", trcNessuno

Cn.BeginTrans

GeneraMovimentoDiCarico = Mov.Insert

If GeneraMovimentoDiCarico = False Then
    Cn.RollbackTrans
Else
    Cn.CommitTrans
End If

End Function



Private Function GeneraMovimentoDiScarico(IDAssegnazione As Long, Qta_UM As Double, DataLavorazione As String) As Boolean


Mov.DataMovimento = DataLavorazione
Mov.FattoreDiConversione = Null

Mov.GestioneMatricole = False
Mov.IDEsercizio = Link_Esercizio
Mov.IDTipoOggetto = m_DocType.ID
Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 2)
Mov.IDUtente = TheApp.IDUser
Mov.IDMagazzinoUscita = cboMagazzinoConf.CurrentID
Mov.IDMagazzinoEntrata = cboMagazzinoConf.CurrentID
Mov.Cessione = 0
Mov.Field "IDAzienda", TheApp.IDFirm
Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
Mov.Field "IDTipoAnagrafica", 3
Mov.Field "IDArticolo", m_Document("IDArticolo").Value
Mov.Field "IDUnitaDiMisura", m_Document("IDUnitaDiMisuraDiamante").Value
Mov.Field "IDcambio", Null
Mov.Field "DescrizioneArticolo", m_Document("Articolo").Value
Mov.Field "QuantitaTotale", Qta_UM
Mov.Field "Importo", 0
Mov.Field "DataDocumento", DataLavorazione
Mov.Field "Oggetto", "Lavorazione merce del " & DataLavorazione
Mov.Field "IDTipoMovimento", 1

'DATI DI CONFERIMENTO
Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
Mov.Field "RV_POTipoRiga", 0
Mov.Field "RV_POIDCaricoMerceRighe", 0
Mov.Field "RV_POIDAssegnazioneMerce", 0
Mov.Field "RV_POIDProcessoIVGamma", 0
Mov.Field "RV_POIDAnagraficaSocio", 0
Mov.Field "RV_PODataConferimento", ""
Mov.Field "RV_PONumeroConferimento", ""
Mov.Field "RV_POCodiceLotto", ""
Mov.Field "RV_POCodiceLottoCampagna", ""
Mov.Field "RV_POCodiceLottoVendita", ""
Mov.Field "RV_POQuantitaLiquidazione", 0
Mov.Field "RV_POImportoInclusoImballo", 0
Mov.Field "RV_POImportoLiquidazione", 0
Mov.Field "RV_POQuantitaMovimentata", 0
Mov.Field "RV_PONumeroColli", 0
Mov.Field "RV_POPesoLordo", 0
Mov.Field "RV_POPesoNetto", 0
Mov.Field "RV_POTara", 0
Mov.Field "RV_POQuantitaPezzi", 0

Mov.Field "RV_POIDTipoDocumentoCoop", 0
Mov.Field "RV_POIDImballo", 0
Mov.Field "RV_POCodiceImballo", ""
Mov.Field "RV_PODescrizioneImballo", ""

Mov.Field "RV_PODataLavorazione", ""
Mov.Field "RV_POIDTipoLavorazione", 0
Mov.Field "RV_POIDCalibro", 0
Mov.Field "RV_POIDTipoCategoria", 0
Mov.Field "RV_POIDTipoLavorazioneConf", 0
Mov.Field "RV_POPrezzoMedioConf", 0

Mov.Field "RV_POIDPedana", 0
Mov.Field "RV_POIDTipoPedana", 0
Mov.Field "RV_POCodicePedana", ""
Mov.Field "RV_POPesoPedana", 0

Mov.Field "RV_POIDImballoPrim", 0
Mov.Field "RV_POCodiceImballoPrim", ""
Mov.Field "RV_PODescrizioneImballoPrim", ""
Mov.Field "RV_PONumeroConfezioniPerImballo", 0
Mov.Field "RV_POTaraConfezioneImballo", 0
Mov.Field "RV_POQuantitaTotaleConfImballo", 0
Mov.Field "RV_POCostoConfezioneImballo", 0


Mov.Field "TipoRiga", trcNessuno

Cn.BeginTrans

GeneraMovimentoDiScarico = Mov.Insert

If GeneraMovimentoDiScarico = False Then
    Cn.RollbackTrans
Else
    Cn.CommitTrans
End If

End Function
Private Sub RefreshArray()
Dim I As Integer

End Sub
Private Sub ParametroNuovoCalcolo()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT AttivazioneNuovoMetodoCalcolo FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    ATTIVAZIONE_NUOVO_CALCOLO = fnNotNullN(rs!AttivazioneNuovoMetodoCalcolo)
Else
    ATTIVAZIONE_NUOVO_CALCOLO = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Function ParametroNuovoMetodoEtichette() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT StampaEtichetteNuove FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE ((IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    ParametroNuovoMetodoEtichette = fnNotNullN(rs!StampaEtichetteNuove)
Else
    ParametroNuovoMetodoEtichette = 0
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub ParametroComportamentoLavorazione()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDRV_POTipoComportamentoLavorazione FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    TIPO_COMPORTAMENTO_LAVORAZIONE = fnNotNullN(rs!IDRV_POTipoComportamentoLavorazione)
Else
    TIPO_COMPORTAMENTO_LAVORAZIONE = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub ParametroPesoArticolo()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDRV_POTipoPesoArticolo FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    TIPO_PESO_ARTICOLO = fnNotNullN(rs!IDRV_POTipoPesoArticolo)
Else
    TIPO_PESO_ARTICOLO = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub

Private Function GET_LINK_ORDINAMENTO(Tabella As String) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT MAX(Link_Ordinamento) AS Link_Ordinamento "
sSQL = sSQL & "FROM " & Tabella
sSQL = sSQL & " WHERE " & m_Document.PrimaryKey & "=" & fnNotNullN(m_Document(m_Document.PrimaryKey).Value)

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_ORDINAMENTO = 1
Else
    GET_LINK_ORDINAMENTO = fnNotNullN(rs!LINK_ORDINAMENTO) + 1
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_FUNZIONE_MAGAZZINO(IDTipoDocumentoCoop As Long, IDTipoProcesso As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT RV_POProcessiDocumentoCoop.IDFunzione "
sSQL = sSQL & "FROM RV_POProcessiDocumentoCoop INNER JOIN "
sSQL = sSQL & "RV_POSchemaCoop ON RV_POProcessiDocumentoCoop.IDRV_POSchemaCoop = RV_POSchemaCoop.IDRV_POSchemaCoop "
sSQL = sSQL & "WHERE RV_POSchemaCoop.IDFiliale=" & m_App.Branch
sSQL = sSQL & " AND RV_POProcessiDocumentoCoop.IDDocumentoCoop=" & IDTipoDocumentoCoop
sSQL = sSQL & " AND RV_POProcessiDocumentoCoop.IDTipoProcessoCoop=" & IDTipoProcesso

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Select Case IDTipoProcesso
        Case 1 'Carico
            GET_FUNZIONE_MAGAZZINO = Link_CausaleCarico
        Case 2 'Scarico
            GET_FUNZIONE_MAGAZZINO = Link_CausaleScarico
    End Select
Else
    If fnNotNullN(rs!IDFunzione) = 0 Then
        Select Case IDTipoProcesso
            Case 1 'Carico
                GET_FUNZIONE_MAGAZZINO = Link_CausaleCarico
            Case 2 'Scarico
                GET_FUNZIONE_MAGAZZINO = Link_CausaleScarico
        End Select
        
    Else
        GET_FUNZIONE_MAGAZZINO = fnNotNullN(rs!IDFunzione)
    End If
End If


rs.CloseResultset
Set rs = Nothing

End Function
Private Sub GET_ANAGRAFICA_SOCIO_PER_ETICHETTE(IDAnagraficaSocio As Long, rstmp As ADODB.Recordset)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Anagrafica.IDNazione, Nazione.Nazione, Anagrafica.IDComune, Comune.Comune, "
sSQL = sSQL & "Provincia.Provincia, Provincia.IDProvincia, "
sSQL = sSQL & "Regione.Regione , Regione.IDRegione "
sSQL = sSQL & "FROM Provincia LEFT OUTER JOIN "
sSQL = sSQL & "Regione ON Provincia.IDRegione = Regione.IDRegione RIGHT OUTER JOIN "
sSQL = sSQL & "Comune ON Provincia.IDProvincia = Comune.IDProvincia RIGHT OUTER JOIN "
sSQL = sSQL & "Anagrafica INNER JOIN "
sSQL = sSQL & "Fornitore ON Anagrafica.IDAnagrafica = Fornitore.IDAnagrafica LEFT OUTER JOIN  "
sSQL = sSQL & "Nazione ON Anagrafica.IDNazione = Nazione.IDNazione ON Comune.IDComune = Anagrafica.IDComune "
sSQL = sSQL & "WHERE Fornitore.IDAzienda=" & m_App.IDFirm
sSQL = sSQL & " AND Fornitore.IDAnagrafica=" & IDAnagraficaSocio


Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    rstmp!IDRegione = fnNotNullN(rs!IDRegione)
    rstmp!Regione = fnNotNull(rs!Regione)
    rstmp!IDNazione = fnNotNullN(rs!IDNazione)
    rstmp!Nazione = fnNotNull(rs!Nazione)
    rstmp!IDComune = fnNotNullN(rs!IDComune)
    rstmp!Comune = fnNotNull(rs!Comune)
    rstmp!IDProvincia = fnNotNullN(rs!IDProvincia)
End If
rs.CloseResultset
Set rs = Nothing
End Sub
Private Function GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE(IDConferimentoRiga As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset



GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE = 0

If ATTIVAZIONE_NUOVO_CALCOLO = False Then
    sSQL = "SELECT SUM(Qta_UM) AS Qta_UM, SUM(Colli) AS Colli, SUM(PesoLordo) AS PesoLordo, "
    sSQL = sSQL & "SUM(PesoNetto) AS PesoNetto, SUM(Tara) AS Tara, SUM(Pezzi) AS Pezzi "
    sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
    sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDConferimentoRiga
    Set rs = Cn.OpenResultset(sSQL)
    
    
    
    If rs.EOF Then
        GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE = 0
    Else
        Select Case m_DocumentsLink("IDUnitaDiMisura").Value
            Case 1
                GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE = fnNotNullN(rs!Colli)
            Case 2
                GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE = fnNotNullN(rs!PesoLordo)
            Case 3
                GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE = fnNotNullN(rs!PesoNetto)
            Case 4
                GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE = fnNotNullN(rs!Tara)
            Case 5
                GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE = fnNotNullN(rs!Pezzi)
            
        End Select
            
    End If
    
    rs.CloseResultset
    Set rs = Nothing
Else

    sSQL = "SELECT Sum (RV_POQuantitaMovimentata) AS Quantita FROM Movimento "
    sSQL = sSQL & "WHERE RV_POIDCaricoMerceRighe=" & IDConferimentoRiga
    sSQL = sSQL & " AND IDTipoOggetto=" & fnGetTipoOggetto("RV_POAssegnazioneMerce")
    
    Set rs = Cn.OpenResultset(sSQL)
    
    
    
    
    If rs.EOF Then
        GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE = 0
    Else
        GET_RIEPILOGO_QUANTITA_ASSEGNAZIONE = fnNotNullN(rs!Quantita)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
    
    



End If


End Function
Private Function GET_RIEPILOGO_QUANTITA_PROCESSO(IDConferimentoRiga As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset



GET_RIEPILOGO_QUANTITA_PROCESSO = 0

If ATTIVAZIONE_NUOVO_CALCOLO = False Then
    sSQL = "SELECT SUM(Quantita) AS Quantita "
    sSQL = sSQL & "FROM RV_POProcessoIVGammaRighe "
    sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDConferimentoRiga
    Set rs = Cn.OpenResultset(sSQL)
    
    
    
    If rs.EOF Then
        GET_RIEPILOGO_QUANTITA_PROCESSO = 0
    Else
        GET_RIEPILOGO_QUANTITA_PROCESSO = fnNotNullN(rs!Quantita)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
Else

    sSQL = "SELECT Sum (RV_POQuantitaMovimentata) AS Quantita FROM Movimento "
    sSQL = sSQL & "WHERE RV_POIDCaricoMerceRighe=" & IDConferimentoRiga
    sSQL = sSQL & " AND IDTipoOggetto=" & fnGetTipoOggetto("RV_POIVGamma")
    
    Set rs = Cn.OpenResultset(sSQL)
    
    
    
    
    If rs.EOF Then
        GET_RIEPILOGO_QUANTITA_PROCESSO = 0
    Else
        GET_RIEPILOGO_QUANTITA_PROCESSO = fnNotNullN(rs!Quantita)
    End If
    
    rs.CloseResultset
    Set rs = Nothing

End If


End Function
Private Function Get_TrovaStampante(IDReport As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
    
sSQL = "SELECT Stampante FROM RV_POEtichetteDefault "
sSQL = sSQL & "WHERE IDUtente=" & TheApp.IDUser
sSQL = sSQL & " AND NomeComputer =" & fnNormString(GET_NOMECOMPUTER)
sSQL = sSQL & " AND IDReportPerTipoOggetto=" & IDReport

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    Get_TrovaStampante = fnNotNull(rs!Stampante)
Else
    Get_TrovaStampante = ""
End If

rs.CloseResultset
Set rs = Nothing

End Function
Private Function GET_UNITA_DI_MISURA(IDUnitaDiMisura As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
    
sSQL = "SELECT UnitaDiMisura FROM UnitaDiMisura "
sSQL = sSQL & "WHERE IDUnitaDiMisura=" & IDUnitaDiMisura

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    GET_UNITA_DI_MISURA = fnNotNull(rs!UnitaDiMisura)
Else
    GET_UNITA_DI_MISURA = ""
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_LINK_LINGUA_PREDEFINITA() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDLinguaPredefinita FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    GET_LINK_LINGUA_PREDEFINITA = fnNotNullN(rs!IDLinguaPredefinita)
Else
    GET_LINK_LINGUA_PREDEFINITA = 0
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_DESCRIZIONE_IN_LINGUA(IDLingua As Long, IDArticolo As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT ArticoloPerLinguaDescrizione "
sSQL = sSQL & "FROM ArticoloPerLinguaDescrizione "
sSQL = sSQL & "WHERE IDLinguaDescrizioneArticolo=" & IDLingua
sSQL = sSQL & " AND IDArticolo=" & IDArticolo
sSQL = sSQL & " AND VirtualDelete=0"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_DESCRIZIONE_IN_LINGUA = ""
Else
    GET_DESCRIZIONE_IN_LINGUA = fnNotNull(rs!ArticoloPerLinguaDescrizione)
End If


rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_DESCRIZIONE_CALIBRO_IN_LINGUA(IDLingua As Long, IDCalibro As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT CalibroLingua "
sSQL = sSQL & "FROM RV_POCalibroLingua "
sSQL = sSQL & "WHERE IDLingua=" & IDLingua
sSQL = sSQL & " AND IDRV_POCalibro=" & IDCalibro

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_DESCRIZIONE_CALIBRO_IN_LINGUA = ""
Else
    GET_DESCRIZIONE_CALIBRO_IN_LINGUA = fnNotNull(rs!CalibroLingua)
End If


rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_DESCRIZIONE_CATEGORIA_IN_LINGUA(IDLingua As Long, IDCategoria As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT CategoriaLingua "
sSQL = sSQL & "FROM RV_POCategoriaLingua "
sSQL = sSQL & "WHERE IDLingua=" & IDLingua
sSQL = sSQL & " AND IDRV_POTipoCategoria=" & IDCategoria

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_DESCRIZIONE_CATEGORIA_IN_LINGUA = ""
Else
    GET_DESCRIZIONE_CATEGORIA_IN_LINGUA = fnNotNull(rs!CategoriaLingua)
End If


rs.CloseResultset
Set rs = Nothing
End Function
Private Sub GET_ARTICOLO_CODICE_A_BARRE_CLIENTE(IDAnagrafica As Long, IDArticolo As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT CodiceABarre, DescrizioneCodiceABarre "
sSQL = sSQL & "FROM RV_POConfigurazioneClienteEAN13 "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDAnagrafica
sSQL = sSQL & " AND IDArticolo=" & IDArticolo
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.txtCodiceABarreArticoloCliente.Text = ""
    Me.txtCodificaArticoloCodiceABarre.Text = ""
Else
    Me.txtCodiceABarreArticoloCliente.Text = fnNotNull(rs!DescrizioneCodiceABarre)
    Me.txtCodificaArticoloCodiceABarre.Text = fnNotNull(rs!CodiceABarre)
End If


rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub GET_IMBALLO_CODICE_A_BARRE_CLIENTE(IDAnagrafica As Long, IDArticolo As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT CodiceABarre, DescrizioneCodiceABarre "
sSQL = sSQL & "FROM RV_POConfigurazioneClienteEAN13 "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDAnagrafica
sSQL = sSQL & " AND IDArticolo=" & IDArticolo
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.txtCodiceABarreImballoCliente.Text = ""
    Me.txtCodificaImballoCodiceABarre.Text = ""
Else
    Me.txtCodiceABarreImballoCliente.Text = fnNotNull(rs!DescrizioneCodiceABarre)
    Me.txtCodificaImballoCodiceABarre.Text = fnNotNull(rs!CodiceABarre)
End If


rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub GET_INFO_CLIENTE(IDAnagrafica As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT PrezzoInclusoImballo,CodiceGSI, MaxCaratteriPedana, CodiceAssociato "
sSQL = sSQL & "FROM RV_POConfigurazioneCliente "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDAnagrafica
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm


Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.txtCodiceGSICliente.Text = ""
    'Me.chkPrezzoInclusoImballo.Value = vbUnchecked
    MAX_CARATTERI_PEDANA_CLIENTE = 0
    Me.txtCodiceAssociatoPressoCliente.Text = ""
Else
    Me.txtCodiceGSICliente.Text = fnNotNull(rs!CodiceGSI)
    'Me.chkPrezzoInclusoImballo.Value = Abs(fnNotNullN(rs!PrezzoInclusoImballo))
    MAX_CARATTERI_PEDANA_CLIENTE = fnNotNullN(rs!MaxCaratteriPedana)
    Me.txtCodiceAssociatoPressoCliente.Text = fnNotNull(rs!CodiceAssociato)
End If


rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub GET_ARTICOLO_CODICE_PEDANA(IDAnagrafica As Long, IDEsercizio As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT NumeroPedana  "
sSQL = sSQL & "FROM RV_POConfigurazioneClientePedana "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDAnagrafica
sSQL = sSQL & " AND IDEsercizio=" & IDEsercizio
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.txtCodicePedanaCliente.Text = 1
    Me.txtCodificaCodicePedanaCliente.Text = GET_CODICE_PEDANA_CLIENTE(Me.txtCodicePedanaCliente.Value)
Else
    Me.txtCodicePedanaCliente.Text = fnNotNullN(rs!NumeroPedana)
    Me.txtCodificaCodicePedanaCliente.Text = GET_CODICE_PEDANA_CLIENTE(Me.txtCodicePedanaCliente.Value)

End If


rs.CloseResultset
Set rs = Nothing
End Sub

Private Function GET_TIPO_PEDANA(IDPedana As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDRV_POTipoPedana "
sSQL = sSQL & "FROM RV_POPedana "
sSQL = sSQL & "WHERE IDRV_POPedana=" & IDPedana

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TIPO_PEDANA = 0
Else
    GET_TIPO_PEDANA = fnNotNullN(rs!IDRV_POTipoPedana)
End If


rs.CloseResultset
Set rs = Nothing
End Function
Private Function AGGIORNA_TIPO_PEDANA(IDPedana As Long, IDTipoPedana As Long, PesoPedana As Double)
On Error GoTo ERR_AGGIORNA_TIPO_PEDANA
Dim sSQL As String

sSQL = "UPDATE RV_POPedana SET "
sSQL = sSQL & "IDRV_POTipoPedana=" & IDTipoPedana & ", "
sSQL = sSQL & "PesoPedana=" & fnNormNumber(PesoPedana)
sSQL = sSQL & " WHERE IDRV_POPedana=" & IDPedana


Cn.Execute sSQL

Exit Function
ERR_AGGIORNA_TIPO_PEDANA:
    MsgBox Err.Description, vbCritical, "AGGIORNA_TIPO_PEDANA"
End Function
Private Sub AGGIORNA_NUMERO_PEDANA_CLIENTE(NumeroPedanaCliente As Long, IDAnagraficaCliente As Long)
On Error GoTo ERR_AGGIORNA_NUMERO_PEDANA_CLIENTE
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsNew As ADODB.Recordset
Dim LINK_LOCAL_ESERCIZIO As Long

If NumeroPedanaCliente > 0 Then
    
    LINK_LOCAL_ESERCIZIO = fnGetEsercizio(Me.txtDataLavorazione.Text)
            
    sSQL = "SELECT * FROM RV_POConfigurazioneClientePedana "
    sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
    sSQL = sSQL & " AND IDAnagrafica=" & IDAnagraficaCliente
    sSQL = sSQL & " AND IDEsercizio=" & LINK_LOCAL_ESERCIZIO
'
'    Set rs = Cn.OpenResultset(sSQL)
    
    Set rsNew = New ADODB.Recordset
    
    rsNew.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic
    
    
    
    If rsNew.EOF Then
        rsNew.AddNew
            rsNew!IDRV_POConfigurazioneClientePedana = fnGetNewKey("RV_POConfigurazioneClientePedana", "IDRV_POConfigurazioneClientePedana")
            rsNew!IDAzienda = TheApp.IDFirm
            rsNew!IDRV_POConfigurazioneCliente = GET_CONFIGURAZIONE_CLIENTE_PEDANA(IDAnagraficaCliente)
            rsNew!IDEsercizio = LINK_LOCAL_ESERCIZIO
            rsNew!IDFiliale = TheApp.Branch
            rsNew!IDAnagrafica = IDAnagraficaCliente
            rsNew!NumeroPedana = NumeroPedanaCliente + 1
        rsNew.Update
    Else
        If fnNotNullN(rsNew!NumeroPedana) <= NumeroPedanaCliente Then
            rsNew!NumeroPedana = NumeroPedanaCliente + 1
            rsNew.Update
        End If
    End If
    
    
    rsNew.Close
    Set rsNew = Nothing
    
'    rs.CloseResultset
'    Set rs = Nothing
    

End If

Exit Sub
ERR_AGGIORNA_NUMERO_PEDANA_CLIENTE:
    MsgBox Err.Description, vbCritical, "AGGIORNA_NUMERO_PEDANA_CLIENTE"
    

End Sub
Private Function GET_CONFIGURAZIONE_CLIENTE_PEDANA(IDAnagrafica As Long) As Long
On Error GoTo ERR_GET_CONFIGURAZIONE_CLIENTE_PEDANA
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsNew As ADODB.Recordset

sSQL = "SELECT IDRV_POConfigurazioneCliente "
sSQL = sSQL & "FROM RV_POConfigurazioneCliente "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDAnagrafica
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Set rsNew = New ADODB.Recordset
    rsNew.Open "RV_POConfigurazioneCliente", Cn.InternalConnection, adOpenKeyset, adLockPessimistic
    rsNew.AddNew
        rsNew!IDRV_POConfigurazioneCliente = fnGetNewKey("RV_POConfigurazioneCliente", "IDRV_POConfigurazioneCliente")
        rsNew!IDAzienda = TheApp.IDFirm
        rsNew!IDFiliale = TheApp.Branch
        rsNew!IDAnagrafica = IDAnagrafica
        rsNew!CodiceGSI = ""
        rsNew!MaxCaratteriPedana = 0
        rsNew!PrezzoInclusoImballo = False
        rsNew!CodiceAssociato = ""
    rsNew.Update
    
    GET_CONFIGURAZIONE_CLIENTE_PEDANA = rsNew!IDRV_POConfigurazioneCliente
    
    rsNew.Close
    Set rsNew = Nothing
Else
    GET_CONFIGURAZIONE_CLIENTE_PEDANA = fnNotNullN(rs!IDRV_POConfigurazioneCliente)
End If

rs.CloseResultset
Set rs = Nothing

Exit Function
ERR_GET_CONFIGURAZIONE_CLIENTE_PEDANA:
    MsgBox Err.Description, vbCritical, "GET_CONFIGURAZIONE_CLIENTE_PEDANA"
    GET_CONFIGURAZIONE_CLIENTE_PEDANA = 0
End Function
Private Function MOVIMENTAZIONE_RIGA_LAVORAZIONE(IDLavorazione As Long) As String
On Error GoTo ERR_MOVIMENTAZIONE_RIGA_LAVORAZIONE
Dim OLD_Cursor As Long
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
Dim Movimentato As Long

MOVIMENTAZIONE_RIGA_LAVORAZIONE = ""
Movimentato = 1

Set Mov = New DmtMovim.cMovimentazione

Set Mov.Connection = TheApp.Database.Connection

'''''''''''''''''''''''ELIMINAZIONE MOVIMENTI DELLA RIGA DI LAVORAZIONE'''''''''''
sSQL = "SELECT IDMovimento FROM Movimento "
sSQL = sSQL & "WHERE IDTipoOggetto=" & fnGetTipoOggetto
sSQL = sSQL & " AND IDOggetto=" & fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
sSQL = sSQL & " AND IDValoriOggettoDettaglio=" & IDLavorazione

Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF

    Cn.BeginTrans
    
    If Mov.Delete(fnNotNullN(rs!IDMovimento)) = False Then
        MOVIMENTAZIONE_RIGA_LAVORAZIONE = "Problema riscontrato con l'eliminazione della movimentazione della riga di lavorazione" & vbCrLf
        Cn.RollbackTrans
    Else
        Cn.CommitTrans
    End If
    
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing

''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

    Select Case Link_UnitaDiMisura_Coop_Conferimento
        Case 1
            
            'If Me.chkPreConferimento.Value = vbUnchecked Then
                If GeneraMovimentoDiCarico(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
                    Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtColli.Value, _
                    Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
                    Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
                    Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
                    Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
                    Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
    
                    MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
                                
                    If (Movimentato = 1) Then Movimentato = 0
                End If
            'Else
            '    If GeneraMovimentoDiScaricoPreConf(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
            '        Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtColli.Value, _
            '        Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
            '        Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
            '        Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
            '        Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
            '        Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
    
            '        MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
                                
            '        If (Movimentato = 1) Then Movimentato = 0
            '    End If
            'End If
            If GeneraMovimentoDiScarico(IDLavorazione, Me.txtColli.Value, Me.txtDataLavorazione.Text) = False Then
                MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
                If (Movimentato = 1) Then Movimentato = 0
            End If
        Case 2
'            If Me.chkPreConferimento.Value = vbUnchecked Then
                If GeneraMovimentoDiCarico(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
                    Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtPesoLordo.Value, _
                    Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
                    Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
                    Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
                    Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
                    Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
                
                    MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
                    If (Movimentato = 1) Then Movimentato = 0
                    'Set Mov = Nothing
                    'Exit Function
                End If
'            Else
'                If GeneraMovimentoDiScaricoPreConf(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
'                    Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtPesoLordo.Value, _
'                    Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
'                    Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
'                    Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
'                    Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
'                    Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
'
'                    MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
'                    If (Movimentato = 1) Then Movimentato = 0
'                    'Set Mov = Nothing
'                    'Exit Function
'                End If
'            End If
            If GeneraMovimentoDiScarico(IDLavorazione, Me.txtPesoLordo.Value, Me.txtDataLavorazione.Text) = False Then
                MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
                'Set Mov = Nothing
                'Exit Function
                If (Movimentato = 1) Then Movimentato = 0
            End If

        Case 3
'            If Me.chkPreConferimento.Value = vbUnchecked Then
                If GeneraMovimentoDiCarico(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
                    Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtPesoNetto.Value, _
                    Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
                    Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
                    Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
                    Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
                    Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
                    
                    MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
                    If (Movimentato = 1) Then Movimentato = 0
                End If
'            Else
'                If GeneraMovimentoDiScaricoPreConf(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
'                    Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtPesoNetto.Value, _
'                    Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
'                    Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
'                    Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
'                    Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
'                    Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
'
'                    MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
'                    If (Movimentato = 1) Then Movimentato = 0
'                End If
'            End If
            If GeneraMovimentoDiScarico(IDLavorazione, Me.txtPesoNetto.Value, Me.txtDataLavorazione.Text) = False Then
                MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
                If (Movimentato = 1) Then Movimentato = 0
            End If

        Case 4
'            If Me.chkPreConferimento.Value = vbUnchecked Then
                If GeneraMovimentoDiCarico(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
                    Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtTara.Value, _
                    Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
                    Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
                    Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
                    Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
                    Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
                    
                    MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
                    If (Movimentato = 1) Then Movimentato = 0
                    
                End If
'            Else
'                 If GeneraMovimentoDiScaricoPreConf(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
'                    Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtTara.Value, _
'                    Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
'                    Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
'                    Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
'                    Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
'                    Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
'
'                    MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
'                    If (Movimentato = 1) Then Movimentato = 0
'
'                End If
'            End If
            If GeneraMovimentoDiScarico(IDLavorazione, Me.txtTara.Value, Me.txtDataLavorazione.Text) = False Then
                MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
                If (Movimentato = 1) Then Movimentato = 0
            End If

        Case 5
'            If Me.chkPreConferimento.Value = vbUnchecked Then
                If GeneraMovimentoDiCarico(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
                    Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtPezzi.Value, _
                    Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
                    Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
                    Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
                    Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
                    Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
                    
                    MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
                    If (Movimentato = 1) Then Movimentato = 0
                End If
'            Else
'                If GeneraMovimentoDiScaricoPreConf(IDLavorazione, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), Me.txtLottoVendita.Text, Me.txtCodiceLotto_Conf.Text, Me.CDArticolo.KeyFieldID, Me.cboUM.CurrentID, _
'                    Me.TxtArticolo.Text, Me.txtQta_UM.Value, Me.txtDataLavorazione.Text, Me.txtPezzi.Value, _
'                    Me.txtColli.Value, Me.txtPesoLordo.Value, Me.txtPesoNetto.Value, Me.txtTara.Value, Me.txtPezzi.Value, _
'                    Me.CDCodiceImballo.KeyFieldID, fnNotNullN(m_Document("IDTipoDocumentoCoop").Value), Me.CDCodiceImballo.Code, Me.CDCodiceImballo.Description, _
'                    Me.CboTipoLavorazione.CurrentID, Me.cboTipoCategoria.CurrentID, Me.cboCalibro.CurrentID, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value, _
'                    Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID, Me.txtCodicePedana.Text, Me.txtPesoPedana.Value, Me.CDImballoPrimario.KeyFieldID, Me.CDImballoPrimario.Code, Me.CDImballoPrimario.Description, _
'                    Me.txtNumeroConfImballo.Value, Me.txtTaraConfImballo.Value, Me.txtCostoConfezione.Value) = False Then
'
'                    MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
'                    If (Movimentato = 1) Then Movimentato = 0
'                End If
'            End If
            If GeneraMovimentoDiScarico(IDLavorazione, Me.txtPezzi.Value, Me.txtDataLavorazione.Text) = False Then
                MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
                If (Movimentato = 1) Then Movimentato = 0
            End If
            
    End Select
    
    If Me.chkPreConferimento.Value = vbUnchecked Then
        If ((Me.CDCodiceImballo.KeyFieldID > 0) And (Me.txtColli.Value > 0)) Then
            If GeneraMovimentoCaricoImballo(fnNotNullN(m_Document(m_Document.PrimaryKey).Value), IDLavorazione, Me.txtLottoEntrata.Text, Me.txtCodiceLotto_Conf.Text, Me.CDCodiceImballo.KeyFieldID, Me.cboUMImballo.CurrentID, Me.txtImballo.Text, Me.txtColli.Value) = False Then
                MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di carico imballo" & vbCrLf
                If (Movimentato = 1) Then Movimentato = 0
            End If
        End If
    End If
    If ((Me.CDCodiceImballo.KeyFieldID > 0) And (Me.txtColli.Value > 0)) Then
        If GeneraMovimentoScaricoImballo(fnNotNullN(m_Document(m_Document.PrimaryKey).Value), IDLavorazione, Me.txtLottoEntrata.Text, Me.txtCodiceLotto_Conf.Text, Me.CDCodiceImballo.KeyFieldID, Me.cboUMImballo.CurrentID, Me.txtImballo.Text, Me.txtColli.Value, Me.chkTracciaImballoGest.Value) = False Then
            MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di scarico imballo" & vbCrLf
            If (Movimentato = 1) Then Movimentato = 0
        End If
    End If
    If ((Me.CDImballoPrimario.KeyFieldID > 0) And (Me.txtNumeroConfImballo.Value > 0)) Then
        If GeneraMovimentoScaricoImballoPrim(fnNotNullN(m_Document(m_Document.PrimaryKey).Value), IDLavorazione, Me.txtLottoEntrata.Text, Me.txtCodiceLotto_Conf.Text, Me.CDImballoPrimario.KeyFieldID, GET_LINK_UM_ARTICOLO(Me.CDImballoPrimario.KeyFieldID), Me.CDImballoPrimario.Description, Me.txtColli.Value * Me.txtNumeroConfImballo.Value, Me.chkTracciaImballoGestPrim.Value) = False Then
            MOVIMENTAZIONE_RIGA_LAVORAZIONE = MOVIMENTAZIONE_RIGA_LAVORAZIONE & "Problema riscontrato con la movimentazione della riga di scarico imballo primario" & vbCrLf
            If (Movimentato = 1) Then Movimentato = 0
        End If
    End If
    
    GeneraMovimentoScaricoKit fnNotNullN(m_Document(m_Document.PrimaryKey).Value), IDLavorazione, Me.txtLottoEntrata.Text, Me.txtCodiceLotto_Conf.Text, 0
        
Set Mov = Nothing

sSQL = "UPDATE RV_POAssegnazioneMerce SET "
sSQL = sSQL & " Movimentato=" & Movimentato
sSQL = sSQL & " WHERE IDRV_POAssegnazioneMerce=" & IDLavorazione
Cn.Execute sSQL

Exit Function
ERR_MOVIMENTAZIONE_RIGA_LAVORAZIONE:
    MsgBox Err.Description, vbCritical, "MOVIMENTAZIONE_RIGA_LAVORAZIONE"
End Function
Public Function GeneraMovimentoCaricoImballo(IDRigaConferimento As Long, IDAssegnazione As Long, CodiceLottoEntrata As String, CodiceLottoCampagna As String, IDArticolo As Long, IDUMDiamante As Long, Articolo As String, Qta_UM As Double) As Boolean
Mov.DataMovimento = Me.txtDataLavorazione.Text
Mov.FattoreDiConversione = Null

Mov.GestioneMatricole = False
Mov.IDEsercizio = Link_Esercizio
Mov.IDTipoOggetto = m_DocType.ID
Mov.IDOggetto = IDRigaConferimento
Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 1)
Mov.IDUtente = TheApp.IDUser
Mov.IDMagazzinoEntrata = CboMagazzinoVend.CurrentID
Mov.IDMagazzinoUscita = CboMagazzinoVend.CurrentID

Mov.Cessione = 0
Mov.Field "IDAzienda", TheApp.IDFirm
Mov.Field "IDAnagrafica", fnNotNullN(m_Document("IDAnagrafica").Value)
Mov.Field "IDTipoAnagrafica", 3
Mov.Field "IDArticolo", IDArticolo
Mov.Field "IDUnitaDiMisura", IDUMDiamante
Mov.Field "IDcambio", Null
Mov.Field "DescrizioneArticolo", Articolo
Mov.Field "QuantitaTotale", Qta_UM
Mov.Field "Importo", 0
Mov.Field "DataDocumento", Me.txtDataLavorazione.Text
Mov.Field "Oggetto", "Lavorazione merce del " & Me.txtDataLavorazione.Text
Mov.Field "IDTipoMovimento", 1

'DATI DI CONFERIMENTO
Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
Mov.Field "RV_POTipoRiga", 2
Mov.Field "RV_POIDCaricoMerceRighe", IDRigaConferimento
Mov.Field "RV_POIDAssegnazioneMerce", IDAssegnazione
Mov.Field "RV_POIDProcessoIVGamma", 0
Mov.Field "RV_POIDAnagraficaSocio", fnNotNullN(m_Document("IDAnagrafica").Value)
Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
Mov.Field "RV_POCodiceLottoVendita", Me.txtLottoVendita.Text
Mov.Field "RV_POQuantitaLiquidazione", 0
Mov.Field "RV_POImportoInclusoImballo", 0
Mov.Field "RV_POImportoLiquidazione", 0
Mov.Field "RV_POQuantitaMovimentata", 0
Mov.Field "RV_PONumeroColli", 0
Mov.Field "RV_POPesoLordo", 0
Mov.Field "RV_POPesoNetto", 0
Mov.Field "RV_POTara", 0
Mov.Field "RV_POQuantitaPezzi", 0

Mov.Field "RV_POIDTipoDocumentoCoop", 0
Mov.Field "RV_POIDImballo", 0
Mov.Field "RV_POCodiceImballo", ""
Mov.Field "RV_PODescrizioneImballo", ""

Mov.Field "RV_PODataLavorazione", ""
Mov.Field "RV_POIDTipoLavorazione", 0
Mov.Field "RV_POIDCalibro", 0
Mov.Field "RV_POIDTipoCategoria", 0
Mov.Field "RV_POIDTipoLavorazioneConf", 0
Mov.Field "RV_POPrezzoMedioConf", 0

Mov.Field "RV_POIDPedana", 0
Mov.Field "RV_POIDTipoPedana", 0
Mov.Field "RV_POCodicePedana", ""
Mov.Field "RV_POPesoPedana", 0


Mov.Field "RV_POIDImballoPrim", 0
Mov.Field "RV_POCodiceImballoPrim", ""
Mov.Field "RV_PODescrizioneImballoPrim", ""
Mov.Field "RV_PONumeroConfezioniPerImballo", 0
Mov.Field "RV_POTaraConfezioneImballo", 0
Mov.Field "RV_POQuantitaTotaleConfImballo", 0
Mov.Field "RV_POCostoConfezioneImballo", 0

Mov.Field "TipoRiga", trcNessuno

Cn.BeginTrans

GeneraMovimentoCaricoImballo = Mov.Insert

If GeneraMovimentoCaricoImballo = False Then
    Cn.RollbackTrans
Else
    Cn.CommitTrans
End If

End Function

Public Function GeneraMovimentoScaricoImballo(IDRigaConferimento As Long, IDAssegnazione As Long, CodiceLottoEntrata As String, CodiceLottoCampagna As String, IDArticolo As Long, IDUMDiamante As Long, Articolo As String, Qta_UM As Double, TracciaImballo As Long) As Boolean
Dim QuantitaRimasta As Double
Dim QuantitaUtilizzata As Double
Dim sSQL As String

    QuantitaRimasta = Qta_UM
    
    
If TracciaImballo = 1 Then
    rsLottoImballo.Filter = "Giacenza>0"
    rsLottoImballo.Sort = "Registra DESC, NumeroProgressivo"
    
    If Not ((rsLottoImballo.EOF) And (rsLottoImballo.BOF)) Then
        rsLottoImballo.MoveFirst
        While Not rsLottoImballo.EOF
            If QuantitaRimasta > 0 Then

                Mov.DataMovimento = Me.txtDataLavorazione.Text
                Mov.FattoreDiConversione = Null
                
                Mov.GestioneMatricole = False
                Mov.IDEsercizio = Link_Esercizio
                Mov.IDTipoOggetto = m_DocType.ID
                Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
                Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 2)
                Mov.IDUtente = TheApp.IDUser
                Mov.IDMagazzinoUscita = cboMagazzinoConf.CurrentID
                Mov.IDMagazzinoEntrata = cboMagazzinoConf.CurrentID
                Mov.Cessione = 0
                Mov.Field "IDAzienda", TheApp.IDFirm
                If (Me.chkPreConferimento.Value = vbUnchecked) Then
                    Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
                Else
                    Mov.Field "IDAnagrafica", IDSOCIO_PRE_CONF
                End If
                Mov.Field "IDTipoAnagrafica", 3
                Mov.Field "IDArticolo", IDArticolo
                Mov.Field "IDUnitaDiMisura", IDUMDiamante
                Mov.Field "IDcambio", Null
                Mov.Field "DescrizioneArticolo", Articolo
                If QuantitaRimasta > 0 Then
                    If rsLottoImballo!Registra = 1 Then
                        If Me.chkConfermaDaUtente.Value = Unchecked Then
                            If (QuantitaRimasta - (fnNotNullN(rsLottoImballo!QuantitaSelezionata) + (fnNotNullN(rsLottoImballo!Giacenza) - fnNotNullN(rsLottoImballo!QuantitaSelezionata)))) <= 0 Then
                                QuantitaUtilizzata = QuantitaRimasta
                            Else
                                QuantitaUtilizzata = fnNotNullN(rsLottoImballo!Giacenza) 'fnNotNullN(rsLottoImballo!QuantitaSelezionata)
                            End If
                        Else
                            If (QuantitaRimasta - fnNotNullN(rsLottoImballo!QuantitaSelezionata)) <= 0 Then
                                QuantitaUtilizzata = QuantitaRimasta
                            Else
                                QuantitaUtilizzata = fnNotNullN(rsLottoImballo!QuantitaSelezionata) 'fnNotNullN(rsLottoImballo!QuantitaSelezionata)
                            End If
                        End If
                    Else
                        If (QuantitaRimasta - fnNotNullN(rsLottoImballo!Giacenza)) <= 0 Then
                            QuantitaUtilizzata = QuantitaRimasta
                        Else
                            QuantitaUtilizzata = fnNotNullN(rsLottoImballo!Giacenza)
                        End If
                    End If

                End If
                Mov.Field "QuantitaTotale", QuantitaUtilizzata
                Mov.Field "Importo", 0
                Mov.Field "DataDocumento", Me.txtDataLavorazione.Text
                Mov.Field "Oggetto", "Lavorazione merce del " & Me.txtDataLavorazione.Text
                Mov.Field "IDTipoMovimento", 1
                
                'DATI DI CONFERIMENTO
                Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
                Mov.Field "RV_POTipoRiga", 2
                Mov.Field "RV_POIDCaricoMerceRighe", IDRigaConferimento
                Mov.Field "RV_POIDAssegnazioneMerce", IDAssegnazione
                Mov.Field "RV_POIDProcessoIVGamma", 0
                Mov.Field "RV_POIDAnagraficaSocio", fnNotNullN(m_Document("IDAnagrafica").Value)
                Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
                Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
                Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
                Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
                Mov.Field "RV_POCodiceLottoVendita", Me.txtLottoVendita.Text
                Mov.Field "RV_POQuantitaLiquidazione", 0
                Mov.Field "RV_POImportoInclusoImballo", 0
                Mov.Field "RV_POImportoLiquidazione", 0
                Mov.Field "RV_POQuantitaMovimentata", 0
                Mov.Field "RV_PONumeroColli", 0
                Mov.Field "RV_POPesoLordo", 0
                Mov.Field "RV_POPesoNetto", 0
                Mov.Field "RV_POTara", 0
                Mov.Field "RV_POQuantitaPezzi", 0
                
                Mov.Field "RV_POIDTipoDocumentoCoop", 0
                Mov.Field "RV_POIDImballo", 0
                Mov.Field "RV_POCodiceImballo", ""
                Mov.Field "RV_PODescrizioneImballo", ""
                
                Mov.Field "RV_PODataLavorazione", ""
                Mov.Field "RV_POIDTipoLavorazione", 0
                Mov.Field "RV_POIDCalibro", 0
                Mov.Field "RV_POIDTipoCategoria", 0
                Mov.Field "RV_POIDTipoLavorazioneConf", 0
                Mov.Field "RV_POPrezzoMedioConf", 0
                
                Mov.Field "RV_POIDPedana", 0
                Mov.Field "RV_POIDTipoPedana", 0
                Mov.Field "RV_POCodicePedana", ""
                Mov.Field "RV_POPesoPedana", 0
                
                
                Mov.Field "RV_POIDImballoPrim", 0
                Mov.Field "RV_POCodiceImballoPrim", ""
                Mov.Field "RV_PODescrizioneImballoPrim", ""
                Mov.Field "RV_PONumeroConfezioniPerImballo", 0
                Mov.Field "RV_POTaraConfezioneImballo", 0
                Mov.Field "RV_POQuantitaTotaleConfImballo", 0
                Mov.Field "RV_POCostoConfezioneImballo", 0
                
                Mov.Field "RV_POIDLottoImballo", fnNotNullN(rsLottoImballo!IDRV_POLottoImballo)
                Mov.Field "LottoImballo", GET_DESCRIZIONE_LOTTO_IMBALLO(fnNotNullN(rsLottoImballo!IDRV_POLottoImballo))
                
                Mov.Field "TipoRiga", trcNessuno
                
                Cn.BeginTrans
                
                GeneraMovimentoScaricoImballo = Mov.Insert
                
                If GeneraMovimentoScaricoImballo = False Then
                    Cn.RollbackTrans
                Else
                    Cn.CommitTrans
                End If
                
                QuantitaRimasta = QuantitaRimasta - QuantitaUtilizzata
                
                rsLottoImballo!QuantitaMovimentata = QuantitaUtilizzata
                rsLottoImballo.Update
                
                
                sSQL = "UPDATE RV_POLottoImballo SET "
                sSQL = sSQL & " Giacenza=" & fnNormNumber(rsLottoImballo!Giacenza - QuantitaUtilizzata)
                sSQL = sSQL & " WHERE IDRV_POLottoImballo=" & fnNotNullN(rsLottoImballo!IDRV_POLottoImballo)
                Cn.Execute sSQL
            Else
                If fnNotNullN(rsLottoImballo!QuantitaSelezionata) > 0 Then
                    sSQL = "UPDATE RV_POLottoImballo SET "
                    sSQL = sSQL & " Giacenza=" & fnNormNumber(rsLottoImballo!Giacenza)
                    sSQL = sSQL & " WHERE IDRV_POLottoImballo=" & fnNotNullN(rsLottoImballo!IDRV_POLottoImballo)
                    Cn.Execute sSQL
                End If
            End If
        rsLottoImballo.MoveNext
        Wend
    End If
End If

If QuantitaRimasta > 0 Then
    Mov.DataMovimento = Me.txtDataLavorazione.Text
    Mov.FattoreDiConversione = Null
    
    Mov.GestioneMatricole = False
    Mov.IDEsercizio = Link_Esercizio
    Mov.IDTipoOggetto = m_DocType.ID
    Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 2)
    Mov.IDUtente = TheApp.IDUser
    Mov.IDMagazzinoUscita = cboMagazzinoConf.CurrentID
    Mov.IDMagazzinoEntrata = cboMagazzinoConf.CurrentID
    Mov.Cessione = 0
    Mov.Field "IDAzienda", TheApp.IDFirm
    If (Me.chkPreConferimento.Value = vbUnchecked) Then
        Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
    Else
        Mov.Field "IDAnagrafica", IDSOCIO_PRE_CONF
    End If
    Mov.Field "IDTipoAnagrafica", 3
    Mov.Field "IDArticolo", IDArticolo
    Mov.Field "IDUnitaDiMisura", IDUMDiamante
    Mov.Field "IDcambio", Null
    Mov.Field "DescrizioneArticolo", Articolo
    Mov.Field "QuantitaTotale", QuantitaRimasta
    Mov.Field "Importo", 0
    Mov.Field "DataDocumento", Me.txtDataLavorazione.Text
    Mov.Field "Oggetto", "Lavorazione merce del " & Me.txtDataLavorazione.Text
    Mov.Field "IDTipoMovimento", 1
    
    'DATI DI CONFERIMENTO
    Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
    Mov.Field "RV_POTipoRiga", 2
    Mov.Field "RV_POIDCaricoMerceRighe", IDRigaConferimento
    Mov.Field "RV_POIDAssegnazioneMerce", IDAssegnazione
    Mov.Field "RV_POIDProcessoIVGamma", 0
    Mov.Field "RV_POIDAnagraficaSocio", fnNotNullN(m_Document("IDAnagrafica").Value)
    Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
    Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
    Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
    Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
    Mov.Field "RV_POCodiceLottoVendita", Me.txtLottoVendita.Text
    Mov.Field "RV_POQuantitaLiquidazione", 0
    Mov.Field "RV_POImportoInclusoImballo", 0
    Mov.Field "RV_POImportoLiquidazione", 0
    Mov.Field "RV_POQuantitaMovimentata", 0
    Mov.Field "RV_PONumeroColli", 0
    Mov.Field "RV_POPesoLordo", 0
    Mov.Field "RV_POPesoNetto", 0
    Mov.Field "RV_POTara", 0
    Mov.Field "RV_POQuantitaPezzi", 0
    
    Mov.Field "RV_POIDTipoDocumentoCoop", 0
    Mov.Field "RV_POIDImballo", 0
    Mov.Field "RV_POCodiceImballo", ""
    Mov.Field "RV_PODescrizioneImballo", ""
    
    Mov.Field "RV_PODataLavorazione", ""
    Mov.Field "RV_POIDTipoLavorazione", 0
    Mov.Field "RV_POIDCalibro", 0
    Mov.Field "RV_POIDTipoCategoria", 0
    Mov.Field "RV_POIDTipoLavorazioneConf", 0
    Mov.Field "RV_POPrezzoMedioConf", 0
    
    Mov.Field "RV_POIDPedana", 0
    Mov.Field "RV_POIDTipoPedana", 0
    Mov.Field "RV_POCodicePedana", ""
    Mov.Field "RV_POPesoPedana", 0
    
    Mov.Field "RV_POIDImballoPrim", 0
    Mov.Field "RV_POCodiceImballoPrim", ""
    Mov.Field "RV_PODescrizioneImballoPrim", ""
    Mov.Field "RV_PONumeroConfezioniPerImballo", 0
    Mov.Field "RV_POTaraConfezioneImballo", 0
    Mov.Field "RV_POQuantitaTotaleConfImballo", 0
    Mov.Field "RV_POCostoConfezioneImballo", 0
    
    
    If TracciaImballo = 1 Then
        Mov.Field "RV_POIDLottoImballo", fnNotNullN(LINK_LOTTO_IMBALLO_PRED)
        Mov.Field "LottoImballo", GET_DESCRIZIONE_LOTTO_IMBALLO(LINK_LOTTO_IMBALLO_PRED)
    Else
        Mov.Field "RV_POIDLottoImballo", 0
        Mov.Field "LottoImballo", ""
    End If
    
    Mov.Field "TipoRiga", trcNessuno
    
    Cn.BeginTrans
    
    GeneraMovimentoScaricoImballo = Mov.Insert
    
    If GeneraMovimentoScaricoImballo = False Then
        Cn.RollbackTrans
    Else
        Cn.CommitTrans
    End If

End If
End Function
Private Sub AGGIORNA_ORDINE_CLIENTE(IDDestinazione As Long, IDVettore As Long, IDTipoDestinazione As Long)

End Sub

Private Function GET_CONTROLLA_ESISTENZA_COLLEGAMENTO(IDRigaConferimento As Long, IDTipoOggetto As Long, IDAssegnazioneMerce) As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = False

If ATTIVAZIONE_NUOVO_CALCOLO = True Then

    sSQL = "SELECT IDMovimento FROM Movimento "
    sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
    sSQL = sSQL & " AND RV_POIDCaricoMerceRighe=" & IDRigaConferimento
    sSQL = sSQL & " AND RV_POIDAssegnazioneMerce=" & IDAssegnazioneMerce
    sSQL = sSQL & " AND IDTipoOggetto<>" & IDTipoOggetto
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = False
    Else
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = True
    End If
    
    rs.CloseResultset
    Set rs = Nothing
Else
    ''''''''''''''''''CONTROLLO DDT''''''''''''''''''''''''''''''''''''''''''''''''''''
    sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0004 "
    sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento
    sSQL = sSQL & " AND RV_POIDAssegnazioneMerce=" & IDAssegnazioneMerce
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = False
    Else
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = True
        rs.CloseResultset
        Set rs = Nothing
        Exit Function
    End If
    
    rs.CloseResultset
    Set rs = Nothing
    
    
    ''''''''''''''''''''''''''''''''''''''''
    ''''''''''''''''''CONTROLLO FATTURA ACCOMPAGNATORIA
    sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0001 "
    sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento
    sSQL = sSQL & " AND RV_POIDAssegnazioneMerce=" & IDAssegnazioneMerce

    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = False
    Else
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = True
        rs.CloseResultset
        Set rs = Nothing
        Exit Function
    End If
    
    rs.CloseResultset
    Set rs = Nothing
    
    
    ''''''''''''''''''''''''''''''''''''''''
    ''''''''''''''''''CONTROLLO CORRISPETTIVI
    sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0034 "
    sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento
    sSQL = sSQL & " AND RV_POIDAssegnazioneMerce=" & IDAssegnazioneMerce
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = False
    Else
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = True
        rs.CloseResultset
        Set rs = Nothing
        Exit Function
    End If
    
    rs.CloseResultset
    Set rs = Nothing
    
    
    ''''''''''''''''''''''''''''''''''''''''
    ''''''''''''''''''CONTROLLO NOTA DI CREDITO
    sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0016 "
    sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento
    sSQL = sSQL & " AND RV_POIDAssegnazioneMerce=" & IDAssegnazioneMerce

    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = False
    Else
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = True
        rs.CloseResultset
        Set rs = Nothing
        Exit Function
    End If
    
    rs.CloseResultset
    Set rs = Nothing
        
    
    
    ''''''''''''''''''''''''''''''''''''''''
    ''''''''''''''''''CONTROLLO NOTA DI DEBITO
    sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0007 "
    sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento
    sSQL = sSQL & " AND RV_POIDAssegnazioneMerce=" & IDAssegnazioneMerce
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = False
    Else
        GET_CONTROLLA_ESISTENZA_COLLEGAMENTO = True
        rs.CloseResultset
        Set rs = Nothing
        Exit Function
    End If
    
    rs.CloseResultset
    Set rs = Nothing
    
    
    ''''''''''''''''''''''''''''''''''''''''

End If



End Function
Private Sub GET_INFO_AZIENDA(IDAzienda As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Anagrafica.IDAnagrafica, Azienda.IDAzienda, Anagrafica.Anagrafica, Anagrafica.PartitaIva, Anagrafica.Indirizzo, Anagrafica.Cap, Nazione.Nazione, "
sSQL = sSQL & "Comune.Comune , Provincia.Provincia, Regione.Regione, "
sSQL = sSQL & "Anagrafica.EMailInterno, Anagrafica.EMailInternet, Anagrafica.Telefono, Anagrafica.Fax "
sSQL = sSQL & "FROM Provincia LEFT OUTER JOIN "
sSQL = sSQL & "Regione ON Provincia.IDRegione = Regione.IDRegione RIGHT OUTER JOIN "
sSQL = sSQL & "Comune ON Provincia.IDProvincia = Comune.IDProvincia RIGHT OUTER JOIN "
sSQL = sSQL & "Azienda INNER JOIN "
sSQL = sSQL & "Anagrafica ON Azienda.IDAnagrafica = Anagrafica.IDAnagrafica ON Comune.IDComune = Anagrafica.IDComune LEFT OUTER JOIN "
sSQL = sSQL & "Nazione ON Anagrafica.IDNazione = Nazione.IDNazione "
sSQL = sSQL & " WHERE Azienda.IDAzienda=" & IDAzienda

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    AZIENDA_DENOMINAZIONE = ""
    AZIENDA_INDIRIZZO = ""
    AZIENDA_COMUNE = ""
    AZIENDA_REGIONE = ""
    AZIENDA_NAZIONE = ""
    AZIENDA_CAP = ""
    AZIENDA_PROVINCIA = ""
    AZIENDA_TELEFONO = ""
    AZIENDA_FAX = ""
    AZIENDA_EMAIL = ""
    AZIENDA_INDIRIZZOWEB = ""
    AZIENDA_PARTITA_IVA = ""
Else
    AZIENDA_DENOMINAZIONE = fnNotNull(rs!Anagrafica)
    AZIENDA_INDIRIZZO = fnNotNull(rs!Indirizzo)
    AZIENDA_COMUNE = fnNotNull(rs!Comune)
    AZIENDA_REGIONE = fnNotNull(rs!Regione)
    AZIENDA_NAZIONE = fnNotNull(rs!Nazione)
    AZIENDA_CAP = fnNotNull(rs!Cap)
    AZIENDA_PROVINCIA = fnNotNull(rs!Provincia)
    AZIENDA_TELEFONO = fnNotNull(rs!Telefono)
    AZIENDA_FAX = fnNotNull(rs!Fax)
    AZIENDA_EMAIL = fnNotNull(rs!EMailInterno)
    AZIENDA_INDIRIZZOWEB = fnNotNull(rs!EMailInternet)
    AZIENDA_PARTITA_IVA = fnNotNull(rs!PartitaIva)
End If


rs.CloseResultset
Set rs = Nothing

End Sub
Private Sub GET_INFO_FILIALE(IDAzienda As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim LINK_ATTIVITA_AZIENDA As Long

LINK_ATTIVITA_AZIENDA = GET_LINK_ATTIVITA_AZIENDA(IDAzienda, TheApp.Branch)


sSQL = "SELECT Filiale.IDFiliale, Filiale.Filiale, Filiale.Indirizzo, Filiale.CAP, Nazione.Nazione, "
sSQL = sSQL & "Comune.Comune, Provincia.Provincia, Regione.Regione "
sSQL = sSQL & "FROM Provincia LEFT OUTER JOIN "
sSQL = sSQL & "Regione ON Provincia.IDRegione = Regione.IDRegione RIGHT OUTER JOIN "
sSQL = sSQL & "Comune ON Provincia.IDProvincia = Comune.IDProvincia RIGHT OUTER JOIN "
sSQL = sSQL & "Filiale LEFT OUTER JOIN "
sSQL = sSQL & "Nazione ON Filiale.IDNazione = Nazione.IDNazione ON Comune.IDComune = Filiale.IDComune "
sSQL = sSQL & "WHERE Filiale.IDAttivitaAzienda=" & LINK_ATTIVITA_AZIENDA

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    FILIALE_DENOMINAZIONE = ""
    FILIALE_INDIRIZZO = ""
    FILIALE_COMUNE = ""
    FILIALE_REGIONE = ""
    FILIALE_NAZIONE = ""
    FILIALE_CAP = ""
    FILIALE_PROVINCIA = ""

Else
    FILIALE_DENOMINAZIONE = fnNotNull(rs!Filiale)
    FILIALE_INDIRIZZO = fnNotNull(rs!Indirizzo)
    FILIALE_COMUNE = fnNotNull(rs!Comune)
    FILIALE_REGIONE = fnNotNull(rs!Regione)
    FILIALE_NAZIONE = fnNotNull(rs!Nazione)
    FILIALE_CAP = fnNotNull(rs!Cap)
    FILIALE_PROVINCIA = fnNotNull(rs!Provincia)
End If


rs.CloseResultset
Set rs = Nothing

End Sub
Private Sub GET_INFO_CERTIFICAZIONE_AZIENDA(IDAzienda As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

'If GET_ESISTENZA_BIO(2) = False Then
'    CODICE_CERTIFICAZIONE_AZIENDA = ""
'    DESCRIZIONE_CERTIFICAZIONE_AZIENDA = ""
'    PROTOCOLLO_CERTIFICAZIONE_AZIENDA = ""
'    ENTE_CERTIFICAZIONE_AZIENDA = ""
'    Exit Sub
'End If


sSQL = "SELECT RV_PO01_ParametriFiliale.ProtocolloCertificazione, RV_PO01_Certificazione.CodiceCertificazione, RV_PO01_Certificazione.DescrizioneCertificazione, "
sSQL = sSQL & "RV_PO01_EnteCertificazione.EnteCertificazione "
sSQL = sSQL & "FROM RV_PO01_EnteCertificazione RIGHT OUTER JOIN "
sSQL = sSQL & "RV_PO01_Certificazione ON "
sSQL = sSQL & "RV_PO01_EnteCertificazione.IDRV_PO01_EnteCertificazione = RV_PO01_Certificazione.IDRV_PO01_EnteCertificazione RIGHT OUTER JOIN "
sSQL = sSQL & "RV_PO01_ParametriFiliale ON RV_PO01_Certificazione.IDRV_PO01_Certificazione = RV_PO01_ParametriFiliale.IDRV_PO01_Certificazione "
sSQL = sSQL & "WHERE RV_PO01_ParametriFiliale.IDAzienda=" & IDAzienda
sSQL = sSQL & " AND RV_PO01_ParametriFiliale.IDFiliale=" & TheApp.Branch

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    CODICE_CERTIFICAZIONE_AZIENDA = ""
    DESCRIZIONE_CERTIFICAZIONE_AZIENDA = ""
    PROTOCOLLO_CERTIFICAZIONE_AZIENDA = ""
    ENTE_CERTIFICAZIONE_AZIENDA = ""

Else
    CODICE_CERTIFICAZIONE_AZIENDA = fnNotNull(rs!CodiceCertificazione)
    DESCRIZIONE_CERTIFICAZIONE_AZIENDA = fnNotNull(rs!DescrizioneCertificazione)
    PROTOCOLLO_CERTIFICAZIONE_AZIENDA = fnNotNull(rs!ProtocolloCertificazione)
    ENTE_CERTIFICAZIONE_AZIENDA = fnNotNull(rs!EnteCertificazione)
End If


rs.CloseResultset
Set rs = Nothing

End Sub

Private Sub GET_INFO_SOCIO(IDAzienda As Long, IDAnagraficaSocio As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Fornitore.IDAnagrafica, Fornitore.IDAzienda, Anagrafica.Anagrafica, Anagrafica.Indirizzo, Anagrafica.Cap, Anagrafica.Telefono, Anagrafica.Fax, "
sSQL = sSQL & "Anagrafica.EMailInterno , Anagrafica.EMailInternet, Comune.Comune, Regione.Regione, Provincia.Provincia, Anagrafica.PartitaIva, Nazione.Nazione "
sSQL = sSQL & "FROM Nazione RIGHT OUTER JOIN "
sSQL = sSQL & "Anagrafica INNER JOIN "
sSQL = sSQL & "Fornitore ON Anagrafica.IDAnagrafica = Fornitore.IDAnagrafica ON Nazione.IDNazione = Anagrafica.IDNazione LEFT OUTER JOIN "
sSQL = sSQL & "Provincia LEFT OUTER JOIN "
sSQL = sSQL & "Regione ON Provincia.IDRegione = Regione.IDRegione RIGHT OUTER JOIN "
sSQL = sSQL & "Comune ON Provincia.IDProvincia = Comune.IDProvincia ON Anagrafica.IDComune = Comune.IDComune "
sSQL = sSQL & "WHERE Fornitore.IDAzienda=" & IDAzienda
sSQL = sSQL & " AND Fornitore.IDAnagrafica=" & IDAnagraficaSocio

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then

    SOCIO_INDIRIZZO = ""
    SOCIO_COMUNE = ""
    SOCIO_REGIONE = ""
    SOCIO_NAZIONE = ""
    SOCIO_CAP = ""
    SOCIO_PROVINCIA = ""
    SOCIO_TELEFONO = ""
    SOCIO_FAX = ""
    SOCIO_EMAIL = ""
    SOCIO_INDIRIZZOWEB = ""
    SOCIO_PARTITA_IVA = ""
Else
    
    SOCIO_INDIRIZZO = fnNotNull(rs!Indirizzo)
    SOCIO_COMUNE = fnNotNull(rs!Comune)
    SOCIO_REGIONE = fnNotNull(rs!Regione)
    SOCIO_NAZIONE = fnNotNull(rs!Nazione)
    SOCIO_CAP = fnNotNull(rs!Cap)
    SOCIO_PROVINCIA = fnNotNull(rs!Provincia)
    SOCIO_TELEFONO = fnNotNull(rs!Telefono)
    SOCIO_FAX = fnNotNull(rs!Fax)
    SOCIO_EMAIL = fnNotNull(rs!EMailInterno)
    SOCIO_INDIRIZZOWEB = fnNotNull(rs!EMailInternet)
    SOCIO_PARTITA_IVA = fnNotNull(rs!PartitaIva)
End If


rs.CloseResultset
Set rs = Nothing


End Sub
Public Function ean13$(chaine$)

  Dim I%, checksum%, first%, CodeBarre$, tableA As Boolean
  ean13$ = ""
  If Len(chaine$) = 12 Then
    For I% = 1 To 12
      If Asc(Mid$(chaine$, I%, 1)) < 48 Or Asc(Mid$(chaine$, I%, 1)) > 57 Then
        I% = 0
        Exit For
      End If
    Next
    If I% = 13 Then
      For I% = 12 To 1 Step -2
        checksum% = checksum% + Val(Mid$(chaine$, I%, 1))
      Next
      checksum% = checksum% * 3
      For I% = 11 To 1 Step -2
        checksum% = checksum% + Val(Mid$(chaine$, I%, 1))
      Next
      chaine$ = chaine$ & (10 - checksum% Mod 10) Mod 10
      CodeBarre$ = Left$(chaine$, 1) & Chr$(65 + Val(Mid$(chaine$, 2, 1)))
      first% = Val(Left$(chaine$, 1))
      For I% = 3 To 7
        tableA = False
         Select Case I%
         Case 3
           Select Case first%
           Case 0 To 3
             tableA = True
           End Select
         Case 4
           Select Case first%
           Case 0, 4, 7, 8
             tableA = True
           End Select
         Case 5
           Select Case first%
           Case 0, 1, 4, 5, 9
             tableA = True
           End Select
         Case 6
           Select Case first%
           Case 0, 2, 5, 6, 7
             tableA = True
           End Select
         Case 7
           Select Case first%
           Case 0, 3, 6, 8, 9
             tableA = True
           End Select
         End Select
       If tableA Then
         CodeBarre$ = CodeBarre$ & Chr$(65 + Val(Mid$(chaine$, I%, 1)))
       Else
         CodeBarre$ = CodeBarre$ & Chr$(75 + Val(Mid$(chaine$, I%, 1)))
       End If
     Next
      CodeBarre$ = CodeBarre$ & "*"   'Ajout séparateur central / Add middle separator
      For I% = 8 To 13
        CodeBarre$ = CodeBarre$ & Chr$(97 + Val(Mid$(chaine$, I%, 1)))
      Next
      CodeBarre$ = CodeBarre$ & "+"   'Ajout de la marque de fin / Add end mark
      ean13$ = CodeBarre$
    End If
  End If
End Function
Public Function GET_ESISTENZA_BIO(IDProgramma As Long) As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDRV_POProgramma FROM RV_POProgramma "
sSQL = sSQL & "WHERE IDRV_POProgramma=2"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_ESISTENZA_BIO = False
Else
    GET_ESISTENZA_BIO = True
End If

rs.CloseResultset
Set rs = Nothing
End Function
Public Function GET_VARIETA_ARTICOLO(IDArticolo As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

'If GET_ESISTENZA_BIO(2) = False Then
'    GET_VARIETA_ARTICOLO = ""
'Exit Function
'End If

sSQL = "SELECT RV_PO01_Varieta.Varieta "
sSQL = sSQL & "FROM Articolo LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_Varieta ON Articolo.RV_PO01_IDVarieta = RV_PO01_Varieta.IDRV_PO01_Varieta "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_VARIETA_ARTICOLO = ""
Else
    GET_VARIETA_ARTICOLO = fnNotNull(rs!Varieta)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Public Function GET_FAMIGLIA_ARTICOLO(IDArticolo As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

'If GET_ESISTENZA_BIO(2) = False Then
'    GET_FAMIGLIA_ARTICOLO = ""
'Exit Function
'End If

sSQL = "SELECT RV_PO01_FamigliaProdotti.FamigliaProdotti "
sSQL = sSQL & "FROM Articolo LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_FamigliaProdotti ON Articolo.RV_PO01_IDFamigliaProdotti = RV_PO01_FamigliaProdotti.IDRV_PO01_FamigliaProdotti "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_FAMIGLIA_ARTICOLO = ""
Else
    GET_FAMIGLIA_ARTICOLO = fnNotNull(rs!FamigliaProdotti)
End If

rs.CloseResultset
Set rs = Nothing
End Function

Public Function GET_CATEGORIA_MERCEOLOGICA_ARTICOLO(IDArticolo As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset


sSQL = "SELECT CategoriaMerceologica.CategoriaMerceologica "
sSQL = sSQL & "FROM Articolo LEFT OUTER JOIN "
sSQL = sSQL & "CategoriaMerceologica ON Articolo.IDCategoriaMerceologica = CategoriaMerceologica.IDCategoriaMerceologica "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_CATEGORIA_MERCEOLOGICA_ARTICOLO = ""
Else
    GET_CATEGORIA_MERCEOLOGICA_ARTICOLO = fnNotNull(rs!CategoriaMerceologica)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Public Function GET_DESCRIZIONE_TIPO_PRODOTTO_ARTICOLO(IDArticolo As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT TipoProdotto.TipoProdotto "
sSQL = sSQL & "FROM Articolo LEFT OUTER JOIN "
sSQL = sSQL & "TipoProdotto ON Articolo.IDTipoProdotto = TipoProdotto.IDTipoProdotto "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_DESCRIZIONE_TIPO_PRODOTTO_ARTICOLO = ""
Else
    GET_DESCRIZIONE_TIPO_PRODOTTO_ARTICOLO = fnNotNull(rs!TipoProdotto)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_ESISTENZA_ARTICOLI_DERIVATI(Optional IDArticoloDerivato As Long = 0) As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDArticolo FROM RV_POArticoloFiglio "
sSQL = sSQL & " WHERE IDArticolo=" & fnNotNullN(m_Document("IDArticolo").Value)
If (IDArticoloDerivato > 0) Then
    sSQL = sSQL & " AND IDArticoloFiglio=" & IDArticoloDerivato
End If
Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_ESISTENZA_ARTICOLI_DERIVATI = False
Else
    GET_ESISTENZA_ARTICOLI_DERIVATI = True
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_DEFAULT_REPORT_NEW(IDTipoReport As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim LINK_CONFIGURAZIONE As Long

sSQL = "SELECT IDRV_POConfigurazioneEtichetta "
sSQL = sSQL & "FROM RV_POConfigurazioneEtichetta "
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDRV_POTipoEtichetta=" & IDTipoReport
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    LINK_CONFIGURAZIONE = 0
Else
    LINK_CONFIGURAZIONE = fnNotNullN(rs!IDRV_POConfigurazioneEtichetta)
End If

rs.CloseResultset
Set rs = Nothing

'''''''''''''''''''''''''CONFIGURAZIONE PER ARTICOLO'''''''''''''''''''''''''
sSQL = "SELECT IDRV_POConfigurazioneEtichetta "
sSQL = sSQL & "FROM RV_POEtichettaPerArticolo "
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDArticolo=" & Me.CDArticolo.KeyFieldID
sSQL = sSQL & " AND IDRV_POTipoEtichetta=" & IDTipoReport
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)
 
Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    LINK_CONFIGURAZIONE = fnNotNullN(rs!IDRV_POConfigurazioneEtichetta)
End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'''''''''''''''''''''''''CONFIGURAZIONE PER CLIENTE'''''''''''''''''''''''''
sSQL = "SELECT IDRV_POConfigurazioneEtichetta "
sSQL = sSQL & "FROM RV_POEtichettaPerCliente "
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDAnagrafica=" & Me.cdCliente.KeyFieldID

sSQL = sSQL & " AND IDRV_POTipoEtichetta=" & IDTipoReport
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    LINK_CONFIGURAZIONE = fnNotNullN(rs!IDRV_POConfigurazioneEtichetta)
End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'''''''''''''''''''''''''CONFIGURAZIONE PER CLIENTE PER ARTICOLO'''''''''''''''''''''''''
sSQL = "SELECT IDRV_POConfigurazioneEtichetta "
sSQL = sSQL & "FROM RV_POEtichettaPerClienteRighe "
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDAnagrafica=" & Me.cdCliente.KeyFieldID
sSQL = sSQL & " AND IDArticolo=" & Me.CDArticolo.KeyFieldID
sSQL = sSQL & " AND IDRV_POTipoEtichetta=" & IDTipoReport
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    LINK_CONFIGURAZIONE = fnNotNullN(rs!IDRV_POConfigurazioneEtichetta)
End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

GET_DEFAULT_REPORT_NEW = LINK_CONFIGURAZIONE

End Function

Private Sub CREA_REPORT(LINK_ETICHETTA As Long, NomeReport As String)


Dim AppRep As CRAXDRT.Application
Dim repdoc As CRAXDRT.Report
Dim fld As CRAXDRT.FieldObject
Dim X_TXT As CRAXDRT.TextObject
Dim X_LINE As CRAXDRT.LineObject
Dim X_BOX As CRAXDRT.BoxObject
Dim X_FORMULA As CRAXDDRT.FormulaFieldDefinition
Dim X_GRUPPO As CRAXDDRT.GroupNameFieldDefinition
Dim X_CAMPO_GRUPPO As CRAXDRT.DatabaseFieldDefinition
Dim X_SOMMA As CRAXDDRT.RunningTotalFieldDefinition
Dim X_IMMAGINE As CRAXDDRT.OLEObject
Dim strError As String
Dim blnHasNoError As Boolean
Dim Formula As String

Dim rs As ADODB.Recordset
Dim sSQL As String
Dim I As Integer
Dim IDSection As Long
Dim ISezione As Long
Dim IDGruppoHeaderFooter As Long
Dim MAX_HEIGHT_HEADER As Double


        Set AppRep = New CRAXDRT.Application
        
        Set repdoc = AppRep.NewReport
        
        repdoc.Database.AddOLEDBSource Cn.InternalConnection, "RV_POTMPStampaEtichetteRighe"
        
        repdoc.BottomMargin = 0
        repdoc.TopMargin = 0
        repdoc.RightMargin = 0
        repdoc.LeftMargin = 0
        
        If GET_REPORT_EAN_128(LINK_ETICHETTA) = True Then
            repdoc.FormulaSyntax = crBasicSyntaxFormula
        Else
            repdoc.FormulaSyntax = crCrystalSyntaxFormula
        End If
        
        For I = 1 To repdoc.Sections.Count
            If repdoc.Sections(I).Name = "ReportHeaderSection1" Then
                repdoc.Sections(I).Suppress = True
            End If
            If repdoc.Sections(I).Name = "ReportFooterSection1" Then
                repdoc.Sections(I).Suppress = True
            End If
            If repdoc.Sections(I).Name = "PageHeaderSection1" Then
                repdoc.Sections(I).Suppress = True
            End If
            If repdoc.Sections(I).Name = "PageFooterSection1" Then
                repdoc.Sections(I).Suppress = True
            End If
        Next
        
        
        '''''''TROVA MASSIMA LUNGHEZZA DEGLI HEADER
        
        MAX_HEIGHT_HEADER = GET_TOTALE_HEIGHT_GRUPPO_HEADER(LINK_ETICHETTA)
        
        '''''''''''''''''''''''''''''''''''''''''''''''
        
        '''''''''''''''''''''''''''CREAZIONE RAGGRUPPAMENTI''''''''''''''''''''''''''''''''''''''''''''''''''
        
        sSQL = "SELECT * FROM RV_POConfigurazioneEtichettaSezione "
        sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichetta=" & LINK_ETICHETTA
        sSQL = sSQL & " ORDER BY IDRV_POConfigurazioneEtichettaSezione"
        
        Set rs = New ADODB.Recordset
        
        rs.Open sSQL, Cn.InternalConnection
            
        
        While Not rs.EOF
        '
        '
        'Set fld = repdoc.Sections(5).AddSummaryFieldObject("{RV_POTMPStampaEtichetteRighe.Colli}", crSTSum, 1 * 576, 1 * 576)
            
            Set X_CAMPO_GRUPPO = repdoc.Database.Tables(1).Fields(fnNotNullN(rs!IDCampoRaggruppamento))
            repdoc.AddGroup fnNotNullN(rs!NumeroRaggruppamento), X_CAMPO_GRUPPO, crGCAnyValue, crAscendingOrder
            For I = 1 To repdoc.Sections.Count
                If repdoc.Sections(I).Name = "GroupHeaderSection" & fnNotNullN(rs!NumeroRaggruppamento) + 1 Then
                    IDSection = I
                    SCRIVI_REPORT_GRUPPO IDSection, fnNotNullN(rs!IDRV_POConfigurazioneEtichettaSezione), repdoc, "H", LINK_ETICHETTA
                    Exit For
                End If
            Next
            For I = 1 To repdoc.Sections.Count
                If repdoc.Sections(I).Name = "GroupFooterSection" & fnNotNullN(rs!NumeroRaggruppamento) + 1 Then
                    IDSection = I
                    SCRIVI_REPORT_GRUPPO IDSection, fnNotNullN(rs!IDRV_POConfigurazioneEtichettaSezione), repdoc, "F", LINK_ETICHETTA
                    Exit For
                End If
            Next
        
            
            
        rs.MoveNext
        Wend
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        rs.Close
        Set rs = Nothing
        

        
        For I = 1 To repdoc.Sections.Count
            If repdoc.Sections(I).Name = "DetailSection1" Then
                IDSection = I
            End If
        Next
        


''''''''''''''''''''''''''''''''''''CARICA IMMAGINI''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT * FROM RV_POConfigurazioneEtichettaImmagine "
sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichetta=" & LINK_ETICHETTA
sSQL = sSQL & " AND IDRV_POConfigurazioneEtichettaSezione=" & 0
sSQL = sSQL & " AND IDRV_POConfigurazioneEtichettaSezioneRighe=" & 0
Set rs = New ADODB.Recordset

rs.Open sSQL, Cn.InternalConnection

While Not rs.EOF
    Set X_IMMAGINE = repdoc.Sections(IDSection).AddPictureObject(fnNotNull(rs!Elemento_Campo), fnNotNullN(rs!Elemento_Left) * 576, ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER))
        X_IMMAGINE.Width = fnNotNullN(rs!Elemento_Width) * 576
        X_IMMAGINE.Height = fnNotNullN(rs!Elemento_Height) * 576
rs.MoveNext
Wend


rs.Close
Set rs = Nothing
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

        sSQL = "SELECT * FROM RV_POConfigurazioneEtichettaRighe "
        sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichetta=" & LINK_ETICHETTA
        sSQL = sSQL & " AND IDRV_POConfigurazioneEtichettaSezione=" & 0
        sSQL = sSQL & " AND IDRV_POConfigurazioneEtichettaSezioneRighe=" & 0
        sSQL = sSQL & " ORDER BY IDRV_POTipoElementoEtichetta "
        
        Set rs = New ADODB.Recordset
        
        rs.Open sSQL, Cn.InternalConnection
        
        While Not rs.EOF
            Select Case rs!IDRV_POTipoElementoEtichetta
                Case 1
                     Set fld = repdoc.Sections(IDSection).AddFieldObject("{RV_POTMPStampaEtichetteRighe." & rs!Elemento_Campo & "}", rs!Elemento_Left * 576, ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER))
                         fld.Width = rs!Elemento_Width * 576
                         fld.Height = rs!Elemento_Height * 576
                         fld.Font = rs!Elemento_FontCarattere
                         fld.Font.Size = rs!Elemento_FontDimensione
                         fld.Font.Bold = rs!Elemento_FontGrassetto
                         fld.Font.Italic = rs!Elemento_FontCorsivo
                         fld.Font.Underline = rs!Elemento_FontSottolineato
                         fld.TextColor = rs!Elemento_FontColore
                         fld.BackColor = rs!Elemento_FontSfondo
                         Select Case rs!Elemento_Allineamento
                            Case 0
                                fld.HorAlignment = crLeftAlign
                            Case 1
                                fld.HorAlignment = crRightAlign
                            Case 2
                                fld.HorAlignment = crHorCenterAlign
                            Case Else
                                fld.HorAlignment = crDefaultAlign
                         End Select
                         
                         
                         
                         fld.Suppress = fnNotNullN(rs!Soppresso)
                         Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                            
                            Case 0
                                fld.TextRotationAngle = crRotate0
                            Case 90
                                fld.TextRotationAngle = crRotate90
                            Case 180
                                fld.TextRotationAngle = crRotate0
                            Case 270
                                fld.TextRotationAngle = crRotate270
                            Case Else
                         End Select

                Case 2
                     Set X_TXT = repdoc.Sections(IDSection).AddTextObject(rs!Elemento_Testo, rs!Elemento_Left * 576, ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER))
                         X_TXT.Width = rs!Elemento_Width * 576
                         X_TXT.Height = rs!Elemento_Height * 576
                         X_TXT.Font = rs!Elemento_FontCarattere
                         X_TXT.Font.Size = rs!Elemento_FontDimensione
                         X_TXT.Font.Bold = rs!Elemento_FontGrassetto
                         X_TXT.Font.Italic = rs!Elemento_FontCorsivo
                         X_TXT.Font.Underline = rs!Elemento_FontSottolineato
                         X_TXT.TextColor = rs!Elemento_FontColore
                         X_TXT.BackColor = rs!Elemento_FontSfondo
                         Select Case rs!Elemento_Allineamento
                            
                            Case 0
                                X_TXT.HorAlignment = crLeftAlign
                            Case 1
                                X_TXT.HorAlignment = crRightAlign
                            Case 2
                                X_TXT.HorAlignment = crHorCenterAlign
                            Case Else
                                X_TXT.HorAlignment = crDefaultAlign
                         End Select
                         
                         X_TXT.Suppress = fnNotNullN(rs!Soppresso)
                        
                        Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                            
                            Case 0
                                X_TXT.TextRotationAngle = crRotate0
                            Case 90
                                X_TXT.TextRotationAngle = crRotate90
                            Case 180
                                X_TXT.TextRotationAngle = crRotate0
                            Case 270
                                X_TXT.TextRotationAngle = crRotate270
                            Case Else
                         End Select
                Case 3
                    If fnNotNullN(rs!Elemento_Width) <= 0.5 Then 'LINEA VERTICALE
                        'Set X_LINE = repdoc.Sections(IDSection).AddLineObject(rs!Elemento_left * 576, ((rs!Elemento_top * 576) - MAX_HEIGHT_HEADER), rs!Elemento_height * 576, rs!Elemento_height * 576)
                        'X_LINE.Suppress = fnNotNullN(rs!Soppresso)
                        'X_LINE.LineColor = fnNotNullN(rs!Elemento_FontSfondo)
                        
                        Set X_LINE = repdoc.Sections(IDSection).AddLineObject(rs!Elemento_Left * 576, ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER), rs!Elemento_Height * 576, ((rs!Elemento_Height * 576) + (((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER))))
                        X_LINE.Suppress = fnNotNullN(rs!Soppresso)
                        X_LINE.LineColor = fnNotNullN(rs!Elemento_FontSfondo)
                        
                    Else 'LINEA ORIZZONTALE
                        Set X_LINE = repdoc.Sections(IDSection).AddLineObject(rs!Elemento_Left * 576, ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER), ((rs!Elemento_Width * 576) + (rs!Elemento_Left * 576)), ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER))
                        X_LINE.Suppress = fnNotNullN(rs!Soppresso)
                        X_LINE.LineColor = fnNotNullN(rs!Elemento_FontSfondo)
                    End If
               
                Case 4
                    Set X_BOX = repdoc.Sections(IDSection).AddBoxObject(rs!Elemento_Left * 576, ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER), rs!Elemento_Width * 576, rs!Elemento_Height * 576)
                    X_BOX.Suppress = fnNotNullN(rs!Soppresso)
                    X_BOX.FillColor = rs!Elemento_FontSfondo
                Case 5
                    Set X_FORMULA = repdoc.FormulaFields.Add(rs!Elemento_Campo, rs!Elemento_Testo)
                    Set fld = repdoc.Sections(IDSection).AddFieldObject(X_FORMULA.Name, rs!Elemento_Left * 576, ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER))
                         fld.Width = rs!Elemento_Width * 576
                         fld.Height = rs!Elemento_Height * 576
                         fld.Font = rs!Elemento_FontCarattere
                         fld.Font.Size = rs!Elemento_FontDimensione
                         fld.Font.Bold = rs!Elemento_FontGrassetto
                         fld.Font.Italic = rs!Elemento_FontCorsivo
                         fld.Font.Underline = rs!Elemento_FontSottolineato
                         fld.TextColor = rs!Elemento_FontColore
                         fld.BackColor = rs!Elemento_FontSfondo
                         Select Case rs!Elemento_Allineamento
                            
                            Case 0
                                fld.HorAlignment = crLeftAlign
                            Case 1
                                fld.HorAlignment = crRightAlign
                            Case 2
                                fld.HorAlignment = crHorCenterAlign
                            Case Else
                                fld.HorAlignment = crDefaultAlign
                         End Select
                         
                         
                         
                         fld.Suppress = fnNotNullN(rs!Soppresso)
                        Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                            
                            Case 0
                                fld.TextRotationAngle = crRotate0
                            Case 90
                                fld.TextRotationAngle = crRotate90
                            Case 180
                                fld.TextRotationAngle = crRotate0
                            Case 270
                                fld.TextRotationAngle = crRotate270
                            Case Else
                         End Select
                Case 6
                    Set fld = repdoc.Sections(IDSection).AddSummaryFieldObject("{RV_POTMPStampaEtichetteRighe." & rs!Elemento_Campo & "}", crSTSum, rs!Elemento_Left * 576, ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER))
                         fld.Width = rs!Elemento_Width * 576
                         fld.Height = rs!Elemento_Height * 576
                         fld.Font = rs!Elemento_FontCarattere
                         fld.Font.Size = rs!Elemento_FontDimensione
                         fld.Font.Bold = rs!Elemento_FontGrassetto
                         fld.Font.Italic = rs!Elemento_FontCorsivo
                         fld.Font.Underline = rs!Elemento_FontSottolineato
                         fld.TextColor = rs!Elemento_FontColore
                         fld.BackColor = rs!Elemento_FontSfondo
                         Select Case rs!Elemento_Allineamento
                            Case 0
                                fld.HorAlignment = crLeftAlign
                            Case 1
                                fld.HorAlignment = crRightAlign
                            Case 2
                                fld.HorAlignment = crHorCenterAlign
                            Case Else
                                fld.HorAlignment = crDefaultAlign
                         End Select
                         
                         
                         
                         fld.Suppress = fnNotNullN(rs!Soppresso)
                        Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                            
                            Case 0
                                fld.TextRotationAngle = crRotate0
                            Case 90
                                fld.TextRotationAngle = crRotate90
                            Case 180
                                fld.TextRotationAngle = crRotate0
                            Case 270
                                fld.TextRotationAngle = crRotate270
                            Case Else
                         End Select
                Case 8
                    Set X_FORMULA = repdoc.FormulaFields.Add("@" & rs!Elemento_Testo, GET_FORMULA_EAN_128(rs!Elemento_Testo, FormatNumber((fnNotNullN(rs!Elemento_Height) * 10), 0)))
                    Set fld = repdoc.Sections(IDSection).AddFieldObject(X_FORMULA.Name, rs!Elemento_Left * 576, ((rs!Elemento_Top * 576) - MAX_HEIGHT_HEADER))
                         
                         fld.Width = rs!Elemento_Width * 576
                         fld.Height = rs!Elemento_Height * 576
                         fld.Font = rs!Elemento_FontCarattere
                         fld.Font.Size = rs!Elemento_FontDimensione
                         fld.Font.Bold = rs!Elemento_FontGrassetto
                         fld.Font.Italic = rs!Elemento_FontCorsivo
                         fld.Font.Underline = rs!Elemento_FontSottolineato
                         fld.TextColor = rs!Elemento_FontColore
                         fld.BackColor = rs!Elemento_FontSfondo
                         fld.CanGrow = True

                         Select Case rs!Elemento_Allineamento
                            
                            Case 0
                                fld.HorAlignment = crLeftAlign
                            Case 1
                                fld.HorAlignment = crRightAlign
                            Case 2
                                fld.HorAlignment = crHorCenterAlign
                            Case Else
                                fld.HorAlignment = crDefaultAlign
                         End Select
                         
                         
                         fld.Suppress = fnNotNullN(rs!Soppresso)
                        Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                            
                            Case 0
                                fld.TextRotationAngle = crRotate0
                            Case 90
                                fld.TextRotationAngle = crRotate90
                            Case 180
                                fld.TextRotationAngle = crRotate0
                            Case 270
                                fld.TextRotationAngle = crRotate270
                            Case Else
                        End Select

                Case Else
                    
                        
                
            End Select

                    
        rs.MoveNext
        Wend
    
    
    
    For I = 1 To repdoc.FormulaFields.Count
    
        repdoc.FormulaFields(I).Check blnHasNoError, strError
     
        If blnHasNoError = True Then
            
        Else
           MsgBox strError, vbCritical, repdoc.FormulaFields(I).Name
           MsgBox "Impossbile salvare il report", vbInformation, "Configurazione report"
           Exit Sub
        End If
    Next I
    
    If repdoc.Sections(IDSection).Height > (Me.txt_Y_Lavorazione * 576) Then
        repdoc.Sections(IDSection).Height = (Me.txt_Y_Lavorazione - 1) * 576
    End If
    
    repdoc.SaveAs MenuOptions.ReportsPath & "\" & NomeReport, crDefaultFileFormat

End Sub
Private Sub SCRIVI_REPORT_GRUPPO(IDSection As Long, IDGruppo As Long, repdoc As CRAXDDRT.Report, TipoGruppo As String, LINK_ETICHETTA As Long)
On Error Resume Next
Dim fld As CRAXDRT.FieldObject
Dim X_TXT As CRAXDRT.TextObject
Dim X_LINE As CRAXDRT.LineObject
Dim X_BOX As CRAXDRT.BoxObject
Dim X_FORMULA As CRAXDDRT.FormulaFieldDefinition
Dim X_GRUPPO As CRAXDDRT.GroupNameFieldDefinition
Dim X_CAMPO_GRUPPO As CRAXDRT.DatabaseFieldDefinition
Dim X_SOMMA As CRAXDDRT.RunningTotalFieldDefinition
Dim X_IMMAGINE As CRAXDDRT.OLEObject
Dim rs As ADODB.Recordset
Dim sSQL As String
Dim IDGruppoHeaderFooter As Long
Dim HEIGHT_HEADER As Double

sSQL = "SELECT * FROM RV_POConfigurazioneEtichettaSezioneRighe "
sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichettaSezione=" & IDGruppo
sSQL = sSQL & " AND Tipo=" & fnNormString(TipoGruppo)

Set rs = New ADODB.Recordset

rs.Open sSQL, Cn.InternalConnection

If Not rs.EOF Then
    repdoc.Sections(IDSection).Suppress = fnNotNullN(rs!Soppresso)
    IDGruppoHeaderFooter = fnNotNullN(rs!IDRV_POConfigurazioneEtichettaSezioneRighe)
    HEIGHT_HEADER = fnNotNullN(rs!GruppoHeight)
End If

rs.Close
Set rs = Nothing

''''''''''''''''''''''''''''''''''''CARICA IMMAGINI''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT * FROM RV_POConfigurazioneEtichettaImmagine "
sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichetta=" & LINK_ETICHETTA
sSQL = sSQL & " AND IDRV_POConfigurazioneEtichettaSezione=" & IDGruppo
sSQL = sSQL & " AND IDRV_POConfigurazioneEtichettaSezioneRighe=" & IDGruppoHeaderFooter
Set rs = New ADODB.Recordset

rs.Open sSQL, Cn.InternalConnection

While Not rs.EOF
    Set X_IMMAGINE = repdoc.Sections(IDSection).AddPictureObject(fnNotNull(rs!Elemento_Campo), fnNotNullN(rs!Elemento_Left) * 576, fnNotNullN(rs!Elemento_Top) * 576)
        X_IMMAGINE.Width = fnNotNullN(rs!Elemento_Width) * 576
        X_IMMAGINE.Height = fnNotNullN(rs!Elemento_Height) * 576
rs.MoveNext
Wend


rs.Close
Set rs = Nothing
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''



sSQL = "SELECT * FROM RV_POConfigurazioneEtichettaRighe "
sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichetta=" & LINK_ETICHETTA
sSQL = sSQL & " AND IDRV_POConfigurazioneEtichettaSezione=" & IDGruppo
sSQL = sSQL & " AND IDRV_POConfigurazioneEtichettaSezioneRighe=" & IDGruppoHeaderFooter
sSQL = sSQL & " ORDER BY IDRV_POTipoElementoEtichetta "


Set rs = New ADODB.Recordset

rs.Open sSQL, Cn.InternalConnection


While Not rs.EOF
    Select Case rs!IDRV_POTipoElementoEtichetta
        Case 1
             Set fld = repdoc.Sections(IDSection).AddFieldObject("{RV_POTMPStampaEtichetteRighe." & rs!Elemento_Campo & "}", rs!Elemento_Left * 576, rs!Elemento_Top * 576)
                 fld.Width = rs!Elemento_Width * 576
                 fld.Height = rs!Elemento_Height * 576
                 fld.Font = rs!Elemento_FontCarattere
                 fld.Font.Size = rs!Elemento_FontDimensione
                 fld.Font.Bold = rs!Elemento_FontGrassetto
                 fld.Font.Italic = rs!Elemento_FontCorsivo
                 fld.Font.Underline = rs!Elemento_FontSottolineato
                 fld.TextColor = rs!Elemento_FontColore
                 fld.BackColor = rs!Elemento_FontSfondo
                 Select Case rs!Elemento_Allineamento
                    Case 0
                        fld.HorAlignment = crLeftAlign
                    Case 1
                        fld.HorAlignment = crRightAlign
                    Case 2
                        fld.HorAlignment = crHorCenterAlign
                    Case Else
                        fld.HorAlignment = crDefaultAlign
                 End Select
                 
                 
                 
                 fld.Suppress = False
               Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                   
                   Case 0
                       fld.TextRotationAngle = crRotate0
                   Case 90
                       fld.TextRotationAngle = crRotate90
                   Case 180
                       fld.TextRotationAngle = crRotate0
                   Case 270
                       fld.TextRotationAngle = crRotate270
                   Case Else
                End Select
        Case 2
             Set X_TXT = repdoc.Sections(IDSection).AddTextObject(rs!Elemento_Testo, rs!Elemento_Left * 576, rs!Elemento_Top * 576)
                 X_TXT.Width = rs!Elemento_Width * 576
                 X_TXT.Height = rs!Elemento_Height * 576
                 X_TXT.Font = rs!Elemento_FontCarattere
                 X_TXT.Font.Size = rs!Elemento_FontDimensione
                 X_TXT.Font.Bold = rs!Elemento_FontGrassetto
                 X_TXT.Font.Italic = rs!Elemento_FontCorsivo
                 X_TXT.Font.Underline = rs!Elemento_FontSottolineato
                 X_TXT.TextColor = rs!Elemento_FontColore
                 X_TXT.BackColor = rs!Elemento_FontSfondo
                 X = X_TXT.LineSpacing
                 Select Case rs!Elemento_Allineamento
                    
                    Case 0
                        X_TXT.HorAlignment = crLeftAlign
                    Case 1
                        X_TXT.HorAlignment = crRightAlign
                    Case 2
                        X_TXT.HorAlignment = crHorCenterAlign
                    Case Else
                        X_TXT.HorAlignment = crDefaultAlign
                 End Select
                 
                 X_TXT.Suppress = False
               Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                   
                   Case 0
                       X_TXT.TextRotationAngle = crRotate0
                   Case 90
                       X_TXT.TextRotationAngle = crRotate90
                   Case 180
                       X_TXT.TextRotationAngle = crRotate0
                   Case 270
                       X_TXT.TextRotationAngle = crRotate270
                   Case Else
                End Select
        
        Case 3
            If fnNotNullN(rs!Elemento_Width) <= 0.5 Then 'LINEA VERTICALE
                'Set X_LINE = repdoc.Sections(IDSection).AddLineObject(rs!Elemento_left * 576, ((rs!Elemento_top * 576) - MAX_HEIGHT_HEADER), rs!Elemento_height * 576, rs!Elemento_height * 576)
                'X_LINE.Suppress = fnNotNullN(rs!Soppresso)
                'X_LINE.LineColor = fnNotNullN(rs!Elemento_FontSfondo)
                
                Set X_LINE = repdoc.Sections(IDSection).AddLineObject(rs!Elemento_Left * 576, rs!Elemento_Top * 576, rs!Elemento_Height * 576, ((rs!Elemento_Height * 576) + (rs!Elemento_Top * 576)))
                X_LINE.Suppress = fnNotNullN(rs!Soppresso)
                X_LINE.LineColor = fnNotNullN(rs!Elemento_FontSfondo)
                
            Else 'LINEA ORIZZONTALE
                Set X_LINE = repdoc.Sections(IDSection).AddLineObject(rs!Elemento_Left * 576, rs!Elemento_Top * 576, ((rs!Elemento_Width * 576) + (rs!Elemento_Left * 576)), rs!Elemento_Top * 576)
                X_LINE.Suppress = fnNotNullN(rs!Soppresso)
                X_LINE.LineColor = fnNotNullN(rs!Elemento_FontSfondo)
            End If
        Case 4
            Set X_BOX = repdoc.Sections(IDSection).AddBoxObject(rs!Elemento_Left * 576, rs!Elemento_Top * 576, ((rs!Elemento_Width * 576) + (rs!Elemento_Left * 576)), ((rs!Elemento_Height * 576) + (rs!Elemento_Top * 576)))
            X_BOX.Suppress = False
            X_BOX.FillColor = rs!Elemento_FontSfondo
        Case 5
            Set X_FORMULA = repdoc.FormulaFields.Add(rs!Elemento_Campo, rs!Elemento_Testo)
            Set fld = repdoc.Sections(IDSection).AddFieldObject(X_FORMULA.Name, rs!Elemento_Left * 576, rs!Elemento_Top * 576)
                 fld.Width = rs!Elemento_Width * 576
                 fld.Height = rs!Elemento_Height * 576
                 fld.Font = rs!Elemento_FontCarattere
                 fld.Font.Size = rs!Elemento_FontDimensione
                 fld.Font.Bold = rs!Elemento_FontGrassetto
                 fld.Font.Italic = rs!Elemento_FontCorsivo
                 fld.Font.Underline = rs!Elemento_FontSottolineato
                 fld.TextColor = rs!Elemento_FontColore
                 fld.BackColor = rs!Elemento_FontSfondo
                 Select Case rs!Elemento_Allineamento
                    
                    Case 0
                        fld.HorAlignment = crLeftAlign
                    Case 1
                        fld.HorAlignment = crRightAlign
                    Case 2
                        fld.HorAlignment = crHorCenterAlign
                    Case Else
                        fld.HorAlignment = crDefaultAlign
                 End Select
                 
                 
                 
                 fld.Suppress = False
               Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                   
                   Case 0
                       fld.TextRotationAngle = crRotate0
                   Case 90
                       fld.TextRotationAngle = crRotate90
                   Case 180
                       fld.TextRotationAngle = crRotate0
                   Case 270
                       fld.TextRotationAngle = crRotate270
                   Case Else
                End Select
        Case 6
            Set fld = repdoc.Sections(IDSection).AddSummaryFieldObject("{RV_POTMPStampaEtichetteRighe." & rs!Elemento_Campo & "}", crSTSum, rs!Elemento_Left * 576, rs!Elemento_Top * 576)
                 fld.Width = rs!Elemento_Width * 576
                 fld.Height = rs!Elemento_Height * 576
                 fld.Font = rs!Elemento_FontCarattere
                 fld.Font.Size = rs!Elemento_FontDimensione
                 fld
                 fld.Font.Bold = rs!Elemento_FontGrassetto
                 fld.Font.Italic = rs!Elemento_FontCorsivo
                 fld.Font.Underline = rs!Elemento_FontSottolineato
                 fld.TextColor = rs!Elemento_FontColore
                 fld.BackColor = rs!Elemento_FontSfondo
                 Select Case rs!Elemento_Allineamento
                    Case 0
                        fld.HorAlignment = crLeftAlign
                    Case 1
                        fld.HorAlignment = crRightAlign
                    Case 2
                        fld.HorAlignment = crHorCenterAlign
                    Case Else
                        fld.HorAlignment = crDefaultAlign
                 End Select
                 
                 
                 
                 fld.Suppress = False
               Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                   
                   Case 0
                       fld.TextRotationAngle = crRotate0
                   Case 90
                       fld.TextRotationAngle = crRotate90
                   Case 180
                       fld.TextRotationAngle = crRotate0
                   Case 270
                       fld.TextRotationAngle = crRotate270
                   Case Else
                End Select
            
            Case 8
                Set X_FORMULA = repdoc.FormulaFields.Add("@" & rs!Elemento_Testo, GET_FORMULA_EAN_128(rs!Elemento_Testo, FormatNumber((fnNotNullN(rs!Elemento_Height) * 10), 0)))
                Set fld = repdoc.Sections(IDSection).AddFieldObject(X_FORMULA.Name, rs!Elemento_Left * 576, rs!Elemento_Top * 576)
                     
                 fld.Width = rs!Elemento_Width * 576
                 fld.Height = rs!Elemento_Height * 576
                 fld.Font = rs!Elemento_FontCarattere
                 fld.Font.Size = rs!Elemento_FontDimensione
                 fld.Font.Bold = rs!Elemento_FontGrassetto
                 fld.Font.Italic = rs!Elemento_FontCorsivo
                 fld.Font.Underline = rs!Elemento_FontSottolineato
                 fld.TextColor = rs!Elemento_FontColore
                 fld.BackColor = rs!Elemento_FontSfondo
                 fld.CanGrow = True
                
                 Select Case rs!Elemento_Allineamento
                    
                    Case 0
                        fld.HorAlignment = crLeftAlign
                    Case 1
                        fld.HorAlignment = crRightAlign
                    Case 2
                        fld.HorAlignment = crHorCenterAlign
                    Case Else
                        fld.HorAlignment = crDefaultAlign
                 End Select
                 
                 
                 
                 fld.Suppress = fnNotNullN(rs!Soppresso)
                Select Case fnNotNullN(rs!Elemento_Gradi_Rotazioni)
                    
                    Case 0
                        fld.TextRotationAngle = crRotate0
                    Case 90
                        fld.TextRotationAngle = crRotate90
                    Case 180
                        fld.TextRotationAngle = crRotate0
                    Case 270
                        fld.TextRotationAngle = crRotate270
                    Case Else
                End Select
        Case Else
        
    End Select
    
rs.MoveNext
Wend
rs.Close
Set rs = Nothing

If repdoc.Sections(IDSection).Height >= HEIGHT_HEADER * 576 Then
    repdoc.Sections(IDSection).Height = (HEIGHT_HEADER - 1) * 576
Else
    repdoc.Sections(IDSection).Height = HEIGHT_HEADER * 576
End If
End Sub
Private Function GET_TOTALE_HEIGHT_GRUPPO_HEADER(IDEtichetta As Long) As Double
Dim sSQL As String
Dim rs As ADODB.Recordset


sSQL = "SELECT Sum(GruppoHeight) AS MAX_HEIGHT "
sSQL = sSQL & "FROM RV_POConfigurazioneEtichettaSezioneRighe "
sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichetta=" & IDEtichetta
sSQL = sSQL & " AND Tipo=" & fnNormString("H")

Set rs = New ADODB.Recordset

rs.Open sSQL, Cn.InternalConnection

    
If rs.EOF Then
    GET_TOTALE_HEIGHT_GRUPPO_HEADER = 0
Else
    GET_TOTALE_HEIGHT_GRUPPO_HEADER = fnNotNullN(rs!MAX_HEIGHT) * 576
End If


rs.Close
Set rs = Nothing
End Function

Private Sub SCRIVI_ETICHETTE_LAVORAZIONE_NEW(IDConfigurazioneEtichetta As Long)
'On Error GoTo ERR_CmdStampaEtichette_Click
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim rsEti As ADODB.Recordset
Dim rsNew As ADODB.Recordset
Dim I As Integer
Dim Unita_progresso
Dim NumeroRecord As Long
Dim Link_Lotto As Long

        sSQL = "DELETE FROM RV_POTMPStampaEtichetteRighe "
        sSQL = sSQL & "WHERE IDUtente=" & TheApp.IDUser
        Cn.Execute sSQL
    
        
        Screen.MousePointer = 11
        Set rsNew = New ADODB.Recordset
        sSQL = "SELECT * FROM RV_POTMPStampaEtichetteRighe "
        sSQL = sSQL & "WHERE IDUtente=" & TheApp.IDUser
        
        rsNew.Open sSQL, Cn.InternalConnection, adOpenDynamic, adLockPessimistic
            Cn.BeginTrans
            rsNew.AddNew
                'CAMPI OBBLIGATORI
                rsNew!IDUtente = TheApp.IDUser
                rsNew!IDAzienda = TheApp.IDFirm
                rsNew!IDFiliale = TheApp.Branch
                rsNew!IDRV_POAssegnazioneMerce = fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)
                rsNew!IDRV_POPedana = Me.txtIDPedana.Value
                rsNew!CodicePedana = Me.txtCodicePedana.Text
                
                'CAMPI LAVORAZIONE
                rsNew!IDArticolo = Me.CDArticolo.KeyFieldID
                rsNew!CodiceArticolo = Me.CDArticolo.Code
                rsNew!Articolo = Me.TxtArticolo.Text
                rsNew!IDArticoloImballo = Me.CDCodiceImballo.KeyFieldID
                rsNew!CodiceImballo = Me.CDCodiceImballo.Code
                rsNew!Imballo = Me.CDCodiceImballo.Description
                rsNew!Colli = Me.txtColli.Value
                rsNew!PesoLordo = Me.txtPesoLordo.Value
                rsNew!Tara = Me.txtTara.Value
                rsNew!PesoNetto = Me.txtPesoNetto.Value
                rsNew!Pezzi = Me.txtPezzi.Value
                rsNew!Qta_UM = Me.txtQta_UM.Value
                If fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value) <= 0 Then
                    Link_Lotto = GET_NUMERO_LOTTO
                    rsNew!CodiceLotto = fnGetCodiceLotto(2, 1, Me.txtLottoVendita.Text, Link_Lotto)
                Else
                    rsNew!CodiceLotto = Me.txtLottoVendita.Text
                End If
                rsNew!IDAnagraficaSocio = fnNotNullN(m_Document("IDAnagrafica").Value)
                rsNew!AnagraficaSocio = fnNotNull(m_Document("Anagrafica").Value)
                rsNew!NomeSocio = fnNotNull(m_Document("Nome").Value)
                rsNew!CodiceSocio = fnNotNull(m_Document("CodiceSocio").Value)
                rsNew!IDRV_POCalibro = Me.cboCalibro.CurrentID
                rsNew!Calibro = Me.cboCalibro.Text
                rsNew!IDRV_POTipoCategoria = Me.cboTipoCategoria.CurrentID
                rsNew!TipoCategoria = Me.cboTipoCategoria.Text
                rsNew!CodiceABarreArticolo = Me.txtCodBarreArtAzienda.Text
                rsNew!DescrizioneCodiceABarreArticoloAzienda = Me.txtDescrCodBarreArtAzienda.Text
                rsNew!CodiceABarreImballoAzienda = Me.txtCodBarreImbAzienda.Text
                rsNew!DescrizioneCodiceABarreImballoAzienda = Me.txtDescrCodBarreImbAzienda.Text
                rsNew!LinguaPredefinita = Me.cboLinguaPred.Text
                rsNew!CodicePostazioneUtente = Me.txtCodicePostazione.Text
                rsNew!TipoProdottoArticoloLavorato = TIPO_PRODOTTO_ARTICOLO_LAVORATO
                rsNew!CategoriaMerceologicaArticoloLavorato = CATEGORIA_MERCEOLOGICA_ARTICOLO_LAVORATO
                rsNew!FamigliaArticoloLavorato = FAMIGLIA_ARTICOLO_LAVORATO
                rsNew!VarietaArticoloLavorato = VARIETA_ARTICOLO_LAVORATO
                rsNew!UnitaDiMisuraArticoloLavorato = Me.cboUM.Text
                rsNew!UnitaDiMisuraImballoLavorato = Me.cboUMImballo.Text
                If Me.txtDataOrdine.Value > 0 Then
                    rsNew!DataOrdine = Me.txtDataOrdine.Text
                End If
                rsNew!NumeroOrdine = Me.txtNumeroOrdine.Value
                If Me.txtDataOrdineCliente.Value > 0 Then
                    rsNew!DataOrdinePressoCliente = Me.txtDataOrdineCliente.Text
                End If
                rsNew!NumeroOrdinePressoCliente = Me.txtNumeroOrdineCliente.Text
            
                If Trim(Me.txtArticoloInLinguaPred.Text) <> "" Then
                    rsNew!DescrizioneArticoloInLinguaPredefinita = Me.txtArticoloInLinguaPred.Text
                Else
                     rsNew!DescrizioneArticoloInLinguaPredefinita = Me.TxtArticolo.Text
                End If
                If Trim(Me.txtCalibroInLiguaPred.Text) <> "" Then
                    rsNew!DescrizioneCalibroInLinguaPredefinita = Me.txtCalibroInLiguaPred.Text
                Else
                    rsNew!DescrizioneCalibroInLinguaPredefinita = Me.cboCalibro.Text
                End If
                
                If Trim(Me.txtCategoriaInLinguaPred.Text) <> "" Then
                    rsNew!DescrizioneCategoriaInLinguaPredefinita = Me.txtCategoriaInLinguaPred.Text
                Else
                    rsNew!DescrizioneCategoriaInLinguaPredefinita = Me.cboTipoCategoria.Text
                End If
                

                
                'MERCE
                'rsNew!IDRegione = fnNotNullN(m_Document("IDRegione").Value)
                rsNew!Regione = REGIONE_PROVENIENZA 'Me.txtRegioneProvenienza.Text
                'rsNew!IDNazione = fnNotNullN(m_Document("IDNazione").Value)
                rsNew!Nazione = NAZIONE_PROVENIENZA 'Me.txtNazioneProvenienza.Text
                'rsNew!IDComune = fnNotNullN(m_Document("IDComune").Value)
                rsNew!Comune = COMUNE_PROVENIENZA ' Me.txtComuneProvenienza.Text
                'rsNew!IDProvincia = fnNotNullN(m_Document("IDProvincia").Value)
                rsNew!Provincia = PROVINCIA_PROVENIENZA ' Me.txtProvinciaProvenienza.Text
                
                'DATI CONFERIMENTO
                rsNew!LottoDiConferimento = Me.txtCodiceLotto_Conf.Text
                rsNew!BNDOO = BNDOO ' Me.txtBNDOO.Text
                rsNew!IDLottoDiCampagna = fnNotNullN(m_Document("IDLottoDiCampagna").Value)
                rsNew!CodiceCertificazioneLotto = CODICE_CERTIFICAZIONE_LOTTO_ETI
                rsNew!DescrizioneCertificazioneLotto = DESCRIZIONE_CERTIFICAZIONE_LOTTO_ETI
                rsNew!ProtocolloCertificazioneLotto = PROTOCOLLO_CERTIFICAZIONE_LOTTO_ETI
                rsNew!EnteCertificatoreLotto = ENTE_CERTIFICAZIONE_LOTTO_ETI
                rsNew!CodiceCertificazioneSocioPred = CODICE_CERTIFICAZIONE_SOCIO_ETI
                rsNew!DescrizioneCertificazioneSocioPred = DESCRIZIONE_CERTIFICAZIONE_SOCIO_ETI
                rsNew!ProtocolloCertificazioneSocioPred = PROTOCOLLO_CERTIFICAZIONE_SOCIO_ETI
                rsNew!EnteCertificatoreSocioPred = ENTE_CERTIFICAZIONE_SOCIO_ETI
                rsNew!IDCategoriaMerceologica = fnNotNullN(m_Document("IDCategoriaMerceologica").Value) 'X
                rsNew!CategoriaMerceologica = fnNotNull(m_Document("CategoriaMerceologica").Value) 'X
                rsNew!IDTipoProdotto = fnNotNullN(m_Document("IDTipoProdotto").Value) 'X
                rsNew!TipoProdotto = fnNotNull(m_Document("TipoProdotto").Value) 'X
                rsNew!CodiceLottoEntrata = Me.txtLottoEntrata.Text
                rsNew!CodiceAssociato = CODICE_ASSOCIATO_PRED 'Me.txtCodiceAssociatoPredefinito.Text
                rsNew!IDVarietaLottoCampagna = LINK_VARIETA_LOTTO_CAMPAGNA
                rsNew!IDFamigliaLottoCampagna = LINK_FAMIGLIA_LOTTO_CAMPAGNA
                rsNew!VarietaLottoCampagna = VARIETA_LOTTO_CAMPAGNA
                rsNew!FamigliaLottoCampagna = FAMIGLIA_LOTTO_CAMPAGNA
                rsNew!IDTipoProduzioneLottoCampagna = LINK_TIPO_PRODUZIONE_LOTTO_CAMPAGNA
                rsNew!TipoProduzioneLottoCampagna = TIPO_PRODUZIONE_LOTTO_CAMPAGNA
                rsNew!VarietaArticoloConferito = VARIETA_ARTICOLO_CONFERITO
                rsNew!FamigliaArticoloConferito = FAMIGLIA_ARTICOLO_CONFERITO
                rsNew!DataConfezionamento = Me.txtDataLavorazione.Text
                rsNew!NumeroConferimento = fnNotNullN(m_Document("NumeroDocumento").Value)
                
                'CAMPI CLIENTE
                rsNew!NumeroPedanaCliente = Me.txtCodicePedanaCliente.Value
                rsNew!CodicePedanaCliente = Me.txtCodificaCodicePedanaCliente.Text
                rsNew!IDAnagraficaCliente = Me.cdCliente.KeyFieldID
                rsNew!AnagraficaCliente = Me.cdCliente.Description
                rsNew!LottoCliente = Me.txtLottoCliente.Text
                rsNew!AltreAnnotazioniCliente = Me.txtAltreAnnotazioniCliente.Text
                rsNew!CLIENTE_INDIRIZZO = CLIENTE_INDIRIZZO
                rsNew!CLIENTE_COMUNE = CLIENTE_COMUNE
                rsNew!CLIENTE_PROVINCIA = CLIENTE_PROVINCIA
                rsNew!CLIENTE_REGIONE = CLIENTE_REGIONE
                rsNew!CLIENTE_NAZIONE = CLIENTE_NAZIONE
                rsNew!CLIENTE_PARTITAIVA = CLIENTE_PARTITA_IVA
                rsNew!CLIENTE_CAP = CLIENTE_CAP
                rsNew!CLIENTE_PROVINCIA = CLIENTE_PROVINCIA
                rsNew!CLIENTE_TELEFONO = CLIENTE_TELEFONO
                rsNew!CLIENTE_FAX = CLIENTE_FAX
                rsNew!CLIENTE_EMAIL = CLIENTE_EMAIL
                rsNew!CLIENTE_INDIRIZZOWEB = CLIENTE_INDIRIZZOWEB
                rsNew!CLIENTE_NOME = CLIENTE_NOME
                
                If Me.txtDataPartenza.Value > 0 Then
                    rsNew!DataPartenzaOrdine = Me.txtDataPartenza.Text
                End If
                rsNew!CodiceAssociatoPressoCliente = Me.txtCodiceAssociatoPressoCliente.Text
                rsNew!CodiceABarreArticoloCliente = Me.txtCodificaArticoloCodiceABarre.Text
                rsNew!DescrizioneCodiceABarreArticoloCliente = Me.txtCodiceABarreArticoloCliente.Text
                rsNew!CodiceABarreImballoCliente = Me.txtCodificaImballoCodiceABarre.Text
                rsNew!DescrizioneCodiceABarreImballoCliente = Me.txtCodiceABarreImballoCliente.Text
                rsNew!DescrizioneArticoloInLinguaCliente = Me.txtDescrizioneArticoloInLinguaCliente.Text
                rsNew!DescrizioneCalibroInLinguaCliente = Me.txtCalibroInLingua.Text
                rsNew!DescrizioneCategoriaInLinguaCliente = Me.txtCategoriaInLingua.Text
                rsNew!LinguaCliente = Me.cboLinguaCliente.Text
                rsNew!CodiceGSI = Me.txtCodiceGSICliente.Text
                rsNew!NotaRigaOrdRaggr = Me.txtRaggrOrd.Text
                
                
                
                'DATI AZIENDA
                rsNew!AZIENDA_DENOMINAZIONE = AZIENDA_DENOMINAZIONE
                rsNew!AZIENDA_INDIRIZZO = AZIENDA_INDIRIZZO
                rsNew!AZIENDA_COMUNE = AZIENDA_COMUNE
                rsNew!AZIENDA_PROVINCIA = AZIENDA_PROVINCIA
                rsNew!AZIENDA_NAZIONE = AZIENDA_NAZIONE
                rsNew!AZIENDA_CAP = AZIENDA_CAP
                rsNew!AZIENDA_REGIONE = AZIENDA_REGIONE
                rsNew!AZIENDA_TELEFONO = AZIENDA_TELEFONO
                rsNew!Azienda_PartitaIva = AZIENDA_PARTITA_IVA
                rsNew!AZIENDA_FAX = AZIENDA_FAX
                rsNew!AZIENDA_EMAIL = AZIENDA_EMAIL
                rsNew!AZIENDA_INDIRIZZOWEB = AZIENDA_INDIRIZZOWEB
                
                'DATI FILIALE
                rsNew!FILIALE_DENOMINAZIONE = FILIALE_DENOMINAZIONE
                rsNew!FILIALE_INDIRIZZO = FILIALE_INDIRIZZO
                rsNew!FILIALE_COMUNE = FILIALE_COMUNE
                rsNew!FILIALE_REGIONE = FILIALE_REGIONE
                rsNew!FILIALE_PROVINCIA = FILIALE_PROVINCIA
                rsNew!FILIALE_NAZIONE = FILIALE_PROVINCIA
                rsNew!FILIALE_CAP = FILIALE_CAP
                
                'DATI SOCIO
                rsNew!SOCIO_INDIRIZZO = SOCIO_INDIRIZZO
                rsNew!SOCIO_COMUNE = SOCIO_COMUNE
                rsNew!SOCIO_CAP = SOCIO_CAP
                rsNew!SOCIO_NAZIONE = SOCIO_NAZIONE
                rsNew!SOCIO_REGIONE = SOCIO_REGIONE
                rsNew!SOCIO_PROVINCIA = SOCIO_PROVINCIA
                rsNew!SOCIO_TELEFONO = SOCIO_TELEFONO
                rsNew!SOCIO_FAX = SOCIO_FAX
                rsNew!SOCIO_EMAIL = SOCIO_EMAIL
                rsNew!SOCIO_INDIRIZZOWEB = SOCIO_INDIRIZZOWEB
                rsNew!Socio_PartitaIva = SOCIO_PARTITA_IVA
                
                'CERTIFIZIONE AZIENDA
                rsNew!CodiceCertificazioneAzienda = CODICE_CERTIFICAZIONE_AZIENDA
                rsNew!DescrizioneCertificazioneAzienda = DESCRIZIONE_CERTIFICAZIONE_AZIENDA
                rsNew!ProtocolloCertificazioneAzienda = PROTOCOLLO_CERTIFICAZIONE_AZIENDA
                rsNew!EnteCertificatoreAzienda = ENTE_CERTIFICAZIONE_AZIENDA
                
                'CERTIFIZIONE FAMIGLIA PRODOTTO DELL'ARTICOLO LAVORATO
                rsNew!CodiceCertificazioneFamLav = CODICE_CERTIFICAZIONE_FAM_LAV
                rsNew!DescrizioneCertificazioneFamLav = DESCRIZIONE_CERTIFICAZIONE_FAM_LAV
                rsNew!ProtocolloCertificazioneFamLav = PROTOCOLLO_CERTIFICAZIONE_FAM_LAV
                rsNew!EnteCertificatoreFamLav = ENTE_CERTIFICAZIONE_FAM_LAV
                
                'CERTIFIZIONE FAMIGLIA PRODOTTO DELL'ARTICOLO CONFERITO
                rsNew!CodiceCertificazioneFamConf = CODICE_CERTIFICAZIONE_FAM_CONF
                rsNew!DescrizioneCertificazioneFamConf = DESCRIZIONE_CERTIFICAZIONE_FAM_CONF
                rsNew!ProtocolloCertificazioneFamConf = PROTOCOLLO_CERTIFICAZIONE_FAM_CONF
                rsNew!EnteCertificatoreFamConf = ENTE_CERTIFICAZIONE_FAM_CONF
                
                'DATI DESTINAZIONE MERCE
                rsNew!Cliente_DestinazioneOrdine = DESTINAZIONE_MERCE
                rsNew!Cliente_DestinazioneIndirizzo = DESTINAZIONE_INDIRIZZO
                rsNew!Cliente_DestinazioneComune = DESTINAZIONE_COMUNE
                rsNew!Cliente_DestinazioneProvincia = DESTINAZIONE_PROVINCIA
                rsNew!Cliente_DestinazioneCap = DESTINAZIONE_CAP
                rsNew!Cliente_DestinazioneNazione = DESTINAZIONE_NAZIONE
                rsNew!Cliente_DestinazioneTelefono = DESTINAZIONE_TELEFONO
                rsNew!Cliente_DestinazioneFax = DESTINAZIONE_FAX
                
                'DATI VETTORE
                rsNew!Vettore_Ordine = VETTORE
                rsNew!VETTORE_INDIRIZZO = VETTORE_INDIRIZZO
                rsNew!VETTORE_COMUNE = VETTORE_COMUNE
                rsNew!VETTORE_PROVINCIA = VETTORE_PROVINCIA
                rsNew!VETTORE_CAP = VETTORE_CAP
                rsNew!VETTORE_NAZIONE = VETTORE_NAZIONE
                rsNew!VETTORE_TELEFONO = VETTORE_TELEFONO
                rsNew!VETTORE_FAX = VETTORE_FAX
                rsNew!Vettore_PartitaIva = VETTORE_PARTITA_IVA
                rsNew!Vettore_NumeroAlbo = VETTORE_NUMERO_ALBO
                ''PASSAPORTO
                rsNew!RV_PO01_NumeroPassaportoRighe = Me.txtNumeroProtocollo.Value
                rsNew!RV_PO01_IDSezionaleRighe = Link_Sezionale_Dettagliato
                
                'ORDINE CLIENTE
                rsNew!Ordine_TipoOrdine = ORDINE_TIPO_ORDINE
                rsNew!Ordine_TargaAutomezzo = ORDINE_TARGA_AUTOMEZZO
                rsNew!Ordine_IstruzioneMittente = ORDINE_ISTRUZIONI_MITT
                rsNew!Ordine_AnnotazioniFatturazione = ORDINE_NOTE_FATT
                rsNew!Ordine_AnnotazioneCorpoEvasione = ORDINE_NOTE_CORPO
                rsNew!Ordine_AnnotazioniInterne = ORDINE_NOTE_INTERNE

                
                'IMBALLO SECONDARIO
                rsNew!DescrizioneImballoInLinguaCliente = Me.txtDescrizioneImballoInLinguaCliente.Text
                If Trim(DESCR_IMB_LINGUA_PRED) <> "" Then
                    rsNew!DescrizioneImballoInLinguaPredefinita = DESCR_IMB_LINGUA_PRED
                Else
                     rsNew!DescrizioneImballoInLinguaPredefinita = Me.txtImballo.Text
                End If
                
                'IMBALLO PRIMARIO
                rsNew!IDImballoPrimario = Me.CDImballoPrimario.KeyFieldID
                rsNew!CodiceImballoPrimario = Me.CDImballoPrimario.Code
                rsNew!ImballoPrimario = Me.CDImballoPrimario.Description
                rsNew!NumeroConfezioni = Me.txtNumeroConfImballo.Value
                rsNew!TaraUnitariaConfezione = Me.txtTaraConfImballo.Value
                
                rsNew!DescrizioneImballoPrimInLinguaCliente = DESCR_IMB_PRIM_LINGUA_CLIENTE
                If Trim(DESCR_IMB_PRIM_LINGUA_PRED) <> "" Then
                    rsNew!DescrizioneImballoPrimInLinguaPred = DESCR_IMB_PRIM_LINGUA_PRED
                Else
                     rsNew!DescrizioneImballoPrimInLinguaPred = Me.CDImballoPrimario.Description
                End If
                
                rsNew!CodiceABarreImballoPrimCliente = COD_A_BARRE_IMB_PRIM_CLI
                rsNew!DescrizioneCodiceABarreImballoPrimCliente = DESCR_A_BARRE_IMB_PRIM_CLI
                
                rsNew!CodiceABarreImballoPrimPred = COD_A_BARRE_IMB_PRIM_PRED
                rsNew!DescrizioneCodiceABarreImballoPrimPred = DESCR_A_BARRE_IMB_PRIM_PRED
                
                GET_LOTTI_IMBALLO_PER_ETICHETTA rsNew
                
            rsNew.Update
            
            If IDConfigurazioneEtichetta > 0 Then
                GET_VALORE_CODICE_EAN_128 IDConfigurazioneEtichetta, rsNew
            End If
            DoEvents
            Screen.MousePointer = 0
            
            Cn.CommitTrans
            
            rsNew.Close
            Set rsNew = Nothing

Exit Sub
ERR_CmdStampaEtichette_Click:
    MsgBox Err.Description, vbCritical, "cmdStampaEtichette_Click"
    Screen.MousePointer = 0
    Cn.RollbackTrans
End Sub
Private Sub GET_VALORE_CODICE_EAN_128(IDConfigurazioneEtichetta As Long, rsNew As ADODB.Recordset)
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim rsEti As ADODB.Recordset
Dim rsTesta As ADODB.Recordset
Dim STRINGA_CODICE_EAN_128 As String
Dim DESCRIZIONE_STRINGA_CODICE_EAN_128 As String
Dim DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB As String
Dim STRINGA_CODICE_INDENTIFICATORE As String
Dim StringaDiConnessione As String
Dim cnEti As ADODB.Connection
Dim NUMERO_CON_DECIMALI As String

If Right(Trim(MenuOptions.ConnectionString), 1) = ";" Then
    StringaDiConnessione = MenuOptions.ConnectionString
Else
    StringaDiConnessione = MenuOptions.ConnectionString & ";"
End If

StringaDiConnessione = StringaDiConnessione & "User Id=" & TheApp.User & ";Password=" & TheApp.Password
Set cnEti = New ADODB.Connection
cnEti.ConnectionString = StringaDiConnessione
cnEti.Open


If Not ((rsNew.EOF) And (rsNew.BOF)) Then
    rsNew.Filter = "IDUtente=" & TheApp.IDUser
        If Not ((rsNew.EOF) And (rsNew.BOF)) Then
    
        rsNew.MoveFirst
        
        While Not rsNew.EOF
            sSQL = "SELECT * FROM RV_POConfigurazioneEtichettaRighe "
            sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichetta=" & IDConfigurazioneEtichetta
            sSQL = sSQL & " AND IDRV_POTipoElementoEtichetta=8"
            
            Set rsEti = New ADODB.Recordset
            
            rsEti.Open sSQL, cnEti
            
            
            While Not rsEti.EOF
                sSQL = "SELECT RV_POCostruzioneCodiceEAN128Righe.IDRV_POIdentificatoreEAN128, RV_POCostruzioneCodiceEAN128Righe.CodiceIdentificatoreEAN128, "
                sSQL = sSQL & "RV_POCostruzioneCodiceEAN128Righe.PosizioneIdentificatore, RV_POIdentificatoreEAN128.Lunghezza, RV_POIdentificatoreEAN128.Fisso, "
                sSQL = sSQL & "RV_POIdentificatoreEAN128.CalcolaCheck , RV_POIdentificatoreEAN128.Alfanumerico, RV_POCostruzioneCodiceEAN128Righe.IDRV_POCostruzioneCodiceEAN128, "
                sSQL = sSQL & "RV_POCostruzioneCodiceEAN128Righe.NumeroDecimali, RV_POIdentificatoreEAN128.CampoConDecimali "
                sSQL = sSQL & "FROM RV_POCostruzioneCodiceEAN128Righe LEFT OUTER JOIN "
                sSQL = sSQL & "RV_POIdentificatoreEAN128 ON "
                sSQL = sSQL & "RV_POCostruzioneCodiceEAN128Righe.IDRV_POIdentificatoreEAN128 = RV_POIdentificatoreEAN128.IDRV_POIdentificatoreEAN128 "
                sSQL = sSQL & "WHERE (IDRV_POCostruzioneCodiceEAN128 = " & fnNotNullN(rsEti!Elemento_Campo) & ") "
                sSQL = sSQL & "GROUP BY RV_POCostruzioneCodiceEAN128Righe.IDRV_POIdentificatoreEAN128, RV_POCostruzioneCodiceEAN128Righe.CodiceIdentificatoreEAN128, "
                sSQL = sSQL & "RV_POCostruzioneCodiceEAN128Righe.PosizioneIdentificatore, RV_POIdentificatoreEAN128.Lunghezza, RV_POIdentificatoreEAN128.Fisso, "
                sSQL = sSQL & "RV_POIdentificatoreEAN128.CalcolaCheck , RV_POIdentificatoreEAN128.Alfanumerico, RV_POCostruzioneCodiceEAN128Righe.IDRV_POCostruzioneCodiceEAN128, RV_POCostruzioneCodiceEAN128Righe.NumeroDecimali, "
                sSQL = sSQL & "RV_POIdentificatoreEAN128.CampoConDecimali "
                sSQL = sSQL & "ORDER BY PosizioneIdentificatore "
                
                Set rsTesta = New ADODB.Recordset ' Cn.OpenResultset(sSQL)
                
                rsTesta.Open sSQL, cnEti
                
                STRINGA_CODICE_EAN_128 = ""
                DESCRIZIONE_STRINGA_CODICE_EAN_128 = ""
                DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB = ""
                
                While Not rsTesta.EOF
                    STRINGA_CODICE_INDENTIFICATORE = ""
                    
                    sSQL = "SELECT * FROM RV_POCostruzioneCodiceEAN128Righe "
                    sSQL = sSQL & "WHERE IDRV_POCostruzioneCodiceEAN128=" & fnNotNullN(rsTesta!IDRV_POCostruzioneCodiceEAN128)
                    sSQL = sSQL & " AND IDRV_POIdentificatoreEAN128=" & fnNotNullN(rsTesta!IDRV_POIdentificatoreEAN128)
                    sSQL = sSQL & " ORDER BY Posizione "
                    
                    Set rs = New ADODB.Recordset
                    rs.Open sSQL, cnEti
                    
                    While Not rs.EOF
                        If Len(fnNotNull(rs!NomeCampoEtichetta)) > 0 Then
                            If rsEti!IDRV_POConfigurazioneEtichettaSezione = 0 Then
                                Select Case rsNew.Fields(fnNotNull(rs!NomeCampoEtichetta)).Type
                                            
                                    Case adDate, adDBDate, adDBTime, adDBTimeStamp
                                        STRINGA_CODICE_INDENTIFICATORE = STRINGA_CODICE_INDENTIFICATORE & GET_VALORE_TIPO_DATA_ETICHETTA(fnNotNullN(rs!IDRV_POTipocampoDataEtichetta), rsNew.Fields(fnNotNull(rs!NomeCampoEtichetta)).Value)
                                    Case Else
                                        'If (fnNotNullN(rsTesta!IDRV_POIdentificatoreEAN128) = 11) Or (fnNotNullN(rsTesta!IDRV_POIdentificatoreEAN128) = 12) Then
                                        If (fnNotNullN(rsTesta!CampoConDecimali) = 1) Then
                                            NUMERO_CON_DECIMALI = Replace((FormatNumber(fnNotNullN(rsNew.Fields(fnNotNull(rs!NomeCampoEtichetta)).Value), fnNotNullN(rs!NumeroDecimali))), ",", "")
                                            NUMERO_CON_DECIMALI = GET_STRINGA_FORMATTATA(NUMERO_CON_DECIMALI, 0, fnNotNullN(rsTesta!Lunghezza))
                                            
                                            STRINGA_CODICE_INDENTIFICATORE = STRINGA_CODICE_INDENTIFICATORE & NUMERO_CON_DECIMALI
                                            
                                        Else
                                            STRINGA_CODICE_INDENTIFICATORE = STRINGA_CODICE_INDENTIFICATORE & rsNew.Fields(fnNotNull(rs!NomeCampoEtichetta)).Value
                                        End If
                                End Select
                            Else
                                STRINGA_CODICE_INDENTIFICATORE = STRINGA_CODICE_INDENTIFICATORE & GET_VALORE_PER_SEZIONE(rsNew, rsEti, fnNotNull(rs!NomeCampoEtichetta), rsNew.Fields(fnNotNull(rs!NomeCampoEtichetta)).Type, fnNotNullN(rs!IDRV_POTipocampoDataEtichetta))
                                'If (fnNotNullN(rsTesta!IDRV_POIdentificatoreEAN128) = 11) Or (fnNotNullN(rsTesta!IDRV_POIdentificatoreEAN128) = 12) Then
                                If (fnNotNullN(rsTesta!CampoConDecimali) = 1) Then
                                    NUMERO_CON_DECIMALI = Replace((FormatNumber(STRINGA_CODICE_INDENTIFICATORE, fnNotNullN(rs!NumeroDecimali))), ",", "")
                                    NUMERO_CON_DECIMALI = GET_STRINGA_FORMATTATA(NUMERO_CON_DECIMALI, 0, fnNotNullN(rsTesta!Lunghezza))
                                    
                
                                    STRINGA_CODICE_INDENTIFICATORE = NUMERO_CON_DECIMALI
                                    
                                Else
                                    STRINGA_CODICE_INDENTIFICATORE = STRINGA_CODICE_INDENTIFICATORE
                                End If
                                
                            End If
                        End If
                        If Len(fnNotNull(rs!Valore)) > 0 Then
                            STRINGA_CODICE_INDENTIFICATORE = STRINGA_CODICE_INDENTIFICATORE & fnNotNull(rs!Valore)
                        End If
                    rs.MoveNext
                    Wend
                    
                    rs.Close
                    Set rs = Nothing
                                    
                    If fnNotNullN(rsTesta!Fisso) = 1 Then
                        If Len(STRINGA_CODICE_INDENTIFICATORE) < fnNotNullN(rsTesta!Lunghezza) Then
                            Select Case fnNotNullN(rsTesta!Alfanumerico)
                                Case 0
                                    
                                Case 1
                                
                                Case 2
                                        
                            End Select
                        End If
                        If Len(STRINGA_CODICE_INDENTIFICATORE) > fnNotNullN(rsTesta!Lunghezza) Then
                            STRINGA_CODICE_INDENTIFICATORE = Mid(STRINGA_CODICE_INDENTIFICATORE, 1, fnNotNullN(rsTesta!Lunghezza))
                        End If
                    Else
                        If Len(STRINGA_CODICE_INDENTIFICATORE) < fnNotNullN(rsTesta!Lunghezza) Then
                            STRINGA_CODICE_INDENTIFICATORE = STRINGA_CODICE_INDENTIFICATORE & "Ê"
                            'STRINGA_CODICE_INDENTIFICATORE = STRINGA_CODICE_INDENTIFICATORE & "~202"
                        End If
                    End If
                    
                    If fnNotNullN(rsTesta!CalcolaCheck) = 1 Then
                        STRINGA_CODICE_INDENTIFICATORE = AddChecksum(STRINGA_CODICE_INDENTIFICATORE)
                    End If
                    
                    'If (fnNotNullN(rsTesta!IDRV_POIdentificatoreEAN128) = 11) Or (fnNotNullN(rsTesta!IDRV_POIdentificatoreEAN128) = 12) Then
                    If (fnNotNullN(rsTesta!CampoConDecimali) = 1) Then
                        DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB = DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB & "(" & fnNotNull(rsTesta!CodiceIdentificatoreEAN128) & fnNotNullN(rsTesta!NumeroDecimali) & ")" & STRINGA_CODICE_INDENTIFICATORE
                        STRINGA_CODICE_INDENTIFICATORE = fnNotNull(rsTesta!CodiceIdentificatoreEAN128) & fnNotNullN(rsTesta!NumeroDecimali) & STRINGA_CODICE_INDENTIFICATORE
                        
                        DESCRIZIONE_STRINGA_CODICE_EAN_128 = DESCRIZIONE_STRINGA_CODICE_EAN_128 & STRINGA_CODICE_INDENTIFICATORE
                    
                    Else
                        DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB = DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB & "(" & fnNotNull(rsTesta!CodiceIdentificatoreEAN128) & ")" & STRINGA_CODICE_INDENTIFICATORE
                        STRINGA_CODICE_INDENTIFICATORE = fnNotNull(rsTesta!CodiceIdentificatoreEAN128) & STRINGA_CODICE_INDENTIFICATORE
                        
                        DESCRIZIONE_STRINGA_CODICE_EAN_128 = DESCRIZIONE_STRINGA_CODICE_EAN_128 & STRINGA_CODICE_INDENTIFICATORE
                    End If
                    'DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB = DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB & "(" & fnNotNull(rsTesta!CodiceIdentificatoreEAN128) & ")" & STRINGA_CODICE_INDENTIFICATORE
                rsTesta.MoveNext
                Wend
                
                rsTesta.Close
                Set rsTesta = Nothing
                    
                rsNew(fnNotNull(rsEti!Elemento_Testo)).Value = CodeRefresh(DESCRIZIONE_STRINGA_CODICE_EAN_128)
                Select Case fnNotNull(rsEti!Elemento_Testo)
                    
                    Case "Codifica_EAN128_1"
                        rsNew!Descrizione_EAN128_1 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_1 = Replace(rsNew!Descrizione_EAN128_1, "(", "~202")
                        rsNew!Codifica_EAN128_1 = Replace(rsNew!Codifica_EAN128_1, ")", "")
                    Case "Codifica_EAN128_2"
                        rsNew!Descrizione_EAN128_2 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_2 = Replace(rsNew!Descrizione_EAN128_2, "(", "~202")
                        rsNew!Codifica_EAN128_2 = Replace(rsNew!Codifica_EAN128_2, ")", "")
                    Case "Codifica_EAN128_3"
                        rsNew!Descrizione_EAN128_3 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_3 = Replace(rsNew!Descrizione_EAN128_3, "(", "~202")
                        rsNew!Codifica_EAN128_3 = Replace(rsNew!Codifica_EAN128_3, ")", "")
                    Case "Codifica_EAN128_4"
                        rsNew!Descrizione_EAN128_4 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_4 = Replace(rsNew!Descrizione_EAN128_4, "(", "~202")
                        rsNew!Codifica_EAN128_4 = Replace(rsNew!Codifica_EAN128_4, ")", "")
                    Case "Codifica_EAN128_5"
                        rsNew!Descrizione_EAN128_5 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_5 = Replace(rsNew!Descrizione_EAN128_5, "(", "~202")
                        rsNew!Codifica_EAN128_5 = Replace(rsNew!Codifica_EAN128_5, ")", "")
                    
                    Case "Codifica_EAN128_6"
                        rsNew!Descrizione_EAN128_6 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_6 = Replace(rsNew!Descrizione_EAN128_6, "(", "~202")
                        rsNew!Codifica_EAN128_6 = Replace(rsNew!Codifica_EAN128_6, ")", "")
                    
                    Case "Codifica_EAN128_7"
                        rsNew!Descrizione_EAN128_7 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_7 = Replace(rsNew!Descrizione_EAN128_7, "(", "~202")
                        rsNew!Codifica_EAN128_7 = Replace(rsNew!Codifica_EAN128_7, ")", "")
                    
                    Case "Codifica_EAN128_8"
                        rsNew!Descrizione_EAN128_8 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_8 = Replace(rsNew!Descrizione_EAN128_8, "(", "~202")
                        rsNew!Codifica_EAN128_8 = Replace(rsNew!Codifica_EAN128_8, ")", "")
                    
                    Case "Codifica_EAN128_9"
                        rsNew!Descrizione_EAN128_9 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_9 = Replace(rsNew!Descrizione_EAN128_9, "(", "~202")
                        rsNew!Codifica_EAN128_9 = Replace(rsNew!Codifica_EAN128_9, ")", "")
                    
                    Case "Codifica_EAN128_10"
                        rsNew!Descrizione_EAN128_10 = Replace(DESCRIZIONE_STRINGA_CODICE_EAN_128_PER_DB, "Ê", "")
                        rsNew!Codifica_EAN128_10 = Replace(rsNew!Descrizione_EAN128_10, "(", "~202")
                        rsNew!Codifica_EAN128_10 = Replace(rsNew!Codifica_EAN128_10, ")", "")
                    
                End Select
                    
            rsEti.MoveNext
            Wend
            
            rsEti.Close
            Set rsEti = Nothing
        rsNew.Update
        rsNew.MoveNext
        Wend
    End If
End If

cnEti.Close
Set cnEti = Nothing
End Sub
Public Function GET_STRINGA_FORMATTATA(Stringa As String, Tipo As Long, Lunghezza As Long) As String
Dim I As Long
Dim Rimanenza As String
Dim Stringa_Anno As String

Rimanenza = ""
For I = Len(Stringa) To Lunghezza - 1
    Select Case Tipo
        Case 0
            Rimanenza = Rimanenza & "0"
        Case 1
            Rimanenza = Rimanenza & " "
    End Select
Next

If Tipo = 2 Then

End If
GET_STRINGA_FORMATTATA = Rimanenza & Stringa

End Function
Public Function CodeRefresh(StringaEAN128) As String
  'Construction du code barre / Build the barcode
  Dim I%, dummy$
    dummy$ = "Ê"
    dummy$ = dummy$ & StringaEAN128
    If Right$(dummy$, 1) = "Ê" Then dummy$ = Left$(dummy$, Len(dummy$) - 1)
    dummy$ = ean128$(dummy$)
    
    
    CodeRefresh = dummy$
             
  
End Function

Public Function ean128$(chaine$)
  'Cette fonction est régie par la Licence Générale Publique Amoindrie GNU (GNU LGPL)
  'This function is governed by the GNU Lesser General Public License (GNU LGPL)
  'V 1.0.0
  'Paramètres : une chaine
  'Parameters : a string
  'Retour : * une chaine qui, affichée avec la police CODE128.TTF, donne le code barre
  '         * une chaine vide si paramètre fourni incorrect
  'Return : * a string which give the bar code when it is dispayed with CODE128.TTF font
  '         * an empty string if the supplied parameter is no good
  Dim I%, checksum&, mini%, dummy%, tableB As Boolean
  ean128$ = ""
  If Len(chaine$) > 0 Then
  'Vérifier si caractères valides
  'Check for valid characters
    For I% = 1 To Len(chaine$)
      Select Case Asc(Mid$(chaine$, I%, 1))
      Case 32 To 126, 198, 202
      Case Else
        I% = 0
        Exit For
      End Select
    Next
    'Calculer la chaine de code en optimisant l'usage des tables B et C
    'Calculation of the code string with optimized use of tables B and C
    ean128$ = ""
    tableB = True
    If I% > 0 Then
      I% = 1 'i% devient l'index sur la chaine / i% become the string index
      Do While I% <= Len(chaine$)
        If tableB Then
          'Voir si intéressant de passer en table C / See if interesting to switch to table C
          'Oui pour 4 chiffres au début ou à la fin, sinon pour 6 chiffres / yes for 4 digits at start or end, else if 6 digits
          mini% = IIf(I% = 1 Or I% + 3 = Len(chaine$), 4, 6)
          GoSub TestNumOrFnc1
          If mini% < 0 Then 'Choix table C / Choice of table C
            If I% = 1 Then 'Débuter sur table C / Starting with table C
              ean128$ = Chr$(205)
            Else 'Commuter sur table C / Switch to table C
              ean128$ = ean128$ & Chr$(199)
            End If
            tableB = False
          Else
            If I% = 1 Then ean128$ = Chr$(204) 'Débuter sur table B / Starting with table B
          End If
        End If
        If Not tableB Then
          'On est sur la table C, essayer de traiter 2 chiffres ou Ê/ We are on table C, try to process 2 digits or Ê
          If Asc(Mid$(chaine$, I%, 2)) = 202 Then
            'On traite le Fnc1 (Ê) / We process the Fnc1 (Ê)
            ean128$ = ean128$ & Mid$(chaine$, I%, 1)
            I% = I% + 1
          Else
            mini% = 2
            GoSub TestNum
            If mini% < 0 Then 'OK pour 2 chiffres, les traiter / OK for 2 digits, process it
              dummy% = Val(Mid$(chaine$, I%, 2))
              dummy% = IIf(dummy% < 95, dummy% + 32, dummy% + 100)
              ean128$ = ean128$ & Chr$(dummy%)
              I% = I% + 2
            Else 'On n'a pas 2 chiffres, repasser en table B / We haven't 2 digits, switch to table B
              ean128$ = ean128$ & Chr$(200)
              tableB = True
            End If
          End If
        End If
        If tableB Then
          'Traiter 1 caractère en table B / Process 1 digit with table B
          ean128$ = ean128$ & Mid$(chaine$, I%, 1)
          I% = I% + 1
        End If
      Loop
      'Calcul de la clé de contrôle / Calculation of the checksum
      For I% = 1 To Len(ean128$)
        dummy% = Asc(Mid$(ean128$, I%, 1))
        dummy% = IIf(dummy% < 127, dummy% - 32, dummy% - 100)
        If I% = 1 Then checksum& = dummy%
        checksum& = (checksum& + (I% - 1) * dummy%) Mod 103
      Next
      'Calcul du code ASCII de la clé / Calculation of the checksum ASCII code
      checksum& = IIf(checksum& < 95, checksum& + 32, checksum& + 100)
      'Ajout de la clé et du STOP / Add the checksum and the STOP
      ean128$ = ean128$ & Chr$(checksum&) & Chr$(206)
    End If
  End If
  Exit Function
TestNum:
  'si les mini% caractères à partir de i% sont numériques, alors mini%=0
  'if the mini% characters from i% are numeric, then mini%=0
  mini% = mini% - 1
  If I% + mini% <= Len(chaine$) Then
    Do While mini% >= 0
      If Asc(Mid$(chaine$, I% + mini%, 1)) < 48 Or Asc(Mid$(chaine$, I% + mini%, 1)) > 57 Then Exit Do
      mini% = mini% - 1
    Loop
  End If
Return
TestNumOrFnc1:
  'si les mini% caractères à partir de i% sont numériques ou  FNC1, alors mini%=0
  'if the mini% characters from i% are numeric or Fnc1, then mini%=0
  mini% = mini% - 1
  If I% + mini% <= Len(chaine$) Then
    Do While mini% >= 0
      If (Asc(Mid$(chaine$, I% + mini%, 1)) < 48 Or Asc(Mid$(chaine$, I% + mini%, 1)) > 57) And Asc(Mid$(chaine$, I% + mini%, 1)) <> 202 Then Exit Do
      mini% = mini% - 1
    Loop
  End If
Return
End Function
Private Function AddChecksum(StringaCodiceIdentificatore As String) As String
  'Calcul et ajout de la clé de contrôle EAN
  'Compute and add EAN checksum
  Dim checksum&, I%
  For I% = Len(StringaCodiceIdentificatore) To 1 Step -2
    checksum& = checksum& + Val(Mid$(StringaCodiceIdentificatore, I%, 1))
  Next
  checksum& = checksum& * 3
  For I% = Len(StringaCodiceIdentificatore) - 1 To 1 Step -2
    checksum& = checksum& + Val(Mid$(StringaCodiceIdentificatore, I%, 1))
  Next
  AddChecksum = StringaCodiceIdentificatore & (10 - checksum& Mod 10) Mod 10
End Function

Private Sub StampaNew(NomeStampanteReport As String, NomeReport As String, NumeroCopie As Long, X As Double, Y As Double, Orientamento As Long)
Dim NomeStampantePredefinita As String
Dim appw As New CRAXDRT.Application
Dim rpt As New CRAXDRT.Report
Dim NumeroEtichette As Long
Dim StringaDiConnessione As String
Dim REGISTRY_KEY As String
Dim Stampante As String
Dim Pr As Printer
If Right(Trim(MenuOptions.ConnectionString), 1) = ";" Then
    StringaDiConnessione = MenuOptions.ConnectionString
Else
    StringaDiConnessione = MenuOptions.ConnectionString & ";"
End If

StringaDiConnessione = StringaDiConnessione & "User Id=" & TheApp.User & ";Password=" & TheApp.Password & ";Persist Security Info=true"


    NomeStampantePredefinita = Printer.DeviceName

    Stampante = NomeStampanteReport
    
    If Stampante <> NomeStampantePredefinita Then
        For Each Pr In Printers
            If Pr.DeviceName = Stampante Then
                If WinNTSetDefaultPrinter(Pr.DeviceName) = True Then
                    Exit For
                Else
                    MsgBox "Problemi con la stampante " & NomeStampanteReport
                    Exit Sub
                End If
            End If
        Next
    End If
    
    appw.LogOnServerEx "pdsoledb.dll", "", , , , , StringaDiConnessione
    
    Set rpt = appw.OpenReport(MenuOptions.ReportsPath & "\" & NomeReport)
    
    If Orientamento = 1 Then
        rpt.SetUserPaperSize Y * 100, X * 100
    Else
        rpt.SetUserPaperSize X * 100, Y * 100
    End If
    rpt.PaperOrientation = Orientamento
    rpt.VerifyOnEveryPrint = True
   
    rpt.TopMargin = 0
    rpt.LeftMargin = 0
    rpt.BottomMargin = 0
    rpt.RightMargin = 0
    
    rpt.RecordSelectionFormula = "{RV_POTMPStampaEtichetteRighe.IDUtente} =" & TheApp.IDUser
    
    If IsNumeric(NumeroCopie) Then
        NumeroEtichette = NumeroCopie
    Else
        NumeroEtichette = 1
    End If
    
    rpt.PrintOut False, NumeroEtichette
    
    If Stampante <> NomeStampantePredefinita Then
        WinNTSetDefaultPrinter NomeStampantePredefinita
    End If
    
    StampaEtichettaPDF rpt
    
Exit Sub
ERR_CmdStampaEtichette_Click:
MsgBox Err.Description, vbCritical, "Errore nella stampa delle etichette"
If Stampante <> NomeStampantePredefinita Then
    WinNTSetDefaultPrinter NomeStampantePredefinita
End If
End Sub

Private Sub SCRIVI_ETICHETTE_PEDANA_NEW(IDCodicePedana As String, PedanaAzienda As Boolean, IDConfigurazioneEtichetta As Long)
On Error GoTo ERR_CREA_PEDANA_PER_STAMPA
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim rsNew As ADODB.Recordset
Dim cmdPedana As ADODB.Command
Dim Prm1 As ADODB.Parameter
Dim Prm2 As ADODB.Parameter
Dim Prm3 As ADODB.Parameter
Dim OLD_Cursor As Long

'ELIMINAZIONE DATI TABELLA ETICHETTA PER UTENTE'''''''''''''''
sSQL = "DELETE FROM RV_POTMPStampaEtichetteRighe "
sSQL = sSQL & "WHERE IDUtente=" & TheApp.IDUser
Cn.Execute sSQL
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Set rs = New ADODB.Recordset
Set rsNew = New ADODB.Recordset

OLD_Cursor = Cn.CursorLocation
Cn.CursorLocation = adUseClient

sSQL = "SELECT * FROM RV_POIEStampaEtichette "  '
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDFiliale=" & TheApp.IDFirm
If PedanaAzienda = True Then
    sSQL = sSQL & " AND IDRV_POPedana=" & IDCodicePedana
Else
    sSQL = sSQL & " AND NumeroPedanaCliente=" & IDCodicePedana
End If
rs.Open sSQL, Cn.InternalConnection

sSQL = "SELECT * FROM RV_POTMPStampaEtichetteRighe "
sSQL = sSQL & "WHERE IDUtente=" & TheApp.IDUser
rsNew.Open sSQL, Cn.InternalConnection, adOpenDynamic, adLockPessimistic

Screen.MousePointer = 11

If rs.EOF = False Then
    DoEvents
    Cn.BeginTrans
    While Not rs.EOF
        rsNew.AddNew
            'CAMPI OBBLIGATORI
            rsNew!IDUtente = TheApp.IDUser
            rsNew!IDAzienda = TheApp.IDFirm
            rsNew!IDFiliale = TheApp.Branch
            rsNew!IDRV_POAssegnazioneMerce = fnNotNullN(rs!IDRV_POAssegnazioneMerce)
            rsNew!IDRV_POPedana = fnNotNullN(rs!IDRV_POPedana)
            rsNew!CodicePedana = fnNotNull(rs!CodicePedana)

            'CAMPI LAVORAZIONE
            rsNew!IDArticolo = fnNotNullN(rs!IDArticolo)
            rsNew!CodiceArticolo = fnNotNull(rs!CodiceArticolo)
            rsNew!Articolo = fnNotNull(rs!Articolo)
            rsNew!IDArticoloImballo = fnNotNullN(rs!IDImballoVendita)
            rsNew!CodiceImballo = fnNotNull(rs!CodiceImballoVendita)
            rsNew!Imballo = fnNotNull(rs!ImballoVendita)
            rsNew!Colli = fnNotNullN(rs!Colli)
            rsNew!PesoLordo = fnNotNullN(rs!PesoLordo)
            rsNew!Tara = fnNotNullN(rs!Tara)
            rsNew!PesoNetto = fnNotNullN(rs!PesoNetto)
            rsNew!Pezzi = fnNotNullN(rs!Pezzi)
            rsNew!Qta_UM = fnNotNullN(rs!Qta_UM)
            rsNew!CodiceLotto = fnNotNull(rs!CodiceLottoVendita)
            rsNew!IDAnagraficaSocio = fnNotNullN(rs!IDAnagraficaSocio)
            rsNew!AnagraficaSocio = fnNotNull(rs!AnagraficaSocio)
            rsNew!NomeSocio = fnNotNull(rs!NomeSocio)
            rsNew!CodiceSocio = fnNotNull(rs!CodiceSocio)
            rsNew!IDRV_POCalibro = fnNotNullN(rs!IDRV_POCalibro)
            rsNew!Calibro = fnNotNull(rs!Calibro)
            rsNew!IDRV_POTipoCategoria = fnNotNullN(rs!IDRV_POTipoCategoria)
            rsNew!TipoCategoria = fnNotNull(rs!TipoCategoria)
            rsNew!CodiceABarreArticolo = fnNotNull(rs!CodiceABarreArticoloPred)
            rsNew!CodiceABarreImballoAzienda = fnNotNull(rs!CodiceABarreImballoPred)
            rsNew!DescrizioneCodiceABarreArticoloAzienda = fnNotNull(rs!DescrizioneCodiceABarreArticoloPred)
            rsNew!DescrizioneCodiceABarreImballoAzienda = fnNotNull(rs!DescrizioneCodiceABarreImballoPred)
            rsNew!LinguaPredefinita = fnNotNull(rs!LinguaPredefinita)
            rsNew!CodicePostazioneUtente = fnNotNull(rs!CodiceUtente)
            rsNew!DataOrdine = fnNotNull(rs!DataOrdine)
            rsNew!NumeroOrdine = fnNotNullN(rs!NumeroOrdine)
            If Len(fnNotNull(rs!DataOrdinePressoCliente)) > 0 Then
                rsNew!DataOrdinePressoCliente = fnNotNull(rs!DataOrdinePressoCliente)
            End If
            rsNew!NumeroOrdinePressoCliente = fnNotNull(rs!NumeroOrdinePressoCliente)

            If Trim(fnNotNull(rs!DescrizioneArticoloInLinguaPred)) <> "" Then
                rsNew!DescrizioneArticoloInLinguaPredefinita = fnNotNull(rs!DescrizioneArticoloInLinguaPred)
            Else
                rsNew!DescrizioneArticoloInLinguaPredefinita = fnNotNull(rs!Articolo)
            End If
            If Trim(fnNotNull(rs!DescrizioneCalibroInLinguaPred)) <> "" Then
                rsNew!DescrizioneCalibroInLinguaPredefinita = fnNotNull(rs!DescrizioneCalibroInLinguaPred)
            Else
                rsNew!DescrizioneCalibroInLinguaPredefinita = fnNotNull(rs!Calibro)
            End If
            If Trim(fnNotNull(rs!DescrizioneCategoriaInLinguaPred)) <> "" Then
                rsNew!DescrizioneCategoriaInLinguaPredefinita = fnNotNull(rs!DescrizioneCategoriaInLinguaPred)
            Else
                rsNew!DescrizioneCategoriaInLinguaPredefinita = fnNotNull(rs!TipoCategoria)
            End If
            rsNew!Regione = fnNotNull(rs!Regione_Merce)
            rsNew!Nazione = fnNotNull(rs!Nazione_Merce)
            rsNew!Comune = fnNotNull(rs!Comune_Merce)
            rsNew!Provincia = fnNotNull(rs!Provincia_Merce)
            rsNew!UnitaDiMisuraArticoloLavorato = fnNotNull(rs!UnitaDiMisuraArticoloLavorato)
            rsNew!DataConfezionamento = fnNotNull(rs!DataDocumento)
            rsNew!NumeroConferimento = fnNotNullN(m_Document("NumeroDocumento").Value)
            rsNew!NotaRigaOrdRaggr = Me.txtRaggrOrd.Text
            
            'DATI CONFERIMENTO
            rsNew!LottoDiConferimento = Me.txtCodiceLotto_Conf.Text
            rsNew!BNDOO = BNDOO 'Me.txtBNDOO.Text
            rsNew!IDLottoDiCampagna = fnNotNullN(m_Document("IDLottoDiCampagna").Value)
            rsNew!CodiceCertificazioneLotto = CODICE_CERTIFICAZIONE_LOTTO_ETI
            rsNew!DescrizioneCertificazioneLotto = DESCRIZIONE_CERTIFICAZIONE_LOTTO_ETI
            rsNew!ProtocolloCertificazioneLotto = PROTOCOLLO_CERTIFICAZIONE_LOTTO_ETI
            rsNew!EnteCertificatoreLotto = ENTE_CERTIFICAZIONE_LOTTO_ETI
            rsNew!CodiceCertificazioneSocioPred = CODICE_CERTIFICAZIONE_SOCIO_ETI
            rsNew!DescrizioneCertificazioneSocioPred = DESCRIZIONE_CERTIFICAZIONE_SOCIO_ETI
            rsNew!ProtocolloCertificazioneSocioPred = PROTOCOLLO_CERTIFICAZIONE_SOCIO_ETI
            rsNew!EnteCertificatoreSocioPred = ENTE_CERTIFICAZIONE_SOCIO_ETI
            rsNew!IDCategoriaMerceologica = fnNotNullN(m_Document("IDCategoriaMerceologica").Value) 'X
            rsNew!CategoriaMerceologica = fnNotNull(m_Document("CategoriaMerceologica").Value) 'X
            rsNew!IDTipoProdotto = fnNotNullN(m_Document("IDTipoProdotto").Value) 'X
            rsNew!TipoProdotto = fnNotNull(m_Document("TipoProdotto").Value) 'X
            rsNew!CodiceLottoEntrata = Me.txtLottoEntrata.Text
            rsNew!CodiceAssociato = CODICE_ASSOCIATO_PRED 'Me.txtCodiceAssociatoPredefinito.Text
            rsNew!IDVarietaLottoCampagna = LINK_VARIETA_LOTTO_CAMPAGNA
            rsNew!IDFamigliaLottoCampagna = LINK_FAMIGLIA_LOTTO_CAMPAGNA
            rsNew!VarietaLottoCampagna = VARIETA_LOTTO_CAMPAGNA
            rsNew!FamigliaLottoCampagna = FAMIGLIA_LOTTO_CAMPAGNA
            rsNew!IDTipoProduzioneLottoCampagna = LINK_TIPO_PRODUZIONE_LOTTO_CAMPAGNA
            rsNew!TipoProduzioneLottoCampagna = TIPO_PRODUZIONE_LOTTO_CAMPAGNA
            
            'CAMPI CLIENTE
            rsNew!NumeroPedanaCliente = fnNotNullN(rs!NumeroPedanaCliente)
            rsNew!CodicePedanaCliente = fnNotNull(rs!CodicePedanaCliente)
            rsNew!IDAnagraficaCliente = fnNotNullN(rs!IDCliente)
            rsNew!AnagraficaCliente = fnNotNull(rs!Anagrafica_Cliente)
            rsNew!LottoCliente = fnNotNull(rs!LottoCliente)
            rsNew!AltreAnnotazioniCliente = fnNotNull(rs!AltreAnnotazioniPerCliente)
            rsNew!CLIENTE_NOME = CLIENTE_NOME
            rsNew!CLIENTE_INDIRIZZO = fnNotNull(rs!Indirizzo_cliente)
            rsNew!CLIENTE_COMUNE = fnNotNull(rs!Comune_cliente)
            rsNew!CLIENTE_PROVINCIA = fnNotNull(rs!Provincia_Cliente)
            rsNew!CLIENTE_REGIONE = fnNotNull(rs!Regione_Cliente)
            rsNew!CLIENTE_NAZIONE = fnNotNull(rs!Nazione_Cliente)
            rsNew!CLIENTE_PARTITAIVA = fnNotNull(rs!PartitaIva_cliente)
            rsNew!CLIENTE_CAP = fnNotNull(rs!Cap_Cliente)
            rsNew!CLIENTE_TELEFONO = fnNotNull(rs!Telefono_Cliente)
            rsNew!CLIENTE_FAX = fnNotNull(rs!Fax_Cliente)
            rsNew!CLIENTE_EMAIL = fnNotNull(rs!Email_Cliente)
            rsNew!CLIENTE_INDIRIZZOWEB = fnNotNull(rs!IndirizzoWeb_Cliente)
            If Len(fnNotNull(rs!DataPartenzaOrdine)) > 0 Then
                rsNew!DataPartenzaOrdine = fnNotNull(rs!DataPartenzaOrdine)
            End If
            rsNew!CodiceAssociatoPressoCliente = fnNotNull(rs!CodiceAssociatoPressoCliente)
            rsNew!CodiceABarreArticoloCliente = fnNotNull(rs!CodiceABarreArticoloCliente)
            rsNew!DescrizioneCodiceABarreArticoloCliente = fnNotNull(rs!DescrizioneCodiceABarreArticoloCliente)
            rsNew!CodiceABarreImballoCliente = fnNotNull(rs!CodiceABarreImballoCliente)
            rsNew!DescrizioneCodiceABarreImballoCliente = fnNotNull(rs!DescrizioneCodiceABarreImballoCliente)
            rsNew!DescrizioneArticoloInLinguaCliente = fnNotNull(rs!DescrizioneArticoloInLinguaCliente)
            rsNew!DescrizioneCalibroInLinguaCliente = fnNotNull(rs!DescrizioneCalibroInLinguaCliente)
            rsNew!DescrizioneCategoriaInLinguaCliente = fnNotNull(rs!DescrizioneCategoriaInLinguaCliente)
            rsNew!LinguaCliente = fnNotNull(rs!LinguaCliente)
            rsNew!CodiceGSI = fnNotNull(rs!CodiceGSI)
            
            'DATI AZIENDA
            rsNew!AZIENDA_DENOMINAZIONE = AZIENDA_DENOMINAZIONE
            rsNew!AZIENDA_INDIRIZZO = AZIENDA_INDIRIZZO
            rsNew!AZIENDA_COMUNE = AZIENDA_COMUNE
            rsNew!AZIENDA_PROVINCIA = AZIENDA_PROVINCIA
            rsNew!AZIENDA_NAZIONE = AZIENDA_NAZIONE
            rsNew!AZIENDA_CAP = AZIENDA_CAP
            rsNew!AZIENDA_REGIONE = AZIENDA_REGIONE
            rsNew!AZIENDA_TELEFONO = AZIENDA_TELEFONO
            rsNew!Azienda_PartitaIva = AZIENDA_PARTITA_IVA
            rsNew!AZIENDA_FAX = AZIENDA_FAX
            rsNew!AZIENDA_EMAIL = AZIENDA_EMAIL
            rsNew!AZIENDA_INDIRIZZOWEB = AZIENDA_INDIRIZZOWEB
            
            'DATI FILIALE
            rsNew!FILIALE_DENOMINAZIONE = FILIALE_DENOMINAZIONE
            rsNew!FILIALE_INDIRIZZO = FILIALE_INDIRIZZO
            rsNew!FILIALE_COMUNE = FILIALE_COMUNE
            rsNew!FILIALE_REGIONE = FILIALE_REGIONE
            rsNew!FILIALE_PROVINCIA = FILIALE_PROVINCIA
            rsNew!FILIALE_NAZIONE = FILIALE_PROVINCIA
            rsNew!FILIALE_CAP = FILIALE_CAP
            
            'DATI SOCIO
            rsNew!SOCIO_INDIRIZZO = SOCIO_INDIRIZZO
            rsNew!SOCIO_COMUNE = SOCIO_COMUNE
            rsNew!SOCIO_CAP = SOCIO_CAP
            rsNew!SOCIO_NAZIONE = SOCIO_NAZIONE
            rsNew!SOCIO_REGIONE = SOCIO_REGIONE
            rsNew!SOCIO_PROVINCIA = SOCIO_PROVINCIA
            rsNew!SOCIO_TELEFONO = SOCIO_TELEFONO
            rsNew!SOCIO_FAX = SOCIO_FAX
            rsNew!SOCIO_EMAIL = SOCIO_EMAIL
            rsNew!SOCIO_INDIRIZZOWEB = SOCIO_INDIRIZZOWEB
            rsNew!Socio_PartitaIva = SOCIO_PARTITA_IVA

            'CERTIFIZIONE AZIENDA
            rsNew!CodiceCertificazioneAzienda = CODICE_CERTIFICAZIONE_AZIENDA
            rsNew!DescrizioneCertificazioneAzienda = DESCRIZIONE_CERTIFICAZIONE_AZIENDA
            rsNew!ProtocolloCertificazioneAzienda = PROTOCOLLO_CERTIFICAZIONE_AZIENDA
            rsNew!EnteCertificatoreAzienda = ENTE_CERTIFICAZIONE_AZIENDA
            
            'CERTIFIZIONE FAMIGLIA PRODOTTO DELL'ARTICOLO LAVORATO
            'rsNew!CodiceCertificazioneFamLav = CODICE_CERTIFICAZIONE_FAM_LAV
            'rsNew!DescrizioneCertificazioneFamLav = DESCRIZIONE_CERTIFICAZIONE_FAM_LAV
            'rsNew!ProtocolloCertificazioneFamLav = PROTOCOLLO_CERTIFICAZIONE_FAM_LAV
            'rsNew!EnteCertificatoreFamLav = ENTE_CERTIFICAZIONE_FAM_LAV
            
            'CERTIFIZIONE FAMIGLIA PRODOTTO DELL'ARTICOLO CONFERITO
            rsNew!CodiceCertificazioneFamConf = CODICE_CERTIFICAZIONE_FAM_CONF
            rsNew!DescrizioneCertificazioneFamConf = DESCRIZIONE_CERTIFICAZIONE_FAM_CONF
            rsNew!ProtocolloCertificazioneFamConf = PROTOCOLLO_CERTIFICAZIONE_FAM_CONF
            rsNew!EnteCertificatoreFamConf = ENTE_CERTIFICAZIONE_FAM_CONF
            
            'DATI DESTINAZIONE MERCE
            rsNew!Cliente_DestinazioneOrdine = fnNotNull(rs!DESTINAZIONE_MERCE)
            rsNew!Cliente_DestinazioneIndirizzo = fnNotNull(rs!DESTINAZIONE_INDIRIZZO)
            rsNew!Cliente_DestinazioneComune = fnNotNull(rs!DESTINAZIONE_COMUNE)
            rsNew!Cliente_DestinazioneProvincia = fnNotNull(rs!DESTINAZIONE_PROVINCIA)
            rsNew!Cliente_DestinazioneCap = fnNotNull(rs!DESTINAZIONE_CAP)
            rsNew!Cliente_DestinazioneNazione = fnNotNull(rs!DESTINAZIONE_NAZIONE)
            rsNew!Cliente_DestinazioneTelefono = fnNotNull(rs!DESTINAZIONE_TELEFONO)
            rsNew!Cliente_DestinazioneFax = fnNotNull(rs!DESTINAZIONE_FAX)
            
            'DATI VETTORE
            rsNew!Vettore_Ordine = fnNotNull(rs!VETTORE)
            rsNew!VETTORE_INDIRIZZO = fnNotNull(rs!VETTORE_INDIRIZZO)
            rsNew!VETTORE_COMUNE = fnNotNull(rs!VETTORE_COMUNE)
            rsNew!VETTORE_PROVINCIA = fnNotNull(rs!VETTORE_PROVINCIA)
            rsNew!VETTORE_CAP = fnNotNull(rs!VETTORE_CAP)
            rsNew!VETTORE_NAZIONE = fnNotNull(rs!VETTORE_NAZIONE)
            rsNew!VETTORE_TELEFONO = fnNotNull(rs!VETTORE_TELEFONO)
            rsNew!VETTORE_FAX = fnNotNull(rs!VETTORE_FAX)
            rsNew!Vettore_PartitaIva = fnNotNull(rs!Vettore_PartitaIva)
            rsNew!Vettore_NumeroAlbo = fnNotNull(rs!Vettore_NumeroAlbo)
            
            'PASSAPORTO
            rsNew!RV_PO01_NumeroPassaportoRighe = fnNotNullN(rs!RV_PO01_NumeroPassaportoRighe)
            rsNew!RV_PO01_IDSezionaleRighe = fnNotNullN(rs!RV_PO01_IDSezionaleRighe)
            
            rsNew!Ordine_TipoOrdine = ORDINE_TIPO_ORDINE
            rsNew!Ordine_TargaAutomezzo = ORDINE_TARGA_AUTOMEZZO
            rsNew!Ordine_IstruzioneMittente = ORDINE_ISTRUZIONI_MITT
            rsNew!Ordine_AnnotazioniFatturazione = ORDINE_NOTE_FATT
            rsNew!Ordine_AnnotazioneCorpoEvasione = ORDINE_NOTE_CORPO
            rsNew!Ordine_AnnotazioniInterne = ORDINE_NOTE_INTERNE
            
            rsNew!DescrizioneImballoInLinguaCliente = fnNotNull(rs!DescrizioneImballoInLinguaCliente)
            'IMBALLO SECONDARIO
            If Trim(fnNotNull(rs!DescrizioneImballoInLinguaPred)) <> "" Then
                rsNew!DescrizioneImballoInLinguaPredefinita = fnNotNull(rs!DescrizioneImballoInLinguaPred)
            Else
                rsNew!DescrizioneImballoInLinguaPredefinita = fnNotNull(rs!ImballoVendita)
            End If
            
            'rsNew!DescrizioneImballoInLinguaPredefinita = ""
            
            'IMBALLO PRIMARIO
            rsNew!IDImballoPrimario = fnNotNullN(rs!IDArticoloImballoPrimario)
            rsNew!CodiceImballoPrimario = fnNotNull(rs!CodiceImballoPrim)
            rsNew!ImballoPrimario = fnNotNull(rs!ImballoPrim)
            rsNew!NumeroConfezioni = fnNotNullN(rs!NumeroConfezioniPerImballo)
            rsNew!TaraUnitariaConfezione = fnNotNullN(rs!TaraConfezioneImballo)
            
            rsNew!DescrizioneImballoPrimInLinguaCliente = fnNotNull(rs!DescrizioneImballoPrimInLinguaCliente)
            If Trim(fnNotNull(rs!DescrizioneImballoPrimInLinguaPred)) <> "" Then
                rsNew!DescrizioneImballoPrimInLinguaPred = fnNotNull(rs!DescrizioneImballoPrimInLinguaPred)
            Else
                rsNew!DescrizioneImballoPrimInLinguaPred = fnNotNull(rs!ImballoPrim)
            End If
            
            rsNew!CodiceABarreImballoPrimCliente = fnNotNull(rs!CodiceABarreImballoPrimCliente)
            rsNew!DescrizioneCodiceABarreImballoPrimCliente = fnNotNull(rs!DescrizioneCodiceABarreImballoPrimCliente)
            
            rsNew!CodiceABarreImballoPrimPred = fnNotNull(rs!CodiceABarreImballoPrimPred)
            rsNew!DescrizioneCodiceABarreImballoPrimPred = fnNotNull(rs!DescrizioneCodiceABarreImballoPrimPred)
            
            GET_LOTTI_IMBALLO_PER_ETICHETTA rsNew
            
        rsNew.Update
        
    rs.MoveNext
    Wend
End If


If IDConfigurazioneEtichetta > 0 Then
    GET_VALORE_CODICE_EAN_128 IDConfigurazioneEtichetta, rsNew
End If

Cn.CommitTrans
Cn.CursorLocation = OLD_Cursor


rs.Close
Set rs = Nothing

rsNew.Close
Set rsNew = Nothing

Screen.MousePointer = 0

Exit Sub
ERR_CREA_PEDANA_PER_STAMPA:
    MsgBox Err.Description, vbCritical, "CREA_PEDANA_PER_STAMPA"
    Screen.MousePointer = 0
    Cn.RollbackTrans
End Sub
Private Function GET_VALORE_PER_SEZIONE(rsLav As ADODB.Recordset, rsEtichetta As ADODB.Recordset, NomeCampo As String, TipoCampo, IDTipoCampoData As Long) As String
Dim sSQL As String
Dim sSQL_WHERE_SEZIONE As String
Dim rsSez As ADODB.Recordset
Dim rsRagg As ADODB.Recordset
Dim NomeCampoSezione As String


''''''''''''''''''''''''''''''''''''''''CALCOLO DEL COSTRUTTO WHERE''''''''''''''''''''''''''''''''''''''''''
Set rsSez = New ADODB.Recordset

sSQL = "SELECT * FROM RV_POConfigurazioneEtichettaSezione "
sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichetta=" & fnNotNullN(rsEtichetta!IDRV_POConfigurazioneEtichetta)
sSQL = sSQL & " ORDER BY NumeroRaggruppamento"

sSQL_WHERE_SEZIONE = "WHERE IDUtente=" & TheApp.IDUser

Set rsSez = New ADODB.Recordset

rsSez.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

While Not rsSez.EOF
    NomeCampoSezione = fnNotNull(rsSez!NomeCampoRaggruppamento)
    
    Select Case rsLav.Fields(NomeCampoSezione).Type
        Case adChar, adVarChar, adVarWChar, adWChar
            
            sSQL_WHERE_SEZIONE = sSQL_WHERE_SEZIONE & " AND " & fnNotNull(rsSez!NomeCampoRaggruppamento) & "=" & fnNormString(fnNotNull(rsLav.Fields(NomeCampoSezione).Value))
        
        Case adInteger
            
            sSQL_WHERE_SEZIONE = sSQL_WHERE_SEZIONE & " AND " & fnNotNull(rsSez!NomeCampoRaggruppamento) & "=" & fnNotNullN(rsLav.Fields(NomeCampoSezione).Value)
        
        Case adDate, adDBDate, adDBTime, adDBTimeStamp
            
            sSQL_WHERE_SEZIONE = sSQL_WHERE_SEZIONE & " AND " & fnNotNull(rsSez!NomeCampoRaggruppamento) & "=" & fnNormDate(fnNotNull(rsLav.Fields(NomeCampoSezione).Value))
        
        Case adBoolean, adSmallInt, adTinyInt, adUnsignedTinyInt, adUnsignedSmallInt
            
            sSQL_WHERE_SEZIONE = sSQL_WHERE_SEZIONE & " AND " & fnNotNull(rsSez!NomeCampoRaggruppamento) & "=" & fnNormBoolean(fnNotNullN(rsLav.Fields(NomeCampoSezione).Value))
        
        Case adNumeric, adSingle, adBigInt, adCurrency, adDouble, adDecimal
            
            sSQL_WHERE_SEZIONE = sSQL_WHERE_SEZIONE & " AND " & fnNotNull(rsSez!NomeCampoRaggruppamento) & "=" & fnNormNumber(fnNotNullN(rsLav.Fields(NomeCampoSezione).Value))
    
    End Select
    
    If fnNotNullN(rsSez!IDRV_POConfigurazioneEtichettaSezione) = fnNotNullN(rsEtichetta!IDRV_POConfigurazioneEtichettaSezione) Then
        rsSez.MoveLast
    End If

rsSez.MoveNext
Wend

rsSez.Close
Set rsSez = Nothing
''''''''''''''''''''''FINE CALCOLO COSTRUTTO WHERE''''''''''''''''''''''''''''''''''''''''
''''''''''''''''''''''CALCOLO DEL VALORE DEL CAMPO''''''''''''''''''''''''''''''''''''''''
Set rsRagg = New ADODB.Recordset

Select Case TipoCampo
    Case adChar, adVarChar, adVarWChar, adWChar
        
        sSQL = "SELECT " & NomeCampo
        sSQL = sSQL & " FROM RV_POTMPStampaEtichetteRighe "
        If Len(sSQL_WHERE_SEZIONE) > 0 Then
            sSQL = sSQL & sSQL_WHERE_SEZIONE
        End If
        sSQL = sSQL & " GROUP BY " & NomeCampo
        
    Case adInteger
        
        sSQL = "SELECT sum(" & NomeCampo & ") AS " & NomeCampo
        sSQL = sSQL & " FROM RV_POTMPStampaEtichetteRighe "
        If Len(sSQL_WHERE_SEZIONE) > 0 Then
            sSQL = sSQL & sSQL_WHERE_SEZIONE
        End If
        
        
    Case adDate, adDBDate, adDBTime, adDBTimeStamp
        
        sSQL = "SELECT " & NomeCampo
        sSQL = sSQL & " FROM RV_POTMPStampaEtichetteRighe "
        If Len(sSQL_WHERE_SEZIONE) > 0 Then
            sSQL = sSQL & sSQL_WHERE_SEZIONE
        End If
        sSQL = sSQL & " GROUP BY " & NomeCampo
    Case adBoolean, adSmallInt, adTinyInt, adUnsignedTinyInt, adUnsignedSmallInt
        
        sSQL = "SELECT " & NomeCampo
        sSQL = sSQL & " FROM RV_POTMPStampaEtichetteRighe "
        If Len(sSQL_WHERE_SEZIONE) > 0 Then
            sSQL = sSQL & sSQL_WHERE_SEZIONE
        End If
        sSQL = sSQL & " GROUP BY " & NomeCampo
    Case adNumeric, adSingle, adBigInt, adCurrency, adDouble, adDecimal
        
        sSQL = "SELECT sum(" & NomeCampo & ") AS " & NomeCampo
        sSQL = sSQL & " FROM RV_POTMPStampaEtichetteRighe "
        If Len(sSQL_WHERE_SEZIONE) > 0 Then
            sSQL = sSQL & sSQL_WHERE_SEZIONE
        End If

End Select


rsRagg.Open sSQL, Cn.InternalConnection


If rsRagg.EOF Then
    GET_VALORE_PER_SEZIONE = ""
Else
    Select Case rsLav.Fields(NomeCampo).Type
        
        Case adDate, adDBDate, adDBTime, adDBTimeStamp
            GET_VALORE_PER_SEZIONE = GET_VALORE_TIPO_DATA_ETICHETTA(IDTipoCampoData, fnNotNull(rsRagg(NomeCampo).Value))
        Case Else
            GET_VALORE_PER_SEZIONE = fnNotNull(rsRagg(NomeCampo).Value)
    End Select
End If

rsRagg.Close
Set rsRagg = Nothing
End Function
Private Function GET_VALORE_TIPO_DATA_ETICHETTA(IDTipoCampoEtichetta, ValoreData As String) As String
Dim Giorno As String
Dim Mese As String
Dim AnnoRidotto As String
Dim Anno As String

Giorno = Day(ValoreData)
Mese = Month(ValoreData)
Anno = Year(ValoreData)

If Len(Giorno) = 1 Then
    Giorno = "0" & Giorno
End If

If Len(Mese) = 1 Then
    Mese = "0" & Mese
End If

If Len(Anno) = 4 Then
    AnnoRidotto = Right(Anno, 2)
End If

Select Case IDTipoCampoEtichetta
    Case 1
        GET_VALORE_TIPO_DATA_ETICHETTA = Giorno & Mese & Anno
    Case 2
        GET_VALORE_TIPO_DATA_ETICHETTA = Giorno & Mese & AnnoRidotto
    Case 3
        GET_VALORE_TIPO_DATA_ETICHETTA = Mese & Giorno & Anno
    Case 4
        GET_VALORE_TIPO_DATA_ETICHETTA = Mese & Giorno & AnnoRidotto
    Case 5
        GET_VALORE_TIPO_DATA_ETICHETTA = Anno & Giorno & Mese
    Case 6
        GET_VALORE_TIPO_DATA_ETICHETTA = AnnoRidotto & Giorno & Mese
    Case 7
        GET_VALORE_TIPO_DATA_ETICHETTA = Anno & Mese & Giorno
    Case 8
        GET_VALORE_TIPO_DATA_ETICHETTA = AnnoRidotto & Mese & Giorno
    Case Else
        GET_VALORE_TIPO_DATA_ETICHETTA = Giorno & Mese & Anno
End Select
End Function
Private Sub SCRIVI_CODA(IDOggetto As Long, IDTipoOggetto As Long)
Dim rs As ADODB.Recordset
Dim sSQL As String

'''''''''''''''''ELIMINAZIONE DATI UTENTE PER IL TIPO OGGETTO'''''''''''''''''''
sSQL = "DELETE FROM RV_POTMP "
sSQL = sSQL & "WHERE IDUtente=" & m_App.IDUser
sSQL = sSQL & " AND IDTipoOggetto=" & IDTipoOggetto

Cn.Execute sSQL
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Set rs = New ADODB.Recordset

rs.Open "RV_POTMP", Cn.InternalConnection, adOpenKeyset, adLockPessimistic

rs.AddNew
    rs!IDSessione = fnGetNewKey("RV_POTMP", "IDSessione")
    rs!IDUtente = m_App.IDUser
    rs!IDTipoOggetto = IDTipoOggetto
    rs!IDOggetto = IDOggetto
    rs!Utente = m_App.User
rs.Update

rs.Close
Set rs = Nothing

End Sub
Private Sub SCRIVI_CODA_PEDANA(IDOggetto As Long, IDTipoOggetto As Long)
Dim rs As ADODB.Recordset
Dim sSQL As String

'''''''''''''''''ELIMINAZIONE DATI UTENTE PER IL TIPO OGGETTO'''''''''''''''''''

sSQL = "DELETE FROM RV_POTMP "
sSQL = sSQL & "WHERE IDUtente=" & m_App.IDUser
'sSQL = sSQL & " AND IDTipoOggetto=" & m_DocType.ID

Cn.Execute sSQL
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Set rs = New ADODB.Recordset

rs.Open "RV_POTMP", Cn.InternalConnection, adOpenKeyset, adLockPessimistic

rs.AddNew
    rs!IDSessione = fnGetNewKey("RV_POTMP", "IDSessione")
    rs!IDUtente = m_App.IDUser
    rs!IDTipoOggetto = IDTipoOggetto
    rs!IDOggetto = IDOggetto
    rs!Utente = m_App.User
rs.Update
rs.Close
Set rs = Nothing
End Sub
Private Function GET_NUMERO_DOCUMENTO(IDTipoOggetto As Long, Optional NuovoDocumento As Boolean) As Long
On Error GoTo ERR_GET_NUMERO_DOCUMENTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim X_FRM As Form
Dim Link_Lotto As Long

sSQL = "SELECT * FROM RV_POTMP "
sSQL = sSQL & "WHERE IDTipoOggetto=" & IDTipoOggetto
sSQL = sSQL & "ORDER BY IDSessione, IDUtente"


Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    If fnNotNullN(rs!IDUtente) = m_App.IDUser Then
        Me.Caption = "SALVATAGGIO IN CORSO.........."
        DoEvents
    
        
        If NuovoDocumento = True Then
            Link_Lotto = GET_NUMERO_LOTTO
            Me.txtLottoVendita.Text = fnGetCodiceLotto(2, 1, Me.txtLottoVendita.Text, Link_Lotto)
            rsNew!CodiceLottoVendita = Me.txtLottoVendita.Text
            rsNew!IDRV_POAssegnazioneMerce = fnGetNewKey("RV_POAssegnazioneMerce", "IDRV_POAssegnazioneMerce")
            rsNew!IDRV_POAssegnazioneMercePadre = rsNew!IDRV_POAssegnazioneMerce
        End If
        
        
        If APERTURA_FORM_CODA = True Then
            Unload frmCoda
            APERTURA_FORM_CODA = False
        End If
        
        GET_NUMERO_DOCUMENTO = 1
        
    Else
    
        If APERTURA_FORM_CODA = False Then
            APERTURA_FORM_CODA = True
            frmCoda.Show
        End If
        
        Me.Caption = "ATTENDERE......."
        DoEvents

        
        GET_NUMERO_DOCUMENTO 0
        
    End If
End If


rs.CloseResultset
Set rs = Nothing

Exit Function

ERR_GET_NUMERO_DOCUMENTO:
MsgBox Err.Description, vbCritical, "Errore coda"
    
If APERTURA_FORM_CODA = True Then
    Unload frmCoda
    APERTURA_FORM_CODA = False
End If

GET_NUMERO_DOCUMENTO = -1

End Function

Private Function GET_LINK_ANAGRAFICA_ORDINE(IDOggettoOrdine As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Link_nom_anagrafica "
sSQL = sSQL & "FROM ValoriOggettoPerTipo000F "
sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_ANAGRAFICA_ORDINE = 0
Else
    GET_LINK_ANAGRAFICA_ORDINE = fnNotNullN(rs!Link_nom_anagrafica)
End If



rs.CloseResultset
Set rs = Nothing
End Function
Private Sub txtPesoLordo_Q_Change()
    If Link_UnitaDiMisura_Coop_Q = 2 Then
        Me.txtQta_UM_Q.Value = Me.txtPesoLordo_Q.Value
    End If
    
    GET_PERC_RESO
End Sub

Private Sub txtPesoLordo_Q_LostFocus()
    CalcoloPesoNetto_Q
End Sub

Private Sub txtPesoNetto_Q_Change()
    If Link_UnitaDiMisura_Coop_Q = 3 Then
        Me.txtQta_UM_Q.Value = Me.txtPesoNetto_Q.Value
    End If
    
    GET_PERC_RESO
End Sub

Private Sub txtPesoNetto_Q_LostFocus()
    Me.txtPesoLordo_Q.Value = Me.txtPesoNetto_Q.Value + Me.txtTara_Q.Value
End Sub

Private Sub txtPezzi_Q_Change()
    If Link_UnitaDiMisura_Coop_Q = 5 Then
        Me.txtQta_UM_Q.Value = Me.txtPezzi_Q.Value
    End If
    
    GET_PERC_RESO
End Sub
Private Sub CalcoloPesoNetto_Q()
On Error Resume Next
    Me.txtTara_Q.Value = Me.txtColli_Q.Value * Me.txtTaraUnitaria_Q.Value
    Me.txtPesoNetto_Q.Value = Me.txtPesoLordo_Q.Value - Me.txtTara_Q.Value
End Sub

Private Function GET_ORARIO(StringaData As String) As String
Dim Ora As String
Dim Minuti As String
Dim Secondi As String

If Len(DatePart("h", StringaData)) = 1 Then
    Ora = "0" & DatePart("h", StringaData)
Else
    Ora = DatePart("h", StringaData)
End If
If Len(DatePart("n", StringaData)) = 1 Then
    Minuti = "0" & DatePart("n", StringaData)
Else
    Minuti = DatePart("n", StringaData)
End If
If Len(DatePart("s", StringaData)) = 1 Then
    Secondi = "0" & DatePart("s", StringaData)
Else
    Secondi = DatePart("s", StringaData)
End If

GET_ORARIO = Ora & "." & Minuti & "." & Secondi


End Function

Public Function PermessoSalvataggio_Q() As Boolean
PermessoSalvataggio_Q = True

If Me.CDArticolo_Q.KeyFieldID <= 0 Then
    MsgBox "Inserire l'articolo", vbInformation, "Errore salvataggio"
    PermessoSalvataggio_Q = False
    Me.CDArticolo_Q.SetFocus
    Exit Function
End If

If Me.txtColli_Q.Value < 0 Then
    MsgBox "La quantità dei colli deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio_Q = False
    Me.txtColli_Q.SetFocus
    Exit Function
End If

If Me.txtPesoLordo_Q.Value < 0 Then
    MsgBox "La quantità del peso lordo deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio_Q = False
    Me.txtPesoLordo_Q.SetFocus
    Exit Function
    
End If
If Me.txtPesoNetto_Q.Value < 0 Then
    MsgBox "La quantità del peso netto deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio_Q = False
    Me.txtPesoNetto_Q.SetFocus
    Exit Function
    
End If
If Me.txtPezzi_Q.Value < 0 Then
    MsgBox "La quantità dei pezzi deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio_Q = False
    Me.txtPezzi_Q.SetFocus
    Exit Function
    
End If
If Me.txtTara_Q.Value < 0 Then
    MsgBox "La quantità della tara deve essere maggiore o uguale a zero", vbInformation, "Errore salvataggio"
    PermessoSalvataggio_Q = False
    Me.txtTara_Q.SetFocus
    Exit Function
    
End If
If (Me.txtPesoLordo_Q.Value < Me.txtPesoNetto_Q.Value) Then
    MsgBox "La quantità del peso netto deve essere minore o uguale al valore del peso lordo", vbInformation, "Errore salvataggio"
    PermessoSalvataggio_Q = False
    Me.txtPesoLordo_Q.SetFocus
    Exit Function

End If
If Me.cboUM_Q.CurrentID <= 0 Then
    MsgBox "Non è stata impostata l'unità misura dell'articolo.", vbInformation, "Errore salvataggio"
    PermessoSalvataggio_Q = False
    Me.CDArticolo_Q.SetFocus
    Exit Function
    
End If
If (Link_TipoProdotto_Q <> Link_TipoCaloPeso) And (Link_TipoProdotto_Q <> Link_TipoAumentoPeso) And (Link_TipoProdotto_Q <> Link_TipoScarto) Then
    MsgBox "Il prodotto selezionato non è un prodotto di quadratura", vbInformation, "Errore salvataggio"
    PermessoSalvataggio_Q = False
    Exit Function
End If
End Function

Private Function MOVIMENTAZIONE_RIGA_QUADRATURA() As String
Dim OLD_Cursor As Long
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
Dim IDTipoProdotto As Long


CONTROLLO_ELIMINAZIONE_VECCHIO_MOVIMENTO fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey).Value)
    
Set Mov = New DmtMovim.cMovimentazione

Set Mov.Connection = TheApp.Database.Connection

'''''''''''''''''''''''ELIMINAZIONE MOVIMENTI DELLA RIGA DI LAVORAZIONE
sSQL = "SELECT IDMovimento FROM Movimento "
sSQL = sSQL & "WHERE IDTipoOggetto=" & fnGetTipoOggetto("RV_POLavorazioneL")
sSQL = sSQL & " AND IDOggetto=" & fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
sSQL = sSQL & " AND IDValoriOggettoDettaglio=" & fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey).Value)

Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    Cn.BeginTrans
    If Mov.Delete(fnNotNullN(rs!IDMovimento)) = False Then
        MOVIMENTAZIONE_RIGA_QUADRATURA = "Problema riscontrato con l'eliminazione dei movimenti della riga"
        Cn.RollbackTrans
    Else
        Cn.CommitTrans
    End If
    
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

MOVIMENTAZIONE_RIGA_QUADRATURA = ""

IDTipoProdotto = GET_TIPO_PRODOTTO(Me.CDArticolo_Q.KeyFieldID)

    Select Case Link_UnitaDiMisura_Coop_Conferimento
        Case 1

            If GeneraMovimentoDiCarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtQta_UM_Q.Value, Me.txtDataLavorazione_Q.Text, Me.CDArticolo_Q.Code, Me.CDArticolo_Q.Description, Me.CDArticolo_Q.KeyFieldID, Me.txtColli_Q.Value, Me.cboUM_Q.CurrentID, _
            Me.txtDataLavorazione_Q.Text, Me.CboTipoLavorazione_Q.CurrentID, 0, 0, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
            End If

            If GeneraMovimentoDiScarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtColli.Value, Me.txtDataLavorazione_Q.Text) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
            End If
        Case 2
            If GeneraMovimentoDiCarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtQta_UM_Q.Value, Me.txtDataLavorazione_Q.Text, Me.CDArticolo_Q.Code, Me.CDArticolo_Q.Description, Me.CDArticolo_Q.KeyFieldID, Me.txtPesoLordo_Q.Value, Me.cboUM_Q.CurrentID, _
            Me.txtDataLavorazione_Q.Text, Me.CboTipoLavorazione_Q.CurrentID, 0, 0, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
            End If

            If GeneraMovimentoDiScarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtPesoLordo_Q.Value, Me.txtDataLavorazione_Q.Text) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
            End If
        Case 3
            If GeneraMovimentoDiCarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtQta_UM_Q.Value, Me.txtDataLavorazione_Q.Text, Me.CDArticolo_Q.Code, Me.CDArticolo_Q.Description, Me.CDArticolo_Q.KeyFieldID, Me.txtPesoNetto_Q.Value, Me.cboUM_Q.CurrentID, _
            Me.txtDataLavorazione_Q.Text, Me.CboTipoLavorazione_Q.CurrentID, 0, 0, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
            End If

            If GeneraMovimentoDiScarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtPesoNetto_Q.Value, Me.txtDataLavorazione_Q.Text) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
            End If
        Case 4
            If GeneraMovimentoDiCarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtQta_UM_Q.Value, Me.txtDataLavorazione_Q.Text, Me.CDArticolo_Q.Code, Me.CDArticolo_Q.Description, Me.CDArticolo_Q.KeyFieldID, Me.txtTara_Q.Value, Me.cboUM_Q.CurrentID, _
            Me.txtDataLavorazione_Q.Text, Me.CboTipoLavorazione_Q.CurrentID, 0, 0, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
            End If
            If GeneraMovimentoDiScarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtTara_Q.Value, Me.txtDataLavorazione_Q.Text) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
            End If
        Case 5
            If GeneraMovimentoDiCarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtQta_UM_Q.Value, Me.txtDataLavorazione_Q.Text, Me.CDArticolo_Q.Code, Me.CDArticolo_Q.Description, Me.CDArticolo_Q.KeyFieldID, Me.txtPezzi_Q.Value, Me.cboUM_Q.CurrentID, _
            Me.txtDataLavorazione_Q.Text, Me.CboTipoLavorazione_Q.CurrentID, 0, 0, Me.cboTipoLavConf.CurrentID, Me.chkPrezzoMedioConf.Value) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di lavorazione" & vbCrLf
            End If

            If GeneraMovimentoDiScarico_Q(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey)), IDTipoProdotto, Me.txtPezzi_Q.Value, Me.txtDataLavorazione_Q.Text) = False Then
                MOVIMENTAZIONE_RIGA_QUADRATURA = MOVIMENTAZIONE_RIGA_QUADRATURA & "Problema riscontrato con la movimentazione della riga di conferimento" & vbCrLf
            End If

    End Select
           

    
'Cn.CursorLocation = OLD_CURSOR
Set Mov = Nothing

End Function

Private Function GeneraMovimentoDiCarico_Q(IDRiga As Long, IDTipoProdotto As Long, Quantita As Double, DataQuadratura As String, CodiceArticolo As String, DescrizioneArticolo As String, IDArticolo As Long, QuantitaMovimentata As Double, IDUnitaDiMisura As Long, _
DataLavorazione As String, IDTipoLavorazione As Long, IDTipoCategoria As Long, IDCalibro As Long, IDTipoLavorazioneConf As Long, PrezzoMedioConf As Long) As Boolean
Cn.BeginTrans


Mov.DataMovimento = DataQuadratura
Mov.FattoreDiConversione = Null
Mov.GestioneMatricole = False
Mov.IDEsercizio = Link_Esercizio
Mov.IDTipoOggetto = fnGetTipoOggetto("RV_POLavorazioneL")
Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
Select Case IDTipoProdotto
    Case Link_TipoCaloPeso
        Mov.IDFunzione = GET_CAUSALE_QUADRATURA("IDCausaleCaloPesoCarico")
        Mov.Field "Oggetto", "Calo peso"
    Case Link_TipoAumentoPeso
        Mov.IDFunzione = GET_CAUSALE_QUADRATURA("IDCausaleAumentoPesoCarico")
        Mov.Field "Oggetto", "Aumento di peso"
    Case Link_TipoScarto
        Mov.IDFunzione = GET_CAUSALE_QUADRATURA("IDCausaleScartoCarico")
        Mov.Field "Oggetto", "Scarto"
End Select

Mov.IDUtente = TheApp.IDUser
Mov.IDMagazzinoUscita = CboMagazzinoVend.CurrentID
Mov.IDMagazzinoEntrata = CboMagazzinoVend.CurrentID
Mov.Cessione = 0
Mov.Field "IDAzienda", TheApp.IDFirm
Mov.Field "IDAnagrafica", Me.TxtIDAnagrafica.Text
Mov.Field "IDTipoAnagrafica", 3
Mov.Field "IDArticolo", IDArticolo
Mov.Field "IDUnitaDiMisura", IDUnitaDiMisura
Mov.Field "IDcambio", Null
Mov.Field "DescrizioneArticolo", DescrizioneArticolo
Mov.Field "QuantitaTotale", Quantita
Mov.Field "Importo", 0
Mov.Field "DataDocumento", Date

Mov.Field "IDTipoMovimento", 1
Mov.Field "TipoRiga", trcNessuno

'DATI DI CONFERIMENTO
Mov.Field "IDValoriOggettoDettaglio", IDRiga
Mov.Field "RV_POTipoRiga", 1
Mov.Field "RV_POIDCaricoMerceRighe", m_Document(m_Document.PrimaryKey).Value
Mov.Field "RV_POIDAssegnazioneMerce", 0
Mov.Field "RV_POIDProcessoIVGamma", 0
Mov.Field "RV_POIDAnagraficaSocio", m_Document("IDAnagrafica").Value
Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
Mov.Field "RV_POCodiceLottoVendita", ""
Mov.Field "RV_POQuantitaLiquidazione", 0
Mov.Field "RV_POImportoInclusoImballo", 0
Mov.Field "RV_POImportoLiquidazione", 0
Mov.Field "RV_POQuantitaMovimentata", QuantitaMovimentata

Mov.Field "RV_PODataLavorazione", DataLavorazione
Mov.Field "RV_POIDTipoLavorazione", IDTipoLavorazione
Mov.Field "RV_POIDCalibro", IDCalibro
Mov.Field "RV_POIDTipoCategoria", IDTipoCategoria
Mov.Field "RV_POIDTipoLavorazioneConf", IDTipoLavorazioneConf
Mov.Field "RV_POPrezzoMedioConf", PrezzoMedioConf

GeneraMovimentoDiCarico_Q = Mov.Insert

If GeneraMovimentoDiCarico_Q = False Then
    Cn.RollbackTrans
Else
    Cn.CommitTrans
End If

End Function
Private Function GeneraMovimentoDiScarico_Q(IDRiga As Long, IDTipoProdotto As Long, Quantita As Double, DataQuadratura As String) As Boolean

Cn.BeginTrans

Mov.DataMovimento = DataQuadratura
Mov.FattoreDiConversione = Null
Mov.GestioneMatricole = False
Mov.IDEsercizio = Link_Esercizio
Mov.IDTipoOggetto = fnGetTipoOggetto("RV_POLavorazioneL")
Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
Select Case IDTipoProdotto
    Case Link_TipoCaloPeso
        Mov.IDFunzione = GET_CAUSALE_QUADRATURA("IDCausaleCaloPeso")
        Mov.Field "Oggetto", "Calo peso"
    Case Link_TipoAumentoPeso
        Mov.IDFunzione = GET_CAUSALE_QUADRATURA("IDCausaleAumentoPeso")
        Mov.Field "Oggetto", "Aumento di peso"
    Case Link_TipoScarto
        Mov.IDFunzione = GET_CAUSALE_QUADRATURA("IDCausaleScarto")
        Mov.Field "Oggetto", "Scarto"
End Select

Mov.IDUtente = TheApp.IDUser
Mov.IDMagazzinoUscita = cboMagazzinoConf.CurrentID
Mov.IDMagazzinoEntrata = cboMagazzinoConf.CurrentID
Mov.Cessione = 0
Mov.Field "IDAzienda", TheApp.IDFirm
Mov.Field "IDAnagrafica", Me.TxtIDAnagrafica.Text
Mov.Field "IDTipoAnagrafica", 3
Mov.Field "IDArticolo", fnNotNullN(m_Document("IDArticolo").Value)
Mov.Field "IDcambio", Null
Mov.Field "DescrizioneArticolo", fnNotNull(m_Document("Articolo").Value)
Mov.Field "QuantitaTotale", Quantita
Mov.Field "Importo", 0
Mov.Field "IDUnitaDiMisura", fnNotNullN(m_Document("IDUnitaDiMisuraDiamante").Value)
Mov.Field "DataDocumento", Date

Mov.Field "IDTipoMovimento", 1
Mov.Field "TipoRiga", trcNessuno


'DATI DI CONFERIMENTO
Mov.Field "IDValoriOggettoDettaglio", IDRiga
Mov.Field "RV_POTipoRiga", 1
Mov.Field "RV_POIDCaricoMerceRighe", 0
Mov.Field "RV_POIDAssegnazioneMerce", 0
Mov.Field "RV_POIDProcessoIVGamma", 0
Mov.Field "RV_POIDAnagraficaSocio", ""
Mov.Field "RV_PODataConferimento", ""
Mov.Field "RV_PONumeroConferimento", 0
Mov.Field "RV_POCodiceLotto", ""
Mov.Field "RV_POCodiceLottoCampagna", ""
Mov.Field "RV_POCodiceLottoVendita", ""
Mov.Field "RV_POQuantitaLiquidazione", 0
Mov.Field "RV_POImportoInclusoImballo", 0
Mov.Field "RV_POImportoLiquidazione", 0
Mov.Field "RV_POQuantitaMovimentata", 0
Mov.Field "RV_PONumeroColli", 0
Mov.Field "RV_POPesoLordo", 0
Mov.Field "RV_POPesoNetto", 0
Mov.Field "RV_POTara", 0
Mov.Field "RV_POQuantitaPezzi", 0


GeneraMovimentoDiScarico_Q = Mov.Insert

If GeneraMovimentoDiScarico_Q = False Then
    Cn.RollbackTrans
Else
    Cn.CommitTrans
End If

End Function



Private Sub CONTROLLO_ELIMINAZIONE_VECCHIO_MOVIMENTO(IDRigaQuadratura As Long)
Dim sSQL As String
Dim rs As ADODB.Recordset

sSQL = "SELECT IDMovimento_Carico, IDMovimento_Vendita "
sSQL = sSQL & "FROM RV_POLavorazione "
sSQL = sSQL & "WHERE IDRV_POLavorazione=" & IDRigaQuadratura

Set rs = New ADODB.Recordset

rs.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

If Not rs.EOF Then
    If fnNotNullN(rs!IDMovimento_Carico) > 0 Then
        EliminaMovimentoQuadratura fnNotNullN(rs!IDMovimento_Carico)
    End If
    
    If fnNotNullN(rs!IDMovimento_Carico) > 0 Then
        EliminaMovimentoQuadratura fnNotNullN(rs!IDMovimento_Vendita)
    End If
    
    rs!IDMovimento_Carico = 0
    rs!IDMovimento_Vendita = 0
    rs.Update
End If



rs.Close
Set rs = Nothing


End Sub
Private Function EliminaMovimentoQuadratura(IDMovimento As Long) As Boolean



Set Mov = New DmtMovim.cMovimentazione

Set Mov.Connection = TheApp.Database.Connection


EliminaMovimentoQuadratura = Mov.Delete(IDMovimento)

If EliminaMovimentoQuadratura = False Then
    MsgBox "Impossibile eliminare il movimento (IDMovimento: " & IDMovimento & ")", vbCritical, "Eliminazione movimento di carico"
End If


Set Mov = Nothing
End Function
Private Function EliminaMovimentoQuadraturaPerEliminazioneRiga(IDRiga As Long, Optional Gestore As String) As Boolean
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String
Dim IDMovimento_Local As Long

EliminaMovimentoQuadraturaPerEliminazioneRiga = True

sSQL = "SELECT IDMovimento FROM Movimento "
sSQL = sSQL & "WHERE IDValoriOggettoDettaglio=" & IDRiga
sSQL = sSQL & " AND IDTipoOggetto=" & fnGetTipoOggetto("RV_POLavorazioneL")

Set rs = Cn.OpenResultset(sSQL, adOpenKeyset)

Set Mov = New DmtMovim.cMovimentazione

Set Mov.Connection = TheApp.Database.Connection


While Not rs.EOF
    Cn.BeginTrans
    EliminaMovimentoQuadraturaPerEliminazioneRiga = Mov.Delete(fnNotNullN(rs!IDMovimento))
    
    If EliminaMovimentoQuadraturaPerEliminazioneRiga = False Then
        Cn.RollbackTrans
        MsgBox "Impossibile eliminare il movimento (IDMovimento: " & fnNotNullN(rs!IDMovimento) & ")", vbCritical, "Eliminazione movimento di carico"
        EliminaMovimentoQuadraturaPerEliminazioneRiga = False
        rs.MoveLast
        
    End If
    Cn.CommitTrans
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing

Set Mov = Nothing


End Function
Private Sub REFRESH_DATI_ETICHETTA(Tipo As Long, IDEtichetta As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT NomeReport, DataUltimaModifica, OraUltimaModifica, Larghezza_X,Altezza_Y, Orientamento "
sSQL = sSQL & "FROM RV_POConfigurazioneEtichetta "
sSQL = sSQL & " WHERE IDRV_POConfigurazioneEtichetta=" & IDEtichetta

Set rs = Cn.OpenResultset(sSQL)

If Tipo = 1 Then
    If rs.EOF Then
        Me.txtNomeReportLavorazione.Text = ""
        Me.txtDataCreazioneReportLavorazione.Text = ""
        Me.txt_X_Lavorazione.Text = 0
        Me.txt_Y_Lavorazione.Text = 0
        Me.txtOrientamentoLavorazione.Text = 0
        Me.txtOraCreazioneReportLavorazione.Text = ""
    Else
        Me.txtNomeReportLavorazione.Text = fnNotNull(rs!NomeReport)
        Me.txtDataCreazioneReportLavorazione.Text = fnNotNull(rs!DataUltimaModifica)
        Me.txt_X_Lavorazione.Text = fnNotNullN(rs!Larghezza_X)
        Me.txt_Y_Lavorazione.Text = fnNotNullN(rs!Altezza_Y)
        Me.txtOrientamentoLavorazione.Text = fnNotNullN(rs!Orientamento) + 1
        Me.txtOraCreazioneReportLavorazione.Text = fnNotNull(rs!OraUltimaModifica)
    End If
End If

If Tipo = 2 Then
    If rs.EOF Then
        Me.txtNomeReportPedana.Text = ""
        Me.txtDataCreazioneReportPedana.Text = ""
        Me.txt_X_Pedana.Text = ""
        Me.txt_Y_Pedana.Text = ""
        Me.txtOrientamentoPedana.Text = ""
        Me.txtOraCreazioneReportPedana.Text = ""
    Else
        Me.txtNomeReportPedana.Text = fnNotNull(rs!NomeReport)
        Me.txtDataCreazioneReportPedana.Text = fnNotNull(rs!DataUltimaModifica)
        Me.txt_X_Pedana.Text = fnNotNullN(rs!Larghezza_X)
        Me.txt_Y_Pedana.Text = fnNotNullN(rs!Altezza_Y)
        Me.txtOrientamentoPedana.Text = fnNotNullN(rs!Orientamento) + 1
        Me.txtOraCreazioneReportPedana.Text = fnNotNull(rs!OraUltimaModifica)
    End If
    
End If


rs.CloseResultset
Set rs = Nothing



End Sub
Private Function GET_LINK_ANAGRAFICA_AZIENDA(IDAzienda As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDAnagrafica FROM Azienda "
sSQL = sSQL & "WHERE IDAzienda=" & IDAzienda

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_ANAGRAFICA_AZIENDA = 0
Else
    GET_LINK_ANAGRAFICA_AZIENDA = fnNotNullN(rs!IDAnagrafica)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_ARTICOLO_ANNULLATO(IDArticolo As Long) As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Annullato FROM Articolo "
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_ARTICOLO_ANNULLATO = False
Else
    GET_ARTICOLO_ANNULLATO = fnNotNullN(rs!Annullato)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_LINK_LISTINO() As Long
Dim IDListinoDefault As Long

    IDListinoDefault = GET_LISTINO_DEFAULT(Me.cdCliente.KeyFieldID, Me.cboDestinazione.CurrentID)
    
    'If IDListinoDefault > 0 Then
        GET_LINK_LISTINO = IDListinoDefault
    'Else
    '    GET_LINK_LISTINO = GET_LISTINO_DEFAULT_PARAMETRI_AZIENDA
    'End If
End Function
Private Function CHECK_ABILITAZIONE_DIAMANTE() As Boolean
Dim I As Integer
Dim swChk As DmtSwChk.SwCheck

Set swChk = New DmtSwChk.SwCheck

Set swChk.Connection = Cn.InternalConnection
swChk.SwComponentName = "MODBASE_"
I = swChk.CheckSwComponent

Select Case I
    Case 0
        CHECK_ABILITAZIONE_DIAMANTE = False
        MsgBox swChk.LastError, vbCritical, "Abilitazione programma"
    Case -1
        CHECK_ABILITAZIONE_DIAMANTE = True
    Case -2
        CHECK_ABILITAZIONE_DIAMANTE = False
        MsgBox swChk.LastError, vbCritical, "Abilitazione programma"
End Select

Set swChk = Nothing

End Function
Private Function GET_NUMERO_DOCUMENTO_PEDANA(NuovoDocumento As Boolean, IDTipoOggetto As Long) As Long
On Error GoTo ERR_GET_NUMERO_DOCUMENTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim X_FRM As Form
Dim OLD_Cursor As Long

GET_NUMERO_DOCUMENTO_PEDANA = 0

sSQL = "SELECT * FROM RV_POTMP "
sSQL = sSQL & "WHERE IDTipoOggetto=" & IDTipoOggetto
sSQL = sSQL & " ORDER BY IDSessione, IDUtente"

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    If fnNotNullN(rs!IDUtente) = m_App.IDUser Then

        DoEvents
        
        If NuovoDocumento = True Then
            Me.txtCodicePedana.Text = GetNumeroPedana(DatePart("yyyy", Date))
            Me.txtIDPedana.Value = LINK_PEDANA
            If Me.CDTipoPedana.KeyFieldID = 0 Then
                Me.CDTipoPedana.Load GET_TIPO_PEDANA(LINK_PEDANA)
                Me.txtPesoPedana.Value = GET_PESO_PEDANA(LINK_PEDANA, Me.CDTipoPedana.KeyFieldID)
            End If
        End If
        
        DoEvents
        
        If APERTURA_FORM_CODA = True Then
            Unload frmCoda
            APERTURA_FORM_CODA = False
        End If
        
        GET_NUMERO_DOCUMENTO_PEDANA = 1
        
        rs.CloseResultset
        Set rs = Nothing
    Else
        rs.CloseResultset
        Set rs = Nothing
    
        If APERTURA_FORM_CODA = False Then
            APERTURA_FORM_CODA = True
            Me.Enabled = False
            frmCoda.Show
        End If
        
        DoEvents
        'GET_NUMERO_DOCUMENTO NuovoDocumento
        
    End If
End If
Exit Function

ERR_GET_NUMERO_DOCUMENTO:
    MsgBox Err.Description, vbCritical, "Errore coda"
    GET_NUMERO_DOCUMENTO_PEDANA = -1
    Unload frmCoda
End Function

Private Function GET_UTENTE(IDUtente As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Utente FROM Utente "
sSQL = sSQL & "WHERE IDUtente=" & IDUtente

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_UTENTE = ""
Else
    GET_UTENTE = fnNotNull(rs!Utente)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_CONTROLLO_PEDANA_ORDINE(IDPedana As Long, IDOggettoOrdine As Long, IDAssegnazioneMerce As Long) As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDRV_POAssegnazioneMerce, IDRV_POPedana "
sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
sSQL = sSQL & "WHERE IDRV_POPedana=" & IDPedana
sSQL = sSQL & " AND IDOggettoOrdine<>" & IDOggettoOrdine
sSQL = sSQL & " AND IDRV_POAssegnazioneMerce<>" & IDAssegnazioneMerce
Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_CONTROLLO_PEDANA_ORDINE = False
Else
    GET_CONTROLLO_PEDANA_ORDINE = True
End If


rs.CloseResultset
Set rs = Nothing
End Function

Private Function GET_FORMULA_EAN_128(NomeCampo As String, Altezza As String) As String
Dim Testo As String
Dim Campo_Per_Report As String

Select Case NomeCampo
    Case "Codifica_EAN128_1"
        'Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Descrizione_EAN128_1}"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_1}"
    Case "Codifica_EAN128_2"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_2}"
    Case "Codifica_EAN128_3"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_3}"
    Case "Codifica_EAN128_4"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_4}"
    Case "Codifica_EAN128_5"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_5}"
    Case "Codifica_EAN128_6"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_6}"
    Case "Codifica_EAN128_7"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_7}"
    Case "Codifica_EAN128_8"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_8}"
    Case "Codifica_EAN128_9"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_9}"
    Case "Codifica_EAN128_10"
        Campo_Per_Report = "{RV_POTMPStampaEtichetteRighe.Codifica_EAN128_10}"
End Select

Testo = ""
Testo = Testo & "Dim DataToEncode As String" & vbCrLf
Testo = Testo & "Dim BarHeight As Number" & vbCrLf
Testo = Testo & "Dim ApplyTilde As Boolean" & vbCrLf

Testo = Testo & "'Modify the next line to connect to the data source:" & vbCrLf
Testo = Testo & "DataToEncode = Replace(" & Campo_Per_Report & "," & Chr(34) & ")" & Chr(34) & "," & Chr(34) & Chr(34) & ")" & vbCrLf
Testo = Testo & "DataToEncode = Replace(DataToEncode," & Chr(34) & "(" & Chr(34) & "," & Chr(34) & Chr(34) & ")" & vbCrLf

Testo = Testo & "'Modify the next line to change the barcode height:" & vbCrLf
Testo = Testo & "BarHeight = " & Altezza - 9 & vbCrLf

Testo = Testo & "'Modify the next line to disable special processing of the Tilde:" & vbCrLf
Testo = Testo & "ApplyTilde = True" & vbCrLf
Testo = Testo & "'Change MonoSpaceFont to equal False when not using a mono-spaced font" & vbCrLf
Testo = Testo & "'such as Courier New. Barcodes may not be completely accurate when using" & vbCrLf
Testo = Testo & "'proportional fonts." & vbCrLf
Testo = Testo & "Dim MonoSpaceFont As Boolean" & vbCrLf
Testo = Testo & "MonoSpaceFont = True" & vbCrLf
Testo = Testo & "Dim DataToPrint As String" & vbCrLf
Testo = Testo & "Dim WeightedTotal As Number" & vbCrLf
Testo = Testo & "Dim SymbolString As String" & vbCrLf
Testo = Testo & "Dim StringLength As Number" & vbCrLf
Testo = Testo & "StringLength = Len(DataToEncode)" & vbCrLf
Testo = Testo & "Dim CurrentCharNum As Number" & vbCrLf
Testo = Testo & "Dim CurrentValue As Number" & vbCrLf
Testo = Testo & "Dim WeightValue As Number" & vbCrLf
Testo = Testo & "Dim NumCharsTaken As Number" & vbCrLf
Testo = Testo & "Dim CheckDigitValue As Number" & vbCrLf
Testo = Testo & "Dim PrintableString As String" & vbCrLf
Testo = Testo & "Dim Factor As Number" & vbCrLf
Testo = Testo & "Dim I As Number" & vbCrLf
Testo = Testo & "Dim J As Number" & vbCrLf
Testo = Testo & "Dim CorrectFNC As Number" & vbCrLf
Testo = Testo & "Dim nwPattern As String" & vbCrLf
Testo = Testo & "Dim OnlyCorrectData As String" & vbCrLf
Testo = Testo & "Dim OnlyNumberData As String" & vbCrLf
Testo = Testo & "Dim OnlyNumberDataRev As String" & vbCrLf
Testo = Testo & "Dim DataToFormat As String" & vbCrLf
Testo = Testo & "Dim C128Start As String" & vbCrLf

Testo = Testo & "PrintableString = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "Formula = " & Chr(34) & Chr(34) & vbCrLf

Testo = Testo & "Dim ArrayBase As Number" & vbCrLf
Testo = Testo & "Dim CurrentChar As String" & vbCrLf
Testo = Testo & "ArrayBase = 1 'Array Base is 1 in Crystal Reports and 0 in Microsoft VB" & vbCrLf
Testo = Testo & "Dim CurrentEncoding As String" & vbCrLf

Testo = Testo & "CurrentEncoding = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "DataToPrint = " & Chr(34) & Chr(34) & vbCrLf

Testo = Testo & "CorrectFNC = 0" & vbCrLf
Testo = Testo & "'in case ApplyTilde is null, set it to false" & vbCrLf
Testo = Testo & "If ApplyTilde <> True Then ApplyTilde = False" & vbCrLf
Testo = Testo & "PrintableString = " & Chr(34) & Chr(34) & vbCrLf

Testo = Testo & "'ApplyTilde ~???" & vbCrLf
Testo = Testo & "If ApplyTilde Then" & vbCrLf
Testo = Testo & "    OnlyCorrectData = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "StringLength = Len(DataToEncode)" & vbCrLf
Testo = Testo & "     For I = 1 To StringLength" & vbCrLf
Testo = Testo & "        If (I < StringLength - 2) And Mid(DataToEncode, I, 1) =" & Chr(34) & "~" & Chr(34) & " And IsNumeric(Mid(DataToEncode, I + 1, 3)) Then" & vbCrLf
Testo = Testo & "            CurrentCharNum = Val(Mid(DataToEncode, I + 1, 3))" & vbCrLf
Testo = Testo & "            OnlyCorrectData = OnlyCorrectData & ChrW(CurrentCharNum)" & vbCrLf
Testo = Testo & "            I = I + 3" & vbCrLf
Testo = Testo & "        Else" & vbCrLf
Testo = Testo & "           OnlyCorrectData = OnlyCorrectData & Mid(DataToEncode, I, 1)" & vbCrLf
Testo = Testo & "        End If" & vbCrLf
Testo = Testo & "    Next I" & vbCrLf
Testo = Testo & "    DataToEncode = OnlyCorrectData" & vbCrLf
Testo = Testo & "End If" & vbCrLf
Testo = Testo & "'ApplyTilde ~m??" & vbCrLf
Testo = Testo & "If ApplyTilde Then" & vbCrLf
Testo = Testo & "    OnlyCorrectData = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "    StringLength = Len(DataToEncode)" & vbCrLf
Testo = Testo & "    For I = 1 To StringLength" & vbCrLf
Testo = Testo & "        If (I < StringLength - 2) And Mid(DataToEncode, I, 2) =" & Chr(34) & "~m" & Chr(34) & " And IsNumeric(Mid(DataToEncode, I + 2, 2)) Then" & vbCrLf
Testo = Testo & "            WeightValue = Val(Mid(DataToEncode, I + 2, 2))" & vbCrLf
Testo = Testo & "            If (I - WeightValue) < 1 Then WeightValue = I - 1" & vbCrLf
Testo = Testo & "            'Modifications for MOD10 calculations" & vbCrLf
Testo = Testo & "            OnlyNumberData = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "            OnlyNumberDataRev = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "              'Ensure only numbers are included in the MOD10 calculation" & vbCrLf
Testo = Testo & "              For J = I - 1 To 1 Step -1" & vbCrLf
Testo = Testo & "                 'Add all numbers to OnlyNumberData string" & vbCrLf
Testo = Testo & "                 If IsNumeric(Mid(DataToEncode, J, 1)) = True Then" & vbCrLf
Testo = Testo & "                     OnlyNumberDataRev = OnlyNumberDataRev & Mid(DataToEncode, J, 1)" & vbCrLf
Testo = Testo & "                     NumCharsTaken = NumCharsTaken + 1" & vbCrLf
Testo = Testo & "                 End If" & vbCrLf
Testo = Testo & "                 If NumCharsTaken = WeightValue Then" & vbCrLf
Testo = Testo & "                     Exit For" & vbCrLf
Testo = Testo & "                 End If" & vbCrLf
Testo = Testo & "              Next J" & vbCrLf
Testo = Testo & "              'String is backwards, needs to be reversed" & vbCrLf
Testo = Testo & "              OnlyNumberData = StrReverse(OnlyNumberDataRev)" & vbCrLf
Testo = Testo & "              Factor = 3" & vbCrLf
Testo = Testo & "              WeightedTotal = 0" & vbCrLf
Testo = Testo & "              For J = Len(OnlyNumberData) To 1 Step -1" & vbCrLf
Testo = Testo & "                   CurrentCharNum = Val(Mid(OnlyNumberData, J, 1))" & vbCrLf
Testo = Testo & "                   WeightedTotal = WeightedTotal + CurrentCharNum * Factor" & vbCrLf
Testo = Testo & "                   Factor = 4 - Factor" & vbCrLf
Testo = Testo & "              Next J" & vbCrLf
Testo = Testo & "              'Find the CheckDigit by finding the smallest number that = a multiple of 10" & vbCrLf
Testo = Testo & "              Factor = (WeightedTotal Mod 10)" & vbCrLf
Testo = Testo & "              If Factor <> 0 Then" & vbCrLf
Testo = Testo & "                   CheckDigitValue = (10 - Factor)" & vbCrLf
Testo = Testo & "              Else" & vbCrLf
Testo = Testo & "                   CheckDigitValue = 0" & vbCrLf
Testo = Testo & "              End If" & vbCrLf
Testo = Testo & "              'Add check digit" & vbCrLf
Testo = Testo & "              OnlyCorrectData = OnlyCorrectData & ChrW(CheckDigitValue + 48)" & vbCrLf
Testo = Testo & "              I = I + 3" & vbCrLf
Testo = Testo & "          Else" & vbCrLf
Testo = Testo & "             OnlyCorrectData = OnlyCorrectData & Mid(DataToEncode, I, 1)" & vbCrLf
Testo = Testo & "          End If" & vbCrLf
Testo = Testo & "      Next I" & vbCrLf
Testo = Testo & "      DataToEncode = OnlyCorrectData" & vbCrLf
Testo = Testo & "  End If" & vbCrLf
Testo = Testo & "  DataToFormat = DataToEncode" & vbCrLf
Testo = Testo & "  OnlyCorrectData = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "DataToEncode = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "DataToPrint = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "Dim SetC128(128) As String" & vbCrLf
Testo = Testo & "SetC128 = Array(" & " _" & vbCrLf
Testo = Testo & Chr(34) & "EFF" & Chr(34) & ","
Testo = Testo & Chr(34) & "FEF" & Chr(34) & ","
Testo = Testo & Chr(34) & "FFE" & Chr(34) & ","
Testo = Testo & Chr(34) & "BBG" & Chr(34) & ","
Testo = Testo & Chr(34) & "BCF" & Chr(34) & ","
Testo = Testo & Chr(34) & "CBF" & Chr(34) & ","
Testo = Testo & Chr(34) & "BFC" & Chr(34) & ","
Testo = Testo & Chr(34) & "BGB" & Chr(34) & ","
Testo = Testo & Chr(34) & "CFB" & Chr(34) & ","
Testo = Testo & Chr(34) & "FBC" & Chr(34) & ", _" & vbCrLf

Testo = Testo & Chr(34) & "FCB" & Chr(34) & ","
Testo = Testo & Chr(34) & "GBB" & Chr(34) & ","
Testo = Testo & Chr(34) & "AFJ" & Chr(34) & ","
Testo = Testo & Chr(34) & "BEJ" & Chr(34) & ","
Testo = Testo & Chr(34) & "BFI" & Chr(34) & ","
Testo = Testo & Chr(34) & "AJF" & Chr(34) & ","
Testo = Testo & Chr(34) & "BIF" & Chr(34) & ","
Testo = Testo & Chr(34) & "BJE" & Chr(34) & ","
Testo = Testo & Chr(34) & "FJA" & Chr(34) & ","
Testo = Testo & Chr(34) & "FAJ" & Chr(34) & ", _" & vbCrLf

Testo = Testo & Chr(34) & "FBI" & Chr(34) & ","
Testo = Testo & Chr(34) & "EJB" & Chr(34) & ","
Testo = Testo & Chr(34) & "FIB" & Chr(34) & ","
Testo = Testo & Chr(34) & "IEI" & Chr(34) & ","
Testo = Testo & Chr(34) & "IBF" & Chr(34) & ","
Testo = Testo & Chr(34) & "JAF" & Chr(34) & ","
Testo = Testo & Chr(34) & "JBE" & Chr(34) & ","
Testo = Testo & Chr(34) & "IFB" & Chr(34) & ","
Testo = Testo & Chr(34) & "JEB" & Chr(34) & ","
Testo = Testo & Chr(34) & "JFA" & Chr(34) & ", _" & vbCrLf

Testo = Testo & Chr(34) & "EEG" & Chr(34) & ","
Testo = Testo & Chr(34) & "EGE" & Chr(34) & ","
Testo = Testo & Chr(34) & "GEE" & Chr(34) & ","
Testo = Testo & Chr(34) & "ACG" & Chr(34) & ","
Testo = Testo & Chr(34) & "CAG" & Chr(34) & ","
Testo = Testo & Chr(34) & "CCE" & Chr(34) & ","
Testo = Testo & Chr(34) & "AGC" & Chr(34) & ","
Testo = Testo & Chr(34) & "CEC" & Chr(34) & ","
Testo = Testo & Chr(34) & "CGA" & Chr(34) & ","
Testo = Testo & Chr(34) & "ECC" & Chr(34) & ", _" & vbCrLf

Testo = Testo & Chr(34) & "GAC" & Chr(34) & ","
Testo = Testo & Chr(34) & "GCA" & Chr(34) & ","
Testo = Testo & Chr(34) & "AEK" & Chr(34) & ","
Testo = Testo & Chr(34) & "AGI" & Chr(34) & ","
Testo = Testo & Chr(34) & "CEI" & Chr(34) & ","
Testo = Testo & Chr(34) & "AIG" & Chr(34) & ","
Testo = Testo & Chr(34) & "AKE" & Chr(34) & ","
Testo = Testo & Chr(34) & "CIE" & Chr(34) & ","
Testo = Testo & Chr(34) & "IIE" & Chr(34) & ","
Testo = Testo & Chr(34) & "ECI" & Chr(34) & ", _" & vbCrLf


Testo = Testo & Chr(34) & "GAI" & Chr(34) & ","
Testo = Testo & Chr(34) & "EIC" & Chr(34) & ","
Testo = Testo & Chr(34) & "EKA" & Chr(34) & ","
Testo = Testo & Chr(34) & "EII" & Chr(34) & ","
Testo = Testo & Chr(34) & "IAG" & Chr(34) & ","
Testo = Testo & Chr(34) & "ICE" & Chr(34) & ","
Testo = Testo & Chr(34) & "KAE" & Chr(34) & ","
Testo = Testo & Chr(34) & "IEC" & Chr(34) & ","
Testo = Testo & Chr(34) & "IGA" & Chr(34) & ","
Testo = Testo & Chr(34) & "KEA" & Chr(34) & ", _" & vbCrLf

Testo = Testo & Chr(34) & "IMA" & Chr(34) & ","
Testo = Testo & Chr(34) & "FDA" & Chr(34) & ","
Testo = Testo & Chr(34) & "OAA" & Chr(34) & ","
Testo = Testo & Chr(34) & "ABH" & Chr(34) & ","
Testo = Testo & Chr(34) & "ADF" & Chr(34) & ","
Testo = Testo & Chr(34) & "BAH" & Chr(34) & ","
Testo = Testo & Chr(34) & "BDE" & Chr(34) & ","
Testo = Testo & Chr(34) & "DAF" & Chr(34) & ","
Testo = Testo & Chr(34) & "DBE" & Chr(34) & ","
Testo = Testo & Chr(34) & "AFD" & Chr(34) & ", _" & vbCrLf

Testo = Testo & Chr(34) & "AHB" & Chr(34) & ","
Testo = Testo & Chr(34) & "BED" & Chr(34) & ","
Testo = Testo & Chr(34) & "BHA" & Chr(34) & ","
Testo = Testo & Chr(34) & "DEB" & Chr(34) & ","
Testo = Testo & Chr(34) & "DFA" & Chr(34) & ","
Testo = Testo & Chr(34) & "HBA" & Chr(34) & ","
Testo = Testo & Chr(34) & "FAD" & Chr(34) & ","
Testo = Testo & Chr(34) & "MIA" & Chr(34) & ","
Testo = Testo & Chr(34) & "HAB" & Chr(34) & ","
Testo = Testo & Chr(34) & "CMA" & Chr(34) & ", _" & vbCrLf

Testo = Testo & Chr(34) & "ABN" & Chr(34) & ","
Testo = Testo & Chr(34) & "BAN" & Chr(34) & ","
Testo = Testo & Chr(34) & "BBM" & Chr(34) & ","
Testo = Testo & Chr(34) & "ANB" & Chr(34) & ","
Testo = Testo & Chr(34) & "BMB" & Chr(34) & ","
Testo = Testo & Chr(34) & "BNA" & Chr(34) & ","
Testo = Testo & Chr(34) & "MBB" & Chr(34) & ","
Testo = Testo & Chr(34) & "NAB" & Chr(34) & ","
Testo = Testo & Chr(34) & "NBA" & Chr(34) & ","
Testo = Testo & Chr(34) & "EEM" & Chr(34) & ", _" & vbCrLf

Testo = Testo & Chr(34) & "EME" & Chr(34) & ","
Testo = Testo & Chr(34) & "MEE" & Chr(34) & ","
Testo = Testo & Chr(34) & "AAO" & Chr(34) & ","
Testo = Testo & Chr(34) & "ACM" & Chr(34) & ","
Testo = Testo & Chr(34) & "CAM" & Chr(34) & ","
Testo = Testo & Chr(34) & "AMC" & Chr(34) & ","
Testo = Testo & Chr(34) & "AOA" & Chr(34) & ","
Testo = Testo & Chr(34) & "MAC" & Chr(34) & ","
Testo = Testo & Chr(34) & "MCA" & Chr(34) & ","
Testo = Testo & Chr(34) & "AIM" & Chr(34) & ", _" & vbCrLf

Testo = Testo & Chr(34) & "AMI" & Chr(34) & ","
Testo = Testo & Chr(34) & "IAM" & Chr(34) & ","
Testo = Testo & Chr(34) & "MAI" & Chr(34) & ","
Testo = Testo & Chr(34) & "EDB" & Chr(34) & ","
Testo = Testo & Chr(34) & "EBD" & Chr(34) & ","
Testo = Testo & Chr(34) & "EBJ" & Chr(34) & ")" & vbCrLf

Testo = Testo & "'Here we select character set A, B or C for the START character" & vbCrLf
Testo = Testo & "'Start A = " & Chr(34) & "EDB" & Chr(34) & vbCrLf
Testo = Testo & "'Start A = " & Chr(34) & "EBD" & Chr(34) & vbCrLf
Testo = Testo & "'Start A = " & Chr(34) & "EBJ" & Chr(34) & vbCrLf

Testo = Testo & "StringLength = Len(DataToFormat)" & vbCrLf
Testo = Testo & "CurrentCharNum = AscW(Mid(DataToFormat, 1, 1))" & vbCrLf
Testo = Testo & "'Set A?" & vbCrLf
Testo = Testo & "If CurrentCharNum < 32 Then C128Start = " & Chr(34) & "EDB" & Chr(34) & vbCrLf
Testo = Testo & "'Set B?" & vbCrLf
Testo = Testo & "If CurrentCharNum > 31 And CurrentCharNum < 127 Then C128Start = " & Chr(34) & "EBD" & Chr(34) & vbCrLf
Testo = Testo & "If CurrentCharNum = 197 Then C128Start = " & Chr(34) & "EBD" & Chr(34) & vbCrLf

Testo = Testo & "'Updated V5.08 by BDA" & vbCrLf
Testo = Testo & "'Set C?" & vbCrLf
Testo = Testo & "If ((StringLength > 3) And IsNumeric(Mid(DataToFormat, 1, 4))) Then C128Start = " & Chr(34) & "EBJ" & Chr(34) & vbCrLf

Testo = Testo & "'202 & 212-215 is for the FNC1, with this Start C is mandatory" & vbCrLf
Testo = Testo & "If CurrentCharNum = 202 Then C128Start = " & Chr(34) & "EBJ" & Chr(34) & vbCrLf
Testo = Testo & "If CurrentCharNum > 211 Then C128Start = " & Chr(34) & "EBJ" & Chr(34) & vbCrLf
Testo = Testo & "If C128Start = " & Chr(34) & "EDB" & Chr(34) & " Then CurrentEncoding = " & Chr(34) & "A" & Chr(34) & vbCrLf
Testo = Testo & "If C128Start = " & Chr(34) & "EBD" & Chr(34) & " Then CurrentEncoding = " & Chr(34) & "B" & Chr(34) & vbCrLf
Testo = Testo & "If C128Start = " & Chr(34) & "EBJ" & Chr(34) & " Then CurrentEncoding = " & Chr(34) & "C" & Chr(34) & vbCrLf
Testo = Testo & "For I = 1 To StringLength" & vbCrLf
Testo = Testo & "    CurrentCharNum = AscW(Mid(DataToFormat, I, 1))" & vbCrLf
Testo = Testo & "    'check for FNC1 in any set which is ASCII 202 and ASCII 212-219" & vbCrLf
Testo = Testo & "    If ((CurrentCharNum > 201) And (CurrentCharNum < 219)) Then" & vbCrLf
Testo = Testo & "        DataToEncode = DataToEncode & ChrW(202)" & vbCrLf
Testo = Testo & "    'check for switching to character set C" & vbCrLf
Testo = Testo & "    ElseIf CurrentCharNum = 197 Then" & vbCrLf
Testo = Testo & "        If CurrentEncoding = " & Chr(34) & "C" & Chr(34) & " Then 'switch to B" & vbCrLf
Testo = Testo & "            DataToEncode = DataToEncode & ChrW(200)" & vbCrLf
Testo = Testo & "            CurrentEncoding = " & Chr(34) & "B" & Chr(34) & vbCrLf
Testo = Testo & "        End If" & vbCrLf
Testo = Testo & "        DataToEncode = DataToEncode & ChrW(197)" & vbCrLf
Testo = Testo & "    ElseIf ((I < StringLength - 2) And (IsNumeric(Mid(DataToFormat, I, 1))) And (IsNumeric(Mid(DataToFormat, I + 1, 1))) And (IsNumeric(Mid(DataToFormat, I, 4)))) Or ((I < StringLength) And (IsNumeric(Mid(DataToFormat, I, 1))) And (IsNumeric(Mid(DataToFormat, I + 1, 1))) And (CurrentEncoding = " & Chr(34) & "C" & Chr(34) & ")) Then" & vbCrLf
Testo = Testo & "        'check to see if we have an odd number of numbers to encode," & vbCrLf
Testo = Testo & "        'if so, stay in current set and then switch to save space" & vbCrLf
Testo = Testo & "        If CurrentEncoding <> " & Chr(34) & "C" & Chr(34) & "Then" & vbCrLf
Testo = Testo & "            J = I" & vbCrLf
Testo = Testo & "            Factor = 3" & vbCrLf
Testo = Testo & "            Do While J <= StringLength And IsNumeric(Mid(DataToFormat, J, 1))" & vbCrLf
Testo = Testo & "                Factor = 4 - Factor" & vbCrLf
Testo = Testo & "                J = J + 1" & vbCrLf
Testo = Testo & "            Loop" & vbCrLf
Testo = Testo & "            If Factor = 1 Then" & vbCrLf
Testo = Testo & "                'if so stay in current set for 1 character to save space" & vbCrLf
Testo = Testo & "                DataToEncode = DataToEncode & ChrW(CurrentCharNum)" & vbCrLf
Testo = Testo & "                I = I + 1" & vbCrLf
Testo = Testo & "            End If" & vbCrLf
Testo = Testo & "        End If" & vbCrLf
Testo = Testo & "        'switch to set C if not already in it" & vbCrLf
Testo = Testo & "        If CurrentEncoding <> " & Chr(34) & "C" & Chr(34) & " Then DataToEncode = DataToEncode & ChrW(199)" & vbCrLf
Testo = Testo & "        CurrentEncoding = " & Chr(34) & "C" & Chr(34) & vbCrLf
Testo = Testo & "        CurrentChar = Mid(DataToFormat, I, 2)" & vbCrLf
Testo = Testo & "        CurrentValue = Val(CurrentChar)" & vbCrLf
Testo = Testo & "        'set the CurrentValue to the number of String CurrentChar" & vbCrLf
Testo = Testo & "        DataToEncode = DataToEncode & ChrW(CurrentValue + 32)" & vbCrLf
Testo = Testo & "        I = I + 1" & vbCrLf
Testo = Testo & "        'check for switching to character set A" & vbCrLf
Testo = Testo & "    ElseIf (I <= StringLength) And ((AscW(Mid(DataToFormat, I, 1)) < 31) Or ((CurrentEncoding = " & Chr(34) & "A" & Chr(34) & ") And (AscW(Mid(DataToFormat, I, 1)) > 32 And (AscW(Mid(DataToFormat, I, 1))) < 96))) Then" & vbCrLf
Testo = Testo & "        'switch to set A if not already in it" & vbCrLf
Testo = Testo & "        If CurrentEncoding <> " & Chr(34) & "A" & Chr(34) & " Then DataToEncode = DataToEncode & ChrW(201)" & vbCrLf
Testo = Testo & "        CurrentEncoding = " & Chr(34) & "A" & Chr(34) & vbCrLf
Testo = Testo & "        'Get the ASCII value of the next character" & vbCrLf
Testo = Testo & "        CurrentCharNum = AscW(Mid(DataToFormat, I, 1))" & vbCrLf
Testo = Testo & "        If CurrentCharNum < 32 Then" & vbCrLf
Testo = Testo & "            DataToEncode = DataToEncode & ChrW(CurrentCharNum + 96)" & vbCrLf
Testo = Testo & "        ElseIf CurrentCharNum > 32 Then" & vbCrLf
Testo = Testo & "            DataToEncode = DataToEncode & ChrW(CurrentCharNum)" & vbCrLf
Testo = Testo & "        End If" & vbCrLf
Testo = Testo & "    'check for switching to character set B" & vbCrLf
Testo = Testo & "    ElseIf (I <= StringLength) And (((AscW(Mid(DataToFormat, I, 1))) > 31) And ((AscW(Mid(DataToFormat, I, 1)))) < 127) Then" & vbCrLf
Testo = Testo & "         'switch to set B if not already in it" & vbCrLf
Testo = Testo & "        If CurrentEncoding <> " & Chr(34) & "B" & Chr(34) & " Then DataToEncode = DataToEncode & ChrW(200)" & vbCrLf
Testo = Testo & "        CurrentEncoding = " & Chr(34) & "B" & Chr(34) & vbCrLf
Testo = Testo & "        'Get the ASCII value of the next character" & vbCrLf
Testo = Testo & "        CurrentCharNum = AscW(Mid(DataToFormat, I, 1))" & vbCrLf
Testo = Testo & "        DataToEncode = DataToEncode & ChrW(CurrentCharNum)" & vbCrLf
Testo = Testo & "    End If" & vbCrLf
Testo = Testo & "Next I" & vbCrLf

Testo = Testo & "'<<< Calculate Modulo 103 Check Digit >>>" & vbCrLf
Testo = Testo & "If C128Start = " & Chr(34) & "EDB" & Chr(34) & " Then WeightedTotal = 103 'CurrentEncoding = " & Chr(34) & "A" & Chr(34) & vbCrLf
Testo = Testo & "If C128Start = " & Chr(34) & "EBD" & Chr(34) & " Then WeightedTotal = 104 'CurrentEncoding = " & Chr(34) & "B" & Chr(34) & vbCrLf
Testo = Testo & "If C128Start = " & Chr(34) & "EBJ" & Chr(34) & " Then WeightedTotal = 105 'CurrentEncoding = " & Chr(34) & "C" & Chr(34) & vbCrLf
Testo = Testo & "StringLength = Len(DataToEncode)" & vbCrLf
Testo = Testo & "For I = 1 To StringLength" & vbCrLf
Testo = Testo & "    CurrentCharNum = AscW(Mid(DataToEncode, I, 1))" & vbCrLf
Testo = Testo & "    If CurrentCharNum < 135 Then CurrentValue = CurrentCharNum - 32" & vbCrLf
Testo = Testo & "    If CurrentCharNum > 134 Then CurrentValue = CurrentCharNum - 100" & vbCrLf
Testo = Testo & "    If CurrentCharNum = 194 Then CurrentValue = 0" & vbCrLf
Testo = Testo & "    PrintableString = PrintableString & SetC128(CurrentValue + ArrayBase)" & vbCrLf
Testo = Testo & "    CurrentValue = CurrentValue * I" & vbCrLf
Testo = Testo & "    WeightedTotal = WeightedTotal + CurrentValue" & vbCrLf
Testo = Testo & "Next I" & vbCrLf
Testo = Testo & "CheckDigitValue = (WeightedTotal Mod 103)" & vbCrLf
Testo = Testo & "DataToEncode =" & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "'GIAH produces the stop character." & vbCrLf
Testo = Testo & "DataToPrint = C128Start & PrintableString & SetC128(CheckDigitValue + ArrayBase)" & " & " & Chr(34) & "GIAH" & Chr(34) & vbCrLf
Testo = Testo & "'Universal to SymbolString conversion" & vbCrLf
Testo = Testo & "'At this point in the code, DataToPrint is the entire barcode string for the Universal Font" & vbCrLf
Testo = Testo & "SymbolString = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "StringLength = Len(DataToPrint)" & vbCrLf
Testo = Testo & "For I = 1 To StringLength" & vbCrLf
Testo = Testo & "    'Get the value of each" & vbCrLf
Testo = Testo & "    CurrentCharNum = AscW(Mid(DataToPrint, I, 1))" & vbCrLf
Testo = Testo & "    If CurrentCharNum >= 65 And CurrentCharNum <= 68 Then SymbolString = SymbolString & Cstr((11+(CurrentCharNum - 65)),0," & Chr(34) & Chr(34) & ")" & vbCrLf
Testo = Testo & "    If CurrentCharNum >= 69 And CurrentCharNum <= 72 Then SymbolString = SymbolString & Cstr((21+(CurrentCharNum - 69)),0," & Chr(34) & Chr(34) & ")" & vbCrLf
Testo = Testo & "    If CurrentCharNum >= 73 And CurrentCharNum <= 76 Then SymbolString = SymbolString & Cstr((31+(CurrentCharNum - 73)),0," & Chr(34) & Chr(34) & ")" & vbCrLf
Testo = Testo & "    If CurrentCharNum >= 77 And CurrentCharNum <= 80 Then SymbolString = SymbolString & Cstr((41+(CurrentCharNum - 77)),0," & Chr(34) & Chr(34) & ")" & vbCrLf
Testo = Testo & "    If CurrentCharNum >= 87 And CurrentCharNum <= 88 Then SymbolString = SymbolString & Cstr((11+(CurrentCharNum - 87)),0," & Chr(34) & Chr(34) & ")" & vbCrLf
Testo = Testo & "    If CurrentCharNum >= 89 And CurrentCharNum <= 90 Then SymbolString = SymbolString & Cstr((21+(CurrentCharNum - 89)),0," & Chr(34) & Chr(34) & ")" & vbCrLf
Testo = Testo & "Next I" & vbCrLf
Testo = Testo & "'SymbolString to Native Conversion" & vbCrLf
Testo = Testo & "'At this point in the code, SymbolString is the entire barcode string in number form" & vbCrLf
Testo = Testo & "'For example: 211214142112214121221114311321211232" & vbCrLf
Testo = Testo & "'Convert SymbolString to PrintableString" & vbCrLf
Testo = Testo & "Dim ww As String" & vbCrLf
Testo = Testo & "Dim wb As String" & vbCrLf
Testo = Testo & "Dim bw As String" & vbCrLf
Testo = Testo & "Dim bb As String" & vbCrLf
Testo = Testo & "ww = ChrW(32) 'SPACE" & vbCrLf
Testo = Testo & "If MonoSpaceFont = False Then ww = ChrW(32) & ChrW(32) & ChrW(32)" & vbCrLf
Testo = Testo & "wb = ChrW(9616)" & vbCrLf
Testo = Testo & "bw = ChrW(9612)" & vbCrLf
Testo = Testo & "bb = ChrW(9608)" & vbCrLf
Testo = Testo & "CurrentValue = 0" & vbCrLf
Testo = Testo & "PrintableString = " & Chr(34) & Chr(34) & vbCrLf
Testo = Testo & "Dim NextDigitUsed As Number" & vbCrLf
Testo = Testo & "Dim StartOver As Number" & vbCrLf
Testo = Testo & "NextDigitUsed = 0" & vbCrLf
Testo = Testo & "Factor = 3" & vbCrLf
Testo = Testo & "Dim SymbolStringLength" & vbCrLf
Testo = Testo & "SymbolStringLength = Len(SymbolString) - 1" & vbCrLf
Testo = Testo & "For I = 1 To SymbolStringLength" & vbCrLf
Testo = Testo & "    CurrentValue = Val(Mid(SymbolString, I, 1))" & vbCrLf
Testo = Testo & "    If NextDigitUsed = 1 Then" & vbCrLf
Testo = Testo & "        'Because the next digit is used, remove 1 from CurrentValue" & vbCrLf
Testo = Testo & "        'unless CurrentValue is already 1" & vbCrLf
Testo = Testo & "        If CurrentValue > 1 Then" & vbCrLf
Testo = Testo & "            CurrentValue = CurrentValue - 1" & vbCrLf
Testo = Testo & "            NextDigitUsed = 0" & vbCrLf
Testo = Testo & "        Else" & vbCrLf
Testo = Testo & "            'CurrentValue was used in a previous step" & vbCrLf
Testo = Testo & "            NextDigitUsed = 1" & vbCrLf
Testo = Testo & "        End If" & vbCrLf
Testo = Testo & "    End If" & vbCrLf
Testo = Testo & "    If NextDigitUsed = 1 And CurrentValue = 1 Then" & vbCrLf
Testo = Testo & "        'There is nothing more here to do because the CurrentValue" & vbCrLf
Testo = Testo & "        'was used in a previous step" & vbCrLf
Testo = Testo & "        NextDigitUsed = 0" & vbCrLf
Testo = Testo & "    Else" & vbCrLf
Testo = Testo & "        For J = 1 To CurrentValue" & vbCrLf
Testo = Testo & "            If J = CurrentValue Then" & vbCrLf
Testo = Testo & "                NextDigitUsed = 1" & vbCrLf
Testo = Testo & "                'We are at the end of the bar segment, borrow 1 segment from the next" & vbCrLf
Testo = Testo & "                If Factor = 3 Then PrintableString = PrintableString & bw" & vbCrLf
Testo = Testo & "                If Factor = 1 Then PrintableString = PrintableString & wb" & vbCrLf
Testo = Testo & "            Else" & vbCrLf
Testo = Testo & "                NextDigitUsed = 0" & vbCrLf
Testo = Testo & "                If Factor = 3 Then PrintableString = PrintableString & bb" & vbCrLf
Testo = Testo & "                If Factor = 1 Then PrintableString = PrintableString & ww" & vbCrLf
Testo = Testo & "                J = J + 1" & vbCrLf
Testo = Testo & "            End If" & vbCrLf
Testo = Testo & "        Next J" & vbCrLf
Testo = Testo & "    End If" & vbCrLf
Testo = Testo & "    Factor = 4 - Factor" & vbCrLf
Testo = Testo & "Next I" & vbCrLf
Testo = Testo & "For I = 1 To BarHeight" & vbCrLf
Testo = Testo & "    Formula = Formula & ChrW(10) & ChrW(13) & PrintableString" & vbCrLf
Testo = Testo & "Next I" & vbCrLf
Testo = Testo & "'Note: DataToPrint returns the string for the Universal Font" & vbCrLf
Testo = Testo & "'and SymbolString returns the symbology string." & vbCrLf
Testo = Testo & "'Formula = DataToPrint" & vbCrLf


GET_FORMULA_EAN_128 = Testo
'Me.Text1.Text = Testo
End Function
Private Function GET_REPORT_EAN_128(IDEtichetta As Long) As Boolean
Dim sSQL As String
Dim rs As ADODB.Recordset

sSQL = "SELECT * FROM RV_POConfigurazioneEtichettaRighe "
sSQL = sSQL & "WHERE IDRV_POConfigurazioneEtichetta=" & IDEtichetta
sSQL = sSQL & " AND IDRV_POTipoElementoEtichetta = 8"

Set rs = New ADODB.Recordset

rs.Open sSQL, Cn.InternalConnection

If rs.EOF Then
    GET_REPORT_EAN_128 = False
Else
    GET_REPORT_EAN_128 = True
End If

rs.Close
Set rs = Nothing
End Function
Private Sub GET_DUPLICA_RIGA(IDLavorazione As Long)
On Error GoTo ERR_GET_DUPLICA_RIGA
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

COPIA_RIGA_COME_NUOVO = 1

sSQL = "SELECT * FROM RV_POAssegnazioneMerce "
sSQL = sSQL & " WHERE IDRV_POAssegnazioneMerce=" & IDLavorazione


Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
        'Me.txtIDPedana.Value = fnNotNullN(rs("IDRV_POPedana").Value)
        'Me.txtCodicePedana.Text = fnNotNull(rs("CodicePedana").Value)
        Me.CDTipoPedana.Load GET_TIPO_PEDANA(fnNotNullN(rs("IDRV_POPedana").Value))
        Me.txtPesoPedana.Value = GET_PESO_PEDANA(fnNotNullN(rs("IDRV_POPedana").Value), Me.CDTipoPedana.KeyFieldID)
        Link_TipoProdotto = GET_TIPO_PRODOTTO_ARTICOLO(fnNotNullN(rs("IDArticolo").Value))
        Me.CDArticolo.Load fnNotNullN(rs("IDArticolo").Value)
        Me.TxtArticolo.Text = fnNotNull(rs("Articolo").Value)
        Me.cboUM.WriteOn IIf(IsNull(rs("IDUnitaDiMisura").Value), 0, rs("IDUnitaDiMisura").Value)
        Link_UnitaDiMisura_Coop = fnNotNullN(rs("IDUnitaDiMisuraCoop").Value)
        Me.CDCodiceImballo.Load fnNotNullN(rs("IDImballoVendita").Value)
        Me.txtImballo.Text = fnNotNull(rs("ImballoVendita").Value)
        Me.txtTaraUnitaria.Value = fnNotNullN(rs("TaraUnitaria").Value)
        Me.CDImballoPrimario.Load fnNotNullN(rs!IDArticoloImballoPrimario)
        Me.txtNumeroConfImballo.Value = fnNotNullN(rs!NumeroConfezioniPerImballo)
        Me.txtTaraConfImballo.Value = fnNotNullN(rs!TaraConfezioneImballo)
        
        Me.CboTipoLavorazione.WriteOn fnNotNullN(rs("IDTipoLavorazione").Value)
        Me.cboTipoCategoria.WriteOn fnNotNullN(rs("IDRV_POTipoCategoria").Value)
        Me.cboCalibro.WriteOn fnNotNullN(rs("IDRV_POCalibro").Value)
        Me.cboLinguaPred.WriteOn fnNotNullN(rs("IDLinguaPredefinita").Value)
        
        
        
        
        'Link_Movimento_Carico = fnNotNull(rs("IDMovimento_carico").Value)
        'Link_Movimento_Scarico = fnNotNull(rs("IDMovimento_vendita").Value)
        
        'Me.cdCliente.Load fnNotNullN(rs("IDCliente").Value)
        Me.txtIDOrdineCliente.Value = fnNotNullN(rs("IDOggettoOrdine").Value)
        'Me.txtNumeroOrdine.Value = fnNotNullN(rs("NumeroOrdine").Value)
        'Me.txtDataOrdine.Value = fnNotNullN(rs("DataOrdine").Value)
        'Me.cboLinguaCliente.WriteOn fnNotNullN(rs("IDLinguaCliente").Value)
        'Me.txtCodicePedanaCliente.Value = fnNotNullN(rs("NumeroPedanaCliente").Value)
        'Me.txtCodificaCodicePedanaCliente.Text = fnNotNull(rs("CodicePedanaCliente").Value)
        
        
        'Me.txtLottoVendita.Text = fnNotNull(rs("CodiceLottoVendita").Value)
        'Me.txtLottoCliente.Text = fnNotNull(rs("LottoCliente").Value)
        'Me.txtAltreAnnotazioniCliente.Text = fnNotNull(rs("AltreAnnotazioniPerCliente").Value)
        
        Me.cboUtente.WriteOn fnNotNullN(rs("IDUtente").Value)
        Me.txtCodicePostazione.Text = fnNotNull(rs("CodiceUtente").Value)
    
        'Me.txtCodicePedanaCliente.Value = fnNotNullN(rs("NumeroPedanaCliente").Value)
        'Me.chkPrezzoInclusoImballo.Value = Abs(fnNotNullN(rs("MerceInclusoImballo").Value))
        Me.txtNomeMacchina.Text = rs("UtentePC").Value
        Me.txtUtenteMacchina.Text = rs("NomePC").Value

        'Me.txtCodiceGSICliente.Text = fnNotNull(rs("CodiceGSI").Value)
        ''Me.txtCodiceAssociatoPressoCliente.Text = fnNotNull(rs("CodiceAssociatoPressoCliente").Value)
        'Me.txtCodificaArticoloCodiceABarre.Text = fnNotNull(rs("CodiceABarreArticoloCliente").Value)
        
        'Me.txtCodiceABarreArticoloCliente.Text = fnNotNull(rs("DescrizioneCodiceABarreArticoloCliente").Value)
        'Me.txtCodificaImballoCodiceABarre.Text = fnNotNull(rs("CodiceABarreImballoCliente").Value)
        'Me.txtCodiceABarreImballoCliente.Text = fnNotNull(rs("DescrizioneCodiceABarreImballoCliente").Value)
        'Me.txtArticoloInLinguaPred.Text = fnNotNull(rs("DescrizioneArticoloInLinguaPred").Value)
        'Me.txtCalibroInLiguaPred.Text = fnNotNull(rs("DescrizioneCalibroInLinguaPred").Value)
        'Me.txtCategoriaInLinguaPred.Text = fnNotNull(rs("DescrizioneCategoriaInLinguaPred").Value)
        'Me.txtDescrizioneArticoloInLinguaCliente.Text = fnNotNull(rs("DescrizioneArticoloInLinguaCliente").Value)
        'Me.txtCalibroInLingua.Text = fnNotNull(rs("DescrizioneCalibroInLinguaCliente").Value)
        'Me.txtCategoriaInLingua.Text = fnNotNull(rs("DescrizioneCategoriaInLinguaCliente").Value)
        'Me.txtOraLav.Text = fnNotNull(rs("OraLavorazione").Value)
        
        Me.txtIDRigaOrdine.Value = fnNotNullN(rs!IDValoriOggettoDettaglioRigaOrd)
        
        ''''QUI I VALORI DEI PESI'''''''''''''''''''''''''''''''''''''''''''''''''''''''
        QUANTITA_PER_COLLO = fnNotNullN(rs!QuantitaPerCollo)
        PESO_LORDO_ARTICOLO = fnNotNullN(rs!PesoPerCollo)
        MOLTIPLICATORE = fnNotNullN(rs!MoltiplicatorePerCollo)
        
        Me.txtColli.Value = fnNotNullN(rs("Colli").Value)
        Me.txtPesoLordo.Value = fnNotNullN(rs("PesoLordo").Value)
        Me.txtTara.Value = fnNotNullN(rs("Tara").Value)
        Me.txtPesoNetto.Value = fnNotNullN(rs("PesoNetto").Value)
        Me.txtPezzi.Value = fnNotNullN(rs("Pezzi").Value)
        Me.txtQta_UM.Value = fnNotNullN(rs("Qta_UM").Value)
        Me.txtRaggrOrd.Text = fnNotNull(rs("NotaRigaOrdRaggr").Value)
End If


rs.CloseResultset
Set rs = Nothing

COPIA_RIGA_COME_NUOVO = 0

Exit Sub
ERR_GET_DUPLICA_RIGA:
    COPIA_RIGA_COME_NUOVO = 0
    MsgBox Err.Description, vbCritical, "GET_DUPLICA_RIGA"

End Sub
Private Function GET_NUMERO_PEDANE_LAVORATE(IDRigaConferimento As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_NUMERO_PEDANE_LAVORATE = 0

sSQL = "SELECT IDRV_POPedana "
sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaConferimento
sSQL = sSQL & " GROUP BY IDRV_POPedana"

Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    GET_NUMERO_PEDANE_LAVORATE = GET_NUMERO_PEDANE_LAVORATE + 1
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_TOTALI_COLLI_LAV(IDRigaConferimento As Long) As Double
Dim sSQL As String
Dim rsArt As DmtOleDbLib.adoResultset
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT SUM(Colli) as NumeroColli "
sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaConferimento

Set rs = Cn.OpenResultset(sSQL)
    
If rs.EOF Then
    GET_TOTALI_COLLI_LAV = 0
Else
    GET_TOTALI_COLLI_LAV = fnNotNullN(rs!NumeroColli)
End If

rs.CloseResultset
Set rs = Nothing
    
End Function

Private Function GET_LINK_ARTICOLO_TIPO_PEDANA(IDTipoPedana As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDArticoloImballo "
sSQL = sSQL & "FROM RV_POTipoPedana "
sSQL = sSQL & "WHERE IDRV_POTipoPedana=" & IDTipoPedana
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_ARTICOLO_TIPO_PEDANA = 0
Else
    GET_LINK_ARTICOLO_TIPO_PEDANA = fnNotNullN(rs!IDArticoloImballo)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_PREPARAZIONE_RIGA_CONFERIMENTO_AUTOMATICO(IDRigaConferimento As Long)
On Error GoTo ERR_GET_PREPARAZIONE_RIGA_CONFERIMENTO_AUTOMATICO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim PesoLordo As Double
Dim Tara As Double

sSQL = "SELECT * FROM RV_POCaricoMerceRighe "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaConferimento


Set rs = Cn.OpenResultset(sSQL)


If Not rs.EOF Then
    cmdNuovo_Click
    'cmdNuovaPedana_Click
    Me.CDArticolo.Load fnNotNullN(rs!IDArticolo)
    Me.CDCodiceImballo.Load fnNotNullN(rs!IDImballo)
    Me.txtTaraUnitaria.Value = fnNotNullN(rs!TaraUnitaria) ' / fnNotNullN(rs!Colli)
    
    If fnNotNullN(rs!IDArticoloPedana) > 0 Then
        Me.CDTipoPedana.Load GET_LINK_PEDANA_DA_ARTICOLO(fnNotNullN(rs!IDArticoloPedana))
        Me.txtPesoPedana.Value = fnNotNullN(rs!TaraPedana)
    End If
    
    Me.txtColli.Value = fnNotNullN(rs!Colli)
    'Me.txtPesoLordo.Value = fnNotNullN(rs!PesoLordo)
    PesoLordo = fnNotNullN(rs!PesoLordo) - (fnNotNullN(rs!TaraPedana) * fnNotNullN(rs!QuantitaPedana))
    

    If (TIPO_PESO_ARTICOLO <= 1) Then
        PESO_LORDO_ARTICOLO = PesoLordo / fnNotNullN(rs!Colli)
        Me.txtPesoLordo.Value = Me.txtColli.Value * PESO_LORDO_ARTICOLO
    Else
        
        PESO_LORDO_ARTICOLO = (PesoLordo - (fnNotNullN(rs!Colli) * fnNotNullN(rs!TaraUnitaria))) / fnNotNullN(rs!Colli)
        Me.txtPesoNetto.Value = Me.txtColli.Value * PESO_LORDO_ARTICOLO
    End If
    
    If fnNotNullN(rs!Pezzi) > 0 Then
        QUANTITA_PER_COLLO = fnNotNullN(rs!Pezzi) / fnNotNullN(rs!Colli)
    End If
    
    Me.txtTara.Value = fnNotNullN(rs!TaraUnitaria) * fnNotNullN(rs!Colli)
    
    'Me.txtPesoLordo.Value = fnNotNullN(rs!PesoLordo) - (fnNotNullN(rs!TaraPedana) * fnNotNullN(rs!QuantitaPedana))
    'Me.txtTara.Value = fnNotNullN(rs!TaraUnitaria) * fnNotNullN(rs!Colli)
    

    'Me.txtPesoNetto.Value = fnNotNullN(rs!PesoLordo)
    'Me.txtPesoNetto.Value = Me.txtPesoLordo.Value - Me.txtTara.Value
    Me.txtPezzi.Value = fnNotNullN(rs!Pezzi)
    
    CalcoloPesoNetto
    
    Select Case Link_UnitaDiMisura_Coop
        Case 1
            Me.txtQta_UM.Value = Me.txtColli.Value
        Case 2
            Me.txtQta_UM.Value = Me.txtPesoLordo.Value
        Case 3
            Me.txtQta_UM.Value = Me.txtPesoNetto.Value
        Case 4
            Me.txtQta_UM.Value = Me.txtTara.Value
        Case 5
            Me.txtQta_UM.Value = Me.txtPezzi.Value
    End Select
    
'    If fnNotNullN(rs!IDOggettoOrdine) > 0 Then
'        Me.txtIDOrdineCliente.Value = fnNotNullN(rs!IDOggettoOrdine)
'    End If
    
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_PREPARAZIONE_RIGA_CONFERIMENTO_AUTOMATICO:
    MsgBox Err.Description, vbCritical, "GET_PREPARAZIONE_RIGA_CONFERIMENTO_AUTOMATICO"
End Function
Private Sub ParametroPedanaAutomatica()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT PedanaAutomatica FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    PEDANA_AUTOMATICA = fnNotNullN(rs!PedanaAutomatica)
Else
    PEDANA_AUTOMATICA = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub ParametroOrdineAutomatico()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT OrdineAutomatico FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    ORDINE_AUTOMATICO = fnNotNullN(rs!OrdineAutomatico)
Else
    ORDINE_AUTOMATICO = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub

Private Function GET_PREZZO_IMBALLO_INCLUSO(IDArticoloImballo As Long, IDCliente As Long) As Long
On Error GoTo ERR_GET_PREZZO_IMBALLO_INCLUSO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsCli As DmtOleDbLib.adoResultset


sSQL = "SELECT PrezzoInclusoImballo "
sSQL = sSQL & "FROM RV_POConfigurazioneClienteImb "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDCliente
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo


Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    sSQL = "SELECT PrezzoInclusoImballo "
    sSQL = sSQL & "FROM RV_POConfigurazioneCliente "
    sSQL = sSQL & "WHERE IDAnagrafica=" & IDCliente
    sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
    'sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
    
    Set rsCli = Cn.OpenResultset(sSQL)
    
    If rsCli.EOF Then
        GET_PREZZO_IMBALLO_INCLUSO = 0
    Else
        GET_PREZZO_IMBALLO_INCLUSO = fnNotNullN(rsCli!PrezzoInclusoImballo)
    End If
    
    rsCli.CloseResultset
    Set rsCli = Nothing
    
Else
    GET_PREZZO_IMBALLO_INCLUSO = fnNotNullN(rs!PrezzoInclusoImballo)
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_PREZZO_IMBALLO_INCLUSO:
MsgBox Err.Description, vbCritical, "ERR_GET_PREZZO_IMBALLO_INCLUSO"
End Function
Private Function GET_PESO_PEDANA(IDPedana As Long, IDTipoPedana As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT * FROM RV_PORepPedana "
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDRV_POPedana=" & IDPedana

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_PESO_PEDANA = 0
Else
    If IDTipoPedana <> fnNotNullN(rs!IDRV_POTipoPedana) Then
        GET_PESO_PEDANA = 0
    Else
        GET_PESO_PEDANA = fnNotNullN(rs!PesoPedana)
    End If
End If

rs.CloseResultset
Set rs = Nothing

If GET_PESO_PEDANA > 0 Then Exit Function

sSQL = "SELECT * FROM RV_PORepTipoPedana "
sSQL = sSQL & "WHERE IDRV_POTipoPedana=" & IDTipoPedana
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_PESO_PEDANA = 0
Else
    GET_PESO_PEDANA = fnNotNullN(rs!Tara)
    If fnNotNullN(rs!NumeroPallet) > 1 Then
        GET_PESO_PEDANA = GET_PESO_PEDANA * fnNotNullN(rs!NumeroPallet)
    End If
End If

rs.CloseResultset
Set rs = Nothing

End Function
Private Sub ParametroAndamentoOrdine()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT VisAndamentoOrdDaLav FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    VISUALIZZA_ANDAMENTO_ORDINE = fnNotNullN(rs!VisAndamentoOrdDaLav)
Else
    VISUALIZZA_ANDAMENTO_ORDINE = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub GET_ANDAMENTO_ORDINE(IDOrdine As Long)
On Error GoTo ERR_GET_ANDAMENTO_ORDINE
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim NumeroPedaneOrdinate As Double
Dim NumeroColliOrdinati As Double

Dim NumeroPedaneLavorate As Double
Dim NumeroColliLavorati As Double

Dim AndamentoPedana As Double
Dim AndamentoColli As Double
Dim RigaAndamanentoOrdine As String

CREA_RECORDSET_PEDANA_TMP
'Me.PBOrdine.Visible = False
Me.txtAndamentoOrdine.Visible = False
'Me.PBOrdine.Value = 0
Me.txtAndamentoOrdine.Text = ""
RigaAndamanentoOrdine = ""

If ((Me.cdCliente.KeyFieldID = LINK_CLIENTE_ORD_PRED) And (Me.txtDataOrdine.Text = DATA_ORDINE_PRED) And (Me.txtNumeroOrdine.Value = NUMERO_ORDINE_PRED)) Then Exit Sub

NumeroPedaneOrdinate = GET_TOTALI_ORDINE(IDOrdine)
NumeroColliOrdinati = GET_TOTALI_COLLI_ORDINE(IDOrdine)

NumeroPedaneLavorate = 0
NumeroColliLavorati = 0

'If NumeroPedaneOrdinate = 0 Then Exit Sub
If NumeroPedaneOrdinate > 0 Then
    NumeroPedaneLavorate = GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE(IDOrdine)
End If
If NumeroColliOrdinati > 0 Then
    NumeroColliLavorati = GET_NUMERO_COLLI_LAVORATE_PER_ORDINE(IDOrdine)
End If

'Me.PBOrdine.Visible = True
Me.txtAndamentoOrdine.Visible = True
'Me.PBOrdine.Value = 0
'Me.PBOrdine.Max = NumeroPedaneOrdinate
'If NumeroPedaneOrdinate < NumeroPedaneLavorate Then
'    Me.PBOrdine.Value = NumeroPedaneOrdinate
'Else
'    Me.PBOrdine.Value = NumeroPedaneLavorate
'End If

AndamentoPedana = 100
If NumeroPedaneOrdinate > 0 Then
    AndamentoPedana = FormatNumber(((NumeroPedaneLavorate / NumeroPedaneOrdinate) * 100), 2)
End If

AndamentoColli = 100
If NumeroColliOrdinati > 0 Then
    AndamentoColli = FormatNumber(((NumeroColliLavorati / NumeroColliOrdinati) * 100), 2)
End If

RigaAndamanentoOrdine = RigaAndamanentoOrdine & FormatNumber(NumeroPedaneOrdinate, 2) & "/" & FormatNumber(NumeroPedaneLavorate, 2) & " [" & AndamentoPedana & "%]"
RigaAndamanentoOrdine = RigaAndamanentoOrdine & " - " & FormatNumber(NumeroColliOrdinati, 2) & "/" & FormatNumber(NumeroColliLavorati, 2) & " [" & AndamentoColli & "%]"


Me.txtAndamentoOrdine.Visible = True
Me.txtAndamentoOrdine.Text = RigaAndamanentoOrdine

'If Andamento < 50 Then
'    Me.txtAndamentoOrdine.BackColor = Me.BackColor
'Else
'    Me.txtAndamentoOrdine.BackColor = &H8000000D
'End If
Exit Sub
ERR_GET_ANDAMENTO_ORDINE:
    MsgBox Err.Description, vbCritical, "GET_ANDAMENTO_ORDINE"
End Sub

Private Function GET_TOTALI_ORDINE(IDOggettoOrdine As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

'sSQL = "SELECT SUM(RV_POQuantitaPedana) as NumeroPedane "
sSQL = "SELECT SUM(RV_POQuantitaPedanaEffettiva) as NumeroPedane "
sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
sSQL = sSQL & " AND RV_POTipoRiga=1 "

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TOTALI_ORDINE = 0
Else
    GET_TOTALI_ORDINE = fnNotNullN(rs!NumeroPedane)
End If


rs.CloseResultset
Set rs = Nothing
End Function

Private Function GET_TOTALI_COLLI_ORDINE(IDOggettoOrdine As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT SUM(art_numero_colli) as NumeroPedane "
sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
sSQL = sSQL & " AND RV_POTipoRiga=1 "

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TOTALI_COLLI_ORDINE = 0
Else
    GET_TOTALI_COLLI_ORDINE = fnNotNullN(rs!NumeroPedane)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE(IDOggettoOrdine As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim NumeroColliPerPedana As Double
Dim NumeroColliSpezzati As Double
GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE = 0

'sSQL = "SELECT IDRV_POPedana "
'sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
'sSQL = sSQL & "WHERE IDOggettoOrdinePadre=" & IDOggettoOrdine
'sSQL = sSQL & " GROUP BY IDRV_POPedana"
'
'Set rs = Cn.OpenResultset(sSQL)
'
'While Not rs.EOF
'    GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE = GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE + 1
'rs.MoveNext
'Wend
'
'rs.CloseResultset
'Set rs = Nothing

sSQL = "SELECT RV_POAssegnazioneMerce.IDRV_POPedana, RV_POAssegnazioneMerce.IDImballoVendita, RV_POAssegnazioneMerce.Colli, RV_POPedana.IDRV_POTipoPedana "
sSQL = sSQL & "FROM RV_POAssegnazioneMerce LEFT OUTER JOIN "
sSQL = sSQL & "RV_POPedana ON RV_POAssegnazioneMerce.IDRV_POPedana = RV_POPedana.IDRV_POPedana "
sSQL = sSQL & " WHERE RV_POAssegnazioneMerce.IDOggettoOrdinePadre=" & IDOggettoOrdine

'sSQL = sSQL & " AND RV_POAssegnazioneMerce.IDValoriOggettoDettaglioRigaOrd=" & IDRigaOrdine
'sSQL = sSQL & " GROUP BY RV_POAssegnazioneMerce.IDRV_POPedana"

Set rs = Cn.OpenResultset(sSQL)
    
While Not rs.EOF
    NumeroColliPerPedana = GET_COLLI_PER_TIPO_PEDANA(fnNotNullN(rs!IDRV_POTipoPedana), fnNotNullN(rs!IDImballoVendita))
    If GET_CONTROLLO_ESISTENZA_PEDANA_CALCOLATA(fnNotNullN(rs!IDRV_POPedana)) = False Then
        If NumeroColliPerPedana = 0 Then
            GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE = GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE + 1
        Else
            NumeroColliSpezzati = (fnNotNullN(rs!Colli) / NumeroColliPerPedana)
            GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE = GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE + NumeroColliSpezzati
        End If
    Else
        If NumeroColliPerPedana > 0 Then
            NumeroColliSpezzati = FormatNumber((fnNotNullN(rs!Colli) / NumeroColliPerPedana), 2)
            GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE = GET_NUMERO_PEDANE_LAVORATE_PER_ORDINE + NumeroColliSpezzati
        End If
    End If
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_NUMERO_COLLI_LAVORATE_PER_ORDINE(IDOggettoOrdine As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_NUMERO_COLLI_LAVORATE_PER_ORDINE = 0

sSQL = "SELECT SUM(Colli) as NumeroColli "
sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
sSQL = sSQL & "WHERE IDOggettoOrdinePadre=" & IDOggettoOrdine
'sSQL = sSQL & " GROUP BY IDRV_POPedana"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_NUMERO_COLLI_LAVORATE_PER_ORDINE = 0
Else
    GET_NUMERO_COLLI_LAVORATE_PER_ORDINE = fnNotNullN(rs!NumeroColli)
End If

rs.CloseResultset
Set rs = Nothing
End Function


Private Sub GET_ANDAMENTO_ORDINE_LAVORAZIONE(IDOrdine As Long, IDArticoloLavorato As Long, raggrOrd As String)
On Error GoTo ERR_GET_ANDAMENTO_ORDINE_LAVORAZIONE
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim NumeroPedaneOrdinate As Double
Dim NumeroPedaneLavorate As Double
Dim NumeroColliOrdinati As Double
Dim NumeroColliLavorati As Double

Dim AndamentoPedane As Double
Dim AndamentoColli As Double
Dim RigaAndamanentoOrdine As String

Dim IDArticoloPadreOrdine As Long

RigaAndamanentoOrdine = ""

CREA_RECORDSET_PEDANA_TMP

Me.txtAndamentoOrdineDett.Visible = False

Me.txtAndamentoOrdineDett.Text = ""

IDArticoloPadreOrdine = IDArticoloLavorato ' GET_LINK_ARTICOLO_PADRE_ORDINATO(IDArticoloLavorato)

If IDArticoloPadreOrdine = 0 Then Exit Sub
If ((Me.cdCliente.KeyFieldID = LINK_CLIENTE_ORD_PRED) And (Me.txtDataOrdine.Text = DATA_ORDINE_PRED) And (Me.txtNumeroOrdine.Value = NUMERO_ORDINE_PRED)) Then Exit Sub

NumeroPedaneOrdinate = GET_TOTALI_ORDINE_DETTAGLIO(IDOrdine, IDArticoloPadreOrdine, raggrOrd, Me.txtIDRigaOrdine.Value)
NumeroColliOrdinati = GET_TOTALI_ORDINE_DETTAGLIO_COLLI(IDOrdine, IDArticoloPadreOrdine, raggrOrd, Me.txtIDRigaOrdine.Value)

'If NumeroPedaneOrdinate = 0 Then Exit Sub

NumeroPedaneLavorate = GET_NUMERO_PEDANE_LAVORATE_PER_ARTICOLO_ORDINATO(IDOrdine, IDArticoloPadreOrdine, raggrOrd, Me.txtIDRigaOrdine.Value)
NumeroColliLavorati = GET_NUMERO_COLLI_LAVORATI_PER_ARTICOLO_ORDINATO(IDOrdine, IDArticoloPadreOrdine, raggrOrd, Me.txtIDRigaOrdine.Value)


'Me.PBOrdineDettaglio.Visible = False
'Me.txtAndamentoOrdineDett.Visible = False
'Me.PBOrdineDettaglio.Value = 0
'Me.PBOrdineDettaglio.Max = NumeroPedaneOrdinate

'If NumeroPedaneOrdinate < NumeroPedaneLavorate Then
'    Me.PBOrdineDettaglio.Value = NumeroPedaneOrdinate
'Else
'    Me.PBOrdineDettaglio.Value = NumeroPedaneLavorate
'End If

''RAGGRUPPAMENTO ORDINE
RigaAndamanentoOrdine = RigaAndamanentoOrdine & Me.txtRaggrOrd.Text

''ANDAMENTO PEDANE
AndamentoPedane = 100
If (NumeroPedaneOrdinate) > 0 Then
    AndamentoPedane = FormatNumber(((NumeroPedaneLavorate / NumeroPedaneOrdinate) * 100), 2)
End If
If Len(Trim(RigaAndamanentoOrdine)) > 0 Then
    RigaAndamanentoOrdine = RigaAndamanentoOrdine & " - " & FormatNumber(NumeroPedaneOrdinate, 2) & "/" & FormatNumber(NumeroPedaneLavorate, 2) & " [" & AndamentoPedane & "%]"
Else
    RigaAndamanentoOrdine = RigaAndamanentoOrdine & FormatNumber(NumeroPedaneOrdinate, 2) & "/" & FormatNumber(NumeroPedaneLavorate, 2) & " [" & AndamentoPedane & "%]"
End If

''ANDAMENTO COLLI
AndamentoColli = 100
If (NumeroColliOrdinati) > 0 Then
    AndamentoColli = FormatNumber(((NumeroColliLavorati / NumeroColliOrdinati) * 100), 2)
End If
RigaAndamanentoOrdine = RigaAndamanentoOrdine & " - " & FormatNumber(NumeroColliOrdinati, 2) & "/" & FormatNumber(NumeroColliLavorati, 2) & " [" & AndamentoColli & "%]"

'Me.txtAndamentoOrdineDett.Text = Andamento & "%"
Me.txtAndamentoOrdineDett.Visible = True
Me.txtAndamentoOrdineDett.Text = RigaAndamanentoOrdine

'If Andamento < 50 Then
'    Me.txtAndamentoOrdineDett.BackColor = Me.BackColor
'Else
'    Me.txtAndamentoOrdineDett.BackColor = &H8000000D
'End If

Exit Sub
ERR_GET_ANDAMENTO_ORDINE_LAVORAZIONE:
    MsgBox Err.Description, vbCritical, "GET_ANDAMENTO_ORDINE_LAVORAZIONE"
End Sub
Private Function GET_LINK_ARTICOLO_PADRE_ORDINATO(IDArticoloDerivato As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDArticolo FROM RV_POArticoloFiglioOrdine "
sSQL = sSQL & "WHERE IDArticoloFiglio=" & IDArticoloDerivato

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_ARTICOLO_PADRE_ORDINATO = 0
Else
    GET_LINK_ARTICOLO_PADRE_ORDINATO = fnNotNullN(rs!IDArticolo)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_TOTALI_ORDINE_DETTAGLIO(IDOggettoOrdine As Long, IDArticolo As Long, raggrOrd As String, IDRigaOrdine As Long) As Double
On Error GoTo ERR_GET_TOTALI_ORDINE_DETTAGLIO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_TOTALI_ORDINE_DETTAGLIO = 0

'sSQL = "SELECT SUM(RV_POQuantitaPedana) as NumeroPedane "
sSQL = "SELECT SUM(RV_POQuantitaPedanaEffettiva) as NumeroPedane "
sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
'sSQL = sSQL & " AND Link_art_articolo=" & IDArticolo
'sSQL = sSQL & " AND RV_PONotaRigaOrdRaggr=" & fnNormString(raggrOrd)
sSQL = sSQL & " AND IDValoriOggettoDettaglio=" & IDRigaOrdine
sSQL = sSQL & " AND RV_POTipoRiga=1 "

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TOTALI_ORDINE_DETTAGLIO = 0
Else
    GET_TOTALI_ORDINE_DETTAGLIO = fnNotNullN(rs!NumeroPedane)
End If


rs.CloseResultset
Set rs = Nothing

Exit Function
ERR_GET_TOTALI_ORDINE_DETTAGLIO:
    MsgBox Err.Description, vbCritical, "ERR_GET_TOTALI_ORDINE_DETTAGLIO"
End Function
Private Function GET_TOTALI_ORDINE_DETTAGLIO_COLLI(IDOggettoOrdine As Long, IDArticolo As Long, raggrOrd As String, IDRigaOrdine As Long) As Double
On Error GoTo ERR_GET_TOTALI_ORDINE_DETTAGLIO_COLLI
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_TOTALI_ORDINE_DETTAGLIO_COLLI = 0

sSQL = "SELECT SUM(art_numero_colli) as NumeroPedane "
sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
'sSQL = sSQL & " AND Link_art_articolo=" & IDArticolo
'sSQL = sSQL & " AND RV_PONotaRigaOrdRaggr=" & fnNormString(raggrOrd)
sSQL = sSQL & " AND IDValoriOggettoDettaglio=" & IDRigaOrdine
sSQL = sSQL & " AND RV_POTipoRiga=1 "

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TOTALI_ORDINE_DETTAGLIO_COLLI = 0
Else
    GET_TOTALI_ORDINE_DETTAGLIO_COLLI = fnNotNullN(rs!NumeroPedane)
End If

Exit Function
ERR_GET_TOTALI_ORDINE_DETTAGLIO_COLLI:
    MsgBox Err.Description, vbCritical, "GET_TOTALI_ORDINE_DETTAGLIO_COLLI"
rs.CloseResultset
Set rs = Nothing
End Function


Private Sub CREA_RECORDSET_PEDANA_TMP()
If Not (rsTmpPed Is Nothing) Then
    If rsTmpPed.State > 0 Then
        rsTmpPed.Close
    End If
    Set rsTmpPed = Nothing
End If
Set rsTmpPed = New ADODB.Recordset

rsTmpPed.CursorLocation = adUseClient

rsTmpPed.Fields.Append "IDRV_POPedana", adInteger, , adFldIsNullable

rsTmpPed.Open , , adOpenKeyset, adLockPessimistic


End Sub
Private Function GET_CONTROLLO_ESISTENZA_PEDANA_CALCOLATA(IDPedana As Long) As Boolean
rsTmpPed.Filter = "IDRV_POPedana=" & IDPedana

If rsTmpPed.EOF Then
    GET_CONTROLLO_ESISTENZA_PEDANA_CALCOLATA = False
    rsTmpPed.Filter = ""
    rsTmpPed.AddNew
        rsTmpPed!IDRV_POPedana = IDPedana
    rsTmpPed.Update

Else
    GET_CONTROLLO_ESISTENZA_PEDANA_CALCOLATA = True
End If
End Function
Private Function GET_NUMERO_PEDANE_LAVORATE_PER_ARTICOLO_ORDINATO(IDOggettoOrdine As Long, IDArticoloPadre As Long, raggrOrd As String, IDRigaOrdine As Long) As Double
Dim sSQL As String
Dim rsArt As DmtOleDbLib.adoResultset
Dim rs As DmtOleDbLib.adoResultset
Dim rstmp As ADODB.Recordset
Dim NumeroColliPerPedana As Long
Dim IDTipoPedana As Double
Dim NumeroColliSpezzati As Double

GET_NUMERO_PEDANE_LAVORATE_PER_ARTICOLO_ORDINATO = 0

'sSQL = "SELECT IDRV_POPedana, ImballoVendita, Colli "
'sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
'sSQL = sSQL & "WHERE IDOggettoOrdinePadre=" & IDOggettoOrdine
'sSQL = sSQL & " AND IDValoriOggettoDettaglioRigaOrd=" & IDRigaOrdine
'sSQL = sSQL & " GROUP BY IDRV_POPedana"
If IDRigaOrdine = 0 Then Exit Function

sSQL = "SELECT RV_POAssegnazioneMerce.IDRV_POPedana, RV_POAssegnazioneMerce.IDImballoVendita, RV_POAssegnazioneMerce.Colli, RV_POPedana.IDRV_POTipoPedana "
sSQL = sSQL & "FROM RV_POAssegnazioneMerce LEFT OUTER JOIN "
sSQL = sSQL & "RV_POPedana ON RV_POAssegnazioneMerce.IDRV_POPedana = RV_POPedana.IDRV_POPedana "
sSQL = sSQL & " WHERE RV_POAssegnazioneMerce.IDOggettoOrdinePadre=" & IDOggettoOrdine
sSQL = sSQL & " AND RV_POAssegnazioneMerce.IDValoriOggettoDettaglioRigaOrd=" & IDRigaOrdine
'sSQL = sSQL & " GROUP BY RV_POAssegnazioneMerce.IDRV_POPedana"

Set rs = Cn.OpenResultset(sSQL)
    
While Not rs.EOF
    NumeroColliPerPedana = GET_COLLI_PER_TIPO_PEDANA(fnNotNullN(rs!IDRV_POTipoPedana), fnNotNullN(rs!IDImballoVendita))
    If GET_CONTROLLO_ESISTENZA_PEDANA_CALCOLATA(fnNotNullN(rs!IDRV_POPedana)) = False Then
        If NumeroColliPerPedana = 0 Then
            GET_NUMERO_PEDANE_LAVORATE_PER_ARTICOLO_ORDINATO = GET_NUMERO_PEDANE_LAVORATE_PER_ARTICOLO_ORDINATO + 1
        Else
            NumeroColliSpezzati = (fnNotNullN(rs!Colli) / NumeroColliPerPedana)
            GET_NUMERO_PEDANE_LAVORATE_PER_ARTICOLO_ORDINATO = GET_NUMERO_PEDANE_LAVORATE_PER_ARTICOLO_ORDINATO + NumeroColliSpezzati
        End If
    Else
        If NumeroColliPerPedana > 0 Then
            NumeroColliSpezzati = FormatNumber((fnNotNullN(rs!Colli) / NumeroColliPerPedana), 2)
            GET_NUMERO_PEDANE_LAVORATE_PER_ARTICOLO_ORDINATO = GET_NUMERO_PEDANE_LAVORATE_PER_ARTICOLO_ORDINATO + NumeroColliSpezzati
        End If
    End If
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing
    
End Function
Private Function GET_NUMERO_COLLI_LAVORATI_PER_ARTICOLO_ORDINATO(IDOggettoOrdine As Long, IDArticoloPadre As Long, raggrOrd As String, IDRigaOrdine As Long) As Double
Dim sSQL As String
Dim rsArt As DmtOleDbLib.adoResultset
Dim rs As DmtOleDbLib.adoResultset
Dim rstmp As ADODB.Recordset

    GET_NUMERO_COLLI_LAVORATI_PER_ARTICOLO_ORDINATO = 0
    
    If IDRigaOrdine = 0 Then Exit Function

    sSQL = "SELECT SUM(Colli) as NumeroColli "
    sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
    sSQL = sSQL & "WHERE IDOggettoOrdinePadre=" & IDOggettoOrdine
    sSQL = sSQL & " AND IDValoriOggettoDettaglioRigaOrd=" & IDRigaOrdine

    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        GET_NUMERO_COLLI_LAVORATI_PER_ARTICOLO_ORDINATO = 0
    Else
        GET_NUMERO_COLLI_LAVORATI_PER_ARTICOLO_ORDINATO = fnNotNullN(rs!NumeroColli)
    End If

    rs.CloseResultset
    Set rs = Nothing
    
End Function
Private Function GET_NUMERO_PROCESSI_COLLEGATI(IDLavorazione As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Count(IDRV_POAssegnazioneMerce) AS NumeroProcessi "
sSQL = sSQL & "FROM RV_POAssegnazioneMerce "
sSQL = sSQL & "WHERE IDRV_POAssegnazioneMercePadre=" & IDLavorazione
sSQL = sSQL & " AND IDRV_POAssegnazioneMerce<>" & IDLavorazione

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_NUMERO_PROCESSI_COLLEGATI = 0
Else
    GET_NUMERO_PROCESSI_COLLEGATI = fnNotNullN(rs!NumeroProcessi)
End If

rs.CloseResultset
Set rs = Nothing

End Function
Private Function GET_PREZZO_IMBALLO_2(IDArticolo As Long, IDListinoCliente As Long, IDListinoAzienda As Long, IDListinoParAzienda As Long, IDOggettoOrdine As Long, PrezziDaOrdine As Long, IDPedana As Long, IDImballo As Long, IDDestinazione As Long, IDCliente As Long) As Double
On Error GoTo ERR_GET_PREZZO_IMBALLO_2
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim ImportoUnitario As Double
Dim IDArticoloPadre As Long
Dim IDTipoPedana As Long
Dim NumeroCombinazioni As Long
Dim Link_Listino_Dest As Long
Dim Link_Riga_Ordine As Long

ImportoUnitario = 0

If PrezziDaOrdine = 1 Then
    Link_Riga_Ordine = 0
    IDArticoloPadre = GET_LINK_ARTICOLO_PADRE_ORDINATO(IDArticolo)
    IDTipoPedana = GET_TIPO_PEDANA(IDPedana)
    
    If IDArticoloPadre > 0 Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        sSQL = "SELECT Count(IDValoriOggettoDettaglio) AS NumeroRecord "
        sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
        sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
        sSQL = sSQL & " AND RV_POTipoRiga=1 "
        sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
        'sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
        If GESTIONE_ORDINE_VIVAIO = 0 Then
            If TROVA_PREZZI_NO_IMB = 0 Then
                sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
            End If
        End If
        
        Set rs = Cn.OpenResultset(sSQL)
        
        If rs.EOF Then
            NumeroCombinazioni = 0
        Else
            NumeroCombinazioni = fnNotNullN(rs!NumeroRecord)
        End If
        
        rs.CloseResultset
        Set rs = Nothing
        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        If NumeroCombinazioni = 1 Then
            '''''''''''''''''''TROVO IL LINK_RIGA DELL'ORDINE'''''''''''''''''''''''''''
            sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
            sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
            sSQL = sSQL & " AND RV_POTipoRiga=1 "
            sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
            'sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
            If GESTIONE_ORDINE_VIVAIO = 0 Then
                If TROVA_PREZZI_NO_IMB = 0 Then
                    sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
                End If
            End If
            Set rs = Cn.OpenResultset(sSQL)
            
            If Not rs.EOF Then
                Link_Riga_Ordine = fnNotNullN(rs!RV_POLinkRiga)
            End If
            
            rs.CloseResultset
            Set rs = Nothing
            ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
            
            If Link_Riga_Ordine > 0 Then
                sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
                sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
                sSQL = sSQL & " AND RV_POTipoRiga=2 "
                sSQL = sSQL & " AND RV_POLinkRiga=" & Link_Riga_Ordine
                sSQL = sSQL & " AND Link_Art_articolo=" & IDImballo
                
                Set rs = Cn.OpenResultset(sSQL)
                
                If Not rs.EOF Then
                    ImportoUnitario = fnNotNullN(rs!Art_prezzo_unitario_netto_IVA)
                End If
                
                rs.CloseResultset
                Set rs = Nothing
            End If
            
        End If
    End If
End If


'''''IMPORTO UNITARIO DAL LISTINO CLIENTE'''''''''''''''''''''''''''''''''''''''''''''''''''
If ImportoUnitario = 0 Then
    sSQL = "SELECT PrezzoNettoIva "
    sSQL = sSQL & "FROM ListinoPerArticolo "
    sSQL = sSQL & " WHERE IDListino=" & IDListinoCliente
    sSQL = sSQL & " AND IDArticolo=" & IDImballo
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        ImportoUnitario = 0
    Else
        ImportoUnitario = fnNotNullN(rs!PrezzoNettoIva)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'''''IMPORTO UNITARIO DAL LISTINO IMBALLI INDICATO NEI PARAMETRI FILIALE'''''''''''''''''''''''
If ImportoUnitario = 0 Then
    sSQL = "SELECT PrezzoNettoIva "
    sSQL = sSQL & "FROM ListinoPerArticolo "
    sSQL = sSQL & " WHERE IDListino=" & IDListinoParAzienda
    sSQL = sSQL & " AND IDArticolo=" & IDImballo
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        ImportoUnitario = 0
    Else
        ImportoUnitario = fnNotNullN(rs!PrezzoNettoIva)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

'''''IMPORTO UNITARIO DAL LISTINO AZIENDA'''''''''''''''''''''''''''''''''''''''''''''''''''''
If ImportoUnitario = 0 Then
    sSQL = "SELECT PrezzoNettoIva "
    sSQL = sSQL & "FROM ListinoPerArticolo "
    sSQL = sSQL & " WHERE IDListino=" & IDListinoAzienda
    sSQL = sSQL & " AND IDArticolo=" & IDImballo
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        ImportoUnitario = 0
    Else
        ImportoUnitario = fnNotNullN(rs!PrezzoNettoIva)
    End If
    
    rs.CloseResultset
    Set rs = Nothing

End If
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
GET_PREZZO_IMBALLO_2 = ImportoUnitario
Exit Function
ERR_GET_PREZZO_IMBALLO_2:
    GET_PREZZO_IMBALLO_2 = 0
End Function

Private Sub GET_PREZZI_DA_ORDINE()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT PrezziArticoloDaOrdine, PrezziImballoDaOrdine, PrezzoInclusoImballoDaOrdine "
sSQL = sSQL & "FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & TheApp.Branch
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDUtente=" & 0

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    PREZZI_ARTICOLI_DA_ORDINE = 0
    PREZZI_IMBALLI_DA_ORDINE = 0
    PREZZO_INCLUSO_IMBALLO_DA_ORDINE = 0
Else
    PREZZI_ARTICOLI_DA_ORDINE = fnNotNullN(rs!PrezziArticoloDaOrdine)
    PREZZI_IMBALLI_DA_ORDINE = fnNotNullN(rs!PrezziImballoDaOrdine)
    PREZZO_INCLUSO_IMBALLO_DA_ORDINE = fnNotNullN(rs!PrezzoInclusoImballoDaOrdine)
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Function GET_PREZZO_IMBALLO_INCLUSO_2(IDArticolo As Long, IDImballo As Long, IDCliente As Long) As Long
On Error GoTo ERR_GET_PREZZO_IMBALLO_INCLUSO_2
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim rsCli As DmtOleDbLib.adoResultset
Dim IDArticoloPadre As Long
Dim IDTipoPedana As Long
Dim NumeroCombinazioni As Long
Dim Link_Listino_Dest As Long

GET_PREZZO_IMBALLO_INCLUSO_2 = 0

'If PrezziDaOrdine = 1 Then
'    IDArticoloPadre = IDArticolo 'GET_LINK_ARTICOLO_PADRE_ORDINATO(IDArticolo)
'    'IDTipoPedana = GET_TIPO_PEDANA(IDPedana)
'
'    If IDArticoloPadre > 0 Then
'        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'        sSQL = "SELECT Count(IDValoriOggettoDettaglio) AS NumeroRecord "
'        sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
'        sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
'        sSQL = sSQL & " AND RV_POTipoRiga=1 "
'        sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
'        'sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
'        If GESTIONE_ORDINE_VIVAIO = 0 Then
'            If TROVA_PREZZI_NO_IMB = 0 Then
'                sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
'            End If
'        End If
'        sSQL = sSQL & " AND RV_PONotaRigaOrdRaggr=" & fnNormString(raggrOrdine)
'        If (TROVA_PREZZI_ORD_CAT = 1) Then
'            sSQL = sSQL & " AND RV_POIDTipoCategoria=" & IDCategoria
'        End If
'        If (TROVA_PREZZI_ORD_CAL = 1) Then
'            sSQL = sSQL & " AND RV_POIDCalibro=" & IDCalibro
'        End If
'
'        Set rs = Cn.OpenResultset(sSQL)
'
'        If rs.EOF Then
'            NumeroCombinazioni = 0
'        Else
'            NumeroCombinazioni = fnNotNullN(rs!NumeroRecord)
'        End If
'
'        rs.CloseResultset
'        Set rs = Nothing
'        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'        If NumeroCombinazioni = 1 Then
'            sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
'            sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
'            sSQL = sSQL & " AND RV_POTipoRiga=1 "
'            sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
'            'sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
'            If GESTIONE_ORDINE_VIVAIO = 0 Then
'                If TROVA_PREZZI_NO_IMB = 0 Then
'                    sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
'                End If
'            End If
'            sSQL = sSQL & " AND RV_PONotaRigaOrdRaggr=" & fnNormString(raggrOrdine)
'            If (TROVA_PREZZI_ORD_CAT = 1) Then
'                sSQL = sSQL & " AND RV_POIDTipoCategoria=" & IDCategoria
'            End If
'            If (TROVA_PREZZI_ORD_CAL = 1) Then
'                sSQL = sSQL & " AND RV_POIDCalibro=" & IDCalibro
'            End If
'
'            Set rs = Cn.OpenResultset(sSQL)
'
'            If Not rs.EOF Then
'                GET_PREZZO_IMBALLO_INCLUSO_2 = fnNotNullN(rs!RV_POImportoImballoInArticolo)
'            End If
'
'            rs.CloseResultset
'            Set rs = Nothing
'            Exit Function
'        End If
'    End If
'End If


If GET_PREZZO_IMBALLO_INCLUSO_2 = 0 Then
    sSQL = "SELECT PrezzoInclusoImballo "
    sSQL = sSQL & "FROM RV_POConfigurazioneClienteImb "
    sSQL = sSQL & "WHERE IDAnagrafica=" & IDCliente
    sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
    sSQL = sSQL & " AND IDArticoloImballo=" & IDImballo
    
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        sSQL = "SELECT PrezzoInclusoImballo "
        sSQL = sSQL & "FROM RV_POConfigurazioneCliente "
        sSQL = sSQL & "WHERE IDAnagrafica=" & IDCliente
        sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
        'sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
        
        Set rsCli = Cn.OpenResultset(sSQL)
        
        If rsCli.EOF Then
            GET_PREZZO_IMBALLO_INCLUSO_2 = 0
        Else
            GET_PREZZO_IMBALLO_INCLUSO_2 = fnNotNullN(rsCli!PrezzoInclusoImballo)
        End If
        
        rsCli.CloseResultset
        Set rsCli = Nothing
        
    Else
        GET_PREZZO_IMBALLO_INCLUSO_2 = fnNotNullN(rs!PrezzoInclusoImballo)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If

Exit Function
ERR_GET_PREZZO_IMBALLO_INCLUSO_2:
    GET_PREZZO_IMBALLO_INCLUSO_2 = 0
End Function
Private Function GET_PREZZO_UNITARIO_ARTICOLO(IDArticolo As Long, IDListinoCliente As Long, IDListinoAzienda As Long, IDOggettoOrdine As Long, PrezziDaOrdine As Long, IDPedana As Long, IDImballo As Long, rstmp As ADODB.Recordset, IDDestinazione As Long, IDCliente As Long) As Double
On Error GoTo ERR_GET_PREZZO_UNITARIO_ARTICOLO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim ImportoUnitario As Double
Dim IDArticoloPadre As Long
Dim IDTipoPedana As Long
Dim NumeroCombinazioni As Long
Dim Link_Listino_Dest As Long


ImportoUnitario = 0

If PrezziDaOrdine = 1 Then
    IDArticoloPadre = IDArticolo
    IDTipoPedana = GET_TIPO_PEDANA(IDPedana)
    
    If IDArticoloPadre > 0 Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        sSQL = "SELECT Count(IDValoriOggettoDettaglio) AS NumeroRecord "
        sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
        sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
        sSQL = sSQL & " AND RV_POTipoRiga=1 "
        sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
        sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
        sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
        
        Set rs = Cn.OpenResultset(sSQL)
        
        If rs.EOF Then
            NumeroCombinazioni = 0
        Else
            NumeroCombinazioni = fnNotNullN(rs!NumeroRecord)
        End If
        
        rs.CloseResultset
        Set rs = Nothing
        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        If NumeroCombinazioni = 1 Then
            sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
            sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
            sSQL = sSQL & " AND RV_POTipoRiga=1 "
            sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
            sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
            sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
            
            Set rs = Cn.OpenResultset(sSQL)
            
            If Not rs.EOF Then
                ImportoUnitario = fnNotNullN(rs!Art_prezzo_unitario_netto_IVA)
                rstmp!Sconto1 = fnNotNullN(rs!Art_sco_in_percentuale_1)
                rstmp!Sconto2 = fnNotNullN(rs!Art_sco_in_percentuale_2)
            End If
            
            rs.CloseResultset
            Set rs = Nothing
        End If
    End If
End If


'''''IMPORTO UNITARIO DAL LISTINO CLIENTE'''''''''''''''''''''''''''''''''''''''''''''''''''
If ImportoUnitario = 0 Then
'CALCOLO DELLA RIGA
    sSQL = "SELECT PrezzoNettoIva "
    sSQL = sSQL & "FROM ListinoPerArticolo "
    sSQL = sSQL & " WHERE IDListino=" & IDListinoCliente
    sSQL = sSQL & " AND IDArticolo=" & IDArticolo
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        ImportoUnitario = 0
    Else
        ImportoUnitario = fnNotNullN(rs!PrezzoNettoIva)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

If ImportoUnitario = 0 Then
'''''''''IMPORTO UNITARIO DAL LISTINO AZIENDA'''''''''''''''''''''''''''''''''''''''''''''''''
    sSQL = "SELECT PrezzoNettoIva "
    sSQL = sSQL & "FROM ListinoPerArticolo "
    sSQL = sSQL & " WHERE IDListino=" & IDListinoAzienda
    sSQL = sSQL & " AND IDArticolo=" & IDArticolo
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If rs.EOF Then
        ImportoUnitario = 0
    Else
        ImportoUnitario = fnNotNullN(rs!PrezzoNettoIva)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
End If

GET_PREZZO_UNITARIO_ARTICOLO = ImportoUnitario
Exit Function
ERR_GET_PREZZO_UNITARIO_ARTICOLO:
    GET_PREZZO_UNITARIO_ARTICOLO = 0
    
End Function

Private Function GET_LINK_LISTINO_AZIENDA() As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDListinoDiBase "
sSQL = sSQL & "FROM PersonalizzazionePerFiliale "
sSQL = sSQL & "WHERE IDFiliale=" & TheApp.Branch

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_LISTINO_AZIENDA = 0
Else
    GET_LINK_LISTINO_AZIENDA = fnNotNullN(rs!IDListinoDiBase)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO(IDSocio As Long, NomeCampo As String, IDArticolo As Long) As String
On Error GoTo ERR_GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim IDFamiglia As Long

GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO = ""

''''''RECUPERO DELLA FAMIGLIA DELL'ARTICOLO VENDUTO''''''''''''''''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT RV_PO01_IDFamigliaProdotti "
sSQL = sSQL & "FROM Articolo "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    IDFamiglia = 0
Else
    IDFamiglia = fnNotNullN(rs!RV_PO01_IDFamigliaProdotti)
End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

If IDFamiglia = 0 Then Exit Function

sSQL = "SELECT " & NomeCampo & " "
sSQL = sSQL & "FROM RV_PO01_CertificazioneSocioFamiglia INNER JOIN "
sSQL = sSQL & "RV_PO01_Certificazione ON RV_PO01_CertificazioneSocioFamiglia.IDRV_PO01_Certificazione = RV_PO01_Certificazione.IDRV_PO01_Certificazione "
sSQL = sSQL & "WHERE IDRV_PO01_FamigliaProdotti=" & IDFamiglia
sSQL = sSQL & " AND IDAnagrafica=" & IDSocio
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO = ""
Else
    GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO = fnNotNull(rs.adoColumns(NomeCampo).Value)
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_CERTIFICAZIONE_FAMIGLIA_PRODOTTO:
End Function
Private Sub GET_CERTIFICAZIONE_FAM_PER_ETI_LAV(IDSocio As Long, IDArticolo As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim IDFamiglia As Long


''''''RECUPERO DELLA FAMIGLIA DELL'ARTICOLO VENDUTO''''''''''''''''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT RV_PO01_IDFamigliaProdotti "
sSQL = sSQL & "FROM Articolo "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    IDFamiglia = 0
Else
    IDFamiglia = fnNotNullN(rs!RV_PO01_IDFamigliaProdotti)
End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

If IDFamiglia = 0 Then Exit Sub

sSQL = "SELECT RV_PO01_CertificazioneSocioFamiglia.IDRV_PO01_CertificazioneSocioFamiglia, RV_PO01_CertificazioneSocioFamiglia.IDAnagrafica, "
sSQL = sSQL & "RV_PO01_CertificazioneSocioFamiglia.IDRV_PO01_FamigliaProdotti, RV_PO01_CertificazioneSocioFamiglia.IDRV_PO01_Certificazione,"
sSQL = sSQL & "RV_PO01_CertificazioneSocioFamiglia.ProtocolloCertificazione, RV_PO01_CertificazioneSocioFamiglia.Predefinito,"
sSQL = sSQL & "RV_PO01_Certificazione.CodiceCertificazione, RV_PO01_Certificazione.DescrizioneCertificazione,"
sSQL = sSQL & "RV_PO01_EnteCertificazione.EnteCertificazione "
sSQL = sSQL & "FROM RV_PO01_CertificazioneSocioFamiglia INNER JOIN "
sSQL = sSQL & "RV_PO01_Certificazione ON "
sSQL = sSQL & "RV_PO01_CertificazioneSocioFamiglia.IDRV_PO01_Certificazione = RV_PO01_Certificazione.IDRV_PO01_Certificazione LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_EnteCertificazione ON RV_PO01_Certificazione.IDRV_PO01_EnteCertificazione = RV_PO01_EnteCertificazione.IDRV_PO01_EnteCertificazione "
sSQL = sSQL & "WHERE IDRV_PO01_FamigliaProdotti=" & IDFamiglia
sSQL = sSQL & " AND IDAnagrafica=" & IDSocio
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    CODICE_CERTIFICAZIONE_FAM_LAV = ""
    DESCRIZIONE_CERTIFICAZIONE_FAM_LAV = ""
    PROTOCOLLO_CERTIFICAZIONE_FAM_LAV = ""
    ENTE_CERTIFICAZIONE_FAM_LAV = ""
Else
    CODICE_CERTIFICAZIONE_FAM_LAV = fnNotNull(rs!CodiceCertificazione)
    DESCRIZIONE_CERTIFICAZIONE_FAM_LAV = fnNotNull(rs!DescrizioneCertificazione)
    PROTOCOLLO_CERTIFICAZIONE_FAM_LAV = fnNotNull(rs!ProtocolloCertificazione)
    ENTE_CERTIFICAZIONE_FAM_LAV = fnNotNull(rs!EnteCertificazione)
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub GET_CERTIFICAZIONE_FAM_PER_ETI_CONF(IDSocio As Long, IDArticolo As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim IDFamiglia As Long


''''''RECUPERO DELLA FAMIGLIA DELL'ARTICOLO VENDUTO''''''''''''''''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT RV_PO01_IDFamigliaProdotti "
sSQL = sSQL & "FROM Articolo "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    IDFamiglia = 0
Else
    IDFamiglia = fnNotNullN(rs!RV_PO01_IDFamigliaProdotti)
End If

rs.CloseResultset
Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

If IDFamiglia = 0 Then Exit Sub

sSQL = "SELECT RV_PO01_CertificazioneSocioFamiglia.IDRV_PO01_CertificazioneSocioFamiglia, RV_PO01_CertificazioneSocioFamiglia.IDAnagrafica, "
sSQL = sSQL & "RV_PO01_CertificazioneSocioFamiglia.IDRV_PO01_FamigliaProdotti, RV_PO01_CertificazioneSocioFamiglia.IDRV_PO01_Certificazione,"
sSQL = sSQL & "RV_PO01_CertificazioneSocioFamiglia.ProtocolloCertificazione, RV_PO01_CertificazioneSocioFamiglia.Predefinito,"
sSQL = sSQL & "RV_PO01_Certificazione.CodiceCertificazione, RV_PO01_Certificazione.DescrizioneCertificazione,"
sSQL = sSQL & "RV_PO01_EnteCertificazione.EnteCertificazione "
sSQL = sSQL & "FROM RV_PO01_CertificazioneSocioFamiglia INNER JOIN "
sSQL = sSQL & "RV_PO01_Certificazione ON "
sSQL = sSQL & "RV_PO01_CertificazioneSocioFamiglia.IDRV_PO01_Certificazione = RV_PO01_Certificazione.IDRV_PO01_Certificazione LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_EnteCertificazione ON RV_PO01_Certificazione.IDRV_PO01_EnteCertificazione = RV_PO01_EnteCertificazione.IDRV_PO01_EnteCertificazione "
sSQL = sSQL & "WHERE IDRV_PO01_FamigliaProdotti=" & IDFamiglia
sSQL = sSQL & " AND IDAnagrafica=" & IDSocio
sSQL = sSQL & " AND Predefinito=" & fnNormBoolean(1)

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    CODICE_CERTIFICAZIONE_FAM_CONF = ""
    DESCRIZIONE_CERTIFICAZIONE_FAM_CONF = ""
    PROTOCOLLO_CERTIFICAZIONE_FAM_CONF = ""
    ENTE_CERTIFICAZIONE_FAM_CONF = ""
Else
    CODICE_CERTIFICAZIONE_FAM_CONF = fnNotNull(rs!CodiceCertificazione)
    DESCRIZIONE_CERTIFICAZIONE_FAM_CONF = fnNotNull(rs!DescrizioneCertificazione)
    PROTOCOLLO_CERTIFICAZIONE_FAM_CONF = fnNotNull(rs!ProtocolloCertificazione)
    ENTE_CERTIFICAZIONE_FAM_CONF = fnNotNull(rs!EnteCertificazione)
End If

rs.CloseResultset
Set rs = Nothing

End Sub
Private Sub EtichetteProPerUtenteDMTLav()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT EtichetteProPerUtenteLav FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    ETICHETTE_PRO_PER_UTENTE_DMT_LAV = fnNotNullN(rs!EtichetteProPerUtenteLav)
Else
    ETICHETTE_PRO_PER_UTENTE_DMT_LAV = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub EtichetteProPerUtenteDMTPed()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT EtichetteProPerUtentePed FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    ETICHETTE_PRO_PER_UTENTE_DMT_PED = fnNotNullN(rs!EtichetteProPerUtentePed)
Else
    ETICHETTE_PRO_PER_UTENTE_DMT_PED = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub

Private Function GET_LINK_SEZIONALE_PROT_DETT(NomeCampo As String) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT " & NomeCampo
sSQL = sSQL & " FROM RV_PO01_ParametriFiliale "
sSQL = sSQL & "WHERE IDFiliale=" & TheApp.Branch


Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_SEZIONALE_PROT_DETT = 0
Else
    GET_LINK_SEZIONALE_PROT_DETT = fnNotNullN(rs.adoColumns(NomeCampo).Value)
End If


rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_LINK_TIPO_PASSAPORTO_AZIENDA(NomeCampo As String) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT " & NomeCampo
sSQL = sSQL & " FROM RV_PO01_ParametriFiliale "
sSQL = sSQL & "WHERE IDFiliale=" & TheApp.Branch


Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_TIPO_PASSAPORTO_AZIENDA = 0
Else
    GET_LINK_TIPO_PASSAPORTO_AZIENDA = fnNotNullN(rs.adoColumns(NomeCampo).Value)
End If


rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_PERIODO_IVA_PROTOCOLLO(DataLavorazione As String) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDPeriodoIVA "
sSQL = sSQL & "FROM PeriodoIVA "
sSQL = sSQL & "WHERE Anno=" & DatePart("yyyy", DataLavorazione)


Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_PERIODO_IVA_PROTOCOLLO = 0
Else
    GET_PERIODO_IVA_PROTOCOLLO = fnNotNullN(rs!IDPeriodoIVA)
End If


rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_NUMERO_PROTOCOLLO(IDSezionale As Long, IDPeriodoIVA As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT ProgressivoDisponibile "
sSQL = sSQL & "FROM ProgressivoSezionale "
sSQL = sSQL & "WHERE IDSezionale=" & IDSezionale
sSQL = sSQL & " AND IDPeriodoIVA=" & IDPeriodoIVA

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    sSQL = "INSERT INTO ProgressivoSezionale ("
    sSQL = sSQL & "IDProgressivoSezionale, IDTipoModulo, IDPeriodoIVA, IDSezionale, "
    sSQL = sSQL & "ProgressivoDisponibile, DataUltimaVariazione, IDUtenteUltimaVariazione, "
    sSQL = sSQL & "VirtualDelete) "
    sSQL = sSQL & "VALUES ("
    sSQL = sSQL & fnGetNewKey("ProgressivoSezionale", "IDProgressivoSezionale") & ", "
    sSQL = sSQL & 1 & ", "
    sSQL = sSQL & IDPeriodoIVA & ", "
    sSQL = sSQL & IDSezionale & ", "
    sSQL = sSQL & 1 & ", "
    sSQL = sSQL & fnNormDate(Date) & ", "
    sSQL = sSQL & TheApp.IDUser & ", "
    sSQL = sSQL & 0 & ")"
    
    Cn.Execute sSQL
    GET_NUMERO_PROTOCOLLO = 1
Else
    GET_NUMERO_PROTOCOLLO = fnNotNullN(rs!ProgressivoDisponibile)
End If


rs.CloseResultset
Set rs = Nothing
End Function
Private Sub INCREMENTO_NUMERO_SEZIONALE_PROT(IDSezionale As Long, IDPeriodoIVA As Long, NumeroProgressivo As Long)
Dim sSQL As String
Dim rs As ADODB.Recordset
    sSQL = "SELECT ProgressivoDisponibile FROM ProgressivoSezionale "
    sSQL = sSQL & "WHERE IDSezionale=" & IDSezionale
    sSQL = sSQL & " AND IDPeriodoIVA=" & IDPeriodoIVA
    
    Set rs = New ADODB.Recordset
    
    rs.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic
    
    If Not rs.EOF Then
        rs!ProgressivoDisponibile = NumeroProgressivo + 1
        rs.Update
    End If
rs.Close
Set rs = Nothing
End Sub
Private Function GET_LINK_TIPO_PASS_ARTICOLO(IDArticolo As Long, IDTipoPassaportoAzienda As Long) As Long
Dim rs As DmtOleDbLib.adoResultset
Dim sSQL As String

sSQL = "SELECT RV_PO01_IDTipoPassaporto, RV_PO01_Passaporto "
sSQL = sSQL & "FROM Articolo "
sSQL = sSQL & " WHERE IDArticolo=" & IDArticolo
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_TIPO_PASS_ARTICOLO = 0
Else
    If fnNotNullN(rs!RV_PO01_Passaporto) = 0 Then
        GET_LINK_TIPO_PASS_ARTICOLO = 0
    Else
        If fnNotNullN(rs!RV_PO01_IDTipoPassaporto) > 0 Then
            GET_LINK_TIPO_PASS_ARTICOLO = fnNotNullN(rs!RV_PO01_IDTipoPassaporto)
        Else
            If IDTipoPassaportoAzienda > 0 Then
                GET_LINK_TIPO_PASS_ARTICOLO = IDTipoPassaportoAzienda
            Else
                GET_LINK_TIPO_PASS_ARTICOLO = 1
            End If
        End If
    End If
End If
rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_CONTROLLO_NUMERO_LETTERE_INTENTO(IDAnagrafica As Long, IDAzienda As Long, Anno As Long) As Long
On Error GoTo ERR_GET_CONTROLLO_NUMERO_LETTERE_INTENTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Count(IDLetteraIntento) AS NumeroRecord "
sSQL = sSQL & "FROM LetteraIntento "
sSQL = sSQL & "WHERE IDAzienda_CF=" & IDAzienda
sSQL = sSQL & " AND IDAnagrafica_CF=" & IDAnagrafica
sSQL = sSQL & " AND IDTipoAnagrafica_CF=2"
sSQL = sSQL & " AND ((Anno=" & Anno & ") OR (AnnoOperazione=" & Anno & "))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_CONTROLLO_NUMERO_LETTERE_INTENTO = 0
Else
    GET_CONTROLLO_NUMERO_LETTERE_INTENTO = fnNotNullN(rs!NumeroRecord)
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_CONTROLLO_NUMERO_LETTERE_INTENTO:
    MsgBox Err.Description, vbCritical, "GET_CONTROLLO_NUMERO_LETTERE_INTENTO"
End Function
Private Function GET_LINK_LETTERA_INTENTO(IDAnagrafica As Long, IDAzienda As Long, Anno As Long) As Long
On Error GoTo ERR_GET_LINK_LETTERA_INTENTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDLetteraIntento "
sSQL = sSQL & "FROM LetteraIntento "
sSQL = sSQL & "WHERE IDAzienda_CF=" & IDAzienda
sSQL = sSQL & " AND IDAnagrafica_CF=" & IDAnagrafica
sSQL = sSQL & " AND IDTipoAnagrafica_CF=2"
sSQL = sSQL & " AND ((Anno=" & Anno & ") OR (AnnoOperazione=" & Anno & "))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_LETTERA_INTENTO = 0
Else
    GET_LINK_LETTERA_INTENTO = fnNotNullN(rs!IDLetteraIntento)
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_LINK_LETTERA_INTENTO:
    MsgBox Err.Description, vbCritical, "GET_LINK_LETTERA_INTENTO"
End Function
Private Function GET_LINK_IVA_LETTERA_INTENTO(IDLetteraIntento As Long, IDIvaCliente As Long) As Long
On Error GoTo ERR_GET_LINK_IVA_LETTERA_INTENTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDIva "
sSQL = sSQL & "FROM LetteraIntento "
sSQL = sSQL & "WHERE IDLetteraIntento=" & IDLetteraIntento

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_IVA_LETTERA_INTENTO = IDIvaCliente
Else
    If fnNotNullN(rs!IDIva) > 0 Then
        GET_LINK_IVA_LETTERA_INTENTO = fnNotNullN(rs!IDIva)
    Else
        GET_LINK_IVA_LETTERA_INTENTO = IDIvaCliente
    End If
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_LINK_IVA_LETTERA_INTENTO:
    MsgBox Err.Description, vbCritical, "GET_LINK_IVA_LETTERA_INTENTO"
End Function

Private Function GET_LINK_IVA_CLIENTE(IDAnagrafica As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDIva "
sSQL = sSQL & "FROM Cliente "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDAnagrafica
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_IVA_CLIENTE = 0
Else
    GET_LINK_IVA_CLIENTE = fnNotNullN(rs!IDIva)
End If

rs.CloseResultset
Set rs = Nothing

Exit Function

End Function

Private Sub GET_CONFIGURAZIONE_IMPORTI_ARTICOLO(IDAnagrafica As Long, IDArticolo As Long, IDListino As Long, IDListinoAzienda As Long, Quantita As Double)
Dim ObjDoc As DmtDocs.cDocument
Dim sTabellaTestataLocal As String
Dim sTabellaDettaglioLocal As String
Dim sTabellaIVALocal As String
Dim sTabellaScadenzeLocal As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim ImportoUnitario As Double
Dim IDArticoloPadre As Long
Dim IDTipoPedana As Long
Dim NumeroCombinazioni As Long

ImportoUnitario = 0

'If PrezziDaOrdine = 1 Then
'    IDArticoloPadre = IDArticolo
'    'IDTipoPedana = GET_TIPO_PEDANA(IDPedana)
'
'    If IDArticoloPadre > 0 Then
'        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'        sSQL = "SELECT Count(IDValoriOggettoDettaglio) AS NumeroRecord "
'        sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
'        sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
'        sSQL = sSQL & " AND RV_POTipoRiga=1 "
'        sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
'        'sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
'        If GESTIONE_ORDINE_VIVAIO = 0 Then
'            If TROVA_PREZZI_NO_IMB = 0 Then
'                sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
'            End If
'        End If
'
'        sSQL = sSQL & " AND RV_PONotaRigaOrdRaggr=" & fnNormString(raggrOrdine)
'        If (TROVA_PREZZI_ORD_CAT = 1) Then
'            sSQL = sSQL & " AND RV_POIDTipoCategoria=" & IDCategoria
'        End If
'        If (TROVA_PREZZI_ORD_CAL = 1) Then
'            sSQL = sSQL & " AND RV_POIDCalibro=" & IDCalibro
'        End If
'
'        Set rs = Cn.OpenResultset(sSQL)
'
'        If rs.EOF Then
'            NumeroCombinazioni = 0
'        Else
'            NumeroCombinazioni = fnNotNullN(rs!NumeroRecord)
'        End If
'
'        rs.CloseResultset
'        Set rs = Nothing
'        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'        If NumeroCombinazioni = 1 Then
'            sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
'            sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
'            sSQL = sSQL & " AND RV_POTipoRiga=1 "
'            sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
'            'sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
'            If GESTIONE_ORDINE_VIVAIO = 0 Then
'                If TROVA_PREZZI_NO_IMB = 0 Then
'                    sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
'                End If
'            End If
'            sSQL = sSQL & " AND RV_PONotaRigaOrdRaggr=" & fnNormString(raggrOrdine)
'            If (TROVA_PREZZI_ORD_CAT = 1) Then
'                sSQL = sSQL & " AND RV_POIDTipoCategoria=" & IDCategoria
'            End If
'            If (TROVA_PREZZI_ORD_CAL = 1) Then
'                sSQL = sSQL & " AND RV_POIDCalibro=" & IDCalibro
'            End If
'            Set rs = Cn.OpenResultset(sSQL)
'
'            If Not rs.EOF Then
'                Me.txtImportoUnitarioArticolo.Value = fnNotNullN(rs!Art_prezzo_unitario_netto_IVA)
'                Me.txtImportoUnitarioListino.Value = fnNotNullN(rs!RV_POImportoUnitarioListino)
'                Me.txtSconto1.Value = fnNotNullN(rs!Art_sco_in_percentuale_1)
'                Me.txtSconto2.Value = fnNotNullN(rs!Art_sco_in_percentuale_2)
'                ImportoUnitario = Me.txtImportoUnitarioArticolo.Value
'            End If
'
'            rs.CloseResultset
'            Set rs = Nothing
'        End If
'    End If
'End If

If ImportoUnitario > 0 Then Exit Sub


Set ObjDoc = New DmtDocs.cDocument
Set ObjDoc.Connection = TheApp.Database.Connection
ObjDoc.SetTipoOggetto 2
ObjDoc.IDFunzione = 105
ObjDoc.TablesNames ObjDoc.IDTipoOggetto, sTabellaTestataLocal, sTabellaDettaglioLocal, sTabellaIVALocal, sTabellaScadenzeLocal
ObjDoc.IDAzienda = TheApp.IDFirm
ObjDoc.IDFiliale = TheApp.Branch
ObjDoc.IDAttivitaAzienda = GET_LINK_ATTIVITA_AZIENDA(TheApp.IDFirm, TheApp.Branch)
ObjDoc.IDTipoAnagrafica = 2
ObjDoc.IDUtente = TheApp.IDUser
ObjDoc.DataEmissione = Date

ObjDoc.ClearValues

ObjDoc.Tables(sTabellaDettaglioLocal).SetActiveRetail 1 'oDoc.Tables(sTabellaDettaglioLocal).NumRetails
ObjDoc.ReadDataFromCliFo IDAnagrafica
ObjDoc.Field "Doc_data", ObjDoc.DataEmissione, sTabellaTestataLocal
ObjDoc.Field "Link_Val_valuta", 9, sTabellaTestataLocal
ObjDoc.ReadDataFromArticle IDArticolo, sTabellaDettaglioLocal
ObjDoc.Field "Link_Doc_listino", IDListino, sTabellaTestataLocal
ObjDoc.Field "Link_Doc_listino_base", IDListinoAzienda, sTabellaTestataLocal

ObjDoc.ReadDataFromPriceList IDListino
ObjDoc.ReadDataFromDiscountsList

If Quantita = 0 Then
    ObjDoc.Field "Art_quantita_totale", "0,01", sTabellaDettaglioLocal
Else
    ObjDoc.Field "Art_quantita_totale", Quantita, sTabellaDettaglioLocal
End If

Me.txtImportoUnitarioArticolo.Value = fnNotNullN(ObjDoc.Field("Art_prezzo_unitario_neutro", , sTabellaDettaglioLocal))

Me.txtSconto1.Value = fnNotNullN(ObjDoc.Field("Art_sco_in_percentuale_1", , sTabellaDettaglioLocal))
Me.txtSconto2.Value = fnNotNullN(ObjDoc.Field("Art_sco_in_percentuale_2", , sTabellaDettaglioLocal))


Set ObjDoc = Nothing
End Sub
Private Sub GET_CONFIGURAZIONE_IMPORTI_IMBALLO(IDAnagrafica As Long, IDArticolo As Long, IDListino As Long, IDListinoAzienda As Long, Quantita As Double)
Dim ObjDoc As DmtDocs.cDocument
Dim sTabellaTestataLocal As String
Dim sTabellaDettaglioLocal As String
Dim sTabellaIVALocal As String
Dim sTabellaScadenzeLocal As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim ImportoUnitario As Double
Dim IDArticoloPadre As Long
Dim IDTipoPedana As Long
Dim NumeroCombinazioni As Long
Dim Link_Riga_Ordine As Long

ImportoUnitario = 0

'If PrezziDaOrdine = 1 Then
'    Link_Riga_Ordine = 0
'    IDArticoloPadre = IDArticolo
'    'IDTipoPedana = GET_TIPO_PEDANA(IDPedana)
'
'    If IDArticoloPadre > 0 Then
'        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'        sSQL = "SELECT Count(IDValoriOggettoDettaglio) AS NumeroRecord "
'        sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
'        sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
'        sSQL = sSQL & " AND RV_POTipoRiga=1 "
'        sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
'        'sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
'        If GESTIONE_ORDINE_VIVAIO = 0 Then
'            If TROVA_PREZZI_NO_IMB = 0 Then
'                sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
'            End If
'        End If
'        sSQL = sSQL & " AND RV_PONotaRigaOrdRaggr=" & fnNormString(raggrOrdine)
'        If (TROVA_PREZZI_ORD_CAT = 1) Then
'            sSQL = sSQL & " AND RV_POIDTipoCategoria=" & IDCategoria
'        End If
'        If (TROVA_PREZZI_ORD_CAL = 1) Then
'            sSQL = sSQL & " AND RV_POIDCalibro=" & IDCalibro
'        End If
'
'        Set rs = Cn.OpenResultset(sSQL)
'
'        If rs.EOF Then
'            NumeroCombinazioni = 0
'        Else
'            NumeroCombinazioni = fnNotNullN(rs!NumeroRecord)
'        End If
'
'        rs.CloseResultset
'        Set rs = Nothing
'        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'        If NumeroCombinazioni = 1 Then
'            '''''''''''''''''''TROVO IL LINK_RIGA DELL'ORDINE'''''''''''''''''''''''''''
'            sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
'            sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
'            sSQL = sSQL & " AND RV_POTipoRiga=1 "
'            sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
'            'sSQL = sSQL & " AND RV_POIDTipoPedana=" & IDTipoPedana
'            If GESTIONE_ORDINE_VIVAIO = 0 Then
'                If TROVA_PREZZI_NO_IMB = 0 Then
'                    sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
'                End If
'            End If
'            sSQL = sSQL & " AND RV_PONotaRigaOrdRaggr=" & fnNormString(raggrOrdine)
'            If (TROVA_PREZZI_ORD_CAT = 1) Then
'                sSQL = sSQL & " AND RV_POIDTipoCategoria=" & IDCategoria
'            End If
'            If (TROVA_PREZZI_ORD_CAL = 1) Then
'                sSQL = sSQL & " AND RV_POIDCalibro=" & IDCalibro
'            End If
'            Set rs = Cn.OpenResultset(sSQL)
'
'            If Not rs.EOF Then
'                Link_Riga_Ordine = fnNotNullN(rs!RV_POLinkRiga)
'            End If
'
'            rs.CloseResultset
'            Set rs = Nothing
'            ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'
'            If Link_Riga_Ordine > 0 Then
'                sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
'                sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
'                sSQL = sSQL & " AND RV_POTipoRiga=2 "
'                sSQL = sSQL & " AND RV_POLinkRiga=" & Link_Riga_Ordine
'                sSQL = sSQL & " AND Link_Art_articolo=" & IDImballo
'
'                Set rs = Cn.OpenResultset(sSQL)
'
'                If Not rs.EOF Then
'                    Me.txtImportoUnitarioImballo.Value = fnNotNullN(rs!Art_prezzo_unitario_netto_IVA)
'                    ImportoUnitario = fnNotNullN(rs!Art_prezzo_unitario_netto_IVA)
'                End If
'
'                rs.CloseResultset
'                Set rs = Nothing
'            End If
'
'        End If
'    End If
'End If

If ImportoUnitario > 0 Then Exit Sub


Set ObjDoc = New DmtDocs.cDocument
Set ObjDoc.Connection = TheApp.Database.Connection
ObjDoc.SetTipoOggetto 2
ObjDoc.IDFunzione = 105
ObjDoc.TablesNames ObjDoc.IDTipoOggetto, sTabellaTestataLocal, sTabellaDettaglioLocal, sTabellaIVALocal, sTabellaScadenzeLocal
ObjDoc.IDAzienda = TheApp.IDFirm
ObjDoc.IDFiliale = TheApp.Branch
ObjDoc.IDAttivitaAzienda = GET_LINK_ATTIVITA_AZIENDA(TheApp.IDFirm, TheApp.Branch)
ObjDoc.IDTipoAnagrafica = 2
ObjDoc.IDUtente = TheApp.IDUser
ObjDoc.DataEmissione = Date


ObjDoc.ClearValues

ObjDoc.Tables(sTabellaDettaglioLocal).SetActiveRetail 1 'oDoc.Tables(sTabellaDettaglioLocal).NumRetails
ObjDoc.ReadDataFromCliFo IDAnagrafica
ObjDoc.Field "Doc_data", ObjDoc.DataEmissione, sTabellaTestataLocal
ObjDoc.Field "Link_Val_valuta", 9, sTabellaTestataLocal
ObjDoc.ReadDataFromArticle IDArticolo, sTabellaDettaglioLocal
ObjDoc.Field "Link_Doc_listino", IDListino, sTabellaTestataLocal
ObjDoc.Field "Link_Doc_listino_base", IDListinoAzienda, sTabellaTestataLocal

ObjDoc.ReadDataFromPriceList IDListino
ObjDoc.ReadDataFromDiscountsList

If Quantita = 0 Then
    ObjDoc.Field "Art_quantita_totale", "0,01", sTabellaDettaglioLocal
Else
    ObjDoc.Field "Art_quantita_totale", Quantita, sTabellaDettaglioLocal
End If

Me.txtImportoUnitarioImballo.Value = fnNotNullN(ObjDoc.Field("Art_prezzo_unitario_neutro", , sTabellaDettaglioLocal))

Set ObjDoc = Nothing
End Sub



Private Function GET_LINK_ATTIVITA_AZIENDA(IDAzienda As Long, IDFiliale As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT AttivitaAzienda.IDAttivitaAzienda, Azienda.IDAzienda, Filiale.IDFiliale "
sSQL = sSQL & "FROM AttivitaAzienda INNER JOIN "
sSQL = sSQL & "Azienda ON AttivitaAzienda.IDAzienda = Azienda.IDAzienda INNER JOIN "
sSQL = sSQL & "Filiale ON AttivitaAzienda.IDAttivitaAzienda = Filiale.IDAttivitaAzienda "
sSQL = sSQL & "WHERE (Azienda.IDAzienda =" & IDAzienda & ") And (Filiale.IDFiliale = " & IDFiliale & ")"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_ATTIVITA_AZIENDA = 0
Else
    GET_LINK_ATTIVITA_AZIENDA = fnNotNullN(rs!IDAttivitaAzienda)
End If

rs.CloseResultset
Set rs = Nothing

End Function
Private Function GET_NUMERO_ORDINI_DA_RICERCA(IDCliente As Long, NumeroOrdine As Long, DataOrdine As String, DataPartenza As String) As Long
Dim sSQL As String
Dim sSQL_WHERE As String
Dim rs As DmtOleDbLib.adoResultset
Dim I As Long
Dim IDOrdineReturn As Long

sSQL_WHERE = ""

sSQL = "SELECT * FROM RV_POIERicercaOrdine "
sSQL = sSQL & "WHERE Doc_ordine_chiuso = 0 "
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDFiliale=" & TheApp.Branch


If Me.cdCliente.KeyFieldID > 0 Then
    sSQL = sSQL & " AND Link_nom_anagrafica=" & IDCliente
End If

If Me.txtNumeroOrdine.Value > 0 Then
    sSQL = sSQL & " AND Doc_numero=" & NumeroOrdine
End If

If Me.txtDataOrdine.Value > 0 Then
    sSQL = sSQL & " AND Doc_data=" & fnNormDate(DataOrdine)
End If
    
If Me.txtDataPartenza.Value > 0 Then
    sSQL = sSQL & " AND Doc_data_prevista_evasione=" & fnNormDate(DataPartenza)
End If

I = 0

Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    I = I + 1
    IDOrdineReturn = fnNotNullN(rs!IDOggetto)
rs.MoveNext
Wend
rs.CloseResultset
Set rs = Nothing

If I = 1 Then
    GET_NUMERO_ORDINI_DA_RICERCA = I
    Me.txtIDOrdineCliente.Value = IDOrdineReturn
Else
    GET_NUMERO_ORDINI_DA_RICERCA = I
End If

End Function
Private Function GET_CODICE_TRACCIABILITA_WEB(IDFiliale As Long) As String
On Error GoTo ERR_GET_CODICE_TRACCIABILITA_WEB
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT CodiceTraccAzienda FROM RV_POSchemaCoop "
sSQL = sSQL & " WHERE IDFiliale=" & IDFiliale
sSQL = sSQL & "  AND IDUtente=0"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_CODICE_TRACCIABILITA_WEB = ""
Else
    GET_CODICE_TRACCIABILITA_WEB = Trim(fnNotNull(rs!CodiceTraccAzienda))
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_CODICE_TRACCIABILITA_WEB:
    GET_CODICE_TRACCIABILITA_WEB = ""
End Function

Private Sub txtTaraUnitaria_Q_LostFocus()
CalcoloPesoNetto_Q
End Sub
Private Sub ParametroPrezzoMedioAutomatico()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT PrezzoMedioDaConf FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & m_App.Branch
sSQL = sSQL & " AND IDUtente=0"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    PREZZO_MEDIO_AUT = fnNotNullN(rs!PrezzoMedioDaConf)
Else
    PREZZO_MEDIO_AUT = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub

Private Sub ParametroAggiornaPrezzoMedioDaConf()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT AggiornaPrezzoMedioDaConf FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & m_App.Branch
sSQL = sSQL & " AND IDUtente=0"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    AGGIORNA_PREZZO_MEDIO = fnNotNullN(rs!AggiornaPrezzoMedioDaConf)
Else
    AGGIORNA_PREZZO_MEDIO = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub ParametroAggiornaTipoLavorazioneDaConf()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT AggiornaTipoLavDaConf FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & m_App.Branch
sSQL = sSQL & " AND IDUtente=0"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    AGGIORNA_TIPO_LAVORAZIONE = fnNotNullN(rs!AggiornaTipoLavDaConf)
Else
    AGGIORNA_TIPO_LAVORAZIONE = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub

Private Function GET_TIPO_LIQUIDAZIONE_PER_CONFERIMENTO(IDFiliale As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDRV_POTipoLiqConf,IDRV_POTipoConfLiquidazioneChiuso,IDRV_POTipoConfLiquidazioneNuovo "
sSQL = sSQL & "FROM RV_POCalcoloLiqTesta "
sSQL = sSQL & "WHERE IDFiliale=" & IDFiliale
sSQL = sSQL & " AND IDSocio=0"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    LINK_TIPO_LIQ_CONF = 1
Else
    If fnNotNullN(rs!IDRV_POTipoLiqConf) = 0 Then
        LINK_TIPO_LIQ_CONF = 1
        LINK_STATO_LIQ_CHIUSO = 0
        LINK_STATO_LIQ_NUOVO = 0
    Else
        LINK_TIPO_LIQ_CONF = fnNotNullN(rs!IDRV_POTipoLiqConf)
        LINK_STATO_LIQ_CHIUSO = fnNotNullN(rs!IDRV_POTipoConfLiquidazioneChiuso)
        LINK_STATO_LIQ_NUOVO = fnNotNullN(rs!IDRV_POTipoConfLiquidazioneNuovo)
    End If
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub ParametroMessaggioConferimentoNegativo()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT MsgConferimentoNegativo FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & m_App.Branch
sSQL = sSQL & " AND IDUtente=0"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    msg_CONFERIMENTO_NEGATIVO = fnNotNullN(rs!msgCONFERIMENTONEGATIVO)
Else
    msg_CONFERIMENTO_NEGATIVO = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub GET_MODULO_ATTIVATO(Codice As String, IdentificativoProgramma As Long)
On Error GoTo ERR_GET_MODULO_ATTIVATO

Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT Attivato, DescrizioneModulo FROM RV_POProgrammaModulo "
sSQL = sSQL & "WHERE CodiceModulo=" & fnNormString(Codice)
sSQL = sSQL & " AND IdentificazioneProgramma=" & IdentificativoProgramma

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    MODULO_ATTIVATO = 0
    MODULO_DESCRIZIONE = ""
Else
    MODULO_ATTIVATO = Abs(fnNotNullN(rs!Attivato))
    MODULO_DESCRIZIONE = fnNotNull(rs!DescrizioneModulo)
End If

rs.CloseResultset
Set rs = Nothing

Exit Sub
ERR_GET_MODULO_ATTIVATO:
    MODULO_ATTIVATO = 0
    MODULO_DESCRIZIONE = ""
End Sub
Private Function GET_TRACCIABILITA_IMBALLO(IDArticoloImballo As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT RV_POTracciabilitaImballo FROM Articolo "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticoloImballo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TRACCIABILITA_IMBALLO = 0
Else
    GET_TRACCIABILITA_IMBALLO = fnNotNullN(rs!RV_POTracciabilitaImballo)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function CREA_STRINGA_LOTTO_IMBALLO(DataDocumento As String, NumeroDocumento As String, CodiceSocio As String, NumeroProgressivo As String) As String
On Error GoTo ERR_CREA_STRINGA_LOTTO_IMBALLO
Dim Anno As String
Dim Mese As String
Dim Giorno As String
Dim CodiceSocioLocal As String
Dim NumeroDocumentoLocal As String
Dim I As Long
Dim Zeri As String

Anno = Year(DataDocumento)
Mese = Month(DataDocumento)
Giorno = Day(DataDocumento)

If Len(Mese) = 1 Then
    Mese = "0" & Mese
End If
If Len(Giorno) = 1 Then
    Giorno = "0" & Giorno
End If

Zeri = ""
For I = Len(CodiceSocio) To 4
    Zeri = Zeri & "0"
Next
CodiceSocioLocal = Zeri & CodiceSocio

Zeri = ""
For I = Len(NumeroDocumento) To 5
    Zeri = Zeri & "0"
Next
NumeroDocumentoLocal = Zeri & NumeroDocumento


CREA_STRINGA_LOTTO_IMBALLO = Anno
CREA_STRINGA_LOTTO_IMBALLO = CREA_STRINGA_LOTTO_IMBALLO & Mese
CREA_STRINGA_LOTTO_IMBALLO = CREA_STRINGA_LOTTO_IMBALLO & Giorno
CREA_STRINGA_LOTTO_IMBALLO = CREA_STRINGA_LOTTO_IMBALLO & NumeroDocumentoLocal
CREA_STRINGA_LOTTO_IMBALLO = CREA_STRINGA_LOTTO_IMBALLO & "-" & CodiceSocioLocal
CREA_STRINGA_LOTTO_IMBALLO = CREA_STRINGA_LOTTO_IMBALLO & "-" & NumeroProgressivo

Exit Function
ERR_CREA_STRINGA_LOTTO_IMBALLO:
    MsgBox Err.Description, vbCritical, "CREA_STRINGA_LOTTO_IMBALLO"
    CREA_STRINGA_LOTTO_IMBALLO = ""

End Function
Private Function GET_TRACCIA_IMBALLO(IDArticolo As Long) As Long
On Error GoTo ERR_GET_TRACCIA_IMBALLO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT RV_POTracciabilitaImballo "
sSQL = sSQL & "FROM Articolo "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TRACCIA_IMBALLO = 0
Else
    GET_TRACCIA_IMBALLO = Abs(fnNotNullN(rs!RV_POTracciabilitaImballo))
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_TRACCIA_IMBALLO:
    MsgBox Err.Description, vbCritical, "GET_TRACCIA_IMBALLO"
    GET_TRACCIA_IMBALLO = 0
End Function
Private Function GET_DESCRIZIONE_LOTTO_IMBALLO(IDLottoImballo As Long) As String
On Error GoTo ERR_GET_DESCRIZIONE_LOTTO_IMBALLO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT LottoImballo "
sSQL = sSQL & "FROM RV_POLottoImballo "
sSQL = sSQL & "WHERE IDRV_POLottoImballo=" & IDLottoImballo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_DESCRIZIONE_LOTTO_IMBALLO = ""
Else
    GET_DESCRIZIONE_LOTTO_IMBALLO = fnNotNull(rs!LottoImballo)
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_DESCRIZIONE_LOTTO_IMBALLO:
    MsgBox Err.Description, vbCritical, "GET_DESCRIZIONE_LOTTO_IMBALLO"
End Function

Private Function CREA_MODIFICA_LOTTO_IMBALLO(IDLottoImballo As Long, IDRigaConferimento As Long, IDCaricoMerceImballi As Long, IDTestaConferimento, Quantita As Double, IDTipoOggetto As Long, IDAnagrafica As Long, IDArticoloImballo As Long, DataDocumento As String, NumeroDocumento As String, CodiceSocio As String) As Long
On Error GoTo ERR_CREA_MODIFICA_LOTTO_IMBALLO
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim IDLottoReturn As Long
Dim NumeroProgressivo As Long
Dim NumeroProgressivoString As String
Dim I As Long
Dim QuantitaModificata As Double

IDLottoReturn = 0
NumeroProgressivo = GET_NUMERO_LOTTO_IMBALLO(TheApp.IDFirm)

NumeroProgressivoString = ""
For I = Len(CStr(NumeroProgressivo)) To 6
    NumeroProgressivoString = NumeroProgressivoString & "0"
Next
NumeroProgressivoString = NumeroProgressivoString & CStr(NumeroProgressivo)

sSQL = "SELECT * FROM RV_POLottoImballo "
sSQL = sSQL & "WHERE IDRV_POLottoImballo=" & IDLottoImballo

Set rs = New ADODB.Recordset
rs.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

If rs.EOF Then
    rs.AddNew
    
    rs!IDRV_POLottoImballo = fnGetNewKey("RV_POLottoImballo", "IDRV_POLottoImballo")
    rs!IDAzienda = TheApp.IDFirm
    rs!NumeroProgressivo = NumeroProgressivo
    rs!IDTipoOggetto = IDTipoOggetto
    rs!IDRV_POcaricoMercetesta = IDTestaConferimento
    If IDRigaConferimento > 0 Then
        rs!IDRV_POCaricoMerceRighe = IDRigaConferimento
    End If
    rs!IDArticoloImballo = IDArticoloImballo
    rs!LottoImballo = CREA_STRINGA_LOTTO_IMBALLO(DataDocumento, NumeroDocumento, CodiceSocio, NumeroProgressivoString)
    rs!IDAnagrafica = IDAnagrafica
    rs!QuantitaCaricata = Quantita
    rs!Giacenza = Quantita
    rs!DataCreazione = Date
Else
    QuantitaModificata = Quantita - fnNotNullN(rs!QuantitaCaricata)
    If QuantitaModificata <> 0 Then
        rs!QuantitaCaricata = Quantita
        rs!Giacenza = rs!Giacenza + QuantitaModificata
        rs!IDArticoloImballo = IDArticoloImballo
        rs!IDAnagrafica = IDAnagrafica
    End If
End If
    
rs.Update

IDLottoReturn = rs!IDRV_POLottoImballo

rs.Close
Set rs = Nothing

If IDLottoReturn > 0 Then
    If IDRigaConferimento > 0 Then
        sSQL = "UPDATE RV_POCaricoMerceRighe SET "
        sSQL = sSQL & "IDRV_POLottoImballo=" & IDLottoReturn
        sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaConferimento
        Cn.Execute sSQL
    End If
    
    'If IDCaricoMerceImballi > 0 Then
    '    sSQL = "UPDATE RV_POCaricoMerceImballi SET "
    '    sSQL = sSQL & "IDRV_POLottoImballo=" & IDLottoReturn
    '    sSQL = sSQL & "WHERE IDRV_POCaricoMerceImballi=" & IDCaricoMerceImballi
    '    Cn.Execute sSQL
    'End If
    
End If

CREA_MODIFICA_LOTTO_IMBALLO = IDLottoReturn

Exit Function
ERR_CREA_MODIFICA_LOTTO_IMBALLO:
    MsgBox Err.Description, vbCritical, "ERR_CREA_MODIFICA_LOTTO_IMBALLO"
    
End Function
Private Function GET_NUMERO_LOTTO_IMBALLO(IDAzienda As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT MAX(NumeroProgressivo) AS NumeroProgressivo "
sSQL = sSQL & "FROM RV_POLottoImballo "
sSQL = sSQL & "WHERE IDAzienda=" & IDAzienda

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_NUMERO_LOTTO_IMBALLO = 1
Else
    GET_NUMERO_LOTTO_IMBALLO = fnNotNullN(rs!NumeroProgressivo) + 1
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub CREA_RIGHE_TRACCIABILITA_IMBALLO(IDTestaConferimento As Long, IDTipoOggetto As Long, IDAnagrafica As Long, DataDocumento As String, NumeroDocumento As String, CodiceSocio As String)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDRV_POCaricoMerceRighe, IDRV_POCaricoMerceTesta, IDRV_POLottoImballo, TracciaImballo, Colli, IDImballo, TracciaImballo "
sSQL = sSQL & "FROM RV_POCaricoMerceRighe "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceTesta=" & IDTestaConferimento

Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    If ((fnNotNullN(rs!TracciaImballo) = 1)) Then 'And (fnNotNullN(rs!IDRV_POLottoImballo) = 0)) Then
        CREA_MODIFICA_LOTTO_IMBALLO fnNotNullN(rs!IDRV_POLottoImballo), fnNotNullN(rs!IDRV_POCaricoMerceRighe), 0, IDTestaConferimento, _
        fnNotNullN(rs!Colli), IDTipoOggetto, IDAnagrafica, fnNotNullN(rs!IDImballo), DataDocumento, NumeroDocumento, CodiceSocio
    End If
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub CREA_RECORDSET_LOTTI_IMBALLI(IDArticoloImballo As Long, IDTipoOggetto As Long, IDOggetto As Long, IDValoriOggettoDettaglio As Long, Optional UtilizzoEsclusivo As Long = 0)
On Error GoTo ERR_CREA_RECORDSET_LOTTI_IMBALLI
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim rsVista As ADODB.Recordset
Dim I As Long
Dim QuantitaLottoProcesso As Double

    sSQL = "SELECT * FROM RV_POLottoImballo "
    sSQL = sSQL & "WHERE IDRV_POLottoImballo=0"
    
    Set rsVista = New ADODB.Recordset
    rsVista.Open sSQL, Cn.InternalConnection
    
    If Not (rsLottoImballo Is Nothing) Then
        If rsLottoImballo.State > 0 Then
            rsLottoImballo.Close
        End If
        Set rsLottoImballo = Nothing
    End If
    
    Set rsLottoImballo = New ADODB.Recordset
    rsLottoImballo.CursorLocation = adUseClient
    
    With rsVista
        For I = 0 To rsVista.Fields.Count - 1
            Select Case rsVista.Fields(I).Type
                Case adChar, adVarChar, adVarWChar, adWChar, 201
                    rsLottoImballo.Fields.Append .Fields(I).Name, .Fields(I).Type, .Fields(I).DefinedSize, adFldIsNullable
                Case adNumeric, adBigInt, adCurrency, adDecimal, adDouble, adInteger, adLongVarBinary, adSingle
                    rsLottoImballo.Fields.Append .Fields(I).Name, adDouble, , adFldIsNullable
                Case adDate, adDBTimeStamp, adDBDate
                    rsLottoImballo.Fields.Append .Fields(I).Name, adDBDate, , adFldIsNullable
                Case adSmallInt, adBoolean
                    rsLottoImballo.Fields.Append .Fields(I).Name, adSmallInt, , adFldIsNullable
                Case Else
                    rsLottoImballo.Fields.Append .Fields(I).Name, .Fields(I).Type, .Fields(I).DefinedSize, adFldIsNullable
            End Select
        Next
        rsLottoImballo.Fields.Append "QuantitaSelezionata", adDouble, , adFldIsNullable
        rsLottoImballo.Fields.Append "Rimanenza", adDouble, , adFldIsNullable
        rsLottoImballo.Fields.Append "Registra", adSmallInt, , adFldIsNullable
        rsLottoImballo.Fields.Append "RegistraDaUtente", adSmallInt, , adFldIsNullable
        
        rsLottoImballo.Fields.Append "QuantitaMovimentata", adDouble, , adFldIsNullable
    End With
    rsVista.Close
    Set rsVista = Nothing
    
    rsLottoImballo.Open , , adOpenKeyset, adLockBatchOptimistic

    sSQL = "SELECT * FROM RV_POLottoImballo "
    sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
    If (UtilizzoEsclusivo = 1) Then
        If (IDArticoloImballo = fnNotNullN(m_Document("IDImballo").Value)) Then
            sSQL = sSQL & " AND IDRV_POCaricoMerceRighe=" & fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
            sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
        Else
            sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
            sSQL = sSQL & " AND UtilizzoEsclusivo=0"
        End If
    Else
        sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
        sSQL = sSQL & " AND UtilizzoEsclusivo=0"
    End If
    'sSQL = sSQL & " AND Giacenza>0"
    
    sSQL = sSQL & "ORDER BY DataCreazione, NumeroProgressivo"
    
    Set rs = New ADODB.Recordset
    rs.Open sSQL, Cn.InternalConnection
    
    While Not rs.EOF
        rsLottoImballo.AddNew
            For I = 0 To rs.Fields.Count - 1
                rsLottoImballo.Fields(rs.Fields(I).Name).Value = rs.Fields(I).Value
            Next
            
            QuantitaLottoProcesso = GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO(fnNotNullN(rs!IDRV_POLottoImballo), IDTipoOggetto, IDOggetto, IDValoriOggettoDettaglio, IDArticoloImballo)
            rsLottoImballo!Giacenza = rsLottoImballo!Giacenza + QuantitaLottoProcesso
            rsLottoImballo!QuantitaSelezionata = QuantitaLottoProcesso
            rsLottoImballo!Rimanenza = rsLottoImballo!Giacenza - rsLottoImballo!QuantitaSelezionata
            rsLottoImballo!QuantitaMovimentata = 0
            If QuantitaLottoProcesso = 0 Then
                rsLottoImballo!Registra = 0
            Else
                rsLottoImballo!Registra = 1
            End If
            rsLottoImballo!RegistraDaUtente = 0
        rsLottoImballo.Update
    rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
Exit Sub
ERR_CREA_RECORDSET_LOTTI_IMBALLI:
    MsgBox Err.Description, vbCritical, "CREA_RECORDSET_LOTTI_IMBALLI"
End Sub
Private Function GET_GIACENZA_LOTTO_IMBALLO(IDArticoloImballo As Long, Optional UtilizzoEsclusivo = 0) As Double
On Error GoTo ERR_GET_GIACENZA_LOTTO_IMBALLO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT SUM(Giacenza) AS TotaleGiacenza "
sSQL = sSQL & "FROM RV_POLottoImballo "
sSQL = sSQL & " WHERE IDAzienda=" & TheApp.IDFirm
If (UtilizzoEsclusivo = 1) Then
    If (IDArticoloImballo = fnNotNullN(m_Document("IDImballo").Value)) Then
        sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
        sSQL = sSQL & " AND IDRV_POCaricoMerceRighe=" & fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    Else
        sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
        sSQL = sSQL & " AND UtilizzoEsclusivo=0"
    End If
Else
    sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
    sSQL = sSQL & " AND UtilizzoEsclusivo=0"
End If

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_GIACENZA_LOTTO_IMBALLO = 0
Else
    GET_GIACENZA_LOTTO_IMBALLO = fnNotNullN(rs!TotaleGiacenza)
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_GIACENZA_LOTTO_IMBALLO:
    MsgBox Err.Description, vbCritical, "GET_GIACENZA_LOTTO_IMBALLO"
End Function
Private Function GET_LINK_LOTTO_IMBALLO_PRED(IDAzienda As Long) As Long
On Error GoTo ERR_GET_LINK_LOTTO_IMBALLO_PRED
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim IDReturn As Long
Dim IDLottoReturn As Long
Dim NumeroProgressivo As Long
Dim NumeroProgressivoString As String
Dim I As Long
Dim QuantitaModificata As Double

NumeroProgressivo = GET_NUMERO_LOTTO_IMBALLO(IDAzienda)

NumeroProgressivoString = ""
For I = Len(CStr(NumeroProgressivo)) To 6
    NumeroProgressivoString = NumeroProgressivoString & "0"
Next
NumeroProgressivoString = NumeroProgressivoString & CStr(NumeroProgressivo)


sSQL = "SELECT * FROM RV_POLottoImballo "
sSQL = sSQL & "WHERE IDAzienda=" & IDAzienda
sSQL = sSQL & " AND Sistema=1"

Set rs = New ADODB.Recordset
rs.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

If rs.EOF Then
    rs.AddNew

        IDReturn = fnGetNewKey("RV_POLottoImballo", "IDRV_POLottoImballo")
        rs!IDRV_POLottoImballo = IDReturn
        rs!IDAzienda = IDAzienda
        rs!NumeroProgressivo = NumeroProgressivo
        rs!IDTipoOggetto = 0
        rs!IDRV_POcaricoMercetesta = 0
        rs!IDRV_POCaricoMerceRighe = 0
        rs!IDArticoloImballo = 0
        rs!LottoImballo = CREA_STRINGA_LOTTO_IMBALLO(Date, "", "", NumeroProgressivoString)
        rs!IDAnagrafica = 0
        rs!QuantitaCaricata = 0
        rs!Giacenza = 0
        rs!DataCreazione = Date
        rs!Sistema = 1
        
    rs.Update
Else
    IDReturn = fnNotNullN(rs!IDRV_POLottoImballo)
End If

rs.Close
Set rs = Nothing
GET_LINK_LOTTO_IMBALLO_PRED = IDReturn
Exit Function
ERR_GET_LINK_LOTTO_IMBALLO_PRED:
    MsgBox Err.Description, vbCritical, "GET_LINK_LOTTO_IMBALLO_PRED"
End Function

Private Function GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO(IDLottoImballo As Long, IDTipoOggetto As Long, IDOggetto As Long, IDValoriOggettoDettaglio As Long, IDArticolo As Long) As Double
On Error GoTo ERR_GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT SUM(QuantitaTotale) AS QuantitaTotale "
sSQL = sSQL & "FROM Movimento "
sSQL = sSQL & "WHERE IDTipoOggetto=" & IDTipoOggetto
sSQL = sSQL & " AND IDOggetto=" & IDOggetto
sSQL = sSQL & " AND IDValoriOggettoDettaglio=" & IDValoriOggettoDettaglio
sSQL = sSQL & " AND RV_POIDLottoImballo>0"
sSQL = sSQL & " AND IDArticolo=" & IDArticolo
If IDLottoImballo > 0 Then
    sSQL = sSQL & " AND RV_POIDLottoImballo=" & IDLottoImballo
End If
Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO = 0
Else
    GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO = fnNotNullN(rs!QuantitaTotale)
End If

rs.CloseResultset
Set rs = Nothing

Exit Function
ERR_GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO:
    MsgBox Err.Description, vbCritical, "GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO"
End Function
Private Sub RIPRISTINO_LOTTI_DA_MOVIMENTO(IDOggetto As Long, IDTipoOggetto As Long, IDValoriOggettoDettaglio As Long)
On Error GoTo ERR_RIPRISTINO_LOTTI_DA_MOVIMENTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT * FROM Movimento "
sSQL = sSQL & "WHERE IDTipoOggetto=" & IDTipoOggetto
sSQL = sSQL & " AND IDOggetto=" & IDOggetto
sSQL = sSQL & " AND IDValoriOggettoDettaglio=" & IDValoriOggettoDettaglio
sSQL = sSQL & " AND RV_POIDLottoImballo>0"

Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    sSQL = "UPDATE RV_POLottoImballo SET "
    sSQL = sSQL & "Giacenza=Giacenza+" & fnNormNumber(rs!QuantitaTotale)
    sSQL = sSQL & "WHERE IDRV_POLottoImballo=" & fnNotNullN(rs!RV_POIDLottoImballo)
    Cn.Execute sSQL
    
rs.MoveNext
Wend


rs.CloseResultset
Set rs = Nothing
Exit Sub
ERR_RIPRISTINO_LOTTI_DA_MOVIMENTO:
    MsgBox Err.Description, vbCritical, "RIPRISTINO_LOTTI_DA_MOVIMENTO"
    
End Sub
Private Sub ELIMINAZIONE_LOTTO_IMBALLO(IDLottoImballo As Long)
Dim sSQL As String

sSQL = "DELETE FROM RV_POLottoImballo "
sSQL = sSQL & "WHERE IDRV_POLottoImballo=" & IDLottoImballo
Cn.Execute sSQL

End Sub
Private Function GET_CONTROLLO_MOVIMENTAZIONE_LOTTO_IMBALLO(IDLottoImballo As Long) As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim ris As Boolean
Dim NumeroRecord As Long
GET_CONTROLLO_MOVIMENTAZIONE_LOTTO_IMBALLO = False

If IDLottoImballo = 0 Then Exit Function



sSQL = "SELECT COUNT(IDMovimento) as NumeroRecord "
sSQL = sSQL & "FROM Movimento "
sSQL = sSQL & "WHERE RV_POIDLottoImballo=" & IDLottoImballo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    NumeroRecord = 0
Else
    NumeroRecord = fnNotNullN(rs!NumeroRecord)
    
End If

rs.CloseResultset
Set rs = Nothing

If NumeroRecord <= 1 Then
    GET_CONTROLLO_MOVIMENTAZIONE_LOTTO_IMBALLO = False
Else
    GET_CONTROLLO_MOVIMENTAZIONE_LOTTO_IMBALLO = True
End If

End Function
Private Function ControlloRigheMovimentateLottiImballo() As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim ris As Boolean

ris = False

sSQL = "SELECT IDRV_POLottoImballo FROM RV_POCaricoMerceRighe "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceTesta=" & fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
sSQL = sSQL & " AND IDRV_POLottoImballo>0"
Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    If ris = False Then
        If GET_CONTROLLO_MOVIMENTAZIONE_LOTTO_IMBALLO(fnNotNullN(rs!IDRV_POLottoImballo)) = True Then
            ris = True
        End If
    End If
rs.MoveNext
Wend
rs.CloseResultset
Set rs = Nothing

If ris = False Then
    sSQL = "SELECT IDRV_POLottoImballo FROM RV_POCaricoMerceImballi "
    sSQL = sSQL & "WHERE IDRV_POCaricoMerceTesta=" & fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    sSQL = sSQL & " AND IDRV_POLottoImballo>0"
    Set rs = Cn.OpenResultset(sSQL)
    
    While Not rs.EOF
        If ris = False Then
            If GET_CONTROLLO_MOVIMENTAZIONE_LOTTO_IMBALLO(fnNotNullN(rs!IDRV_POLottoImballo)) = True Then
                ris = True
            End If
        End If
    rs.MoveNext
    Wend
    rs.CloseResultset
    Set rs = Nothing
End If

ControlloRigheMovimentateLottiImballo = ris


End Function
Private Sub CREA_RECORDSET_LOTTO_IMBALLO_DELETE()
On Error GoTo ERR_CREA_RECORDSET_LOTTO_IMBALLO_DELETE

If Not (rslottoImballoDelete Is Nothing) Then
    If rslottoImballoDelete.State > 0 Then
        rslottoImballoDelete.Close
    End If
    Set rslottoImballoDelete = Nothing
End If

Set rslottoImballoDelete = New ADODB.Recordset
rslottoImballoDelete.CursorLocation = adUseClient

rslottoImballoDelete.Fields.Append "IDRV_POLottoImballo", adInteger, , adFldIsNullable

rslottoImballoDelete.Open , , adOpenKeyset, adLockPessimistic

Exit Sub
ERR_CREA_RECORDSET_LOTTO_IMBALLO_DELETE:
    MsgBox Err.Description, vbCritical, "CREA_RECORDSET_LOTTO_IMBALLO_DELETE"
    
End Sub
Private Sub DELETE_TMP_LOTTO_IMBALLO(IDLottoImballo As Long)
On Error GoTo ERR_DELETE_TMP_LOTTO_IMBALLO
rslottoImballoDelete.Filter = "IDRV_POLottoImballo=" & IDLottoImballo

If rslottoImballoDelete.EOF Then
    rslottoImballoDelete.AddNew
        rslottoImballoDelete!IDRV_POLottoImballo = IDLottoImballo
    rslottoImballoDelete.Update
End If


rslottoImballoDelete.Filter = vbNullString
Exit Sub
ERR_DELETE_TMP_LOTTO_IMBALLO:
    MsgBox Err.Description, vbCritical, "DELETE_TMP_LOTTO_IMBALLO"
    
End Sub
Private Sub DELETE_LOTTO_IMBALLO()
On Error GoTo ERR_DELETE_LOTTO_IMBALLO
If ((rslottoImballoDelete.EOF) And (rslottoImballoDelete.BOF)) Then Exit Sub

rslottoImballoDelete.MoveFirst

While Not rslottoImballoDelete.EOF
    ELIMINAZIONE_LOTTO_IMBALLO fnNotNullN(rslottoImballoDelete!IDRV_POLottoImballo)
rslottoImballoDelete.MoveNext
Wend

CREA_RECORDSET_LOTTO_IMBALLO_DELETE
Exit Sub
ERR_DELETE_LOTTO_IMBALLO:
    MsgBox Err.Description, vbCritical, "DELETE_LOTTO_IMBALLO"
End Sub
Private Sub LOTTI_IMBALLI_PER_ELIMINAZIONE(IDCaricoMerceTesta As Long)
On Error GoTo ERR_LOTTI_IMBALLI_PER_ELIMINAZIONE
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

'RIGHE DEL CONFERIMENTO
sSQL = "SELECT IDRV_POLottoImballo FROM RV_POCaricoMerceRighe "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceTesta=" & IDCaricoMerceTesta
sSQL = sSQL & " AND IDRV_POLottoImballo>0"
Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    DELETE_TMP_LOTTO_IMBALLO fnNotNullN(rs!IDRV_POLottoImballo)
rs.MoveNext
Wend
rs.CloseResultset
Set rs = Nothing

'RIGHE ALTRI IMBALLI
sSQL = "SELECT IDRV_POLottoImballo FROM RV_POCaricoMerceImballi "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceTesta=" & IDCaricoMerceTesta
sSQL = sSQL & " AND IDRV_POLottoImballo>0"
Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    DELETE_TMP_LOTTO_IMBALLO fnNotNullN(rs!IDRV_POLottoImballo)
rs.MoveNext
Wend
rs.CloseResultset
Set rs = Nothing

Exit Sub
ERR_LOTTI_IMBALLI_PER_ELIMINAZIONE:
    MsgBox Err.Description, vbCritical, "LOTTI_IMBALLI_PER_ELIMINAZIONE"
End Sub
Private Sub RECUPERO_DATI_GIACENZA_LOTTO_IMBALLO(IDArticoloImballo As Long, IDTipoOggetto As Long, IDOggetto As Long, IDValoriOggettoDettaglio As Long, Optional UtilizzoEsclusivo = 0)
Me.txtGiacLottoImballo.Value = 0
Me.txtDispLottoImballo.Value = 0
Me.cmdLottoImballo.Enabled = False

If Me.chkTracciaImballoGest.Value = vbChecked Then
    
    Me.txtGiacLottoImballo.Value = GET_GIACENZA_LOTTO_IMBALLO(IDArticoloImballo, UtilizzoEsclusivo)
    
    Me.txtDispLottoImballo.Value = Me.txtGiacLottoImballo.Value + GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO(0, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value), IDArticoloImballo)

    Me.cmdLottoImballo.Enabled = True
    
    CREA_RECORDSET_LOTTI_IMBALLI IDArticoloImballo, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value), Abs(Me.chkLottoUtilizzoEsclusivo.Value)

End If

End Sub
Private Sub GET_LOTTI_IMBALLO_PER_ETICHETTA(rstmp As ADODB.Recordset)
Dim LottiImballo As String
Dim QuantitaLottiImballo As String
Dim I As Long

LottiImballo = ""
QuantitaLottiImballo = ""

If Not ((rsLottoImballo.EOF) And (rsLottoImballo.BOF)) Then
    rsLottoImballo.Filter = "Registra=1"
    I = 1
    While Not rsLottoImballo.EOF
        If I > 1 Then
            LottiImballo = LottiImballo & "|"
            QuantitaLottiImballo = QuantitaLottiImballo & "|"
        End If
        LottiImballo = LottiImballo & fnNotNull(rsLottoImballo!LottoImballo)
        QuantitaLottiImballo = QuantitaLottiImballo & fnNotNullN(rsLottoImballo!QuantitaSelezionata)
        I = I + 1
    rsLottoImballo.MoveNext
    Wend
    
    rsLottoImballo.Filter = vbNullString
    
End If

rstmp!LottiImballo = LottiImballo
rstmp!QuantitaLottoImballo = QuantitaLottiImballo
End Sub
Private Sub ParametroGestioneOrdineVivaio()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT AttivaGestioneOrdineVivaio FROM RV_POSchemaCoop WHERE ("
sSQL = sSQL & "(IDFiliale=" & m_App.Branch & ") "
sSQL = sSQL & "AND (IDUtente=0))"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    GESTIONE_ORDINE_VIVAIO = fnNotNullN(rs!AttivaGestioneOrdineVivaio)
Else
    GESTIONE_ORDINE_VIVAIO = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Function GET_IMPORTO_IMBALLO_DA_RIGA_ORDINE(IDOggetto As Long, linkRiga As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_IMPORTO_IMBALLO_DA_RIGA_ORDINE = 0


sSQL = "SELECT IDValoriOggettoDettaglio, Art_prezzo_unitario_netto_IVA"
sSQL = sSQL & " FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & " WHERE IDOggetto=" & IDOggetto
sSQL = sSQL & " AND RV_POLinkRiga=" & linkRiga
sSQL = sSQL & " AND RV_POTipoRiga=2"

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_IMPORTO_IMBALLO_DA_RIGA_ORDINE = fnNotNullN(rs!Art_prezzo_unitario_netto_IVA)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub GET_RIEPILOGO_PESI()
On Error Resume Next

If FORM_PESI_MEDI_SHOW = True Then

    frmPesiMedi.RefreshCalcolo
        
    'Me.SetFocus
End If


End Sub
Private Sub CalcoloScarto()

    Me.txtQtaLavPrec.Value = 0

    If txtQtaDifferenza.Value > 0 Then
        Select Case Link_UnitaDiMisura_Coop_Conferimento
            Case 1
                Me.txtColli_Q.Value = Me.txtQtaDifferenza.Value + fnNotNullN(m_DocumentsLink1("Qta_UM").Value)
            Case 2
                Me.txtPesoLordo_Q.Value = Me.txtQtaDifferenza.Value + fnNotNullN(m_DocumentsLink1("Qta_UM").Value)
                CalcoloPesoNetto_Q
            Case 3
                Me.txtPesoLordo_Q.Value = Me.txtQtaDifferenza.Value + fnNotNullN(m_DocumentsLink1("Qta_UM").Value)
                CalcoloPesoNetto_Q
                'Me.txtPesoNetto_Q.Value = Me.txtQtaDifferenza.Value

            Case 4
                Me.txtTara_Q.Value = Me.txtQtaDifferenza.Value + fnNotNullN(m_DocumentsLink1("Qta_UM").Value)
            Case 5
                Me.txtPezzi_Q.Value = Me.txtQtaDifferenza.Value + fnNotNullN(m_DocumentsLink1("Qta_UM").Value)
        End Select
        
        
        
    End If

End Sub
Private Sub CalcoloScartoPrelievo()
Dim TotaleConferito As Double
Dim TotaleLavorato As Double
Dim TotaleScarto As Double
Dim TotaleLavPrec As Double
Dim TotaleDifferenza As Double
Dim TotaleDifferenzaDiff As Double

Me.txtQtaLavPrec.Value = GET_TOTALE_PRELIEVO_PREC(fnNotNullN(m_DocumentsLink1(m_DocumentsLink1.PrimaryKey).Value), fnNotNull(m_Document(m_Document.PrimaryKey).Value))

TotaleDifferenzaDiff = Me.txtQtaPrelievoQ.Value - Me.txtQtaLavPrec.Value

Select Case Link_UnitaDiMisura_Coop_Conferimento
    Case 1
        Me.txtColli_Q.Value = TotaleDifferenzaDiff
    Case 2
        Me.txtPesoLordo_Q.Value = TotaleDifferenzaDiff
        CalcoloPesoNetto_Q
    Case 3
        Me.txtPesoLordo_Q.Value = TotaleDifferenzaDiff
        CalcoloPesoNetto_Q
        'Me.txtPesoNetto_Q.Value = Me.txtQtaDifferenza.Value

    Case 4
        Me.txtTara_Q.Value = TotaleDifferenzaDiff
    Case 5
        Me.txtPezzi_Q.Value = TotaleDifferenzaDiff
End Select


End Sub
Private Function GET_TOTALE_PRELIEVO_PREC(IDRiga As Long, IDRigaConferimento)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_TOTALE_PRELIEVO_PREC = 0

sSQL = "SELECT SUM(QtaPrelevata) as SommaPrelievoPrec, SUM(Qta_UM) AS SommaQuadrataPrec "
sSQL = sSQL & "FROM RV_POLavorazione "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaConferimento
If IDRiga > 0 Then
    sSQL = sSQL & " AND IDRV_POLavorazione<>" & IDRiga
End If

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TOTALE_PRELIEVO_PREC = 0
Else
    If (IDRiga < 0) Then
        'GET_TOTALE_PRELIEVO_PREC = txtDisponibiltaLottoCaricato.Value - (Me.txtQtaDifferenza.Value + txtQtaQuadrata.Value) - fnNotNullN(rs!SommaPrelievoPrec) - fnNotNullN(rs!SommaQuadrataPrec)
        GET_TOTALE_PRELIEVO_PREC = txtDisponibiltaLottoCaricato.Value - (Me.txtQtaDifferenza.Value + fnNotNullN(rs!SommaPrelievoPrec))
    Else
        'GET_TOTALE_PRELIEVO_PREC = txtDisponibiltaLottoCaricato.Value - (Me.txtDisponibiltaLottoCaricato.Value - (fnNotNullN(m_DocumentsLink1("QtaPrelevata").Value) - fnNotNullN(m_DocumentsLink1("Qta_UM").Value)))
        GET_TOTALE_PRELIEVO_PREC = txtQtaVenduta.Value - fnNotNullN(rs!SommaPrelievoPrec) + fnNotNullN(rs!SommaQuadrataPrec)
        
    End If
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_SEQUENZA_SCARTO(IDRigaConferimento As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT COUNT(Sequenza) AS NUMERO "
sSQL = sSQL & "FROM RV_POLavorazione "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaConferimento


Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = True Then
    GET_SEQUENZA_SCARTO = 1
Else
    GET_SEQUENZA_SCARTO = fnNotNullN(rs.adoColumns("NUMERO")) + 1
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub ParametroStampeEtichettePDF()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

PERCORSO_ETICHETTE_PDF = ""
STAMPA_ETICHETTE_PDF = 0

sSQL = "SELECT StampaEtichettaPDF, PercorsoEtichettePDF FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & m_App.Branch
sSQL = sSQL & " AND IDUtente=0"

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    PERCORSO_ETICHETTE_PDF = fnNotNull(rs!PercorsoEtichettePDF)
    STAMPA_ETICHETTE_PDF = fnNotNullN(rs!StampaEtichettaPDF)
End If

rs.CloseResultset
Set rs = Nothing
End Sub



Private Sub ParametroAttivaImportoRiepConf()
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT AbilitaImportoRiepilogoConferimento FROM RV_POSchemaCoop "
sSQL = sSQL & "WHERE IDFiliale=" & m_App.Branch
sSQL = sSQL & " AND IDUtente=0"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF = False Then
    VISUALIZZA_IMPORTO_F4 = 0
Else
    VISUALIZZA_IMPORTO_F4 = 0
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Sub GET_PERC_RESO()
On Error GoTo ERR_GET_PERC_RESO
    txtPercResoQ.Value = 0
    If (Me.txtQtaPrelievoQ.Value > 0) Then
        txtPercResoQ.Value = (Me.txtQta_UM_Q.Value / Me.txtQtaPrelievoQ.Value) * 100
    Else
        If (Me.txtDisponibiltaLottoCaricato.Value > 0) Then
            txtPercResoQ.Value = (Me.txtQta_UM_Q.Value / Me.txtDisponibiltaLottoCaricato.Value) * 100
        End If
    End If

Exit Sub
ERR_GET_PERC_RESO:
    
End Sub
Private Sub CONTROLLO_MOVIMENTAZIONE(IDRigaConferimento As Long, IDAssegnazioneMerce As Long)
On Error GoTo ERR_CONTROLLO_MOVIMENTAZIONE_CONFERIMENTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim Testo As String

sSQL = "SELECT * FROM RV_POIEControlloMovLav "
sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & IDAssegnazioneMerce
sSQL = sSQL & " AND IDRV_POCaricoMerceRighe = " & IDRigaConferimento

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    Testo = "ATTENZIONE!!!" & vbCrLf
    Testo = Testo & "Alcuni movimenti della lavorazione non sono stati eseguiti." & vbCrLf
    Testo = Testo & "Salvare di nuovo la riga di lavorazione e se il problema persiste contattare l'assistenza"
    
    MsgBox Testo, vbCritical, "CONTROLLO MOVIMENTAZIONE LAVORAZIONE"
End If

rs.CloseResultset
Set rs = Nothing

Exit Sub
ERR_CONTROLLO_MOVIMENTAZIONE_CONFERIMENTO:
    MsgBox Err.Description, vbCritical, "CONTROLLO MOVIMENTAZIONE LAVORAZIONE"
End Sub
Private Sub AGGIORNA_NUMERAZIONE_ORDINE()
On Error GoTo ERR_AGGIORNA_NUMERAZIONE_ORDINE
Dim sSQL As String

sSQL = "UPDATE ValoriOggettoPerTipo000F SET "
sSQL = sSQL & "RV_PONumeroOrdinePadre=Doc_numero, "
sSQL = sSQL & "RV_PODataOrdinePadre=Doc_data, "
sSQL = sSQL & "RV_PONumeroListaPrelievo=1, "
sSQL = sSQL & "RV_POIDOrdinePadre=IDOggetto, "
sSQL = sSQL & "RV_PONumeroPedanePrelievo=0, "
sSQL = sSQL & "RV_POOrdineCompletato=0, "
sSQL = sSQL & "RV_POIDAnagraficaDestinazione=0 "
sSQL = sSQL & "WHERE (RV_POIDOrdinePadre IS NULL)"

Cn.Execute sSQL

Exit Sub
ERR_AGGIORNA_NUMERAZIONE_ORDINE:
    MsgBox Err.Description, vbCritical, "AGGIORNA_NUMERAZIONE_ORDINE"
End Sub

Private Function GET_CONFIGURAZIONE_PREZZO_DA_ORDINE(IDArticolo As Long, IDImballo As Long, IDOggettoOrdine As Long) As Boolean
On Error GoTo ERR_GET_CONFIGURAZIONE_PREZZO_DA_ORDINE
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim IDArticoloPadre As Long
Dim NumeroCombinazioni As Long
Dim Result As Boolean
Dim AttivaCursore As Boolean

    Result = False
    RETURN_SEL_PREZZO_IMB_DA_ORD = 0
    AttivaCursore = False
    
    IDArticoloPadre = IDArticolo
    
    If IDArticoloPadre > 0 Then
        '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        sSQL = "SELECT Count(IDValoriOggettoDettaglio) AS NumeroRecord "
        sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
        sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
        sSQL = sSQL & " AND RV_POTipoRiga=1 "
        sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
        If TROVA_PREZZI_NO_IMB = 0 Then
            sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
        End If
        Set rs = Cn.OpenResultset(sSQL)
        
        If rs.EOF Then
            NumeroCombinazioni = 0
        Else
            NumeroCombinazioni = fnNotNullN(rs!NumeroRecord)
        End If
        
        rs.CloseResultset
        Set rs = Nothing
        ''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        If NumeroCombinazioni = 1 Then
            sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
            sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
            sSQL = sSQL & " AND RV_POTipoRiga=1 "
            sSQL = sSQL & " AND Link_Art_articolo=" & IDArticoloPadre
            If TROVA_PREZZI_NO_IMB = 0 Then
                sSQL = sSQL & " AND RV_POIDImballo=" & IDImballo
            End If
            Set rs = Cn.OpenResultset(sSQL)
            
            If Not rs.EOF Then
                Me.txtImportoUnitarioArticolo.Value = fnNotNullN(rs!Art_prezzo_unitario_netto_IVA)
                Me.txtImportoUnitarioListino.Value = fnNotNullN(rs!RV_POImportoUnitarioListino)
                Me.txtSconto1.Value = fnNotNullN(rs!Art_sco_in_percentuale_1)
                Me.txtSconto2.Value = fnNotNullN(rs!Art_sco_in_percentuale_2)
                Me.txtRaggrOrd.Text = fnNotNull(rs!RV_PONotaRigaOrdRaggr)
                
                RECUPERO_PREZZI_DA_ORD = True
                Me.txtIDRigaOrdine.Value = fnNotNullN(rs!IDValoriOggettoDettaglio)
                RECUPERO_PREZZI_DA_ORD = False
                
                If (IDImballo = fnNotNullN(rs!RV_POIDImballo)) Then
                    If fnNotNullN(rs!RV_POLinkRiga) > 0 Then
                        RETURN_SEL_PREZZO_IMB_DA_ORD = 1
                        GET_PREZZO_IMBALLO_DA_ORDINE IDImballo, fnNotNullN(rs!RV_POLinkRiga), IDOggettoOrdine
                    End If
                Else
                    RETURN_SEL_PREZZO_IMB_DA_ORD = 0
                End If
            End If
            
            rs.CloseResultset
            Set rs = Nothing
            
            Result = True
            
        End If
        
        If NumeroCombinazioni > 1 Then
            If Screen.MousePointer = 11 Then
                Screen.MousePointer = 0
                AttivaCursore = True
            End If
            
            LINK_ARTICOLO_ORDINE = Me.CDArticolo.KeyFieldID
            LINK_ORDINE_PER_PREZZO = IDOggettoOrdine
            MODALITA_RECUPERO_RIGA_ORD = 0
            
            frmCorpoOrdine.Show vbModal
            
            If CONFERMA_SEL_PREZZO_DA_ORD = 1 Then
                Result = True
            End If
            If AttivaCursore = True Then
                Screen.MousePointer = 11
                DoEvents
            End If
        End If
    End If

    GET_CONFIGURAZIONE_PREZZO_DA_ORDINE = Result

Exit Function
ERR_GET_CONFIGURAZIONE_PREZZO_DA_ORDINE:
    MsgBox Err.Description, vbCritical, "GET_CONFIGURAZIONE_PREZZO_DA_ORDINE"
End Function

Private Sub GET_PREZZO_IMBALLO_DA_ORDINE(IDImballo As Long, linkRiga As Long, IDOggettoOrdine As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT * FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
sSQL = sSQL & " AND RV_POTipoRiga=2 "
sSQL = sSQL & " AND RV_POLinkRiga=" & linkRiga
sSQL = sSQL & " AND Link_Art_articolo=" & IDImballo

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    Me.txtImportoUnitarioImballo.Value = fnNotNullN(rs!Art_prezzo_unitario_netto_IVA)
    Me.chkPrezzoInclusoImballo.Value = Abs(fnNotNullN(rs!RV_POImportoImballoInArticolo))
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Function GET_CONTROLLO_MERCE_IN_ORDINE(IDOggettoOrdine As Long) As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim NumeroRecord As Long

GET_CONTROLLO_MERCE_IN_ORDINE = False

sSQL = "SELECT COUNT(IDValoriOggettoDettaglio) AS NumeroRecordOrdine "
sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoOrdine
sSQL = sSQL & " AND RV_POTipoRiga=1"

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    NumeroRecord = 0
Else
    NumeroRecord = fnNotNullN(rs!NumeroRecordOrdine)
End If

rs.CloseResultset
Set rs = Nothing

If NumeroRecord > 0 Then
    GET_CONTROLLO_MERCE_IN_ORDINE = True
End If

End Function
Private Sub GET_CONFEZIONI_IMBALLO_PER_ARTICOLO(IDArticoloMerce As Long, IDArticoloImballo As Long)
On Error GoTo ERR_GET_CONFEZIONI_IMBALLO_PER_ARTICOLO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim NumeroRecord As Long

Me.txtNumeroConfImballo.Value = 0
Me.txtTaraConfImballo.Value = 0

sSQL = "SELECT COUNT(IDRV_PODistintaBaseRigheConf) AS Numero "
sSQL = sSQL & "FROM RV_POIEDistintaBasaConf "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticoloMerce
sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    NumeroRecord = 0
Else
    NumeroRecord = fnNotNullN(rs!numero)
End If

rs.CloseResultset
Set rs = Nothing

If NumeroRecord = 0 Then Exit Sub

If (NumeroRecord = 1) Then
    sSQL = "SELECT *  "
    sSQL = sSQL & "FROM RV_POIEDistintaBasaConf "
    sSQL = sSQL & "WHERE IDArticolo=" & IDArticoloMerce
    sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
    
    Set rs = Cn.OpenResultset(sSQL)

    If rs.EOF Then
        Me.txtNumeroConfImballo.Value = 0
        Me.txtTaraConfImballo.Value = 0
        Me.CDImballoPrimario.Load 0
        Me.txtCostoConfezione.Value = 0
        
    Else
        Me.txtNumeroConfImballo.Value = fnNotNullN(rs!NumeroConfezioni)
        Me.txtTaraConfImballo.Value = fnNotNullN(rs!Tara)
        Me.CDImballoPrimario.Load fnNotNullN(rs!IDArticoloAssociato)
        Me.txtCostoConfezione.Value = fnNotNullN(rs!CostoConfezione)
'        If fnNotNullN(rs!PesoPerCollo) > 0 Then
'            PESO_LORDO_ARTICOLO = fnNotNullN(rs!PesoPerCollo)
'        End If
'        If fnNotNullN(rs!NumeroConfezioni) > 0 Then
'            QUANTITA_PER_COLLO = fnNotNullN(rs!NumeroConfezioni)
'            If fnNotNullN(rs!QuantitaPerConfezione) > 0 Then
'                QUANTITA_PER_COLLO = fnNotNullN(rs!QuantitaPerConfezione) * fnNotNullN(rs!NumeroConfezioni)
'            End If
'        End If
    End If
    
    rs.CloseResultset
    Set rs = Nothing
    
    
Else
    frmNumeroConf.Show vbModal
    
    'txtColli_Change
End If

Exit Sub
ERR_GET_CONFEZIONI_IMBALLO_PER_ARTICOLO:
    MsgBox Err.Description, vbCritical, "GET_CONFEZIONI_IMBALLO_PER_ARTICOLO"
End Sub
Private Sub CREA_RECORDSET_GRIGLIA_DISTINTA()
Set rsDistintaGriglia = New ADODB.Recordset
rsDistintaGriglia.CursorLocation = adUseClient

rsDistintaGriglia.Fields.Append "Selezionato", adSmallInt, , adFldIsNullable
rsDistintaGriglia.Fields.Append "IDArticolo", adInteger, , adFldIsNullable
rsDistintaGriglia.Fields.Append "IDUnitaDiMisura", adInteger, , adFldIsNullable
rsDistintaGriglia.Fields.Append "IDUnitaDiMisuraCoop", adInteger, , adFldIsNullable
rsDistintaGriglia.Fields.Append "CodiceArticolo", adVarChar, 250, adFldIsNullable
rsDistintaGriglia.Fields.Append "Articolo", adVarChar, 250, adFldIsNullable
rsDistintaGriglia.Fields.Append "UnitaDiMisura", adVarChar, 250, adFldIsNullable
rsDistintaGriglia.Fields.Append "QuantitaProcesso", adDouble, , adFldIsNullable
rsDistintaGriglia.Fields.Append "Costo", adDouble, , adFldIsNullable



rsDistintaGriglia.Open , , adOpenKeyset, adLockBatchOptimistic

Set rsDistintaReturn = New ADODB.Recordset
rsDistintaReturn.CursorLocation = adUseClient

rsDistintaReturn.Fields.Append "Selezionato", adSmallInt, , adFldIsNullable
rsDistintaReturn.Fields.Append "IDArticolo", adInteger, , adFldIsNullable
rsDistintaReturn.Fields.Append "IDUnitaDiMisura", adInteger, , adFldIsNullable
rsDistintaReturn.Fields.Append "IDUnitaDiMisuraCoop", adInteger, , adFldIsNullable
rsDistintaReturn.Fields.Append "CodiceArticolo", adVarChar, 250, adFldIsNullable
rsDistintaReturn.Fields.Append "Articolo", adVarChar, 250, adFldIsNullable
rsDistintaReturn.Fields.Append "UnitaDiMisura", adVarChar, 250, adFldIsNullable
rsDistintaReturn.Fields.Append "QuantitaProcesso", adDouble, , adFldIsNullable
rsDistintaReturn.Fields.Append "Costo", adDouble, , adFldIsNullable
rsDistintaReturn.Open , , adOpenKeyset, adLockBatchOptimistic

End Sub
Private Sub ELIMINA_RIGA_DISTINTA_ARTICOLO_IN_PROCESSO(IDRigaLavorazione As Long)
Dim sSQL As String

sSQL = "DELETE FROM RV_POAssegnazioneMerceImbPrim "
sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & IDRigaLavorazione
Cn.Execute sSQL

End Sub
Private Sub GET_DISTINTA_ARTICOLO(IDArticolo As Long, IDAssegnazioneMerceCollegato As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim AvviaScelta As Long

sSQL = "SELECT IDRV_PODistintaBase, AttivaSceltaMultipla "
sSQL = sSQL & "FROM RV_PODistintaBase "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    rs.CloseResultset
    Set rs = Nothing
    
    Exit Sub
End If

AvviaScelta = Abs(fnNotNullN(rs!AttivaSceltaMultipla))

rs.CloseResultset
Set rs = Nothing

'ELIMINA_RIGA_DISTINTA_ARTICOLO_IN_PROCESSO IDAssegnazioneMerceCollegato

CREA_RECORDSET_GRIGLIA_DISTINTA
    
    
sSQL = "SELECT * FROM RV_POIEDistintaBaseSel "
'sSQL = sSQL & " WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " WHERE IDArticoloPadre=" & IDArticolo
sSQL = sSQL & " AND ((IDArticoloImballo=0) OR (IDArticoloImballo=" & Me.CDCodiceImballo.KeyFieldID & "))"

Set rs = Cn.OpenResultset(sSQL)

If Not (rs.EOF) Then
    CREA_RECORDSET_GRIGLIA_DISTINTA
    Screen.MousePointer = 11
    While Not rs.EOF
        rsDistintaGriglia.AddNew
            rsDistintaGriglia!Selezionato = 0
            rsDistintaGriglia!IDArticolo = fnNotNullN(rs!IDArticolo)
            rsDistintaGriglia!IDUnitaDiMisura = fnNotNullN(rs!IDUnitaDiMisura)
            rsDistintaGriglia!CodiceArticolo = fnNotNull(rs!CodiceArticolo)
            rsDistintaGriglia!Articolo = fnNotNull(rs!Articolo)
            rsDistintaGriglia!UnitaDiMisura = fnNotNull(rs!UnitaDiMisura)
            rsDistintaGriglia!IDUnitaDiMisuraCoop = fnNotNullN(rs!IDUnitaDiMisuraCoop)
            
            
            
            Select Case fnNotNullN(rs!IDUnitaDiMisuraCoop)
                Case 1
                    rsDistintaGriglia!QuantitaProcesso = fnNotNullN(rs!Quantita) * Me.txtColli.Value
                Case 2
                    rsDistintaGriglia!QuantitaProcesso = fnNotNullN(rs!Quantita) * Me.txtPesoLordo.Value
                Case 3
                    rsDistintaGriglia!QuantitaProcesso = fnNotNullN(rs!Quantita) * Me.txtPesoNetto.Value
                Case 4
                    rsDistintaGriglia!QuantitaProcesso = fnNotNullN(rs!Quantita) * Me.txtTara.Value
                Case 5
                    rsDistintaGriglia!QuantitaProcesso = fnNotNullN(rs!Quantita) * Me.txtPezzi.Value
                Case Else
                    rsDistintaGriglia!QuantitaProcesso = fnNotNullN(rs!Quantita) * 1
            End Select
            
        rsDistintaGriglia.Update
    rs.MoveNext
    Wend
    Screen.MousePointer = 0
End If
    

If AvviaScelta = 0 Then
    If Not rsDistintaGriglia.EOF Then
        rsDistintaGriglia.MoveFirst
        While Not rsDistintaGriglia.EOF
                    
        
        
        rsDistintaGriglia.MoveNext
        Wend
        
    End If
    
Else
    
    'frmArtDistinta.Show vbModal
    
    If Not rsDistintaReturn.EOF Then
        rsDistintaReturn.MoveFirst
            
        rsDistintaReturn.MoveNext
        
        
    End If
    
    rsDistintaReturn.Close
    Set rsDistintaReturn = Nothing
    
    
End If

End Sub


Public Function GeneraMovimentoScaricoImballoPrim(IDRigaConferimento As Long, IDAssegnazione As Long, CodiceLottoEntrata As String, CodiceLottoCampagna As String, IDArticolo As Long, IDUMDiamante As Long, Articolo As String, Qta_UM As Double, TracciaImballo As Long) As Boolean
Dim QuantitaRimasta As Double
Dim QuantitaUtilizzata As Double
Dim sSQL As String

QuantitaRimasta = Qta_UM
    
If TracciaImballo = 1 Then
    rsLottoImballoPrim.Filter = "Giacenza>0"
    rsLottoImballoPrim.Sort = "Registra DESC, NumeroProgressivo"
    
    If Not ((rsLottoImballoPrim.EOF) And (rsLottoImballoPrim.BOF)) Then
        rsLottoImballoPrim.MoveFirst
        While Not rsLottoImballoPrim.EOF
            If QuantitaRimasta > 0 Then

                Mov.DataMovimento = Me.txtDataLavorazione.Text
                Mov.FattoreDiConversione = Null
                
                Mov.GestioneMatricole = False
                Mov.IDEsercizio = Link_Esercizio
                Mov.IDTipoOggetto = m_DocType.ID
                Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
                Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 2)
                Mov.IDUtente = TheApp.IDUser
                Mov.IDMagazzinoUscita = cboMagazzinoConf.CurrentID
                Mov.IDMagazzinoEntrata = cboMagazzinoConf.CurrentID
                Mov.Cessione = 0
                Mov.Field "IDAzienda", TheApp.IDFirm
                Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
                Mov.Field "IDTipoAnagrafica", 3
                Mov.Field "IDArticolo", IDArticolo
                Mov.Field "IDUnitaDiMisura", IDUMDiamante
                Mov.Field "IDcambio", Null
                Mov.Field "DescrizioneArticolo", Articolo
                If QuantitaRimasta > 0 Then
                    If rsLottoImballoPrim!Registra = 1 Then
                        If Me.chkConfermaDaUtentePrim.Value = Unchecked Then
                            If (QuantitaRimasta - (fnNotNullN(rsLottoImballoPrim!QuantitaSelezionata) + (fnNotNullN(rsLottoImballoPrim!Giacenza) - fnNotNullN(rsLottoImballoPrim!QuantitaSelezionata)))) <= 0 Then
                                QuantitaUtilizzata = QuantitaRimasta
                            Else
                                QuantitaUtilizzata = fnNotNullN(rsLottoImballoPrim!Giacenza) 'fnNotNullN(rsLottoImballo!QuantitaSelezionata)
                            End If
                        Else
                            If (QuantitaRimasta - fnNotNullN(rsLottoImballoPrim!QuantitaSelezionata)) <= 0 Then
                                QuantitaUtilizzata = QuantitaRimasta
                            Else
                                QuantitaUtilizzata = fnNotNullN(rsLottoImballoPrim!QuantitaSelezionata) 'fnNotNullN(rsLottoImballo!QuantitaSelezionata)
                            End If
                        End If
                    Else
                        If (QuantitaRimasta - fnNotNullN(rsLottoImballoPrim!Giacenza)) <= 0 Then
                            QuantitaUtilizzata = QuantitaRimasta
                        Else
                            QuantitaUtilizzata = fnNotNullN(rsLottoImballoPrim!Giacenza)
                        End If
                    End If

                End If
                Mov.Field "QuantitaTotale", QuantitaUtilizzata
                Mov.Field "Importo", 0
                Mov.Field "DataDocumento", Me.txtDataLavorazione.Text
                Mov.Field "Oggetto", "Lavorazione merce del " & Me.txtDataLavorazione.Text
                Mov.Field "IDTipoMovimento", 1
                
                'DATI DI CONFERIMENTO
                Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
                Mov.Field "RV_POTipoRiga", 2
                Mov.Field "RV_POIDCaricoMerceRighe", IDRigaConferimento
                Mov.Field "RV_POIDAssegnazioneMerce", IDAssegnazione
                Mov.Field "RV_POIDProcessoIVGamma", 0
                Mov.Field "RV_POIDAnagraficaSocio", fnNotNullN(m_Document("IDAnagrafica").Value)
                Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
                Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
                Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
                Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
                Mov.Field "RV_POCodiceLottoVendita", Me.txtLottoVendita.Text
                Mov.Field "RV_POQuantitaLiquidazione", 0
                Mov.Field "RV_POImportoInclusoImballo", 0
                Mov.Field "RV_POImportoLiquidazione", 0
                Mov.Field "RV_POQuantitaMovimentata", 0
                Mov.Field "RV_PONumeroColli", 0
                Mov.Field "RV_POPesoLordo", 0
                Mov.Field "RV_POPesoNetto", 0
                Mov.Field "RV_POTara", 0
                Mov.Field "RV_POQuantitaPezzi", 0
                
                Mov.Field "RV_POIDTipoDocumentoCoop", 0
                Mov.Field "RV_POIDImballo", 0
                Mov.Field "RV_POCodiceImballo", ""
                Mov.Field "RV_PODescrizioneImballo", ""
                
                Mov.Field "RV_PODataLavorazione", ""
                Mov.Field "RV_POIDTipoLavorazione", 0
                Mov.Field "RV_POIDCalibro", 0
                Mov.Field "RV_POIDTipoCategoria", 0
                Mov.Field "RV_POIDTipoLavorazioneConf", 0
                Mov.Field "RV_POPrezzoMedioConf", 0
                
                Mov.Field "RV_POIDPedana", 0
                Mov.Field "RV_POIDTipoPedana", 0
                Mov.Field "RV_POCodicePedana", ""
                Mov.Field "RV_POPesoPedana", 0
                
                Mov.Field "RV_POIDImballoPrim", 0
                Mov.Field "RV_POCodiceImballoPrim", ""
                Mov.Field "RV_PODescrizioneImballoPrim", ""
                Mov.Field "RV_PONumeroConfezioniPerImballo", 0
                Mov.Field "RV_POTaraConfezioneImballo", 0
                Mov.Field "RV_POQuantitaTotaleConfImballo", 0
                Mov.Field "RV_POCostoConfezioneImballo", 0
                
                
                Mov.Field "RV_POIDLottoImballo", fnNotNullN(rsLottoImballoPrim!IDRV_POLottoImballo)
                Mov.Field "LottoImballo", GET_DESCRIZIONE_LOTTO_IMBALLO(fnNotNullN(rsLottoImballoPrim!IDRV_POLottoImballo))
                
                Mov.Field "TipoRiga", trcNessuno
                
                Cn.BeginTrans
                
                GeneraMovimentoScaricoImballoPrim = Mov.Insert
                
                If GeneraMovimentoScaricoImballoPrim = False Then
                    Cn.RollbackTrans
                Else
                    Cn.CommitTrans
                End If
                
                QuantitaRimasta = QuantitaRimasta - QuantitaUtilizzata
                
                rsLottoImballoPrim!QuantitaMovimentata = QuantitaUtilizzata
                rsLottoImballoPrim.Update
                
                
                sSQL = "UPDATE RV_POLottoImballo SET "
                sSQL = sSQL & " Giacenza=" & fnNormNumber(rsLottoImballoPrim!Giacenza - QuantitaUtilizzata)
                sSQL = sSQL & " WHERE IDRV_POLottoImballo=" & fnNotNullN(rsLottoImballoPrim!IDRV_POLottoImballo)
                Cn.Execute sSQL
            Else
                If fnNotNullN(rsLottoImballoPrim!QuantitaSelezionata) > 0 Then
                    sSQL = "UPDATE RV_POLottoImballo SET "
                    sSQL = sSQL & " Giacenza=" & fnNormNumber(rsLottoImballoPrim!Giacenza)
                    sSQL = sSQL & " WHERE IDRV_POLottoImballo=" & fnNotNullN(rsLottoImballoPrim!IDRV_POLottoImballo)
                    Cn.Execute sSQL
                End If
            End If
        rsLottoImballoPrim.MoveNext
        Wend
    End If
End If

If QuantitaRimasta > 0 Then
    Mov.DataMovimento = Me.txtDataLavorazione.Text
    Mov.FattoreDiConversione = Null
    
    Mov.GestioneMatricole = False
    Mov.IDEsercizio = Link_Esercizio
    Mov.IDTipoOggetto = m_DocType.ID
    Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 2)
    Mov.IDUtente = TheApp.IDUser
    Mov.IDMagazzinoUscita = cboMagazzinoConf.CurrentID
    Mov.IDMagazzinoEntrata = cboMagazzinoConf.CurrentID
    Mov.Cessione = 0
    Mov.Field "IDAzienda", TheApp.IDFirm
    Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
    Mov.Field "IDTipoAnagrafica", 3
    Mov.Field "IDArticolo", IDArticolo
    Mov.Field "IDUnitaDiMisura", IDUMDiamante
    Mov.Field "IDcambio", Null
    Mov.Field "DescrizioneArticolo", Articolo
    Mov.Field "QuantitaTotale", QuantitaRimasta
    Mov.Field "Importo", 0
    Mov.Field "DataDocumento", Me.txtDataLavorazione.Text
    Mov.Field "Oggetto", "Lavorazione merce del " & Me.txtDataLavorazione.Text
    Mov.Field "IDTipoMovimento", 1
    
    'DATI DI CONFERIMENTO
    Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
    Mov.Field "RV_POTipoRiga", 2
    Mov.Field "RV_POIDCaricoMerceRighe", IDRigaConferimento
    Mov.Field "RV_POIDAssegnazioneMerce", IDAssegnazione
    Mov.Field "RV_POIDProcessoIVGamma", 0
    Mov.Field "RV_POIDAnagraficaSocio", fnNotNullN(m_Document("IDAnagrafica").Value)
    Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
    Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
    Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
    Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
    Mov.Field "RV_POCodiceLottoVendita", Me.txtLottoVendita.Text
    Mov.Field "RV_POQuantitaLiquidazione", 0
    Mov.Field "RV_POImportoInclusoImballo", 0
    Mov.Field "RV_POImportoLiquidazione", 0
    Mov.Field "RV_POQuantitaMovimentata", 0
    Mov.Field "RV_PONumeroColli", 0
    Mov.Field "RV_POPesoLordo", 0
    Mov.Field "RV_POPesoNetto", 0
    Mov.Field "RV_POTara", 0
    Mov.Field "RV_POQuantitaPezzi", 0
    
    Mov.Field "RV_POIDTipoDocumentoCoop", 0
    Mov.Field "RV_POIDImballo", 0
    Mov.Field "RV_POCodiceImballo", ""
    Mov.Field "RV_PODescrizioneImballo", ""
    
    Mov.Field "RV_PODataLavorazione", ""
    Mov.Field "RV_POIDTipoLavorazione", 0
    Mov.Field "RV_POIDCalibro", 0
    Mov.Field "RV_POIDTipoCategoria", 0
    Mov.Field "RV_POIDTipoLavorazioneConf", 0
    Mov.Field "RV_POPrezzoMedioConf", 0
    
    Mov.Field "RV_POIDPedana", 0
    Mov.Field "RV_POIDTipoPedana", 0
    Mov.Field "RV_POCodicePedana", ""
    Mov.Field "RV_POPesoPedana", 0
    
    
    Mov.Field "RV_POIDImballoPrim", 0
    Mov.Field "RV_POCodiceImballoPrim", ""
    Mov.Field "RV_PODescrizioneImballoPrim", ""
    Mov.Field "RV_PONumeroConfezioniPerImballo", 0
    Mov.Field "RV_POTaraConfezioneImballo", 0
    Mov.Field "RV_POQuantitaTotaleConfImballo", 0
    Mov.Field "RV_POCostoConfezioneImballo", 0
    
    If TracciaImballo = 1 Then
        Mov.Field "RV_POIDLottoImballo", fnNotNullN(LINK_LOTTO_IMBALLO_PRED)
        Mov.Field "LottoImballo", GET_DESCRIZIONE_LOTTO_IMBALLO(LINK_LOTTO_IMBALLO_PRED)
    Else
        Mov.Field "RV_POIDLottoImballo", 0
        Mov.Field "LottoImballo", ""
    End If
    
    Mov.Field "TipoRiga", trcNessuno
    
    Cn.BeginTrans
    
    GeneraMovimentoScaricoImballoPrim = Mov.Insert
    
    If GeneraMovimentoScaricoImballoPrim = False Then
        Cn.RollbackTrans
    Else
        Cn.CommitTrans
    End If
        
    
End If
End Function

Private Sub RECUPERO_DATI_GIACENZA_LOTTO_IMBALLO_PRIM(IDArticoloImballo As Long, IDTipoOggetto As Long, IDOggetto As Long, IDValoriOggettoDettaglio As Long)
Me.txtGiacLottoImballoPrim.Value = 0
Me.txtDispLottoImballoPrim.Value = 0
Me.cmdLottoImballoPrim.Enabled = False

If Me.chkTracciaImballoGestPrim.Value = vbChecked Then
    
    Me.txtGiacLottoImballoPrim.Value = GET_GIACENZA_LOTTO_IMBALLO(IDArticoloImballo)
    
    Me.txtDispLottoImballoPrim.Value = Me.txtGiacLottoImballoPrim.Value + GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO(0, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value), IDArticoloImballo)

    Me.cmdLottoImballoPrim.Enabled = True
    
    CREA_RECORDSET_LOTTI_IMBALLI_PRIM IDArticoloImballo, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value)

End If

End Sub
Private Sub CREA_RECORDSET_LOTTI_IMBALLI_PRIM(IDArticoloImballo As Long, IDTipoOggetto As Long, IDOggetto As Long, IDValoriOggettoDettaglio As Long)
On Error GoTo ERR_CREA_RECORDSET_LOTTI_IMBALLI
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim rsVista As ADODB.Recordset
Dim I As Long
Dim QuantitaLottoProcesso As Double

    sSQL = "SELECT * FROM RV_POLottoImballo "
    sSQL = sSQL & "WHERE IDRV_POLottoImballo=0"
    
    Set rsVista = New ADODB.Recordset
    rsVista.Open sSQL, Cn.InternalConnection
    
    If Not (rsLottoImballoPrim Is Nothing) Then
        If rsLottoImballoPrim.State > 0 Then
            rsLottoImballoPrim.Close
        End If
        Set rsLottoImballoPrim = Nothing
    End If
    
    Set rsLottoImballoPrim = New ADODB.Recordset
    rsLottoImballoPrim.CursorLocation = adUseClient
    
    With rsVista
        For I = 0 To rsVista.Fields.Count - 1
            Select Case rsVista.Fields(I).Type
                Case adChar, adVarChar, adVarWChar, adWChar, 201
                    rsLottoImballoPrim.Fields.Append .Fields(I).Name, .Fields(I).Type, .Fields(I).DefinedSize, adFldIsNullable
                Case adNumeric, adBigInt, adCurrency, adDecimal, adDouble, adInteger, adLongVarBinary, adSingle
                    rsLottoImballoPrim.Fields.Append .Fields(I).Name, adDouble, , adFldIsNullable
                Case adDate, adDBTimeStamp, adDBDate
                    rsLottoImballoPrim.Fields.Append .Fields(I).Name, adDBDate, , adFldIsNullable
                Case adSmallInt, adBoolean
                    rsLottoImballoPrim.Fields.Append .Fields(I).Name, adSmallInt, , adFldIsNullable
                Case Else
                    rsLottoImballoPrim.Fields.Append .Fields(I).Name, .Fields(I).Type, .Fields(I).DefinedSize, adFldIsNullable
            End Select
        Next
        rsLottoImballoPrim.Fields.Append "QuantitaSelezionata", adDouble, , adFldIsNullable
        rsLottoImballoPrim.Fields.Append "Rimanenza", adDouble, , adFldIsNullable
        rsLottoImballoPrim.Fields.Append "Registra", adSmallInt, , adFldIsNullable
        rsLottoImballoPrim.Fields.Append "RegistraDaUtente", adSmallInt, , adFldIsNullable
        rsLottoImballoPrim.Fields.Append "QuantitaMovimentata", adDouble, , adFldIsNullable
    End With
    
    
    rsVista.Close
    Set rsVista = Nothing
    
    rsLottoImballoPrim.Open , , adOpenKeyset, adLockBatchOptimistic

    sSQL = "SELECT * FROM RV_POLottoImballo "
    sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
    sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
    
    'sSQL = sSQL & " AND Giacenza>0"
    
    sSQL = sSQL & "ORDER BY DataCreazione, NumeroProgressivo"
    
    Set rs = New ADODB.Recordset
    rs.Open sSQL, Cn.InternalConnection
    
    While Not rs.EOF
        rsLottoImballoPrim.AddNew
            For I = 0 To rs.Fields.Count - 1
                rsLottoImballoPrim.Fields(rs.Fields(I).Name).Value = rs.Fields(I).Value
            Next
            
            QuantitaLottoProcesso = GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO(fnNotNullN(rs!IDRV_POLottoImballo), IDTipoOggetto, IDOggetto, IDValoriOggettoDettaglio, IDArticoloImballo)
            rsLottoImballoPrim!Giacenza = rsLottoImballoPrim!Giacenza + QuantitaLottoProcesso
            rsLottoImballoPrim!QuantitaSelezionata = QuantitaLottoProcesso
            rsLottoImballoPrim!Rimanenza = rsLottoImballoPrim!Giacenza - rsLottoImballoPrim!QuantitaSelezionata
            rsLottoImballoPrim!QuantitaMovimentata = 0
            If QuantitaLottoProcesso = 0 Then
                rsLottoImballoPrim!Registra = 0
            Else
                rsLottoImballoPrim!Registra = 1
            End If
            rsLottoImballoPrim!RegistraDaUtente = 0
        rsLottoImballoPrim.Update
    rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
Exit Sub
ERR_CREA_RECORDSET_LOTTI_IMBALLI:
    MsgBox Err.Description, vbCritical, "CREA_RECORDSET_LOTTI_IMBALLI"
End Sub
Private Sub CREA_RECORDSET_KIT(IDArticoloMerce, IDArticoloImballo As Long, IDArticoloConfezione, IDLavorazione As Long)
On Error GoTo ERR_CREA_RECORDSET_LOTTI_IMBALLI
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim rsVista As ADODB.Recordset
Dim I As Long
Dim QuantitaLottoProcesso As Double
Dim EsistenzaKit As Long
    
    EsistenzaKit = GET_ESISTENZA_KIT_LAVORAZIONE(IDLavorazione)

    sSQL = "SELECT * FROM RV_POIEDistintaBaseRighe "
    sSQL = sSQL & "WHERE IDRV_PODistintaBaseRighe=0"
    
    Set rsVista = New ADODB.Recordset
    rsVista.Open sSQL, Cn.InternalConnection
    
    If Not (rsKIT Is Nothing) Then
        If rsKIT.State > 0 Then
            rsKIT.Close
        End If
        Set rsKIT = Nothing
    End If
    
    Set rsKIT = New ADODB.Recordset
    rsKIT.CursorLocation = adUseClient
    
    With rsVista
        For I = 0 To rsVista.Fields.Count - 1
            Select Case rsVista.Fields(I).Type
                Case adChar, adVarChar, adVarWChar, adWChar, 201
                    rsKIT.Fields.Append .Fields(I).Name, .Fields(I).Type, .Fields(I).DefinedSize, adFldIsNullable
                Case adNumeric, adBigInt, adCurrency, adDecimal, adDouble, adInteger, adLongVarBinary, adSingle
                    rsKIT.Fields.Append .Fields(I).Name, adDouble, , adFldIsNullable
                Case adDate, adDBTimeStamp, adDBDate
                    rsKIT.Fields.Append .Fields(I).Name, adDBDate, , adFldIsNullable
                Case adSmallInt, adBoolean
                    rsKIT.Fields.Append .Fields(I).Name, adSmallInt, , adFldIsNullable
                Case Else
                    rsKIT.Fields.Append .Fields(I).Name, .Fields(I).Type, .Fields(I).DefinedSize, adFldIsNullable
            End Select
        Next
        rsKIT.Fields.Append "Selezionato", adBoolean, , adFldIsNullable
        rsKIT.Fields.Append "QuantitaTotale", adDouble, , adFldIsNullable
        rsKIT.Fields.Append "CostoTotale", adDouble, , adFldIsNullable
        rsKIT.Fields.Append "Annotazioni", adVarChar, 250, adFldIsNullable
        rsKIT.Fields.Append "GiacenzaLottoImballo", adDouble, , adFldIsNullable         'NUOVO CAMPO PER TRACC. LOTTI
        rsKIT.Fields.Append "DisponibilitaLottoImballo", adDouble, , adFldIsNullable    'NUOVO CAMPO PER TRACC. LOTTI
    End With
    
    
    rsVista.Close
    Set rsVista = Nothing
    
    rsKIT.Open , , adOpenKeyset, adLockBatchOptimistic
    
    
    If Not (rsKITLotti Is Nothing) Then
        If rsKITLotti.State > 0 Then
            rsKITLotti.Close
        End If
        Set rsKITLotti = Nothing
    End If
        
'''''CREA RECORDSET PER LOTTI IMBALLI DEI KIT''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
        
    Set rsKITLotti = New ADODB.Recordset
    rsKITLotti.CursorLocation = adUseClient
        
    sSQL = "SELECT * FROM RV_POLottoImballo "
    sSQL = sSQL & "WHERE IDRV_POLottoImballo=0"
    
    Set rsVista = New ADODB.Recordset
    rsVista.Open sSQL, Cn.InternalConnection
    
    With rsVista
        For I = 0 To rsVista.Fields.Count - 1
            Select Case rsVista.Fields(I).Type
                Case adChar, adVarChar, adVarWChar, adWChar, 201
                    rsKITLotti.Fields.Append .Fields(I).Name, .Fields(I).Type, .Fields(I).DefinedSize, adFldIsNullable
                Case adNumeric, adBigInt, adCurrency, adDecimal, adDouble, adInteger, adLongVarBinary, adSingle
                    rsKITLotti.Fields.Append .Fields(I).Name, adDouble, , adFldIsNullable
                Case adDate, adDBTimeStamp, adDBDate
                    rsKITLotti.Fields.Append .Fields(I).Name, adDBDate, , adFldIsNullable
                Case adSmallInt, adBoolean
                    rsKITLotti.Fields.Append .Fields(I).Name, adSmallInt, , adFldIsNullable
                Case Else
                    rsKITLotti.Fields.Append .Fields(I).Name, .Fields(I).Type, .Fields(I).DefinedSize, adFldIsNullable
            End Select
        Next
        rsKITLotti.Fields.Append "QuantitaSelezionata", adDouble, , adFldIsNullable
        rsKITLotti.Fields.Append "Rimanenza", adDouble, , adFldIsNullable
        rsKITLotti.Fields.Append "Registra", adSmallInt, , adFldIsNullable
        rsKITLotti.Fields.Append "RegistraDaUtente", adSmallInt, , adFldIsNullable
        rsKITLotti.Fields.Append "QuantitaMovimentata", adDouble, , adFldIsNullable
        rsKITLotti.Fields.Append "IDRV_PODistintaBaseRighe", adInteger, , adFldIsNullable
    End With
    
    rsVista.Close
    Set rsVista = Nothing
    
    rsKITLotti.Open , , adOpenKeyset, adLockBatchOptimistic
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    
    
'''''''''''''''''''''ARTICOLO DA SCARICARE SEMPRE'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    sSQL = "SELECT * FROM RV_POIEDistintaBaseRighe "
    sSQL = sSQL & "WHERE IDArticoloMerce=" & IDArticoloMerce
    sSQL = sSQL & " AND IDArticoloImballo=0"
    sSQL = sSQL & " AND IDArticoloConfezione=0"
    
    Set rs = New ADODB.Recordset
    rs.Open sSQL, Cn.InternalConnection
    
    While Not rs.EOF
        rsKIT.AddNew
            For I = 0 To rs.Fields.Count - 1
                rsKIT.Fields(rs.Fields(I).Name).Value = rs.Fields(I).Value
            Next
                    
            If ((EsistenzaKit = 0) Or (IDLavorazione <= 0)) Then
                rsKIT!Selezionato = 1
            Else
                rsKIT!Selezionato = GET_KIT_SELEZIONATO(IDLavorazione, fnNotNullN(rs!IDRV_PODistintaBaseRighe))
            End If
            
            Select Case rs!IDUnitaDiMisuraCoop
                Case 1 'Colli
                    rsKIT!QuantitaTotale = Me.txtColli.Value * fnNotNullN(rs!Quantita)
                Case 2 'PesoLordo
                    rsKIT!QuantitaTotale = Me.txtPesoLordo.Value * fnNotNullN(rs!Quantita)
                Case 3 'PesoNetto
                    rsKIT!QuantitaTotale = Me.txtPesoNetto.Value * fnNotNullN(rs!Quantita)
                Case 4 'Tara
                    rsKIT!QuantitaTotale = Me.txtTara.Value * fnNotNullN(rs!Quantita)
                Case 5 'Pezzi
                    rsKIT!QuantitaTotale = Me.txtPezzi.Value * fnNotNullN(rs!Quantita)
            End Select
            
            rsKIT!CostoTotale = rsKIT!QuantitaTotale * fnNotNullN(rs!Costo)
            rsKIT!Annotazioni = "Componente da scaricare sempre"
            rsKIT!RV_POTracciabilitaImballo = GET_TRACCIABILITA_IMBALLO(fnNotNullN(rsKIT!IDArticolo))
            If fnNotNullN(rsKIT!RV_POTracciabilitaImballo) = 1 Then
                rsKIT!GiacenzaLottoImballo = GET_GIACENZA_LOTTO_IMBALLO(fnNotNullN(rsKIT!IDArticolo))
                rsKIT!DisponibilitaLottoImballo = rsKIT!GiacenzaLottoImballo + GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO(0, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value), fnNotNullN(rsKIT!IDArticolo))
                
                CREA_RECORDSET_LOTTI_IMBALLI_KIT fnNotNullN(rsKIT!IDArticolo), m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value), fnNotNullN(rsKIT!IDRV_PODistintaBaseRighe)
            End If
        rsKIT.Update
    rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    
'''''''''''''''''''''ARTICOLO DA SCARICARE PER IL KIT'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    sSQL = "SELECT * FROM RV_POIEDistintaBaseRighe "
    sSQL = sSQL & "WHERE IDArticoloMerce=" & IDArticoloMerce
    sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
    sSQL = sSQL & " AND IDArticoloConfezione=" & IDArticoloConfezione
    
    Set rs = New ADODB.Recordset
    rs.Open sSQL, Cn.InternalConnection
    
    While Not rs.EOF
        rsKIT.AddNew
            For I = 0 To rs.Fields.Count - 1
                rsKIT.Fields(rs.Fields(I).Name).Value = rs.Fields(I).Value
            Next
            
            If ((EsistenzaKit = 0) Or (IDLavorazione <= 0)) Then
                rsKIT!Selezionato = 1
            Else
                rsKIT!Selezionato = GET_KIT_SELEZIONATO(IDLavorazione, fnNotNullN(rs!IDRV_PODistintaBaseRighe))
            End If
            
            Select Case rs!IDUnitaDiMisuraCoop
                Case 1 'Colli
                    rsKIT!QuantitaTotale = Me.txtColli.Value * fnNotNullN(rs!Quantita)
                Case 2 'PesoLordo
                    rsKIT!QuantitaTotale = Me.txtPesoLordo.Value * fnNotNullN(rs!Quantita)
                Case 3 'PesoNetto
                    rsKIT!QuantitaTotale = Me.txtPesoNetto.Value * fnNotNullN(rs!Quantita)
                Case 4 'Tara
                    rsKIT!QuantitaTotale = Me.txtTara.Value * fnNotNullN(rs!Quantita)
                Case 5 'Pezzi
                    rsKIT!QuantitaTotale = Me.txtPezzi.Value * fnNotNullN(rs!Quantita)
            End Select
            
            rsKIT!CostoTotale = rsKIT!QuantitaTotale * fnNotNullN(rs!Costo)
            rsKIT!Annotazioni = "Componente del KIT"
            rsKIT!RV_POTracciabilitaImballo = GET_TRACCIABILITA_IMBALLO(fnNotNullN(rsKIT!IDArticolo))
            If fnNotNullN(rsKIT!RV_POTracciabilitaImballo) = 1 Then
                rsKIT!GiacenzaLottoImballo = GET_GIACENZA_LOTTO_IMBALLO(fnNotNullN(rsKIT!IDArticolo))
                rsKIT!DisponibilitaLottoImballo = rsKIT!GiacenzaLottoImballo + GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO(0, m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value), fnNotNullN(rsKIT!IDArticolo))
                
                CREA_RECORDSET_LOTTI_IMBALLI_KIT fnNotNullN(rsKIT!IDArticolo), m_DocType.ID, fnNotNullN(m_Document(m_Document.PrimaryKey).Value), fnNotNullN(m_DocumentsLink(m_DocumentsLink.PrimaryKey).Value), fnNotNullN(rsKIT!IDRV_PODistintaBaseRighe)
            End If
        rsKIT.Update
    rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    
    
Exit Sub
ERR_CREA_RECORDSET_LOTTI_IMBALLI:
    MsgBox Err.Description, vbCritical, "CREA_RECORDSET_KIT"
End Sub
Private Sub SALVA_KIT(IDLavorazione As Long)
Dim sSQL As String
Dim rsNew As ADODB.Recordset

sSQL = "DELETE FROM RV_POAssegnazioneMerceImbPrim "
sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & IDLavorazione
Cn.Execute sSQL

rsKIT.Filter = "Selezionato=" & fnNormBoolean(1)

If ((rsKIT.EOF) And (rsKIT.BOF)) Then Exit Sub

rsKIT.MoveFirst

sSQL = "SELECT * FROM RV_POAssegnazioneMerceImbPrim "
sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & IDLavorazione

Set rsNew = New ADODB.Recordset
rsNew.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

While Not rsKIT.EOF
    rsNew.AddNew
        rsNew!IDRV_POAssegnazioneMerce = IDLavorazione
        rsNew!IDArticolo = fnNotNullN(rsKIT!IDArticolo)
        rsNew!Quantita = fnNotNullN(rsKIT!QuantitaTotale)
        rsNew!CostoUnitario = fnNotNullN(rsKIT!Costo)
        rsNew!IDRV_PODistintaBaseRighe = fnNotNullN(rsKIT!IDRV_PODistintaBaseRighe)
        rsNew!IDRV_PODistintaBaseRigheConf = fnNotNullN(rsKIT!IDRV_PODistintaBaseRigheConf)
        rsNew!CostoTotaleRiga = fnNotNullN(rsKIT!CostoTotale)
        rsNew!TracciaImballo = fnNotNullN(rsKIT!RV_POTracciabilitaImballo)
    rsNew.Update
rsKIT.MoveNext
Wend

rsNew.Close
Set rsNew = Nothing

rsKIT.Close
Set rsKIT = Nothing
End Sub
Public Function GeneraMovimentoScaricoKit(IDRigaConferimento As Long, IDAssegnazione As Long, CodiceLottoEntrata As String, CodiceLottoCampagna As String, TracciaImballo As Long) As Boolean
On Error GoTo ERR_GeneraMovimentoScaricoKit
Dim QuantitaRimasta As Double
Dim QuantitaUtilizzata As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim SelezionatoDaUtente As Boolean

sSQL = "SELECT * FROM RV_POIEAssegnazioneMerceImbPrim "
sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & IDAssegnazione

Set rs = Cn.OpenResultset(sSQL)

While Not rs.EOF
    
    QuantitaRimasta = fnNotNullN(rs!Quantita)
        
    If fnNotNullN(rs!TracciaImballo) = 1 Then
        
        rsKITLotti.Filter = "IDRV_PODistintaBaseRighe=" & fnNotNullN(rs!IDRV_PODistintaBaseRighe)
        rsKITLotti.Sort = "Registra DESC, NumeroProgressivo"
        
        If Not ((rsKITLotti.EOF) And (rsKITLotti.BOF)) Then
            rsKITLotti.MoveFirst
            While Not rsKITLotti.EOF
                If QuantitaRimasta > 0 Then
    
                    Mov.DataMovimento = Me.txtDataLavorazione.Text
                    Mov.FattoreDiConversione = Null
                    
                    Mov.GestioneMatricole = False
                    Mov.IDEsercizio = Link_Esercizio
                    Mov.IDTipoOggetto = m_DocType.ID
                    Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
                    Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 2)
                    Mov.IDUtente = TheApp.IDUser
                    Mov.IDMagazzinoUscita = cboMagazzinoConf.CurrentID
                    Mov.IDMagazzinoEntrata = cboMagazzinoConf.CurrentID
                    Mov.Cessione = 0
                    Mov.Field "IDAzienda", TheApp.IDFirm
                    Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
                    Mov.Field "IDTipoAnagrafica", 3
                    Mov.Field "IDArticolo", fnNotNullN(rs!IDArticolo) 'IDArticolo
                    Mov.Field "IDUnitaDiMisura", fnNotNullN(rs!IDUnitaDiMisura) ' IDUMDiamante
                    Mov.Field "IDcambio", Null
                    Mov.Field "DescrizioneArticolo", fnNotNull(rs!Articolo) ' Articolo
                    Mov.Field "Importo", 0
                    Mov.Field "DataDocumento", Me.txtDataLavorazione.Text
                    Mov.Field "Oggetto", "KIT per lavorazione merce del " & Me.txtDataLavorazione.Text
                    Mov.Field "IDTipoMovimento", 1
                    If QuantitaRimasta > 0 Then
                        If rsKITLotti!Registra = 1 Then
                            If Me.chkConfermaDaUtentePrim.Value = Unchecked Then
                                If (QuantitaRimasta - (fnNotNullN(rsKITLotti!QuantitaSelezionata) + (fnNotNullN(rsKITLotti!Giacenza) - fnNotNullN(rsKITLotti!QuantitaSelezionata)))) <= 0 Then
                                    QuantitaUtilizzata = QuantitaRimasta
                                Else
                                    QuantitaUtilizzata = fnNotNullN(rsKITLotti!Giacenza) 'fnNotNullN(rsLottoImballo!QuantitaSelezionata)
                                End If
                            Else
                                If (QuantitaRimasta - fnNotNullN(rsKITLotti!QuantitaSelezionata)) <= 0 Then
                                    QuantitaUtilizzata = QuantitaRimasta
                                Else
                                    QuantitaUtilizzata = fnNotNullN(rsKITLotti!QuantitaSelezionata) 'fnNotNullN(rsLottoImballo!QuantitaSelezionata)
                                End If
                            End If
                        Else
                            If (QuantitaRimasta - fnNotNullN(rsKITLotti!Giacenza)) <= 0 Then
                                QuantitaUtilizzata = QuantitaRimasta
                            Else
                                QuantitaUtilizzata = fnNotNullN(rsKITLotti!Giacenza)
                            End If
                        End If
    
                    End If
                    Mov.Field "QuantitaTotale", QuantitaUtilizzata
                    Mov.Field "Importo", 0
                    Mov.Field "DataDocumento", Me.txtDataLavorazione.Text
                    Mov.Field "Oggetto", "KIT per lavorazione merce del " & Me.txtDataLavorazione.Text
                    Mov.Field "IDTipoMovimento", 1
    
                    'DATI DI CONFERIMENTO
                    Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
                    Mov.Field "RV_POTipoRiga", 2
                    Mov.Field "RV_POIDCaricoMerceRighe", IDRigaConferimento
                    Mov.Field "RV_POIDAssegnazioneMerce", IDAssegnazione
                    Mov.Field "RV_POIDProcessoIVGamma", 0
                    Mov.Field "RV_POIDAnagraficaSocio", fnNotNullN(m_Document("IDAnagrafica").Value)
                    Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
                    Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
                    Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
                    Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
                    Mov.Field "RV_POCodiceLottoVendita", Me.txtLottoVendita.Text
                    Mov.Field "RV_POQuantitaLiquidazione", 0
                    Mov.Field "RV_POImportoInclusoImballo", 0
                    Mov.Field "RV_POImportoLiquidazione", 0
                    Mov.Field "RV_POQuantitaMovimentata", 0
                    Mov.Field "RV_PONumeroColli", 0
                    Mov.Field "RV_POPesoLordo", 0
                    Mov.Field "RV_POPesoNetto", 0
                    Mov.Field "RV_POTara", 0
                    Mov.Field "RV_POQuantitaPezzi", 0
    
                    Mov.Field "RV_POIDTipoDocumentoCoop", 0
                    Mov.Field "RV_POIDImballo", 0
                    Mov.Field "RV_POCodiceImballo", ""
                    Mov.Field "RV_PODescrizioneImballo", ""
    
                    Mov.Field "RV_PODataLavorazione", ""
                    Mov.Field "RV_POIDTipoLavorazione", 0
                    Mov.Field "RV_POIDCalibro", 0
                    Mov.Field "RV_POIDTipoCategoria", 0
                    Mov.Field "RV_POIDTipoLavorazioneConf", 0
                    Mov.Field "RV_POPrezzoMedioConf", 0
    
                    Mov.Field "RV_POIDPedana", 0
                    Mov.Field "RV_POIDTipoPedana", 0
                    Mov.Field "RV_POCodicePedana", ""
                    Mov.Field "RV_POPesoPedana", 0
    
                    Mov.Field "RV_POIDImballoPrim", 0
                    Mov.Field "RV_POCodiceImballoPrim", ""
                    Mov.Field "RV_PODescrizioneImballoPrim", ""
                    Mov.Field "RV_PONumeroConfezioniPerImballo", 0
                    Mov.Field "RV_POTaraConfezioneImballo", 0
                    Mov.Field "RV_POQuantitaTotaleConfImballo", 0
                    Mov.Field "RV_POCostoConfezioneImballo", 0
    
    
                    Mov.Field "RV_POIDLottoImballo", fnNotNullN(rsKITLotti!IDRV_POLottoImballo)
                    Mov.Field "LottoImballo", GET_DESCRIZIONE_LOTTO_IMBALLO(fnNotNullN(rsKITLotti!IDRV_POLottoImballo))
    
                    Mov.Field "TipoRiga", trcNessuno
    
                    Cn.BeginTrans
    
                    GeneraMovimentoScaricoKit = Mov.Insert
                    
                    If GeneraMovimentoScaricoKit = False Then
                        Cn.RollbackTrans
                    Else
                        Cn.CommitTrans
                    End If
    
                    QuantitaRimasta = QuantitaRimasta - QuantitaUtilizzata
    
                    rsKITLotti!QuantitaMovimentata = QuantitaUtilizzata
                    rsKITLotti.Update
    
    
                    sSQL = "UPDATE RV_POLottoImballo SET "
                    sSQL = sSQL & " Giacenza=" & fnNormNumber(rsKITLotti!Giacenza - QuantitaUtilizzata)
                    sSQL = sSQL & " WHERE IDRV_POLottoImballo=" & fnNotNullN(rsKITLotti!IDRV_POLottoImballo)
                    Cn.Execute sSQL
                Else
                    If fnNotNullN(rsLottoImballoPrim!QuantitaSelezionata) > 0 Then
                        sSQL = "UPDATE RV_POLottoImballo SET "
                        sSQL = sSQL & " Giacenza=" & fnNormNumber(rsKITLotti!Giacenza)
                        sSQL = sSQL & " WHERE IDRV_POLottoImballo=" & fnNotNullN(rsKITLotti!IDRV_POLottoImballo)
                        Cn.Execute sSQL
                    End If
                End If
            rsKITLotti.MoveNext
            Wend
            rsKITLotti.Filter = vbNullString
        End If
    End If


    
    
    If QuantitaRimasta > 0 Then
        Mov.DataMovimento = Me.txtDataLavorazione.Text
        Mov.FattoreDiConversione = Null
        
        Mov.GestioneMatricole = False
        Mov.IDEsercizio = Link_Esercizio
        Mov.IDTipoOggetto = m_DocType.ID
        Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
        Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 2)
        Mov.IDUtente = TheApp.IDUser
        Mov.IDMagazzinoUscita = cboMagazzinoConf.CurrentID
        Mov.IDMagazzinoEntrata = cboMagazzinoConf.CurrentID
        Mov.Cessione = 0
        Mov.Field "IDAzienda", TheApp.IDFirm
        Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
        Mov.Field "IDTipoAnagrafica", 3
        Mov.Field "IDArticolo", fnNotNullN(rs!IDArticolo) 'IDArticolo
        Mov.Field "IDUnitaDiMisura", fnNotNullN(rs!IDUnitaDiMisura) ' IDUMDiamante
        Mov.Field "IDcambio", Null
        Mov.Field "DescrizioneArticolo", fnNotNull(rs!Articolo) ' Articolo
        Mov.Field "QuantitaTotale", QuantitaRimasta
        Mov.Field "Importo", 0
        Mov.Field "DataDocumento", Me.txtDataLavorazione.Text
        Mov.Field "Oggetto", "KIT per lavorazione merce del " & Me.txtDataLavorazione.Text
        Mov.Field "IDTipoMovimento", 1
        
        'DATI DI CONFERIMENTO
        Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
        Mov.Field "RV_POTipoRiga", 2
        Mov.Field "RV_POIDCaricoMerceRighe", IDRigaConferimento
        Mov.Field "RV_POIDAssegnazioneMerce", IDAssegnazione
        Mov.Field "RV_POIDProcessoIVGamma", 0
        Mov.Field "RV_POIDAnagraficaSocio", fnNotNullN(m_Document("IDAnagrafica").Value)
        Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
        Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
        Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
        Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
        Mov.Field "RV_POCodiceLottoVendita", Me.txtLottoVendita.Text
        Mov.Field "RV_POQuantitaLiquidazione", 0
        Mov.Field "RV_POImportoInclusoImballo", 0
        Mov.Field "RV_POImportoLiquidazione", 0
        Mov.Field "RV_POQuantitaMovimentata", 0
        Mov.Field "RV_PONumeroColli", 0
        Mov.Field "RV_POPesoLordo", 0
        Mov.Field "RV_POPesoNetto", 0
        Mov.Field "RV_POTara", 0
        Mov.Field "RV_POQuantitaPezzi", 0
        
        Mov.Field "RV_POIDTipoDocumentoCoop", 0
        Mov.Field "RV_POIDImballo", 0
        Mov.Field "RV_POCodiceImballo", ""
        Mov.Field "RV_PODescrizioneImballo", ""
        
        Mov.Field "RV_PODataLavorazione", ""
        Mov.Field "RV_POIDTipoLavorazione", 0
        Mov.Field "RV_POIDCalibro", 0
        Mov.Field "RV_POIDTipoCategoria", 0
        Mov.Field "RV_POIDTipoLavorazioneConf", 0
        Mov.Field "RV_POPrezzoMedioConf", 0
        
        Mov.Field "RV_POIDPedana", 0
        Mov.Field "RV_POIDTipoPedana", 0
        Mov.Field "RV_POCodicePedana", ""
        Mov.Field "RV_POPesoPedana", 0
        
        Mov.Field "RV_POIDImballoPrim", 0
        Mov.Field "RV_POCodiceImballoPrim", ""
        Mov.Field "RV_PODescrizioneImballoPrim", ""
        Mov.Field "RV_PONumeroConfezioniPerImballo", 0
        Mov.Field "RV_POTaraConfezioneImballo", 0
        Mov.Field "RV_POQuantitaTotaleConfImballo", 0
        Mov.Field "RV_POCostoConfezioneImballo", 0
        
        If fnNotNullN(rs!TracciaImballo) = 1 Then
            Mov.Field "RV_POIDLottoImballo", fnNotNullN(LINK_LOTTO_IMBALLO_PRED)
            Mov.Field "LottoImballo", GET_DESCRIZIONE_LOTTO_IMBALLO(LINK_LOTTO_IMBALLO_PRED)
        Else
            Mov.Field "RV_POIDLottoImballo", 0
            Mov.Field "LottoImballo", ""
        End If
        
        Mov.Field "TipoRiga", trcNessuno
        
        Cn.BeginTrans
        
        GeneraMovimentoScaricoKit = Mov.Insert
        
        If GeneraMovimentoScaricoKit = False Then
            Cn.RollbackTrans
        Else
            Cn.CommitTrans
        End If
            
        
    End If
    

rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GeneraMovimentoScaricoKit:
    MsgBox Err.Description, vbCritical, "GeneraMovimentoScaricoKit"
End Function

Private Function GET_KIT_SELEZIONATO(IDLavorazione As Long, IDDistintaBaseRighe As Long) As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_KIT_SELEZIONATO = True

sSQL = "SELECT ID FROM RV_POAssegnazioneMerceImbPrim "
sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & IDLavorazione
sSQL = sSQL & " AND IDRV_PODistintaBaseRighe=" & IDDistintaBaseRighe

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
   GET_KIT_SELEZIONATO = False
End If

rs.CloseResultset
Set rs = Nothing
End Function

Private Function GET_ESISTENZA_KIT_LAVORAZIONE(IDLavorazione As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_ESISTENZA_KIT_LAVORAZIONE = 0

sSQL = "SELECT COUNT(ID) as NumeroRecord "
sSQL = sSQL & " FROM RV_POAssegnazioneMerceImbPrim "
sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & IDLavorazione

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
   GET_ESISTENZA_KIT_LAVORAZIONE = 0
Else
   GET_ESISTENZA_KIT_LAVORAZIONE = fnNotNullN(rs!NumeroRecord)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub DELETE_KIT(IDLavorazione As Long)
On Error GoTo ERR_DELETE_KIT
Dim sSQL As String

sSQL = "DELETE FROM RV_POAssegnazioneMerceImbPrim "
sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & IDLavorazione
Cn.Execute sSQL

Exit Sub
ERR_DELETE_KIT:
    MsgBox Err.Description, vbCritical, "DELETE_KIT"
End Sub

Private Sub GET_IMBALLO_PER_ARTICOLO_CONF(IDArticoloMerce As Long)
On Error GoTo ERR_GET_IMBALLO_PER_ARTICOLO_CONF
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim NumeroRecord As Long

sSQL = "SELECT IDArticoloImballo, COUNT(IDRV_PODistintaBaseRigheConf) AS Numero "
sSQL = sSQL & "FROM RV_POIEDistintaBasaConf "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticoloMerce
sSQL = sSQL & " GROUP BY IDArticoloImballo "

Set rs = Cn.OpenResultset(sSQL)

NumeroRecord = 0

While Not rs.EOF
    NumeroRecord = NumeroRecord + 1
rs.MoveNext
Wend

rs.CloseResultset
Set rs = Nothing

If NumeroRecord = 0 Then Exit Sub

If (NumeroRecord = 1) Then
    sSQL = "SELECT IDArticoloImballo  "
    sSQL = sSQL & "FROM RV_POIEDistintaBasaConf "
    sSQL = sSQL & "WHERE IDArticolo=" & IDArticoloMerce
    sSQL = sSQL & " GROUP BY IDArticoloImballo "
    
    Set rs = Cn.OpenResultset(sSQL)

    If rs.EOF Then
        Me.CDCodiceImballo.Load 0
    Else
        Me.CDCodiceImballo.Load fnNotNullN(rs!IDArticoloImballo)
    End If
    
    rs.CloseResultset
    Set rs = Nothing
Else
    frmImballoPerArt.Show vbModal
End If

Exit Sub
ERR_GET_IMBALLO_PER_ARTICOLO_CONF:
    MsgBox Err.Description, vbCritical, "GET_IMBALLO_PER_ARTICOLO_CONF"
End Sub

Private Function GET_ORDINE_DA_RIGA_ORD(IDRigaOrdine As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim IDOggettoDaDettaglio As Long

GET_ORDINE_DA_RIGA_ORD = 0

sSQL = "SELECT IDOggetto "
sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & "WHERE IDValoriOggettoDettaglio=" & IDRigaOrdine

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    IDOggettoDaDettaglio = 0
Else
    IDOggettoDaDettaglio = fnNotNullN(rs!IDOggetto)
End If

rs.CloseResultset
Set rs = Nothing

If IDOggettoDaDettaglio = 0 Then Exit Function



sSQL = "SELECT RV_POIDOrdinePadre "
sSQL = sSQL & "FROM ValoriOggettoPerTipo000F "
sSQL = sSQL & "WHERE IDOggetto=" & IDOggettoDaDettaglio

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_ORDINE_DA_RIGA_ORD = 0
Else
    GET_ORDINE_DA_RIGA_ORD = fnNotNullN(rs!RV_POIDOrdinePadre)
End If

rs.CloseResultset
Set rs = Nothing
End Function

Private Function GET_TIPO_ORDINE(IDTipoOrdine As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT * FROM RV_POTipoOrdine "
sSQL = sSQL & "WHERE IDRV_POTipoOrdine=" & IDTipoOrdine

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_TIPO_ORDINE = ""
Else
    GET_TIPO_ORDINE = fnNotNull(rs!TipoOrdine)
End If


rs.CloseResultset
Set rs = Nothing
End Function
Private Sub GET_IMBALLO_PRIM_CODICE_A_BARRE_CLIENTE(IDAnagrafica As Long, IDArticolo As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT CodiceABarre, DescrizioneCodiceABarre "
sSQL = sSQL & "FROM RV_POConfigurazioneClienteEAN13 "
sSQL = sSQL & "WHERE IDAnagrafica=" & IDAnagrafica
sSQL = sSQL & " AND IDArticolo=" & IDArticolo
sSQL = sSQL & " AND IDAzienda=" & TheApp.IDFirm

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    COD_A_BARRE_IMB_PRIM_CLI = ""
    DESCR_A_BARRE_IMB_PRIM_CLI = ""
Else
    COD_A_BARRE_IMB_PRIM_CLI = fnNotNull(rs!CodiceABarre)
    DESCR_A_BARRE_IMB_PRIM_CLI = fnNotNull(rs!DescrizioneCodiceABarre)
End If


rs.CloseResultset
Set rs = Nothing
End Sub

Private Sub StampaEtichettaPDF(rpt As CRAXDRT.Report)
On Error GoTo ERR_StampaEtichettaPDF
Dim NomeFile As String
Dim Orario As String
Dim rs As ADODB.Recordset
Dim sSQL As String

''DATA CONFERIMENTO
''NUMERO CONFERIMENTO
''CODICE ARTICOLO CONFERITO
''DATA E ORA STAMPA

If STAMPA_ETICHETTE_PDF = 0 Then Exit Sub
If Len(Trim(PERCORSO_ETICHETTE_PDF)) = 0 Then Exit Sub

NomeFile = ""
Orario = Now
NomeFile = GET_FORMATTA_DATA_PDF(fnNotNull(m_Document("DataDocumento").Value), False)
NomeFile = NomeFile + "_" + GET_FORMATTA_NUMERO_PDF(fnNotNullN(m_Document("NumeroDocumento").Value))
NomeFile = NomeFile + "_" + fnNotNull(m_Document("CodiceArticolo").Value)
NomeFile = NomeFile + "__" + Me.CDArticolo.Code
NomeFile = NomeFile + "_" + GET_FORMATTA_DATA_PDF(Orario, True)

rpt.ExportOptions.PDFExportAllPages = True
rpt.ExportOptions.DiskFileName = PERCORSO_ETICHETTE_PDF + "\" + NomeFile + ".pdf"
rpt.ExportOptions.DestinationType = crEDTDiskFile
rpt.ExportOptions.FormatType = crEFTPortableDocFormat

rpt.Export False

sSQL = "SELECT * FROM RV_POCaricoMerceRigheEtichettePDF "
sSQL = sSQL & " WHERE ID=0"
Set rs = New ADODB.Recordset
rs.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

rs.AddNew
    rs!IDRV_POCaricoMerceRighe = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    rs!orastampa = Orario
    rs!NomeFile = NomeFile
    rs!IDUtente = TheApp.IDUser
rs.Update

rs.Close
Set rs = Nothing

Exit Sub
ERR_StampaEtichettaPDF:
    MsgBox Err.Description, vbCritical, "StampaEtichettaPDF"
End Sub
Private Sub StampaEtichettaPDF_DMT(rpt As dmtReportLib.dmtReport)
On Error GoTo ERR_StampaEtichettaPDF
Dim NomeFile As String
Dim Orario As String
Dim rs As ADODB.Recordset
Dim sSQL As String

''DATA CONFERIMENTO
''NUMERO CONFERIMENTO
''CODICE ARTICOLO CONFERITO
''DATA E ORA STAMPA

If STAMPA_ETICHETTE_PDF = 0 Then Exit Sub
If Len(Trim(PERCORSO_ETICHETTE_PDF)) = 0 Then Exit Sub

NomeFile = ""
Orario = Now
NomeFile = GET_FORMATTA_DATA_PDF(fnNotNull(m_Document("DataDocumento").Value), False)
NomeFile = NomeFile + "_" + GET_FORMATTA_NUMERO_PDF(fnNotNullN(m_Document("NumeroDocumento").Value))
NomeFile = NomeFile + "_" + fnNotNull(m_Document("CodiceArticolo").Value)
NomeFile = NomeFile + "__" + Me.CDArticolo.Code
NomeFile = NomeFile + "_" + GET_FORMATTA_DATA_PDF(Orario, True)

rpt.ExportFileName = PERCORSO_ETICHETTE_PDF + "\" + NomeFile + ".pdf"
rpt.ShowExportFile = False
rpt.Export recPDF

sSQL = "SELECT * FROM RV_POCaricoMerceRigheEtichettePDF "
sSQL = sSQL & " WHERE ID=0"
Set rs = New ADODB.Recordset
rs.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic

rs.AddNew
    rs!IDRV_POCaricoMerceRighe = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
    rs!orastampa = Orario
    rs!NomeFile = NomeFile
    rs!IDUtente = TheApp.IDUser
rs.Update

rs.Close
Set rs = Nothing

Exit Sub
ERR_StampaEtichettaPDF:
    MsgBox Err.Description, vbCritical, "StampaEtichettaPDF"
End Sub


Private Function GET_FORMATTA_DATA_PDF(data As String, StampaOra As Boolean) As String

Dim Anno As String
Dim Mese As String
Dim Giorno As String
Dim Ora As String
Dim Minuto As String
Dim Secondi As String

Anno = Year(data)
Mese = Month(data)
Giorno = Day(data)

Ora = Hour(data)
Minuto = Minute(data)
Secondi = Second(data)

If (Len(Mese) = 1) Then Mese = "0" + Mese
If (Len(Giorno) = 1) Then Giorno = "0" + Giorno
If (Len(Ora) = 1) Then Ora = "0" + Ora
If (Len(Minuto) = 1) Then Minuto = "0" + Minuto
If (Len(Secondi) = 1) Then Secondi = "0" + Secondi

GET_FORMATTA_DATA_PDF = Anno + Mese + Giorno

If (StampaOra = True) Then
    
    GET_FORMATTA_DATA_PDF = GET_FORMATTA_DATA_PDF + Ora + Minuto + Secondi
End If

End Function

Private Function GET_FORMATTA_NUMERO_PDF(numero As Long) As String
Dim I As Long
Dim NumeroZeri As String
NumeroZeri = ""

If Len(CStr(numero)) < 6 Then
    For I = Len(CStr(numero)) To 6
        NumeroZeri = NumeroZeri + "0"
    Next
    GET_FORMATTA_NUMERO_PDF = NumeroZeri + CStr(numero)
    
Else
    GET_FORMATTA_NUMERO_PDF = numero
End If

End Function
Private Function GET_PESO_MERCE_IN_CONF(IDArticoloMerce As Long, IDArticoloImballo As Long, IDArticoloConfezione As Long) As Double
On Error GoTo ERR_GET_PESO_MERCE_IN_CONF
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_PESO_MERCE_IN_CONF = 0

sSQL = "SELECT *  "
sSQL = sSQL & " FROM RV_POIEDistintaBasaConf "
sSQL = sSQL & " WHERE IDArticolo=" & IDArticoloMerce
sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
sSQL = sSQL & " AND IDArticoloAssociato=" & IDArticoloConfezione

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_PESO_MERCE_IN_CONF = fnNotNullN(rs!PesoPerCollo)
    If GET_PESO_MERCE_IN_CONF > 0 Then TIPO_PESO_ARTICOLO = 2
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_PESO_MERCE_IN_CONF:
    MsgBox Err.Description, vbCritical, "GET_PESO_MERCE_IN_CONF"
End Function
Private Sub GET_PROP_CONFEZIONI(IDArticoloMerce As Long, IDArticoloImballo As Long, IDArticoloConfezione As Long)
On Error GoTo ERR_GET_CONFEZIONI_IMBALLO_PER_ARTICOLO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim NumeroRecord As Long

GET_INFO_ARTICOLO IDArticoloMerce

Me.txtNumeroConfImballo.Value = 0
Me.txtTaraConfImballo.Value = 0

sSQL = "SELECT *  "
sSQL = sSQL & "FROM RV_POIEDistintaBasaConf "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticoloMerce
sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
sSQL = sSQL & " AND IDArticoloAssociato=" & IDArticoloConfezione

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    Me.txtNumeroConfImballo.Value = 0
    Me.txtTaraConfImballo.Value = 0
    Me.txtCostoConfezione.Value = 0
Else
    Me.txtNumeroConfImballo.Value = fnNotNullN(rs!NumeroConfezioni)
    Me.txtTaraConfImballo.Value = fnNotNullN(rs!Tara)
    Me.txtCostoConfezione.Value = fnNotNullN(rs!CostoConfezione)
    If fnNotNullN(rs!PesoPerCollo) > 0 Then
        PESO_LORDO_ARTICOLO = fnNotNullN(rs!PesoPerCollo)
    End If
    If fnNotNullN(rs!QuantitaPerConfezione) > 0 Then
        QUANTITA_PER_COLLO = fnNotNullN(rs!QuantitaPerConfezione) * fnNotNullN(rs!NumeroConfezioni)
    End If
    If fnNotNullN(rs!MOLTIPLICATORE) > 0 Then
        MOLTIPLICATORE = fnNotNullN(rs!MOLTIPLICATORE)
    End If
End If

rs.CloseResultset
Set rs = Nothing

Exit Sub
ERR_GET_CONFEZIONI_IMBALLO_PER_ARTICOLO:
    MsgBox Err.Description, vbCritical, "GET_PROP_CONFEZIONI"
End Sub
Private Sub GET_INFO_ARTICOLO(IDArticolo As Long)
On Error GoTo ERR_GET_INFO_ARTICOLO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

PESO_LORDO_ARTICOLO = 0
QUANTITA_PER_COLLO = 0
MOLTIPLICATORE = 0

sSQL = "SELECT RV_POQuantitaPerCollo, PesoNetto, RV_POMoltiplicatore "
sSQL = sSQL & "FROM Articolo WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    PESO_LORDO_ARTICOLO = fnNotNullN(rs!PesoNetto)
    QUANTITA_PER_COLLO = fnNotNullN(rs!RV_POQuantitaPerCollo)
    MOLTIPLICATORE = fnNotNullN(rs!RV_POMoltiplicatore)
End If

rs.CloseResultset
Set rs = Nothing

Exit Sub
ERR_GET_INFO_ARTICOLO:
    MsgBox Err.Description, vbCritical, "GET_INFO_ARTICOLO"
End Sub
Private Sub GET_ETICHETTE_DA_RIGA_ORD(IDRiga As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT IDValoriOggettoDettaglio, IDOggetto, IDTipoOggetto,  "
sSQL = sSQL & "RV_POIDConfigurazioneEtichettaLavorazione, RV_POIDConfigurazioneEtichettaPedana "
sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & " WHERE IDValoriOggettoDettaglio=" & IDRiga

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    If fnNotNullN(rs!RV_POIDConfigurazioneEtichettaLavorazione) > 0 Then Me.cboReportNew.WriteOn fnNotNullN(rs!RV_POIDConfigurazioneEtichettaLavorazione)
    If fnNotNullN(rs!RV_POIDConfigurazioneEtichettaPedana) > 0 Then Me.cboReportPedNew.WriteOn fnNotNullN(rs!RV_POIDConfigurazioneEtichettaPedana)
End If

rs.CloseResultset
Set rs = Nothing
End Sub
Private Function GET_QTA_PER_COLLO_CONFEZ(IDArticoloMerce As Long, IDArticoloImballo As Long, IDArticoloConfezione As Long) As Double
On Error GoTo ERR_GET_CONFEZIONI_IMBALLO_PER_ARTICOLO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_QTA_PER_COLLO_CONFEZ = 1

sSQL = "SELECT QuantitaPerConfezione  "
sSQL = sSQL & " FROM RV_POIEDistintaBasaConf "
sSQL = sSQL & " WHERE IDArticolo=" & IDArticoloMerce
sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo
sSQL = sSQL & " AND IDArticoloAssociato=" & IDArticoloConfezione

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_QTA_PER_COLLO_CONFEZ = fnNotNullN(rs!QuantitaPerConfezione)
End If

rs.CloseResultset
Set rs = Nothing

If GET_QTA_PER_COLLO_CONFEZ = 0 Then GET_QTA_PER_COLLO_CONFEZ = 1

Exit Function
ERR_GET_CONFEZIONI_IMBALLO_PER_ARTICOLO:
    MsgBox Err.Description, vbCritical, "GET_QTA_PER_COLLO_CONFEZ"
End Function
Private Function GET_COLLI_PER_TIPO_PEDANA(IDTipoPedana As Long, IDArticoloImballo As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim LOCAL_QUANTITA As Double
Dim LOCAL_QUANTITA_LAVORATA As Double
Dim Testo As String

GET_COLLI_PER_TIPO_PEDANA = 0

sSQL = "SELECT Quantita FROM RV_POTipoPedanaImballo "
sSQL = sSQL & "WHERE IDRV_POTipoPedana=" & IDTipoPedana
sSQL = sSQL & " AND IDArticolo=" & IDArticoloImballo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_COLLI_PER_TIPO_PEDANA = 0
Else
    GET_COLLI_PER_TIPO_PEDANA = fnNotNullN(rs!Quantita)
End If

rs.CloseResultset
Set rs = Nothing


End Function

Private Function GET_CODICE_VARIETA_ART(IDArticolo As Long, NomeCampoVarieta As String) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_CODICE_VARIETA_ART = ""

sSQL = "SELECT Articolo.IDArticolo, RV_PO01_Varieta." & NomeCampoVarieta
sSQL = sSQL & " FROM Articolo LEFT OUTER JOIN "
sSQL = sSQL & " RV_PO01_Varieta ON Articolo.RV_PO01_IDVarieta = RV_PO01_Varieta.IDRV_PO01_Varieta"
sSQL = sSQL & " WHERE Articolo.IDArticolo=" & IDArticolo
Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_CODICE_VARIETA_ART = fnNotNull(rs.adoColumns(NomeCampoVarieta))
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_CODICE_FAMIGLIA_ART(IDArticolo As Long, NomeCampoFamiglia As String) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_CODICE_FAMIGLIA_ART = ""

sSQL = "SELECT Articolo.IDArticolo, RV_PO01_FamigliaProdotti." & NomeCampoFamiglia
sSQL = sSQL & " FROM Articolo LEFT OUTER JOIN "
sSQL = sSQL & " RV_PO01_FamigliaProdotti ON Articolo.RV_PO01_IDFamigliaProdotti = RV_PO01_FamigliaProdotti.IDRV_PO01_FamigliaProdotti"
sSQL = sSQL & " WHERE Articolo.IDArticolo=" & IDArticolo
Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_CODICE_FAMIGLIA_ART = fnNotNull(rs.adoColumns(NomeCampoFamiglia))
End If

rs.CloseResultset
Set rs = Nothing
End Function

Private Function GET_CODICE_LOTTO_CAMPAGNA(IDLottoCampagna As Long, NomeCampo As String) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_CODICE_LOTTO_CAMPAGNA = ""

sSQL = "SELECT RV_PO01_LottoCampagna.IDRV_PO01_LottoCampagna, RV_PO01_FamigliaProdotti.FamigliaProdotti, RV_PO01_FamigliaProdotti.CodiceImEx, RV_PO01_Varieta.CodiceImEx AS CodiceImExVarieta, "
sSQL = sSQL & "RV_PO01_Varieta.Varieta "
sSQL = sSQL & "FROM RV_PO01_LottoCampagna LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_FamigliaProdotti ON RV_PO01_LottoCampagna.IDRV_PO01_FamigliaProdotti = RV_PO01_FamigliaProdotti.IDRV_PO01_FamigliaProdotti LEFT OUTER JOIN "
sSQL = sSQL & "RV_PO01_Varieta ON RV_PO01_LottoCampagna.IDRV_PO01_Varieta = RV_PO01_Varieta.IDRV_PO01_Varieta "
sSQL = sSQL & "WHERE RV_PO01_LottoCampagna.IDRV_PO01_LottoCampagna=" & IDLottoCampagna
Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_CODICE_LOTTO_CAMPAGNA = fnNotNull(rs.adoColumns(NomeCampo))
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_TESTO_RIGA_LAV_DA_ORD(IDRigaOrdine As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
GET_TESTO_RIGA_LAV_DA_ORD = ""
sSQL = "SELECT IDValoriOggettoDettaglio, RV_POAnnotazioniRigaLavorazione "
sSQL = sSQL & "FROM ValoriOggettoDettaglio0010 "
sSQL = sSQL & "WHERE IDValoriOggettoDettaglio=" & IDRigaOrdine

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_TESTO_RIGA_LAV_DA_ORD = fnNotNull(rs!RV_POAnnotazioniRigaLavorazione)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_PREPARAZIONE_RIGA_DA_PROCESSO(IDRigaProcesso As Long)
On Error GoTo ERR_GET_PREPARAZIONE_RIGA_CONFERIMENTO_AUTOMATICO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim PesoLordo As Double
Dim Tara As Double

sSQL = "SELECT * FROM RV_POProcessoLavorazioneRighe "
sSQL = sSQL & "WHERE ID=" & IDRigaProcesso


Set rs = Cn.OpenResultset(sSQL)


If Not rs.EOF Then
    cmdNuovo_Click
    
    IDProcessoProd = LINK_PROCESSO_PROD
    IDRigaProcessoProd = LINK_PROCESSO_RIGHE_PROD
    IDLineaProduzione = LINK_LINEA_PROD
    PESO_TOTALE_PEDANA_DA_PROD = fnNotNullN(rs!PesoTotalePedana)
    Me.txtIDOrdineCliente.Value = fnNotNullN(rs!IdentificativoOrdine)
    Me.txtIDRigaOrdine.Value = fnNotNullN(rs!IdentificativoRigaOrdine)
    GET_PEDANA_DA_PROCESSO fnNotNullN(rs!IdentificativoPedana)
    PESO_LORDO_ARTICOLO = fnNotNullN(rs!PesoPerCollo)
    Me.txtColli.Value = fnNotNullN(rs!ColliLavorazione)
    Me.txtPesoLordo.Value = fnNotNullN(rs!PesoLordoLavorazione)
    Me.txtTara.Value = fnNotNullN(rs!TaraLavorazione)
    Me.txtPesoNetto.Value = fnNotNullN(rs!PesoNettoLavorazione)
    Me.txtPezzi.Value = fnNotNullN(rs!PezziLavorazione)
    
    rs.CloseResultset
    Set rs = Nothing
End If

CalcoloPesoNetto

Select Case Link_UnitaDiMisura_Coop
    Case 1
        Me.txtQta_UM.Value = Me.txtColli.Value
    Case 2
        Me.txtQta_UM.Value = Me.txtPesoLordo.Value
    Case 3
        Me.txtQta_UM.Value = Me.txtPesoNetto.Value
    Case 4
        Me.txtQta_UM.Value = Me.txtTara.Value
    Case 5
        Me.txtQta_UM.Value = Me.txtPezzi.Value
End Select

Exit Function
ERR_GET_PREPARAZIONE_RIGA_CONFERIMENTO_AUTOMATICO:
    MsgBox Err.Description, vbCritical, "GET_PREPARAZIONE_RIGA_DA_PROCESSO"
End Function
Private Sub GET_PEDANA_DA_PROCESSO(IDPedana As Long)
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT * FROM RV_POPedana "
sSQL = sSQL & "WHERE IDRV_POPedana=" & IDPedana

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    LINK_PEDANA = fnNotNullN(rs!IDRV_POPedana)
    Me.txtIDPedana = LINK_PEDANA
    Me.txtCodicePedana.Text = fnNotNull(rs!Codice)
    Me.CDTipoPedana.Load GET_TIPO_PEDANA(LINK_PEDANA)
    Me.txtPesoPedana.Value = GET_PESO_PEDANA(Me.txtIDPedana.Value, Me.CDTipoPedana.KeyFieldID)
End If



rs.CloseResultset
Set rs = Nothing
End Sub
Private Function GET_MOLTIPLICATORE_ARTICOLO(IDArticolo As Long) As Double
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

sSQL = "SELECT RV_POMoltiplicatore FROM Articolo "
sSQL = sSQL & "WHERE IDArticolo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_MOLTIPLICATORE_ARTICOLO = 1
Else
    If fnNotNullN(rs!RV_POMoltiplicatore) = 0 Then
        GET_MOLTIPLICATORE_ARTICOLO = 1
    Else
        GET_MOLTIPLICATORE_ARTICOLO = fnNotNullN(rs!RV_POMoltiplicatore)
    End If
End If

rs.CloseResultset
Set rs = Nothing
End Function
Public Function GET_DESCRIZIONE_LOTTO_PROD_LAV(IDLotto As Long) As String
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_DESCRIZIONE_LOTTO_PROD_LAV = ""
LINK_SOCIO_LOTTO_PROD_LAV = 0

sSQL = "SELECT IDRV_PO01_LottoCampagna, CodiceLotto, DescrizioneLotto, IDSocio "
sSQL = sSQL & "FROM RV_PO01_LottoCampagna "
sSQL = sSQL & "WHERE IDRV_PO01_LottoCampagna=" & IDLotto

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    LINK_SOCIO_LOTTO_PROD_LAV = fnNotNullN(rs!IDSocio)
    GET_DESCRIZIONE_LOTTO_PROD_LAV = fnNotNull(rs!CodiceLotto)
    If Len(fnNotNull(rs!DescrizioneLotto)) > 0 Then
        GET_DESCRIZIONE_LOTTO_PROD_LAV = GET_DESCRIZIONE_LOTTO_PROD_LAV & " (" & fnNotNull(rs!DescrizioneLotto) & ")"
    End If
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_LINK_PEDANA_DA_ARTICOLO(IDArticolo As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_LINK_PEDANA_DA_ARTICOLO = 0


sSQL = "SELECT IDRV_POTipoPedana "
sSQL = sSQL & " FROM RV_POTipoPedana "
sSQL = sSQL & " WHERE IDArticoloImballo=" & IDArticolo

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_LINK_PEDANA_DA_ARTICOLO = fnNotNullN(rs!IDRV_POTipoPedana)
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Sub CREA_RIGA_CONFERIMENTO(ID As Long, Optional Lavorazione As Long = 0)
On Error GoTo ERR_CREA_RIGA_CONFERIMENTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim IDConferimentoCollegato As Long
Dim rsNew As ADODB.Recordset
Dim IDTipoOggettoConferimento As Long
Dim IDTipoDocumentoCoop As Long
Dim IDRigaCaricoMerce As Long
Dim rsDeleteMov As DmtOleDbLib.adoResultset

IDConferimentoCollegato = 0

sSQL = "SELECT IDRV_POCaricoMerceTesta FROM RV_POCaricoMerceTesta "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceTestaPreConferimento=" & fnNotNullN(m_Document("IDRV_POCaricoMerceTesta").Value)

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    IDConferimentoCollegato = fnNotNullN(rs!IDRV_POcaricoMercetesta)
End If

rs.CloseResultset
Set rs = Nothing

If IDConferimentoCollegato = 0 Then Exit Sub
If Lavorazione = 0 Then
    sSQL = "SELECT * FROM RV_POAssegnazioneMerce "
    sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & ID
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If Not rs.EOF Then
        sSQL = "SELECT * FROM RV_POCaricoMerceRighe "
        sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & ID
        
        Set rsNew = New ADODB.Recordset
        rsNew.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic
        
        If rsNew.EOF Then
            rsNew.AddNew
            rsNew!IDRV_POCaricoMerceRighe = fnGetNewKey("RV_POCaricoMerceRighe", "IDRV_POCaricoMerceRighe")
            rsNew!IDRV_POcaricoMercetesta = IDConferimentoCollegato
            rsNew!LottoDiConferimento = fnNotNull(m_Document("LottoDiConferimento").Value)
            rsNew!Chiuso = 0
            rsNew!IDLottoDiCampagna = m_Document("IDLottoDiCampagna").Value
            rsNew!LINK_ORDINAMENTO = GET_LINK_ORDINAMENTO_RIGHE_CONF(IDConferimentoCollegato) 'DaCalcolare
            rsNew!CodiceUtente = TheApp.User
            rsNew!IDUtente = TheApp.IDUser
            rsNew!IDProvincia = m_Document("IDProvincia").Value
            rsNew!IDComune = m_Document("IDComune").Value
            rsNew!IDNazione = m_Document("IDNazione").Value
            rsNew!IDRegione = m_Document("IDRegione").Value
            rsNew!DataSbloccoLottoCampagna = m_Document("DataSbloccoLottoCampagna").Value
            rsNew!UtentePC = GET_NOMEUTENTE
            rsNew!NomePC = GET_NOMECOMPUTER
            rsNew!OraArrivoMerce = m_Document("OraArrivoMerce").Value
            rsNew!PrezzoMedio = m_Document("PrezzoMedio").Value
            rsNew!IDRV_POAssegnazioneMerce = ID
            rsNew!IDRV_POLavorazione = 0
            rsNew!RigaScartoDaPreConferimento = 0
            rsNew!CodiceLotto = rs!CodiceLottoVendita
            rsNew!IDRV_POTipoConfLiquidazione = GET_TIPO_LIQUIDAZIONE_PER_CONF_NUOVO(TheApp.Branch)
        End If
        
        IDRigaCaricoMerce = rsNew!IDRV_POCaricoMerceRighe
        rsNew!IDArticolo = rs!IDArticolo
        rsNew!CodiceArticolo = rs!CodiceArticolo
        rsNew!Articolo = rs!Articolo
        rsNew!IDUnitaDiMisura = rs!IDUnitaDiMisuraCoop 'IDUnitaDiMisura Coop
        rsNew!IDUnitaDiMisuraDiamante = rs!IDUnitaDiMisura
        rsNew!Colli = rs!Colli
        rsNew!PesoLordo = rs!PesoLordo
        rsNew!PesoNetto = rs!PesoNetto
        rsNew!Tara = rs!Tara
        rsNew!Pezzi = rs!Pezzi
        rsNew!Qta_UM = rs!Qta_UM
        rsNew!IDIvaAcquisto = m_Document("IDIvaAcquisto").Value
        rsNew!AliquotaIVA = m_Document("AliquotaIVA").Value
        rsNew!ImportoUnitario = m_Document("ImportoUnitario").Value
        rsNew!TotaleImponibileRiga = m_Document("TotaleImponibileRiga").Value
        rsNew!TotaleImpostaRiga = m_Document("TotaleImpostaRiga").Value
        rsNew!TotaleLordoRiga = m_Document("TotaleLordoRiga").Value
    '        rsNew!IDCodiceLotto = 0
    '        rsNew!DescrizioneLotto = ""
        rsNew!IDImballo = rs!IDImballoVendita
        rsNew!CodiceImballo = rs!CodiceImballoVendita
        rsNew!DescrizioneImballo = rs!ImballoVendita
        rsNew!TaraUnitaria = rs!TaraUnitaria
    '        rsNew!IDArticoloPedana = 0
    '        rsNew!TaraPedana = 0
    '        rsNew!CodiceArticoloPedana = ""
    '        rsNew!ArticoloPedana = ""
    '        rsNew!QuantitaPedana = 0
        rsNew!IDRV_POTipoLavorazione = 0
    '        rsNew!IDRV_POLottoImballo = 0
    '        rsNew!TracciaImballo = 0
    '        rsNew!IDValoriOggettoDettaglioOrdine = 0
    '        rsNew!AnnotazioniAggiuntive = ""
    '        rsNew!ImportoUnitarioImballo = 0
    '        rsNew!TaraMezzo = 0
        rsNew!QuantitaPresunta = 0
            
            
        rsNew.Update
        
        rsNew.Close
        Set rsNew = Nothing
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If
If Lavorazione = 1 Then
    sSQL = "SELECT * FROM RV_POLavorazione "
    sSQL = sSQL & "WHERE IDRV_POLavorazione=" & ID
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If Not rs.EOF Then
        sSQL = "SELECT * FROM RV_POCaricoMerceRighe "
        sSQL = sSQL & "WHERE IDRV_POLavorazione=" & ID
        
        Set rsNew = New ADODB.Recordset
        rsNew.Open sSQL, Cn.InternalConnection, adOpenKeyset, adLockPessimistic
        
        If rsNew.EOF Then
            rsNew.AddNew
            rsNew!IDRV_POCaricoMerceRighe = fnGetNewKey("RV_POCaricoMerceRighe", "IDRV_POCaricoMerceRighe")
            rsNew!IDRV_POcaricoMercetesta = IDConferimentoCollegato
            rsNew!LottoDiConferimento = fnNotNull(m_Document("LottoDiConferimento").Value)
            rsNew!Chiuso = 0
            rsNew!IDLottoDiCampagna = m_Document("IDLottoDiCampagna").Value
            rsNew!LINK_ORDINAMENTO = GET_LINK_ORDINAMENTO_RIGHE_CONF(IDConferimentoCollegato) 'DaCalcolare
            rsNew!CodiceUtente = TheApp.User
            rsNew!IDUtente = TheApp.IDUser
            rsNew!IDProvincia = m_Document("IDProvincia").Value
            rsNew!IDComune = m_Document("IDComune").Value
            rsNew!IDNazione = m_Document("IDNazione").Value
            rsNew!IDRegione = m_Document("IDRegione").Value
            rsNew!DataSbloccoLottoCampagna = m_Document("DataSbloccoLottoCampagna").Value
            rsNew!UtentePC = GET_NOMEUTENTE
            rsNew!NomePC = GET_NOMECOMPUTER
            rsNew!OraArrivoMerce = m_Document("OraArrivoMerce").Value
            rsNew!PrezzoMedio = m_Document("PrezzoMedio").Value
            rsNew!IDRV_POAssegnazioneMerce = 0
            rsNew!IDRV_POLavorazione = ID
            rsNew!RigaScartoDaPreConferimento = 1
            rsNew!CodiceLotto = rs!CodiceLottoVendita
            rsNew!IDRV_POTipoConfLiquidazione = GET_TIPO_LIQUIDAZIONE_PER_CONF_NUOVO(TheApp.Branch)
        End If
        
        IDRigaCaricoMerce = rsNew!IDRV_POCaricoMerceRighe
        rsNew!IDArticolo = rs!IDArticolo
        rsNew!CodiceArticolo = rs!CodiceArticolo
        rsNew!Articolo = rs!Articolo
        rsNew!IDUnitaDiMisura = rs!IDUnitaDiMisuraCoop 'IDUnitaDiMisura Coop
        rsNew!IDUnitaDiMisuraDiamante = rs!IDUnitaDiMisura
        rsNew!Colli = rs!Colli
        rsNew!PesoLordo = rs!PesoLordo
        rsNew!PesoNetto = rs!PesoNetto
        rsNew!Tara = rs!Tara
        rsNew!Pezzi = rs!Pezzi
        rsNew!Qta_UM = rs!Qta_UM
        rsNew!IDIvaAcquisto = m_Document("IDIvaAcquisto").Value
        rsNew!AliquotaIVA = m_Document("AliquotaIVA").Value
        rsNew!ImportoUnitario = m_Document("ImportoUnitario").Value
        rsNew!TotaleImponibileRiga = m_Document("TotaleImponibileRiga").Value
        rsNew!TotaleImpostaRiga = m_Document("TotaleImpostaRiga").Value
        rsNew!TotaleLordoRiga = m_Document("TotaleLordoRiga").Value
        'rsNew!IDCodiceLotto = m_Document("ImportoUnitario").Value
    '        rsNew!DescrizioneLotto = ""
        rsNew!IDImballo = rs!IDImballoVendita
        rsNew!CodiceImballo = rs!CodiceImballoVendita
        rsNew!DescrizioneImballo = rs!ImballoVendita
        rsNew!TaraUnitaria = rs!TaraUnitaria
    '        rsNew!IDArticoloPedana = 0
    '        rsNew!TaraPedana = 0
    '        rsNew!CodiceArticoloPedana = ""
    '        rsNew!ArticoloPedana = ""
    '        rsNew!QuantitaPedana = 0
        rsNew!IDRV_POTipoLavorazione = 0
    '        rsNew!IDRV_POLottoImballo = 0
    '        rsNew!TracciaImballo = 0
    '        rsNew!IDValoriOggettoDettaglioOrdine = 0
    '        rsNew!AnnotazioniAggiuntive = ""
    '        rsNew!ImportoUnitarioImballo = 0
    '        rsNew!TaraMezzo = 0
        rsNew!QuantitaPresunta = 0
            
            
        rsNew.Update
        
        rsNew.Close
        Set rsNew = Nothing
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If

sSQL = "SELECT * FROM RV_PORepLavorazione "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaCaricoMerce

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    Set Mov = New DmtMovim.cMovimentazione
    
    Set Mov.Connection = TheApp.Database.Connection
    
    'ELIMINAZIONE MOVIMENTI
    'IDTipoOggettoConferimento = 1 'fnNotNullN(m_Document("IDTipoDocumentoCoop").Value)
    IDTipoOggettoConferimento = fnGetTipoOggetto("RV_POCaricoMerceL")
    IDTipoDocumentoCoop = 4
    
    'ELIMINAZIONE MOVIMENTI DELLA RIGA CONFERITA''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    sSQL = "SELECT IDMovimento FROM Movimento "
    sSQL = sSQL & " WHERE IDTipoOggetto=" & IDTipoOggettoConferimento
    sSQL = sSQL & " AND IDOggetto=" & IDConferimentoCollegato
    sSQL = sSQL & " AND IDValoriOggettoDettaglio=" & IDRigaCaricoMerce
    
    Set rsDeleteMov = Cn.OpenResultset(sSQL)
    
    While Not rsDeleteMov.EOF
        X = Mov.Delete(fnNotNullN(rsDeleteMov!IDMovimento))
    rsDeleteMov.MoveNext
    Wend
    
    rsDeleteMov.CloseResultset
    Set rsDeleteMov = Nothing
    '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
    
    
    'MOVIMENTO ARTICOLO
    Mov.DataMovimento = Date
    If (Lavorazione = 0) Then Mov.DataMovimento = Me.txtDataLavorazione.Text
    If (Lavorazione = 1) Then Mov.DataMovimento = Me.txtDataLavorazione_Q.Text
    Mov.FattoreDiConversione = Null
    
    Mov.GestioneMatricole = False
    Mov.IDEsercizio = Link_Esercizio
    Mov.IDOggetto = IDConferimentoCollegato
    Mov.IDTipoOggetto = IDTipoOggettoConferimento
    
    Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(IDTipoDocumentoCoop, 1)
    Mov.IDUtente = TheApp.IDUser
    Mov.IDMagazzinoEntrata = Me.cboMagazzinoConf.CurrentID
    Mov.IDMagazzinoUscita = Me.cboMagazzinoConf.CurrentID
    Mov.Cessione = 0
    Mov.Field "IDAzienda", TheApp.IDFirm
    Mov.Field "IDAnagrafica", Val(Me.TxtIDAnagrafica.Text)
    Mov.Field "IDTipoAnagrafica", 3
    Mov.Field "IDArticolo", fnNotNullN(rs!IDArticolo)
    Mov.Field "IDUnitaDiMisura", fnNotNullN(rs("IDUnitaDiMisuraDiamante").Value)
    Mov.Field "IDcambio", Null
    Mov.Field "DescrizioneArticolo", fnNotNull(rs("Articolo").Value)
    Mov.Field "QuantitaTotale", rs!Qta_UM
    Mov.Field "Importo", fnNotNullN(rs("TotaleImponibileRiga").Value)
    Mov.Field "PrezzoUnitario", fnNotNullN(rs("ImportoUnitario").Value)
    Mov.Field "DataDocumento", rs!DataDocumento

    Mov.Field "Oggetto", Mid("Conferimento del " & rs!DataDocumento & " Numero " & rs!NumeroDocumento, 1, 100)
    Mov.Field "IDTipoMovimento", 1
    
    Mov.Field "TipoRiga", trcNessuno
    'DATI DI CONFERIMENTO
    Mov.Field "IDValoriOggettoDettaglio", IDRigaCaricoMerce
    Mov.Field "RV_POTipoRiga", 1
    Mov.Field "RV_POIDCaricoMerceRighe", IDRigaCaricoMerce
    Mov.Field "RV_POIDAssegnazioneMerce", 0
    Mov.Field "RV_POIDProcessoIVGamma", 0
    Mov.Field "RV_POIDAnagraficaSocio", Me.TxtIDAnagrafica.Text
    Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
    Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
    Mov.Field "RV_POCodiceLotto", rs!CodiceLotto
    Mov.Field "RV_POCodiceLottoCampagna", Me.txtCodiceLotto_Conf.Text
    Mov.Field "RV_POQuantitaLiquidazione", 0
    Mov.Field "RV_POImportoInclusoImballo", 0
    Mov.Field "RV_POImportoLiquidazione", 0
    Mov.Field "RV_POQuantitaMovimentata", rs!Qta_UM
    Mov.Field "RV_PONumeroColli", rs!Colli
    Mov.Field "RV_POPesoLordo", rs!PesoLordo
    Mov.Field "RV_POPesoNetto", rs!PesoNetto
    Mov.Field "RV_POTara", rs!Tara
    Mov.Field "RV_POQuantitaPezzi", rs!Pezzi

    X = Mov.Insert
    
    'MOVIMENTO IMBALLO
    If ((fnNotNullN(rs("IDImballo").Value) > 0) And (rs!Colli > 0)) Then
        Mov.DataMovimento = Me.txtDataLavorazione.Text
        Mov.FattoreDiConversione = Null
        
        Mov.GestioneMatricole = False
        Mov.IDEsercizio = Link_Esercizio
        Mov.IDOggetto = IDConferimentoCollegato
        Mov.IDTipoOggetto = IDTipoOggettoConferimento
        Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(IDTipoDocumentoCoop, 1)
        Mov.IDUtente = TheApp.IDUser
        Mov.IDMagazzinoEntrata = Me.cboMagazzinoConf.CurrentID
        Mov.IDMagazzinoUscita = Me.cboMagazzinoConf.CurrentID
        Mov.Cessione = 0
        Mov.Field "IDAzienda", TheApp.IDFirm
        If (Me.chkPreConferimento.Value = vbUnchecked) Then
            Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
        Else
            Mov.Field "IDAnagrafica", IDSOCIO_PRE_CONF
        End If
        Mov.Field "IDTipoAnagrafica", 3
        Mov.Field "IDArticolo", fnNotNullN(rs("IDImballo").Value)
        Mov.Field "IDUnitaDiMisura", GET_LINK_UM_ARTICOLO(fnNotNullN(rs("IDImballo").Value))
        Mov.Field "IDcambio", Null
        Mov.Field "DescrizioneArticolo", fnNotNull(rs("DescrizioneImballo").Value)
        Mov.Field "QuantitaTotale", rs!Colli
        Mov.Field "Importo", 0
        Mov.Field "DataDocumento", Me.txtDataDocumento.Text
        
        Mov.Field "Oggetto", Mid("Conferimento del " & Me.txtDataDocumento & " Numero " & Me.txtNumeroDocumento, 1, 100)
        Mov.Field "IDTipoMovimento", 1
        
        Mov.Field "TipoRiga", trcNessuno
        
        Mov.Field "IDValoriOggettoDettaglio", IDRigaCaricoMerce
        Mov.Field "RV_POTipoRiga", 2
        Mov.Field "RV_POIDCaricoMerceRighe", IDRigaCaricoMerce
        Mov.Field "RV_POIDAssegnazioneMerce", 0
        Mov.Field "RV_POIDProcessoIVGamma", 0
        Mov.Field "RV_POIDAnagraficaSocio", Me.TxtIDAnagrafica.Text
        Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
        Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
        Mov.Field "RV_POCodiceLotto", rs!CodiceLotto
        Mov.Field "RV_POCodiceLottoCampagna", Me.txtCodiceLotto_Conf.Text
        Mov.Field "RV_POQuantitaLiquidazione", 0
        Mov.Field "RV_POImportoInclusoImballo", 0
        Mov.Field "RV_POImportoLiquidazione", 0
        Mov.Field "RV_POQuantitaMovimentata", rs!Colli
        Mov.Field "RV_PONumeroColli", 0
        Mov.Field "RV_POPesoLordo", 0
        Mov.Field "RV_POPesoNetto", 0
        Mov.Field "RV_POTara", 0
        Mov.Field "RV_POQuantitaPezzi", 0
        
        X = Mov.Insert
    End If

End If

rs.CloseResultset
Set rs = Nothing
Exit Sub
ERR_CREA_RIGA_CONFERIMENTO:
    MsgBox Err.Description, vbCritical, "CREA_RIGA_CONFERIMENTO"
End Sub
Private Function GET_LINK_ORDINAMENTO_RIGHE_CONF(IDConferimentoTesta As Long) As Long
On Error GoTo ERR_GET_LINK_ORDINAMENTO_RIGHE_CONF
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_LINK_ORDINAMENTO_RIGHE_CONF = 1

sSQL = "SELECT COUNT(LINK_ORDINAMENTO) AS NumeroRecord "
sSQL = sSQL & "FROM RV_POCaricoMerceRighe "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceTesta=" & IDConferimentoTesta

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_LINK_ORDINAMENTO_RIGHE_CONF = 1
Else
    GET_LINK_ORDINAMENTO_RIGHE_CONF = fnNotNullN(rs!NumeroRecord) + 1
End If


rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_LINK_ORDINAMENTO_RIGHE_CONF:
    MsgBox Err.Description, vbCritical, "GET_LINK_ORDINAMENTO_RIGHE_CONF"
End Function
Private Function GET_TIPO_LIQUIDAZIONE_PER_CONF_NUOVO(IDFiliale As Long) As Long
On Error GoTo ERR_GET_TIPO_LIQUIDAZIONE_PER_CONFERIMENTO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset


GET_TIPO_LIQUIDAZIONE_PER_CONF_NUOVO = 0

sSQL = "SELECT IDRV_POTipoLiqConf,IDRV_POTipoConfLiquidazioneChiuso,IDRV_POTipoConfLiquidazioneNuovo "
sSQL = sSQL & "FROM RV_POCalcoloLiqTesta "
sSQL = sSQL & "WHERE IDFiliale=" & IDFiliale
sSQL = sSQL & " AND IDSocio=0"

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_TIPO_LIQUIDAZIONE_PER_CONF_NUOVO = fnNotNullN(rs!IDRV_POTipoConfLiquidazioneNuovo)
End If

rs.CloseResultset
Set rs = Nothing
Exit Function
ERR_GET_TIPO_LIQUIDAZIONE_PER_CONFERIMENTO:
    MsgBox Err.Description, vbCritical, "GET_TIPO_LIQUIDAZIONE_PER_CONF_NUOVO"
End Function
'Restituisce se un bool se la riga collegata alla riga di lavorazione è stata movimentata in lavorazione
Private Function GET_CONTROLLO_DELETE_RIGA_PRE_CONF(IDAssegnazioneMerce As Long, Optional Lavorazione As Long = 0) As Boolean
On Error GoTo ERR_GET_CONTROLLO_DELETE_RIGA_PRE_CONF
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim IDRigaConferimento As Long

GET_CONTROLLO_DELETE_RIGA_PRE_CONF = False
IDRigaConferimento = 0


sSQL = "SELECT IDRV_POCaricoMerceRighe FROM RV_POCaricoMerceRighe "
If Lavorazione = 0 Then
    sSQL = sSQL & "WHERE IDRV_POAssegnazioneMerce=" & IDAssegnazioneMerce
End If
If Lavorazione = 1 Then
    sSQL = sSQL & "WHERE IDRV_POLavorazione=" & IDAssegnazioneMerce
End If
Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    IDRigaConferimento = fnNotNullN(rs!IDRV_POCaricoMerceRighe)
End If

rs.CloseResultset
Set rs = Nothing

If IDRigaConferimento = 0 Then Exit Function

sSQL = "SELECT IDRV_POAssegnazioneMerce FROM RV_POAssegnazioneMerce "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaConferimento
Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_CONTROLLO_DELETE_RIGA_PRE_CONF = True
End If

rs.CloseResultset
Set rs = Nothing
    
    
If GET_CONTROLLO_DELETE_RIGA_PRE_CONF = False Then
''''''''''''''''''CONTROLLO DDT''''''''''''''''''''''''''''''''''''''''''''''''''''
    sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0004 "
    sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If Not rs.EOF Then
        GET_CONTROLLO_DELETE_RIGA_PRE_CONF = True
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If

If GET_CONTROLLO_DELETE_RIGA_PRE_CONF = False Then
''''''''''''''''''CONTROLLO FATTURA ACCOMPAGNATORIA
    sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0001 "
    sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento

    Set rs = Cn.OpenResultset(sSQL)
    
    If Not rs.EOF Then
        GET_CONTROLLO_DELETE_RIGA_PRE_CONF = True
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If

If GET_CONTROLLO_DELETE_RIGA_PRE_CONF = False Then
''''''''''''''''''CONTROLLO CORRISPETTIVI
    sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0034 "
    sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento
    
    Set rs = Cn.OpenResultset(sSQL)
    
    If Not rs.EOF Then
        GET_CONTROLLO_DELETE_RIGA_PRE_CONF = True
    End If
    
    rs.CloseResultset
    Set rs = Nothing
End If

If GET_CONTROLLO_DELETE_RIGA_PRE_CONF = False Then
''''''''''''''''''CONTROLLO NOTA DI CREDITO
    sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0016 "
    sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento

    Set rs = Cn.OpenResultset(sSQL)
    
    If Not rs.EOF Then
        GET_CONTROLLO_DELETE_RIGA_PRE_CONF = True

    End If
    
    rs.CloseResultset
    Set rs = Nothing
    
End If

If GET_CONTROLLO_DELETE_RIGA_PRE_CONF = False Then
''''''''''''''''''CONTROLLO NOTA DI DEBITO
sSQL = "SELECT IDValoriOggettoDettaglio FROM ValoriOggettoDettaglio0007 "
sSQL = sSQL & "WHERE RV_POIDConferimentoRighe=" & IDRigaConferimento

Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_CONTROLLO_DELETE_RIGA_PRE_CONF = True
End If

rs.CloseResultset
Set rs = Nothing
End If
Exit Function
ERR_GET_CONTROLLO_DELETE_RIGA_PRE_CONF:
    GET_CONTROLLO_DELETE_RIGA_PRE_CONF = True
    MsgBox Err.Description, vbCritical, "GET_CONTROLLO_DELETE_RIGA_PRE_CONF"
End Function
Private Sub DELETE_CONFERIMENTO_COLLEGATO(IDAssegnazioneMerce As Long, Optional Lavorazione As Long = 0)
On Error GoTo ERR_DELETE_CONFERIMENTO_COLLEGATO
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset
Dim IDRigaConferimento As Long
Dim IDTestaConferimento As Long
Dim IDTipoOggettoConferimento As Long
Dim rsDeleteMov As DmtOleDbLib.adoResultset

IDRigaConferimento = 0

sSQL = "SELECT IDRV_POCaricoMerceRighe, IDRV_POCaricoMerceTesta "
sSQL = sSQL & " FROM RV_POCaricoMerceRighe "
If Lavorazione = 0 Then
    sSQL = sSQL & " WHERE IDRV_POAssegnazioneMerce=" & IDAssegnazioneMerce
End If
If Lavorazione = 1 Then
    sSQL = sSQL & " WHERE IDRV_POLavorazione=" & IDAssegnazioneMerce
End If
Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    IDRigaConferimento = fnNotNullN(rs!IDRV_POCaricoMerceRighe)
    IDTestaConferimento = fnNotNullN(rs!IDRV_POcaricoMercetesta)
End If

rs.CloseResultset
Set rs = Nothing

If IDRigaConferimento = 0 Then Exit Sub

sSQL = "DELETE FROM RV_POCaricoMerceRighe "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaConferimento
Cn.Execute sSQL



Set Mov = New DmtMovim.cMovimentazione

Set Mov.Connection = TheApp.Database.Connection

'ELIMINAZIONE MOVIMENTI
IDTipoOggettoConferimento = fnGetTipoOggetto("RV_POCaricoMerceL")


'ELIMINAZIONE MOVIMENTI DELLA RIGA CONFERITA''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
sSQL = "SELECT IDMovimento FROM Movimento "
sSQL = sSQL & " WHERE IDTipoOggetto=" & IDTipoOggettoConferimento
sSQL = sSQL & " AND IDOggetto=" & IDTestaConferimento
sSQL = sSQL & " AND IDValoriOggettoDettaglio=" & IDRigaConferimento

Set rsDeleteMov = Cn.OpenResultset(sSQL)

While Not rsDeleteMov.EOF
    X = Mov.Delete(fnNotNullN(rsDeleteMov!IDMovimento))
rsDeleteMov.MoveNext
Wend

rsDeleteMov.CloseResultset
Set rsDeleteMov = Nothing

Set Mov = Nothing
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Exit Sub
ERR_DELETE_CONFERIMENTO_COLLEGATO:
    MsgBox Err.Description, vbCritical, "DELETE_CONFERIMENTO_COLLEGATO"
End Sub

Private Function GeneraMovimentoDiScaricoPreConf(IDAssegnazione As Long, IDRigaConferimento As Long, CodiceLottoVendita As String, CodiceLottoCampagna As String, IDArticolo As Long, IDUMDiamante As Long, Articolo As String, Qta_UM As Double, DataLavorazione As String, QuantitaMovimentata As Double, _
Colli As Double, PesoLordo As Double, PesoNetto As Double, Tara As Double, Pezzi As Double, IDImballo As Long, IDTipoDocumentoCoop As Long, CodiceImballo As String, DescrizioneImballo As String, _
IDTipoLavorazione As Long, IDTipoCategoria As Long, IDCalibro As Long, IDTipoLavorazioneConf As Long, PrezzoMedioConf As Long, _
IDPedana As Long, IDTipoPedana As Long, CodicePedana As String, PesoPedana As Double, IDImballoPrim As Long, CodiceImballoPrim As String, DescrizioneImballoPrim As String, _
NumeroConfezioni As Long, TaraUnitariaConfezione As Double, CostoImballoConfezione As Double) As Long


Mov.DataMovimento = DataLavorazione
Mov.FattoreDiConversione = Null

Mov.GestioneMatricole = False
Mov.IDEsercizio = Link_Esercizio
Mov.IDTipoOggetto = m_DocType.ID
Mov.IDOggetto = fnNotNullN(m_Document(m_Document.PrimaryKey).Value)
Mov.IDFunzione = GET_FUNZIONE_MAGAZZINO(10, 2)
Mov.IDUtente = TheApp.IDUser
Mov.IDMagazzinoEntrata = cboMagazzinoConf.CurrentID
Mov.IDMagazzinoUscita = cboMagazzinoConf.CurrentID
Mov.Cessione = 0
Mov.Field "IDAzienda", TheApp.IDFirm
Mov.Field "IDAnagrafica", m_Document("IDAnagrafica").Value
Mov.Field "IDTipoAnagrafica", 3
Mov.Field "IDArticolo", IDArticolo
Mov.Field "IDUnitaDiMisura", IDUMDiamante
Mov.Field "IDcambio", Null
Mov.Field "DescrizioneArticolo", Articolo
Mov.Field "QuantitaTotale", Qta_UM
Mov.Field "Importo", 0
Mov.Field "DataDocumento", DataLavorazione
Mov.Field "Oggetto", "Lavorazione merce del " & DataLavorazione
Mov.Field "IDTipoMovimento", 1

'DATI DI CONFERIMENTO
Mov.Field "IDValoriOggettoDettaglio", IDAssegnazione
Mov.Field "RV_POTipoRiga", 1
Mov.Field "RV_POIDCaricoMerceRighe", IDRigaConferimento
Mov.Field "RV_POIDAssegnazioneMerce", IDAssegnazione
Mov.Field "RV_POIDProcessoIVGamma", 0
Mov.Field "RV_POIDAnagraficaSocio", fnNotNullN(m_Document("IDAnagrafica").Value)
Mov.Field "RV_PODataConferimento", Me.txtDataDocumento.Text
Mov.Field "RV_PONumeroConferimento", Me.txtNumeroDocumento.Value
Mov.Field "RV_POCodiceLotto", fnNotNull(m_Document("CodiceLotto").Value)
Mov.Field "RV_POCodiceLottoCampagna", fnNotNull(m_Document("LottoDiConferimento").Value)
Mov.Field "RV_POCodiceLottoVendita", CodiceLottoVendita
Mov.Field "RV_POQuantitaLiquidazione", 0
Mov.Field "RV_POImportoInclusoImballo", 0
Mov.Field "RV_POImportoLiquidazione", 0
Mov.Field "RV_POQuantitaMovimentata", QuantitaMovimentata * GET_MOLTIPLICATORE_ARTICOLO(IDArticolo)
Mov.Field "RV_PONumeroColli", Colli
Mov.Field "RV_POPesoLordo", PesoLordo
Mov.Field "RV_POPesoNetto", PesoNetto
Mov.Field "RV_POTara", Tara
Mov.Field "RV_POQuantitaPezzi", Pezzi
Mov.Field "RV_POIDTipoDocumentoCoop", IDTipoDocumentoCoop
Mov.Field "RV_POIDImballo", IDImballo
Mov.Field "RV_POCodiceImballo", CodiceImballo
Mov.Field "RV_PODescrizioneImballo", DescrizioneImballo

Mov.Field "RV_PODataLavorazione", DataLavorazione
Mov.Field "RV_POIDTipoLavorazione", IDTipoLavorazione
Mov.Field "RV_POIDCalibro", IDCalibro
Mov.Field "RV_POIDTipoCategoria", IDTipoCategoria
Mov.Field "RV_POIDTipoLavorazioneConf", IDTipoLavorazioneConf
Mov.Field "RV_POPrezzoMedioConf", PrezzoMedioConf

Mov.Field "RV_POIDPedana", IDPedana
Mov.Field "RV_POIDTipoPedana", IDTipoPedana
Mov.Field "RV_POCodicePedana", CodicePedana
Mov.Field "RV_POPesoPedana", PesoPedana

Mov.Field "RV_POIDImballoPrim", IDImballoPrim
Mov.Field "RV_POCodiceImballoPrim", CodiceImballoPrim
Mov.Field "RV_PODescrizioneImballoPrim", DescrizioneImballoPrim
Mov.Field "RV_PONumeroConfezioniPerImballo", NumeroConfezioni
Mov.Field "RV_POTaraConfezioneImballo", TaraUnitariaConfezione
Mov.Field "RV_POQuantitaTotaleConfImballo", Colli * NumeroConfezioni
Mov.Field "RV_POCostoConfezioneImballo", CostoImballoConfezione

Mov.Field "TipoRiga", trcNessuno

Cn.BeginTrans

GeneraMovimentoDiScaricoPreConf = Mov.Insert

If GeneraMovimentoDiScaricoPreConf = False Then
    Cn.RollbackTrans
Else
    Cn.CommitTrans
End If

End Function

Private Sub CREA_RECORDSET_LOTTI_IMBALLI_KIT(IDArticoloImballo As Long, IDTipoOggetto As Long, IDOggetto As Long, IDValoriOggettoDettaglio As Long, IDRV_PODistintaBaseRighe As Long)
On Error GoTo ERR_CREA_RECORDSET_LOTTI_IMBALLI
Dim sSQL As String
Dim rs As ADODB.Recordset
Dim rsVista As ADODB.Recordset
Dim I As Long
Dim QuantitaLottoProcesso As Double


sSQL = "SELECT * FROM RV_POLottoImballo "
sSQL = sSQL & "WHERE IDAzienda=" & TheApp.IDFirm
sSQL = sSQL & " AND IDArticoloImballo=" & IDArticoloImballo

'sSQL = sSQL & " AND Giacenza>0"

sSQL = sSQL & "ORDER BY DataCreazione, NumeroProgressivo"

Set rs = New ADODB.Recordset
rs.Open sSQL, Cn.InternalConnection

While Not rs.EOF
    rsKITLotti.AddNew
        For I = 0 To rs.Fields.Count - 1
            rsKITLotti.Fields(rs.Fields(I).Name).Value = rs.Fields(I).Value
        Next
        
        QuantitaLottoProcesso = GET_QUANTITA_LOTTO_UTILIZZATA_PROCESSO(fnNotNullN(rs!IDRV_POLottoImballo), IDTipoOggetto, IDOggetto, IDValoriOggettoDettaglio, IDArticoloImballo)
        rsKITLotti!Giacenza = rsKITLotti!Giacenza + QuantitaLottoProcesso
        rsKITLotti!QuantitaSelezionata = QuantitaLottoProcesso
        rsKITLotti!Rimanenza = rsKITLotti!Giacenza - rsKITLotti!QuantitaSelezionata
        rsKITLotti!QuantitaMovimentata = 0
        If QuantitaLottoProcesso = 0 Then
            rsKITLotti!Registra = 0
        Else
            rsKITLotti!Registra = 1
        End If
        rsKITLotti!RegistraDaUtente = 0
        rsKITLotti!IDRV_PODistintaBaseRighe = IDRV_PODistintaBaseRighe
    rsKITLotti.Update
rs.MoveNext
Wend

rs.Close
Set rs = Nothing
Exit Sub
ERR_CREA_RECORDSET_LOTTI_IMBALLI:
    MsgBox Err.Description, vbCritical, "CREA_RECORDSET_LOTTI_IMBALLI"
End Sub
Private Function CONTROLLO_DISP_LOTTO_KIT() As String
On Error GoTo ERR_CONTROLLO_DISP_LOTTO_KIT

CONTROLLO_DISP_LOTTO_KIT = ""

If ((rsKIT.EOF) And (rsKIT.BOF)) Then Exit Function

rsKIT.MoveFirst

While Not rsKIT.EOF
    If fnNotNullN(rsKIT!RV_POTracciabilitaImballo) = 1 Then
        If fnNotNullN(rsKIT!QuantitaTotale) > fnNotNullN(rsKIT!DisponibilitaLottoImballo) Then
            CONTROLLO_DISP_LOTTO_KIT = CONTROLLO_DISP_LOTTO_KIT & " - " & rsKIT!Articolo & " (" & fnNotNullN(rsKIT!DisponibilitaLottoImballo) - fnNotNullN(rsKIT!QuantitaTotale) & ")" & vbCrLf
        End If
    End If
rsKIT.MoveNext
Wend
Exit Function
ERR_CONTROLLO_DISP_LOTTO_KIT:
    MsgBox Err.Description, vbCritical, "CONTROLLO_DISP_LOTTO_KIT"
End Function

Private Function GET_ESISTENZA_RIGA_CONF(IDRigaConf As Long) As Boolean
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_ESISTENZA_RIGA_CONF = True

sSQL = "SELECT IDRV_POCaricoMerceRighe FROM RV_POCaricoMerceRighe "
sSQL = sSQL & "WHERE IDRV_POCaricoMerceRighe=" & IDRigaConf

Set rs = Cn.OpenResultset(sSQL)

If rs.EOF Then
    GET_ESISTENZA_RIGA_CONF = False
End If

rs.CloseResultset
Set rs = Nothing
End Function
Private Function GET_BLOCCO_QTA_LAVORATA(IDUtente As Long) As Long
Dim sSQL As String
Dim rs As DmtOleDbLib.adoResultset

GET_BLOCCO_QTA_LAVORATA = 0

sSQL = "SELECT * FROM RV_POUtentiBloccoQtaConfInLav"
sSQL = sSQL & " WHERE IDUtente=" & IDUtente
sSQL = sSQL & " AND IDFiliale=" & TheApp.Branch
Set rs = Cn.OpenResultset(sSQL)

If Not rs.EOF Then
    GET_BLOCCO_QTA_LAVORATA = 1
End If

rs.CloseResultset
Set rs = Nothing

End Function

Private Function CONTROLLO_QTA_LAVORATA() As Boolean
Dim QtaUMConf As Double
CONTROLLO_QTA_LAVORATA = False
Select Case fnNotNullN(m_Document("IDUnitaDiMisura").Value)
    Case 1
        QtaUMConf = Me.txtColli.Value
    Case 2
        QtaUMConf = Me.txtPesoLordo.Value
    Case 3
        QtaUMConf = Me.txtPesoNetto.Value
    Case 4
        QtaUMConf = Me.txtTara.Value
    Case 5
        QtaUMConf = Me.txtPezzi.Value
End Select

If (txtQtaDifferenza - QtaUMConf) < 0 Then
    CONTROLLO_QTA_LAVORATA = True
End If
End Function
